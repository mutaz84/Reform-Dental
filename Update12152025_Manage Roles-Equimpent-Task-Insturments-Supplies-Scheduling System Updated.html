<html lang="en" data-accent="green" data-fontcolor="default" data-theme="light" data-role="admin" data-theme-preset="high-contrast"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReformDental - Management Dashboard</title>
    <style data-fullcalendar="">        /* ============ WORKING HOURS CALENDAR STYLES ============ */
        .working-hours-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2500;
            display: flex;
            ...existing code...
            animation: slideInWorking 0.3s ease-out;
            overflow: auto;
            padding-top: 50px;
            width: 100%;
            height: 100%;
        }

        .working-hours-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            border: 3px solid #3b82f6;
            border-radius: 8px;
            overflow: hidden;
            margin: 50px;
        }

        .working-hours-container.hidden {
            display: none !important;
        }

        @keyframes slideInWorking {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .working-hours-header {
            background: var(--card-bg);
            border-bottom: 2px solid var(--accent-primary);
            padding: 0.75rem;
            box-shadow: 0 4px 12px var(--shadow);
            flex-shrink: 0;
            box-sizing: border-box;
            width: 100%;
        }

        .working-hours-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .working-hours-title h2 {
            margin: 0;
            font-size: 1rem;
        }

        .working-hours-title i {
            font-size: 1.2rem;
            color: var(--accent-primary);
        }

        .working-hours-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .view-toggles {
            display: flex;
            gap: 0.25rem;
        }

        .view-toggle-btn {
            padding: 0.4rem 0.6rem;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .view-toggle-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .view-toggle-btn:hover:not(.active) {
            background: var(--accent-light);
            border-color: var(--accent-primary);
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-icon-btn {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .nav-icon-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            color: var(--accent-dark);
        }

        .current-date-display {
            min-width: 120px;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .close-modal-btn {
            padding: 0.4rem 0.6rem;
            background: #fee2e2;
            color: #ef4444;
            border: 1px solid #ef4444;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .close-modal-btn:hover {
            background: #ef4444;
            color: white;
        }

        .working-hours-content {
            flex: 1;
            overflow: visible;
            background: var(--bg-primary);
            padding: 1rem;
            box-sizing: border-box;
            width: 100%;
        }

        .working-hours-legend {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .legend-row {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
        }

        .working-hours-view {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: auto;
            min-height: 400px;
        }

        .working-hours-view.hidden {
            display: none !important;
        }

        /* ========== EMPLOYEE PROFILE CARD ========== */
        .employee-profile-card {
            position: fixed;
            right: 10px;
            top: 70px;
            width: 280px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 2600;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .employee-profile-card.hidden {
            display: none !important;
        }

        .employee-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .employee-info h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 700;
        }

        .employee-info p {
            margin: 0.15rem 0 0 0;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .close-employee-card {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-employee-card:hover {
            color: var(--accent-primary);
        }

        .clinic-section {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .clinic-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .clinic-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .clinic-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            background: var(--accent-primary);
        }

        .provider-item {
            background: var(--bg-secondary);
            border-left: 3px solid;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.4rem;
            font-size: 0.75rem;
        }

        .provider-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .assistant-info {
            color: var(--text-secondary);
            margin: 0.15rem 0;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .assistant-info i {
            width: 12px;
            text-align: center;
            font-size: 0.7rem;
        }

        .room-info {
            color: var(--text-secondary);
            margin: 0.15rem 0;
            padding: 0.2rem 0.3rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 2px;
            font-size: 0.7rem;
        }

        .shift-time {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.7rem;
        }

        .no-assistant {
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-style: italic;
            padding: 0.2rem 0;
        }

        .clinic-only-info {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-primary);
            border-radius: 4px;
            padding: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .month-calendar-view {
            display: flex;
            flex-direction: column;
            overflow: auto !important;
        }

        .calendar-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            gap: 1px;
            background-clip: padding-box;
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.95rem;
            border-right: 1px solid var(--border-color);
        }

        .calendar-day-header:last-child {
            border-right: none;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            padding: 1px;
            flex: 1;
        }

        .calendar-cell {
            background: var(--bg-primary);
            min-height: 150px;
            max-height: 150px;
            height: 150px;
            padding: 0.75rem;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        /* Larger cells for week view */
        .week-calendar-view .calendar-cell {
            min-height: 450px;
            max-height: 450px;
            height: 450px;
            padding: 1.25rem;
        }

        /* Week Schedule Table Styles */
        .week-schedule-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: auto;
            height: 100%;
        }

        .week-schedule-table {
            display: flex;
            flex-direction: column;
            min-width: 1400px;
        }

        .week-time-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            padding: 1px;
            background-clip: padding-box;
            flex-shrink: 0;
        }

        .time-slot-label {
            background: var(--bg-secondary);
            padding: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            border-right: 1px solid var(--border-color);
        }

        .time-day-header {
            background: var(--bg-secondary);
            padding: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            border-right: 1px solid var(--border-color);
        }

        .time-day-header:last-child {
            border-right: none;
        }

        .week-time-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 1px;
            background: var(--border-color);
            padding: 1px;
        }

        .time-row {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
        }

        .time-cell {
            background: var(--bg-primary);
            padding: 1rem;
            min-height: 120px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 8px;
        }

        .time-cell:last-child {
            border-right: none;
        }

        .time-cell.time-label {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            border-right: 1px solid var(--border-color);
        }

        .time-cell.today {
            background: var(--accent-light);
        }

        .staff-shift-item {
            background: var(--card-bg);
            border: 2px solid currentColor;
            border-radius: 6px;
            padding: 8px;
            width: 100%;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .staff-shift-item.morning {
            background: #86efac;
            border-color: #4ade80;
        }

        .staff-shift-item.afternoon {
            background: #93c5fd;
            border-color: #60a5fa;
        }

        .staff-shift-item.evening {
            background: #c4b5fd;
            border-color: #a78bfa;
        }

        .staff-shift-item.night {
            background: #a5b4fc;
            border-color: #818cf8;
        }

        .staff-shift-icon {
            font-size: 1rem;
        }

        .staff-shift-name {
            font-weight: 700;
            text-align: center;
        }

        /* Week Timeline Styles */
        .week-timeline-header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-primary);
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
        }

        .timeline-day-header {
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .week-timeline-body {
            background: var(--bg-primary);
            padding: 1rem;
            overflow: auto;
            flex: 1;
        }

        .week-timeline-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            min-height: 100%;
        }

        .week-day-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            min-height: 500px;
        }

        .week-day-column.today {
            background: var(--accent-light);
            border: 2px solid var(--accent-primary);
        }

        .week-shift-card {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-primary);
            border-radius: 6px;
            padding: 1rem;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .week-shift-card.morning {
            border-left-color: #86efac;
        }

        .week-shift-card.afternoon {
            border-left-color: #93c5fd;
        }

        .week-shift-card.evening {
            border-left-color: #c4b5fd;
        }

        .week-shift-card.night {
            border-left-color: #a5b4fc;
        }

        .week-shift-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .week-shift-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .week-shift-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0.25rem 0;
        }

        .calendar-cell.other-month {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .calendar-cell.today {
            background: var(--accent-light);
        }

        .cell-date {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .shift-badge {
            padding: 4px 6px;
            border-radius: 3px;
            color: white;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 3px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            pointer-events: auto;
            user-select: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .shift-badge:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .shift-badge.morning {
            background: #86efac;
        }

        .shift-badge.afternoon {
            background: #93c5fd;
        }

        .shift-badge.evening {
            background: #c4b5fd;
        }

        .shift-badge.doctor {
            border-left: 3px solid rgba(255, 255, 255, 0.8);
            padding-left: 4px;
        }

        .shift-badge-time {
            font-size: 0.65rem;
            opacity: 0.9;
            margin-left: 2px;
        }

        .shift-badge-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shift-badge-doctor-icon {
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        /* ========== INLINE CALENDAR DISPLAY ========== */
        .provider-info-box {
            background: var(--bg-secondary);
            border-left: 3px solid;
            padding: 0.4rem;
            margin: 0.3rem 0;
            border-radius: 3px;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .provider-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .room-and-time {
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin: 0.2rem 0;
        }

        .assistant-in-room {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.7rem;
            margin: 0.2rem 0;
        }

        .day-view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .day-provider-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 4px solid;
            border-radius: 6px;
            padding: 0.75rem;
        }

        .day-provider-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .day-room-detail {
            background: var(--bg-primary);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
        }

        .day-room-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .day-assistant {
            color: var(--accent-primary);
            font-weight: 600;
            margin: 0.2rem 0;
        }

        .day-shift {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin: 0.2rem 0;
        }

        .clinic-section-header {
            font-weight: 700;
            padding: 0.5rem 0;
            margin: 0.5rem 0 0.3rem 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .week-calendar-view {
            display: flex;
            flex-direction: column;
            overflow: auto !important;
        }

        .week-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            gap: 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .week-time-label {
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            border-right: 2px solid var(--border-color);
            font-size: 0.8rem;
        }

        .week-day-column {
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.9rem;
        }

        .week-day-column:last-child {
            border-right: none;
        }

        .week-day-column:last-child {
            border-right: none;
        }

        .week-day-name {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .week-day-date {
            font-size: 0.75rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* Date column header (spans multiple employee columns) */
        .week-date-column-header {
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.9rem;
            background: var(--accent-light);
        }

        .week-date-name {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .week-date-num {
            font-size: 0.85rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* Employee sub-header */
        .week-employee-column-header {
            padding: 0.75rem 0.4rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
            border-right: 1px solid var(--border-color);
            font-size: 0.8rem;
            background: var(--bg-secondary);
            word-break: break-word;
            white-space: normal;
            line-height: 1.2;
        }

        .week-timeline {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 0;
            flex: 1;
            overflow: auto;
            background-color: var(--border-color);
            grid-auto-rows: 60px;
        }

        .time-row {
            background: var(--bg-secondary);
            padding: 0.75rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-right: 2px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-cell {
            background: var(--bg-primary);
            padding: 8px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
        }

        .time-cell:last-child {
            border-right: none;
        }

        .shift-event-badge {
            background: #86efac;
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            line-height: 1.3;
            min-width: 80%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .shift-event-badge:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }

        .shift-event-badge.afternoon {
            background: #93c5fd;
        }

        .shift-event-badge.evening {
            background: #c4b5fd;
        }

        .shift-event-badge.off {
            background: #e5e7eb;
            color: #6b7280;
            opacity: 1;
        }

        /* Mini Calendar Widget */
        .wh-mini-calendar {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            width: 240px;
            position: absolute;
            top: 60px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            resize: both;
            overflow: auto;
            min-width: 200px;
            cursor: move;
            transition: all 0.3s ease;
        }

        .wh-mini-calendar.minimized {
            width: 240px;
            height: auto !important;
            overflow: hidden;
        }

        .wh-mini-calendar.minimized .wh-mini-calendar-weekdays,
        .wh-mini-calendar.minimized .wh-mini-calendar-days,
        .wh-mini-calendar.minimized .wh-month-year-picker,
        .wh-mini-calendar.minimized .wh-mini-calendar-today-btn {
            display: none !important;
        }

        .wh-mini-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            cursor: grab;
            padding: 0.3rem;
            background: var(--accent-light);
            border-radius: 4px;
            margin: -0.5rem -0.5rem 0.4rem -0.5rem;
            padding: 0.5rem;
        }

        .wh-mini-calendar-header-actions {
            display: flex;
            gap: 0.2rem;
            align-items: center;
        }

        .wh-mini-toggle-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.25rem 0.35rem;
            border-radius: 3px;
            font-size: 0.6rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .wh-mini-toggle-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .wh-mini-calendar-header:active {
            cursor: grabbing;
        }

        .wh-mini-calendar-nav {
            display: flex;
            gap: 0.2rem;
        }

        .wh-mini-calendar-nav button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            transition: all 0.2s;
            font-weight: 600;
        }

        .wh-mini-calendar-nav button:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .wh-mini-calendar-month {
            text-align: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.75rem;
            cursor: pointer;
            flex: 1;
            padding: 0 0.5rem;
            transition: all 0.2s;
        }

        .wh-mini-calendar-month:hover {
            color: var(--accent-primary);
            text-decoration: underline;
        }

        .wh-mini-calendar-today-btn {
            padding: 0.4rem 0.6rem;
            background: var(--accent-primary);
            color: white;
            border: 1px solid var(--accent-primary);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            margin: 0.4rem 0;
            width: 100%;
            text-align: center;
        }

        .wh-mini-calendar-today-btn:hover {
            background: var(--accent-dark);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .wh-mini-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 0.3rem;
        }

        .wh-mini-calendar-weekday {
            text-align: center;
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 0.65rem;
            padding: 0.2rem 0;
        }

        .wh-mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .wh-mini-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            border-radius: 3px;
            cursor: pointer;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
            padding: 2px;
        }

        .wh-mini-calendar-day:hover:not(.other-month) {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .wh-mini-calendar-day.other-month {
            color: var(--text-secondary);
            background: var(--bg-secondary);
            cursor: default;
            opacity: 0.5;
        }

        .wh-mini-calendar-day.today {
            background: var(--accent-primary);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }

        .wh-mini-calendar-day.selected {
            background: var(--accent-secondary);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.5);
        }

        /* Month/Year Picker */
        .wh-month-year-picker {
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            background: var(--card-bg);
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-top: 0.3rem;
        }

        .wh-month-year-picker.open {
            display: flex;
        }

        .wh-picker-section-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.7rem;
            text-transform: uppercase;
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .wh-months-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.3rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .wh-years-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.3rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .wh-month-year-option {
            padding: 0.4rem;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
            font-weight: 500;
        }

        .wh-month-year-option:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
        }

        .wh-month-year-option.active {
            background: var(--accent-primary);
            color: white;
            font-weight: 700;
        }

        .day-calendar-view {
            display: flex;
            flex-direction: column;
            overflow: auto !important;
        }

        .day-header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            padding: 1.5rem;
            text-align: center;
            border-bottom: 3px solid var(--accent-primary);
        }

        .day-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .day-header p {
            margin: 0.5rem 0 0 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .day-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--bg-primary);
        }

        .staff-shift-block {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-left: 5px solid var(--accent-primary);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            transition: all 0.2s ease;
        }

        .staff-shift-block:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent-secondary);
        }

        .staff-shift-block:last-child {
            margin-bottom: 0;
        }

        .staff-name-header {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .shift-time-display {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .shift-time-item {
            padding: 0.9rem;
            border-radius: 6px;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            background: #86efac;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .shift-time-item.afternoon {
            background: #93c5fd;
        }

        .shift-time-item.evening {
            background: #c4b5fd;
        }

        .shift-time-item.off {
            background: #e5e7eb;
            color: #6b7280;
            opacity: 1;
        }

        @media (max-width: 1200px) {
            .working-hours-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .view-toggles {
                width: 100%;
            }

            .view-toggle-btn {
                flex: 1;
            }

            .date-navigation {
                width: 100%;
                justify-content: center;
            }

            .calendar-cell {
                min-height: 90px;
            }

            .cell-shifts {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 768px) {
            .working-hours-header {
                padding: 1rem;
            }

            .working-hours-title {
                margin-bottom: 0.75rem;
            }

            .working-hours-title h2 {
                font-size: 1.2rem;
            }

            .working-hours-title i {
                font-size: 1.5rem;
            }

            .view-toggle-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .calendar-cell {
                min-height: 70px;
                padding: 0.5rem;
            }

            .cell-date {
                font-size: 0.85rem;
            }

            .week-timeline {
                grid-template-columns: 60px repeat(auto-fit, minmax(100px, 1fr));
            }

            .week-header {
                grid-template-columns: 60px repeat(auto-fit, minmax(100px, 1fr));
            }

            .week-day-name {
                font-size: 0.8rem;
            }

            .week-day-date {
                font-size: 0.7rem;
            }

            .time-row {
                min-height: 80px;
                font-size: 0.7rem;
                padding: 0.5rem;
            }

            .time-cell {
                min-height: 80px;
                padding: 4px;
            }

            .shift-event-badge {
                padding: 4px 6px;
                font-size: 0.7rem;
            }

            .staff-shift-block {
                padding: 0.9rem;
                margin-bottom: 0.9rem;
            }

            .shift-time-item {
                padding: 0.7rem;
                font-size: 0.85rem;
            }

            .day-header {
                padding: 1rem;
            }

            .day-header h3 {
                font-size: 1.2rem;
            }

            .day-header p {
                font-size: 0.85rem;
            }
        }
                font-size: 0.7rem;
                min-height: 60px;
            }

            .time-cell {
                min-height: 60px;
            }

            .legend-row {
                gap: 1rem;
            }

            .legend-item {
                font-size: 0.8rem;
            }
        }

        /* Address Autocomplete Suggestions */
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg, #fff);
            border: 1px solid var(--border-color, #ddd);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 2px;
        }
        
        .address-suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color, #eee);
            font-size: 0.9rem;
            transition: background-color 0.15s;
        }
        
        .address-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .address-suggestion-item:hover {
            background: var(--hover-bg, #f0f9ff);
        }
        
        .address-suggestion-item .suggestion-main {
            font-weight: 500;
            color: var(--text-primary, #333);
        }
        
        .address-suggestion-item .suggestion-secondary {
            font-size: 0.8rem;
            color: var(--text-secondary, #666);
            margin-top: 2px;
        }
        
        .address-suggestion-loading {
            padding: 12px;
            text-align: center;
            color: var(--text-secondary, #666);
            font-style: italic;
        }

        /* Permission-based styling */
        .permission-readonly {
            position: relative;
        }
        
        .permission-readonly::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            cursor: not-allowed;
        }
        
        .permission-hidden {
            display: none !important;
        }

        </style><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Sticky Notes Functions - Define early so they're available to navigation
        function toggleStickyNotesPanel() {
            console.log('toggleStickyNotesPanel called');
            const panel = document.getElementById('stickyNotesPanel');
            console.log('panel element:', panel);
            if (!panel) {
                console.error('Sticky notes panel not found!');
                return;
            }
            
            // Toggle using class for CSS-based approach
            const isHidden = !panel.classList.contains('sticky-notes-open');
            if (isHidden) {
                panel.classList.add('sticky-notes-open');
                panel.style.setProperty('display', 'block', 'important');
            } else {
                panel.classList.remove('sticky-notes-open');
                panel.style.setProperty('display', 'none', 'important');
            }
            console.log('panel display set to:', panel.style.display);
            console.log('panel classList:', panel.className);
            console.log('panel visibility:', panel.offsetHeight, 'x', panel.offsetWidth);
        }

        function addStickyNote() {
            const textArea = document.getElementById('newStickyNoteText');
            const noteText = textArea.value.trim();
            if (!noteText) return;
            const notesList = document.getElementById('stickyNotesList');
            const noteDiv = document.createElement('div');
            noteDiv.className = 'sticky-note';
            noteDiv.style.cssText = 'background:#fffbe7; border:1px solid #fbbf24; border-radius:8px; padding:0.75rem; color:#d97706; font-size:1rem; position:relative; box-shadow:0 2px 8px rgba(0,0,0,0.07); margin-bottom:0.5rem;';
            noteDiv.innerHTML = `<span>${noteText}</span><button onclick="this.parentElement.remove()" style="position:absolute; top:8px; right:8px; background:none; border:none; color:#d97706; font-size:1.2rem; cursor:pointer;">&times;</button>`;
            notesList.appendChild(noteDiv);
            textArea.value = '';
        }

        // Attach event listener for Sticky Notes nav item
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.includes('Sticky Notes')) {
                    console.log('Found Sticky Notes nav item, attaching listener');
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Sticky Notes nav clicked!');
                        toggleStickyNotesPanel();
                    });
                }
            });
        });
    </script>
    <style>
        :root {
            /* Softer, Eye-Friendly Light Theme */
            --bg-primary: #fafbfc;
            --bg-secondary: #f0f4f8;
            --bg-tertiary: #e3e8ef;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --border-color: #cbd5e1;
            --shadow: rgba(15, 23, 42, 0.08);
            --card-bg: #ffffff;
            
            /* Softer Accent - Gentle Blue */
            --accent-primary: #3b82f6;
            --accent-secondary: #2563eb;
            --accent-light: #dbeafe;
            --accent-dark: #1e40af;
        }

        [data-theme="dark"] {
            --bg-primary: #2d3748;
            --bg-secondary: #4a5568;
            --bg-tertiary: #5a6270;
            --text-primary: #ffffff;
            --text-secondary: #f0f0f0;
            --border-color: #6b7280;
            --shadow: rgba(0, 0, 0, 0.3);
            --card-bg: #5a6270;
        }

        /* Accent Color Themes */
        [data-accent="blue"] {
            --accent-primary: #3b82f6;
            --accent-secondary: #2563eb;
            --accent-light: #dbeafe;
            --accent-dark: #1e40af;
        }

        [data-accent="purple"] {
            --accent-primary: #a855f7;
            --accent-secondary: #9333ea;
            --accent-light: #f3e8ff;
            --accent-dark: #7e22ce;
        }

        [data-accent="green"] {
            --accent-primary: #10b981;
            --accent-secondary: #059669;
            --accent-light: #d1fae5;
            --accent-dark: #047857;
        }

        [data-accent="teal"] {
            --accent-primary: #14b8a6;
            --accent-secondary: #0d9488;
            --accent-light: #ccfbf1;
            --accent-dark: #0f766e;
        }

        [data-accent="indigo"] {
            --accent-primary: #6366f1;
            --accent-secondary: #4f46e5;
            --accent-light: #e0e7ff;
            --accent-dark: #312e81;
        }

        [data-accent="amber"] {
            --accent-primary: #f59e0b;
            --accent-secondary: #d97706;
            --accent-light: #fef3c7;
            --accent-dark: #92400e;
        }

        [data-accent="orange"] {
            --accent-primary: #f97316;
            --accent-secondary: #ea580c;
            --accent-light: #ffedd5;
            --accent-dark: #7c2d12;
        }

        [data-accent="red"] {
            --accent-primary: #ef4444;
            --accent-secondary: #dc2626;
            --accent-light: #fee2e2;
            --accent-dark: #7f1d1d;
        }

        [data-accent="pink"] {
            --accent-primary: #ec4899;
            --accent-secondary: #db2777;
            --accent-light: #fce7f3;
            --accent-dark: #831843;
        }

        [data-accent="slate"] {
            --accent-primary: #64748b;
            --accent-secondary: #475569;
            --accent-light: #f1f5f9;
            --accent-dark: #1e293b;
        }

        [data-accent="rose"] {
            --accent-primary: #f43f5e;
            --accent-secondary: #e11d48;
            --accent-light: #ffe4e6;
            --accent-dark: #881337;
        }

        /* Theme Presets */
        [data-theme-preset="ocean"] {
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --bg-tertiary: #cffafe;
            --text-primary: #0c4a6e;
            --text-secondary: #0369a1;
            --border-color: #bae6fd;
            --shadow: rgba(3, 105, 161, 0.15);
            --card-bg: #ffffff;
        }
        /* Calendar column sizing variables */
        :root {
            --fc-col-min-width: 160px;
            --resource-area-width: 90px;
        }
        
        /* Custom checkbox styling for better visibility */
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 20px !important;
            height: 20px !important;
            min-width: 20px;
            min-height: 20px;
            border: 2px solid var(--border-color, #d1d5db);
            border-radius: 4px;
            background-color: var(--bg-secondary, #f9fafb);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        input[type="checkbox"]:checked {
            background-color: #06b6d4;
            border-color: #06b6d4;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        input[type="checkbox"]:hover {
            border-color: var(--accent-primary, #3b82f6);
        }
        
        /* Group chat member checkboxes - cyan */
        input[name="groupMembers"]:checked {
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        /* Announcement recipient checkboxes - amber */
        input[name="announcementRecipients"]:checked {
            background-color: #f59e0b;
            border-color: #f59e0b;
        }
        
            /* Compact styles for Room Week view to improve fitting/alignment */
            .view-mode-room .fc .event-badge-container { gap: 4px; }
            .view-mode-room .fc .fc-event-title { font-size: 0.72rem; font-weight:600; }
            .view-mode-room .fc .event-badge-container span { font-size: 0.68rem; }
            .view-mode-room .resource-avatar { width: 32px !important; height: 32px !important; font-size: 0.72rem !important; }
            .view-mode-room .fc .fc-timegrid-slot-label { font-size: 0.7rem; }
            .view-mode-room .fc .fc-col-header-cell-cushion { font-size: 0.78rem; }
            .view-mode-room .fc .fc-daygrid-event .fc-event-title { font-size:0.72rem }
            .view-mode-room .fc .fc-timegrid-event { padding: 2px 4px !important; }
            .view-mode-room .fc .fc-event-title { line-height: 1; }
            /* Make day columns wider in room-week so events fit better */
            .view-mode-room .fc .fc-timegrid-col, .view-mode-room .fc .fc-col-header, .view-mode-room .fc .fc-daygrid-day {
                min-width: var(--fc-col-min-width) !important;
            }
            .view-mode-room .fc .fc-scrollgrid-section-liquid .fc-scrollgrid-section { min-width: var(--fc-col-min-width) !important; }
            /* Offset the top date header row by the resource area width so columns align */
            .view-mode-room .fc .fc-scrollgrid-section-header {
                padding-left: var(--resource-area-width) !important;
            }
            /* Reduce the left padding of the header inner section so content aligns with timegrid columns */
            .view-mode-room .fc .fc-scrollgrid-section-header .fc-scrollgrid-section {
                padding-left: 0 !important;
            }

        /* Employee View Alignment Fixes - Day and Week */
            .view-mode-employee .fc .fc-timegrid-col, .view-mode-employee .fc .fc-col-header, .view-mode-employee .fc .fc-daygrid-day {
                min-width: var(--fc-col-min-width) !important;
            }
            .view-mode-employee .fc .fc-scrollgrid-section-liquid .fc-scrollgrid-section { min-width: var(--fc-col-min-width) !important; }
            /* Offset the top date header row by the resource area width so columns align */
            .view-mode-employee .fc .fc-scrollgrid-section-header {
                padding-left: 30px !important;
            }
            /* Reduce the left padding of the header inner section so content aligns with timegrid columns */
            .view-mode-employee .fc .fc-scrollgrid-section-header .fc-scrollgrid-section {
                padding-left: 0 !important;
            }

        /* Provider View Alignment Fixes - Day and Week */
            .view-mode-provider .fc .fc-timegrid-col, .view-mode-provider .fc .fc-col-header, .view-mode-provider .fc .fc-daygrid-day {
                min-width: var(--fc-col-min-width) !important;
            }
            .view-mode-provider .fc .fc-scrollgrid-section-liquid .fc-scrollgrid-section { min-width: var(--fc-col-min-width) !important; }
            /* Offset the top date header row by the resource area width so columns align */
            .view-mode-provider .fc .fc-scrollgrid-section-header {
                padding-left: 30px !important;
            }
            /* Reduce the left padding of the header inner section so content aligns with timegrid columns */
            .view-mode-provider .fc .fc-scrollgrid-section-header .fc-scrollgrid-section {
                padding-left: 0 !important;
            }
                max-width: 30px !important;
            }
            /* Offset BOTH the date header AND resource names row */
            .view-mode-provider .fc .fc-scrollgrid-section-header,
            .view-mode-provider .fc .fc-scrollgrid-section-body {
                padding-left: 30px !important;
            }
            /* Reduce the left padding of the header inner section so content aligns with timegrid columns */
            .view-mode-provider .fc .fc-scrollgrid-section-header .fc-scrollgrid-section,
            .view-mode-provider .fc .fc-scrollgrid-section-body .fc-scrollgrid-section {
                padding-left: 0 !important;
            }

        [data-theme="dark"][data-theme-preset="ocean"] {
            --bg-primary: #1e3a52;
            --bg-secondary: #2a5a78;
            --bg-tertiary: #3a6a88;
            --text-primary: #ffffff;
            --text-secondary: #e0f2fe;
            --border-color: #0891b2;
            --shadow: rgba(0, 0, 0, 0.5);
            --card-bg: #3a6a88;
        }

        [data-theme-preset="sunset"] {
            --bg-primary: #fef5f1;
            --bg-secondary: #fef3c7;
            --bg-tertiary: #fde68a;
            --text-primary: #92400e;
            --text-secondary: #b45309;
            --border-color: #fcd34d;
            --shadow: rgba(217, 119, 6, 0.15);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="sunset"] {
            --bg-primary: #6b4a2a;
            --bg-secondary: #8b5a3a;
            --bg-tertiary: #9b6a4a;
            --text-primary: #ffffff;
            --text-secondary: #fed7aa;
            --border-color: #f59e0b;
            --shadow: rgba(0, 0, 0, 0.5);
            --card-bg: #9b6a4a;
        }

        /* Modern Theme - Clean, Professional Design */
        [data-theme-preset="modern"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #f0f4f9;
            --bg-tertiary: #e8ecf1;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #cbd5e0;
            --shadow: rgba(0, 0, 0, 0.08);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="modern"] {
            --bg-primary: #2d3748;
            --bg-secondary: #4a5568;
            --bg-tertiary: #5a6575;
            --text-primary: #ffffff;
            --text-secondary: #f0f0f0;
            --border-color: #6b7280;
            --shadow: rgba(0, 0, 0, 0.3);
            --card-bg: #5a6575;
        }

        [data-theme-preset="forest"] {
            --bg-primary: #f0fdf4;
            --bg-secondary: #dcfce7;
            --bg-tertiary: #bbf7d0;
            --text-primary: #14532d;
            --text-secondary: #166534;
            --border-color: #86efac;
            --shadow: rgba(34, 197, 94, 0.15);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="forest"] {
            --bg-primary: #2d4a3e;
            --bg-secondary: #3d6050;
            --bg-tertiary: #4d7060;
            --text-primary: #ffffff;
            --text-secondary: #d1fae5;
            --border-color: #4ade80;
            --shadow: rgba(0, 0, 0, 0.5);
            --card-bg: #4d7060;
        }

        [data-theme-preset="professional"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.08);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="professional"] {
            --bg-primary: #2a3441;
            --bg-secondary: #3f4a58;
            --bg-tertiary: #505b69;
            --text-primary: #ffffff;
            --text-secondary: #f0f0f0;
            --border-color: #6b7280;
            --shadow: rgba(0, 0, 0, 0.5);
            --card-bg: #505b69;
        }

        [data-theme-preset="soft"] {
            --bg-primary: #faf8f3;
            --bg-secondary: #f5f1e8;
            --bg-tertiary: #ede9de;
            --text-primary: #5a4a42;
            --text-secondary: #8b7355;
            --border-color: #e0d5c7;
            --shadow: rgba(90, 74, 66, 0.08);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="soft"] {
            --bg-primary: #4d4341;
            --bg-secondary: #605a55;
            --bg-tertiary: #706a65;
            --text-primary: #ffffff;
            --text-secondary: #f0ebe5;
            --border-color: #8b7f77;
            --shadow: rgba(0, 0, 0, 0.5);
            --card-bg: #706a65;
        }

        [data-theme-preset="vibrant"] {
            --bg-primary: #fdf2f8;
            --bg-secondary: #fce7f3;
            --bg-tertiary: #fbcfe8;
            --text-primary: #831843;
            --text-secondary: #be185d;
            --border-color: #f472b6;
            --shadow: rgba(236, 72, 153, 0.15);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="vibrant"] {
            --bg-primary: #6b1d45;
            --bg-secondary: #8b2d55;
            --bg-tertiary: #9b3d65;
            --text-primary: #ffffff;
            --text-secondary: #fce7f3;
            --border-color: #ec4899;
            --shadow: rgba(0, 0, 0, 0.5);
            --card-bg: #9b3d65;
        }

        [data-theme-preset="high-contrast"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-tertiary: #e0e0e0;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border-color: #000000;
            --shadow: rgba(0, 0, 0, 0.3);
            --card-bg: #ffffff;
        }

        [data-theme="dark"][data-theme-preset="high-contrast"] {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #333333;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --border-color: #ffffff;
            --shadow: rgba(255, 255, 255, 0.2);
            --card-bg: #1a1a1a;
        }

        /* ============ CONTRAST ENHANCEMENT ============ */
        /* Ensure all interactive elements have visible text regardless of theme */
        button,
        select,
        input,
        .calendar-corner-toggle {
            /* Force better contrast for all states */
            min-contrast: 4.5;
        }

        /* Ensure dropdown options are always visible */
        select option,
        option {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
        }

        /* ============ UNIVERSAL BASE STYLES ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *,
        *::before,
        *::after {
            box-sizing: inherit;
        }

        /* Ensure all elements inherit theme variables and font */
        html {
            box-sizing: border-box;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Inherit font family for all form elements and inputs */
        input,
        button,
        textarea,
        select,
        option {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            color: inherit;
        }

        /* Ensure all headings inherit color and font */
        h1, h2, h3, h4, h5, h6 {
            font-family: inherit;
            color: var(--text-primary);
            font-weight: 700;
            line-height: 1.2;
        }

        /* Ensure paragraphs and text elements inherit styles */
        p, span, div, label {
            font-family: inherit;
            color: inherit;
        }

        /* Links inherit color and remove default styles */
        a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--accent-secondary);
        }

        /* Buttons inherit styles and remove defaults */
        button {
            background: transparent;
            border: none;
            cursor: pointer;
            font-family: inherit;
            color: inherit;
            transition: all 0.3s ease;
        }

        /* Input fields inherit theme colors */
        input,
        textarea,
        select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* Tables inherit theme styles */
        table {
            border-collapse: collapse;
            width: 100%;
            color: var(--text-primary);
            font-family: inherit;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: inherit;
        }

        th {
            font-weight: 600;
            background: var(--bg-secondary);
        }

        /* Lists inherit styles */
        ul, ol {
            color: var(--text-primary);
            font-family: inherit;
        }

        /* Code elements */
        code, pre, kbd {
            font-family: 'Courier New', Courier, monospace;
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: var(--text-primary);
        }

        /* Strong and emphasis */
        strong, b {
            font-weight: 700;
            color: inherit;
        }

        em, i {
            font-style: italic;
            color: inherit;
        }

        /* Images and media */
        img, video {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Scrollbar styling for consistency */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* ============ LOGIN SCREEN ============ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h2 {
            margin: 0.5rem 0 0.25rem 0;
            font-size: 1.75rem;
            color: var(--text-primary);
        }

        .login-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* ============ UTILITY CLASSES ============ */
        /* Common utility classes for consistent styling */
        .text-primary {
            color: var(--text-primary) !important;
        }

        .text-secondary {
            color: var(--text-primary) !important;
            opacity: 0.7;
        }

        .text-accent {
            color: var(--accent-primary) !important;
        }

        .bg-primary {
            background: var(--bg-primary) !important;
        }

        .bg-secondary {
            background: var(--bg-secondary) !important;
        }

        .bg-card {
            background: var(--card-bg) !important;
        }

        .border-color {
            border-color: var(--border-color) !important;
        }

        .border-accent {
            border-color: var(--accent-primary) !important;
        }

        /* Spacing utilities */
        .m-0 { margin: 0 !important; }
        .p-0 { padding: 0 !important; }
        .mt-1 { margin-top: 0.5rem !important; }
        .mb-1 { margin-bottom: 0.5rem !important; }
        .p-1 { padding: 0.5rem !important; }
        .p-2 { padding: 1rem !important; }

        /* Flexbox utilities */
        .flex { display: flex !important; }
        .flex-center {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .flex-between {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        /* Text utilities */
        .text-center { text-align: center !important; }
        .text-bold { font-weight: 700 !important; }
        .text-normal { font-weight: 400 !important; }

        /* Border radius utilities */
        .rounded { border-radius: 6px !important; }
        .rounded-lg { border-radius: 12px !important; }
        .rounded-full { border-radius: 50% !important; }

        /* Transition utilities */
        .transition-all {
            transition: all 0.3s ease !important;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10000;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-container {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .logo-placeholder {
            font-size: 24px;
            color: var(--accent-primary);
        }

        .brand-text h1 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .brand-text p {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Role Switcher */
        .role-switcher {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.15rem;
            display: flex;
            gap: 0.1rem;
        }

        .role-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            background: transparent;
            color: var(--text-primary);
            opacity: 0.7;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            white-space: nowrap;
        }

        .role-btn:hover {
            background: var(--bg-tertiary);
            opacity: 1;
        }

        .role-btn.active {
            background: var(--accent-primary);
            color: white;
            opacity: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .role-btn i {
            font-size: 0.9rem;
        }

        /* Theme Controls */
        .theme-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.35rem 0.7rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .accent-selector {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.35rem;
            border-radius: 6px;
        }

        .accent-btn {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .accent-btn:hover {
            transform: scale(1.1);
            border-color: var(--text-primary);
        }

        .accent-btn.active {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 1px var(--bg-secondary);
        }

        .accent-btn.cyan { background: #06b6d4; }
        .accent-btn.blue { background: #3b82f6; }
        .accent-btn.purple { background: #a855f7; }
        .accent-btn.green { background: #10b981; }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0.6rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        /* Selector Group Compact Styling */
        .selector-group select {
            padding: 0.35rem 0.6rem;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .selector-group select:hover {
            border-color: var(--accent-primary);
        }

        .selector-group select option {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .selector-group label {
            font-size: 0.8rem;
            color: var(--text-primary);
            opacity: 0.8;
            font-weight: 500;
        }

        /* Theme Preset Options with Color Indicators */
        #themePresetSelect option {
            padding: 0.5rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .user-profile:hover {
            border-color: var(--accent-primary);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 0.65rem;
            color: var(--text-primary);
            opacity: 0.7;
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100vh - 50px);
            flex-wrap: nowrap;
            transition: all 0.3s ease;
            margin-top: 0;
        }

        .container.header-hidden {
            height: 100vh;
            margin-top: -50px;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            flex-shrink: 0;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Right Sidebar */
        .sidebar-right {
            width: 220px;
            flex-shrink: 0;
            background: var(--card-bg);
            border-left: 1px solid var(--border-color);
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar::-webkit-scrollbar,
        .sidebar-right::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track,
        .sidebar-right::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb,
        .sidebar-right::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover,
        .sidebar-right::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* ============ SIDEBAR TOGGLE CSS ============ */
        .sidebar.hidden {
            display: none !important;
        }

        .sidebar-right.hidden {
            display: none !important;
        }

        /* Adjust grid when sidebar is hidden */
        .dashboard-grid:has(.sidebar-right.hidden),
        .dashboard-grid:not(:has(.sidebar-right)) {
            grid-template-columns: 1fr !important;
        }

        /* Toggle Buttons Container */
        .sidebar-toggle-buttons {
            position: fixed;
            top: 70px;
            left: 10px;
            z-index: 1000;
            display: none;
            gap: 0.5rem;
            flex-direction: column;
        }

        .sidebar-toggle-buttons.right-side {
            left: auto;
            right: 10px;
            top: 70px;  /* Same as left side for mirror effect */
        }

        /* Toggle Button Styles */
        .toggle-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .toggle-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        /* Corner Sidebar Toggle Buttons */
        .calendar-corner-toggle {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 0;
            background: var(--accent-primary);
            border: none;
            border-top: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            transition: all 0.3s ease;
            box-shadow: none;
            z-index: 100;
            padding: 0;
        }

        .calendar-corner-toggle:hover {
            background: var(--accent-hover);
            border-top-color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            color: white;
            box-shadow: none;
        }

        .calendar-corner-toggle.left-toggle {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-radius: 0 0 8px 0;
        }

        .calendar-corner-toggle.right-toggle {
            top: 0;
            right: 0;
            border-left: none;
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 0 0 0 8px;
        }

        .calendar-corner-toggle.right-toggle:hover {
            border-right-color: var(--accent-primary);
            border-top-color: var(--accent-primary);
        }

        .calendar-corner-toggle.top-toggle {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 24px;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            border-top: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }

        .calendar-corner-toggle.top-toggle:hover {
            border-left-color: var(--accent-primary);
            border-right-color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        /* Sidebar close buttons */
        .sidebar-close-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .sidebar-close-btn:hover {
            color: var(--accent-primary);
        }

        .nav-section {
            margin: 0;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-section:first-child {
            padding-top: 1.5rem;
        }

        .nav-section:last-child {
            border-bottom: none;
        }

        .nav-title {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin: 0.5rem 1rem 0.75rem 1rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s ease;
        }

        .nav-title:hover {
            color: var(--text-primary);
        }

        .nav-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .nav-section.collapsed .nav-toggle {
            transform: rotate(-90deg);
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 0;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .nav-section.collapsed .nav-items {
            max-height: 0;
            opacity: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.8rem 1rem;
            margin: 0;
            border-radius: 0;
            border-left: 3px solid transparent;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            padding-left: calc(1rem + 2px);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            font-weight: 600;
            padding-left: calc(1rem + 2px);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            font-size: 0.95rem;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.6rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 22px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item.active .nav-badge {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .nav-item:hover .nav-badge {
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0.5rem;
            overflow-y: auto;
            min-width: 0;
        }

        /* Content Toggle */
        .content-view {
            display: none;
        }

        .content-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Frozen top section */
        .dashboard-header {
            /* position: sticky; */
            top: 0;
            background: var(--bg-secondary);
            z-index: 1000;
            padding-bottom: 0;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-primary);
            opacity: 0.7;
            margin-bottom: 0.15rem;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 0.65rem;
            margin-top: 0.15rem;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 220px;
            gap: 1rem;
        }

        /* Calendar Section */
        .calendar-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            width: 100%;
            min-height: 700px;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            /* position: sticky; */
            top: 200px;
            z-index: 999;
            background: var(--card-bg);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            padding: 1.5rem 1.5rem 1rem 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
        }

        /* Calendar */
        .calendar {
            margin-bottom: 1.5rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-month {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--bg-secondary);
        }

        .calendar-day:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .calendar-day.today {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
            font-weight: 700;
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.has-events {
            border-width: 2px;
        }

        .calendar-day-number {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .calendar-day-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* Event List */
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .event-item {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-primary);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .event-item:hover {
            border-left-width: 6px;
            box-shadow: 0 2px 8px var(--shadow);
            transform: translateX(4px);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .event-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .event-time {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .event-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        /* Right Panel */
        .right-panel {
            display: block;
        }

        .panel-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            position: sticky;
            top: calc(var(--header-height) + 8px);
            z-index: 999;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Legends */
        .legend-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: var(--bg-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: 0.875rem;
            color: var(--text-primary);
            flex: 1;
        }

        .legend-count {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            color: var(--text-secondary);
        }

        /* Collapsible Dashboard Sections */
        .dashboard-section {
            position: relative;
        }

        .dashboard-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            padding: 0;
        }

        .dashboard-section-header:hover {
            opacity: 0.8;
        }

        .dashboard-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: var(--accent-primary);
        }

        .dashboard-section.collapsed .dashboard-toggle {
            transform: rotate(-90deg);
        }

        .dashboard-section-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
            margin-top: 1rem;
        }

        .dashboard-section.collapsed .dashboard-section-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        /* My Duties */
        .duty-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .duty-item {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .duty-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(2px);
        }

        .duty-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .duty-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .duty-badges {
            display: flex;
            gap: 0.5rem;
        }

        .duty-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .duty-badge.type {
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        .duty-badge.priority {
            color: white;
        }

        .duty-badge.critical {
            background: #dc2626;
        }

        .duty-badge.high {
            background: #d97706;
        }

        .duty-badge.medium {
            background: #ca8a04;
        }

        .duty-badge.low {
            background: #059669;
            color: white !important;
        }

        .duty-description {
            font-size: 0.75rem;
            color: var(--text-primary);
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }

        .duty-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.7rem;
            color: var(--text-primary);
            opacity: 0.7;
        }

        .duty-meta i {
            margin-right: 0.25rem;
        }

        /* Summary Stats */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .summary-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-primary);
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0.8;
        }

        select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover {
            border-color: var(--accent-primary);
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        select option[value]:not([value="all"]) {
            color: var(--text-primary);
        }

        /* Filter message */
        .filter-message {
            background: var(--bg-secondary);
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active filter indicator */
        .filter-group select:not([value="all"]) {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        /* Hide elements based on role */
        [data-role="user"] .admin-only {
            display: none !important;
        }

        /* Employee Selector - Admin Only */
        .employee-selector {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .view-mode-switcher {
            margin-bottom: 1.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin: 0 -1.5rem 1.5rem -1.5rem;
            box-shadow: none;
        }

        .view-mode-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .view-mode-label i {
            font-size: 1rem;
            color: var(--accent-primary);
        }

        .view-mode-toggle {
            display: flex;
            gap: 0.5rem;
            background: transparent;
            padding: 0;
            border-radius: 0;
            border: none;
        }

        .view-mode-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .view-mode-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        .view-mode-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .view-mode-btn[data-view-mode="date"].active {
            background: var(--accent-primary);
        }

        .view-mode-btn[data-view-mode="employee"].active {
            background: var(--accent-primary);
        }

        .view-mode-btn[data-view-mode="room"].active {
            background: var(--accent-primary);
        }

        .view-mode-btn[data-view-mode="provider"].active {
            background: var(--accent-primary);
        }

        .view-mode-btn[data-view-mode="event"].active {
            background: var(--accent-primary);
        }

        .view-mode-btn i {
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        /* View Filter Controls (Dropdown Filters) */
        .view-filter-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa !important;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            color: var(--text-primary);
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .filter-select {
            padding: 0.6rem 0.9rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 220px;
            max-width: 100%;
        }

        .filter-select:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .clear-filter-btn {
            padding: 0.6rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .clear-filter-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .clear-filter-btn i {
            font-size: 0.8rem;
        }

        .active-filter-badge {
            background: var(--accent-primary);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .employee-card {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .employee-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .employee-card.active {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }

        .employee-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }

        .employee-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .employee-role-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Quick Calendar Dropdown */
        .quick-calendar-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 0.5rem;
            background: var(--card-bg);
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            display: none;
            animation: slideUpFade 0.2s ease-out;
        }

        .quick-calendar-dropdown.active {
            display: block;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Event Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 75vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            height: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--accent-primary);
            color: white;
        }

        .modal-body {
            padding: revert-layer;
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }

        .modal-section-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .modal-info-grid {
            display: grid;
            gap: 1rem;
        }

        .modal-info-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .modal-info-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-info-content {
            flex: 1;
        }

        .modal-info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .modal-info-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .modal-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .modal-badge.paid {
            background: #10b981;
            color: white;
        }

        .modal-badge.overdue {
            background: #ef4444;
            color: white;
        }

        .modal-badge.priority-critical {
            background: #dc2626;
            color: white;
        }

        .modal-badge.priority-high {
            background: #d97706;
            color: white;
        }

        .modal-badge.priority-medium {
            background: #ca8a04;
            color: white;
        }

        .modal-badge.priority-low {
            background: #059669;
            color: white;
        }

        .modal-actions {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Procedure Modal */
        .procedure-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10003;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .procedure-modal-overlay.active {
            display: flex;
        }

        .procedure-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .procedure-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .procedure-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .procedure-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .procedure-modal-close:hover {
            background: var(--accent-primary);
            color: white;
        }

        .procedure-modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .procedure-modal-actions {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Custom Calendar Styles */
        .custom-calendar {
            background: var(--bg-secondary);
            flex: 1;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
        }
        
        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }
        
        .calendar-nav .nav-btn,
        .calendar-view-buttons .view-btn {
            background: var(--accent-primary);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        
        .calendar-nav .nav-btn:hover,
        .calendar-view-buttons .view-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }
        
        .calendar-view-buttons .view-btn.active {
            background: var(--accent-secondary);
        }
        
        .calendar-title {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.25rem;
        }
        
        .calendar-view-buttons {
            display: flex;
            gap: 0.25rem;
        }
        
        .calendar-body {
            flex: 1;
            overflow: auto;
            padding: 1rem;
        }
        
        .calendar-month-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }
        
        .calendar-month-table thead th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .calendar-month-table tbody td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            vertical-align: top;
            height: 100px;
            min-height: 100px;
            background: var(--card-bg);
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .calendar-month-table tbody td:hover {
            background: var(--bg-secondary);
        }
        
        .calendar-day.today {
            background: var(--accent-light) !important;
        }
        
        .calendar-day.other-month {
            opacity: 0.5;
        }
        
        .day-number {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .event-item {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-radius: 3px;
            padding: 2px 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-left: 3px solid #86efac !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .event-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        
        .event-item.priority-critical {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #f87171 !important;
        }
        
        .event-item.priority-high {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #fb923c !important;
        }
        
        .event-item.priority-medium {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #fbbf24 !important;
        }
        
        .event-item.priority-low {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #86efac !important;
        }
        
        .event-item .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 0.65rem;
            font-weight: bold;
            background: rgba(255,255,255,0.3);
        }
        
        .event-item .badge.overdue {
            background: #ef4444;
        }
        
        .event-item .badge.paid {
            background: #10b981;
        }
        
        .event-item.working-hours-indicator {
            cursor: default;
            border: 1px solid #d1d5db;
        }
        
        .event-item.working-hours-indicator:hover {
            transform: none;
            box-shadow: none;
        }
        
        .event-more {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
            font-style: italic;
        }
        
        /* Time Grid Views */
        .calendar-time-grid-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: auto;
        }
        
        .calendar-resource-view {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            transform: rotateX(180deg);
        }
        
        .calendar-resource-view .time-grid {
            min-width: fit-content;
            transform: rotateX(180deg);
        }
        
        .time-grid {
            display: flex;
            flex-direction: column;
            min-height: 600px;
            background: var(--card-bg);
        }
        
        .time-grid.resource-grid {
            overflow-x: auto;
        }
        
        /* Top scrollbar wrapper */
        .top-scrollbar-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            height: 17px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            margin: 0 1rem; /* Match calendar-body padding */
            width: calc(100% - 2rem); /* Account for margins */
        }
        
        .top-scrollbar-content {
            height: 1px;
        }
        
        .time-grid-header {
            display: grid;
            grid-template-columns: 80px repeat(auto-fit, minmax(100px, 1fr));
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .time-grid-header.resource-header {
            display: flex;
            grid-template-columns: none;
        }
        
        .time-label-header {
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
        }
        
        .resource-label-header {
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .day-header {
            text-align: center;
            padding: 0.75rem;
            border-right: 1px solid var(--border-color);
        }
        
        .day-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .day-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 0.25rem;
        }
        
        .day-date.today {
            color: var(--accent-primary);
            background: var(--accent-light);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        .resource-labels-row {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 52px;
            z-index: 9;
            min-height: 40px;
        }
        
        .resource-labels-row .time-label,
        .resource-labels-row .resource-spacer {
            flex-shrink: 0;
        }
        
        .resource-labels-row .time-label {
            width: 80px;
        }
        
        .resource-labels-row .resource-spacer {
            width: 100px;
        }
        
        .resource-label {
            text-align: center;
            padding: 0.5rem 0.5rem;
            border-right: 1px solid var(--border-color);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 120px;
            flex: 1;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .resource-label:hover {
            background: rgba(59, 130, 246, 0.1);
            cursor: grab;
        }
        
        .resource-label.dragging {
            opacity: 0.5;
            cursor: grabbing;
            background: rgba(59, 130, 246, 0.3);
        }
        
        .resource-label.drag-over {
            background: rgba(59, 130, 246, 0.2);
            border-bottom: 3px solid #3b82f6;
        }
        
        .resource-spacer {
            border-right: 2px solid var(--border-color);
        }
        
        .time-slots-container {
            display: flex;
            flex-direction: column;
        }
        
        .time-slot-row {
            display: grid;
            grid-template-columns: 80px repeat(auto-fit, minmax(100px, 1fr));
            min-height: 60px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .time-slots-container.resource-slots .time-slot-row {
            display: flex;
        }
        
        .time-slots-container.resource-slots .time-slot-row .time-label {
            width: 80px;
            flex-shrink: 0;
        }
        
        .time-slots-container.resource-slots .time-slot-row .resource-spacer {
            width: 100px;
            flex-shrink: 0;
        }
        
        .time-label {
            background: var(--bg-secondary);
            border-right: 2px solid var(--border-color);
            padding: 0.5rem;
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .time-slot {
            border-right: 1px solid var(--border-color);
            background: var(--card-bg);
            position: relative;
            padding: 2px;
            transition: background 0.2s ease;
        }
        
        .time-slot:hover {
            background: var(--bg-secondary);
        }
        
        .time-slot.resource-slot {
            min-width: 120px;
            flex: 1;
            max-width: 300px;
            position: relative;
        }
        
        .calendar-event {
            background: #ffffff !important;
            color: #2d3748 !important;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: move;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.2s ease;
            line-height: 1.2;
            border-left: 4px solid #86efac !important;
            border: 1px solid #86efac !important;
            border-left: 4px solid #86efac !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }
        
        .resource-slot .calendar-event {
            font-size: 0.65rem;
            padding: 3px 4px;
            gap: 2px;
        }
        
        .resource-slot .calendar-event .event-time {
            font-size: 0.6rem;
        }
        
        .resource-slot .calendar-event .event-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
        
        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 5;
        }
        
        .calendar-event.priority-critical {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #f87171 !important;
        }
        
        .calendar-event.priority-high {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #fb923c !important;
        }
        
        .calendar-event.priority-medium {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #fbbf24 !important;
        }
        
        .calendar-event.priority-low {
            background: #ffffff !important;
            color: #2d3748 !important;
            border-left-color: #86efac !important;
        }
        
        .calendar-event[data-type="working-hours"],
        .calendar-event.working-hours-block {
            background: #e5e7eb !important;
            border: 1px solid #d1d5db !important;
            border-left: 3px solid #9ca3af !important;
            color: #6b7280 !important;
            font-style: italic;
            font-weight: 400;
            font-size: 0.65rem;
        }
        
        .calendar-event[data-type="working-hours"]:hover,
        .calendar-event.working-hours-block:hover {
            background: #d1d5db !important;
        }
        
        /* Assistant Block Styling */
        .calendar-event.assistant-block {
            padding: 4px !important;
            font-size: 0.7rem !important;
            line-height: 1.1 !important;
            overflow: visible !important;
            white-space: normal !important;
            display: block !important;
        }
        
        /* Unscheduled Items Section */
        .unscheduled-items-row {
            display: flex !important;
            background: #fefce8;
            border-top: 2px solid #fde047;
            border-bottom: 2px solid #fde047;
            min-height: 50px;
            align-items: stretch;
        }
        
        .unscheduled-items-row .time-label {
            width: 80px !important;
            min-width: 80px !important;
            max-width: 80px !important;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
            background: #fefce8;
            font-size: 0.75rem !important;
            color: var(--text-secondary) !important;
            font-weight: 600 !important;
            padding: 0 !important;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
        }
        
        .unscheduled-items-row .resource-spacer {
            width: 100px !important;
            flex-shrink: 0;
            background: #fefce8;
            border-right: 2px solid var(--border-color);
        }
        
        .unscheduled-cell {
            flex: 1;
            min-width: 120px;
            max-width: 300px;
            padding: 0.5rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            align-items: flex-start;
            align-content: flex-start;
            background: #fffef7;
        }
        
        .unscheduled-task-chip {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #78350f;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .unscheduled-task-chip:hover {
            background: #fde68a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }
        
        .unscheduled-duty-chip {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .unscheduled-duty-chip:hover {
            background: #bfdbfe;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        
        .calendar-event .event-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 0.65rem;
            font-weight: bold;
            background: rgba(255,255,255,0.3);
        }
        
        .calendar-event .event-badge.overdue {
            background: #ef4444;
        }
        
        .calendar-event .event-badge.paid {
            background: #10b981;
        }
        
        .calendar-event .event-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calendar-event .event-time {
            font-size: 0.65rem;
            opacity: 0.9;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .event-context-menu {
            animation: menuFadeIn 0.15s ease-out;
        }
        
        @keyframes menuFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Time slot hover effect */
        .time-slot:hover {
            background: var(--accent-light) !important;
            cursor: pointer;
        }
        
        .time-slot:hover::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: var(--accent-primary);
            opacity: 0.3;
            pointer-events: none;
        }
        
        .time-slot.has-event:hover::after {
            display: none;
        }

        .calendar-week-view,
        .calendar-day-view {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: var(--card-bg);
            border-radius: 8px;
        }
        
        .week-view-content,
        .day-view-content {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Legacy FullCalendar Compatibility Styles */
        .fc {
            background: var(--bg-secondary);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .fc .fc-daygrid {
            flex: 1;
        }

        /* Ensure all FullCalendar text uses theme colors */
        .fc,
        .fc *,
        .fc a,
        .fc-daygrid-more-link,
        .fc-popover,
        .fc-popover * {
            color: var(--text-primary) !important;
        }

        .fc .fc-toolbar {
            margin-bottom: 0;
        }

        .fc .fc-button {
            background: var(--accent-primary);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .fc .fc-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .fc .fc-button-active {
            background: var(--accent-secondary) !important;
        }

        .fc-daygrid-day {
            background: var(--card-bg);
            border-color: var(--border-color) !important;
        }

        .fc-daygrid-day:hover {
            background: var(--bg-secondary);
        }

        .fc-daygrid-day.fc-day-today {
            background: var(--accent-light) !important;
        }

        .fc-daygrid-day-number {
            color: var(--text-primary) !important;
            font-weight: 600;
            opacity: 0.9 !important;
        }

        .fc-event {
            border: none !important;
            border-left: 4px solid var(--accent-primary) !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            margin: 2px 0 !important;
            font-size: 0.75rem !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            line-height: 1.4 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 2px !important;
            max-width: 100% !important;
            overflow: hidden !important;
            background-color: var(--bg-tertiary) !important;
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif !important;
            font-weight: 400 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        /* Force override FullCalendar's bg color on the inner elements */
        .fc-event .fc-event-main,
        .fc-event .fc-event-main-frame {
            background-color: transparent !important;
            background: transparent !important;
            color: var(--text-primary) !important;
        }

        /* All events same background - only left border color differs by priority */
        .fc-event[data-priority="high"],
        .fc-event[data-priority="critical"],
        .fc-event[data-priority="medium"],
        .fc-event[data-priority="low"] {
            background: var(--bg-tertiary) !important;
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }

        /* Priority indicator via left border color */
        .fc-event[data-priority="high"] {
            border-left-color: #fb923c !important;
        }

        .fc-event[data-priority="critical"] {
            border-left-color: #f87171 !important;
        }

        .fc-event[data-priority="medium"] {
            border-left-color: #fbbf24 !important;
        }

        .fc-event[data-priority="low"] {
            border-left-color: #86efac !important;
        }

        .fc-event:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
            transform: translateY(-1px) !important;
        }

        .fc-event-title {
            font-weight: 500 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            white-space: normal !important;
            overflow: visible !important;
            flex: 1 1 100% !important;
            min-width: 0 !important;
            color: var(--text-primary) !important;
            line-height: 1.4 !important;
            width: 100% !important;
            font-size: 0.75rem !important;
            display: block;
        }

        /* All-day event styling in resource timeline */
        .fc-daygrid-event {
            padding: 4px 8px !important;
            margin: 3px 2px !important;
            border-radius: 4px !important;
            white-space: normal !important;
            border: none !important;
            border-left: 4px solid var(--accent-primary) !important;
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            overflow: hidden !important;
            gap: 2px !important;
            font-size: 0.75rem !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif !important;
            font-weight: 500 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        .fc-col-header-cell {
            background: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
            padding: 12px 8px !important;
            text-align: center !important;
            word-wrap: break-word !important;
            white-space: normal !important;
            line-height: 1.3 !important;
            min-height: 50px !important;
        }

        .fc-col-header-cell-cushion {
            color: var(--text-primary) !important;
            font-weight: 500 !important;
            text-transform: capitalize !important;
            font-size: 13px !important;
            letter-spacing: 0px !important;
            word-break: break-word !important;
        }

        /* Resource Timeline Customization */
        .fc-timeline {
            background: var(--card-bg);
        }

        .fc-timeline-slot {
            border-color: var(--border-color) !important;
            min-height: 50px !important;
        }

        .fc-resource-timeline .fc-resource {
            background: var(--bg-secondary);
            border-color: var(--border-color) !important;
        }

        .fc-datagrid-cell {
            background: var(--card-bg);
            border-color: var(--border-color) !important;
        }

        .fc-datagrid-cell-cushion {
            color: white !important;
            font-weight: 600 !important;
            padding: 10px 6px !important;
            text-align: center !important;
            word-wrap: break-word !important;
            white-space: normal !important;
            line-height: 1.2 !important;
            font-size: 11px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .fc-datagrid-cell {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-color) !important;
            padding: 0 !important;
            text-align: center !important;
        }

        /* Make week/day view look like a grid table */
        .fc-timeGridWeek-view .fc-col-time-frame,
        .fc-timeGridDay-view .fc-col-time-frame {
            background: white;
        }

        .fc-timegrid-slot {
            height: 100px;
        }

        .fc-timegrid-slot-label {
            vertical-align: middle;
            text-align: center;
            font-weight: 600;
        }

        .fc-col-header-cell {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            font-weight: 500 !important;
            border: 1px solid var(--border-color) !important;
            padding: 12px 8px !important;
            text-align: center !important;
            word-wrap: break-word !important;
            white-space: normal !important;
            line-height: 1.3 !important;
            min-height: 50px !important;
        }

        .fc-timegrid-body {
            border: 1px solid #dee2e6;
        }

        .fc-timegrid-body td {
            border: 1px solid #dee2e6;
        }

        .fc-timegrid-body .fc-timegrid-slot {
            border-top: 1px solid #dee2e6;
        }

        .fc-datagrid-cell {
            border: 1px solid #dee2e6;
            padding: 0 !important;
        }

        .fc-datagrid-cell-cushion {
            font-weight: 600;
        }

        .fc-timegrid-event {
            border: none !important;
            border-left: 4px solid var(--accent-primary) !important;
            border-radius: 4px !important;
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif !important;
            font-weight: 500 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        .fc .fc-timegrid-event .fc-event-time {
            display: none;
        }

        .fc-timegrid-col {
            background: var(--card-bg);
        }

        .fc-timegrid-col.fc-day-today {
            background: var(--accent-light) !important;
        }

        /* Resource Day Grid */
        .fc-resource-daygrid .fc-col-header-cell {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-color) !important;
            padding: 8px 4px !important;
            word-wrap: break-word !important;
            white-space: normal !important;
            color: var(--text-primary) !important;
            font-weight: 500 !important;
        }

        .fc-resource-timeline-divider {
            border-color: var(--border-color) !important;
        }

        .fc-timeline-slot-label {
            border-color: var(--border-color) !important;
        }

        .fc-timeline-slot-frame {
            background: var(--card-bg);
        }

        .fc-timeline-lane {
            border-color: var(--border-color) !important;
            min-height: 50px !important;
        }

        .fc-timeline-lane-frame {
            background: var(--bg-secondary);
            padding: 4px !important;
        }

        /* All-day events in timeline */
        .fc-daygrid-day-frame {
            min-height: 140px !important;
            position: relative;
        }

        .fc-daygrid-day-events {
            display: flex !important;
            flex-direction: column !important;
            flex-wrap: nowrap !important;
            gap: 3px !important;
            padding: 6px !important;
            align-content: flex-start;
            max-height: 130px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Custom scrollbar styling */
        .fc-daygrid-day-events::-webkit-scrollbar {
            width: 4px;
        }
        
        .fc-daygrid-day-events::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .fc-daygrid-day-events::-webkit-scrollbar-thumb {
            background: var(--accent-secondary);
            border-radius: 2px;
            opacity: 0.5;
        }
        
        .fc-daygrid-day-events::-webkit-scrollbar-thumb:hover {
            opacity: 0.8;
        }

        /* Timeline event blocks */
        .fc-timegrid-event {
            margin-bottom: 8px !important;
            margin-left: 4px !important;
            margin-right: 4px !important;
            margin-top: 4px !important;
        }

        .fc-col-time-cell {
            vertical-align: top !important;
            padding-top: 4px !important;
        }

        /* Scrollgrid cell heights */
        .fc-scrollgrid-sync-inner {
            min-height: 100px !important;
        }

        .fc-scrollgrid {
            border-color: var(--border-color) !important;
        }

        .fc-scrollgrid-section > * {
            border-color: var(--border-color) !important;
        }

        .fc-resource-daygrid .fc-col-header-cell {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        .fc-resource-timeline .fc-resource-area {
            border-right: 1px solid var(--border-color) !important;
        }

        .fc-resource-title {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 50px !important;
            width: 100% !important;
        }

        .fc-datagrid-cell-main {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0.75rem !important;
            min-height: 50px !important;
            width: 100% !important;
        }

        .fc-col-header-cell.fc-datagrid-cell {
            padding: 0 !important;
            min-height: 50px !important;
        }

        .fc-resource-daygrid-body {
            border: 1px solid #dee2e6 !important;
        }

        .fc-resource-daygrid-body td {
            border: 1px solid #dee2e6 !important;
            padding: 0 !important;
            height: 60px !important;
        }

        .fc-daygrid-day-events {
            display: block;
            height: 100%;
        }

        .fc-daygrid-day-event {
            margin: 3px 0 !important;
        }
        }

        .resource-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .resource-info {
            display: flex;
            flex-direction: column;
        }

        .resource-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .resource-role {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Legend Panel Styles */
        .legend-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .legend-panel-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-panel-title i {
            color: var(--accent-primary);
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .legend-item-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }

        .legend-item-row:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .legend-item-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .legend-item-info {
            flex: 1;
            min-width: 0;
        }

        .legend-item-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .legend-item-role {
            font-size: 0.7rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Event Badges */
        .event-badge-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1px;
            flex-wrap: wrap;
            width: 100%;
        }
        
        /* Show badges inline */
        .event-priority-flag,
        .event-mini-badge {
            display: inline-flex;
        }
        
        /* Hide employee avatars in calendar events for cleaner view */
        .fc-event span[style*="border-radius:50%"] {
            display: none !important;
        }
        
        .fc-event span[style*="border-radius:3px"] {
            display: none !important;
        }
        
        /* Hide the count badges for people overflow */
        .fc-event span[style*="background:rgba(0,0,0"] {
            display: none !important;
        }

        .event-mini-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            font-size: 0.55rem;
            font-weight: 700;
            border: 1px solid var(--accent-light);
            color: var(--accent-primary);
            background: var(--card-bg);
            flex-shrink: 0;
        }
        
        .event-priority-flag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 10px;
            margin-right: 3px;
            flex-shrink: 0;
            border-radius: 2px;
            position: relative;
            box-shadow: inset -1px -1px 0 rgba(0,0,0,0.2);
        }
        
        .event-priority-flag::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 8px;
            background: rgba(0,0,0,0.3);
        }

        .event-mini-badge.paid {
            border-color: #e0e7ff;
            color: #6366f1;
        }

        .event-mini-badge.overdue {
            border-color: #fee2e2;
            color: #dc2626;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                display: none !important;
            }
            
            .header-controls {
                flex-wrap: wrap;
            }
        }

        /* ============ FLOATING CHAT BUTTON STYLES ============ */
        .floating-chat-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4), 0 0 0 0 rgba(6, 182, 212, 0.4);
            z-index: 9999;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: chat-pulse 2s infinite;
        }
        
        .floating-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(6, 182, 212, 0.5);
            animation: none;
        }
        
        .floating-chat-btn:active {
            transform: scale(0.95);
        }
        
        /* Pulse animation */
        @keyframes chat-pulse {
            0% {
                box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4), 0 0 0 0 rgba(6, 182, 212, 0.4);
            }
            70% {
                box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4), 0 0 0 15px rgba(6, 182, 212, 0);
            }
            100% {
                box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4), 0 0 0 0 rgba(6, 182, 212, 0);
            }
        }
        
        /* Bounce animation for new messages */
        @keyframes chat-bounce {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-8px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(-4px); }
        }
        
        .floating-chat-btn.has-messages {
            animation: chat-bounce 1s ease infinite, chat-pulse 2s infinite;
        }
        
        /* Unread badge on floating button */
        .floating-chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: badge-pop 0.3s ease;
        }
        
        @keyframes badge-pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Chat icon wiggle on sidebar */
        .chat-nav-item {
            position: relative;
        }
        
        .chat-nav-item.has-unread i {
            animation: icon-wiggle 0.5s ease infinite;
        }
        
        @keyframes icon-wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        
        .chat-nav-item.has-unread::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: glow-dot 1.5s ease infinite;
        }
        
        @keyframes glow-dot {
            0%, 100% { box-shadow: 0 0 5px #ef4444; }
            50% { box-shadow: 0 0 15px #ef4444, 0 0 25px #ef4444; }
        }

        /* ============ MOBILE RESPONSIVE STYLES ============ */
        @media (max-width: 768px) {
            /* Hide sidebars on mobile by default */
            .sidebar, .sidebar-right {
                position: fixed;
                top: 50px;
                bottom: 0;
                z-index: 1001;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 280px !important;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            
            .sidebar-right {
                right: 0;
                left: auto;
                transform: translateX(100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .sidebar-right.mobile-open {
                transform: translateX(0);
            }
            
            /* Mobile overlay when sidebar is open */
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 50px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }
            
            .mobile-overlay.active {
                display: block;
            }
            
            /* Main content takes full width on mobile */
            .main-content {
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* Header adjustments */
            .header {
                padding: 0.5rem 1rem;
            }
            
            .header-left {
                gap: 0.5rem;
            }
            
            .logo-container {
                width: 40px !important;
                height: 40px !important;
            }
            
            #customLogoImg {
                width: 40px !important;
                height: 40px !important;
            }
            
            .app-title {
                font-size: 1rem;
            }
            
            #appCompanyName {
                font-size: 1rem;
            }
            
            #appTagline {
                display: none;
            }
            
            .header-controls {
                gap: 0.25rem;
            }
            
            .header-controls button {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            
            /* Hide text in header buttons on mobile */
            .header-controls button span:not(.notification-badge) {
                display: none;
            }
            
            /* Mobile menu toggle button */
            .mobile-menu-btn {
                display: flex !important;
                width: 36px;
                height: 36px;
                align-items: center;
                justify-content: center;
                background: var(--accent-primary);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1.2rem;
            }
            
            /* Calendar adjustments */
            .calendar-container {
                padding: 0.5rem;
            }
            
            .calendar-header h2 {
                font-size: 1rem;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
            
            .event-mini {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
            
            /* Modal adjustments for mobile */
            .modal-content,
            [id$="Modal"] > div:first-child,
            [style*="background: white"][style*="border-radius"] {
                width: 95% !important;
                max-width: none !important;
                max-height: 90vh !important;
                margin: 1rem auto;
                border-radius: 12px !important;
            }
            
            /* Form adjustments */
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                width: 100% !important;
            }
            
            input, select, textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Stats cards */
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            /* Kanban board horizontal scroll */
            .kanban-board {
                overflow-x: auto;
                padding-bottom: 1rem;
            }
            
            .kanban-column {
                min-width: 280px;
            }
            
            /* Settings dropdown */
            #settingsDropdown {
                right: 0;
                left: auto;
                width: 200px;
            }
            
            /* Procedures view */
            #view-procedures {
                flex-direction: column;
            }
            
            .procedures-list {
                width: 100% !important;
                max-width: none !important;
                min-width: auto !important;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .instrument-container {
                padding: 1rem;
            }
            
            /* Working hours calendar */
            .working-hours-container {
                padding: 0.5rem;
            }
            
            .working-hours-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            /* Tables responsive */
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 600px;
            }
            
            /* Chat modal */
            #chatModal > div:first-child {
                width: 100% !important;
                height: 100% !important;
                max-width: none !important;
                max-height: none !important;
                border-radius: 0 !important;
            }
        }
        
        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .header {
                padding: 0.4rem 0.5rem;
            }
            
            .logo-container {
                width: 32px !important;
                height: 32px !important;
            }
            
            #customLogoImg {
                width: 32px !important;
                height: 32px !important;
            }
            
            #appCompanyName {
                font-size: 0.9rem;
            }
            
            .header-controls button {
                padding: 0.3rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .calendar-day {
                min-height: 50px;
                font-size: 0.7rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
            
            .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
        }
    
/* ==== ADDED: Accent palettes (theme colors) ==== */
[data-accent="cyan"]   { --accent-primary:#06b6d4; --accent-secondary:#0891b2; --accent-light:#cffafe; --accent-dark:#0e7490; }
[data-accent="blue"]   { --accent-primary:#3b82f6; --accent-secondary:#2563eb; --accent-light:#dbeafe; --accent-dark:#1e40af; }
[data-accent="purple"] { --accent-primary:#a855f7; --accent-secondary:#9333ea; --accent-light:#f3e8ff; --accent-dark:#7e22ce; }
[data-accent="green"]  { --accent-primary:#10b981; --accent-secondary:#059669; --accent-light:#d1fae5; --accent-dark:#047857; }
[data-accent="teal"]   { --accent-primary:#14b8a6; --accent-secondary:#0d9488; --accent-light:#ccfbf1; --accent-dark:#115e59; }
[data-accent="indigo"] { --accent-primary:#6366f1; --accent-secondary:#4f46e5; --accent-light:#e0e7ff; --accent-dark:#3730a3; }
[data-accent="amber"]  { --accent-primary:#f59e0b; --accent-secondary:#d97706; --accent-light:#fef3c7; --accent-dark:#92400e; }
[data-accent="orange"] { --accent-primary:#f97316; --accent-secondary:#ea580c; --accent-light:#ffedd5; --accent-dark:#9a3412; }
[data-accent="red"]    { --accent-primary:#ef4444; --accent-secondary:#dc2626; --accent-light:#fee2e2; --accent-dark:#991b1b; }
[data-accent="pink"]   { --accent-primary:#ec4899; --accent-secondary:#db2777; --accent-light:#fce7f3; --accent-dark:#9d174d; }
[data-accent="slate"]  { --accent-primary:#64748b; --accent-secondary:#475569; --accent-light:#e2e8f0; --accent-dark:#1f2937; }
[data-accent="rose"]   { --accent-primary:#f43f5e; --accent-secondary:#e11d48; --accent-light:#ffe4e6; --accent-dark:#9f1239; }

/* ==== ADDED: Font color palettes (override text colors globally) ==== */
[data-fontcolor="default"]  { /* keep your defaults */ }
[data-fontcolor="charcoal"] { --text-primary:#111827; --text-secondary:#6b7280; }
[data-fontcolor="slate"]    { --text-primary:#334155; --text-secondary:#64748b; }
[data-fontcolor="neutral"]  { --text-primary:#262626; --text-secondary:#737373; }
[data-fontcolor="ink"]      { --text-primary:#0f172a; --text-secondary:#475569; }
[data-fontcolor="soft"]     { --text-primary:#374151; --text-secondary:#9ca3af; }
[data-fontcolor="contrast"] { --text-primary:#000000; --text-secondary:#4b5563; }
[data-fontcolor="light"]    { --text-primary:#f8f9fa; --text-secondary:#cbd5e1; }

/* ==== ADDED: Calendar fullscreen helper ==== */
.calendar-fullscreen{
  position:fixed !important;
  inset:0 !important;
  background:var(--bg-primary);
  z-index:2000;
  margin:0 !important;
  padding:1rem !important;
  border-radius:0 !important;
  border:none !important;
}

/* ==== PROCEDURES VIEW ==== */
#view-procedures {
    display: none;
    flex-direction: row;
    gap: 0;
    padding: 0;
    height: calc(100vh - 70px);
    width: 100%;
    background: var(--bg-secondary);
}

#view-procedures.active {
    display: flex;
}

.procedures-list {
    background: var(--card-bg);
    border: none;
    border-right: 1px solid var(--border-color);
    border-radius: 0;
    padding: 2rem 1.5rem;
    width: 300px;
    min-width: 300px;
    max-width: 300px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.procedures-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.procedures-list-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
}

.btn-add-procedure {
    padding: 0.5rem 1rem;
    background: var(--accent-primary);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-add-procedure:hover {
    background: var(--accent-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.procedure-item {
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
    background: var(--bg-secondary);
}

.procedure-item:hover {
    border-color: var(--accent-primary);
    background: var(--accent-light);
    box-shadow: 0 2px 8px var(--shadow);
}

.procedure-item.active {
    border-color: var(--accent-primary);
    background: var(--accent-light);
    border-left: 4px solid var(--accent-primary);
}

.procedure-item-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.35rem;
}

.procedure-item-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.procedure-item-meta span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.instrument-container {
    background: var(--card-bg);
    border: none;
    border-radius: 0;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow-y: auto;
}

.container-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.container-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.container-controls {
    display: flex;
    gap: 0.5rem;
}

.tray-visual {
    background: linear-gradient(135deg, #f0f4f8 0%, #e8ecf0 100%);
    border: 2px solid var(--border-color);
    border-radius: 16px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    flex: 1;
    min-height: 180px;
    position: relative;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.75rem;
    overflow-y: auto;
}

.instrument-slot {
    background: var(--card-bg);
    border: 2px dashed var(--border-color);
    border-radius: 6px;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 70px;
    position: relative;
}

.instrument-slot:hover {
    border-color: var(--accent-primary);
    background: var(--accent-light);
    transform: translateY(-2px);
}

.instrument-slot.filled {
    border-color: var(--accent-primary);
    background: var(--accent-light);
    border-style: solid;
}

.instrument-slot-icon {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
    color: var(--text-secondary);
}

.instrument-slot.filled .instrument-slot-icon {
    color: var(--accent-primary);
}

.instrument-slot-label {
    font-size: 0.65rem;
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
}

.instrument-slot.filled .instrument-slot-label {
    color: var(--accent-primary);
    font-weight: 600;
}

.instrument-name {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 0.25rem;
    text-align: center;
    line-height: 1.1;
}

.slot-remove-btn {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #ef4444;
    color: white;
    border: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    opacity: 0;
    transition: all 0.3s ease;
}

.instrument-slot.filled:hover .slot-remove-btn {
    opacity: 1;
}

.slot-remove-btn:hover {
    background: #dc2626;
    transform: scale(1.1);
}

.instrument-selector {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

.selector-title {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.instrument-categories {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.category-btn {
    padding: 0.6rem 1rem;
    border: 2px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.category-btn:hover {
    border-color: var(--accent-primary);
    background: var(--accent-light);
}

.category-btn.active {
    border-color: var(--accent-primary);
    background: var(--accent-primary);
    color: white;
}

.instruments-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
}

.instrument-option {
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    background: var(--bg-secondary);
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.instrument-option:hover {
    border-color: var(--accent-primary);
    background: var(--accent-light);
    transform: translateY(-2px);
}

.instrument-option.selected {
    border-color: var(--accent-primary);
    background: var(--accent-primary);
    color: white;
}

.instrument-option-icon {
    font-size: 1.5rem;
}

.instrument-option-name {
    font-size: 0.75rem;
    font-weight: 600;
}

.procedure-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

.action-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    font-size: 0.9rem;
}

.action-btn-primary {
    background: var(--accent-primary);
    color: white;
}

.action-btn-primary:hover {
    background: var(--accent-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.action-btn-secondary:hover {
    background: var(--border-color);
}

.action-btn-danger {
    background: #ef4444;
    color: white;
}

.action-btn-danger:hover {
    background: #dc2626;
}

/* ============ KANBAN BOARD STYLES ============ */
#view-projects {
    display: none;
    width: 100%;
    background: var(--bg-secondary);
    overflow: hidden;
}

#view-projects.active {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.kanban-header {
    background: var(--card-bg);
    border-bottom: 2px solid var(--border-color);
    padding: 1rem 1.5rem;
    flex-shrink: 0;
}

.kanban-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.kanban-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.kanban-title i {
    color: var(--accent-primary);
}

.kanban-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.kanban-filter {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.kanban-filter:hover {
    border-color: var(--accent-primary);
    background: var(--accent-light);
}

.kanban-filter.active {
    border-color: var(--accent-primary);
    background: var(--accent-primary);
    color: white;
}

.btn-new-project {
    padding: 0.6rem 1.25rem;
    background: var(--accent-primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
}

.btn-new-project:hover {
    background: var(--accent-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.kanban-stats {
    display: flex;
    gap: 2rem;
    padding: 0.75rem 0;
}

.kanban-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.kanban-stat-value {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-primary);
}

.kanban-container {
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 1rem;
    min-height: 0;
}

.kanban-board {
    display: flex;
    gap: 1rem;
    min-width: min-content;
    height: 100%;
    padding-right: 1rem;
}

.kanban-column {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    width: 260px;
    min-width: 260px;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 250px);
}

.kanban-column-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9fafb;
}

.kanban-column-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.kanban-column-badge {
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
    border: none;
    min-width: 22px;
    text-align: center;
}

.kanban-column-actions {
    display: flex;
    gap: 0.5rem;
}

.kanban-column-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.kanban-column-btn:hover {
    background: var(--bg-secondary);
    color: var(--accent-primary);
}

.kanban-column-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.kanban-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem;
    cursor: move;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.kanban-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.kanban-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
}

.kanban-card-title {
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--text-primary);
    line-height: 1.3;
    flex: 1;
}

.kanban-card-priority {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
}

.priority-high {
    background: #fee2e2;
    color: #dc2626;
}

.priority-medium {
    background: #fef3c7;
    color: #d97706;
}

.priority-low {
    background: #dbeafe;
    color: #2563eb;
}

.kanban-card-description {
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.4;
    margin-bottom: 0.5rem;
}

.kanban-card-tags {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
}

.kanban-tag {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    background: var(--accent-light);
    color: var(--accent-primary);
    border: 1px solid var(--accent-primary);
}

.kanban-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

.kanban-card-assignees {
    display: flex;
    align-items: center;
}

.kanban-avatar {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: var(--accent-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 700;
    border: 2px solid var(--bg-secondary);
    margin-left: -6px;
}

.kanban-avatar:first-child {
    margin-left: 0;
}

.kanban-card-meta {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.kanban-card-meta span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.kanban-card-meta i {
    font-size: 0.7rem;
}

.kanban-card-due {
    color: #ef4444;
    font-weight: 600;
}

/* Kanban Column Colors */
.kanban-column.backlog .kanban-column-title i { color: #6b7280; }
.kanban-column.todo .kanban-column-title i { color: #3b82f6; }
.kanban-column.in-progress .kanban-column-title i { color: #eab308; }
.kanban-column.review .kanban-column-title i { color: #a855f7; }
.kanban-column.done .kanban-column-title i { color: #10b981; }

/* Empty State */
.kanban-empty {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.kanban-empty i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

/* ==== Floating Tasks & Mark as Completed ==== */
.floating-tasks-panel {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 380px;
    max-height: 600px;
    background: var(--card-bg);
    border: 2px solid var(--accent-primary);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    z-index: 1500;
    display: none;
    flex-direction: column;
    animation: slideInUp 0.3s ease;
}

.floating-tasks-panel.active { display: flex; }
.floating-tasks-panel.minimized { height: 60px; overflow: hidden; }

@keyframes slideInUp {
    from { opacity: 0; transform: translateY(100px); }
    to { opacity: 1; transform: translateY(0); }
}

.floating-tasks-header {
    padding: 1rem 1.25rem;
    background: var(--accent-primary);
    color: white;
    border-radius: 14px 14px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.floating-tasks-title {
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.floating-tasks-badge {
    background: white;
    color: var(--accent-primary);
    padding: 0.25rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
}

.floating-tasks-controls { display: flex; gap: 0.5rem; }

.floating-tasks-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.floating-tasks-btn:hover { background: rgba(255, 255, 255, 0.3); }

.floating-tasks-body {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
}

.floating-task-item {
    padding: 1rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    animation: fadeInSlide 0.3s ease;
}

@keyframes fadeInSlide {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.floating-task-item:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 4px 12px var(--shadow);
}

.floating-task-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
}

.floating-task-title {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
    flex: 1;
}

.floating-task-badges { display: flex; gap: 0.375rem; flex-shrink: 0; }

.floating-task-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.floating-task-badge.paid { background: #10b981; color: white; }
.floating-task-badge.priority { background: #d97706; color: white; }

.floating-task-desc {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    line-height: 1.5;
}

.floating-task-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.floating-task-meta i { margin-right: 0.25rem; }

.floating-task-actions { display: flex; gap: 0.5rem; }

.claim-task-btn {
    flex: 1;
    padding: 0.625rem;
    background: var(--accent-primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.claim-task-btn:hover {
    background: var(--accent-secondary);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.dismiss-task-btn {
    padding: 0.625rem 0.875rem;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.dismiss-task-btn:hover {
    background: var(--border-color);
    color: var(--text-primary);
}

.no-floating-tasks {
    padding: 2rem;
    text-align: center;
    color: var(--text-secondary);
}

.no-floating-tasks i {
    font-size: 3rem;
    opacity: 0.3;
    margin-bottom: 1rem;
    display: block;
}

.floating-tasks-toggle {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    background: var(--accent-primary);
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    z-index: 1400;
    transition: all 0.3s ease;
}

.floating-tasks-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
}

.floating-tasks-toggle .notification-dot {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background: #ef4444;
    border: 2px solid var(--card-bg);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
}

@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-8px);
    }
}

@keyframes bounce-icon {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-6px);
    }
    60% {
        transform: translateY(-3px);
    }
}

.bounce-icon {
    animation: bounce-icon 2s ease infinite;
    display: inline-block;
}

.btn-completed {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.btn-completed:hover { background: #059669; }

.fc-event.completed {
    opacity: 0.6;
    text-decoration: line-through;
}

.event-mini-badge.completed {
    border-color: #e0e7ff;
    color: #6366f1;
}

.modal-badge.completed {
    background: #10b981;
    color: white;
}

        /* === SIMPLE ONE-ROW HEADER STYLE (STYLE ONLY, NO HTML CHANGES) === */
        #calendarSection .section-header,
        #calendarSection .view-mode-switcher,
        #calendarSection #viewFilterContainer,
        #calendarSection #eventFilterControls {
            background: #f8f9fa !important;
            border-bottom: 1px solid #e6b27f;
        }

        /* Put them visually one after another, small and compact */
        #calendarSection .section-header {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.4rem;
            padding: 0.25rem 0.5rem;
            margin: 0;
        }

        #calendarSection .view-mode-switcher,
        #calendarSection #viewFilterContainer,
        #calendarSection #eventFilterControls {
            display: inline-flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.3rem;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
        }

        /* Small buttons & controls */
        #calendarSection .header-actions .btn,
        #calendarSection .header-actions button,
        #calendarSection .view-mode-btn,
        #calendarSection .clear-filter-btn,
        #calendarSection .view-mode-buttons .view-mode-btn {
            font-size: 0.7rem !important;
            padding: 0.15rem 0.4rem !important;
            border-radius: 4px !important;
            white-space: nowrap !important;
        }

        #calendarSection .filter-select,
        #calendarSection select {
            font-size: 0.7rem !important;
            padding: 0.15rem 0.3rem !important;
            height: auto;
        }

        #calendarSection .filter-label,
        #calendarSection .view-mode-label span {
            font-size: 0.7rem !important;
        }

        #calendarSection .view-mode-toggle,
        #calendarSection .filter-group,
        #calendarSection .view-mode-buttons {
            display: inline-flex !important;
            flex-wrap: nowrap !important;
            gap: 0.2rem;
        }

        /* Keep header tight to calendar */
        #calendarSection #calendar {
            margin-top: 0.2rem;
        }

        /* --- Refined professional calendar header --- */
        #calendarSection .section-header {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            margin: 0;
            background: #fff7ec; /* softer beige */
            /* border-bottom: 1px solid #e0b27a; */
            box-shadow: none;
            overflow-x: auto;
        }

        #calendarSection .section-title {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.7rem;
            margin: 0;
        }

        #calendarSection .section-title i {
            display: none; /* cleaner like Dentrix */
        }

        #calendarSection #viewTitle {
            font-weight: 600;
            color: #c46a1a; /* orange similar to screenshot */
            white-space: nowrap;
        }

        #calendarSection .header-actions {
            display: inline-flex;
            align-items: center;
            gap: 0.15rem;
        }

        #calendarSection .header-actions .btn,
        #calendarSection .header-actions button {
            font-size: 0.6rem !important;
            padding: 0.12rem 0.35rem !important;
            border-radius: 6px !important;
            white-space: nowrap !important;
            height: 22px !important;
        }

        #calendarSection .view-mode-switcher,
        #calendarSection #viewFilterContainer,
        #calendarSection #eventFilterControls {
            display: inline-flex !important;
            align-items: center;
            flex-wrap: nowrap !important;
            gap: 0.15rem;
            padding: 0;
            margin: 0;
            border: none !important;
            background: transparent !important;
        }

        #calendarSection .view-mode-label span,
        #calendarSection .filter-label {
            font-size: 0.7rem !important;
        }

        #calendarSection .view-mode-toggle,
        #calendarSection .filter-group,
        #calendarSection .view-mode-buttons {
            display: inline-flex !important;
            flex-wrap: nowrap !important;
            gap: 0.1rem;
        }

        #calendarSection .view-mode-btn,
        #calendarSection .clear-filter-btn {
            font-size: 0.55rem !important;
            padding: 0.1rem 0.3rem !important;
            border-radius: 4px !important;
            white-space: nowrap !important;
        }

        #calendarSection .filter-select,
        #calendarSection select {
            font-size: 0.6rem !important;
            padding: 0.1rem 0.25rem !important;
            height: auto;
        }

        /* Display and style FullCalendar's header toolbar */
        #calendarSection .fc-header-toolbar {
            display: flex !important;
        }

        /* === Uniform button style with separating borders on calendar header === */
        #calendarSection .header-actions .btn,
        #calendarSection .header-actions button,
        #calendarSection .view-mode-btn,
        #calendarSection .clear-filter-btn,
        #calendarSection .view-mode-buttons .view-mode-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem !important;
            padding: 0.1rem 0.3rem !important;
            min-height: 18px !important;
            border-radius: 4px !important;
            background: #00a9d6 !important;    /* unified teal/blue */
            color: #ffffff !important;
            border: 1px solid #0088aa !important;
            box-shadow: none !important;
            white-space: nowrap !important;
        }

        /* Light border/spacing between adjacent buttons so they read as separate segments */
        #calendarSection .header-actions .btn + .btn,
        #calendarSection .header-actions button + button,
        #calendarSection .view-mode-toggle .view-mode-btn + .view-mode-btn,
        #calendarSection .view-mode-buttons .view-mode-btn + .view-mode-btn {
            margin-left: 2px;
        }

        /* === Header like reference: text links + active pill === */
        /* General header actions: simple blue text, no filled box */
        #calendarSection .header-actions .btn,
        #calendarSection .header-actions button {
            background: transparent !important;
            color: #1e40af !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 0.6rem !important;
            padding: 0 0.3rem !important;
            min-height: auto;
            border-radius: 0 !important;
            white-space: nowrap !important;
        }

        /* Thin separators between header action items */
        #calendarSection .header-actions .btn + .btn,
        #calendarSection .header-actions button + button {
            border-left: 1px solid #d0d0d0 !important;
            padding-left: 0.4rem !important;
            margin-left: 0.15rem !important;
        }

        /* View mode buttons styled like calendar buttons */
        #calendarSection .view-mode-btn {
            background: transparent !important;
            color: var(--text-primary) !important;
            border: 1.5px solid var(--border-color) !important;
            box-shadow: none !important;
            border-radius: 6px !important;
            padding: 0.5rem 0.75rem !important;
            font-size: 0.75rem !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }

        #calendarSection .view-mode-btn:hover {
            border-color: var(--accent-primary) !important;
            color: var(--accent-primary) !important;
        }

        #calendarSection .view-mode-btn i {
            margin-right: 0.3rem;
        }

        /* Active mode shown with blue background */
        #calendarSection .view-mode-btn.active {
            background: var(--accent-primary) !important;
            border-radius: 6px !important;
            border: 1.5px solid var(--accent-primary) !important;
            color: white !important;
            padding: 0.5rem 0.75rem !important;
        }

        /* === FINAL CLEAN SMALL HEADER STYLE === */
        #calendarSection .section-title,
        #calendarSection .view-mode-label {
            display: none !important;
        }

        #calendarSection .section-header,
        #calendarSection .view-mode-switcher,
        #calendarSection #viewFilterContainer,
        #calendarSection #eventFilterControls {
            background: #f8f9fa !important;
            border-bottom: 1px solid #1e40af !important;
            padding: 0.15rem 0.4rem !important;
        }

        #calendarSection .header-actions button,
        #calendarSection .view-mode-btn,
        #calendarSection .clear-filter-btn {
            font-size: 0.62rem !important;
            padding: 0.1rem 0.35rem !important;
            background: transparent !important;
            color: #005a99 !important;
            border: none !important;
        }

        #calendarSection .header-actions button + button,
        #calendarSection .view-mode-btn + .view-mode-btn,
        #calendarSection #viewFilterContainer > * + * {
            border-left: 1px solid #cfcfcf !important;
            margin-left: 0.25rem !important;
            padding-left: 0.35rem !important;
        }

        #calendarSection .view-mode-btn.active {
            background: #ffe9d1 !important;
            color: #d96f1a !important;
            border: 1px solid #f0a567 !important;
            border-radius: 10px !important;
            padding: 0.1rem 0.45rem !important;
        }

        #viewTitle {
            display: none !important;
        }

        #calendarSection select {
            font-size: 0.62rem !important;
            padding: 0.05rem 0.2rem !important;
            height: auto !important;
        }

        /* === Remove blue; unify all header items to orange text === */
        #calendarSection .header-actions button,
        #calendarSection .view-mode-btn,
        #calendarSection .clear-filter-btn {
            color: #1e40af !important; /* orange text */
        }

        /* Active pill: darker orange background */
        #calendarSection .view-mode-btn.active {
            background: #fbe2c4 !important;
            color: #d96f1a !important;
            border-color: #d96f1a !important;
        }

        /* Ensure no residual blue backgrounds */
        #calendarSection .header-actions button,
        #calendarSection .view-mode-btn {
            background: transparent !important;
            border-radius: 10px !important;
        }

        /* FINAL FIX: Force ALL view-mode buttons (By Employee, Room, etc.) to orange */
        #calendarSection .view-mode-btn {
            color: #1e40af !important;
            background: transparent !important;
            border: none !important;
        }
        #calendarSection .view-mode-btn.active {
            background: #ffffff !important;
            color: #1e40af !important;
            border: 1px solid #1e40af !important;
        }

        /* === Restore FullCalendar month/week/day toolbar === */
        #calendarSection .fc-header-toolbar {
            display: flex !important;
            align-items: center;
            justify-content: space-between;
            padding: 0.25rem 0.4rem;
            margin: 0 0 0.75rem 0;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            gap: 0.35rem;
        }

        #calendarSection .fc-header-toolbar .fc-toolbar-chunk {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        #calendarSection .fc-header-toolbar .fc-toolbar-chunk:first-child {
            flex: 0 0 auto;
        }

        #calendarSection .fc-header-toolbar .fc-toolbar-chunk:nth-child(2) {
            flex: 1;
            justify-content: center;
        }

        #calendarSection .fc-header-toolbar .fc-toolbar-chunk:last-child {
            flex: 0 0 auto;
        }

        #calendarSection .fc .fc-button {
            background: transparent;
            border: 1.5px solid transparent;
            color: var(--text-primary);
            font-size: 0.5rem;
            padding: 0.2rem 0.35rem;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #calendarSection .fc .fc-button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        #calendarSection .fc .fc-button-active {
            background: transparent !important;
            color: var(--accent-primary) !important;
            border: 2px solid var(--accent-primary) !important;
            border-radius: 5px !important;
            font-weight: 700;
            padding: 0.2rem 0.35rem !important;
        }

        #calendarSection .fc-toolbar-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            white-space: nowrap;
        }

        /* Sticky Notes Panel Styles */
        #stickyNotesPanel {
            display: none !important;
            position: fixed !important;
            top: 100px !important;
            right: 20px !important;
            width: 320px !important;
            background: white !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            z-index: 10001 !important;
            overflow: hidden !important;
            max-height: 500px !important;
        }

        #stickyNotesPanel.sticky-notes-open {
            display: block !important;
        }

        /* Sticky Notes Board Styles */
        #view-sticky-notes {
            display: none !important;
        }

        #view-sticky-notes.active {
            display: flex !important;
            flex-direction: column !important;
            height: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            background: linear-gradient(135deg, #f5f7fa 0%, #f0f4f8 100%);
        }

        #view-sticky-notes.active > div {
            display: flex;
            flex-direction: row;
            height: 100%;
            padding: 1.5rem !important;
            gap: 1.5rem;
        }

        #view-sticky-notes.active > div > div:first-child {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Vertical Sidebar */
        .sticky-notes-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--accent-primary);
            width: 200px;
            flex-shrink: 0;
        }

        .sticky-notes-title-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .sticky-notes-title-vertical h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .sticky-notes-title-vertical i {
            font-size: 1.8rem;
            color: var(--accent-primary);
        }

        .color-picker-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .color-picker-vertical label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
        }

        .color-options-vertical {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        #stickyBoard {
            flex: 1 !important;
            overflow: auto !important;
            position: relative !important;
        }

        /* Sticky Notes Search Highlight */
        .sticky-search-highlight {
            box-shadow: 0 0 0 3px var(--accent-primary), 0 8px 25px rgba(0,0,0,0.2) !important;
            transition: all 0.3s ease !important;
        }
        
        .sticky-note-item {
            transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Paper Shredding Animation */
        @keyframes paperTear {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            20% { transform: translateY(-10px) rotate(-5deg); }
            40% { transform: translateY(20px) rotate(8deg) scaleY(0.9); }
            60% { transform: translateY(60px) rotate(-3deg) scaleY(0.7); }
            80% { transform: translateY(120px) rotate(5deg) scaleY(0.4); opacity: 0.5; }
            100% { transform: translateY(200px) rotate(0deg) scaleY(0.1); opacity: 0; }
        }
        
        @keyframes shredStrip {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(150px) rotate(var(--rotate)) scaleX(0.3); opacity: 0; }
        }
        
        .sticky-shredding {
            animation: paperTear 0.6s ease-in forwards;
            pointer-events: none;
        }
        
        .shred-strip {
            position: absolute;
            background: inherit;
            animation: shredStrip 0.8s ease-in forwards;
            border-radius: 2px;
        }

        .sticky-notes-stats {
            background: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 2.5rem;
            justify-content: flex-start;
            border-left: 4px solid var(--accent-primary);
            flex-shrink: 0;
        }

        .color-option-professional {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 3px;
            border: none;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            min-height: 40px;
            position: relative;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(0px) rotateX(0deg);
            perspective: 1000px;
        }

        /* Stack effect - second layer */
        .color-option-professional::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 2px;
            right: -2px;
            bottom: 3px;
            background: inherit;
            border-radius: 3px;
            z-index: -1;
            opacity: 0.7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Stack effect - third layer */
        .color-option-professional::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 4px;
            right: -4px;
            bottom: 6px;
            background: inherit;
            border-radius: 3px;
            z-index: -2;
            opacity: 0.4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .color-option-professional:active {
            cursor: grabbing;
            transform: translateY(-2px) scale(1.02);
        }

        .color-option-professional:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.2),
                0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .color-option-professional:hover::before {
            opacity: 0.85;
            top: -5px;
        }

        .color-option-professional:hover::after {
            opacity: 0.55;
            top: -8px;
        }

        .color-option-professional.active {
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1),
                0 0 0 3px rgba(var(--accent-primary-rgb), 0.3);
        }

        .sticky-note-btn-professional {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            background: var(--accent-primary);
            color: white;
            width: 100%;
        }

        .sticky-note-btn-professional:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            opacity: 0.9;
        }

        .btn-add-professional {
            background: var(--accent-primary);
            color: white;
        }

        .btn-add-professional:hover {
            opacity: 0.85;
        }

        .btn-clear-professional {
            background: var(--accent-primary);
            color: white;
        }

        .btn-clear-professional:hover {
            opacity: 0.85;
        }

        .btn-print-professional {
            background: var(--accent-primary);
            color: white;
        }

        .btn-print-professional:hover {
            opacity: 0.85;
        }

        .btn-pdf-professional {
            background: var(--accent-primary);
            color: white;
        }

        .btn-pdf-professional:hover {
            opacity: 0.85;
        }

        #stickyBoard {
            flex: 1 !important;
            overflow: hidden !important;
            position: relative !important;
        }

        #view-sticky-notes.active > div > div:last-child {
            flex-shrink: 0;
        }

        .sticky-notes-stats {
            background: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 2.5rem;
            justify-content: flex-start;
            border-left: 4px solid var(--accent-primary);
        }

        .stat-item-professional {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #555;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .stat-item-professional i {
            font-size: 1.1rem;
            color: var(--accent-primary);
        }

        .stat-item-professional strong {
            color: var(--accent-primary);
            font-size: 1rem;
        }

        .sticky-note-item {
            position: absolute;
            width: 220px;
            min-height: 160px;
            padding: 1.25rem;
            border-radius: 2px;
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.12),
                0 4px 8px rgba(0, 0, 0, 0.15),
                inset 0 -1px 3px rgba(0, 0, 0, 0.1);
            cursor: move;
            user-select: none;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            perspective: 1000px;
            transform: rotateX(0.5deg) rotateY(0deg) rotateZ(0deg);
            resize: both;
            min-width: 180px;
        }

        .sticky-note-resize-handle {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 0%, transparent 50%, rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.1) 100%);
            border-radius: 2px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .sticky-note-item:hover .sticky-note-resize-handle {
            opacity: 1;
        }

        .sticky-note-item:nth-child(2n) {
            transform: rotateX(0.3deg) rotateY(0deg) rotateZ(-1deg);
        }

        .sticky-note-item:nth-child(3n) {
            transform: rotateX(0.4deg) rotateY(0deg) rotateZ(0.8deg);
        }

        .sticky-note-item:nth-child(4n) {
            transform: rotateX(0.2deg) rotateY(0deg) rotateZ(-0.5deg);
        }

        .sticky-note-item:hover {
            box-shadow: 
                0 2px 5px rgba(0, 0, 0, 0.15),
                0 8px 16px rgba(0, 0, 0, 0.2),
                inset 0 -1px 3px rgba(0, 0, 0, 0.1);
            transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) translateY(-3px);
        }

        .sticky-note-item.dragging {
            box-shadow: 
                0 4px 10px rgba(0, 0, 0, 0.18),
                0 12px 24px rgba(0, 0, 0, 0.25),
                inset 0 -1px 3px rgba(0, 0, 0, 0.1);
            opacity: 0.98;
            z-index: 1000;
            transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1.02);
        }

        .sticky-note-header-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.08);
            min-height: 40px;
        }

        .sticky-note-time-item {
            font-size: 0.75rem;
            opacity: 0.65;
            line-height: 1.3;
            flex: 1;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .sticky-note-close-item {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #999;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 0.75rem;
            border-radius: 50%;
        }

        .sticky-note-close-item:hover {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .sticky-note-content-item {
            flex: 1;
            resize: none;
            border: none;
            background: transparent;
            color: #2c3e50;
            font-size: 0.95rem;
            line-height: 1.5;
            font-family: inherit;
            width: 100%;
            outline: none;
        }

        /* Professional Color Palette with 3D Texture */
        .sticky-note-item.yellow { 
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #fbbf24;
        }

        .sticky-note-item.yellow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 2px;
        }

        .sticky-note-item.pink { 
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            color: #831843;
            border-left: 4px solid #ec4899;
        }

        .sticky-note-item.pink::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 2px;
        }

        .sticky-note-item.blue { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #3b82f6;
        }

        .sticky-note-item.blue::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 2px;
        }

        .sticky-note-item.green { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #10b981;
        }

        .sticky-note-item.green::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 2px;
        }

        .sticky-note-item.purple { 
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            color: #6b21a8;
            border-left: 4px solid #a855f7;
        }

        .sticky-note-item.purple::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 2px;
        }

        .sticky-note-item.orange { 
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            border-left: 4px solid #f97316;
        }

        .sticky-note-item.orange::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, transparent 50%, rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 2px;
        }

        .sticky-note-item.pink .sticky-note-content-item,
        .sticky-note-item.purple .sticky-note-content-item {
            color: inherit;
        }

        .sticky-note-item.pink .sticky-note-close-item,
        .sticky-note-item.purple .sticky-note-close-item {
            color: rgba(0, 0, 0, 0.4);
        }

        .sticky-note-item.pink .sticky-note-close-item:hover,
        .sticky-note-item.purple .sticky-note-close-item:hover {
            background: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }

        .sticky-note-item.pink .sticky-note-time-item,
        .sticky-note-item.purple .sticky-note-time-item {
            opacity: 0.7;
        }

        .sticky-color-option:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.2),
                0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .sticky-color-option:hover::before {
            opacity: 0.85;
            top: -5px;
        }

        .sticky-color-option:hover::after {
            opacity: 0.55;
            top: -8px;
        }

        .sticky-color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 3px;
            border: none;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            min-height: 40px;
            position: relative;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(0px);
            perspective: 1000px;
        }

        /* Stack effect - second layer */
        .sticky-color-option::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 2px;
            right: -2px;
            bottom: 3px;
            background: inherit;
            border-radius: 3px;
            z-index: -1;
            opacity: 0.7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Stack effect - third layer */
        .sticky-color-option::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 4px;
            right: -4px;
            bottom: 6px;
            background: inherit;
            border-radius: 3px;
            z-index: -2;
            opacity: 0.4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .sticky-color-option:active {
            cursor: grabbing;
            transform: translateY(-2px) scale(1.02);
        }

        .sticky-color-option.active {
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.15),
                0 4px 8px rgba(0, 0, 0, 0.1),
                0 0 0 3px rgba(var(--accent-primary-rgb), 0.3) !important;
        }
</style>
</head>
<body>
<!-- Sticky Notes Panel -->

    <!-- Header -->
    <div class="header">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileSidebar()" style="display: none;">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="logo-section" onclick="switchContentView('calendar', event)" style="cursor: pointer;" title="Go to Calendar">
            <div class="logo-container" id="appLogoContainer">
                <!-- Dynamic logo will be inserted here -->
                <i class="fas fa-tooth logo-placeholder" id="defaultLogoIcon"></i>
                <img id="customLogoImg" src="" alt="Company Logo" style="display: none; width: 100%; height: 100%; object-fit: contain;">
            </div>
            <div class="brand-text">
                <h1 id="appCompanyName">ReformDental</h1>
                <p id="appTagline">Management System</p>
            </div>
        </div>

        <div class="header-controls">
            <!-- Clinic Filter -->
            <div class="selector-group" id="clinicFilterContainer" style="display:flex;gap:.5rem;align-items:center">
                <label for="clinicFilterSelect" style="font-size:.85rem;opacity:.8">Clinic</label>
                <select id="clinicFilterSelect" onchange="applyClinicFilter(this.value)">
                    <option value="">All Clinics</option>
                    <!-- Options will be loaded dynamically from offices -->
                </select>
            </div>
            
            <!-- Theme Controls -->
            <div class="theme-controls">
                <!-- Theme Preset Dropdown -->
                <div class="selector-group" style="display:flex;gap:.5rem;align-items:center">
                    <label for="themePresetSelect" style="font-size:.85rem;opacity:.8">Theme</label>
                    <select id="themePresetSelect" onchange="setThemePreset(this.value)">
                        <option value="ocean">Ocean</option>
                        <option value="sunset">Sunset</option>
                        <option value="forest">Forest</option>
                        <option value="professional">Professional</option>
                        <option value="soft">Soft</option>
                        <option value="vibrant">Vibrant</option>
                        <option value="high-contrast" selected>High Contrast</option>
                    </select>
                </div>

                <!-- Accent Color Dropdown -->
                <div class="selector-group" style="display:flex;gap:.5rem;align-items:center;margin-left:.75rem">
                    <label for="accentColorSelect" style="font-size:.85rem;opacity:.8">Accent</label>
                    <select id="accentColorSelect" onchange="setAccent(this.value)">
                        <option value="cyan">Cyan</option>
                        <option value="blue">Blue</option>
                        <option value="purple">Purple</option>
                        <option value="green" selected>Green</option>
                    </select>
                </div>

                <!-- Dark/Light Toggle -->
                <button class="theme-toggle" onclick="toggleTheme()" style="margin-left:.75rem">
                    <i class="fas fa-moon"></i>
                </button>
            </div>

            <!-- User Profile -->
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="displayUserName">Dr. Smith</div>
                    <div class="user-role" id="currentRole">Administrator</div>
                </div>
            </div>

            <!-- Settings Button with Dropdown -->
            <div style="position: relative; margin-left: 0.5rem;">
                <button class="theme-toggle" onclick="toggleSettingsMenu()" title="Settings" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                </button>
                <div id="settingsDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); min-width: 200px; z-index: 1000;">
                    <div style="padding: 0.5rem 0;">
                        <button id="masterSettingsMenuItem" onclick="openMasterSettings(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-sliders-h" style="margin-right: 0.75rem; width: 20px; color: #6366f1;"></i>
                            <span>Master Settings</span>
                        </button>
                        <button id="manageOfficesMenuItem" onclick="openOfficesManagement(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-building" style="margin-right: 0.75rem; width: 20px; color: var(--accent-primary);"></i>
                            <span>Manage Office</span>
                        </button>
                        <button id="manageRoomsMenuItem" onclick="openRoomsManagement(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-door-open" style="margin-right: 0.75rem; width: 20px; color: var(--accent-primary);"></i>
                            <span>Manage Rooms</span>
                        </button>
                        <button id="manageUsersMenuItem" onclick="openUserManagement(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-users-cog" style="margin-right: 0.75rem; width: 20px; color: var(--accent-primary);"></i>
                            <span>Manage Users</span>
                        </button>
                        <button id="managePermissionsMenuItem" onclick="openPermissionsManagement(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-shield-alt" style="margin-right: 0.75rem; width: 20px; color: #8b5cf6;"></i>
                            <span>Manage Permissions</span>
                        </button>
                        <button id="scheduleManagerMenuItem" onclick="openScheduleManager(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-calendar-check" style="margin-right: 0.75rem; width: 20px; color: var(--accent-primary);"></i>
                            <span>Manage Schedule</span>
                        </button>
                        <button id="manageTasksMenuItem" onclick="openTasksManagement(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-tasks" style="margin-right: 0.75rem; width: 20px; color: var(--accent-primary);"></i>
                            <span>Manage Tasks</span>
                        </button>
                        <button id="manageDutiesMenuItem" onclick="openDutiesManagement(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-clipboard-check" style="margin-right: 0.75rem; width: 20px; color: #10b981;"></i>
                            <span>Manage Duties</span>
                        </button>
                        <div style="border-top: 1px solid var(--border-color); margin: 0.5rem 0;"></div>
                        <button id="resetDataMenuItem" onclick="openResetDataModal(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; display: none; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-database" style="margin-right: 0.75rem; width: 20px; color: #f59e0b;"></i>
                            <span>Reset Data</span>
                        </button>
                        <button onclick="logout(); toggleSettingsMenu();" style="width: 100%; text-align: left; padding: 0.75rem 1rem; background: none; border: none; color: var(--text-primary); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'">
                            <i class="fas fa-sign-out-alt" style="margin-right: 0.75rem; width: 20px; color: #ef4444;"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Toggle Buttons (Left Side) -->
    <div class="sidebar-toggle-buttons" id="toggleButtonsLeft">
        <button class="toggle-btn" id="toggleBtnLeft" onclick="toggleSidebarLeft()" title="Hide/Show Left Sidebar">
            <i class="fas fa-chevron-left"></i>
        </button>
    </div>

    <!-- Sidebar Toggle Buttons (Right Side) -->
    <div class="sidebar-toggle-buttons right-side" id="toggleButtonsRight">
        <button class="toggle-btn" id="toggleBtnRight" onclick="toggleSidebarRight()" title="Hide/Show Right Sidebar">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-tooth" style="font-size: 3rem; color: var(--accent-primary); margin-bottom: 1rem;"></i>
                <h2>ReformDental</h2>
                <p>Management System</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event); return false;">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <div id="loginError" class="login-error" style="display: none;"></div>
                <button type="submit" class="login-btn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="mainSidebar">
            <div style="display: flex; justify-content: center; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                <a href="#" class="nav-item active" onclick="switchContentView('calendar', event)" style="width: 100%; justify-content: center; background: var(--accent-primary); color: white; border-radius: 8px; padding: 0.75rem;">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
            </div>

            <!-- User View -->
            <div class="nav-section" data-section="my-work">
                <div class="nav-title">
                    <span>MY WORK</span>
                    <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="nav-items">
                    <a href="#" class="nav-item" onclick="switchContentView('schedule', event)">
                        <i class="fas fa-clock"></i>
                        <span>My Schedule</span>
                        <span class="nav-badge">5</span>
                    </a>
                    <a href="#" class="nav-item" onclick="switchContentView('duties', event)">
                        <i class="fas fa-clipboard-check"></i>
                        <span>My Duties</span>
                        <span class="nav-badge">4</span>
                    </a>
                    <a href="#" class="nav-item" onclick="switchContentView('tasks', event)">
                        <i class="fas fa-list-check"></i>
                        <span>My Tasks</span>
                        <span class="nav-badge">6</span>
                    </a>
                    <a href="#" class="nav-item" onclick="toggleFloatingTasksPanel(); event.preventDefault();">
                        <i class="fas fa-clipboard-list bounce-icon"></i>
                        <span>Floating Tasks</span>
                        <span class="nav-badge" id="floatingTasksNavBadge">5</span>
                    </a>
                    <a href="#" class="nav-item" onclick="toggleBonusTasksPanel(); event.preventDefault();">
                        <i class="fas fa-star bounce-icon"></i>
                        <span>Bonus Tasks</span>
                        <span class="nav-badge" id="bonusTasksNavBadge" style="background: #eab308;">3</span>
                    </a>
                    <a href="#" class="nav-item" onclick="switchContentView('requests', event)">
                        <i class="fas fa-paper-plane"></i>
                        <span>Requests</span>
                    </a>
                    <a href="#" class="nav-item" onclick="switchContentView('projects', event)">
                        <i class="fas fa-project-diagram"></i>
                        <span>Projects</span>
                    </a>
                    <a href="#" class="nav-item" onclick="switchContentView('sticky-notes', event)">
                        <i class="fas fa-sticky-note"></i>
                        <span>Sticky Notes</span>
                    </a>
                </div>
            </div>

            <!-- HR & Personal Section -->
            <div class="nav-section collapsed" data-section="hr-personal">
                <div class="nav-title">
                    <span>HR &amp; PERSONAL</span>
                    <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                </div>
                <div class="nav-items">
                    <a href="#" class="nav-item">
                        <i class="fas fa-user-circle"></i>
                        <span>My Profile</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-credit-card"></i>
                        <span>Pay Stubs</span>
                        <span class="nav-badge">2</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-calendar"></i>
                        <span>Time Off</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-file-alt"></i>
                        <span>My Documents</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-bell"></i>
                        <span>Benefits</span>
                        <span class="nav-badge">1</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Compliances</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Evaluations</span>
                    </a>
                    <a href="#" class="nav-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Onboarding</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Frozen Header with Stats -->
            <div class="dashboard-header">
                

            <!-- Stats Cards - User View -->
            <div class="stats-grid" style="display: none;" data-user-stats="">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #06b6d4;">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">My Tasks</div>
                        <div class="stat-value">12</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 3 new today
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #3b82f6;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Completed Today</div>
                        <div class="stat-value">5</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> Great progress!
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #ef4444;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Overdue</div>
                        <div class="stat-value">2</div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-down"></i> Needs attention
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: #10b981;">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Weekly Completion</div>
                        <div class="stat-value">87%</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> Above target!
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Schedule View -->
            <div class="content-view" id="view-schedule">
                <!-- Dashboard Grid for Schedule -->
                <div class="dashboard-grid">
                    <!-- Schedule Section (Left) -->
                    <div class="calendar-section" id="scheduleSection">
                        <!-- Corner Toggle Buttons -->
                        <button class="calendar-corner-toggle left-toggle" onclick="toggleSidebarLeft()" title="Toggle Left Sidebar">
                            <i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>
                        </button>
                        <button class="calendar-corner-toggle right-toggle" onclick="toggleSidebarRight()" title="Toggle Right Sidebar">
                            <i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>
                        </button>
                        
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <h2 class="section-title">
                                <i class="fas fa-clock" style="color: var(--accent-primary); margin-right: 0.5rem;"></i>
                                My Schedule - Working Hours
                            </h2>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button onclick="mySchedulePrevWeek()" style="padding: 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-primary);">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="myScheduleWeekLabel" style="font-weight: 600; color: var(--text-primary); min-width: 180px; text-align: center;"></span>
                                <button onclick="myScheduleNextWeek()" style="padding: 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-primary);">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <button onclick="myScheduleToday()" style="padding: 0.5rem 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-left: 0.5rem;">
                                    Today
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filters Row -->
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                            <!-- Type Filter (Clinical/Non-Clinical) -->
                            <div style="flex: 1; min-width: 130px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">
                                    <i class="fas fa-briefcase" style="margin-right: 0.25rem;"></i>Type
                                </label>
                                <select id="myScheduleTypeFilter" onchange="filterMyScheduleEmployees(); renderMyScheduleCalendar()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                                    <option value="">All Types</option>
                                    <option value="clinical">Clinical</option>
                                    <option value="non-clinical">Non-Clinical</option>
                                </select>
                            </div>
                            
                            <!-- Role Filter -->
                            <div style="flex: 1; min-width: 150px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">
                                    <i class="fas fa-id-badge" style="margin-right: 0.25rem;"></i>Role
                                </label>
                                <select id="myScheduleRoleFilter" onchange="filterMyScheduleEmployees(); renderMyScheduleCalendar()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                                    <option value="">All Roles</option>
                                </select>
                            </div>
                            
                            <!-- Employee Filter -->
                            <div style="flex: 1; min-width: 180px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">
                                    <i class="fas fa-user-md" style="margin-right: 0.25rem;"></i>Employee
                                </label>
                                <select id="myScheduleEmployeeFilter" onchange="renderMyScheduleCalendar()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                            
                            <!-- Clinic Filter -->
                            <div style="flex: 1; min-width: 180px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">
                                    <i class="fas fa-hospital" style="margin-right: 0.25rem;"></i>Clinic
                                </label>
                                <select id="myScheduleClinicFilter" onchange="renderMyScheduleCalendar()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                                    <option value="">All Clinics</option>
                                </select>
                            </div>
                            
                            <!-- Room Filter -->
                            <div style="flex: 1; min-width: 180px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">
                                    <i class="fas fa-door-open" style="margin-right: 0.25rem;"></i>Room
                                </label>
                                <select id="myScheduleRoomFilter" onchange="renderMyScheduleCalendar()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.8rem; cursor: pointer;">
                                    <option value="">All Rooms</option>
                                </select>
                            </div>
                            
                            <!-- Clear Filters Button -->
                            <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                                <button onclick="clearMyScheduleFilters()" style="padding: 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-secondary); font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                                <button onclick="refreshMySchedule()" style="padding: 0.5rem 0.75rem; background: #3b82f6; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;" title="Refresh Schedule">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button onclick="checkMyScheduleConflicts()" style="padding: 0.5rem 0.75rem; background: #f59e0b; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;" title="Check for Conflicts">
                                    <i class="fas fa-exclamation-triangle"></i> Conflicts
                                </button>
                            </div>
                            
                            <!-- Print & Export Buttons -->
                            <div style="display: flex; align-items: flex-end; gap: 0.5rem; margin-left: auto;">
                                <button onclick="printMySchedule()" style="padding: 0.5rem 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-primary); font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;" title="Print Schedule">
                                    <i class="fas fa-print"></i> Print
                                </button>
                                <button onclick="exportMyScheduleToPDF()" style="padding: 0.5rem 0.75rem; background: #dc2626; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;" title="Export to PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- Weekly Calendar Grid -->
                        <div id="myScheduleCalendar" style="display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: var(--card-bg);">
                            <!-- Week Header -->
                            <div id="myScheduleHeader" style="display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                                <!-- Days will be populated by JavaScript -->
                            </div>
                            
                            <!-- Week Body with shift cards -->
                            <div id="myScheduleBody" style="display: grid; grid-template-columns: repeat(7, 1fr); min-height: 400px;">
                                <!-- Day columns with shifts will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <script>
                        // Helper function to convert 24-hour time to 12-hour AM/PM format
                        function convertTo12Hour(time24) {
                            if (!time24) return time24;
                            const [hours, minutes] = time24.split(':');
                            let hours24 = parseInt(hours);
                            const period = hours24 >= 12 ? 'PM' : 'AM';
                            hours24 = hours24 % 12 || 12;
                            return `${hours24}:${minutes} ${period}`;
                        }
                        
                        // My Schedule Weekly Calendar Data & Logic
                        (function() {
                            // Current week start date - expose globally for quick calendar sync
                            window.myScheduleCurrentWeekStart = getStartOfWeek(new Date());
                            
                            // Shifts data with days they work - GLOBAL so Schedule Manager can add to it
                            // Empty array for testing - schedules will be added via Schedule Manager
                            window.myScheduleShifts = [];
                            
                            // Expose shifts data globally for filters (same reference)
                            window.myScheduleShiftsData = window.myScheduleShifts;
                            
                            function getStartOfWeek(date) {
                                const d = new Date(date);
                                const day = d.getDay();
                                const diff = d.getDate() - day;
                                return new Date(d.setDate(diff));
                            }
                            
                            function formatDate(date) {
                                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }
                            
                            function getDayName(date) {
                                return date.toLocaleDateString('en-US', { weekday: 'short' });
                            }
                            
                            function getDayNameFull(date) {
                                return date.toLocaleDateString('en-US', { weekday: 'long' });
                            }
                            
                            function isToday(date) {
                                const today = new Date();
                                return date.toDateString() === today.toDateString();
                            }
                            
                            // Populate filter dropdowns
                            function populateFilters() {
                                const typeFilter = document.getElementById('myScheduleTypeFilter');
                                const roleFilter = document.getElementById('myScheduleRoleFilter');
                                const employeeFilter = document.getElementById('myScheduleEmployeeFilter');
                                const clinicFilter = document.getElementById('myScheduleClinicFilter');
                                const roomFilter = document.getElementById('myScheduleRoomFilter');
                                
                                if (!employeeFilter || !clinicFilter || !roomFilter) return;
                                
                                // Save current selections
                                const currentType = typeFilter?.value || '';
                                const currentRole = roleFilter?.value || '';
                                const currentEmployee = employeeFilter.value;
                                const currentClinic = clinicFilter.value;
                                const currentRoom = roomFilter.value;
                                
                                // Clear existing options (keep first "All" option)
                                if (roleFilter) roleFilter.innerHTML = '<option value="">All Roles</option>';
                                employeeFilter.innerHTML = '<option value="">All Employees</option>';
                                clinicFilter.innerHTML = '<option value="">All Clinics</option>';
                                roomFilter.innerHTML = '<option value="">All Rooms</option>';
                                
                                // Get ALL employees from employeeResources (master data) if available
                                let allEmployees = [];
                                if (typeof employeeResources !== 'undefined' && employeeResources.length > 0) {
                                    // Use master employee list
                                    allEmployees = employeeResources.map(e => ({
                                        name: e.title,
                                        role: e.extendedProps?.role || '',
                                        type: e.extendedProps?.type || ''
                                    })).sort((a, b) => a.name.localeCompare(b.name));
                                } else {
                                    // Fallback to shifts data
                                    const shifts = window.myScheduleShifts || [];
                                    const providers = shifts.map(s => s.name).filter(Boolean);
                                    const assistants = shifts.map(s => s.assistant).filter(Boolean);
                                    const uniqueNames = [...new Set([...providers, ...assistants])].sort();
                                    allEmployees = uniqueNames.map(name => ({
                                        name: name,
                                        role: providers.includes(name) ? 'Provider' : 'Assistant',
                                        type: providers.includes(name) ? 'provider' : 'assistant'
                                    }));
                                }
                                
                                // Get clinics and rooms from masterData if available
                                let clinics = [];
                                let rooms = [];
                                if (window.masterData) {
                                    clinics = window.masterData.clinics.map(c => c.name).sort();
                                    rooms = window.masterData.rooms.map(r => r.name).sort();
                                } else {
                                    const shifts = window.myScheduleShifts || [];
                                    clinics = [...new Set(shifts.map(s => s.clinic))].sort();
                                    rooms = [...new Set(shifts.map(s => s.room))].sort();
                                }
                                
                                // Get unique roles and populate role filter
                                const uniqueRoles = [...new Set(allEmployees.map(e => e.role).filter(Boolean))].sort();
                                if (roleFilter) {
                                    uniqueRoles.forEach(role => {
                                        const option = document.createElement('option');
                                        option.value = role;
                                        option.textContent = role;
                                        if (currentRole === role) option.selected = true;
                                        roleFilter.appendChild(option);
                                    });
                                }
                                
                                // Filter employees by staffType and role
                                let filteredEmployees = allEmployees;
                                if (currentType) {
                                    // Use staffType field from employee data
                                    filteredEmployees = filteredEmployees.filter(e => {
                                        const staffType = e.staffType || e.extendedProps?.staffType || '';
                                        return staffType === currentType;
                                    });
                                }
                                if (currentRole) {
                                    filteredEmployees = filteredEmployees.filter(e => e.role === currentRole);
                                }
                                
                                // Populate employees (filtered)
                                filteredEmployees.forEach(emp => {
                                    const option = document.createElement('option');
                                    option.value = emp.name;
                                    // Add role indicator
                                    const roleLabel = emp.type === 'provider' ? 'Provider' : emp.role || 'Staff';
                                    option.textContent = `${emp.name} (${roleLabel})`;
                                    employeeFilter.appendChild(option);
                                });
                                
                                // Populate clinics
                                clinics.forEach(clinic => {
                                    const option = document.createElement('option');
                                    option.value = clinic;
                                    option.textContent = clinic;
                                    clinicFilter.appendChild(option);
                                });
                                
                                // Populate rooms
                                rooms.forEach(room => {
                                    const option = document.createElement('option');
                                    option.value = room;
                                    option.textContent = room;
                                    roomFilter.appendChild(option);
                                });
                                
                                // Restore previous selections if they still exist
                                const employeeNames = filteredEmployees.map(e => e.name);
                                if (currentEmployee && employeeNames.includes(currentEmployee)) {
                                    employeeFilter.value = currentEmployee;
                                }
                                if (currentClinic && clinics.includes(currentClinic)) {
                                    clinicFilter.value = currentClinic;
                                }
                                if (currentRoom && rooms.includes(currentRoom)) {
                                    roomFilter.value = currentRoom;
                                }
                            }
                            
                            // Get filtered shifts
                            function getFilteredShifts() {
                                const typeFilter = document.getElementById('myScheduleTypeFilter');
                                const roleFilter = document.getElementById('myScheduleRoleFilter');
                                const employeeFilter = document.getElementById('myScheduleEmployeeFilter');
                                const clinicFilter = document.getElementById('myScheduleClinicFilter');
                                const roomFilter = document.getElementById('myScheduleRoomFilter');
                                
                                const selectedType = typeFilter ? typeFilter.value : '';
                                const selectedRole = roleFilter ? roleFilter.value : '';
                                const selectedEmployee = employeeFilter ? employeeFilter.value : '';
                                const selectedClinic = clinicFilter ? clinicFilter.value : '';
                                const selectedRoom = roomFilter ? roomFilter.value : '';
                                
                                // Use global array
                                const shifts = window.myScheduleShifts || [];
                                return shifts.filter(shift => {
                                    // Type filter - check person's staffType
                                    if (selectedType) {
                                        const allEmployees = window.masterData?.getAllEmployees() || [];
                                        const personData = allEmployees.find(e => e.title === shift.name);
                                        const staffType = personData?.extendedProps?.staffType || '';
                                        
                                        if (staffType !== selectedType) return false;
                                    }
                                    
                                    // Role filter
                                    if (selectedRole) {
                                        const allEmployees = window.masterData?.getAllEmployees() || [];
                                        const personData = allEmployees.find(e => e.title === shift.name);
                                        const personRole = personData?.extendedProps?.role || shift.role || '';
                                        if (personRole !== selectedRole) return false;
                                    }
                                    
                                    // Check if selected employee matches provider OR assistant
                                    if (selectedEmployee && shift.name !== selectedEmployee && shift.assistant !== selectedEmployee) return false;
                                    if (selectedClinic && shift.clinic !== selectedClinic) return false;
                                    if (selectedRoom && shift.room !== selectedRoom) return false;
                                    return true;
                                });
                            }
                            
                            // Helper function to check if a date falls within a shift's date range
                            function isDateInShiftRange(shift, dateToCheck) {
                                // If shift has no date range, show it (legacy support)
                                if (!shift.startDate && !shift.endDate) return true;
                                
                                // Format check date as YYYY-MM-DD in local timezone
                                const year = dateToCheck.getFullYear();
                                const month = String(dateToCheck.getMonth() + 1).padStart(2, '0');
                                const day = String(dateToCheck.getDate()).padStart(2, '0');
                                const checkDateStr = `${year}-${month}-${day}`;
                                
                                if (shift.startDate) {
                                    // Compare as strings to avoid timezone issues
                                    if (checkDateStr < shift.startDate) return false;
                                }
                                
                                if (shift.endDate) {
                                    // Compare as strings to avoid timezone issues
                                    if (checkDateStr > shift.endDate) return false;
                                }
                                
                                return true;
                            }
                            
                            // Filter employee dropdown by type/role
                            window.filterMyScheduleEmployees = function() {
                                const allEmployees = window.masterData?.getAllEmployees() || [];
                                const typeFilter = document.getElementById('myScheduleTypeFilter')?.value || '';
                                const roleFilter = document.getElementById('myScheduleRoleFilter')?.value || '';
                                const employeeSelect = document.getElementById('myScheduleEmployeeFilter');
                                
                                let filteredEmployees = allEmployees;
                                
                                // Filter by staffType
                                if (typeFilter) {
                                    filteredEmployees = filteredEmployees.filter(e => {
                                        const staffType = e.extendedProps?.staffType || '';
                                        return staffType === typeFilter;
                                    });
                                }
                                
                                // Filter by role
                                if (roleFilter) {
                                    filteredEmployees = filteredEmployees.filter(e => e.extendedProps?.role === roleFilter);
                                }
                                
                                // Update employee dropdown
                                if (employeeSelect) {
                                    const currentValue = employeeSelect.value;
                                    employeeSelect.innerHTML = '<option value="">All Employees</option>' +
                                        filteredEmployees.map(e => `<option value="${e.title}" ${currentValue === e.title ? 'selected' : ''}>${e.title}</option>`).join('');
                                }
                            };
                            
                            // Clear all filters
                            window.clearMyScheduleFilters = function() {
                                const typeFilter = document.getElementById('myScheduleTypeFilter');
                                const roleFilter = document.getElementById('myScheduleRoleFilter');
                                const employeeFilter = document.getElementById('myScheduleEmployeeFilter');
                                const clinicFilter = document.getElementById('myScheduleClinicFilter');
                                const roomFilter = document.getElementById('myScheduleRoomFilter');
                                
                                if (typeFilter) typeFilter.value = '';
                                if (roleFilter) roleFilter.value = '';
                                if (employeeFilter) employeeFilter.value = '';
                                if (clinicFilter) clinicFilter.value = '';
                                if (roomFilter) roomFilter.value = '';
                                
                                // Repopulate employee dropdown to show all
                                filterMyScheduleEmployees();
                                renderMyScheduleCalendar();
                            };
                            
                            // Refresh schedule calendar
                            window.refreshMySchedule = function() {
                                renderMyScheduleCalendar();
                                if (typeof showNotification === 'function') {
                                    showNotification('Schedule refreshed', 'success');
                                }
                            };
                            
                            // Check for schedule conflicts
                            window.checkMyScheduleConflicts = function() {
                                const conflicts = [];
                                const allSchedules = [];
                                
                                // Build schedule list from myScheduleShifts
                                if (window.myScheduleShifts) {
                                    window.myScheduleShifts.forEach(shift => {
                                        (shift.days || []).forEach(day => {
                                            allSchedules.push({
                                                id: shift.id,
                                                provider: shift.name,
                                                clinic: shift.clinic,
                                                room: shift.room,
                                                assistant: shift.assistant,
                                                day: day,
                                                startTime: shift.startTime,
                                                endTime: shift.endTime,
                                                startDate: shift.startDate,
                                                endDate: shift.endDate
                                            });
                                        });
                                    });
                                }
                                
                                // Helper to check if times overlap
                                function timesOverlap(start1, end1, start2, end2) {
                                    return start1 < end2 && start2 < end1;
                                }
                                
                                // Helper to check if date ranges overlap
                                function datesOverlap(startDate1, endDate1, startDate2, endDate2) {
                                    if (!startDate1 || !endDate1 || !startDate2 || !endDate2) return true;
                                    return startDate1 <= endDate2 && startDate2 <= endDate1;
                                }
                                
                                // Check for conflicts
                                for (let i = 0; i < allSchedules.length; i++) {
                                    for (let j = i + 1; j < allSchedules.length; j++) {
                                        const s1 = allSchedules[i];
                                        const s2 = allSchedules[j];
                                        
                                        if (s1.day !== s2.day) continue;
                                        if (!datesOverlap(s1.startDate, s1.endDate, s2.startDate, s2.endDate)) continue;
                                        if (!timesOverlap(s1.startTime, s1.endTime, s2.startTime, s2.endTime)) continue;
                                        
                                        // Provider conflict
                                        if (s1.provider === s2.provider && s1.room !== s2.room) {
                                            const conflictKey = `provider-${s1.provider}-${s1.day}-${s1.startTime}`;
                                            if (!conflicts.find(c => c.key === conflictKey)) {
                                                conflicts.push({
                                                    key: conflictKey,
                                                    type: 'Provider',
                                                    message: `${s1.provider} is in ${s1.room} and ${s2.room} at same time on ${s1.day}`
                                                });
                                            }
                                        }
                                        
                                        // Room conflict
                                        if (s1.room === s2.room && s1.provider !== s2.provider) {
                                            const conflictKey = `room-${s1.room}-${s1.day}-${s1.startTime}`;
                                            if (!conflicts.find(c => c.key === conflictKey)) {
                                                conflicts.push({
                                                    key: conflictKey,
                                                    type: 'Room',
                                                    message: `${s1.room} has ${s1.provider} and ${s2.provider} at same time on ${s1.day}`
                                                });
                                            }
                                        }
                                        
                                        // Assistant conflict
                                        if (s1.assistant && s2.assistant && s1.provider !== s2.provider) {
                                            const assistants1 = s1.assistant.split(', ').filter(a => a);
                                            const assistants2 = s2.assistant.split(', ').filter(a => a);
                                            const common = assistants1.filter(a => assistants2.includes(a));
                                            
                                            common.forEach(assistant => {
                                                const conflictKey = `assistant-${assistant}-${s1.day}-${s1.startTime}`;
                                                if (!conflicts.find(c => c.key === conflictKey)) {
                                                    conflicts.push({
                                                        key: conflictKey,
                                                        type: 'Assistant',
                                                        message: `${assistant} assigned to ${s1.provider} and ${s2.provider} at same time on ${s1.day}`
                                                    });
                                                }
                                            });
                                        }
                                    }
                                }
                                
                                // Show results
                                if (conflicts.length > 0) {
                                    let msg = `âš ï¸ Found ${conflicts.length} Conflict(s):\n\n`;
                                    conflicts.forEach((c, i) => {
                                        msg += `${i + 1}. [${c.type}] ${c.message}\n`;
                                    });
                                    alert(msg);
                                    
                                    if (typeof showNotification === 'function') {
                                        showNotification(`âš ï¸ ${conflicts.length} scheduling conflict(s) found!`, 'warning');
                                    }
                                } else {
                                    if (typeof showNotification === 'function') {
                                        showNotification('âœ… No conflicts found! All schedules are valid.', 'success');
                                    } else {
                                        alert('âœ… No conflicts found! All schedules are valid.');
                                    }
                                }
                                
                                return conflicts;
                            };
                            
                            window.renderMyScheduleCalendar = function() {
                                const header = document.getElementById('myScheduleHeader');
                                const body = document.getElementById('myScheduleBody');
                                const weekLabel = document.getElementById('myScheduleWeekLabel');
                                
                                if (!header || !body || !weekLabel) return;
                                
                                // Refresh filters to include any new schedules
                                populateFilters();
                                
                                // Update week label
                                const weekEnd = new Date(window.myScheduleCurrentWeekStart);
                                weekEnd.setDate(weekEnd.getDate() + 6);
                                weekLabel.textContent = `${formatDate(window.myScheduleCurrentWeekStart)} - ${formatDate(weekEnd)}, ${weekEnd.getFullYear()}`;
                                
                                // Get filtered shifts
                                const filteredShifts = getFilteredShifts();
                                
                                // Render header
                                header.innerHTML = '';
                                for (let i = 0; i < 7; i++) {
                                    const date = new Date(window.myScheduleCurrentWeekStart);
                                    date.setDate(date.getDate() + i);
                                    const dayName = getDayName(date);
                                    const isTodayClass = isToday(date) ? 'background: var(--accent-primary); color: white;' : '';
                                    
                                    header.innerHTML += `
                                        <div style="padding: 0.75rem 0.5rem; text-align: center; border-right: 1px solid var(--border-color); ${isTodayClass}">
                                            <div style="font-weight: 700; font-size: 0.85rem;">${dayName}</div>
                                            <div style="font-size: 0.75rem; opacity: 0.8;">${formatDate(date)}</div>
                                        </div>
                                    `;
                                }
                                
                                // Render body
                                body.innerHTML = '';
                                for (let i = 0; i < 7; i++) {
                                    const date = new Date(window.myScheduleCurrentWeekStart);
                                    date.setDate(date.getDate() + i);
                                    const dayName = getDayName(date);
                                    const isTodayBg = isToday(date) ? 'background: rgba(var(--accent-primary-rgb, 59, 130, 246), 0.05);' : '';
                                    
                                    // Get shifts for this day (using filtered shifts AND checking date range)
                                    const dayShifts = filteredShifts.filter(shift => {
                                        // Check if shift is scheduled for this day of the week
                                        if (!shift.days.includes(dayName)) return false;
                                        // Check if this specific date falls within the shift's date range
                                        return isDateInShiftRange(shift, date);
                                    });
                                    
                                    // Merge shifts with same provider, clinic, time into one card (combine rooms and assistants)
                                    const mergedShifts = [];
                                    dayShifts.forEach(shift => {
                                        const existingShift = mergedShifts.find(s => {
                                            const nameMatch = (s.name || '').trim() === (shift.name || '').trim();
                                            const clinicMatch = (s.clinic || '').trim() === (shift.clinic || '').trim();
                                            const startMatch = (s.startTime || '').trim() === (shift.startTime || '').trim();
                                            const endMatch = (s.endTime || '').trim() === (shift.endTime || '').trim();
                                            return nameMatch && clinicMatch && startMatch && endMatch;
                                        });
                                        if (existingShift) {
                                            // Merge rooms using array to avoid duplicates
                                            if (shift.room) {
                                                if (!existingShift.roomsArray) {
                                                    existingShift.roomsArray = existingShift.room ? [existingShift.room] : [];
                                                }
                                                if (!existingShift.roomsArray.includes(shift.room)) {
                                                    existingShift.roomsArray.push(shift.room);
                                                    existingShift.room = existingShift.roomsArray.join(', ');
                                                }
                                            }
                                            // Merge assistants using array to avoid duplicates
                                            if (shift.assistant) {
                                                if (!existingShift.assistantsArray) {
                                                    existingShift.assistantsArray = existingShift.assistant ? existingShift.assistant.split(', ').map(a => a.trim()) : [];
                                                }
                                                const newAssistants = shift.assistant.split(', ').map(a => a.trim());
                                                newAssistants.forEach(a => {
                                                    if (a && !existingShift.assistantsArray.includes(a)) {
                                                        existingShift.assistantsArray.push(a);
                                                    }
                                                });
                                                existingShift.assistant = existingShift.assistantsArray.join(', ');
                                            }
                                        } else {
                                            const newShift = {...shift};
                                            if (newShift.room) newShift.roomsArray = [newShift.room];
                                            if (newShift.assistant) newShift.assistantsArray = newShift.assistant.split(', ').map(a => a.trim());
                                            mergedShifts.push(newShift);
                                        }
                                    });
                                    
                                    let shiftsHtml = '';
                                    mergedShifts.forEach(shift => {
                                        const assistantText = shift.assistant ? shift.assistant : 'No Assistant';
                                        const startTimeDisplay = typeof convertTo12Hour === 'function' ? convertTo12Hour(shift.startTime) : shift.startTime;
                                        const endTimeDisplay = typeof convertTo12Hour === 'function' ? convertTo12Hour(shift.endTime) : shift.endTime;
                                        shiftsHtml += `
                                            <div style="padding: 0.6rem; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid ${shift.color}; cursor: pointer; margin-bottom: 0.5rem; transition: transform 0.15s, box-shadow 0.15s;" 
                                                 onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';"
                                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"
                                                 onclick="showShiftDetail('${shift.id}')">
                                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.8rem; margin-bottom: 0.25rem;">
                                                    <i class="fas fa-user-md" style="color: ${shift.color}; margin-right: 0.3rem; font-size: 0.7rem;"></i>${shift.name}
                                                </div>
                                                <div style="font-size: 0.65rem; color: ${shift.color}; font-weight: 500; margin-bottom: 0.3rem; padding: 0.15rem 0.4rem; background: ${shift.color}15; border-radius: 3px; display: inline-block;">
                                                    ${shift.role}
                                                </div>
                                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.2rem;">
                                                    <i class="fas fa-clock" style="margin-right: 0.2rem; width: 12px;"></i>${startTimeDisplay} - ${endTimeDisplay}
                                                </div>
                                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.2rem;">
                                                    <i class="fas fa-hospital" style="margin-right: 0.2rem; width: 12px;"></i>${shift.clinic} - ${shift.room}
                                                </div>
                                                <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                                    <i class="fas fa-user-friends" style="margin-right: 0.2rem; width: 12px;"></i>${assistantText}
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    if (dayShifts.length === 0) {
                                        shiftsHtml = `
                                            <div style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.75rem; font-style: italic;">
                                                No shifts
                                            </div>
                                        `;
                                    }
                                    
                                    body.innerHTML += `
                                        <div style="padding: 0.5rem; border-right: 1px solid var(--border-color); min-height: 300px; ${isTodayBg}">
                                            ${shiftsHtml}
                                        </div>
                                    `;
                                }
                            };
                            
                            // Navigation functions
                            window.mySchedulePrevWeek = function() {
                                window.myScheduleCurrentWeekStart.setDate(window.myScheduleCurrentWeekStart.getDate() - 7);
                                renderMyScheduleCalendar();
                            };
                            
                            window.myScheduleNextWeek = function() {
                                window.myScheduleCurrentWeekStart.setDate(window.myScheduleCurrentWeekStart.getDate() + 7);
                                renderMyScheduleCalendar();
                            };
                            
                            window.myScheduleToday = function() {
                                window.myScheduleCurrentWeekStart = getStartOfWeek(new Date());
                                renderMyScheduleCalendar();
                            };
                            
                            // Navigate to specific date (for quick calendar sync)
                            window.myScheduleGoToDate = function(date) {
                                window.myScheduleCurrentWeekStart = getStartOfWeek(new Date(date));
                                renderMyScheduleCalendar();
                            };
                            
                            // Print Schedule Function
                            window.printMySchedule = function() {
                                const printContent = document.getElementById('myScheduleCalendar');
                                const weekLabel = document.getElementById('myScheduleWeekLabel');
                                
                                // Get current filter values for the title
                                const employeeFilter = document.getElementById('myScheduleEmployeeFilter');
                                const clinicFilter = document.getElementById('myScheduleClinicFilter');
                                const roomFilter = document.getElementById('myScheduleRoomFilter');
                                
                                let filterInfo = [];
                                if (employeeFilter && employeeFilter.value) filterInfo.push('Employee: ' + employeeFilter.value);
                                if (clinicFilter && clinicFilter.value) filterInfo.push('Clinic: ' + clinicFilter.value);
                                if (roomFilter && roomFilter.value) filterInfo.push('Room: ' + roomFilter.value);
                                
                                const printWindow = window.open('', '_blank');
                                printWindow.document.write(`
                                    <!DOCTYPE html>
                                    <html>
                                    <head>
                                        <title>My Schedule - ${weekLabel ? weekLabel.textContent : ''}</title>
                                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                                        <style>
                                            * { margin: 0; padding: 0; box-sizing: border-box; }
                                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; }
                                            .print-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
                                            .print-header h1 { font-size: 1.5rem; color: #1f2937; margin-bottom: 5px; }
                                            .print-header .week-range { font-size: 1rem; color: #6b7280; margin-bottom: 5px; }
                                            .print-header .filters { font-size: 0.85rem; color: #9ca3af; }
                                            .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
                                            .day-header { padding: 10px; text-align: center; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; border-right: 1px solid #e5e7eb; font-weight: 700; }
                                            .day-header:last-child { border-right: none; }
                                            .day-column { padding: 8px; border-right: 1px solid #e5e7eb; min-height: 150px; }
                                            .day-column:last-child { border-right: none; }
                                            .shift-card { padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 8px; font-size: 0.75rem; }
                                            .shift-name { font-weight: 600; color: #1f2937; margin-bottom: 3px; }
                                            .shift-role { display: inline-block; padding: 2px 6px; background: #e5e7eb; border-radius: 3px; font-size: 0.65rem; margin-bottom: 4px; }
                                            .shift-info { color: #6b7280; margin-bottom: 2px; }
                                            .no-shifts { text-align: center; color: #9ca3af; font-style: italic; padding: 20px; }
                                            .print-footer { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #9ca3af; }
                                            @media print {
                                                body { padding: 0; }
                                                .calendar-grid { page-break-inside: avoid; }
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="print-header">
                                            <h1><i class="fas fa-calendar-alt"></i> My Schedule - Working Hours</h1>
                                            <div class="week-range">${weekLabel ? weekLabel.textContent : ''}</div>
                                            ${filterInfo.length > 0 ? '<div class="filters">Filters: ' + filterInfo.join(' | ') + '</div>' : ''}
                                        </div>
                                        <div class="calendar-grid">
                                            ${generatePrintableCalendar()}
                                        </div>
                                        <div class="print-footer">
                                            Printed on ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </body>
                                    </html>
                                `);
                                printWindow.document.close();
                                
                                // Wait for content to load then print
                                printWindow.onload = function() {
                                    printWindow.print();
                                };
                            };
                            
                            // Export to PDF Function (uses print dialog with PDF option)
                            window.exportMyScheduleToPDF = function() {
                                const weekLabel = document.getElementById('myScheduleWeekLabel');
                                
                                // Get current filter values for the title
                                const employeeFilter = document.getElementById('myScheduleEmployeeFilter');
                                const clinicFilter = document.getElementById('myScheduleClinicFilter');
                                const roomFilter = document.getElementById('myScheduleRoomFilter');
                                
                                let filterInfo = [];
                                if (employeeFilter && employeeFilter.value) filterInfo.push('Employee: ' + employeeFilter.value);
                                if (clinicFilter && clinicFilter.value) filterInfo.push('Clinic: ' + clinicFilter.value);
                                if (roomFilter && roomFilter.value) filterInfo.push('Room: ' + roomFilter.value);
                                
                                const pdfWindow = window.open('', '_blank');
                                pdfWindow.document.write(`
                                    <!DOCTYPE html>
                                    <html>
                                    <head>
                                        <title>My Schedule - ${weekLabel ? weekLabel.textContent : ''}</title>
                                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                                        <style>
                                            * { margin: 0; padding: 0; box-sizing: border-box; }
                                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: white; }
                                            .print-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb; }
                                            .print-header h1 { font-size: 1.5rem; color: #1f2937; margin-bottom: 5px; }
                                            .print-header .week-range { font-size: 1rem; color: #6b7280; margin-bottom: 5px; }
                                            .print-header .filters { font-size: 0.85rem; color: #9ca3af; }
                                            .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
                                            .day-header { padding: 10px; text-align: center; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; border-right: 1px solid #e5e7eb; font-weight: 700; }
                                            .day-header:last-child { border-right: none; }
                                            .day-column { padding: 8px; border-right: 1px solid #e5e7eb; min-height: 150px; background: white; }
                                            .day-column:last-child { border-right: none; }
                                            .shift-card { padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 8px; font-size: 0.75rem; }
                                            .shift-name { font-weight: 600; color: #1f2937; margin-bottom: 3px; }
                                            .shift-role { display: inline-block; padding: 2px 6px; background: #e5e7eb; border-radius: 3px; font-size: 0.65rem; margin-bottom: 4px; }
                                            .shift-info { color: #6b7280; margin-bottom: 2px; }
                                            .no-shifts { text-align: center; color: #9ca3af; font-style: italic; padding: 20px; }
                                            .print-footer { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #9ca3af; }
                                            .pdf-instructions { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; }
                                            .pdf-instructions h3 { color: #92400e; margin-bottom: 8px; }
                                            .pdf-instructions p { color: #a16207; font-size: 0.9rem; }
                                            @media print {
                                                .pdf-instructions { display: none; }
                                                body { padding: 0; }
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="pdf-instructions">
                                            <h3><i class="fas fa-info-circle"></i> Export to PDF</h3>
                                            <p>Press <strong>Ctrl+P</strong> (or Cmd+P on Mac), then select <strong>"Save as PDF"</strong> as the destination.</p>
                                        </div>
                                        <div class="print-header">
                                            <h1><i class="fas fa-calendar-alt"></i> My Schedule - Working Hours</h1>
                                            <div class="week-range">${weekLabel ? weekLabel.textContent : ''}</div>
                                            ${filterInfo.length > 0 ? '<div class="filters">Filters: ' + filterInfo.join(' | ') + '</div>' : ''}
                                        </div>
                                        <div class="calendar-grid">
                                            ${generatePrintableCalendar()}
                                        </div>
                                        <div class="print-footer">
                                            Generated on ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </body>
                                    </html>
                                `);
                                pdfWindow.document.close();
                            };
                            
                            // Generate printable calendar HTML
                            window.generatePrintableCalendar = function() {
                                const filteredShifts = getFilteredShifts();
                                let html = '';
                                
                                // Generate headers
                                for (let i = 0; i < 7; i++) {
                                    const date = new Date(window.myScheduleCurrentWeekStart);
                                    date.setDate(date.getDate() + i);
                                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    html += '<div class="day-header"><div>' + dayName + '</div><div style="font-size: 0.8rem; font-weight: normal;">' + dateStr + '</div></div>';
                                }
                                
                                // Generate day columns with shifts
                                for (let i = 0; i < 7; i++) {
                                    const date = new Date(window.myScheduleCurrentWeekStart);
                                    date.setDate(date.getDate() + i);
                                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                                    
                                    // Filter by day name AND check if date falls within shift's date range
                                    const dayShifts = filteredShifts.filter(shift => {
                                        if (!shift.days.includes(dayName)) return false;
                                        return isDateInShiftRange(shift, date);
                                    });
                                    
                                    // Merge shifts with same provider, clinic, time into one card (combine rooms and assistants)
                                    const mergedShifts = [];
                                    dayShifts.forEach(shift => {
                                        const existingShift = mergedShifts.find(s => 
                                            (s.name || '').trim() === (shift.name || '').trim() && 
                                            (s.clinic || '').trim() === (shift.clinic || '').trim() && 
                                            (s.startTime || '').trim() === (shift.startTime || '').trim() && 
                                            (s.endTime || '').trim() === (shift.endTime || '').trim()
                                        );
                                        if (existingShift) {
                                            // Merge rooms using array
                                            if (shift.room) {
                                                if (!existingShift.roomsArray) {
                                                    existingShift.roomsArray = existingShift.room ? [existingShift.room] : [];
                                                }
                                                if (!existingShift.roomsArray.includes(shift.room)) {
                                                    existingShift.roomsArray.push(shift.room);
                                                    existingShift.room = existingShift.roomsArray.join(', ');
                                                }
                                            }
                                            // Merge assistants using array
                                            if (shift.assistant) {
                                                if (!existingShift.assistantsArray) {
                                                    existingShift.assistantsArray = existingShift.assistant ? existingShift.assistant.split(', ').map(a => a.trim()) : [];
                                                }
                                                const newAssistants = shift.assistant.split(', ').map(a => a.trim());
                                                newAssistants.forEach(a => {
                                                    if (a && !existingShift.assistantsArray.includes(a)) {
                                                        existingShift.assistantsArray.push(a);
                                                    }
                                                });
                                                existingShift.assistant = existingShift.assistantsArray.join(', ');
                                            }
                                        } else {
                                            const newShift = {...shift};
                                            if (newShift.room) newShift.roomsArray = [newShift.room];
                                            if (newShift.assistant) newShift.assistantsArray = newShift.assistant.split(', ').map(a => a.trim());
                                            mergedShifts.push(newShift);
                                        }
                                    });
                                    
                                    html += '<div class="day-column">';
                                    if (mergedShifts.length > 0) {
                                        mergedShifts.forEach(shift => {
                                            const assistantText = shift.assistant ? shift.assistant : 'No Assistant';
                                            const startTimeAMPM = typeof convertTo12Hour === 'function' ? convertTo12Hour(shift.startTime) : shift.startTime;
                                            const endTimeAMPM = typeof convertTo12Hour === 'function' ? convertTo12Hour(shift.endTime) : shift.endTime;
                                            html += '<div class="shift-card" style="border-left-color: ' + shift.color + ';">';
                                            html += '<div class="shift-name">' + shift.name + '</div>';
                                            html += '<div class="shift-role">' + shift.role + '</div>';
                                            html += '<div class="shift-info"><i class="fas fa-clock"></i> ' + startTimeAMPM + ' - ' + endTimeAMPM + '</div>';
                                            html += '<div class="shift-info"><i class="fas fa-hospital"></i> ' + shift.clinic + ' - ' + shift.room + '</div>';
                                            html += '<div class="shift-info"><i class="fas fa-user-friends"></i> ' + assistantText + '</div>';
                                            html += '</div>';
                                        });
                                    } else {
                                        html += '<div class="no-shifts">No shifts</div>';
                                    }
                                    html += '</div>';
                                }
                                
                                return html;
                            };
                            
                            // Initial render
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', function() {
                                    populateFilters();
                                    renderMyScheduleCalendar();
                                });
                            } else {
                                populateFilters();
                                renderMyScheduleCalendar();
                            }
                        })();
                        </script>
                    </div>

                    <!-- Right Sidebar - Dental Office -->
                    <div class="sidebar-right">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Dental Office</span>
                        </div>
                        <!-- Dental Office Section -->
                        <div class="nav-section" data-section="dental-office">
                            <div class="nav-title">
                                <span>DENTAL OFFICE</span>
                                <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="nav-items">
                                <a href="#" class="nav-item" onclick="showOfficePlan(); return false;">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <span>Office Plan</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openVendorsManagement(); return false;">
                                    <i class="fas fa-truck"></i>
                                    <span>Vendors</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openEquipmentManagement(); return false;">
                                    <i class="fas fa-tools"></i>
                                    <span>Equipment</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openInstrumentsManagement(); return false;">
                                    <i class="fas fa-syringe"></i>
                                    <span>Instruments</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openSuppliesManagement(); return false;">
                                    <i class="fas fa-boxes"></i>
                                    <span>Supplies</span>
                                </a>
                                <a href="#" class="nav-item" onclick="switchContentView('procedures', event)">
                                    <i class="fas fa-clipboard-list"></i>
                                    <span>Procedures</span>
                                    <span class="nav-badge">5</span>
                                </a>
                            </div>
                        </div>

                        <!-- Clinical Resources Section -->
                        <div class="nav-section collapsed" data-section="clinical">
                            <div class="nav-title">
                                <span>RESOURCES</span>
                                <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="nav-items">
                                <a href="#" class="nav-item">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>Training</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-book-medical"></i>
                                    <span>Guidelines</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-video"></i>
                                    <span>Video Library</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Support</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-address-book"></i>
                                    <span>Rolodex</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openChat(); return false;" style="position: relative;">
                                    <i class="fas fa-comments"></i>
                                    <span>Chat</span>
                                    <span class="chat-unread-badge" style="display: none; position: absolute; top: 4px; right: 8px; background: #ef4444; color: white; font-size: 0.65rem; min-width: 18px; height: 18px; border-radius: 9px; align-items: center; justify-content: center; font-weight: 600;">0</span>
                                </a>
                            </div>
                        </div>
                        <!-- Quick Calendar Toggle Button -->
                        <div style="padding: 0.75rem; border-top: 1px solid var(--border-color); margin-top: auto; position: relative;">
                            <button onclick="toggleQuickCalendar()" style="width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-primary); font-size: 1.1rem;"></i>
                                    <div>
                                        <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); text-align: left;">QUICK CALENDAR</div>
                                        <div style="font-size: 0.75rem; font-weight: 500; color: var(--text-primary); text-align: left;" id="quickCalendarButtonDate">November 2025</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-up" id="quickCalendarChevron" style="transition: transform 0.2s; color: var(--text-secondary);"></i>
                            </button>
                            
                            <!-- Dropdown Calendar -->
                            <div class="quick-calendar-dropdown" id="quickCalendarDropdown">
                                <!-- Month Navigation -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; gap: 0.5rem;">
                                    <button onclick="quickCalendarPrevMonth()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; justify-content: center;">
                                        <div style="font-weight: 600; color: var(--accent-primary); text-align: center; font-size: 0.85rem;" id="quickCalendarMonth">November 2025</div>
                                        <button onclick="quickCalendarToday()" title="Jump to Today" style="background: var(--accent-primary); color: white; border: none; padding: 0.35rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                            Today
                                        </button>
                                    </div>
                                    <button onclick="quickCalendarNextMonth()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                
                                <!-- Calendar Grid -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;" id="quickCalendarGrid">
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Su</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Mo</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Tu</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">We</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Th</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Fr</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Sa</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="content-view active" id="view-calendar">
            <div class="dashboard-grid">
                <!-- Calendar Section -->
                <div class="calendar-section" id="calendarSection">
                    <!-- Corner Toggle Buttons -->
                    <button class="calendar-corner-toggle left-toggle" id="cornerToggleLeft" onclick="toggleSidebarLeft()" title="Toggle Left Sidebar">
                        <i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>
                    </button>
                    <button class="calendar-corner-toggle right-toggle" id="cornerToggleRight" onclick="toggleSidebarRight()" title="Toggle Right Sidebar">
                        <i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>
                    </button>
                    
                    <!-- Top Center Toggle Button for Header -->
                    <button class="calendar-corner-toggle top-toggle" id="cornerToggleTop" onclick="toggleHeaderBar()" title="Hide Header Bar">
                        <i class="fas fa-chevron-up" style="font-size: 0.6rem;"></i>
                    </button>
                    
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-calendar-alt" style="color: var(--accent-primary); margin-right: 0.5rem;"></i>
                            <span id="viewTitle">Schedule Overview</span>
                        </h2>
                        <div class="header-actions">                
                
                <!-- Employee Data Type Selector Dropdown (Only visible in Employee/Provider views) -->
                <div id="employeeDataTypeContainer" style="position: relative; display: none;">
                    <button id="employeeDataTypeBtn" onclick="event.stopPropagation(); toggleEmployeeDataType();" style="padding: 0.7rem 1.2rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;">
                        <i class="fas fa-clock"></i> 
                        <span id="employeeDataTypeText">Select Data Type</span>
                        <i class="fas fa-chevron-down" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                    </button>
                    
                    <div id="employeeDataTypeDropdown" style="display: none; position: fixed; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 9999; min-width: 220px;">
                        <div id="option-working-hours" onclick="event.stopPropagation(); selectEmployeeDataType('working-hours');" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-clock" style="width: 20px; color: var(--accent-primary);"></i>
                                <span style="color: var(--text-primary); font-weight: 500;">Working Hours</span>
                            </div>
                            <i class="fas fa-check checkmark" style="color: #10b981; opacity: 0; transition: opacity 0.2s;"></i>
                        </div>
                        <div id="option-duties" onclick="event.stopPropagation(); selectEmployeeDataType('duties');" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-clipboard-list" style="width: 20px; color: var(--accent-primary);"></i>
                                <span style="color: var(--text-primary); font-weight: 500;">Duties</span>
                            </div>
                            <i class="fas fa-check checkmark" style="color: #10b981; opacity: 0; transition: opacity 0.2s;"></i>
                        </div>
                        <div id="option-assistants" class="provider-only-option" onclick="event.stopPropagation(); selectEmployeeDataType('assistants');" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-user-friends" style="width: 20px; color: var(--accent-primary);"></i>
                                <span style="color: var(--text-primary); font-weight: 500;">Assistants</span>
                            </div>
                            <i class="fas fa-check checkmark" style="color: #10b981; opacity: 0; transition: opacity 0.2s;"></i>
                        </div>
                        <div id="option-clear" onclick="event.stopPropagation(); selectEmployeeDataType('none');" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-clipboard" style="width: 20px; color: #f59e0b;"></i>
                                <span style="color: var(--text-primary); font-weight: 500;">Tasks</span>
                            </div>
                            <i class="fas fa-check checkmark" style="color: #10b981; opacity: 0; transition: opacity 0.2s;"></i>
                        </div>
                    </div>
                </div>
                            
                            <button class="btn btn-primary" onclick="openAddEventModal()">
                                <i class="fas fa-plus"></i>
                                Add Event
                            </button>
                            
                            <!-- Table View Toggle -->
                            <button class="btn" onclick="toggleTableView()" id="tableViewToggleBtn" style="margin-left: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                                <i class="fas fa-table"></i>
                                Show as Table
                            </button>
                            
                        </div>
                    </div>

                    <!-- View Mode Switcher - Admin Only -->
                    <div class="view-mode-switcher admin-only">
                        <div class="view-mode-label">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Calendar View Mode</span>
                        </div>
                        <div class="view-mode-toggle">
                            <button class="view-mode-btn active" data-view-mode="date" onclick="switchViewMode('date')">
                                <i class="fas fa-calendar-day"></i>
                                <span>By Date</span>
                            </button>
                            <button class="view-mode-btn" data-view-mode="employee" onclick="switchViewMode('employee')">
                                <i class="fas fa-users"></i>
                                <span>By Employee</span>
                            </button>
                            <button class="view-mode-btn" data-view-mode="room" onclick="switchViewMode('room')">
                                <i class="fas fa-door-open"></i>
                                <span>By Room</span>
                            </button>
                            <button class="view-mode-btn" data-view-mode="provider" onclick="switchViewMode('provider')">
                                <i class="fas fa-user-md"></i>
                                <span>By Provider</span>
                            </button>
                            <button class="view-mode-btn" data-view-mode="event" onclick="switchViewMode('event')">
                                <i class="fas fa-calendar-check"></i>
                                <span>By Event</span>
                            </button>
                        </div>
                    </div>

                    <!-- Zoom Controls -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color);">
                        <button onclick="zoomCalendar(-0.1)" title="Zoom Out" style="background: var(--card-bg); border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 4px; cursor: pointer; color: var(--text-primary); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--card-bg)'">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <span id="zoomLevel" style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); min-width: 45px; text-align: center;">100%</span>
                        <button onclick="zoomCalendar(0.1)" title="Zoom In" style="background: var(--card-bg); border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 4px; cursor: pointer; color: var(--text-primary); transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--card-bg)'">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button onclick="resetZoom()" title="Reset Zoom" style="background: var(--card-bg); border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 4px; cursor: pointer; color: var(--text-primary); transition: all 0.2s; display: flex; align-items: center; justify-content: center; margin-left: 0.25rem;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--card-bg)'">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>

                    <!-- Filter Controls (shown based on active view) -->
                    <div class="view-filter-container" id="viewFilterContainer" style="display: none;">
                        <div class="filter-group">
                            <span class="filter-label" id="filterLabel">Filter by Employee:</span>
                            <select class="filter-select" id="resourceFilterSelect" onchange="applyResourceFilter(this.value)"><option value="">-- All Items --</option><option value="john-smith">John Smith</option><option value="sarah-johnson">Sarah Johnson</option><option value="mike-davis">Mike Davis</option><option value="emily-brown">Emily Brown</option><option value="james-wilson">James Wilson</option></select>
                        </div>
                        <button class="clear-filter-btn" onclick="clearResourceFilter()">
                            <i class="fas fa-times"></i> Clear Filter
                        </button>
                        <div id="activeFilterBadge" style="display: none;"></div>
                    </div>

                    <!-- Event Category Filter (For Provider View) -->
                    <div class="view-controls" id="eventFilterControls" style="display:none;"></div>


                    <!-- Calendar Header (toolbar) -->
                    <div id="calendarHeaderContainer"></div>

                    <!-- Custom Calendar Container with Zoom Wrapper (only grid/events zoomed) -->
                    <div style="overflow: auto; width: 100%; height: auto;">
                        <div id="calendarGridWrapper">
                            <div id="calendar" class="custom-calendar" style="transform-origin: top left;"></div>
                        </div>
                    </div>
                    
                    <!-- Table View Container -->
                    <div id="tableView" style="display: none;">
                        <div style="background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden;">
                            <!-- Table Header Controls -->
                            <div style="padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-table" style="color: var(--accent-primary);"></i>
                                        Events Table View
                                    </h3>
                                    <span id="tableRowCount" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="tableSearch" placeholder="Search events..." style="padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); min-width: 250px;" onkeyup="filterTable()">
                                    <button onclick="exportTableToCSV()" style="padding: 0.5rem 1rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                        <i class="fas fa-download"></i>
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Table Content -->
                            <div style="overflow-x: auto; max-height: 70vh;">
                                <table id="eventsTable" style="width: 100%; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10;">
                                        <tr>
                                            <th onclick="sortTable(0)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none; white-space: nowrap;">
                                                Date <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th onclick="sortTable(1)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none; white-space: nowrap;">
                                                Time <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th onclick="sortTable(2)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;">
                                                Title <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th onclick="sortTable(3)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;">
                                                Type <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th onclick="sortTable(4)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;">
                                                Employee <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th onclick="sortTable(5)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;">
                                                Priority <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th onclick="sortTable(6)" style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color); cursor: pointer; user-select: none;">
                                                Location <i class="fas fa-sort" style="font-size: 0.8rem; margin-left: 0.25rem;"></i>
                                            </th>
                                            <th style="padding: 0.75rem 1rem; text-align: center; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border-color);">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="eventsTableBody">
                                        <!-- Table rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Dental Office -->
                <div class="sidebar-right">
                    <div style="display: flex; justify-content: center; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Dental Office</span>
                    </div>
                    <!-- Dental Office Section -->
                    <div class="nav-section" data-section="dental-office">
                        <div class="nav-title">
                            <span>DENTAL OFFICE</span>
                            <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="nav-items">
                            <a href="#" class="nav-item" onclick="showOfficePlan(); return false;">
                                <i class="fas fa-map-marked-alt"></i>
                                <span>Office Plan</span>
                            </a>
                            <a href="#" class="nav-item" onclick="openVendorsManagement(); return false;">
                                <i class="fas fa-truck"></i>
                                <span>Vendors</span>
                            </a>
                            <a href="#" class="nav-item" onclick="openEquipmentManagement(); return false;">
                                <i class="fas fa-tools"></i>
                                <span>Equipment</span>
                            </a>
                            <a href="#" class="nav-item" onclick="openInstrumentsManagement(); return false;">
                                <i class="fas fa-syringe"></i>
                                <span>Instruments</span>
                            </a>
                            <a href="#" class="nav-item" onclick="openSuppliesManagement(); return false;">
                                <i class="fas fa-boxes"></i>
                                <span>Supplies</span>
                            </a>
                            <a href="#" class="nav-item" onclick="switchContentView('procedures', event)">
                                <i class="fas fa-clipboard-list"></i>
                                <span>Procedures</span>
                                <span class="nav-badge" id="proceduresCountBadge">0</span>
                            </a>
                        </div>
                    </div>

                    <!-- Clinical Resources Section -->
                    <div class="nav-section collapsed" data-section="clinical">
                        <div class="nav-title">
                            <span>RESOURCES</span>
                            <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="nav-items">
                            <a href="#" class="nav-item">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Training</span>
                            </a>
                            <a href="#" class="nav-item">
                                <i class="fas fa-book-medical"></i>
                                <span>Guidelines</span>
                            </a>
                            <a href="#" class="nav-item">
                                <i class="fas fa-video"></i>
                                <span>Video Library</span>
                            </a>
                            <a href="#" class="nav-item">
                                <i class="fas fa-question-circle"></i>
                                <span>Support</span>
                            </a>
                            <a href="#" class="nav-item">
                                <i class="fas fa-address-book"></i>
                                <span>Rolodex</span>
                            </a>
                            <a href="#" class="nav-item chat-nav-item" onclick="openChat(); return false;" style="position: relative; background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(8, 145, 178, 0.1)); border: 1px solid rgba(6, 182, 212, 0.4); border-radius: 8px; margin-top: 0.5rem;">
                                <i class="fas fa-comments" style="color: #06b6d4;"></i>
                                <span style="color: #06b6d4; font-weight: 600;">ðŸ’¬ Team Chat</span>
                                <span class="chat-unread-badge" style="display: none; position: absolute; top: 4px; right: 8px; background: #ef4444; color: white; font-size: 0.65rem; min-width: 18px; height: 18px; border-radius: 9px; align-items: center; justify-content: center; font-weight: 600;">0</span>
                            </a>
                        </div>
                    </div>
                    <!-- Quick Calendar Toggle Button -->
                    <div style="padding: 0.75rem; border-top: 1px solid var(--border-color); margin-top: auto; position: relative;">
                        <button onclick="toggleQuickCalendar()" style="width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-calendar-alt" style="color: var(--accent-primary); font-size: 1.1rem;"></i>
                                <div>
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); text-align: left;">QUICK CALENDAR</div>
                                    <div style="font-size: 0.75rem; font-weight: 500; color: var(--text-primary); text-align: left;" id="quickCalendarButtonDate">November 2025</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-up" id="quickCalendarChevron" style="transition: transform 0.2s; color: var(--text-secondary);"></i>
                        </button>
                        
                        <!-- Dropdown Calendar -->
                        <div class="quick-calendar-dropdown" id="quickCalendarDropdown">
                            <!-- Month Navigation -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; gap: 0.5rem;">
                                <button onclick="quickCalendarPrevMonth()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; justify-content: center;">
                                    <div style="font-weight: 600; color: var(--accent-primary); text-align: center; font-size: 0.85rem;" id="quickCalendarMonth">November 2025</div>
                                    <button onclick="quickCalendarToday()" title="Jump to Today" style="background: var(--accent-primary); color: white; border: none; padding: 0.35rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                        Today
                                    </button>
                                </div>
                                <button onclick="quickCalendarNextMonth()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            
                            <!-- Calendar Grid -->
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;" id="quickCalendarGrid">
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Su</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Mo</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Tu</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">We</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Th</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Fr</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Sa</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Content Toggle - Duties View -->
            <div class="content-view" id="view-duties">
                <!-- Dashboard Grid for Duties -->
                <div class="dashboard-grid">
                    <!-- Duties Section (Left) -->
                    <div class="calendar-section" id="dutiesSection">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-clipboard-check" style="color: var(--accent-primary); margin-right: 0.5rem;"></i>
                                My Duties
                            </h2>
                        </div>
                        <div id="myDutiesContainer" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                <p>Loading duties...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar - Dental Office -->
                    <div class="sidebar-right">
                        <div style="display: flex; justify-content: center; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                            <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Dental Office</span>
                        </div>
                        <!-- Dental Office Section -->
                        <div class="nav-section" data-section="dental-office">
                            <div class="nav-title">
                                <span>DENTAL OFFICE</span>
                                <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="nav-items">
                                <a href="#" class="nav-item" onclick="showOfficePlan(); return false;">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <span>Office Plan</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openVendorsManagement(); return false;">
                                    <i class="fas fa-truck"></i>
                                    <span>Vendors</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openEquipmentManagement(); return false;">
                                    <i class="fas fa-tools"></i>
                                    <span>Equipment</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openInstrumentsManagement(); return false;">
                                    <i class="fas fa-syringe"></i>
                                    <span>Instruments</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openSuppliesManagement(); return false;">
                                    <i class="fas fa-boxes"></i>
                                    <span>Supplies</span>
                                </a>
                                <a href="#" class="nav-item" onclick="switchContentView('procedures', event)">
                                    <i class="fas fa-clipboard-list"></i>
                                    <span>Procedures</span>
                                    <span class="nav-badge">5</span>
                                </a>
                            </div>
                        </div>

                        <!-- Clinical Resources Section -->
                        <div class="nav-section collapsed" data-section="clinical">
                            <div class="nav-title">
                                <span>RESOURCES</span>
                                <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                            </div>
                            <div class="nav-items">
                                <a href="#" class="nav-item">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>Training</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-book-medical"></i>
                                    <span>Guidelines</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-video"></i>
                                    <span>Video Library</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Support</span>
                                </a>
                                <a href="#" class="nav-item">
                                    <i class="fas fa-address-book"></i>
                                    <span>Rolodex</span>
                                </a>
                                <a href="#" class="nav-item" onclick="openChat(); return false;" style="position: relative;">
                                    <i class="fas fa-comments"></i>
                                    <span>Chat</span>
                                    <span class="chat-unread-badge" style="display: none; position: absolute; top: 4px; right: 8px; background: #ef4444; color: white; font-size: 0.65rem; min-width: 18px; height: 18px; border-radius: 9px; align-items: center; justify-content: center; font-weight: 600;">0</span>
                                </a>
                            </div>
                        </div>
                        <!-- Quick Calendar Toggle Button -->
                        <div style="padding: 0.75rem; border-top: 1px solid var(--border-color); margin-top: auto; position: relative;">
                            <button onclick="toggleQuickCalendar()" style="width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-primary); font-size: 1.1rem;"></i>
                                    <div>
                                        <div style="font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); text-align: left;">QUICK CALENDAR</div>
                                        <div style="font-size: 0.75rem; font-weight: 500; color: var(--text-primary); text-align: left;" id="quickCalendarButtonDate">November 2025</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-up" id="quickCalendarChevron" style="transition: transform 0.2s; color: var(--text-secondary);"></i>
                            </button>
                            
                            <!-- Dropdown Calendar -->
                            <div class="quick-calendar-dropdown" id="quickCalendarDropdown">
                                <!-- Month Navigation -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; gap: 0.5rem;">
                                    <button onclick="quickCalendarPrevMonth()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; justify-content: center;">
                                        <div style="font-weight: 600; color: var(--accent-primary); text-align: center; font-size: 0.85rem;" id="quickCalendarMonth">November 2025</div>
                                        <button onclick="quickCalendarToday()" title="Jump to Today" style="background: var(--accent-primary); color: white; border: none; padding: 0.35rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                            Today
                                        </button>
                                    </div>
                                    <button onclick="quickCalendarNextMonth()" style="background: transparent; border: 1px solid var(--border-color); padding: 0.4rem 0.6rem; border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                
                                <!-- Calendar Grid -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;" id="quickCalendarGrid">
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Su</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Mo</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Tu</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">We</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Th</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Fr</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem;">Sa</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Tasks View -->
        <div class="content-view" id="view-tasks">
            <!-- Dashboard Grid for Tasks -->
            <div class="dashboard-grid">
                <!-- Tasks Section (Left) -->
                <div class="calendar-section" id="tasksSection" style="max-width: 100%;">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="section-title">
                            <i class="fas fa-tasks" style="color: var(--accent-primary); margin-right: 0.5rem;"></i>
                            Task Management
                        </h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <!-- Date Navigator for Tasks -->
                            <div style="display: flex; align-items: center; gap: 0.25rem; background: var(--bg-secondary); border-radius: 8px; padding: 0.25rem;">
                                <button onclick="taskCalendarPrevWeek()" style="background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-secondary); border-radius: 6px;" title="Previous Week">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button onclick="toggleTaskCalendar()" id="taskCalendarButton" style="padding: 0.5rem 0.75rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; min-width: 180px; justify-content: center;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-primary);"></i>
                                    <span id="taskCalendarButtonDate" style="font-weight: 600; font-size: 0.85rem;">This Week</span>
                                    <i class="fas fa-chevron-down" id="taskCalendarChevron" style="font-size: 0.7rem; transition: transform 0.3s;"></i>
                                </button>
                                <button onclick="taskCalendarNextWeek()" style="background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-secondary); border-radius: 6px;" title="Next Week">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <button onclick="taskCalendarToday()" style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; color: var(--accent-primary); border-radius: 6px; font-size: 0.8rem; font-weight: 600;" title="Jump to Today">
                                    Today
                                </button>
                            </div>
                            
                            <!-- Task Calendar Dropdown -->
                            <div class="quick-calendar-dropdown" id="taskCalendarDropdown" style="position: absolute; top: 100%; right: 0; margin-top: 0.5rem; z-index: 1000;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <button onclick="taskCalendarPrevMonth()" style="background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; color: var(--text-secondary);">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="taskCalendarMonth" style="font-weight: 600; color: var(--text-primary);"></span>
                                    <button onclick="taskCalendarNextMonth()" style="background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; color: var(--text-secondary);">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div id="taskCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">Su</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">Mo</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">Tu</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">We</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">Th</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">Fr</div>
                                    <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;">Sa</div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                                    <button onclick="setTaskDateRange('today')" style="flex: 1; padding: 0.4rem; background: var(--bg-tertiary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">Today</button>
                                    <button onclick="setTaskDateRange('week')" style="flex: 1; padding: 0.4rem; background: var(--bg-tertiary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">This Week</button>
                                    <button onclick="setTaskDateRange('month')" style="flex: 1; padding: 0.4rem; background: var(--bg-tertiary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">This Month</button>
                                    <button onclick="setTaskDateRange('all')" style="flex: 1; padding: 0.4rem; background: var(--bg-tertiary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">All</button>
                                </div>
                            </div>
                            
                            <button id="newTaskBtn" onclick="openCreateTaskModal()" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: none; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                <i class="fas fa-plus"></i> New Task
                            </button>
                        </div>
                    </div>
                    
                    <!-- Date Range Indicator -->
                    <div id="taskDateRangeIndicator" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--accent-light); border-radius: 8px; margin-bottom: 1rem;">
                        <i class="fas fa-calendar-week" style="color: var(--accent-primary);"></i>
                        <span id="taskDateRangeText" style="font-size: 0.85rem; color: var(--accent-dark); font-weight: 600;">Showing tasks for: This Week</span>
                        <span id="taskDateRangeCount" style="margin-left: auto; font-size: 0.8rem; color: var(--accent-secondary); background: var(--card-bg); padding: 0.2rem 0.5rem; border-radius: 4px;"></span>
                    </div>
                    
                    <!-- Task Filters -->
                    <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <select id="taskFilterStatus" onchange="renderTasksList()" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--card-bg);">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                        <select id="taskFilterPriority" onchange="renderTasksList()" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--card-bg);">
                            <option value="">All Priority</option>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <select id="taskFilterCategory" onchange="renderTasksList()" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--card-bg);">
                            <option value="">All Categories</option>
                            <option value="Clinical">Clinical</option>
                            <option value="Administrative">Administrative</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Facility">Facility</option>
                            <option value="Business Center">Business Center</option>
                        </select>
                        <select id="taskFilterAssignee" onchange="renderTasksList()" class="admin-only" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; background: var(--card-bg);">
                            <option value="">All Assignees</option>
                        </select>
                        <button onclick="clearTaskFilters()" style="padding: 0.5rem 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-secondary);">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                    
                    <!-- Task Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="padding: 0.75rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #92400e;" id="taskStatPending">0</div>
                            <div style="font-size: 0.75rem; color: #92400e;">Pending</div>
                        </div>
                        <div style="padding: 0.75rem; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="taskStatInProgress">0</div>
                            <div style="font-size: 0.75rem; color: #1e40af;">In Progress</div>
                        </div>
                        <div style="padding: 0.75rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="taskStatCompleted">0</div>
                            <div style="font-size: 0.75rem; color: #065f46;">Completed</div>
                        </div>
                        <div style="padding: 0.75rem; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #991b1b;" id="taskStatOverdue">0</div>
                            <div style="font-size: 0.75rem; color: #991b1b;">Overdue</div>
                        </div>
                    </div>
                    
                    <!-- Tasks List -->
                    <div id="tasksListContainer" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 60vh; overflow-y: auto;">
                        <!-- Tasks will be rendered here -->
                    </div>
                </div>

                <!-- Right Sidebar - Task Templates & Quick Actions (Admin Management Mode Only) -->
                <div class="sidebar-right hidden" id="taskManagementSidebar">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                        <span style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">Task Templates</span>
                        <button onclick="openManageTemplatesModal()" style="background: none; border: none; color: var(--accent-color); cursor: pointer; font-size: 0.8rem; padding: 0.25rem 0.5rem;" title="Manage Templates">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    
                    <!-- Quick Task Templates - Dynamic -->
                    <div class="nav-section" data-section="task-templates">
                        <div class="nav-title">
                            <span>QUICK TEMPLATES</span>
                            <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="nav-items" id="templatesSidebarList">
                            <!-- Templates rendered dynamically -->
                        </div>
                        <div style="padding: 0.5rem;">
                            <button onclick="openCreateTemplateModal()" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px dashed var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-plus"></i> Add Template
                            </button>
                        </div>
                    </div>

                    <!-- Task Categories -->
                    <div class="nav-section collapsed" data-section="task-categories">
                        <div class="nav-title">
                            <span>CATEGORIES</span>
                            <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="nav-items">
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Clinical'); return false;">
                                <i class="fas fa-stethoscope" style="color: var(--accent-primary);"></i>
                                <span>Clinical</span>
                                <span class="nav-badge" id="catBadgeClinical">0</span>
                            </a>
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Administrative'); return false;">
                                <i class="fas fa-file-alt" style="color: var(--accent-secondary);"></i>
                                <span>Administrative</span>
                                <span class="nav-badge" id="catBadgeAdministrative">0</span>
                            </a>
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Compliance'); return false;">
                                <i class="fas fa-shield-alt" style="color: var(--accent-primary);"></i>
                                <span>Compliance</span>
                                <span class="nav-badge" id="catBadgeCompliance">0</span>
                            </a>
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Equipment'); return false;">
                                <i class="fas fa-cog" style="color: #f59e0b;"></i>
                                <span>Equipment</span>
                                <span class="nav-badge" id="catBadgeEquipment">0</span>
                            </a>
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Marketing'); return false;">
                                <i class="fas fa-bullhorn" style="color: #ec4899;"></i>
                                <span>Marketing</span>
                                <span class="nav-badge" id="catBadgeMarketing">0</span>
                            </a>
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Facility'); return false;">
                                <i class="fas fa-building" style="color: var(--text-secondary);"></i>
                                <span>Facility</span>
                                <span class="nav-badge" id="catBadgeFacility">0</span>
                            </a>
                            <a href="#" class="nav-item" onclick="filterTasksByCategory('Business Center'); return false;">
                                <i class="fas fa-print" style="color: #6366f1;"></i>
                                <span>Business Center</span>
                                <span class="nav-badge" id="catBadgeBusinessCenter">0</span>
                            </a>
                        </div>
                    </div>

                    <!-- This Week's Due -->
                    <div class="nav-section" data-section="this-week">
                        <div class="nav-title">
                            <span>DUE THIS WEEK</span>
                            <span class="nav-toggle"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="nav-items" id="tasksThisWeekList" style="max-height: 200px; overflow-y: auto;">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Quick Calendar for Tasks -->
                    <div style="border-top: 1px solid var(--border-color); margin-top: auto;">
                        <div onclick="toggleTaskSidebarCalendar()" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; cursor: pointer; user-select: none;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-calendar-alt" style="color: var(--accent-primary);"></i>
                                <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.5px;">QUICK CALENDAR</span>
                            </div>
                            <i class="fas fa-chevron-down" id="taskSidebarCalendarChevron" style="font-size: 0.7rem; color: var(--text-secondary); transition: transform 0.3s;"></i>
                        </div>
                        <div id="taskSidebarCalendarContainer" style="display: none; padding: 0.75rem 1rem;">
                            <!-- Month Navigation -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <button onclick="event.stopPropagation(); taskSidebarCalendarPrevMonth()" style="background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; color: var(--text-secondary);">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="taskSidebarCalendarMonth" style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;"></span>
                                <button onclick="event.stopPropagation(); taskSidebarCalendarNextMonth()" style="background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; color: var(--text-secondary);">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            
                            <!-- Calendar Grid -->
                            <div id="taskSidebarCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 0.75rem;">
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">Su</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">Mo</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">Tu</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">We</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">Th</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">Fr</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;">Sa</div>
                            </div>
                            
                            <!-- Quick Presets -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button onclick="event.stopPropagation(); setTaskDateRange('today')" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-sun" style="color: var(--accent-primary);"></i> Today
                                </button>
                                <button onclick="event.stopPropagation(); setTaskDateRange('week')" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-calendar-week" style="color: var(--accent-primary);"></i> This Week
                                </button>
                                <button onclick="event.stopPropagation(); setTaskDateRange('month')" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-primary);"></i> This Month
                                </button>
                                <button onclick="event.stopPropagation(); setTaskDateRange('all')" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-list" style="color: var(--accent-primary);"></i> All Tasks
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Procedures View -->
        <div class="content-view" id="view-procedures">
            <!-- Procedures List -->
            <div class="procedures-list">
                <div class="procedures-list-header">
                    <h2 class="procedures-list-title">
                        <i class="fas fa-list-check"></i> Procedures
                    </h2>
                    <button class="btn-add-procedure" onclick="openProcedureModal('new')">
                        <i class="fas fa-plus"></i> New
                    </button>
                </div>
                <div id="proceduresList">
            <div class="procedure-item " onclick="selectProcedure('proc-1')">
                <div class="procedure-item-name">Root Canal Setup</div>
                <div class="procedure-item-meta">
                    <span><i class="fas fa-clock"></i>90m</span>
                    <span><i class="fas fa-cube"></i>7</span>
                    <span style="color: var(--accent-primary);"><i class="fas fa-star"></i>Template</span>
                </div>
            </div>
        
            <div class="procedure-item " onclick="selectProcedure('proc-2')">
                <div class="procedure-item-name">Cleaning &amp; Prophylaxis</div>
                <div class="procedure-item-meta">
                    <span><i class="fas fa-clock"></i>45m</span>
                    <span><i class="fas fa-cube"></i>6</span>
                    <span style="color: var(--accent-primary);"><i class="fas fa-star"></i>Template</span>
                </div>
            </div>
        </div>
            </div>

            <!-- Instrument Container -->
            <div class="instrument-container">
                <div class="container-header">
                    <h2 class="container-title">
                        <i class="fas fa-boxes"></i> Instrument Tray
                    </h2>
                    <div class="container-controls">
                        <button class="btn" onclick="saveProcedureTemplate()" title="Save as template">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>

                <!-- Tray Visualization -->
                <div class="tray-visual" id="trayVisual"><div style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem;"><i class="fas fa-info-circle"></i>&nbsp; Select instruments to populate the tray</div></div>

                <!-- Instrument Selection -->
                <div class="instrument-selector">
                    <div class="selector-title">Add Instruments</div>
                    
                    <div class="instrument-categories" id="categoryButtons"><button class="category-btn active" onclick="filterByCategory('diagnostic')">Diagnostic</button><button class="category-btn " onclick="filterByCategory('surgical')">Surgical</button><button class="category-btn " onclick="filterByCategory('cutting')">Cutting</button><button class="category-btn " onclick="filterByCategory('filling')">Filling</button><button class="category-btn " onclick="filterByCategory('suction')">Suction</button><button class="category-btn " onclick="filterByCategory('misc')">Misc</button></div>
                    
                    <div class="instruments-list" id="instrumentsList">
            <div class="instrument-option " onclick="toggleInstrument('mirror-1')">
                <span class="instrument-option-icon"><i class="fas fa-microscope"></i></span>
                <span class="instrument-option-name">Mouth Mirror</span>
            </div>
        
            <div class="instrument-option " onclick="toggleInstrument('explorer-1')">
                <span class="instrument-option-icon"><i class="fas fa-compass"></i></span>
                <span class="instrument-option-name">Explorer</span>
            </div>
        
            <div class="instrument-option " onclick="toggleInstrument('probe-1')">
                <span class="instrument-option-icon"><i class="fas fa-ruler"></i></span>
                <span class="instrument-option-name">Periodontal Probe</span>
            </div>
        
            <div class="instrument-option " onclick="toggleInstrument('tweezers-1')">
                <span class="instrument-option-icon"><i class="fas fa-hand-holding-tweezers"></i></span>
                <span class="instrument-option-name">Tweezers</span>
            </div>
        </div>
                </div>

                <!-- Procedure Actions -->
                <div class="procedure-actions">
                    <button class="action-btn action-btn-primary" onclick="saveProcedure()">
                        <i class="fas fa-check-circle"></i> Save Procedure
                    </button>
                    <button class="action-btn action-btn-secondary" onclick="clearProcedure()">
                        <i class="fas fa-redo"></i> Clear
                    </button>
                    <button class="action-btn action-btn-danger" onclick="deleteProcedure()" id="deleteProcedureBtn" style="display:none;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        </div>

        <!-- Projects Kanban View -->
        <div class="content-view" id="view-projects">
            <div class="kanban-header">
                <div class="kanban-header-top">
                    <div class="kanban-title">
                        <i class="fas fa-project-diagram"></i>
                        <span>Projects Board</span>
                    </div>
                    <div class="kanban-controls">
                        <button class="kanban-filter active" data-filter="all">All Projects</button>
                        <button class="kanban-filter" data-filter="my">My Projects</button>
                        <button class="btn-new-project" onclick="openNewProjectModal()">
                            <i class="fas fa-plus"></i>
                            New Project
                        </button>
                    </div>
                </div>
                <div class="kanban-stats">
                    <div class="kanban-stat">
                        <span>Total Projects:</span>
                        <span class="kanban-stat-value" id="totalProjects">16</span>
                    </div>
                    <div class="kanban-stat">
                        <span>Active:</span>
                        <span class="kanban-stat-value" id="activeProjects">8</span>
                    </div>
                    <div class="kanban-stat">
                        <span>Completed This Month:</span>
                        <span class="kanban-stat-value" id="completedProjects">3</span>
                    </div>
                    <div class="kanban-stat">
                        <span>Overdue:</span>
                        <span class="kanban-stat-value" style="color: #ef4444;" id="overdueProjects">2</span>
                    </div>
                </div>
            </div>

            <div class="kanban-container">
                <div class="kanban-board" id="kanbanBoard">
                    <!-- Backlog Column -->
                    <div class="kanban-column backlog" data-status="backlog">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                <i class="fas fa-inbox"></i>
                                Backlog
                                <span class="kanban-column-badge">3</span>
                            </div>
                            <div class="kanban-column-actions">
                                <button class="kanban-column-btn" title="Add card">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="kanban-column-body">
                            <div class="kanban-card" draggable="true" data-project-id="1">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Website Redesign Phase 2</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Update remaining pages with new design system and brand guidelines.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Design</span>
                                    <span class="kanban-tag">Frontend</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #3b82f6;">JD</div>
                                        <div class="kanban-avatar" style="background: #8b5cf6;">SM</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-calendar"></i> Feb 15</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="2">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Marketing Campaign Q1</div>
                                    <div class="kanban-card-priority priority-low">Low</div>
                                </div>
                                <div class="kanban-card-description">
                                    Plan and execute social media campaign for new service launch.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Marketing</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #10b981;">AL</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-calendar"></i> Feb 28</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="3">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Office Equipment Upgrade</div>
                                    <div class="kanban-card-priority priority-low">Low</div>
                                </div>
                                <div class="kanban-card-description">
                                    Research and purchase new equipment for operatory rooms.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Operations</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #f59e0b;">RP</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-calendar"></i> Mar 10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- To Do Column -->
                    <div class="kanban-column todo" data-status="todo">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                <i class="fas fa-list"></i>
                                To Do
                                <span class="kanban-column-badge">4</span>
                            </div>
                            <div class="kanban-column-actions">
                                <button class="kanban-column-btn" title="Add card">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="kanban-column-body">
                            <div class="kanban-card" draggable="true" data-project-id="4">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Patient Portal Development</div>
                                    <div class="kanban-card-priority priority-high">High</div>
                                </div>
                                <div class="kanban-card-description">
                                    Build secure patient portal for appointment booking and records access.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Development</span>
                                    <span class="kanban-tag">Security</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #ec4899;">MK</div>
                                        <div class="kanban-avatar" style="background: #06b6d4;">TN</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-comments"></i> 5</span>
                                        <span class="kanban-card-due"><i class="fas fa-calendar"></i> Dec 20</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="5">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Staff Training Program</div>
                                    <div class="kanban-card-priority priority-high">High</div>
                                </div>
                                <div class="kanban-card-description">
                                    Develop comprehensive training materials for new dental software.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Training</span>
                                    <span class="kanban-tag">HR</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #10b981;">AL</div>
                                        <div class="kanban-avatar" style="background: #8b5cf6;">SM</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-calendar"></i> Jan 5</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="6">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Compliance Audit Preparation</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Prepare documentation and procedures for annual compliance review.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Compliance</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #f59e0b;">RP</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-calendar"></i> Jan 15</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="7">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Inventory Management System</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Implement automated system for tracking supplies and equipment.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Operations</span>
                                    <span class="kanban-tag">Software</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #3b82f6;">JD</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-comments"></i> 3</span>
                                        <span><i class="fas fa-calendar"></i> Jan 20</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- In Progress Column -->
                    <div class="kanban-column in-progress" data-status="in-progress">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                <i class="fas fa-spinner"></i>
                                In Progress
                                <span class="kanban-column-badge">3</span>
                            </div>
                            <div class="kanban-column-actions">
                                <button class="kanban-column-btn" title="Add card">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="kanban-column-body">
                            <div class="kanban-card" draggable="true" data-project-id="8">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">EHR System Integration</div>
                                    <div class="kanban-card-priority priority-high">High</div>
                                </div>
                                <div class="kanban-card-description">
                                    Connect practice management software with electronic health records system.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Development</span>
                                    <span class="kanban-tag">Integration</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #06b6d4;">TN</div>
                                        <div class="kanban-avatar" style="background: #ec4899;">MK</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-comments"></i> 12</span>
                                        <span class="kanban-card-due"><i class="fas fa-calendar"></i> Dec 15</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="9">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Holiday Marketing Campaign</div>
                                    <div class="kanban-card-priority priority-high">High</div>
                                </div>
                                <div class="kanban-card-description">
                                    Launch special promotions and social media content for holiday season.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Marketing</span>
                                    <span class="kanban-tag">Design</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #10b981;">AL</div>
                                        <div class="kanban-avatar" style="background: #8b5cf6;">SM</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-comments"></i> 8</span>
                                        <span class="kanban-card-due"><i class="fas fa-calendar"></i> Dec 10</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="10">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Office Renovation Planning</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Design and plan renovations for waiting area and front desk.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Facilities</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #f59e0b;">RP</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-comments"></i> 4</span>
                                        <span><i class="fas fa-calendar"></i> Feb 1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Review Column -->
                    <div class="kanban-column review" data-status="review">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                <i class="fas fa-search"></i>
                                Review
                                <span class="kanban-column-badge">2</span>
                            </div>
                            <div class="kanban-column-actions">
                                <button class="kanban-column-btn" title="Add card">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="kanban-column-body">
                            <div class="kanban-card" draggable="true" data-project-id="11">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Q4 Financial Report</div>
                                    <div class="kanban-card-priority priority-high">High</div>
                                </div>
                                <div class="kanban-card-description">
                                    Complete quarterly financial analysis and prepare presentation for board.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Finance</span>
                                    <span class="kanban-tag">Reporting</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #3b82f6;">JD</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-comments"></i> 6</span>
                                        <span><i class="fas fa-calendar"></i> Dec 8</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="12">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Security Policy Update</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Review and update cybersecurity policies for all staff members.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Security</span>
                                    <span class="kanban-tag">Compliance</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #06b6d4;">TN</div>
                                        <div class="kanban-avatar" style="background: #f59e0b;">RP</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-calendar"></i> Dec 12</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Done Column -->
                    <div class="kanban-column done" data-status="done">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                <i class="fas fa-check-circle"></i>
                                Done
                                <span class="kanban-column-badge">4</span>
                            </div>
                            <div class="kanban-column-actions">
                                <button class="kanban-column-btn" title="Archive">
                                    <i class="fas fa-archive"></i>
                                </button>
                            </div>
                        </div>
                        <div class="kanban-column-body">
                            <div class="kanban-card" draggable="true" data-project-id="13">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">New Employee Onboarding</div>
                                    <div class="kanban-card-priority priority-high">High</div>
                                </div>
                                <div class="kanban-card-description">
                                    Complete onboarding process for three new dental assistants.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">HR</span>
                                    <span class="kanban-tag">Training</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #10b981;">AL</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-check"></i> Completed Nov 28</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="14">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Website Performance Optimization</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Improve site speed and SEO rankings for better online visibility.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Development</span>
                                    <span class="kanban-tag">SEO</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #ec4899;">MK</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-check"></i> Completed Nov 25</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="15">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Annual Insurance Review</div>
                                    <div class="kanban-card-priority priority-low">Low</div>
                                </div>
                                <div class="kanban-card-description">
                                    Review and renew all practice insurance policies.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Operations</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #f59e0b;">RP</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-check"></i> Completed Nov 20</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kanban-card" draggable="true" data-project-id="16">
                                <div class="kanban-card-header">
                                    <div class="kanban-card-title">Patient Satisfaction Survey</div>
                                    <div class="kanban-card-priority priority-medium">Medium</div>
                                </div>
                                <div class="kanban-card-description">
                                    Conduct survey and analyze feedback from 200+ patients.
                                </div>
                                <div class="kanban-card-tags">
                                    <span class="kanban-tag">Research</span>
                                </div>
                                <div class="kanban-card-footer">
                                    <div class="kanban-card-assignees">
                                        <div class="kanban-avatar" style="background: #8b5cf6;">SM</div>
                                    </div>
                                    <div class="kanban-card-meta">
                                        <span><i class="fas fa-check"></i> Completed Nov 18</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Notes Board View -->
        <div class="content-view" id="view-sticky-notes">
            <div style="padding: 1.5rem; height: 100%; display: flex; flex-direction: row; gap: 1.5rem;">
                <!-- Main Board Area -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
                    <div id="stickyBoard" style="background: white; border-radius: 12px; border: 1px solid #e8e8e8; position: relative; padding: 2rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); overflow: auto; flex: 1;">
                        <!-- Sticky notes will be added here -->
                    </div>
                    <div class="sticky-notes-stats">
                        <div class="stat-item-professional">
                            <i class="fas fa-layer-group"></i>
                            <span>Total Notes: <strong id="stickytotalNotes">0</strong></span>
                        </div>
                        <div class="stat-item-professional">
                            <i class="fas fa-save"></i>
                            <span>Auto-saved</span>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="sticky-notes-sidebar">
                    <div class="sticky-notes-title-vertical">
                        <i class="fas fa-sticky-note"></i>
                        <h2>Notes</h2>
                    </div>

                    <!-- Search Box -->
                    <div class="sticky-search-box" style="margin-bottom: 1rem;">
                        <div style="position: relative;">
                            <input type="text" id="stickySearchInput" placeholder="Search notes..." 
                                style="width: 100%; padding: 0.6rem 0.6rem 0.6rem 2.2rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.85rem; background: var(--card-bg); color: var(--text-primary);"
                                oninput="searchStickyNotes(this.value)">
                            <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.8rem;"></i>
                            <button onclick="clearStickySearch()" id="stickySearchClear" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; display: none; padding: 0.25rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="stickySearchResults" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem; display: none;">
                            <span id="stickySearchCount">0</span> notes found
                        </div>
                    </div>

                    <div class="color-picker-vertical">
                        <label>Drag Color:</label>
                        <div class="color-options-vertical">
                            <div class="sticky-color-option active" data-color="yellow" style="background: #FFF59D;"></div>
                            <div class="sticky-color-option" data-color="pink" style="background: #F48FB1;"></div>
                            <div class="sticky-color-option" data-color="blue" style="background: #81D4FA;"></div>
                            <div class="sticky-color-option" data-color="green" style="background: #A5D6A7;"></div>
                            <div class="sticky-color-option" data-color="purple" style="background: #CE93D8;"></div>
                            <div class="sticky-color-option" data-color="orange" style="background: #FFB74D;"></div>
                        </div>
                    </div>

                    <button id="stickyClearBtn" class="sticky-note-btn-professional btn-clear-professional">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>

                    <button id="stickyPrintBtn" class="sticky-note-btn-professional btn-print-professional">
                        <i class="fas fa-print"></i>
                        Print
                    </button>

                    <button id="stickySaveBtn" class="sticky-note-btn-professional btn-pdf-professional">
                        <i class="fas fa-file-pdf"></i>
                        PDF
                    </button>

                    <!-- Recycle Bin -->
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button onclick="openStickyRecycleBin()" class="sticky-note-btn-professional" style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white; position: relative;">
                            <i class="fas fa-recycle"></i>
                            Recycle Bin
                            <span id="stickyRecycleBinCount" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 10px; display: none;">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Event Detail Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="modalTitle">Event Details</h3>
                    <div class="modal-badges" id="modalBadges"></div>
                </div>
                <button class="modal-close" onclick="closeEventModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <div class="modal-section-title">Event Information</div>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <div class="modal-info-icon" style="background: #3b82f6; color: white;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="modal-info-content">
                                <div class="modal-info-label">Time</div>
                                <div class="modal-info-value" id="modalTime"></div>
                            </div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-icon" style="background: #a855f7; color: white;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="modal-info-content">
                                <div class="modal-info-label">Assigned To</div>
                                <div class="modal-info-value" id="modalEmployee"></div>
                            </div>
                        </div>
                        <div class="modal-info-item" id="modalAssistantsSection" style="display:none;">
                            <div class="modal-info-icon" style="background: #059669; color: white;">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="modal-info-content">
                                <div class="modal-info-label" id="modalAssistantsLabel">Assistants</div>
                                <div class="modal-info-value" id="modalAssistants"></div>
                            </div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-icon" style="background: #10b981; color: white;">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="modal-info-content">
                                <div class="modal-info-label">Location</div>
                                <div class="modal-info-value" id="modalLocation"></div>
                            </div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-icon" style="background: #f97316; color: white;">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="modal-info-content">
                                <div class="modal-info-label">Priority</div>
                                <div class="modal-info-value" id="modalPriority"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">Description</div>
                    <div class="modal-info-item">
                        <div class="modal-info-content">
                            <p id="modalDescription" style="color: var(--text-primary); line-height: 1.6;"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-section" id="modalNotesSection">
                    <div class="modal-section-title">Additional Notes</div>
                    <div class="modal-info-item">
                        <div class="modal-info-content">
                            <p id="modalNotes" style="color: var(--text-secondary); line-height: 1.6; font-size: 0.9rem;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeEventModal()">
                    <i class="fas fa-times"></i>
                    Close
                </button>
                <button class="btn btn-completed" id="markCompletedBtn" onclick="markAsCompleted()">
    <i class="fas fa-check-circle"></i>
    Mark as Completed
</button>
                <button class="btn btn-primary" onclick="editEvent()">
                    <i class="fas fa-edit"></i>
                    Edit Event
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ AUTHENTICATION SYSTEM ============
        // Test users (in production, this would be handled by a backend API)
        const testUsers = {
            'admin': {
                password: 'admin123',
                role: 'admin',
                name: 'Admin User'
            },
            'user': {
                password: 'user123',
                role: 'user',
                name: 'Regular User'
            },
            'dr.johnson': {
                password: 'dental123',
                role: 'provider',
                name: 'Dr. Sarah Johnson'
            }
        };

        // Check if user is already logged in
        function checkAuth() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const userName = localStorage.getItem('userName');
            const loginScreen = document.getElementById('loginScreen');
            const mainContainer = document.querySelector('.container');
            const header = document.querySelector('.header');
            
            if (loggedInUser) {
                // User is logged in, hide login screen
                if (loginScreen) loginScreen.classList.add('hidden');
                if (mainContainer) mainContainer.style.display = 'flex';
                if (header) header.style.display = 'flex';
                
                // Update displayed user name
                const displayNameEl = document.getElementById('displayUserName');
                if (displayNameEl && userName) {
                    displayNameEl.textContent = userName;
                }
                
                // Update UI for role
                updateUIForRole();
                
                // Initialize chat notifications
                if (typeof initChatNotifications === 'function') {
                    initChatNotifications();
                    updateOnlineStatus(true);
                }
            } else {
                // User is not logged in, show login screen
                if (loginScreen) loginScreen.classList.remove('hidden');
                if (mainContainer) mainContainer.style.display = 'none';
                if (header) header.style.display = 'none';
            }
        }

        // Handle login form submission - Uses API for secure authentication
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = document.querySelector('#loginForm button[type="submit"]');
            
            // Show loading state
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
            }
            
            // Try API login first (secure - passwords checked server-side)
            if (typeof API_BASE_URL !== 'undefined') {
                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        console.log('âœ… API login successful');
                        
                        // Store session
                        localStorage.setItem('loggedInUser', username);
                        localStorage.setItem('userRole', result.user.role);
                        localStorage.setItem('userName', `${result.user.firstName} ${result.user.lastName}`);
                        localStorage.setItem('currentUser', JSON.stringify({
                            username: username,
                            role: result.user.role,
                            name: `${result.user.firstName} ${result.user.lastName}`,
                            firstName: result.user.firstName,
                            lastName: result.user.lastName,
                            permissions: getDefaultPermissions(result.user.role)
                        }));
                        
                        // Show success
                        errorDiv.style.display = 'block';
                        errorDiv.style.background = '#d4edda';
                        errorDiv.style.borderColor = '#c3e6cb';
                        errorDiv.style.color = '#155724';
                        errorDiv.textContent = 'Login successful! Redirecting...';
                        
                        setTimeout(() => {
                            checkAuth();
                            updateUIForRole();
                        }, 500);
                        return;
                    }
                } catch (apiError) {
                    console.log('API login unavailable, using local fallback');
                }
            }
            
            // Fallback to localStorage (for offline/local testing)
            const users = loadUsers();
            
            if (users[username] && users[username].password === password) {
                const user = users[username];
                
                if (!user.permissions) {
                    user.permissions = getDefaultPermissions(user.role);
                    users[username] = user;
                    saveUsers(users);
                }
                
                localStorage.setItem('loggedInUser', username);
                localStorage.setItem('userRole', user.role);
                localStorage.setItem('userName', user.name);
                localStorage.setItem('currentUser', JSON.stringify({
                    username: username,
                    role: user.role,
                    name: user.name,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    permissions: user.permissions
                }));
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.borderColor = '#c3e6cb';
                errorDiv.style.color = '#155724';
                errorDiv.textContent = 'Login successful! Redirecting...';
                
                setTimeout(() => {
                    checkAuth();
                    updateUIForRole();
                }, 500);
            } else {
                // Failed login
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#f8d7da';
                errorDiv.style.borderColor = '#f5c6cb';
                errorDiv.style.color = '#721c24';
                errorDiv.textContent = 'Invalid username or password. Please try again.';
            }
            
            // Reset button
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Sign In';
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                localStorage.removeItem('currentUser');
                
                // Clear chat caches
                chatUserIdCache = null;
                currentDbUserId = null;
                chatUsersCache = [];
                currentChatUserId = null;
                
                checkAuth();
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').style.display = 'none';
                
                // Force page reload to reset state
                setTimeout(() => location.reload(), 100);
            }
        }

        // Initialize auth check on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeUsers(); // Force initialization first
            loadUsers(); // Load users without logging
            checkAuth();
            updateUIForRole();
            
            // Load duties from API
            loadDutiesFromAPI();
            
            // Initialize master settings (logo, company name, etc.)
            initMasterSettings();
        });

        // ============ USER MANAGEMENT SYSTEM ============
        
        // ============ PERMISSION SYSTEM ============
        
        // Define all available permissions with their categories
        const PERMISSION_CATEGORIES = {
            clinics: {
                label: 'Clinics/Offices',
                icon: 'fa-hospital',
                color: '#10b981',
                permissions: {
                    view: { label: 'View Clinics', description: 'See clinic list and details' },
                    create: { label: 'Create Clinics', description: 'Add new clinics' },
                    edit: { label: 'Edit Clinics', description: 'Modify clinic information' },
                    delete: { label: 'Delete Clinics', description: 'Remove clinics' }
                }
            },
            rooms: {
                label: 'Rooms',
                icon: 'fa-door-open',
                color: '#8b5cf6',
                permissions: {
                    view: { label: 'View Rooms', description: 'See room list and details' },
                    create: { label: 'Create Rooms', description: 'Add new rooms' },
                    edit: { label: 'Edit Rooms', description: 'Modify room information' },
                    delete: { label: 'Delete Rooms', description: 'Remove rooms' }
                }
            },
            users: {
                label: 'Users/Employees',
                icon: 'fa-users',
                color: '#3b82f6',
                permissions: {
                    view_all: { label: 'View All Users', description: 'See all users in system' },
                    view_team: { label: 'View Team Only', description: 'See only assigned team members' },
                    create: { label: 'Create Users', description: 'Add new employees' },
                    edit: { label: 'Edit Users', description: 'Modify user information' },
                    delete: { label: 'Delete Users', description: 'Remove users (except admin)' },
                    manage_permissions: { label: 'Manage Permissions', description: 'Assign permissions to users' }
                }
            },
            schedules: {
                label: 'Schedules',
                icon: 'fa-calendar-alt',
                color: '#06b6d4',
                permissions: {
                    view_all: { label: 'View All Schedules', description: 'See all employee schedules' },
                    view_team: { label: 'View Team Schedules', description: 'See team member schedules' },
                    view_own: { label: 'View Own Schedule', description: 'See only personal schedule' },
                    create: { label: 'Create Schedules', description: 'Create new schedules' },
                    edit: { label: 'Edit Schedules', description: 'Modify schedules' },
                    delete: { label: 'Delete Schedules', description: 'Remove schedules' }
                }
            },
            tasks: {
                label: 'Tasks',
                icon: 'fa-tasks',
                color: '#f59e0b',
                permissions: {
                    view_all: { label: 'View All Tasks', description: 'See all tasks in system' },
                    view_team: { label: 'View Team Tasks', description: 'See team member tasks' },
                    view_own: { label: 'View Own Tasks', description: 'See only personal tasks' },
                    create: { label: 'Create Tasks', description: 'Create new tasks' },
                    edit: { label: 'Edit Tasks', description: 'Modify tasks' },
                    delete: { label: 'Delete Tasks', description: 'Remove tasks' },
                    assign: { label: 'Assign Tasks', description: 'Assign tasks to others' }
                }
            },
            vendors: {
                label: 'Vendors',
                icon: 'fa-truck',
                color: '#ec4899',
                permissions: {
                    view: { label: 'View Vendors', description: 'See vendor list and details' },
                    create: { label: 'Create Vendors', description: 'Add new vendors' },
                    edit: { label: 'Edit Vendors', description: 'Modify vendor information' },
                    delete: { label: 'Delete Vendors', description: 'Remove vendors' }
                }
            },
            equipment: {
                label: 'Equipment',
                icon: 'fa-cog',
                color: '#f59e0b',
                permissions: {
                    view: { label: 'View Equipment', description: 'See equipment inventory' },
                    create: { label: 'Create Equipment', description: 'Add new equipment' },
                    edit: { label: 'Edit Equipment', description: 'Modify equipment information' },
                    delete: { label: 'Delete Equipment', description: 'Remove equipment' }
                }
            },
            instruments: {
                label: 'Instruments',
                icon: 'fa-tools',
                color: '#06b6d4',
                permissions: {
                    view: { label: 'View Instruments', description: 'See instruments inventory' },
                    create: { label: 'Create Instruments', description: 'Add new instruments' },
                    edit: { label: 'Edit Instruments', description: 'Modify instrument information' },
                    delete: { label: 'Delete Instruments', description: 'Remove instruments' }
                }
            },
            supplies: {
                label: 'Supplies',
                icon: 'fa-boxes',
                color: '#8b5cf6',
                permissions: {
                    view: { label: 'View Supplies', description: 'See supplies inventory' },
                    create: { label: 'Create Supplies', description: 'Add new supplies' },
                    edit: { label: 'Edit Supplies', description: 'Modify supply information' },
                    delete: { label: 'Delete Supplies', description: 'Remove supplies' }
                }
            },
            reports: {
                label: 'Reports',
                icon: 'fa-chart-bar',
                color: '#6366f1',
                permissions: {
                    view: { label: 'View Reports', description: 'Access reports and analytics' },
                    export: { label: 'Export Reports', description: 'Download/export report data' }
                }
            },
            system: {
                label: 'System',
                icon: 'fa-cog',
                color: '#ef4444',
                permissions: {
                    reset_data: { label: 'Reset Data', description: 'Clear application data' },
                    manage_settings: { label: 'Manage Settings', description: 'Configure system settings' }
                }
            }
        };
        
        // Permission access levels
        const ACCESS_LEVELS = {
            full: { label: 'Full Access', icon: 'fa-check-circle', color: '#10b981', description: 'Can view and interact' },
            readonly: { label: 'Read Only', icon: 'fa-eye', color: '#f59e0b', description: 'Can view but not modify' },
            hidden: { label: 'Hidden', icon: 'fa-eye-slash', color: '#ef4444', description: 'Cannot see or access' }
        };
        
        // Get default permissions for a role
        function getDefaultPermissions(role) {
            const allPermissions = {};
            
            // Build permission structure
            Object.keys(PERMISSION_CATEGORIES).forEach(category => {
                allPermissions[category] = {};
                Object.keys(PERMISSION_CATEGORIES[category].permissions).forEach(perm => {
                    if (role === 'admin') {
                        allPermissions[category][perm] = 'full';
                    } else if (role === 'manager') {
                        // Managers get team-level access by default
                        if (perm.includes('view')) {
                            allPermissions[category][perm] = 'full';
                        } else if (perm === 'view_all' || perm === 'delete' || perm === 'manage_permissions' || perm === 'reset_data') {
                            allPermissions[category][perm] = 'hidden';
                        } else {
                            allPermissions[category][perm] = 'readonly';
                        }
                    } else {
                        // Regular users - minimal access
                        if (perm === 'view_own') {
                            allPermissions[category][perm] = 'full';
                        } else if (perm.includes('view')) {
                            allPermissions[category][perm] = 'hidden';
                        } else {
                            allPermissions[category][perm] = 'hidden';
                        }
                    }
                });
            });
            
            return allPermissions;
        }
        
        // Check if current user has a specific permission
        function hasPermission(category, permission, requiredLevel = 'full') {
            const currentUser = localStorage.getItem('currentUser');
            const userRole = localStorage.getItem('userRole');
            
            // Admin always has full access
            if (userRole === 'admin') return true;
            
            const users = loadUsers();
            const user = users[currentUser];
            
            if (!user || !user.permissions) {
                // No permissions set, use defaults
                const defaults = getDefaultPermissions(userRole || 'user');
                const level = defaults[category]?.[permission] || 'hidden';
                return requiredLevel === 'readonly' ? (level === 'full' || level === 'readonly') : level === 'full';
            }
            
            const level = user.permissions[category]?.[permission] || 'hidden';
            
            if (requiredLevel === 'readonly') {
                return level === 'full' || level === 'readonly';
            }
            return level === 'full';
        }
        
        // Get permission level for current user
        function getPermissionLevel(category, permission) {
            const currentUser = localStorage.getItem('currentUser');
            const userRole = localStorage.getItem('userRole');
            
            // Admin always has full access
            if (userRole === 'admin') return 'full';
            
            const users = loadUsers();
            const user = users[currentUser];
            
            if (!user || !user.permissions) {
                const defaults = getDefaultPermissions(userRole || 'user');
                return defaults[category]?.[permission] || 'hidden';
            }
            
            return user.permissions[category]?.[permission] || 'hidden';
        }
        
        // Migrate permissions - add any new permission categories to existing users
        function migrateUserPermissions() {
            const usersJson = localStorage.getItem('appUsers');
            if (!usersJson) return;
            
            const users = JSON.parse(usersJson);
            let updated = false;
            
            // Get all current permission categories
            const currentCategories = Object.keys(PERMISSION_CATEGORIES);
            
            for (const username in users) {
                const user = users[username];
                if (!user.permissions) {
                    user.permissions = getDefaultPermissions(user.role || 'user');
                    updated = true;
                } else {
                    // Check for missing categories and add them
                    for (const category of currentCategories) {
                        if (!user.permissions[category]) {
                            // Add missing category with default permissions for user's role
                            const defaults = getDefaultPermissions(user.role || 'user');
                            user.permissions[category] = defaults[category];
                            updated = true;
                            console.log(`Added missing '${category}' permissions for user: ${username}`);
                        }
                    }
                }
            }
            
            if (updated) {
                localStorage.setItem('appUsers', JSON.stringify(users));
                console.log('User permissions migrated successfully');
            }
        }
        
        // Initialize users storage if not exists (only as fallback if API unavailable)
        function initializeUsers() {
            // Only create default admin if no users exist in localStorage AND API sync hasn't happened
            // This is a fallback for offline mode only
            if (!localStorage.getItem('appUsers')) {
                // Only create admin account as fallback - database is source of truth
                const defaultUsers = {
                    'admin': {
                        password: 'admin123',
                        role: 'admin',
                        name: 'Admin User',
                        firstName: 'Admin',
                        lastName: 'User',
                        jobTitle: 'System Administrator',
                        employeeStatus: 'Active',
                        permissions: getDefaultPermissions('admin')
                    }
                };
                localStorage.setItem('appUsers', JSON.stringify(defaultUsers));
            }
            
            // Always run migration to add any new permission categories
            migrateUserPermissions();
        }

        // Load users from localStorage (should be synced from API first)
        function loadUsers() {
            // Note: Always call syncUsersFromAPI() before this to ensure data is fresh
            const usersJson = localStorage.getItem('appUsers');
            if (usersJson) {
                return JSON.parse(usersJson);
            }
            // Fallback if localStorage is empty
            initializeUsers();
            return JSON.parse(localStorage.getItem('appUsers') || '{}');
        }

        // Save users to localStorage and optionally sync to API
        function saveUsers(users) {
            localStorage.setItem('appUsers', JSON.stringify(users));
        }
        
        // Save a single user to the database API
        async function saveUserToAPI(username, userData) {
            if (typeof API_BASE_URL === 'undefined') {
                console.log('âš ï¸ API_BASE_URL not defined, skipping database sync');
                return;
            }
            try {
                console.log('ðŸ“¤ Saving user to database:', username);
                const payload = {
                    username: username,
                    password: userData.password || 'changeme123',
                    firstName: userData.firstName || '',
                    middleName: userData.middleName || '',
                    lastName: userData.lastName || '',
                    gender: userData.gender || '',
                    dateOfBirth: userData.dateOfBirth || null,
                    role: userData.role || 'user',
                    staffType: userData.staffType || 'non-clinical',
                    employeeType: userData.employeeType || 'full-time',
                    department: userData.department || '',
                    employeeStatus: userData.employeeStatus || 'active',
                    jobTitle: userData.jobTitle || '',
                    workEmail: userData.workEmail || '',
                    personalEmail: userData.personalEmail || '',
                    cellPhone: userData.cellPhone || '',
                    homePhone: userData.homePhone || '',
                    address: userData.address || '',
                    city: userData.city || '',
                    state: userData.state || '',
                    zipCode: userData.zipCode || '',
                    hireDate: userData.hireDate || null,
                    hourlyRate: userData.hourlyRate || null,
                    salary: userData.salary || null,
                    color: userData.color || '#3b82f6'
                };
                console.log('ðŸ“¦ Payload:', JSON.stringify(payload));
                
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('âœ… User saved to database:', username, result);
                    showSyncStatus('User saved to database', true);
                    
                    // Store the database ID back in localStorage
                    if (result.id) {
                        const users = JSON.parse(localStorage.getItem('appUsers') || '{}');
                        if (users[username]) {
                            users[username].id = result.id;
                            localStorage.setItem('appUsers', JSON.stringify(users));
                            console.log('ðŸ“ Stored database ID:', result.id, 'for user:', username);
                        }
                    }
                } else {
                    console.error('âŒ API error:', response.status, result);
                    showSyncStatus('Failed to save user to database: ' + (result.error || result.details || 'Unknown error'), false);
                }
            } catch (error) {
                console.error('âŒ Error saving user to API:', error);
                showSyncStatus('Error saving to database: ' + error.message, false);
            }
        }

        // Update existing user in database via API
        async function updateUserViaAPI(userId, userData) {
            if (typeof API_BASE_URL === 'undefined') {
                console.log('âš ï¸ API_BASE_URL not defined, skipping database sync');
                return;
            }
            try {
                console.log('ðŸ“¤ Updating user in database, ID:', userId);
                const payload = {
                    firstName: userData.firstName || '',
                    middleName: userData.middleName || '',
                    lastName: userData.lastName || '',
                    gender: userData.gender || '',
                    dateOfBirth: userData.dateOfBirth || null,
                    role: userData.role || 'user',
                    staffType: userData.staffType || 'non-clinical',
                    employeeType: userData.employeeType || 'full-time',
                    department: userData.department || '',
                    employeeStatus: userData.employeeStatus || 'active',
                    jobTitle: userData.jobTitle || '',
                    workEmail: userData.workEmail || '',
                    personalEmail: userData.personalEmail || '',
                    cellPhone: userData.cellPhone || '',
                    homePhone: userData.homePhone || '',
                    address: userData.address || '',
                    city: userData.city || '',
                    state: userData.state || '',
                    zipCode: userData.zipCode || '',
                    hireDate: userData.hireDate || null,
                    hourlyRate: userData.hourlyRate || null,
                    salary: userData.salary || null,
                    color: userData.color || '#3b82f6'
                };
                console.log('ðŸ“¦ Update Payload:', JSON.stringify(payload));
                
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    console.log('âœ… User updated in database');
                    showSyncStatus('User updated in database', true);
                } else {
                    const result = await response.json();
                    console.error('âŒ API error:', response.status, result);
                    showSyncStatus('Failed to update user: ' + (result.error || 'Unknown error'), false);
                }
            } catch (error) {
                console.error('âŒ Error updating user via API:', error);
                showSyncStatus('Error updating user: ' + error.message, false);
            }
        }

        // Update UI based on user role and permissions
        function updateUIForRole() {
            const userRole = localStorage.getItem('userRole');
            
            // Set data-role attribute on HTML element for CSS-based hiding
            const root = document.documentElement;
            root.setAttribute('data-role', userRole || 'user');
            
            const masterSettingsMenuItem = document.getElementById('masterSettingsMenuItem');
            const manageOfficesMenuItem = document.getElementById('manageOfficesMenuItem');
            const manageRoomsMenuItem = document.getElementById('manageRoomsMenuItem');
            const manageUsersMenuItem = document.getElementById('manageUsersMenuItem');
            const manageVendorsMenuItem = document.getElementById('manageVendorsMenuItem');
            const manageEquipmentMenuItem = document.getElementById('manageEquipmentMenuItem');
            const manageInstrumentsMenuItem = document.getElementById('manageInstrumentsMenuItem');
            const manageSuppliesMenuItem = document.getElementById('manageSuppliesMenuItem');
            const scheduleManagerMenuItem = document.getElementById('scheduleManagerMenuItem');
            const manageTasksMenuItem = document.getElementById('manageTasksMenuItem');
            const manageDutiesMenuItem = document.getElementById('manageDutiesMenuItem');
            const resetDataMenuItem = document.getElementById('resetDataMenuItem');
            const managePermissionsMenuItem = document.getElementById('managePermissionsMenuItem');
            
            // Helper function to set menu item visibility based on permission
            function setMenuVisibility(element, category, permission) {
                if (!element) return;
                
                const level = getPermissionLevel(category, permission);
                
                if (level === 'full') {
                    element.style.display = 'block';
                    element.style.opacity = '1';
                    element.style.pointerEvents = 'auto';
                    element.classList.remove('permission-readonly', 'permission-hidden');
                } else if (level === 'readonly') {
                    element.style.display = 'block';
                    element.style.opacity = '0.6';
                    element.style.pointerEvents = 'none';
                    element.classList.add('permission-readonly');
                    element.classList.remove('permission-hidden');
                } else {
                    element.style.display = 'none';
                    element.classList.add('permission-hidden');
                    element.classList.remove('permission-readonly');
                }
            }
            
            // Master Settings - only for admin/owner or users with system settings permission
            if (masterSettingsMenuItem) {
                const canAccessSettings = userRole === 'admin' || userRole === 'owner' || hasPermission('system', 'settings');
                masterSettingsMenuItem.style.display = canAccessSettings ? 'block' : 'none';
            }
            
            // Apply permissions to menu items
            setMenuVisibility(manageOfficesMenuItem, 'clinics', 'view');
            setMenuVisibility(manageRoomsMenuItem, 'rooms', 'view');
            setMenuVisibility(manageUsersMenuItem, 'users', 'view_all');
            setMenuVisibility(manageVendorsMenuItem, 'vendors', 'view');
            setMenuVisibility(manageEquipmentMenuItem, 'equipment', 'view');
            setMenuVisibility(manageInstrumentsMenuItem, 'instruments', 'view');
            setMenuVisibility(manageSuppliesMenuItem, 'supplies', 'view');
            setMenuVisibility(scheduleManagerMenuItem, 'schedules', 'create');
            setMenuVisibility(manageTasksMenuItem, 'tasks', 'view_all');
            setMenuVisibility(manageDutiesMenuItem, 'tasks', 'view_all'); // Duties uses same permission as tasks
            setMenuVisibility(resetDataMenuItem, 'system', 'reset_data');
            
            // Manage Permissions - only for those who can manage_permissions
            if (managePermissionsMenuItem) {
                const canManagePerms = hasPermission('users', 'manage_permissions');
                managePermissionsMenuItem.style.display = canManagePerms ? 'block' : 'none';
            }
            
            // Re-render tasks list to apply user filtering
            if (typeof renderTasksList === 'function') {
                renderTasksList();
            }
        }

        // Toggle settings dropdown menu
        function toggleSettingsMenu() {
            const dropdown = document.getElementById('settingsDropdown');
            if (dropdown) {
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }

        // ============ MASTER SETTINGS ============
        
        // Open Master Settings modal
        function openMasterSettings() {
            const modal = document.getElementById('masterSettingsModal');
            if (modal) {
                modal.style.display = 'flex';
                loadMasterSettings();
            }
        }
        
        // Close Master Settings modal
        function closeMasterSettings() {
            const modal = document.getElementById('masterSettingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Load Master Settings from localStorage/API
        function loadMasterSettings() {
            const settings = JSON.parse(localStorage.getItem('masterSettings') || '{}');
            
            // Load company name
            const companyName = settings.companyName || 'ReformDental';
            document.getElementById('settingsCompanyName').value = companyName;
            
            // Load tagline
            const tagline = settings.tagline || 'Management System';
            document.getElementById('settingsTagline').value = tagline;
            
            // Load logo preview
            if (settings.logoData) {
                const previewImg = document.getElementById('logoPreviewImg');
                const placeholder = document.getElementById('logoPreviewPlaceholder');
                previewImg.src = settings.logoData;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                document.getElementById('logoPreviewImg').style.display = 'none';
                document.getElementById('logoPreviewPlaceholder').style.display = 'block';
            }
        }
        
        // Handle logo file upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    alert('Logo file is too large. Please use an image under 2MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoData = e.target.result;
                    
                    // Show preview
                    const previewImg = document.getElementById('logoPreviewImg');
                    const placeholder = document.getElementById('logoPreviewPlaceholder');
                    previewImg.src = logoData;
                    previewImg.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Remove logo
        function removeLogo() {
            document.getElementById('logoPreviewImg').src = '';
            document.getElementById('logoPreviewImg').style.display = 'none';
            document.getElementById('logoPreviewPlaceholder').style.display = 'block';
            document.getElementById('logoFileInput').value = '';
        }
        
        // Save Master Settings
        async function saveMasterSettings() {
            const companyName = document.getElementById('settingsCompanyName').value.trim() || 'ReformDental';
            const tagline = document.getElementById('settingsTagline').value.trim() || 'Management System';
            const logoPreviewImg = document.getElementById('logoPreviewImg');
            const logoData = logoPreviewImg.style.display !== 'none' ? logoPreviewImg.src : null;
            
            const settings = {
                companyName,
                tagline,
                logoData,
                updatedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('masterSettings', JSON.stringify(settings));
            
            // Apply settings to header
            applyMasterSettings(settings);
            
            // Try to save to API for sync across devices
            try {
                await fetch(`${API_BASE_URL}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                console.log('âœ… Master settings saved to API');
            } catch (error) {
                console.log('âš ï¸ Settings saved locally (API sync not available)');
            }
            
            alert('Settings saved successfully!');
            closeMasterSettings();
        }
        
        // Apply Master Settings to the app header
        function applyMasterSettings(settings) {
            // Apply company name
            const companyNameEl = document.getElementById('appCompanyName');
            if (companyNameEl && settings.companyName) {
                companyNameEl.textContent = settings.companyName;
            }
            
            // Apply tagline
            const taglineEl = document.getElementById('appTagline');
            if (taglineEl && settings.tagline) {
                taglineEl.textContent = settings.tagline;
            }
            
            // Apply logo
            const customLogo = document.getElementById('customLogoImg');
            const defaultIcon = document.getElementById('defaultLogoIcon');
            if (settings.logoData) {
                customLogo.src = settings.logoData;
                customLogo.style.display = 'block';
                defaultIcon.style.display = 'none';
            } else {
                customLogo.style.display = 'none';
                defaultIcon.style.display = 'block';
            }
        }
        
        // Load and apply settings on page load
        async function initMasterSettings() {
            // First try to load from localStorage for immediate display
            let settings = JSON.parse(localStorage.getItem('masterSettings') || '{}');
            if (Object.keys(settings).length > 0) {
                applyMasterSettings(settings);
            }
            
            // Then try to sync from API (database) for latest settings
            try {
                const response = await fetch(`${API_BASE_URL}/settings`);
                if (response.ok) {
                    const apiSettings = await response.json();
                    if (apiSettings && Object.keys(apiSettings).length > 0) {
                        // Update localStorage with API data
                        localStorage.setItem('masterSettings', JSON.stringify(apiSettings));
                        applyMasterSettings(apiSettings);
                        console.log('âœ… Master settings synced from database');
                    }
                }
            } catch (error) {
                console.log('âš ï¸ Using local settings (API not available)');
            }
        }

        // Close settings menu when clicking outside
        document.addEventListener('click', function(event) {
            const settingsBtn = document.getElementById('settingsBtn');
            const dropdown = document.getElementById('settingsDropdown');
            if (settingsBtn && dropdown && !settingsBtn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Open user management modal
        async function openUserManagement() {
            const modal = document.getElementById('userManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                // First sync from API, then display
                if (typeof syncUsersFromAPI === 'function') {
                    await syncUsersFromAPI();
                }
                displayUsersList();
            }
        }

        // Close all management modals
        function closeAllManagementModals() {
            // List of all modal IDs
            const modalIds = [
                'userManagementModal',
                'officesManagementModal',
                'roomsManagementModal',
                'vendorsManagementModal',
                'equipmentManagementModal',
                'instrumentsManagementModal',
                'suppliesManagementModal',
                'addUserModal',
                'editUserModal',
                'equipmentListModal',
                'instrumentsListModal',
                'suppliesListModal',
                'officePlanModal'
            ];
            
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Close user management modal
        function closeUserManagement() {
            const modal = document.getElementById('userManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Open Add User Modal
        function openAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.style.display = 'flex';
                // Reset form
                document.getElementById('createUserForm').reset();
                document.getElementById('createUserError').style.display = 'none';
                // Reset photo preview
                const photoPreview = document.getElementById('photoPreview');
                if (photoPreview) {
                    photoPreview.innerHTML = '<i class="fas fa-user" style="font-size: 2.5rem; color: var(--text-tertiary);"></i>';
                }
                // Reset documents
                const documentsList = document.getElementById('documentsList');
                if (documentsList) {
                    documentsList.style.display = 'none';
                }
                uploadedPhoto = null;
                uploadedDocuments = [];
            }
        }

        // Close Add User Modal
        function closeAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Clear form
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserError').style.display = 'none';
            // Hide separation fields
            const sepContainer = document.getElementById('newSeparationFieldsContainer');
            if (sepContainer) sepContainer.style.display = 'none';
        }

        // Toggle Separation Fields visibility for Add User modal
        function toggleNewSeparationFields() {
            const status = document.getElementById('newEmployeeStatus').value;
            const container = document.getElementById('newSeparationFieldsContainer');
            if (container) {
                if (status === 'Active') {
                    container.style.display = 'none';
                    // Clear fields when hidden
                    document.getElementById('newSeparationDate').value = '';
                    document.getElementById('newSeparationReason').value = '';
                } else {
                    container.style.display = 'block';
                }
            }
        }

        // Toggle Separation Fields visibility for Edit User modal
        function toggleEditSeparationFields() {
            const status = document.getElementById('editEmployeeStatus').value;
            const container = document.getElementById('editSeparationFieldsContainer');
            if (container) {
                if (status === 'Active') {
                    container.style.display = 'none';
                } else {
                    container.style.display = 'block';
                }
            }
        }

        // Create new user
        async function createUser(event) {
            event.preventDefault();
            
            // Get all form values
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            const errorDiv = document.getElementById('createUserError');
            
            // Personal Information
            let title = document.getElementById('newTitle').value;
            // Handle custom title
            if (title === 'Other') {
                title = document.getElementById('newCustomTitle').value.trim();
            }
            const firstName = document.getElementById('newFirstName').value.trim();
            const middleName = document.getElementById('newMiddleName').value.trim();
            const lastName = document.getElementById('newLastName').value.trim();
            const gender = document.getElementById('newGender').value;
            const dateOfBirth = document.getElementById('newDateOfBirth').value;
            const ssn = document.getElementById('newSSN').value.trim();
            
            // Contact Information
            const personalEmail = document.getElementById('newPersonalEmail').value.trim();
            const workEmail = document.getElementById('newWorkEmail').value.trim();
            const homePhone = document.getElementById('newHomePhone').value.trim();
            const cellPhone = document.getElementById('newCellPhone').value.trim();
            const address = document.getElementById('newAddress').value.trim();
            const city = document.getElementById('newCity').value.trim();
            const state = document.getElementById('newState').value.trim();
            const zipCode = document.getElementById('newZipCode').value.trim();
            
            // Employment Information
            const jobTitle = document.getElementById('newJobTitle').value.trim();
            const staffType = document.getElementById('newStaffType').value;
            const employeeType = document.getElementById('newEmployeeType').value;
            const hireDate = document.getElementById('newHireDate').value;
            const employeeStatus = document.getElementById('newEmployeeStatus').value;
            const nextReviewDate = document.getElementById('newNextReviewDate').value;
            const exemptStatus = document.getElementById('newExemptStatus').value;
            const officeLocation = document.getElementById('newOfficeLocation').value.trim();
            const department = document.getElementById('newDepartment').value.trim();
            const directSupervisor = document.getElementById('newDirectSupervisor').value.trim();
            const roleTitle = document.getElementById('newRoleTitle').value.trim();
            const separationDate = document.getElementById('newSeparationDate').value;
            const separationReason = document.getElementById('newSeparationReason').value.trim();
            const hourlyRate = document.getElementById('newHourlyRate').value;
            const salary = document.getElementById('newSalary').value;
            const benefitStartDate = document.getElementById('newBenefitStartDate').value;
            const color = document.getElementById('newColor').value;
            
            // Emergency Contact Information
            const emergencyContactName = document.getElementById('emergencyContactName').value.trim();
            const emergencyContactRelationship = document.getElementById('emergencyContactRelationship').value.trim();
            const emergencyContactPhone = document.getElementById('emergencyContactPhone').value.trim();
            const emergencyContactEmail = document.getElementById('emergencyContactEmail').value.trim();
            
            // Validate
            if (username.length < 3) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Username must be at least 3 characters long.';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Password must be at least 6 characters long.';
                return;
            }
            
            // Validate required fields
            if (!firstName || !lastName || !workEmail || !jobTitle || !hireDate) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please fill in all required fields.';
                return;
            }
            
            // Load existing users
            const users = loadUsers();
            
            // Check if username already exists
            if (users[username]) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Username already exists. Please choose a different username.';
                return;
            }
            
            // Create full name
            const fullName = middleName 
                ? `${firstName} ${middleName} ${lastName}` 
                : `${firstName} ${lastName}`;
            
            // Add new user with all employee data
            users[username] = {
                password: password,
                role: role,
                name: fullName,
                // Personal Information
                title: title,
                firstName: firstName,
                middleName: middleName,
                lastName: lastName,
                gender: gender,
                dateOfBirth: dateOfBirth,
                ssn: ssn,
                // Contact Information
                personalEmail: personalEmail,
                workEmail: workEmail,
                homePhone: homePhone,
                cellPhone: cellPhone,
                address: address,
                city: city,
                state: state,
                zipCode: zipCode,
                // Emergency Contact
                emergencyContactName: emergencyContactName,
                emergencyContactRelationship: emergencyContactRelationship,
                emergencyContactPhone: emergencyContactPhone,
                emergencyContactEmail: emergencyContactEmail,
                // Employment Information
                jobTitle: jobTitle,
                staffType: staffType,
                employeeType: employeeType,
                hireDate: hireDate,
                employeeStatus: employeeStatus,
                nextReviewDate: nextReviewDate,
                exemptStatus: exemptStatus,
                officeLocation: officeLocation,
                department: department,
                directSupervisor: directSupervisor,
                roleTitle: roleTitle,
                separationDate: separationDate,
                separationReason: separationReason,
                hourlyRate: hourlyRate ? parseFloat(hourlyRate) : null,
                salary: salary ? parseFloat(salary) : null,
                benefitStartDate: benefitStartDate,
                color: color,
                // Photo & Documents
                photoData: uploadedPhoto ? uploadedPhoto.dataURL : null,
                photoFileName: uploadedPhoto ? uploadedPhoto.fileName : null,
                documents: uploadedDocuments.length > 0 ? uploadedDocuments : [],
                // Permissions - assign default based on role
                permissions: getDefaultPermissions(role),
                // System fields
                isActive: true,
                createdDate: new Date().toISOString(),
                modifiedDate: new Date().toISOString(),
                failedLoginAttempts: 0
            };
            
            // Save to storage
            saveUsers(users);
            
            // Also save to database API and get the user ID
            const savedUser = await saveUserToAPI(username, users[username]);
            
            // Assign selected duties to the new user
            const selectedDutyIds = getSelectedDutyIds();
            if (selectedDutyIds.length > 0 && savedUser && savedUser.id) {
                await assignDutiesToUser(savedUser.id, selectedDutyIds);
            }
            
            // Show success message
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#d4edda';
            errorDiv.style.borderColor = '#c3e6cb';
            errorDiv.style.color = '#155724';
            errorDiv.textContent = `Employee "${fullName}" created successfully!${selectedDutyIds.length > 0 ? ` (${selectedDutyIds.length} duties assigned)` : ''}`;
            
            // Reset form
            document.getElementById('createUserForm').reset();
            clearAllDuties();
            
            // Clear uploaded files
            uploadedPhoto = null;
            uploadedDocuments = [];
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('documentsList').innerHTML = '';
            
            // Refresh users list
            displayUsersList();
            
            // Refresh duties data
            loadDutiesFromAPI();
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
            }, 3000);
        }

        // Display users list as table rows
        function displayUsersList() {
            const users = loadUsers();
            const usersList = document.getElementById('usersList');
            
            if (!usersList) return;
            
            usersList.innerHTML = '';
            
            const roleColors = {
                admin: '#ef4444',
                manager: '#f59e0b',
                user: '#10b981'
            };

            const statusColors = {
                'Active': '#10b981',
                'Inactive': '#6b7280',
                'On Leave': '#f59e0b',
                'Terminated': '#ef4444'
            };
            
            Object.keys(users).forEach(username => {
                const user = users[username];
                const row = document.createElement('tr');
                row.style.cssText = 'border-bottom: 1px solid var(--border-color); transition: background 0.2s;';
                row.onmouseover = function() { this.style.background = 'var(--bg-secondary)'; };
                row.onmouseout = function() { this.style.background = 'transparent'; };
                
                const status = user.employeeStatus || 'Active';
                
                row.innerHTML = `
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="font-weight: 600;">${user.name || username}</div>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${username}</td>
                    <td style="padding: 1rem;">
                        <span style="background: ${roleColors[user.role] || '#6b7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${(user.role || 'user').toUpperCase()}</span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${user.jobTitle || '-'}</td>
                    <td style="padding: 1rem;">
                        <span style="background: ${statusColors[status] || '#6b7280'}20; color: ${statusColors[status] || '#6b7280'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${status}</span>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="openEditUserModal('${username}')" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="openHRInfoModal('${username}')" style="padding: 0.5rem 1rem; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'" title="HR Info">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </button>
                            ${username !== 'admin' ? `<button onclick="deleteUser('${username}')" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </td>
                `;
                
                usersList.appendChild(row);
            });
        }

        // Delete user
        function deleteUser(username) {
            if (username === 'admin') {
                alert('Cannot delete the admin user.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user "${username}"?`)) {
                const users = loadUsers();
                const userId = users[username]?.id;
                console.log('ðŸ—‘ï¸ Deleting user:', username, 'Database ID:', userId);
                
                // Delete from database FIRST (before removing from local storage)
                if (userId) {
                    deleteUserViaAPI(userId);
                } else {
                    console.warn('âš ï¸ User has no database ID, cannot delete from Azure');
                    showSyncStatus('User deleted locally only (no database ID)', false);
                }
                
                // Then delete from localStorage
                delete users[username];
                saveUsers(users);
                displayUsersList();
            }
        }

        // Delete user from database via API
        async function deleteUserViaAPI(userId) {
            if (typeof API_BASE_URL === 'undefined') {
                console.log('âš ï¸ API_BASE_URL not defined, skipping database sync');
                return;
            }
            try {
                console.log('ðŸ—‘ï¸ Deleting user from database, ID:', userId);
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    console.log('âœ… User deleted from database');
                    showSyncStatus('User deleted from database', true);
                } else {
                    console.error('âŒ Failed to delete user from database');
                    showSyncStatus('Failed to delete user from database', false);
                }
            } catch (error) {
                console.error('âŒ Error deleting user via API:', error);
                showSyncStatus('Error deleting user: ' + error.message, false);
            }
        }

        // ============ EDIT USER FUNCTIONS ============
        
        let editingUsername = null;
        let editUploadedPhoto = null;
        let editUploadedDocuments = [];
        
        // Preview photo for edit modal
        function previewEditPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo must be less than 5MB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('editPhotoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    document.getElementById('editRemovePhotoBtn').style.display = 'inline-block';
                    editUploadedPhoto = { dataURL: e.target.result, fileName: file.name };
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Remove photo for edit modal
        function removeEditPhoto() {
            const preview = document.getElementById('editPhotoPreview');
            preview.innerHTML = '<i class="fas fa-user" style="font-size: 2.5rem; color: var(--text-tertiary);"></i>';
            document.getElementById('editRemovePhotoBtn').style.display = 'none';
            document.getElementById('editEmployeePhoto').value = '';
            editUploadedPhoto = null;
        }
        
        // Handle documents upload for edit modal
        function handleEditDocumentsUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Max size is 10MB.`);
                    continue;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    editUploadedDocuments.push({
                        name: file.name,
                        type: file.type,
                        dataURL: e.target.result
                    });
                    displayEditDocuments();
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Display documents list for edit modal
        function displayEditDocuments() {
            const container = document.getElementById('editDocumentsPreview');
            const listDiv = document.getElementById('editDocumentsList');
            
            if (editUploadedDocuments.length === 0) {
                listDiv.style.display = 'none';
                return;
            }
            
            listDiv.style.display = 'block';
            container.innerHTML = editUploadedDocuments.map((doc, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--border-color);">
                    <span style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary);">
                        <i class="fas fa-file" style="color: var(--accent-primary);"></i>
                        ${doc.name}
                    </span>
                    <button type="button" onclick="removeEditDocument(${index})" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Remove document from edit list
        function removeEditDocument(index) {
            editUploadedDocuments.splice(index, 1);
            displayEditDocuments();
        }
        
        // Toggle custom title input visibility
        function toggleCustomTitle(prefix) {
            const titleSelect = document.getElementById(prefix + 'Title');
            const customContainer = document.getElementById(prefix + 'CustomTitleContainer');
            const customInput = document.getElementById(prefix + 'CustomTitle');
            
            if (titleSelect.value === 'Other') {
                customContainer.style.display = 'block';
                customInput.focus();
            } else {
                customContainer.style.display = 'none';
                customInput.value = '';
            }
        }
        
        // Cancel custom title
        function cancelCustomTitle(prefix) {
            const titleSelect = document.getElementById(prefix + 'Title');
            const customContainer = document.getElementById(prefix + 'CustomTitleContainer');
            const customInput = document.getElementById(prefix + 'CustomTitle');
            
            titleSelect.value = '';
            customContainer.style.display = 'none';
            customInput.value = '';
        }
        
        // Detect location using browser geolocation
        function detectLocation(prefix) {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            
            // Show loading state
            if (typeof showNotification === 'function') {
                showNotification('Detecting your location...', 'info');
            }
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        // Use free reverse geocoding service (Nominatim OpenStreetMap)
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
                        const data = await response.json();
                        
                        if (data && data.address) {
                            const address = data.address;
                            
                            // Build street address
                            let streetAddress = '';
                            if (address.house_number) streetAddress += address.house_number + ' ';
                            if (address.road) streetAddress += address.road;
                            
                            // Fill in form fields
                            const addressField = document.getElementById(prefix + 'Address');
                            const cityField = document.getElementById(prefix + 'City');
                            const stateField = document.getElementById(prefix + 'State');
                            const zipField = document.getElementById(prefix + 'ZipCode');
                            
                            if (addressField && streetAddress) addressField.value = streetAddress.trim();
                            if (cityField) cityField.value = address.city || address.town || address.village || address.municipality || '';
                            if (stateField) stateField.value = getStateAbbreviation(address.state) || '';
                            if (zipField) zipField.value = address.postcode || '';
                            
                            if (typeof showNotification === 'function') {
                                showNotification('Location detected successfully!', 'success');
                            }
                        } else {
                            if (typeof showNotification === 'function') {
                                showNotification('Could not determine address from location.', 'warning');
                            }
                        }
                    } catch (error) {
                        console.error('Reverse geocoding error:', error);
                        if (typeof showNotification === 'function') {
                            showNotification('Error getting address. Please enter manually.', 'error');
                        }
                    }
                },
                (error) => {
                    let message = 'Could not detect location. ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Please allow location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            message += 'Request timed out.';
                            break;
                        default:
                            message += 'Unknown error.';
                    }
                    if (typeof showNotification === 'function') {
                        showNotification(message, 'error');
                    } else {
                        alert(message);
                    }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // Helper function to convert state name to abbreviation
        function getStateAbbreviation(stateName) {
            if (!stateName) return '';
            
            const states = {
                'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY',
                'District of Columbia': 'DC'
            };
            
            // Check if it's already an abbreviation
            if (stateName.length === 2) return stateName.toUpperCase();
            
            return states[stateName] || stateName.substring(0, 2).toUpperCase();
        }
        
        // ============ ADDRESS AUTOCOMPLETE FUNCTIONS ============
        
        // Debounce timer for address search
        let addressSearchTimer = null;
        
        // Handle address input with debounce
        function handleAddressInput(prefix, value) {
            const suggestionsDiv = document.getElementById(prefix + 'AddressSuggestions');
            
            // Clear previous timer
            if (addressSearchTimer) {
                clearTimeout(addressSearchTimer);
            }
            
            // Hide suggestions if input is too short
            if (!value || value.length < 3) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Show loading state
            suggestionsDiv.innerHTML = '<div class="address-suggestion-loading"><i class="fas fa-spinner fa-spin"></i> Searching addresses...</div>';
            suggestionsDiv.style.display = 'block';
            
            // Debounce the API call (wait 400ms after user stops typing)
            addressSearchTimer = setTimeout(() => {
                searchAddresses(prefix, value);
            }, 400);
        }
        
        // Search for address suggestions using Nominatim
        async function searchAddresses(prefix, query) {
            const suggestionsDiv = document.getElementById(prefix + 'AddressSuggestions');
            
            try {
                // Use Nominatim for address search (limit to USA for better results)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&addressdetails=1&limit=6`);
                const results = await response.json();
                
                if (results && results.length > 0) {
                    suggestionsDiv.innerHTML = results.map((result, index) => {
                        const address = result.address || {};
                        
                        // Build display strings
                        let mainText = '';
                        if (address.house_number) mainText += address.house_number + ' ';
                        if (address.road) mainText += address.road;
                        if (!mainText) mainText = result.display_name.split(',')[0];
                        
                        const city = address.city || address.town || address.village || address.municipality || '';
                        const state = address.state || '';
                        const zip = address.postcode || '';
                        
                        let secondaryText = [city, state, zip].filter(Boolean).join(', ');
                        
                        return `<div class="address-suggestion-item" onclick="selectAddressSuggestion('${prefix}', ${index}, ${JSON.stringify(result).replace(/"/g, '&quot;')})">
                            <div class="suggestion-main">${mainText}</div>
                            <div class="suggestion-secondary">${secondaryText}</div>
                        </div>`;
                    }).join('');
                } else {
                    suggestionsDiv.innerHTML = '<div class="address-suggestion-loading">No addresses found. Try a more specific search.</div>';
                }
            } catch (error) {
                console.error('Address search error:', error);
                suggestionsDiv.innerHTML = '<div class="address-suggestion-loading">Error searching addresses. Please try again.</div>';
            }
        }
        
        // Select an address from suggestions
        function selectAddressSuggestion(prefix, index, resultData) {
            const suggestionsDiv = document.getElementById(prefix + 'AddressSuggestions');
            const addressField = document.getElementById(prefix + 'Address');
            const cityField = document.getElementById(prefix + 'City');
            const stateField = document.getElementById(prefix + 'State');
            const zipField = document.getElementById(prefix + 'ZipCode');
            
            // Parse the result data
            let result;
            try {
                result = typeof resultData === 'string' ? JSON.parse(resultData.replace(/&quot;/g, '"')) : resultData;
            } catch (e) {
                console.error('Error parsing address data:', e);
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const address = result.address || {};
            
            // Build street address
            let streetAddress = '';
            if (address.house_number) streetAddress += address.house_number + ' ';
            if (address.road) streetAddress += address.road;
            
            // Fill in form fields
            if (addressField) addressField.value = streetAddress.trim() || result.display_name.split(',')[0];
            if (cityField) cityField.value = address.city || address.town || address.village || address.municipality || '';
            if (stateField) stateField.value = getStateAbbreviation(address.state) || '';
            if (zipField) zipField.value = address.postcode || '';
            
            // Hide suggestions
            suggestionsDiv.style.display = 'none';
        }
        
        // Close address suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestions = document.querySelectorAll('.address-suggestions');
            suggestions.forEach(div => {
                if (!div.contains(e.target) && !e.target.id.includes('Address')) {
                    div.style.display = 'none';
                }
            });
        });
        
        // Open edit user modal
        function openEditUserModal(username) {
            const users = loadUsers();
            const user = users[username];
            
            if (!user) {
                alert('User not found.');
                return;
            }
            
            editingUsername = username;
            
            // Populate form fields
            document.getElementById('editUsername').value = username;
            document.getElementById('editUserRole').value = user.role || 'user';
            
            // Handle title - check if it's a custom title
            const titleSelect = document.getElementById('editTitle');
            const standardTitles = ['', 'Dr.', 'Mr.', 'Mrs.', 'Ms.'];
            if (user.title && !standardTitles.includes(user.title)) {
                // It's a custom title
                titleSelect.value = 'Other';
                document.getElementById('editCustomTitleContainer').style.display = 'block';
                document.getElementById('editCustomTitle').value = user.title;
            } else {
                titleSelect.value = user.title || '';
                document.getElementById('editCustomTitleContainer').style.display = 'none';
                document.getElementById('editCustomTitle').value = '';
            }
            
            document.getElementById('editFirstName').value = user.firstName || '';
            document.getElementById('editMiddleName').value = user.middleName || '';
            document.getElementById('editLastName').value = user.lastName || '';
            document.getElementById('editGender').value = user.gender || '';
            document.getElementById('editDateOfBirth').value = user.dateOfBirth || '';
            document.getElementById('editPersonalEmail').value = user.personalEmail || '';
            document.getElementById('editWorkEmail').value = user.workEmail || '';
            document.getElementById('editHomePhone').value = user.homePhone || '';
            document.getElementById('editCellPhone').value = user.cellPhone || '';
            document.getElementById('editAddress').value = user.address || '';
            document.getElementById('editCity').value = user.city || '';
            document.getElementById('editState').value = user.state || '';
            document.getElementById('editZipCode').value = user.zipCode || '';
            document.getElementById('editJobTitle').value = user.jobTitle || '';
            document.getElementById('editStaffType').value = user.staffType || '';
            document.getElementById('editEmployeeType').value = user.employeeType || '';
            document.getElementById('editDepartment').value = user.department || '';
            document.getElementById('editEmployeeStatus').value = user.employeeStatus || 'Active';
            document.getElementById('editHireDate').value = user.hireDate || '';
            document.getElementById('editHourlyRate').value = user.hourlyRate || '';
            document.getElementById('editSalary').value = user.salary || '';
            document.getElementById('editColor').value = user.color || '#06b6d4';
            
            // Load photo if exists
            const photoPreview = document.getElementById('editPhotoPreview');
            const removePhotoBtn = document.getElementById('editRemovePhotoBtn');
            if (user.photoData) {
                photoPreview.innerHTML = `<img src="${user.photoData}" style="width: 100%; height: 100%; object-fit: cover;">`;
                removePhotoBtn.style.display = 'inline-block';
                editUploadedPhoto = { dataURL: user.photoData, fileName: user.photoFileName };
            } else {
                photoPreview.innerHTML = '<i class="fas fa-user" style="font-size: 2.5rem; color: var(--text-tertiary);"></i>';
                removePhotoBtn.style.display = 'none';
                editUploadedPhoto = null;
            }
            
            // Load documents if exist
            editUploadedDocuments = user.documents ? [...user.documents] : [];
            displayEditDocuments();
            
            // Populate separation fields and toggle visibility
            document.getElementById('editSeparationDate').value = user.separationDate || '';
            document.getElementById('editSeparationReason').value = user.separationReason || '';
            toggleEditSeparationFields();
            
            // Clear password fields
            document.getElementById('editPassword').value = '';
            document.getElementById('editConfirmPassword').value = '';
            
            // Clear error message
            document.getElementById('editUserError').style.display = 'none';
            
            // Show modal
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        // Close edit user modal
        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.style.display = 'none';
            }
            editingUsername = null;
        }
        
        // ========== HR INFO MODAL FUNCTIONS ==========
        
        // Open HR Info Modal
        function openHRInfoModal(username) {
            const users = loadUsers();
            const user = users[username];
            
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            
            // Set employee ID
            document.getElementById('hrEmployeeId').value = username;
            
            // Set header info
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || username;
            document.getElementById('hrEmployeeName').textContent = fullName;
            document.getElementById('hrEmployeeJobTitle').textContent = `${user.jobTitle || 'No Title'} â€¢ ${user.officeLocation || 'No Office'}`;
            
            // Set photo/initials
            const photoDiv = document.getElementById('hrEmployeePhoto');
            if (user.photo) {
                photoDiv.innerHTML = `<img src="${user.photo}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                const initials = `${(user.firstName || 'U')[0]}${(user.lastName || '')[0] || ''}`.toUpperCase();
                photoDiv.innerHTML = initials;
            }
            
            // Load HR data from user object or localStorage
            const hrData = user.hrInfo || {};
            
            // Set form values
            document.getElementById('hrEmploymentType').value = hrData.employmentType || '';
            document.getElementById('hrActiveStatus').value = hrData.activeStatus || 'Active';
            document.getElementById('hrPayType').value = hrData.payType || '';
            document.getElementById('hrSalary').value = hrData.salary || '';
            document.getElementById('hrHourlyRate').value = hrData.hourlyRate || '';
            document.getElementById('hrExpectedHours').value = hrData.expectedHours || '';
            document.getElementById('hrBenefitStartDate').value = hrData.benefitStartDate || '';
            document.getElementById('hrBenefitEndDate').value = hrData.benefitEndDate || '';
            document.getElementById('hrNotes').value = hrData.notes || '';
            
            // Set benefit checkboxes
            document.getElementById('hrBenefitHealth').checked = hrData.benefits?.health || false;
            document.getElementById('hrBenefitDental').checked = hrData.benefits?.dental || false;
            document.getElementById('hrBenefitVision').checked = hrData.benefits?.vision || false;
            document.getElementById('hrBenefit401k').checked = hrData.benefits?.retirement || false;
            document.getElementById('hrBenefitPTO').checked = hrData.benefits?.pto || false;
            document.getElementById('hrBenefitLife').checked = hrData.benefits?.life || false;
            
            // Toggle pay fields based on pay type
            toggleHRPayFields();
            
            // Show modal
            document.getElementById('hrInfoModal').style.display = 'flex';
        }
        
        // Close HR Info Modal
        function closeHRInfoModal() {
            document.getElementById('hrInfoModal').style.display = 'none';
        }
        
        // Toggle HR Pay Fields based on pay type
        function toggleHRPayFields() {
            const payType = document.getElementById('hrPayType').value;
            const salaryField = document.getElementById('hrSalaryField');
            const hourlyFields = document.getElementById('hrHourlyFields');
            
            if (payType === 'Salary') {
                if (salaryField) salaryField.style.display = 'block';
                if (hourlyFields) hourlyFields.style.display = 'none';
            } else if (payType === 'Hourly') {
                if (salaryField) salaryField.style.display = 'none';
                if (hourlyFields) hourlyFields.style.display = 'grid';
            } else {
                if (salaryField) salaryField.style.display = 'block';
                if (hourlyFields) hourlyFields.style.display = 'grid';
            }
        }
        
        // Save HR Info
        async function saveHRInfo(event) {
            event.preventDefault();
            
            const username = document.getElementById('hrEmployeeId').value;
            if (!username) {
                showNotification('No employee selected', 'error');
                return;
            }
            
            const users = loadUsers();
            const user = users[username];
            
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            
            // Gather HR data
            const hrData = {
                employmentType: document.getElementById('hrEmploymentType').value,
                activeStatus: document.getElementById('hrActiveStatus').value,
                payType: document.getElementById('hrPayType').value,
                salary: document.getElementById('hrSalary').value,
                hourlyRate: document.getElementById('hrHourlyRate').value,
                expectedHours: document.getElementById('hrExpectedHours').value,
                benefitStartDate: document.getElementById('hrBenefitStartDate').value,
                benefitEndDate: document.getElementById('hrBenefitEndDate').value,
                notes: document.getElementById('hrNotes').value,
                benefits: {
                    health: document.getElementById('hrBenefitHealth').checked,
                    dental: document.getElementById('hrBenefitDental').checked,
                    vision: document.getElementById('hrBenefitVision').checked,
                    retirement: document.getElementById('hrBenefit401k').checked,
                    pto: document.getElementById('hrBenefitPTO').checked,
                    life: document.getElementById('hrBenefitLife').checked
                },
                lastUpdated: new Date().toISOString()
            };
            
            // Save HR data to user object
            user.hrInfo = hrData;
            users[username] = user;
            saveUsers(users);
            
            showNotification('HR information saved successfully!', 'success');
            closeHRInfoModal();
            
            // Refresh user list if on users page
            if (typeof loadUsersData === 'function') {
                loadUsersData();
            }
        }
        
        // ========== END HR INFO MODAL FUNCTIONS ==========

        // Save edited user
        function saveEditedUser(event) {
            event.preventDefault();
            
            const errorDiv = document.getElementById('editUserError');
            
            if (!editingUsername) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'No user selected for editing.';
                return;
            }
            
            const users = loadUsers();
            const user = users[editingUsername];
            
            if (!user) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'User not found.';
                return;
            }
            
            // Get form values
            const newPassword = document.getElementById('editPassword').value;
            const confirmPassword = document.getElementById('editConfirmPassword').value;
            
            // Validate password if provided
            if (newPassword) {
                if (newPassword.length < 4) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Password must be at least 4 characters.';
                    return;
                }
                if (newPassword !== confirmPassword) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Passwords do not match.';
                    return;
                }
                user.password = newPassword;
            }
            
            // Update user fields
            user.role = document.getElementById('editUserRole').value;
            
            // Handle title - check if custom title
            let editTitle = document.getElementById('editTitle').value;
            if (editTitle === 'Other') {
                editTitle = document.getElementById('editCustomTitle').value.trim();
            }
            user.title = editTitle;
            
            user.firstName = document.getElementById('editFirstName').value.trim();
            user.middleName = document.getElementById('editMiddleName').value.trim();
            user.lastName = document.getElementById('editLastName').value.trim();
            user.name = [user.firstName, user.middleName, user.lastName].filter(Boolean).join(' ');
            user.gender = document.getElementById('editGender').value;
            user.dateOfBirth = document.getElementById('editDateOfBirth').value;
            user.personalEmail = document.getElementById('editPersonalEmail').value.trim();
            user.workEmail = document.getElementById('editWorkEmail').value.trim();
            user.homePhone = document.getElementById('editHomePhone').value.trim();
            user.cellPhone = document.getElementById('editCellPhone').value.trim();
            user.address = document.getElementById('editAddress').value.trim();
            user.city = document.getElementById('editCity').value.trim();
            user.state = document.getElementById('editState').value.trim();
            user.zipCode = document.getElementById('editZipCode').value.trim();
            user.jobTitle = document.getElementById('editJobTitle').value.trim();
            user.staffType = document.getElementById('editStaffType').value;
            user.employeeType = document.getElementById('editEmployeeType').value;
            user.department = document.getElementById('editDepartment').value.trim();
            user.employeeStatus = document.getElementById('editEmployeeStatus').value;
            user.hireDate = document.getElementById('editHireDate').value;
            user.hourlyRate = document.getElementById('editHourlyRate').value ? parseFloat(document.getElementById('editHourlyRate').value) : null;
            user.salary = document.getElementById('editSalary').value ? parseFloat(document.getElementById('editSalary').value) : null;
            user.color = document.getElementById('editColor').value;
            user.modifiedDate = new Date().toISOString();
            
            // Save separation fields (only if status is not Active)
            if (user.employeeStatus !== 'Active') {
                user.separationDate = document.getElementById('editSeparationDate').value;
                user.separationReason = document.getElementById('editSeparationReason').value.trim();
            } else {
                user.separationDate = null;
                user.separationReason = null;
            }
            
            // Save photo and documents
            user.photoData = editUploadedPhoto ? editUploadedPhoto.dataURL : null;
            user.photoFileName = editUploadedPhoto ? editUploadedPhoto.fileName : null;
            user.documents = editUploadedDocuments.length > 0 ? editUploadedDocuments : [];
            
            // Save users to localStorage
            saveUsers(users);
            
            // Also update in database if user has an ID
            if (user.id && typeof updateUserViaAPI === 'function') {
                updateUserViaAPI(user.id, user);
            }
            
            // Close modal and refresh list
            closeEditUserModal();
            displayUsersList();
            
            if (typeof showNotification === 'function') {
                showNotification('User updated successfully!', 'success');
            }
        }

        // ============ ROOMS MANAGEMENT ============
        
        // Load rooms from localStorage
        function loadRooms() {
            const rooms = localStorage.getItem('rooms');
            return rooms ? JSON.parse(rooms) : [];
        }

        // Save rooms to localStorage and sync to API
        function saveRooms(rooms, newItem = null) {
            localStorage.setItem('rooms', JSON.stringify(rooms));
            // Sync new item to API if provided
            if (newItem && typeof saveRoomToAPI === 'function') {
                saveRoomToAPI(newItem);
            }
        }

        // ============ RESET DATA FUNCTIONS ============
        
        // Open reset data modal
        function openResetDataModal() {
            const modal = document.getElementById('resetDataModal');
            if (modal) {
                modal.style.display = 'flex';
                // Uncheck all checkboxes
                document.getElementById('resetRooms').checked = false;
                document.getElementById('resetUsers').checked = false;
                document.getElementById('resetSchedules').checked = false;
                document.getElementById('resetStickyNotes').checked = false;
                document.getElementById('resetVendors').checked = false;
                document.getElementById('resetAll').checked = false;
            }
        }
        
        // Close reset data modal
        function closeResetDataModal() {
            const modal = document.getElementById('resetDataModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Toggle all checkboxes when "Reset All" is checked
        function toggleResetAll() {
            const resetAll = document.getElementById('resetAll').checked;
            document.getElementById('resetRooms').checked = resetAll;
            document.getElementById('resetUsers').checked = resetAll;
            document.getElementById('resetSchedules').checked = resetAll;
            document.getElementById('resetStickyNotes').checked = resetAll;
            document.getElementById('resetVendors').checked = resetAll;
        }
        
        // Execute the data reset
        function executeResetData() {
            const resetClinics = document.getElementById('resetClinics').checked;
            const resetRooms = document.getElementById('resetRooms').checked;
            const resetUsers = document.getElementById('resetUsers').checked;
            const resetSchedules = document.getElementById('resetSchedules').checked;
            const resetStickyNotes = document.getElementById('resetStickyNotes').checked;
            const resetVendors = document.getElementById('resetVendors').checked;
            const resetAll = document.getElementById('resetAll').checked;
            
            // Check if at least one option is selected
            if (!resetClinics && !resetRooms && !resetUsers && !resetSchedules && !resetStickyNotes && !resetVendors && !resetAll) {
                alert('Please select at least one data type to reset.');
                return;
            }
            
            // Confirm action
            const selectedItems = [];
            if (resetClinics) selectedItems.push('Clinics');
            if (resetRooms) selectedItems.push('Rooms');
            if (resetUsers) selectedItems.push('Users');
            if (resetSchedules) selectedItems.push('Schedules, Events & Tasks');
            if (resetStickyNotes) selectedItems.push('Sticky Notes');
            if (resetVendors) selectedItems.push('Vendors');
            
            const confirmMsg = resetAll 
                ? 'Are you sure you want to reset ALL application data? This will clear everything except your login credentials.'
                : `Are you sure you want to reset the following data?\n\nâ€¢ ${selectedItems.join('\nâ€¢ ')}\n\nThis action cannot be undone.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Perform the reset
            let resetCount = 0;
            
            if (resetAll) {
                // Keep only essential data
                const currentUser = localStorage.getItem('currentUser');
                const theme = localStorage.getItem('theme');
                const accent = localStorage.getItem('accent');
                
                // Get admin user to preserve
                const users = loadUsers();
                const adminUser = users['admin'];
                
                localStorage.clear();
                
                // Restore essentials
                if (currentUser) localStorage.setItem('currentUser', currentUser);
                if (theme) localStorage.setItem('theme', theme);
                if (accent) localStorage.setItem('accent', accent);
                
                // Restore admin user
                if (adminUser) {
                    saveUsers({ admin: adminUser });
                }
                
                resetCount = 5;
            } else {
                if (resetClinics) {
                    localStorage.removeItem('clinics');
                    masterData.clinics = [];
                    resetCount++;
                }
                if (resetRooms) {
                    localStorage.removeItem('rooms');
                    masterData.rooms = [];
                    resetCount++;
                }
                if (resetUsers) {
                    // Keep admin user
                    const users = loadUsers();
                    const adminUser = users['admin'];
                    if (adminUser) {
                        saveUsers({ admin: adminUser });
                    } else {
                        localStorage.removeItem('appUsers');
                    }
                    employeeResources = [];
                    resetCount++;
                }
                if (resetSchedules) {
                    localStorage.removeItem('scheduleShifts');
                    localStorage.removeItem('tableBuilderRows');
                    localStorage.removeItem('sbGameData');
                    localStorage.removeItem('scheduleData');
                    localStorage.removeItem('employeeSchedules');
                    localStorage.removeItem('calendarEvents');
                    localStorage.removeItem('employeeTasks');
                    localStorage.removeItem('employeeDuties');
                    eventDatabase = [];
                    employeeTasksDatabase = [];
                    employeeDutiesDatabase = [];
                    resetCount++;
                }
                if (resetStickyNotes) {
                    localStorage.removeItem('stickyNotes');
                    localStorage.removeItem('deletedStickyNotes');
                    resetCount++;
                }
                if (resetVendors) {
                    localStorage.removeItem('vendors');
                    resetCount++;
                }
            }
            
            // Close modal and show success
            closeResetDataModal();
            
            if (typeof showNotification === 'function') {
                showNotification(`Successfully reset ${resetCount} data type(s). Refreshing page...`, 'success');
            } else {
                alert(`Successfully reset ${resetCount} data type(s). The page will now refresh.`);
            }
            
            // Refresh page after short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        }
        
        // ============ PERMISSION MANAGEMENT ============
        
        let selectedPermissionUser = null;
        let tempPermissions = null;
        
        // Open permission management modal
        function openPermissionsManagement() {
            const modal = document.getElementById('permissionManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                selectedPermissionUser = null;
                tempPermissions = null;
                renderPermissionUsersList();
                showNoUserSelected();
            }
        }
        
        // Close permission management modal
        function closePermissionsManagement() {
            const modal = document.getElementById('permissionManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            selectedPermissionUser = null;
            tempPermissions = null;
        }
        
        // Render the list of users in the permission management panel
        function renderPermissionUsersList(filter = '') {
            const container = document.getElementById('permissionUsersList');
            if (!container) return;
            
            const users = loadUsers();
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Filter out admin from being edited (admin always has full permissions)
            const editableUsers = Object.entries(users).filter(([username, user]) => {
                if (username === 'admin') return false;
                if (filter) {
                    const searchStr = `${user.firstName || ''} ${user.lastName || ''} ${username}`.toLowerCase();
                    return searchStr.includes(filter.toLowerCase());
                }
                return true;
            });
            
            if (editableUsers.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-users-slash" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                        <p style="margin: 0;">${filter ? 'No users match your search' : 'No users to manage'}</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">Create users first in User Management</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = editableUsers.map(([username, user]) => {
                const initials = ((user.firstName || '?')[0] + (user.lastName || '?')[0]).toUpperCase();
                const displayName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || username;
                const roleColor = user.role === 'admin' ? '#ef4444' : user.role === 'manager' ? '#f59e0b' : '#10b981';
                const isSelected = selectedPermissionUser === username;
                
                return `
                    <div onclick="selectPermissionUser('${username}')" style="padding: 0.75rem; margin: 0.25rem 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; background: ${isSelected ? 'var(--accent-primary)' : 'var(--card-bg)'}; color: ${isSelected ? 'white' : 'var(--text-primary)'}; transition: all 0.2s;" onmouseover="if(!${isSelected}) this.style.background='var(--bg-primary)'" onmouseout="if(!${isSelected}) this.style.background='var(--card-bg)'">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, ${roleColor}, ${roleColor}dd); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85rem;">${initials}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayName}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; text-transform: capitalize;">${user.role || 'user'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter users in permission management
        function filterPermissionUsers(filter) {
            renderPermissionUsersList(filter);
        }
        
        // Show "no user selected" message
        function showNoUserSelected() {
            document.getElementById('noUserSelectedMessage').style.display = 'flex';
            document.getElementById('permissionEditorPanel').style.display = 'none';
        }
        
        // Select a user to edit permissions
        function selectPermissionUser(username) {
            const users = loadUsers();
            const user = users[username];
            
            if (!user) return;
            
            selectedPermissionUser = username;
            
            // Initialize temp permissions from user's current permissions or defaults
            tempPermissions = JSON.parse(JSON.stringify(user.permissions || getDefaultPermissions(user.role)));
            
            // Update UI
            renderPermissionUsersList(document.getElementById('permUserSearch')?.value || '');
            
            // Show editor panel
            document.getElementById('noUserSelectedMessage').style.display = 'none';
            document.getElementById('permissionEditorPanel').style.display = 'flex';
            
            // Update selected user info
            const initials = ((user.firstName || '?')[0] + (user.lastName || '?')[0]).toUpperCase();
            const displayName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || username;
            
            document.getElementById('selectedUserAvatar').textContent = initials;
            document.getElementById('selectedUserName').textContent = displayName;
            document.getElementById('selectedUserRole').innerHTML = `<span style="display: inline-block; padding: 0.15rem 0.5rem; background: ${user.role === 'admin' ? '#fee2e2' : user.role === 'manager' ? '#fef3c7' : '#d1fae5'}; color: ${user.role === 'admin' ? '#dc2626' : user.role === 'manager' ? '#d97706' : '#059669'}; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${user.role || 'user'}</span> â€¢ @${username}`;
            
            // Render permission categories
            renderPermissionCategories();
        }
        
        // Render permission categories and their individual permissions
        function renderPermissionCategories() {
            const container = document.getElementById('permissionCategoriesContainer');
            if (!container || !tempPermissions) return;
            
            container.innerHTML = Object.entries(PERMISSION_CATEGORIES).map(([categoryKey, category]) => {
                const categoryPerms = tempPermissions[categoryKey] || {};
                
                return `
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1rem; overflow: hidden;">
                        <div style="padding: 1rem 1.25rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; border-radius: 8px; background: ${category.color}20; display: flex; align-items: center; justify-content: center;">
                                    <i class="${category.icon}" style="color: ${category.color}; font-size: 1rem;"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: var(--text-primary); font-size: 1rem;">${category.label}</h4>
                                    <p style="margin: 0; font-size: 0.75rem; color: var(--text-secondary);">${Object.keys(category.permissions).length} permissions</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="setCategoryAccess('${categoryKey}', 'full')" style="padding: 0.35rem 0.75rem; background: ${Object.values(categoryPerms).every(v => v === 'full') ? '#10b981' : 'transparent'}; color: ${Object.values(categoryPerms).every(v => v === 'full') ? 'white' : 'var(--text-secondary)'}; border: 1px solid ${Object.values(categoryPerms).every(v => v === 'full') ? '#10b981' : 'var(--border-color)'}; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">All Full</button>
                                <button onclick="setCategoryAccess('${categoryKey}', 'readonly')" style="padding: 0.35rem 0.75rem; background: ${Object.values(categoryPerms).every(v => v === 'readonly') ? '#f59e0b' : 'transparent'}; color: ${Object.values(categoryPerms).every(v => v === 'readonly') ? 'white' : 'var(--text-secondary)'}; border: 1px solid ${Object.values(categoryPerms).every(v => v === 'readonly') ? '#f59e0b' : 'var(--border-color)'}; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">All Read</button>
                                <button onclick="setCategoryAccess('${categoryKey}', 'hidden')" style="padding: 0.35rem 0.75rem; background: ${Object.values(categoryPerms).every(v => v === 'hidden') ? '#6b7280' : 'transparent'}; color: ${Object.values(categoryPerms).every(v => v === 'hidden') ? 'white' : 'var(--text-secondary)'}; border: 1px solid ${Object.values(categoryPerms).every(v => v === 'hidden') ? '#6b7280' : 'var(--border-color)'}; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">All Hidden</button>
                            </div>
                        </div>
                        <div style="padding: 1rem;">
                            ${Object.entries(category.permissions).map(([permKey, permData]) => {
                                const currentLevel = categoryPerms[permKey] || 'hidden';
                                const permLabel = typeof permData === 'object' ? permData.label : permData;
                                return `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem; background: var(--bg-secondary);">
                                        <div>
                                            <span style="color: var(--text-primary); font-weight: 500;">${permLabel}</span>
                                        </div>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button onclick="setPermissionLevel('${categoryKey}', '${permKey}', 'full')" style="padding: 0.4rem 0.75rem; background: ${currentLevel === 'full' ? '#10b981' : 'var(--card-bg)'}; color: ${currentLevel === 'full' ? 'white' : 'var(--text-secondary)'}; border: 1px solid ${currentLevel === 'full' ? '#10b981' : 'var(--border-color)'}; border-radius: 6px 0 0 6px; cursor: pointer; font-size: 0.8rem;">
                                                <i class="fas fa-check"></i> Full
                                            </button>
                                            <button onclick="setPermissionLevel('${categoryKey}', '${permKey}', 'readonly')" style="padding: 0.4rem 0.75rem; background: ${currentLevel === 'readonly' ? '#f59e0b' : 'var(--card-bg)'}; color: ${currentLevel === 'readonly' ? 'white' : 'var(--text-secondary)'}; border: 1px solid ${currentLevel === 'readonly' ? '#f59e0b' : 'var(--border-color)'}; border-left: none; border-right: none; cursor: pointer; font-size: 0.8rem;">
                                                <i class="fas fa-eye"></i> Read
                                            </button>
                                            <button onclick="setPermissionLevel('${categoryKey}', '${permKey}', 'hidden')" style="padding: 0.4rem 0.75rem; background: ${currentLevel === 'hidden' ? '#6b7280' : 'var(--card-bg)'}; color: ${currentLevel === 'hidden' ? 'white' : 'var(--text-secondary)'}; border: 1px solid ${currentLevel === 'hidden' ? '#6b7280' : 'var(--border-color)'}; border-radius: 0 6px 6px 0; cursor: pointer; font-size: 0.8rem;">
                                                <i class="fas fa-eye-slash"></i> Hidden
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Set permission level for a specific permission
        function setPermissionLevel(category, permission, level) {
            if (!tempPermissions) return;
            
            if (!tempPermissions[category]) {
                tempPermissions[category] = {};
            }
            
            tempPermissions[category][permission] = level;
            renderPermissionCategories();
        }
        
        // Set all permissions in a category to a specific level
        function setCategoryAccess(category, level) {
            if (!tempPermissions || !PERMISSION_CATEGORIES[category]) return;
            
            if (!tempPermissions[category]) {
                tempPermissions[category] = {};
            }
            
            Object.keys(PERMISSION_CATEGORIES[category].permissions).forEach(permKey => {
                tempPermissions[category][permKey] = level;
            });
            
            renderPermissionCategories();
        }
        
        // Apply a permission preset
        function applyPermissionPreset(preset) {
            if (!tempPermissions) return;
            
            const users = loadUsers();
            const user = users[selectedPermissionUser];
            
            switch (preset) {
                case 'full':
                    // Grant full access to everything
                    tempPermissions = getDefaultPermissions('admin');
                    break;
                case 'readonly':
                    // Set everything to readonly
                    Object.keys(PERMISSION_CATEGORIES).forEach(catKey => {
                        if (!tempPermissions[catKey]) tempPermissions[catKey] = {};
                        Object.keys(PERMISSION_CATEGORIES[catKey].permissions).forEach(permKey => {
                            // View permissions get readonly, action permissions get hidden
                            if (permKey.includes('view')) {
                                tempPermissions[catKey][permKey] = 'readonly';
                            } else {
                                tempPermissions[catKey][permKey] = 'hidden';
                            }
                        });
                    });
                    break;
                case 'minimal':
                    // Set everything to hidden except basic view own
                    Object.keys(PERMISSION_CATEGORIES).forEach(catKey => {
                        if (!tempPermissions[catKey]) tempPermissions[catKey] = {};
                        Object.keys(PERMISSION_CATEGORIES[catKey].permissions).forEach(permKey => {
                            tempPermissions[catKey][permKey] = 'hidden';
                        });
                    });
                    // Give basic access
                    if (tempPermissions.schedules) {
                        tempPermissions.schedules.view_own = 'full';
                    }
                    if (tempPermissions.tasks) {
                        tempPermissions.tasks.view_own = 'full';
                    }
                    break;
            }
            
            renderPermissionCategories();
        }
        
        // Save user permissions
        function saveUserPermissions() {
            if (!selectedPermissionUser || !tempPermissions) {
                showNotification('No user selected', 'error');
                return;
            }
            
            const users = loadUsers();
            if (!users[selectedPermissionUser]) {
                showNotification('User not found', 'error');
                return;
            }
            
            // Save permissions to user
            users[selectedPermissionUser].permissions = tempPermissions;
            saveUsers(users);
            
            // Update current user if they're editing themselves
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.username === selectedPermissionUser) {
                currentUser.permissions = tempPermissions;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                // Refresh UI to reflect permission changes
                updateUIForRole();
            }
            
            showNotification(`Permissions saved for ${users[selectedPermissionUser].firstName || selectedPermissionUser}`, 'success');
        }

        // ============ ROOMS MANAGEMENT ============

        // Populate office dropdown for rooms form
        function populateRoomOfficeDropdown() {
            const offices = loadOffices();
            const dropdown = document.getElementById('newOfficeID');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">--Select Office--</option>';
                offices.forEach(office => {
                    const option = document.createElement('option');
                    option.value = office.officeID;
                    option.textContent = office.officeName;
                    dropdown.appendChild(option);
                });
            }
        }

        // Open rooms management modal
        function openRoomsManagement() {
            const modal = document.getElementById('roomsManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                populateRoomOfficeDropdown();
                displayRoomsList();
            }
        }

        // Close rooms management modal
        function closeRoomsManagement() {
            const modal = document.getElementById('roomsManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Clear form
            document.getElementById('createRoomForm').reset();
            document.getElementById('createRoomError').style.display = 'none';
        }

        // Create new room
        // Toggle custom room type input visibility
        function toggleCustomRoomType() {
            const roomTypeSelect = document.getElementById('newRoomType');
            const customContainer = document.getElementById('customRoomTypeContainer');
            const customInput = document.getElementById('newCustomRoomType');
            if (roomTypeSelect.value === 'Other') {
                customContainer.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else {
                customContainer.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Cancel custom room type and reset to dropdown
        function cancelCustomRoomType() {
            const roomTypeSelect = document.getElementById('newRoomType');
            const customContainer = document.getElementById('customRoomTypeContainer');
            const customInput = document.getElementById('newCustomRoomType');
            
            roomTypeSelect.value = '';
            customContainer.style.display = 'none';
            customInput.required = false;
            customInput.value = '';
        }
        
        function createRoom(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editRoomId').value;
            const isEdit = !!editId;
            
            const officeID = document.getElementById('newOfficeID').value;
            const roomNumber = document.getElementById('newRoomNumber').value.trim();
            const roomName = document.getElementById('newRoomName').value.trim();
            let roomType = document.getElementById('newRoomType').value;
            const customRoomType = document.getElementById('newCustomRoomType').value.trim();
            const roomCategory = document.getElementById('newRoomCategory').value;
            const dimensions = document.getElementById('newDimensions').value.trim();
            const color = document.getElementById('newRoomColor').value;
            const status = document.getElementById('newRoomStatus').value;
            const notes = document.getElementById('newRoomNotes').value.trim();
            const isActive = document.getElementById('newIsActive').checked;
            const errorDiv = document.getElementById('createRoomError');
            
            // If Other is selected, use custom type
            if (roomType === 'Other') {
                if (!customRoomType) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Please enter a custom room type.';
                    return;
                }
                roomType = customRoomType;
            }
            
            // Validate required fields
            if (!officeID || !roomNumber || !roomName || !roomType || !roomCategory || !status) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please fill in all required fields.';
                return;
            }
            
            // Load existing rooms
            const rooms = loadRooms();
            
            if (isEdit) {
                // Update existing room
                const index = rooms.findIndex(r => r.roomID === parseInt(editId));
                if (index > -1) {
                    rooms[index] = {
                        ...rooms[index],
                        officeID,
                        roomNumber,
                        roomName,
                        roomType,
                        roomCategory,
                        dimensions,
                        color,
                        status,
                        notes,
                        isActive,
                        modifiedDate: new Date().toISOString()
                    };
                    saveRooms(rooms);
                    
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d4edda';
                    errorDiv.style.borderColor = '#c3e6cb';
                    errorDiv.style.color = '#155724';
                    errorDiv.textContent = `Room "${roomName}" updated successfully!`;
                }
            } else {
                // Check if room number already exists for this office
                const roomExists = rooms.some(r => r.officeID === officeID && r.roomNumber === roomNumber);
                if (roomExists) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'A room with this number already exists in the selected office.';
                    return;
                }
                
                // Create new room object
                const newRoom = {
                    roomID: Date.now(),
                    officeID,
                    roomNumber,
                    roomName,
                    roomType,
                    roomCategory,
                    dimensions,
                    color,
                    status,
                    notes,
                    isActive,
                    createdDate: new Date().toISOString()
                };
                
                rooms.push(newRoom);
                saveRooms(rooms, {
                    name: roomName,
                    clinicId: officeID ? parseInt(officeID) : null,
                    type: roomType,
                    color: color,
                    status: status
                });
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.borderColor = '#c3e6cb';
                errorDiv.style.color = '#155724';
                errorDiv.textContent = `Room "${roomName}" created successfully!`;
            }
            
            // Reset form and hide form section
            document.getElementById('createRoomForm').reset();
            document.getElementById('editRoomId').value = '';
            document.getElementById('roomFormSection').style.display = 'none';
            
            // Refresh rooms list
            displayRoomsList();
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
            }, 3000);
        }

        // Display rooms list
        function displayRoomsList() {
            const rooms = loadRooms();
            const offices = loadOffices();
            const roomsList = document.getElementById('roomsList');
            
            if (!roomsList) return;
            
            if (rooms.length === 0) {
                roomsList.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No rooms added yet. Click "Add New Room" to get started.</td></tr>';
                return;
            }
            
            roomsList.innerHTML = rooms.map(room => {
                const office = offices.find(o => o.officeID == room.officeID);
                const officeName = office ? office.officeName : 'Unknown';
                
                return `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 24px; height: 24px; border-radius: 4px; background: ${room.color || '#06b6d4'};"></div>
                            <div>
                                <div style="font-weight: 600;">${room.roomName}</div>
                                <div style="font-size: 0.8rem; color: var(--text-tertiary);">#${room.roomNumber}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${officeName}</td>
                    <td style="padding: 1rem;">
                        <span style="background: #06b6d420; color: #06b6d4; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${room.roomType}</span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${room.roomCategory || '-'}</td>
                    <td style="padding: 1rem;">
                        <span style="color: ${room.status === 'Active' ? '#10b981' : room.status === 'Maintenance' ? '#f59e0b' : '#ef4444'};">
                            <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.5rem;"></i>${room.status}
                        </span>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="editRoom(${room.roomID})" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit Room">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteRoom(${room.roomID})" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete Room">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Open Add Room Form
        function openAddRoomForm() {
            document.getElementById('roomFormSection').style.display = 'block';
            document.getElementById('roomFormTitle').textContent = 'Add New Room';
            document.getElementById('roomSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Room';
            document.getElementById('editRoomId').value = '';
            document.getElementById('createRoomForm').reset();
            document.getElementById('newIsActive').checked = true;
            populateOfficeDropdownForRooms();
            document.getElementById('roomFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Room Form
        function closeRoomForm() {
            document.getElementById('roomFormSection').style.display = 'none';
            document.getElementById('createRoomForm').reset();
            document.getElementById('editRoomId').value = '';
        }

        // Edit Room
        function editRoom(roomID) {
            const rooms = loadRooms();
            const room = rooms.find(r => r.roomID === roomID);
            
            if (!room) return;
            
            document.getElementById('roomFormSection').style.display = 'block';
            document.getElementById('roomFormTitle').textContent = 'Edit Room';
            document.getElementById('roomSubmitBtn').innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Changes';
            
            populateOfficeDropdownForRooms();
            
            document.getElementById('editRoomId').value = room.roomID;
            document.getElementById('newOfficeID').value = room.officeID || '';
            document.getElementById('newRoomNumber').value = room.roomNumber || '';
            document.getElementById('newRoomName').value = room.roomName || '';
            document.getElementById('newRoomType').value = room.roomType || '';
            document.getElementById('newRoomCategory').value = room.roomCategory || '';
            document.getElementById('newDimensions').value = room.dimensions || '';
            document.getElementById('newRoomColor').value = room.color || '#06b6d4';
            document.getElementById('newRoomStatus').value = room.status || 'Active';
            document.getElementById('newRoomNotes').value = room.notes || '';
            document.getElementById('newIsActive').checked = room.isActive !== false;
            
            document.getElementById('roomFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete room
        function deleteRoom(roomID) {
            if (confirm('Are you sure you want to delete this room?')) {
                const rooms = loadRooms();
                const updatedRooms = rooms.filter(r => r.roomID !== roomID);
                saveRooms(updatedRooms);
                displayRoomsList();
            }
        }

        // ============ OFFICES MANAGEMENT ============
        
        // Load offices from localStorage
        function loadOffices() {
            const offices = localStorage.getItem('offices');
            return offices ? JSON.parse(offices) : [];
        }

        // Save offices (clinics) to localStorage and sync to API
        function saveOffices(offices, newItem = null) {
            localStorage.setItem('offices', JSON.stringify(offices));
            // Sync new item to API if provided
            if (newItem && typeof createClinicViaAPI === 'function') {
                createClinicViaAPI(newItem);
            }
        }

        // Open offices management modal
        function openOfficesManagement() {
            const modal = document.getElementById('officesManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                displayOfficesList();
            }
        }

        // Close offices management modal
        function closeOfficesManagement() {
            const modal = document.getElementById('officesManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Clear form
            document.getElementById('createOfficeForm').reset();
            document.getElementById('createOfficeError').style.display = 'none';
            // Reset logo
            uploadedOfficeLogo = null;
            const logoPreview = document.getElementById('officeLogoPreview');
            if (logoPreview) {
                logoPreview.innerHTML = '<i class="fas fa-building" style="font-size: 3rem; color: var(--text-tertiary);"></i>';
            }
        }

        // Create new office
        function createOffice(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editOfficeId').value;
            const isEdit = !!editId;
            
            const officeName = document.getElementById('newOfficeName').value.trim();
            const phone = document.getElementById('newOfficePhone').value.trim();
            const address = document.getElementById('newOfficeAddress').value.trim();
            const city = document.getElementById('newOfficeCity').value.trim();
            const state = document.getElementById('newOfficeState').value.trim();
            const zipCode = document.getElementById('newOfficeZipCode').value.trim();
            const email = document.getElementById('newOfficeEmail').value.trim();
            const website = document.getElementById('newOfficeWebsite').value.trim();
            const defaultDentist = document.getElementById('newDefaultDentist').value.trim();
            const color = document.getElementById('newOfficeColor').value;
            const taxonomyNumber = document.getElementById('newTaxonomyNumber').value.trim();
            const clinicNPI = document.getElementById('newClinicNPI').value.trim();
            const clinicTIN = document.getElementById('newClinicTIN').value.trim();
            const legalName = document.getElementById('newLegalName').value.trim();
            const legalAddress = document.getElementById('newLegalAddress').value.trim();
            const status = document.getElementById('newOfficeStatus').value;
            const description = document.getElementById('newOfficeDescription').value.trim();
            const isActive = document.getElementById('newOfficeIsActive').checked;
            const errorDiv = document.getElementById('createOfficeError');
            
            // Collect operating hours
            const operatingHours = {
                monday: {
                    isOpen: document.getElementById('dayMonday').checked,
                    open: document.getElementById('mondayOpen').value,
                    close: document.getElementById('mondayClose').value
                },
                tuesday: {
                    isOpen: document.getElementById('dayTuesday').checked,
                    open: document.getElementById('tuesdayOpen').value,
                    close: document.getElementById('tuesdayClose').value
                },
                wednesday: {
                    isOpen: document.getElementById('dayWednesday').checked,
                    open: document.getElementById('wednesdayOpen').value,
                    close: document.getElementById('wednesdayClose').value
                },
                thursday: {
                    isOpen: document.getElementById('dayThursday').checked,
                    open: document.getElementById('thursdayOpen').value,
                    close: document.getElementById('thursdayClose').value
                },
                friday: {
                    isOpen: document.getElementById('dayFriday').checked,
                    open: document.getElementById('fridayOpen').value,
                    close: document.getElementById('fridayClose').value
                },
                saturday: {
                    isOpen: document.getElementById('daySaturday').checked,
                    open: document.getElementById('saturdayOpen').value,
                    close: document.getElementById('saturdayClose').value
                },
                sunday: {
                    isOpen: document.getElementById('daySunday').checked,
                    open: document.getElementById('sundayOpen').value,
                    close: document.getElementById('sundayClose').value
                }
            };
            
            // Validate required fields
            if (!officeName || !status) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please fill in all required fields.';
                return;
            }
            
            // Load existing offices
            const offices = loadOffices();
            
            if (isEdit) {
                // Update existing office
                const index = offices.findIndex(o => o.officeID === parseInt(editId));
                if (index > -1) {
                    offices[index] = {
                        ...offices[index],
                        officeName,
                        logo: uploadedOfficeLogo,
                        phone,
                        address,
                        city,
                        state,
                        zipCode,
                        email,
                        website,
                        defaultDentist,
                        color,
                        taxonomyNumber,
                        clinicNPI,
                        clinicTIN,
                        legalName,
                        legalAddress,
                        status,
                        operatingHours,
                        description,
                        isActive,
                        modifiedDate: new Date().toISOString()
                    };
                    saveOffices(offices);
                    
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d4edda';
                    errorDiv.style.borderColor = '#c3e6cb';
                    errorDiv.style.color = '#155724';
                    errorDiv.textContent = `Office "${officeName}" updated successfully!`;
                }
            } else {
                // Check if office name already exists
                const officeExists = offices.some(o => o.officeName.toLowerCase() === officeName.toLowerCase());
                if (officeExists) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'An office with this name already exists.';
                    return;
                }
                
                // Create new office object
                const newOffice = {
                    officeID: Date.now(),
                    officeName,
                    logo: uploadedOfficeLogo,
                    phone,
                    address,
                    city,
                    state,
                    zipCode,
                    email,
                    website,
                    defaultDentist,
                    color,
                    taxonomyNumber,
                    clinicNPI,
                    clinicTIN,
                    legalName,
                    legalAddress,
                    status,
                    operatingHours,
                    description,
                    isActive,
                    createdDate: new Date().toISOString(),
                    modifiedDate: new Date().toISOString()
                };
                
                offices.push(newOffice);
                saveOffices(offices, {
                    name: officeName,
                    address,
                    city,
                    state,
                    phone,
                    email
                });
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.borderColor = '#c3e6cb';
                errorDiv.style.color = '#155724';
                errorDiv.textContent = `Office "${officeName}" created successfully!`;
            }
            
            // Reset form and hide form section
            document.getElementById('createOfficeForm').reset();
            document.getElementById('editOfficeId').value = '';
            document.getElementById('officeFormSection').style.display = 'none';
            
            // Reset logo
            uploadedOfficeLogo = null;
            const logoPreview = document.getElementById('officeLogoPreview');
            if (logoPreview) {
                logoPreview.innerHTML = '<i class="fas fa-building" style="font-size: 3rem; color: var(--text-tertiary);"></i>';
            }
            
            // Refresh offices list
            displayOfficesList();
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
            }, 3000);
        }

        // Display offices list
        function displayOfficesList() {
            const offices = loadOffices();
            const officesList = document.getElementById('officesList');
            
            if (!officesList) return;
            
            if (offices.length === 0) {
                officesList.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No offices added yet. Click "Add New Office" to get started.</td></tr>';
                return;
            }
            
            officesList.innerHTML = offices.map(office => {
                const address = [office.address, office.city, office.state, office.zipCode].filter(Boolean).join(', ');
                
                return `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            ${office.logo ? `<div style="width: 40px; height: 40px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border-color); background: white;"><img src="${office.logo.dataUrl}" style="width: 100%; height: 100%; object-fit: contain;"></div>` : `<div style="width: 40px; height: 40px; border-radius: 6px; background: ${office.color || 'var(--accent-primary)'}; display: flex; align-items: center; justify-content: center;"><i class="fas fa-building" style="color: white;"></i></div>`}
                            <div>
                                <div style="font-weight: 600;">${office.officeName}</div>
                                ${office.email ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">${office.email}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${office.phone || '-'}</td>
                    <td style="padding: 1rem; color: var(--text-secondary); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${address || '-'}</td>
                    <td style="padding: 1rem;">
                        <span style="background: ${office.isActive !== false ? '#10b98120' : '#ef444420'}; color: ${office.isActive !== false ? '#10b981' : '#ef4444'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${office.status || (office.isActive !== false ? 'Active' : 'Inactive')}</span>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="editOffice(${office.officeID})" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit Office">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteOffice(${office.officeID})" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete Office">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Open Add Office Form
        function openAddOfficeForm() {
            document.getElementById('officeFormSection').style.display = 'block';
            document.getElementById('officeFormTitle').textContent = 'Add New Office';
            document.getElementById('officeSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Office';
            document.getElementById('editOfficeId').value = '';
            document.getElementById('createOfficeForm').reset();
            document.getElementById('newOfficeIsActive').checked = true;
            // Reset logo preview
            const logoPreview = document.getElementById('officeLogoPreview');
            if (logoPreview) {
                logoPreview.innerHTML = '<i class="fas fa-building" style="font-size: 3rem; color: var(--text-tertiary);"></i>';
            }
            uploadedOfficeLogo = null;
            document.getElementById('officeFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Office Form
        function closeOfficeForm() {
            document.getElementById('officeFormSection').style.display = 'none';
            document.getElementById('createOfficeForm').reset();
            document.getElementById('editOfficeId').value = '';
        }

        // Edit Office
        function editOffice(officeID) {
            const offices = loadOffices();
            const office = offices.find(o => o.officeID === officeID);
            
            if (!office) return;
            
            // Show the form section
            document.getElementById('officeFormSection').style.display = 'block';
            document.getElementById('officeFormTitle').textContent = 'Edit Office';
            document.getElementById('officeSubmitBtn').innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Changes';
            document.getElementById('editOfficeId').value = office.officeID;
            
            // Populate form fields
            document.getElementById('newOfficeName').value = office.officeName || '';
            document.getElementById('newOfficePhone').value = office.phone || '';
            document.getElementById('newOfficeAddress').value = office.address || '';
            document.getElementById('newOfficeCity').value = office.city || '';
            document.getElementById('newOfficeState').value = office.state || '';
            document.getElementById('newOfficeZipCode').value = office.zipCode || '';
            document.getElementById('newOfficeEmail').value = office.email || '';
            document.getElementById('newOfficeWebsite').value = office.website || '';
            document.getElementById('newDefaultDentist').value = office.defaultDentist || '';
            document.getElementById('newOfficeColor').value = office.color || '#06b6d4';
            document.getElementById('newTaxonomyNumber').value = office.taxonomyNumber || '';
            document.getElementById('newClinicNPI').value = office.clinicNPI || '';
            document.getElementById('newClinicTIN').value = office.clinicTIN || '';
            document.getElementById('newLegalName').value = office.legalName || '';
            document.getElementById('newLegalAddress').value = office.legalAddress || '';
            document.getElementById('newOfficeStatus').value = office.status || 'Active';
            document.getElementById('newOfficeDescription').value = office.description || '';
            document.getElementById('newOfficeIsActive').checked = office.isActive !== false;
            
            // Load logo if exists
            const logoPreview = document.getElementById('officeLogoPreview');
            if (office.logo && office.logo.dataUrl) {
                logoPreview.innerHTML = `<img src="${office.logo.dataUrl}" style="width: 100%; height: 100%; object-fit: contain;">`;
                uploadedOfficeLogo = office.logo;
            } else {
                logoPreview.innerHTML = '<i class="fas fa-building" style="font-size: 3rem; color: var(--text-tertiary);"></i>';
                uploadedOfficeLogo = null;
            }
            
            // Load operating hours if exists
            if (office.operatingHours) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(day => {
                    const dayData = office.operatingHours[day];
                    const checkbox = document.getElementById('day' + day.charAt(0).toUpperCase() + day.slice(1));
                    const openInput = document.getElementById(day + 'Open');
                    const closeInput = document.getElementById(day + 'Close');
                    if (checkbox && dayData) {
                        checkbox.checked = dayData.isOpen;
                        if (openInput) openInput.value = dayData.open || '';
                        if (closeInput) closeInput.value = dayData.close || '';
                    }
                });
            }
            
            document.getElementById('officeFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete office
        function deleteOffice(officeID) {
            if (confirm('Are you sure you want to delete this office?')) {
                const offices = loadOffices();
                const updatedOffices = offices.filter(o => o.officeID !== officeID);
                saveOffices(updatedOffices);
                displayOfficesList();
            }
        }

        // ============ VENDORS MANAGEMENT ============
        
        // Toggle custom vendor type input
        function toggleCustomVendorType() {
            const vendorTypeSelect = document.getElementById('newVendorType');
            const customBox = document.getElementById('customVendorTypeBox');
            const customInput = document.getElementById('customVendorType');
            
            if (vendorTypeSelect.value === 'Other') {
                customBox.style.display = 'block';
                customInput.focus();
            } else {
                customBox.style.display = 'none';
                customInput.value = '';
            }
        }
        
        // Cancel custom vendor type
        function cancelCustomVendorType() {
            const vendorTypeSelect = document.getElementById('newVendorType');
            const customBox = document.getElementById('customVendorTypeBox');
            const customInput = document.getElementById('customVendorType');
            
            vendorTypeSelect.value = '';
            customBox.style.display = 'none';
            customInput.value = '';
        }
        
        // Load vendors from localStorage
        function loadVendors() {
            const vendors = localStorage.getItem('vendors');
            return vendors ? JSON.parse(vendors) : [];
        }

        // Save vendors to localStorage
        function saveVendors(vendors) {
            localStorage.setItem('vendors', JSON.stringify(vendors));
        }

        // Auto-refresh interval for vendors
        let vendorsAutoRefreshInterval = null;

        // Open vendors management modal - NOW SYNCS FROM API
        async function openVendorsManagement() {
            console.log('openVendorsManagement called');
            const modal = document.getElementById('vendorsManagementModal');
            console.log('Vendors modal element:', modal);
            if (modal) {
                modal.style.display = 'flex';
                // Sync vendors from API first to get latest data
                await syncVendorsFromAPI();
                displayVendorsList();
                
                // Start auto-refresh every 30 seconds
                if (vendorsAutoRefreshInterval) clearInterval(vendorsAutoRefreshInterval);
                vendorsAutoRefreshInterval = setInterval(async () => {
                    console.log('ðŸ”„ Auto-refreshing vendors...');
                    await syncVendorsFromAPI();
                    displayVendorsList();
                }, 30000);
            } else {
                alert('Vendors modal not found!');
            }
        }

        // Refresh vendors from API (manual refresh button)
        async function refreshVendorsFromAPI() {
            const refreshBtn = event.target.closest('button');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            refreshBtn.disabled = true;
            
            try {
                await syncVendorsFromAPI();
                displayVendorsList();
                refreshBtn.innerHTML = '<i class="fas fa-check"></i> Synced!';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                    refreshBtn.disabled = false;
                }, 1500);
            } catch (error) {
                console.error('Error refreshing vendors:', error);
                refreshBtn.innerHTML = '<i class="fas fa-times"></i> Error';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                    refreshBtn.disabled = false;
                }, 1500);
            }
        }

        // Open schedule manager modal
        function openScheduleManager() {
            // Remove existing modal if any
            let existingModal = document.getElementById('scheduleManagerModalDynamic');
            if (existingModal) existingModal.remove();
            
            // Create modal dynamically
            const modal = document.createElement('div');
            modal.id = 'scheduleManagerModalDynamic';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdfa 100%); z-index: 999999; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="background: white; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); padding: 2.5rem; border-radius: 16px; color: #1e293b; text-align: center; max-width: 650px; border: 1px solid #e2e8f0;">
                    <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #0891b2, #0e7490); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                        <i class="fas fa-calendar-check" style="font-size: 1.8rem; color: white;"></i>
                    </div>
                    <h2 style="color: #0f172a; margin-bottom: 0.5rem; font-size: 1.6rem;">Schedule Builder</h2>
                    <p style="margin-bottom: 1.5rem; color: #64748b; line-height: 1.6; font-size: 0.95rem;">Choose your preferred method to create schedules.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- Table/Excel Mode -->
                        <div onclick="openTableScheduleBuilder()" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; text-align: center;" onmouseover="this.style.borderColor='#10b981'; this.style.background='#f0fdf4';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';">
                            <div style="width: 50px; height: 50px; background: #dcfce7; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <i class="fas fa-table" style="font-size: 1.5rem; color: #16a34a;"></i>
                            </div>
                            <h3 style="color: #0f172a; font-size: 1rem; margin-bottom: 0.5rem;">Table Builder</h3>
                            <p style="color: #64748b; font-size: 0.8rem; line-height: 1.4;">Excel-style interface. Create multiple schedules at once in a spreadsheet view.</p>
                            <div style="margin-top: 0.75rem; padding: 0.4rem 0.8rem; background: #dcfce7; color: #166534; border-radius: 20px; font-size: 0.7rem; font-weight: 600; display: inline-block;">
                                <i class="fas fa-bolt" style="margin-right: 0.3rem;"></i> Bulk Entry
                            </div>
                        </div>
                        
                        <!-- Step-by-Step Mode -->
                        <div onclick="openStepByStepBuilder()" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s; text-align: center;" onmouseover="this.style.borderColor='#0891b2'; this.style.background='#f0fdfa';" onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';">
                            <div style="width: 50px; height: 50px; background: #cffafe; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <i class="fas fa-project-diagram" style="font-size: 1.5rem; color: #0891b2;"></i>
                            </div>
                            <h3 style="color: #0f172a; font-size: 1rem; margin-bottom: 0.5rem;">Relational Builder</h3>
                            <p style="color: #64748b; font-size: 0.8rem; line-height: 1.4;">Visual step-by-step wizard. See conflicts and relationships clearly.</p>
                            <div style="margin-top: 0.75rem; padding: 0.4rem 0.8rem; background: #cffafe; color: #155e75; border-radius: 20px; font-size: 0.7rem; font-weight: 600; display: inline-block;">
                                <i class="fas fa-magic" style="margin-right: 0.3rem;"></i> Guided
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeScheduleManagerDynamic()" style="background: white; color: #64748b; border: 2px solid #e2e8f0; padding: 0.75rem 1.5rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-times" style="margin-right: 0.5rem;"></i> Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Open Step-by-Step Builder (existing relational builder)
        function openStepByStepBuilder() {
            const modal = document.getElementById('scheduleManagerModalDynamic');
            if (modal) {
                modal.innerHTML = `
                    <div style="background: white; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); padding: 2.5rem; border-radius: 16px; color: #1e293b; text-align: center; max-width: 550px; border: 1px solid #e2e8f0;">
                        <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #0891b2, #0e7490); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                            <i class="fas fa-project-diagram" style="font-size: 1.8rem; color: white;"></i>
                        </div>
                        <h2 style="color: #0f172a; margin-bottom: 0.5rem; font-size: 1.6rem;">Relational Builder</h2>
                        <p style="margin-bottom: 1.5rem; color: #64748b; line-height: 1.6; font-size: 0.95rem;">Build schedules step-by-step with visual conflict detection.</p>
                        
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <p style="margin-bottom: 1rem; font-weight: 600; color: #475569; font-size: 0.9rem;"><i class="fas fa-hand-pointer" style="color: #0891b2; margin-right: 0.5rem;"></i> Select scheduling mode:</p>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button id="sbModeProvider" onclick="sbSelectMode('provider')" style="flex: 1; background: #0891b2; color: white; border: 2px solid #0891b2; padding: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-user-md" style="font-size: 1.8rem; display: block; margin-bottom: 0.5rem;"></i>
                                    <strong style="font-size: 0.95rem;">Provider First</strong>
                                </button>
                                <button id="sbModeEmployee" onclick="sbSelectMode('employee')" style="flex: 1; background: white; color: #64748b; border: 2px solid #e2e8f0; padding: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                                    <i class="fas fa-user-nurse" style="font-size: 1.8rem; display: block; margin-bottom: 0.5rem;"></i>
                                    <strong style="font-size: 0.95rem;">Employee First</strong>
                                </button>
                            </div>
                        </div>
                        
                        <div id="sbModeSteps" style="font-size: 0.8rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: #f0fdfa; border: 1px solid #99f6e4; border-radius: 8px; color: #0f766e;">
                            <i class="fas fa-route" style="margin-right: 0.5rem;"></i>
                            <strong>Workflow:</strong> Provider â†’ Clinic â†’ Room â†’ Assistant(s) â†’ Dates â†’ Time
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="startScheduleBuilderGame()" style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; border: none; padding: 0.9rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(8,145,178,0.3);">
                                <i class="fas fa-play" style="margin-right: 0.5rem;"></i> Start Building
                            </button>
                            <button onclick="openScheduleManager()" style="background: white; color: #64748b; border: 2px solid #e2e8f0; padding: 0.9rem 1.5rem; font-size: 1rem; font-weight: 600; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i> Back
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // =====================================================
        // TABLE-BASED SCHEDULE BUILDER (Excel/Access Style)
        // =====================================================
        
        let tableBuilderRows = [];
        let tableBuilderNextId = 1;
        
        function openTableScheduleBuilder() {
            const modal = document.getElementById('scheduleManagerModalDynamic');
            if (!modal) return;
            
            // Get data from masterData
            const providers = window.masterData ? window.masterData.getProviders() : [];
            const assistants = window.masterData ? window.masterData.getAssistants() : [];
            const clinics = window.masterData ? window.masterData.clinics : [];
            const rooms = window.masterData ? window.masterData.rooms : [];
            const timeSlots = window.masterData ? window.masterData.timeSlots : [];
            
            // Initialize with one empty row
            tableBuilderRows = [createEmptyRow()];
            
            modal.style.background = '#f1f5f9';
            modal.innerHTML = `
                <style>
                    .tsb-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; }
                    .tsb-header { background: white; border-bottom: 1px solid #e2e8f0; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
                    .tsb-title { font-size: 1.2rem; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 0.75rem; }
                    .tsb-actions { display: flex; gap: 0.75rem; }
                    .tsb-btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
                    .tsb-btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; }
                    .tsb-btn-secondary { background: white; border: 1px solid #e2e8f0; color: #64748b; }
                    .tsb-btn-add { background: #dbeafe; border: 1px solid #93c5fd; color: #1d4ed8; }
                    .tsb-btn-danger { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; }
                    .tsb-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
                    .tsb-content { flex: 1; overflow: auto; padding: 1.5rem; }
                    .tsb-table-wrapper { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: visible; border: 1px solid #d1d5db; }
                    .tsb-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
                    .tsb-table th { background: #f1f5f9; padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: #475569; border: 1px solid #d1d5db; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
                    .tsb-table th i { margin-right: 0.3rem; }
                    .tsb-table td { padding: 0.5rem; border: 1px solid #e2e8f0; vertical-align: top; position: relative; overflow: visible; background: white; }
                    .tsb-table tr:hover td { background: #f8fafc; }
                    .tsb-table tr.invalid td { background: #fef2f2; }
                    .tsb-table tr.saved td { background: #f0fdf4; }
                    .tsb-table tr.saved:hover td { background: #dcfce7; }
                    .tsb-table tr.modified td { background: #fefce8; }
                    .tsb-table tr.modified:hover td { background: #fef9c3; }
                    .tsb-status-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; font-weight: 600; margin-left: 4px; }
                    .tsb-status-badge.saved { background: #dcfce7; color: #166534; }
                    .tsb-status-badge.new { background: #dbeafe; color: #1d4ed8; }
                    .tsb-status-badge.modified { background: #fef3c7; color: #92400e; }
                    .tsb-select { width: 100%; padding: 0.4rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; background: white; cursor: pointer; }
                    .tsb-select:focus { border-color: #0891b2; outline: none; box-shadow: 0 0 0 2px rgba(8,145,178,0.2); }
                    .tsb-input { width: 100%; padding: 0.4rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; }
                    .tsb-input:focus { border-color: #0891b2; outline: none; box-shadow: 0 0 0 2px rgba(8,145,178,0.2); }
                    .tsb-days { display: flex; gap: 0.2rem; flex-wrap: wrap; }
                    .tsb-day { width: 28px; height: 28px; border-radius: 4px; border: 1px solid #e2e8f0; background: white; font-size: 0.65rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
                    .tsb-day:hover { border-color: #0891b2; }
                    .tsb-day.selected { background: #0891b2; color: white; border-color: #0891b2; }
                    .tsb-row-num { width: 40px; text-align: center; color: #94a3b8; font-weight: 600; }
                    .tsb-row-actions { width: 60px; text-align: center; }
                    .tsb-delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.3rem; border-radius: 4px; opacity: 0.5; transition: all 0.15s; }
                    .tsb-delete-btn:hover { opacity: 1; background: #fee2e2; }
                    .tsb-copy-btn { background: none; border: none; color: #3b82f6; cursor: pointer; padding: 0.3rem; border-radius: 4px; opacity: 0.5; transition: all 0.15s; }
                    .tsb-copy-btn:hover { opacity: 1; background: #dbeafe; }
                    .tsb-footer { background: white; border-top: 1px solid #e2e8f0; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
                    .tsb-status { font-size: 0.85rem; color: #64748b; }
                    .tsb-status strong { color: #0f172a; }
                    .tsb-multi-select { position: relative; z-index: 100; }
                    .tsb-multi-btn { width: 100%; padding: 0.4rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; background: white; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; }
                    .tsb-multi-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); z-index: 9999; max-height: 200px; overflow-y: auto; display: none; }
                    .tsb-multi-dropdown.show { display: block; }
                    .tsb-multi-option { padding: 0.4rem 0.6rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
                    .tsb-multi-option:hover { background: #f8fafc; }
                    .tsb-multi-option input { margin: 0; }
                    .tsb-hint { font-size: 0.7rem; color: #94a3b8; margin-top: 0.5rem; }
                    .tsb-filters { display: flex; gap: 0.75rem; padding: 0.75rem 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; align-items: flex-end; }
                    .tsb-filter-group { flex: 1; min-width: 140px; }
                    .tsb-filter-group label { font-size: 0.7rem; font-weight: 600; color: #64748b; display: block; margin-bottom: 0.25rem; }
                    .tsb-filter-select { width: 100%; padding: 0.4rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; font-size: 0.8rem; cursor: pointer; }
                    .tsb-filter-btn { padding: 0.4rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem; color: #64748b; }
                    .tsb-filter-btn:hover { background: #f1f5f9; }
                </style>
                
                <div class="tsb-container">
                    <div class="tsb-header">
                        <div class="tsb-title">
                            <i class="fas fa-table" style="color: #16a34a;"></i>
                            Table Schedule Builder
                            <span style="font-size: 0.7rem; font-weight: 500; background: #dcfce7; color: #166534; padding: 3px 10px; border-radius: 20px;">Excel Mode</span>
                        </div>
                        <div class="tsb-actions">
                            <button class="tsb-btn tsb-btn-add" onclick="tsbAddRow()">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                            <button class="tsb-btn tsb-btn-secondary" onclick="tsbAddMultipleRows()">
                                <i class="fas fa-layer-group"></i> Add 5 Rows
                            </button>
                            <button class="tsb-btn tsb-btn-secondary" onclick="openScheduleManager()">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button class="tsb-btn tsb-btn-danger" onclick="closeScheduleManagerDynamic()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters Section -->
                    <div class="tsb-filters">
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-briefcase" style="margin-right: 0.25rem; color: #0ea5e9;"></i>Type</label>
                            <select id="tsbFilterType" class="tsb-filter-select" onchange="tsbApplyFilters(); tsbFilterEmployeesByType();">
                                <option value="">All Types</option>
                                <option value="clinical">Clinical</option>
                                <option value="non-clinical">Non-Clinical</option>
                            </select>
                        </div>
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-id-badge" style="margin-right: 0.25rem; color: #f43f5e;"></i>Role</label>
                            <select id="tsbFilterRole" class="tsb-filter-select" onchange="tsbApplyFilters(); tsbFilterEmployeesByType();">
                                <option value="">All Roles</option>
                            </select>
                        </div>
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-user" style="margin-right: 0.25rem; color: #6366f1;"></i>Employee</label>
                            <select id="tsbFilterEmployee" class="tsb-filter-select" onchange="tsbApplyFilters()">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-user-md" style="margin-right: 0.25rem; color: #10b981;"></i>Provider</label>
                            <select id="tsbFilterProvider" class="tsb-filter-select" onchange="tsbApplyFilters()">
                                <option value="">All Providers</option>
                            </select>
                        </div>
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-hospital" style="margin-right: 0.25rem; color: #f59e0b;"></i>Clinic</label>
                            <select id="tsbFilterClinic" class="tsb-filter-select" onchange="tsbApplyFilters()">
                                <option value="">All Clinics</option>
                            </select>
                        </div>
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-door-open" style="margin-right: 0.25rem; color: #8b5cf6;"></i>Room</label>
                            <select id="tsbFilterRoom" class="tsb-filter-select" onchange="tsbApplyFilters()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                        <div class="tsb-filter-group">
                            <label><i class="fas fa-check-circle" style="margin-right: 0.25rem; color: #3b82f6;"></i>Status</label>
                            <select id="tsbFilterStatus" class="tsb-filter-select" onchange="tsbApplyFilters()">
                                <option value="">All Status</option>
                                <option value="saved">Saved</option>
                                <option value="new">New</option>
                                <option value="modified">Modified</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="tsb-filter-btn" onclick="tsbClearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                    
                    <div class="tsb-content">
                        <div class="tsb-table-wrapper">
                            <table class="tsb-table">
                                <thead>
                                    <tr>
                                        <th class="tsb-row-num">#</th>
                                        <th id="tsbColEmployee" style="min-width: 150px;"><i class="fas fa-user" style="color: #6366f1;"></i> Employee</th>
                                        <th id="tsbColProvider" style="min-width: 150px;"><i class="fas fa-user-md" style="color: #10b981;"></i> Provider</th>
                                        <th style="min-width: 130px;"><i class="fas fa-hospital" style="color: #f59e0b;"></i> Clinic</th>
                                        <th style="min-width: 140px;"><i class="fas fa-door-open" style="color: #8b5cf6;"></i> Room(s)</th>
                                        <th id="tsbColAssistants" style="min-width: 140px;"><i class="fas fa-user-nurse" style="color: #ec4899;"></i> Assistant(s)</th>
                                        <th style="min-width: 200px;"><i class="fas fa-calendar-day" style="color: #ef4444;"></i> Days</th>
                                        <th style="min-width: 110px;"><i class="fas fa-calendar" style="color: #06b6d4;"></i> Start Date</th>
                                        <th style="min-width: 110px;"><i class="fas fa-calendar" style="color: #06b6d4;"></i> End Date</th>
                                        <th style="min-width: 230px;"><i class="fas fa-clock" style="color: #0891b2;"></i> Time Range</th>
                                        <th style="min-width: 100px;"><i class="fas fa-calendar-plus" style="color: #64748b;"></i> Created</th>
                                        <th class="tsb-row-actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tsbTableBody">
                                </tbody>
                            </table>
                        </div>
                        <p class="tsb-hint"><i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Tip: Click the copy button to duplicate a row. Select multiple rooms and assistants by clicking the dropdown.</p>
                        
                        <!-- Conflict Warning Panel -->
                        <div id="tsbConflictPanel" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: #dc2626; font-size: 0.85rem;"><i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>Scheduling Conflicts Detected</span>
                                <button onclick="document.getElementById('tsbConflictPanel').style.display='none'" style="background: none; border: none; cursor: pointer; color: #dc2626; font-size: 1rem;">&times;</button>
                            </div>
                            <div id="tsbConflictList" style="font-size: 0.8rem; color: #991b1b; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- No Conflicts Success Panel -->
                        <div id="tsbNoConflictPanel" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px;">
                            <span style="font-weight: 600; color: #166534; font-size: 0.85rem;"><i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>No Conflicts Found - All schedules are valid!</span>
                        </div>
                    </div>
                    
                    <div class="tsb-footer">
                        <div class="tsb-status">
                            <span style="margin-right: 1rem;"><i class="fas fa-check-circle" style="color: #10b981; margin-right: 0.3rem;"></i><strong id="tsbSavedCount">0</strong> saved</span>
                            <span style="margin-right: 1rem;"><i class="fas fa-plus-circle" style="color: #3b82f6; margin-right: 0.3rem;"></i><strong id="tsbRowCount">0</strong> new to create</span>
                            <span id="tsbFilterIndicator" style="display: none; color: #f59e0b; font-size: 0.8rem;"><i class="fas fa-filter" style="margin-right: 0.3rem;"></i></span>
                        </div>
                        <div class="tsb-actions">
                            <button class="tsb-btn" onclick="tsbCheckConflicts()" style="background: #f59e0b; color: white;">
                                <i class="fas fa-exclamation-triangle"></i> Check Conflicts
                            </button>
                            <button class="tsb-btn" onclick="tsbExportToExcel()" style="background: #059669; color: white;">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                            <button class="tsb-btn tsb-btn-secondary" onclick="tsbClearAll()">
                                <i class="fas fa-eraser"></i> Clear New
                            </button>
                            <button class="tsb-btn tsb-btn-primary" onclick="tsbCreateAllSchedules()">
                                <i class="fas fa-check-double"></i> Create New Schedules
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Render the initial row
            tsbLoadExistingSchedules();
            tsbRenderTable();
        }
        
        function createEmptyRow() {
            return {
                id: tableBuilderNextId++,
                shiftId: null, // Links to actual shift in myScheduleShifts
                status: 'new', // 'new', 'saved', 'modified'
                employee: '', // For standalone employee schedules (non-assistant)
                provider: '', // Provider the employee assists (optional)
                clinic: '',
                rooms: [],
                assistants: [],
                days: [],
                startDate: '',
                endDate: '',
                startTime: '',
                endTime: '',
                createdDate: null
            };
        }
        
        // Load existing schedules from myScheduleShifts
        function tsbLoadExistingSchedules() {
            tableBuilderRows = [];
            tableBuilderNextId = 1;
            
            if (window.myScheduleShifts && window.myScheduleShifts.length > 0) {
                // Group shifts by provider+clinic+time+dates to merge rooms
                const groupedShifts = {};
                
                window.myScheduleShifts.forEach(shift => {
                    const key = `${shift.name}|${shift.clinic}|${shift.startTime}|${shift.endTime}|${shift.startDate}|${shift.endDate}|${(shift.days || []).sort().join(',')}`;
                    
                    if (!groupedShifts[key]) {
                        groupedShifts[key] = {
                            shiftIds: [shift.id],
                            employee: shift.employee || '', // Standalone employee
                            provider: shift.name,
                            clinic: shift.clinic,
                            rooms: [shift.room],
                            assistants: shift.assistant ? shift.assistant.split(', ').filter(a => a) : [],
                            days: shift.days || [],
                            startDate: shift.startDate || '',
                            endDate: shift.endDate || '',
                            startTime: shift.startTime,
                            endTime: shift.endTime,
                            createdDate: shift.createdDate || null
                        };
                    } else {
                        groupedShifts[key].shiftIds.push(shift.id);
                        if (shift.room && !groupedShifts[key].rooms.includes(shift.room)) {
                            groupedShifts[key].rooms.push(shift.room);
                        }
                    }
                });
                
                // Convert to table rows
                Object.values(groupedShifts).forEach(group => {
                    tableBuilderRows.push({
                        id: tableBuilderNextId++,
                        shiftIds: group.shiftIds,
                        status: 'saved',
                        employee: group.employee || '',
                        provider: group.provider,
                        clinic: group.clinic,
                        rooms: group.rooms,
                        assistants: group.assistants,
                        days: group.days,
                        startDate: group.startDate,
                        endDate: group.endDate,
                        startTime: group.startTime || '',
                        endTime: group.endTime || '',
                        createdDate: group.createdDate
                    });
                });
            }
            
            // Always add one empty row at the end for new entries
            tableBuilderRows.push(createEmptyRow());
            
            // Populate filter dropdowns
            tsbPopulateFilters();
        }
        
        // Populate filter dropdowns with available options
        function tsbPopulateFilters() {
            const providers = window.masterData ? window.masterData.getProviders() : [];
            const clinics = window.masterData ? window.masterData.clinics : [];
            const rooms = window.masterData ? window.masterData.rooms : [];
            const allEmployees = window.masterData ? window.masterData.getAllEmployees() : [];
            
            // Get unique roles from employees
            const roles = [...new Set(allEmployees.map(e => e.extendedProps?.role).filter(Boolean))].sort();
            
            // Role filter
            const roleFilter = document.getElementById('tsbFilterRole');
            if (roleFilter) {
                const currentValue = roleFilter.value;
                roleFilter.innerHTML = '<option value="">All Roles</option>' + 
                    roles.map(r => `<option value="${r}" ${currentValue === r ? 'selected' : ''}>${r}</option>`).join('');
            }
            
            // Employee filter (all staff) - may be filtered by type/role
            const employeeFilter = document.getElementById('tsbFilterEmployee');
            if (employeeFilter) {
                const currentValue = employeeFilter.value;
                const typeFilter = document.getElementById('tsbFilterType')?.value || '';
                const roleFilterVal = document.getElementById('tsbFilterRole')?.value || '';
                
                let filteredEmployees = allEmployees;
                
                // Filter by staffType (clinical/non-clinical)
                if (typeFilter) {
                    filteredEmployees = filteredEmployees.filter(e => {
                        const staffType = e.extendedProps?.staffType || '';
                        return staffType === typeFilter;
                    });
                }
                
                // Filter by role
                if (roleFilterVal) {
                    filteredEmployees = filteredEmployees.filter(e => e.extendedProps?.role === roleFilterVal);
                }
                
                employeeFilter.innerHTML = '<option value="">All Employees</option>' + 
                    filteredEmployees.map(e => `<option value="${e.title}" ${currentValue === e.title ? 'selected' : ''}>${e.title}</option>`).join('');
            }
            
            // Provider filter
            const providerFilter = document.getElementById('tsbFilterProvider');
            if (providerFilter) {
                const currentValue = providerFilter.value;
                providerFilter.innerHTML = '<option value="">All Providers</option>' + 
                    providers.map(p => `<option value="${p.title}" ${currentValue === p.title ? 'selected' : ''}>${p.title}</option>`).join('');
            }
            
            // Clinic filter
            const clinicFilter = document.getElementById('tsbFilterClinic');
            if (clinicFilter) {
                const currentValue = clinicFilter.value;
                clinicFilter.innerHTML = '<option value="">All Clinics</option>' + 
                    clinics.map(c => `<option value="${c.name}" ${currentValue === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            }
            
            // Room filter
            const roomFilter = document.getElementById('tsbFilterRoom');
            if (roomFilter) {
                const currentValue = roomFilter.value;
                roomFilter.innerHTML = '<option value="">All Rooms</option>' + 
                    rooms.map(r => `<option value="${r.name}" ${currentValue === r.name ? 'selected' : ''}>${r.name}</option>`).join('');
            }
        }
        
        // Helper to re-filter employee dropdown when type/role changes
        function tsbFilterEmployeesByType() {
            tsbPopulateFilters();
        }
        
        // Get current filter values
        function tsbGetFilters() {
            return {
                type: document.getElementById('tsbFilterType')?.value || '',
                role: document.getElementById('tsbFilterRole')?.value || '',
                employee: document.getElementById('tsbFilterEmployee')?.value || '',
                provider: document.getElementById('tsbFilterProvider')?.value || '',
                clinic: document.getElementById('tsbFilterClinic')?.value || '',
                room: document.getElementById('tsbFilterRoom')?.value || '',
                status: document.getElementById('tsbFilterStatus')?.value || ''
            };
        }
        
        // Apply filters - just re-renders the table
        function tsbApplyFilters() {
            tsbRenderTable();
        }
        
        // Clear all filters
        function tsbClearFilters() {
            const typeFilter = document.getElementById('tsbFilterType');
            const roleFilter = document.getElementById('tsbFilterRole');
            const employeeFilter = document.getElementById('tsbFilterEmployee');
            const providerFilter = document.getElementById('tsbFilterProvider');
            const clinicFilter = document.getElementById('tsbFilterClinic');
            const roomFilter = document.getElementById('tsbFilterRoom');
            const statusFilter = document.getElementById('tsbFilterStatus');
            
            if (typeFilter) typeFilter.value = '';
            if (roleFilter) roleFilter.value = '';
            if (employeeFilter) employeeFilter.value = '';
            if (providerFilter) providerFilter.value = '';
            if (clinicFilter) clinicFilter.value = '';
            if (roomFilter) roomFilter.value = '';
            if (statusFilter) statusFilter.value = '';
            
            // Re-populate employee filter to show all
            tsbPopulateFilters();
            tsbRenderTable();
            
            if (typeof showNotification === 'function') {
                showNotification('Filters cleared', 'info');
            }
        }
        
        // Check if a row matches current filters
        function tsbRowMatchesFilters(row, filters) {
            // Always show empty rows so user can add new entries
            if (row.status === 'new' && !row.provider && !row.employee && !row.clinic && row.rooms.length === 0) {
                return true;
            }
            
            // Type filter (clinical/non-clinical) - use staffType field
            if (filters.type) {
                const personName = row.employee || row.provider;
                if (!personName) {
                    // No person assigned yet - still show the row
                    return true;
                }
                const allEmployees = window.masterData?.getAllEmployees() || [];
                const personData = allEmployees.find(e => e.title === personName);
                const staffType = personData?.extendedProps?.staffType || '';
                
                if (staffType !== filters.type) return false;
            }
            
            // Role filter
            if (filters.role) {
                const personName = row.employee || row.provider;
                if (personName) {
                    const allEmployees = window.masterData?.getAllEmployees() || [];
                    const personData = allEmployees.find(e => e.title === personName);
                    const personRole = personData?.extendedProps?.role || '';
                    if (personRole !== filters.role) return false;
                }
            }
            
            // Employee filter
            if (filters.employee && row.employee !== filters.employee) {
                return false;
            }
            
            // Provider filter
            if (filters.provider && row.provider !== filters.provider) {
                return false;
            }
            
            // Clinic filter
            if (filters.clinic && row.clinic !== filters.clinic) {
                return false;
            }
            
            // Room filter - check if any room matches
            if (filters.room && !row.rooms.includes(filters.room)) {
                return false;
            }
            
            // Status filter
            if (filters.status && row.status !== filters.status) {
                return false;
            }
            
            return true;
        }
        
        // Helper to convert 24h to 12h display
        function convertTo12HourDisplay(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours);
            const period = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${minutes} ${period}`;
        }
        
        function tsbRenderTable() {
            const tbody = document.getElementById('tsbTableBody');
            if (!tbody) return;
            
            const providers = window.masterData ? window.masterData.getProviders() : [];
            const assistants = window.masterData ? window.masterData.getAssistants() : [];
            const allEmployees = window.masterData ? window.masterData.getAllEmployees() : [];
            const clinics = window.masterData ? window.masterData.clinics : [];
            const rooms = window.masterData ? window.masterData.rooms : [];
            const timeSlots = window.masterData ? window.masterData.timeSlots : [];
            
            // Get current filters
            const filters = tsbGetFilters();
            
            // Show/hide Employee, Provider, and Assistants header columns based on type filter
            const employeeHeader = document.getElementById('tsbColEmployee');
            const providerHeader = document.getElementById('tsbColProvider');
            const assistantsHeader = document.getElementById('tsbColAssistants');
            if (employeeHeader) {
                employeeHeader.style.display = filters.type === 'clinical' ? 'none' : '';
            }
            if (providerHeader) {
                providerHeader.style.display = filters.type === 'non-clinical' ? 'none' : '';
            }
            if (assistantsHeader) {
                assistantsHeader.style.display = filters.type === 'non-clinical' ? 'none' : '';
            }
            
            // Filter rows based on current filters
            const filteredRows = tableBuilderRows.filter(row => tsbRowMatchesFilters(row, filters));
            
            tbody.innerHTML = filteredRows.map((row, index) => {
                // Filter rooms by selected clinic - lookup clinic ID by name, then filter rooms
                let filteredRooms = [];
                if (row.clinic) {
                    const selectedClinic = clinics.find(c => c.name === row.clinic);
                    if (selectedClinic) {
                        filteredRooms = rooms.filter(r => r.clinicId === selectedClinic.id);
                    }
                }
                
                // Filter employees based on active type filter
                let filteredEmployeesForRow = allEmployees;
                let filteredProvidersForRow = providers;
                if (filters.type) {
                    filteredEmployeesForRow = allEmployees.filter(e => 
                        e.extendedProps?.staffType === filters.type
                    );
                    // Providers are only clinical - if non-clinical is selected, no providers
                    if (filters.type === 'non-clinical') {
                        filteredProvidersForRow = [];
                    } else {
                        filteredProvidersForRow = providers.filter(p => 
                            p.extendedProps?.staffType === filters.type
                        );
                    }
                }
                
                // Filter by role if active
                if (filters.role) {
                    filteredEmployeesForRow = filteredEmployeesForRow.filter(e => 
                        e.extendedProps?.role === filters.role
                    );
                    filteredProvidersForRow = filteredProvidersForRow.filter(p => 
                        p.extendedProps?.role === filters.role
                    );
                }
                
                const employeeOptions = filteredEmployeesForRow.map(e => 
                    `<option value="${e.title}" ${row.employee === e.title ? 'selected' : ''}>${e.title}</option>`
                ).join('');
                
                const providerOptions = filteredProvidersForRow.map(p => 
                    `<option value="${p.title}" ${row.provider === p.title ? 'selected' : ''}>${p.title}</option>`
                ).join('');
                
                const clinicOptions = clinics.map(c => 
                    `<option value="${c.name}" ${row.clinic === c.name ? 'selected' : ''}>${c.name}</option>`
                ).join('');
                
                const timeOptions = timeSlots.map(t => 
                    `<option value="${t.name}" ${row.time === t.name ? 'selected' : ''}>${t.name}</option>`
                ).join('');
                
                const roomsDisplay = row.rooms.length > 0 
                    ? (row.rooms.length > 2 ? `${row.rooms.length} rooms` : row.rooms.join(', '))
                    : 'Select...';
                
                const assistantsDisplay = row.assistants.length > 0 
                    ? (row.assistants.length > 2 ? `${row.assistants.length} selected` : row.assistants.join(', '))
                    : 'Select...';
                
                const daysHtml = ['M', 'T', 'W', 'Th', 'F', 'Sa', 'Su'].map((d, i) => {
                    const dayFull = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][i];
                    const isSelected = row.days.includes(dayFull);
                    const isDisabled = row.status === 'saved' ? 'disabled' : '';
                    return `<button type="button" class="tsb-day ${isSelected ? 'selected' : ''}" onclick="tsbToggleDay(${row.id}, '${dayFull}')" ${isDisabled}>${d}</button>`;
                }).join('');
                
                // Room is required for providers, clinic and room optional for standalone employees (IT, Admin, etc.)
                const needsRoom = row.provider ? row.rooms.length > 0 : true;
                const needsClinic = row.provider ? !!row.clinic : true; // Clinic optional for standalone employees
                const isValid = (row.provider || row.employee) && needsClinic && needsRoom && row.days.length > 0 && row.startDate && row.endDate && row.startTime && row.endTime;
                const rowClass = row.status === 'saved' ? 'saved' : (row.status === 'modified' ? 'modified' : (isValid ? '' : 'invalid'));
                const statusBadge = row.status === 'saved' ? '<span class="tsb-status-badge saved">Saved</span>' : 
                                   (row.status === 'modified' ? '<span class="tsb-status-badge modified">Modified</span>' : 
                                   (row.status === 'new' && isValid ? '<span class="tsb-status-badge new">New</span>' : ''));
                const isReadOnly = row.status === 'saved';
                
                // Determine which columns to show based on type filter
                const showEmployeeCol = filters.type !== 'clinical';
                const showProviderCol = filters.type !== 'non-clinical';
                const showAssistantsCol = filters.type !== 'non-clinical';
                
                return `
                    <tr class="${rowClass}" data-row-id="${row.id}">
                        <td class="tsb-row-num">${index + 1}${statusBadge}</td>
                        <td class="tsb-cell-employee" ${!showEmployeeCol ? 'style="display: none;"' : ''}>
                            <select class="tsb-select" onchange="tsbUpdateRow(${row.id}, 'employee', this.value)" ${isReadOnly ? 'disabled' : ''}>
                                <option value="">Select Employee...</option>
                                ${employeeOptions}
                            </select>
                        </td>
                        <td class="tsb-cell-provider" ${!showProviderCol ? 'style="display: none;"' : ''}>
                            <select class="tsb-select" onchange="tsbUpdateRow(${row.id}, 'provider', this.value)" ${isReadOnly ? 'disabled' : ''}>
                                <option value="">Select Provider...</option>
                                ${providerOptions}
                            </select>
                        </td>
                        <td>
                            <select class="tsb-select" onchange="tsbUpdateRow(${row.id}, 'clinic', this.value)" ${isReadOnly ? 'disabled' : ''}>
                                <option value="">Select Clinic...</option>
                                ${clinicOptions}
                            </select>
                        </td>
                        <td>
                            <div class="tsb-multi-select">
                                <button type="button" class="tsb-multi-btn" onclick="${isReadOnly ? '' : `tsbToggleDropdown(${row.id}, 'rooms')`}" ${isReadOnly ? 'style="opacity: 0.7; cursor: default;"' : ''}>
                                    <span>${roomsDisplay}</span>
                                    ${isReadOnly ? '' : '<i class="fas fa-chevron-down" style="font-size: 0.7rem; color: #94a3b8;"></i>'}
                                </button>
                                ${isReadOnly ? '' : `<div class="tsb-multi-dropdown" id="tsbRooms_${row.id}">
                                    ${filteredRooms.map(r => `
                                        <label class="tsb-multi-option">
                                            <input type="checkbox" ${row.rooms.includes(r.name) ? 'checked' : ''} onchange="tsbToggleMulti(${row.id}, 'rooms', '${r.name}')">
                                            ${r.name}
                                        </label>
                                    `).join('')}
                                    ${filteredRooms.length === 0 ? '<div style="padding: 0.5rem; color: #94a3b8; font-size: 0.75rem;">Select a clinic first</div>' : ''}
                                </div>`}
                            </div>
                        </td>
                        <td class="tsb-cell-assistants" ${!showAssistantsCol ? 'style="display: none;"' : ''}>
                            <div class="tsb-multi-select">
                                <button type="button" class="tsb-multi-btn" onclick="${isReadOnly ? '' : `tsbToggleDropdown(${row.id}, 'assistants')`}" ${isReadOnly ? 'style="opacity: 0.7; cursor: default;"' : ''}>
                                    <span>${assistantsDisplay}</span>
                                    ${isReadOnly ? '' : '<i class="fas fa-chevron-down" style="font-size: 0.7rem; color: #94a3b8;"></i>'}
                                </button>
                                ${isReadOnly ? '' : `<div class="tsb-multi-dropdown" id="tsbAssistants_${row.id}">
                                    ${assistants.map(a => `
                                        <label class="tsb-multi-option">
                                            <input type="checkbox" ${row.assistants.includes(a.title) ? 'checked' : ''} onchange="tsbToggleMulti(${row.id}, 'assistants', '${a.title}')">
                                            ${a.title}
                                        </label>
                                    `).join('')}
                                </div>`}
                            </div>
                        </td>
                        <td>
                            <div class="tsb-days">${daysHtml}</div>
                        </td>
                        <td>
                            <input type="date" class="tsb-input" value="${row.startDate}" onchange="tsbUpdateRow(${row.id}, 'startDate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                        </td>
                        <td>
                            <input type="date" class="tsb-input" value="${row.endDate}" onchange="tsbUpdateRow(${row.id}, 'endDate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.25rem; align-items: center;">
                                <input type="time" class="tsb-input" value="${row.startTime}" onchange="tsbUpdateRow(${row.id}, 'startTime', this.value)" ${isReadOnly ? 'disabled' : ''} style="width: 105px; padding: 0.3rem;">
                                <span style="color: #94a3b8;">-</span>
                                <input type="time" class="tsb-input" value="${row.endTime}" onchange="tsbUpdateRow(${row.id}, 'endTime', this.value)" ${isReadOnly ? 'disabled' : ''} style="width: 105px; padding: 0.3rem;">
                            </div>
                        </td>
                        <td style="text-align: center; color: #64748b; font-size: 0.8rem;">
                            ${row.createdDate ? new Date(row.createdDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : (row.status === 'new' ? '<span style="color: #94a3b8;">â€”</span>' : '<span style="color: #94a3b8;">â€”</span>')}
                        </td>
                        <td class="tsb-row-actions">
                            ${row.status === 'modified' ? `
                                <button onclick="tsbSaveRowChanges(${row.id})" title="Save Changes" style="background: #10b981; color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.25rem;">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button onclick="tsbCancelEdit(${row.id})" title="Cancel Edit" style="background: #6b7280; color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : `
                                ${row.status === 'saved' ? `<button class="tsb-edit-btn" onclick="tsbEditRow(${row.id})" title="Edit Schedule" style="background: #3b82f6; color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.25rem;">
                                    <i class="fas fa-edit"></i>
                                </button>` : ''}
                                <button class="tsb-copy-btn" onclick="tsbCopyRow(${row.id})" title="Duplicate Row">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="tsb-delete-btn" onclick="tsbDeleteRow(${row.id})" title="${row.status === 'saved' ? 'Delete Schedule' : 'Remove Row'}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update row count
            const countEl = document.getElementById('tsbRowCount');
            const savedCountEl = document.getElementById('tsbSavedCount');
            const filteredCountEl = document.getElementById('tsbFilteredCount');
            
            // Check if any filters are active
            const hasActiveFilters = filters.type || filters.role || filters.employee || filters.provider || filters.clinic || filters.room || filters.status;
            
            if (countEl) {
                const newValidRows = tableBuilderRows.filter(r => {
                    const needsRoom = r.provider ? r.rooms.length > 0 : true;
                    return r.status === 'new' && (r.provider || r.employee) && r.clinic && needsRoom && r.days.length > 0 && r.startDate && r.endDate && r.startTime && r.endTime;
                }).length;
                countEl.textContent = newValidRows;
            }
            if (savedCountEl) {
                const savedRows = tableBuilderRows.filter(r => r.status === 'saved').length;
                const filteredSavedRows = filteredRows.filter(r => r.status === 'saved').length;
                if (hasActiveFilters) {
                    savedCountEl.textContent = `${filteredSavedRows}/${savedRows}`;
                } else {
                    savedCountEl.textContent = savedRows;
                }
            }
            
            // Show/hide filtered indicator
            const filterIndicator = document.getElementById('tsbFilterIndicator');
            if (filterIndicator) {
                if (hasActiveFilters) {
                    filterIndicator.style.display = 'inline';
                    filterIndicator.textContent = `(filtered: showing ${filteredRows.length} of ${tableBuilderRows.length})`;
                } else {
                    filterIndicator.style.display = 'none';
                }
            }
        }
        
        function tsbAddRow() {
            tableBuilderRows.push(createEmptyRow());
            tsbRenderTable();
        }
        
        function tsbAddMultipleRows() {
            for (let i = 0; i < 5; i++) {
                tableBuilderRows.push(createEmptyRow());
            }
            tsbRenderTable();
        }
        
        function tsbDeleteRow(rowId) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (!row) return;
            
            // Check if it's a saved row (exists in database)
            if (row.status === 'saved' && row.shiftIds && row.shiftIds.length > 0) {
                const confirmDelete = confirm(`Delete this schedule from the system?\n\n${row.provider}\n${row.clinic} - ${row.rooms.join(', ')}\n${row.days.join(', ')}\n\nThis will permanently remove it from the calendar.`);
                if (!confirmDelete) return;
                
                // Delete from myScheduleShifts
                row.shiftIds.forEach(shiftId => {
                    const index = window.myScheduleShifts.findIndex(s => s.id === shiftId);
                    if (index > -1) {
                        window.myScheduleShifts.splice(index, 1);
                    }
                });
                
                // Refresh calendar
                if (typeof window.renderMyScheduleCalendar === 'function') {
                    window.renderMyScheduleCalendar();
                }
                
                if (typeof showNotification === 'function') {
                    showNotification('Schedule deleted successfully', 'success');
                }
            }
            
            // Remove from table (keep at least one row)
            const newRows = tableBuilderRows.filter(r => r.id !== rowId);
            if (newRows.length === 0) {
                newRows.push(createEmptyRow());
            }
            tableBuilderRows = newRows;
            tsbRenderTable();
        }
        
        function tsbCopyRow(rowId) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (row) {
                const newRow = {
                    ...row,
                    id: tableBuilderNextId++,
                    shiftIds: null, // New copy is not linked to any saved shift
                    status: 'new', // Copy is always a new record
                    rooms: [...row.rooms],
                    assistants: [...row.assistants],
                    days: [...row.days]
                };
                const index = tableBuilderRows.findIndex(r => r.id === rowId);
                tableBuilderRows.splice(index + 1, 0, newRow);
                tsbRenderTable();
            }
        }
        
        function tsbEditRow(rowId) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (!row || row.status !== 'saved') return;
            
            // Change status to allow editing
            row.status = 'modified';
            row.originalShiftIds = [...(row.shiftIds || [])]; // Store original IDs for later update
            
            // Re-render to enable editing
            tsbRenderTable();
            
            if (typeof showNotification === 'function') {
                showNotification('ðŸ“ Row unlocked for editing. Click "Save Changes" when done.', 'info');
            }
        }
        
        function tsbSaveRowChanges(rowId) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (!row || row.status !== 'modified') return;
            
            // Validate the row - need either provider or employee
            // Room and Clinic are required for providers, optional for standalone employees (IT, Admin, etc.)
            const needsRoom = row.provider ? row.rooms.length > 0 : true;
            const needsClinic = row.provider ? !!row.clinic : true; // Clinic optional for standalone employees
            if ((!row.provider && !row.employee) || !needsClinic || !needsRoom || row.days.length === 0 || !row.startDate || !row.endDate || !row.startTime || !row.endTime) {
                alert('Please fill in all required fields before saving (Employee or Provider, Days, Dates, Time). Clinic and Room are required for Provider schedules, optional for standalone employees.');
                return;
            }
            
            // Delete old shifts from myScheduleShifts
            if (row.originalShiftIds && row.originalShiftIds.length > 0 && window.myScheduleShifts) {
                row.originalShiftIds.forEach(shiftId => {
                    const idx = window.myScheduleShifts.findIndex(s => s.id === shiftId);
                    if (idx > -1) {
                        window.myScheduleShifts.splice(idx, 1);
                    }
                });
            }
            
            // Get time directly (already in 24h format from time input)
            const startTime = row.startTime || '08:00';
            const endTime = row.endTime || '16:00';
            
            // Get clinic color
            const clinicData = window.masterData?.getClinicByName(row.clinic);
            const clinicColor = clinicData?.color || '#10b981';
            
            // Get person data - use provider if set, otherwise use employee
            const personName = row.provider || row.employee;
            const personData = window.masterData?.employees?.find(e => e.title === personName);
            const role = personData?.role || (row.provider ? 'Provider' : 'Staff');
            
            // Create new shifts - one per room, or one with no room for standalone employees
            const newShiftIds = [];
            const roomsToCreate = row.rooms.length > 0 ? row.rooms : [null]; // null = no room
            
            roomsToCreate.forEach((roomName, index) => {
                const newShiftId = 'shift-' + Date.now() + '-edit-' + index;
                const newShift = {
                    id: newShiftId,
                    name: personName,
                    role: role,
                    startTime: startTime,
                    endTime: endTime,
                    clinic: row.clinic,
                    room: roomName, // Can be null for standalone employees
                    assistant: row.assistants.length > 0 ? row.assistants.join(', ') : null,
                    days: [...row.days],
                    color: clinicColor,
                    startDate: row.startDate,
                    endDate: row.endDate,
                    createdDate: row.createdDate || new Date().toISOString(),
                    employee: row.employee || null,
                    provider: row.provider || null
                };
                
                if (window.myScheduleShifts) {
                    window.myScheduleShifts.push(newShift);
                    newShiftIds.push(newShiftId);
                }
            });
            
            // Update row to saved status
            row.status = 'saved';
            row.shiftIds = newShiftIds;
            delete row.originalShiftIds;
            
            // Refresh calendar
            if (typeof window.renderMyScheduleCalendar === 'function') {
                window.renderMyScheduleCalendar();
            }
            
            tsbRenderTable();
            
            if (typeof showNotification === 'function') {
                showNotification('âœ… Schedule updated successfully!', 'success');
            }
        }
        
        function tsbCancelEdit(rowId) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (!row || row.status !== 'modified') return;
            
            // Reload from original data
            tsbLoadExistingSchedules();
            tsbRenderTable();
            
            if (typeof showNotification === 'function') {
                showNotification('Edit cancelled. Changes reverted.', 'info');
            }
        }
        
        function tsbUpdateRow(rowId, field, value) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (row) {
                row[field] = value;
                // If clinic changes, clear rooms
                if (field === 'clinic') {
                    row.rooms = [];
                }
                tsbRenderTable();
            }
        }
        
        function tsbToggleDay(rowId, day) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (row) {
                const index = row.days.indexOf(day);
                if (index > -1) {
                    row.days.splice(index, 1);
                } else {
                    row.days.push(day);
                }
                tsbRenderTable();
            }
        }
        
        function tsbToggleDropdown(rowId, type) {
            // Close all other dropdowns
            document.querySelectorAll('.tsb-multi-dropdown.show').forEach(d => d.classList.remove('show'));
            
            const dropdown = document.getElementById(`tsb${type.charAt(0).toUpperCase() + type.slice(1)}_${rowId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (!e.target.closest('.tsb-multi-select')) {
                        document.querySelectorAll('.tsb-multi-dropdown.show').forEach(d => d.classList.remove('show'));
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 10);
        }
        
        function tsbToggleMulti(rowId, field, value) {
            const row = tableBuilderRows.find(r => r.id === rowId);
            if (row) {
                const index = row[field].indexOf(value);
                if (index > -1) {
                    row[field].splice(index, 1);
                } else {
                    row[field].push(value);
                }
                
                // Update just the display text without re-rendering (keeps dropdown open)
                const rowEl = document.querySelector(`tr[data-row-id="${rowId}"]`);
                if (rowEl) {
                    if (field === 'rooms') {
                        const roomsDisplay = row.rooms.length > 0 
                            ? (row.rooms.length > 2 ? `${row.rooms.length} rooms` : row.rooms.join(', '))
                            : 'Select...';
                        const btn = rowEl.querySelector(`#tsbRooms_${rowId}`)?.previousElementSibling;
                        if (btn) btn.querySelector('span').textContent = roomsDisplay;
                    } else if (field === 'assistants') {
                        const assistantsDisplay = row.assistants.length > 0 
                            ? (row.assistants.length > 2 ? `${row.assistants.length} selected` : row.assistants.join(', '))
                            : 'Select...';
                        const btn = rowEl.querySelector(`#tsbAssistants_${rowId}`)?.previousElementSibling;
                        if (btn) btn.querySelector('span').textContent = assistantsDisplay;
                    }
                }
                
                // Update row count in footer
                const countEl = document.getElementById('tsbRowCount');
                if (countEl) {
                    const newValidRows = tableBuilderRows.filter(r => {
                        const needsRoom = r.provider ? r.rooms.length > 0 : true;
                        return r.status === 'new' && (r.provider || r.employee) && r.clinic && needsRoom && r.days.length > 0 && r.startDate && r.endDate && r.startTime && r.endTime;
                    }).length;
                    countEl.textContent = newValidRows;
                }
            }
        }
        
        // Check for scheduling conflicts
        function tsbCheckConflicts() {
            const conflicts = [];
            
            // Get all schedules (both from myScheduleShifts and tableBuilderRows with new status)
            const allSchedules = [];
            
            // Add existing shifts from myScheduleShifts
            if (window.myScheduleShifts) {
                window.myScheduleShifts.forEach(shift => {
                    (shift.days || []).forEach(day => {
                        allSchedules.push({
                            id: shift.id,
                            employee: shift.employee || null,
                            provider: shift.name,
                            personName: shift.employee || shift.name, // The person being scheduled
                            clinic: shift.clinic,
                            room: shift.room,
                            assistant: shift.assistant,
                            day: day,
                            startTime: shift.startTime,
                            endTime: shift.endTime,
                            startDate: shift.startDate,
                            endDate: shift.endDate,
                            source: 'saved'
                        });
                    });
                });
            }
            
            // Add new rows from table builder
            tableBuilderRows.forEach(row => {
                // Valid row needs either provider or employee
                if (row.status === 'new' && (row.provider || row.employee) && row.startTime && row.endTime) {
                    row.days.forEach(day => {
                        row.rooms.forEach(room => {
                            allSchedules.push({
                                id: row.id,
                                employee: row.employee || null,
                                provider: row.provider || null,
                                personName: row.employee || row.provider, // The person being scheduled
                                clinic: row.clinic,
                                room: room,
                                assistant: row.assistants.join(', '),
                                day: day,
                                startTime: row.startTime,
                                endTime: row.endTime,
                                startDate: row.startDate,
                                endDate: row.endDate,
                                source: 'new'
                            });
                        });
                    });
                }
            });
            
            // Helper to check if times overlap
            function timesOverlap(start1, end1, start2, end2) {
                return start1 < end2 && start2 < end1;
            }
            
            // Helper to check if date ranges overlap
            function datesOverlap(startDate1, endDate1, startDate2, endDate2) {
                if (!startDate1 || !endDate1 || !startDate2 || !endDate2) return true;
                return startDate1 <= endDate2 && startDate2 <= endDate1;
            }
            
            // Check for conflicts
            for (let i = 0; i < allSchedules.length; i++) {
                for (let j = i + 1; j < allSchedules.length; j++) {
                    const s1 = allSchedules[i];
                    const s2 = allSchedules[j];
                    
                    // Must be on the same day
                    if (s1.day !== s2.day) continue;
                    
                    // Must have overlapping date ranges
                    if (!datesOverlap(s1.startDate, s1.endDate, s2.startDate, s2.endDate)) continue;
                    
                    // Must have overlapping times
                    if (!timesOverlap(s1.startTime, s1.endTime, s2.startTime, s2.endTime)) continue;
                    
                    // Check for person conflict (same person in different rooms)
                    if (s1.personName === s2.personName && s1.room !== s2.room) {
                        const isProvider = s1.provider === s1.personName;
                        const conflictKey = `person-${s1.personName}-${s1.day}-${s1.startTime}`;
                        if (!conflicts.find(c => c.key === conflictKey)) {
                            conflicts.push({
                                key: conflictKey,
                                type: isProvider ? 'Provider' : 'Employee',
                                icon: isProvider ? 'fa-user-md' : 'fa-user',
                                message: `<strong>${s1.personName}</strong> is scheduled in <strong>${s1.room}</strong> and <strong>${s2.room}</strong> at overlapping times on <strong>${s1.day}</strong> (${s1.startTime}-${s1.endTime})`
                            });
                        }
                    }
                    
                    // Check for room conflict (same room with different people)
                    if (s1.room === s2.room && s1.personName !== s2.personName) {
                        const conflictKey = `room-${s1.room}-${s1.day}-${s1.startTime}`;
                        if (!conflicts.find(c => c.key === conflictKey)) {
                            conflicts.push({
                                key: conflictKey,
                                type: 'Room',
                                icon: 'fa-door-open',
                                message: `<strong>${s1.room}</strong> is double-booked with <strong>${s1.personName}</strong> and <strong>${s2.personName}</strong> on <strong>${s1.day}</strong> (${s1.startTime}-${s1.endTime})`
                            });
                        }
                    }
                    
                    // Check for assistant conflict (same assistant with different providers/employees)
                    if (s1.assistant && s2.assistant) {
                        const assistants1 = s1.assistant.split(', ').filter(a => a);
                        const assistants2 = s2.assistant.split(', ').filter(a => a);
                        const commonAssistants = assistants1.filter(a => assistants2.includes(a));
                        
                        commonAssistants.forEach(assistant => {
                            if (s1.personName !== s2.personName) {
                                const conflictKey = `assistant-${assistant}-${s1.day}-${s1.startTime}`;
                                if (!conflicts.find(c => c.key === conflictKey)) {
                                    conflicts.push({
                                        key: conflictKey,
                                        type: 'Assistant',
                                        icon: 'fa-user-nurse',
                                        message: `<strong>${assistant}</strong> is assigned to both <strong>${s1.personName}</strong> and <strong>${s2.personName}</strong> on <strong>${s1.day}</strong> (${s1.startTime}-${s1.endTime})`
                                    });
                                }
                            }
                        });
                    }
                }
            }
            
            // Display results
            const conflictPanel = document.getElementById('tsbConflictPanel');
            const noConflictPanel = document.getElementById('tsbNoConflictPanel');
            const conflictList = document.getElementById('tsbConflictList');
            
            if (conflicts.length > 0) {
                conflictList.innerHTML = conflicts.map(c => 
                    `<div style="padding: 0.4rem 0; border-bottom: 1px dashed #fecaca;">
                        <i class="fas ${c.icon}" style="margin-right: 0.5rem; width: 16px;"></i>
                        <span style="background: #fee2e2; padding: 0.1rem 0.4rem; border-radius: 3px; font-weight: 600; margin-right: 0.5rem;">${c.type}</span>
                        ${c.message}
                    </div>`
                ).join('');
                
                conflictPanel.style.display = 'block';
                noConflictPanel.style.display = 'none';
                
                if (typeof showNotification === 'function') {
                    showNotification(`âš ï¸ Found ${conflicts.length} scheduling conflict(s)!`, 'warning');
                }
            } else {
                conflictPanel.style.display = 'none';
                noConflictPanel.style.display = 'block';
                
                // Auto-hide success after 3 seconds
                setTimeout(() => {
                    noConflictPanel.style.display = 'none';
                }, 3000);
                
                if (typeof showNotification === 'function') {
                    showNotification('âœ… No conflicts found! All schedules are valid.', 'success');
                }
            }
            
            return conflicts;
        }
        
        function tsbClearAll() {
            // Only clear new/unsaved rows, keep saved rows
            const savedRows = tableBuilderRows.filter(r => r.status === 'saved');
            const newRows = tableBuilderRows.filter(r => r.status !== 'saved');
            
            if (newRows.length === 0) {
                alert('No new rows to clear.');
                return;
            }
            
            if (confirm(`Clear ${newRows.length} new row(s)? Saved schedules will remain.`)) {
                tableBuilderRows = savedRows;
                // Add an empty row at the end for new entries
                tableBuilderRows.push(createEmptyRow());
                tsbRenderTable();
            }
        }
        
        function tsbExportToExcel() {
            // Get all rows with data (exclude empty rows)
            const rowsToExport = tableBuilderRows.filter(r => 
                r.provider || r.employee || r.clinic || r.rooms.length > 0
            );
            
            if (rowsToExport.length === 0) {
                alert('No schedules to export.');
                return;
            }
            
            // Create CSV content with BOM for Excel UTF-8 compatibility
            const BOM = '\uFEFF';
            const headers = ['Status', 'Employee', 'Provider', 'Clinic', 'Room', 'Assistant', 'Day', 'Start Date', 'End Date', 'Start Time', 'End Time', 'Created Date'];
            
            // Helper to escape CSV values
            const escapeCSV = (val) => {
                if (val === null || val === undefined) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            
            // Format date for display
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };
            
            // Build CSV rows - expand rooms, assistants, and days into separate rows for data analysis
            const csvRows = [headers.join(',')];
            let totalExpandedRows = 0;
            
            rowsToExport.forEach(row => {
                const status = row.status === 'saved' ? 'Saved' : (row.status === 'modified' ? 'Modified' : 'New');
                const startDate = row.startDate || '';
                const endDate = row.endDate || '';
                const createdDate = row.createdDate ? formatDate(row.createdDate) : '';
                
                // Get arrays to expand (use placeholder if empty)
                const roomsToExpand = row.rooms.length > 0 ? row.rooms : [''];
                const assistantsToExpand = row.assistants.length > 0 ? row.assistants : [''];
                const daysToExpand = row.days.length > 0 ? row.days : [''];
                
                // Create a row for each combination of room, assistant, and day
                roomsToExpand.forEach(room => {
                    assistantsToExpand.forEach(assistant => {
                        daysToExpand.forEach(day => {
                            csvRows.push([
                                escapeCSV(status),
                                escapeCSV(row.employee),
                                escapeCSV(row.provider),
                                escapeCSV(row.clinic),
                                escapeCSV(room),
                                escapeCSV(assistant),
                                escapeCSV(day),
                                escapeCSV(startDate),
                                escapeCSV(endDate),
                                escapeCSV(row.startTime),
                                escapeCSV(row.endTime),
                                escapeCSV(createdDate)
                            ].join(','));
                            totalExpandedRows++;
                        });
                    });
                });
            });
            
            const csvContent = BOM + csvRows.join('\r\n');
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `Schedule_Export_${today}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            if (typeof showNotification === 'function') {
                showNotification(`âœ… Exported ${totalExpandedRows} rows (from ${rowsToExport.length} schedule(s)) to ${filename}`, 'success');
            }
        }
        
        function tsbCreateAllSchedules() {
            // Get valid NEW rows only (not already saved)
            // Valid row needs either provider OR employee
            // Room and Clinic are required for providers, optional for standalone employees (IT, Admin, etc.)
            const validRows = tableBuilderRows.filter(r => {
                if (r.status === 'saved') return false;
                const hasPersonAssigned = r.provider || r.employee;
                const needsRoom = r.provider ? r.rooms.length > 0 : true; // Room optional for employee-only
                const needsClinic = r.provider ? !!r.clinic : true; // Clinic optional for employee-only
                return hasPersonAssigned && needsClinic && needsRoom && r.days.length > 0 && r.startDate && r.endDate && r.startTime && r.endTime;
            });
            
            if (validRows.length === 0) {
                alert('No new complete schedules to create. Please fill in all required fields (Employee or Provider, Days, Dates, Time). Clinic and Room are required for Provider schedules, optional for standalone employees.');
                return;
            }
            
            // Only count incomplete NEW rows (exclude saved rows from the count)
            const newRows = tableBuilderRows.filter(r => r.status !== 'saved');
            const invalidCount = newRows.length - validRows.length;
            if (invalidCount > 0) {
                const proceed = confirm(`${invalidCount} incomplete new row(s) will be skipped.\n\nCreate ${validRows.length} schedule(s)?`);
                if (!proceed) return;
            }
            
            let totalCreated = 0;
            let createdShiftIds = {}; // Map row id to array of created shift ids
            
            validRows.forEach(row => {
                // Get time directly (already in 24h format from time input)
                const startTime = row.startTime || '08:00';
                const endTime = row.endTime || '16:00';
                
                // Get clinic color
                const clinicData = window.masterData?.getClinicByName(row.clinic);
                const clinicColor = clinicData?.color || '#10b981';
                
                // Get person data - use provider if set, otherwise use employee
                const personName = row.provider || row.employee;
                const personData = window.masterData?.employees?.find(e => e.title === personName);
                const role = personData?.role || (row.provider ? 'Provider' : 'Staff');
                
                // Track created shift ids for this row
                createdShiftIds[row.id] = [];
                
                // Create schedules - one per room, or one with no room for standalone employees
                const createdNow = new Date().toISOString();
                const roomsToCreate = row.rooms.length > 0 ? row.rooms : [null]; // null = no room assigned
                
                roomsToCreate.forEach((roomName, index) => {
                    const newShiftId = 'shift-' + Date.now() + '-' + totalCreated + '-' + index;
                    const newShift = {
                        id: newShiftId,
                        name: personName,
                        role: role,
                        startTime: startTime,
                        endTime: endTime,
                        clinic: row.clinic,
                        room: roomName, // Can be null for standalone employees
                        assistant: row.assistants.length > 0 ? row.assistants.join(', ') : null,
                        days: [...row.days],
                        color: clinicColor,
                        startDate: row.startDate,
                        endDate: row.endDate,
                        createdDate: createdNow,
                        employee: row.employee || null,
                        provider: row.provider || null
                    };
                    
                    if (window.myScheduleShifts) {
                        window.myScheduleShifts.push(newShift);
                        createdShiftIds[row.id].push(newShiftId);
                        totalCreated++;
                    }
                });
                
                // Store created date for the row
                row.createdDate = createdNow;
            });
            
            // Mark the created rows as 'saved' and store their shift IDs
            validRows.forEach(row => {
                const tableRow = tableBuilderRows.find(r => r.id === row.id);
                if (tableRow && createdShiftIds[row.id]) {
                    tableRow.status = 'saved';
                    tableRow.shiftIds = createdShiftIds[row.id];
                }
            });
            
            // Refresh calendar
            if (typeof window.renderMyScheduleCalendar === 'function') {
                window.renderMyScheduleCalendar();
            }
            
            // Show success message
            if (typeof showNotification === 'function') {
                showNotification(`âœ… Created ${totalCreated} schedule(s) successfully!`, 'success');
            } else {
                alert(`âœ… Successfully created ${totalCreated} schedule(s)!\n\nFrom ${validRows.length} row(s) with ${validRows.reduce((sum, r) => sum + r.rooms.length, 0)} total room assignments.`);
            }
            
            // Add a fresh empty row at the end for more entries
            tableBuilderRows.push(createEmptyRow());
            
            // Re-render the table to show updated status
            tsbRenderTable();
        }
        
        // Open Task Management (Admin Full View)
        function openTasksManagement() {
            // Switch to tasks view
            switchContentView('tasks', null);
            
            // Show management sidebar and New Task button (admin management mode)
            const managementSidebar = document.getElementById('taskManagementSidebar');
            const newTaskBtn = document.getElementById('newTaskBtn');
            if (managementSidebar) managementSidebar.classList.remove('hidden');
            if (newTaskBtn) newTaskBtn.style.display = 'flex';
            
            // Show a notification
            if (typeof showNotification === 'function') {
                showNotification('Task Management Mode - Full Admin Access', 'info');
            }
        }
        
        // Schedule builder mode
        let sbMode = 'provider'; // 'provider' or 'employee'
        
        function sbSelectMode(mode) {
            sbMode = mode;
            const provBtn = document.getElementById('sbModeProvider');
            const empBtn = document.getElementById('sbModeEmployee');
            const stepsText = document.getElementById('sbModeSteps');
            
            if (mode === 'provider') {
                provBtn.style.background = '#0891b2';
                provBtn.style.color = 'white';
                provBtn.style.borderColor = '#0891b2';
                empBtn.style.background = 'white';
                empBtn.style.color = '#64748b';
                empBtn.style.borderColor = '#e2e8f0';
                stepsText.innerHTML = '<i class="fas fa-route" style="margin-right: 0.5rem;"></i><strong>Workflow:</strong> Provider â†’ Clinic â†’ Room â†’ Assistant(s) â†’ Dates â†’ Time';
            } else {
                empBtn.style.background = '#0891b2';
                empBtn.style.color = 'white';
                empBtn.style.borderColor = '#0891b2';
                provBtn.style.background = 'white';
                provBtn.style.color = '#64748b';
                provBtn.style.borderColor = '#e2e8f0';
                stepsText.innerHTML = '<i class="fas fa-route" style="margin-right: 0.5rem;"></i><strong>Workflow:</strong> Employee â†’ Clinic â†’ Room â†’ Provider(s) â†’ Dates â†’ Time';
            }
        }
        
        function closeScheduleManagerDynamic() {
            const modal = document.getElementById('scheduleManagerModalDynamic');
            if (modal) modal.remove();
        }
        
        function startScheduleBuilderGame() {
            const modal = document.getElementById('scheduleManagerModalDynamic');
            if (modal) {
                modal.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdfa 100%)';
                modal.innerHTML = createRelationalScheduleBuilder();
                initRelationalBuilder();
            }
        }
        
        function createRelationalScheduleBuilder() {
            // Get sync summary for display
            const summary = typeof getAllDataSummary === 'function' ? getAllDataSummary() : { totalProviders: 0, totalClinics: 0, totalRooms: 0 };
            
            return `
                <style>
                    .rsb-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; }
                    .rsb-header { position: absolute; top: 0; left: 0; right: 0; height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; z-index: 100; }
                    .rsb-title { font-size: 1.2rem; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 0.75rem; }
                    .rsb-header-actions { display: flex; gap: 0.75rem; align-items: center; }
                    .rsb-btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
                    .rsb-btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; }
                    .rsb-btn-secondary { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; }
                    .rsb-btn-danger { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; }
                    .rsb-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
                    .rsb-canvas { position: absolute; top: 60px; left: 0; right: 0; bottom: 0; overflow: auto; padding: 2rem; }
                    .rsb-svg { position: absolute; top: 60px; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 50; }
                    .rsb-tables { display: flex; gap: 1.5rem; flex-wrap: wrap; padding-bottom: 100px; }
                    .rsb-table { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); min-width: 180px; overflow: hidden; border: 2px solid #e2e8f0; transition: all 0.2s; }
                    .rsb-table.highlight { border-color: #0891b2; box-shadow: 0 4px 15px -1px rgba(8,145,178,0.3); }
                    .rsb-table-header { padding: 0.75rem 1rem; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; }
                    .rsb-table-provider .rsb-table-header { background: #dcfce7; color: #166534; }
                    .rsb-table-clinic .rsb-table-header { background: #fef3c7; color: #92400e; }
                    .rsb-table-room .rsb-table-header { background: #ede9fe; color: #5b21b6; }
                    .rsb-table-assistant .rsb-table-header { background: #fce7f3; color: #9d174d; }
                    .rsb-table-dates .rsb-table-header { background: #fee2e2; color: #991b1b; }
                    .rsb-table-time .rsb-table-header { background: #cffafe; color: #155e75; }
                    .rsb-row { padding: 0.6rem 1rem; border-top: 1px solid #f1f5f9; font-size: 0.85rem; color: #334155; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 0.5rem; position: relative; }
                    .rsb-row:hover { background: #f8fafc; }
                    .rsb-row.selected { background: #f0fdfa; }
                    .rsb-row.connected { background: #dcfce7; }
                    .rsb-row-dot { width: 10px; height: 10px; border-radius: 50%; background: #e2e8f0; flex-shrink: 0; transition: all 0.2s; }
                    .rsb-row:hover .rsb-row-dot { background: #0891b2; transform: scale(1.3); }
                    .rsb-row.connected .rsb-row-dot { background: #10b981; }
                    .rsb-row.conflict { background: #fef2f2; opacity: 0.7; }
                    .rsb-row.conflict .rsb-row-dot { background: #ef4444; }
                    .rsb-row.conflict:hover { background: #fee2e2; }
                    .rsb-row.hidden { display: none; }
                    .rsb-row.dimmed { opacity: 0.4; }
                    .rsb-row-text { flex: 1; }
                    .rsb-row-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; margin-left: auto; }
                    .rsb-row-badge.conflict { background: #fee2e2; color: #dc2626; }
                    .rsb-row-badge.available { background: #dcfce7; color: #166534; }
                    .rsb-row-badge.booked { background: #fef3c7; color: #92400e; }
                    .rsb-conflict-warning { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 0.75rem 1.25rem; color: #dc2626; font-size: 0.8rem; z-index: 201; display: none; flex-direction: column; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); white-space: pre-line; max-width: 500px; max-height: 200px; overflow-y: auto; }
                    .rsb-conflict-warning .rsb-warning-header { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; border-bottom: 1px solid #fecaca; padding-bottom: 0.5rem; margin-bottom: 0.25rem; }
                    .rsb-conflict-warning .rsb-warning-list { font-size: 0.75rem; line-height: 1.4; }
                    .rsb-conflict-warning .rsb-warning-item { padding: 0.25rem 0; border-bottom: 1px dashed #fecaca; }
                    .rsb-conflict-warning .rsb-warning-item:last-child { border-bottom: none; }
                    .rsb-conflict-warning.success { background: #f0fdf4; border-color: #86efac; color: #166534; }
                    .rsb-conflict-warning .rsb-close-warning { position: absolute; top: 5px; right: 8px; background: none; border: none; cursor: pointer; font-size: 1rem; color: inherit; opacity: 0.6; }
                    .rsb-conflict-warning .rsb-close-warning:hover { opacity: 1; }
                    .rsb-conflict-warning.show { display: flex; }
                    .rsb-schedule-preview { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2); border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 1.5rem; z-index: 200; }
                    .rsb-preview-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: #64748b; }
                    .rsb-preview-item.filled { color: #10b981; font-weight: 600; }
                    .rsb-preview-item i { width: 18px; }
                    .rsb-instructions { position: absolute; top: 75px; left: 50%; transform: translateX(-50%); background: white; padding: 0.6rem 1.2rem; border-radius: 20px; font-size: 0.8rem; color: #64748b; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 100; }
                    .rsb-date-input { width: 100%; padding: 0.4rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; margin-top: 0.3rem; }
                    .rsb-sync-badge { display: flex; align-items: center; gap: 0.5rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 20px; padding: 0.3rem 0.8rem; font-size: 0.7rem; color: #166534; }
                    .rsb-sync-badge i { color: #10b981; }
                </style>
                
                <div class="rsb-container">
                    
                    <div class="rsb-header">
                        <div class="rsb-title">
                            <i class="fas fa-project-diagram" style="color: #0891b2;"></i>
                            Relational Schedule Builder
                            <span style="font-size: 0.7rem; font-weight: 500; background: ${sbMode === 'provider' ? '#dcfce7' : '#fce7f3'}; color: ${sbMode === 'provider' ? '#166534' : '#9d174d'}; padding: 3px 10px; border-radius: 20px;">${sbMode === 'provider' ? 'Provider Mode' : 'Employee Mode'}</span>
                            <span class="rsb-sync-badge" title="Data synced from master database"><i class="fas fa-sync-alt"></i> Synced: ${summary.totalProviders} Providers â€¢ ${summary.totalClinics} Clinics â€¢ ${summary.totalRooms} Rooms</span>
                        </div>
                        <div class="rsb-header-actions">
                            <button class="rsb-btn rsb-btn-secondary" onclick="rsbClearAll()"><i class="fas fa-redo"></i> Clear</button>
                            <button class="rsb-btn rsb-btn-primary" id="rsbCreateBtn" onclick="rsbCreateSchedule()" style="display: none;"><i class="fas fa-check"></i> Create Schedule</button>
                            <button class="rsb-btn rsb-btn-danger" onclick="closeScheduleManagerDynamic()"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    
                    <div class="rsb-instructions">
                        <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                        Click rows to select/unselect. Badges show existing shifts. Rooms are filtered by clinic. Conflicts are validated automatically.
                    </div>
                    
                    <div class="rsb-canvas" id="rsbCanvas">
                        <div class="rsb-tables" id="rsbTables"></div>
                    </div>
                    
                    <div class="rsb-conflict-warning" id="rsbConflictWarning">
                        <button class="rsb-close-warning" onclick="rsbHideConflictWarning()">&times;</button>
                        <div class="rsb-warning-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="rsbConflictHeader">Scheduling Conflicts</span>
                        </div>
                        <div class="rsb-warning-list" id="rsbConflictText"></div>
                    </div>
                    
                    <div class="rsb-schedule-preview" id="rsbPreview">
                        <div class="rsb-preview-item" id="rsbPrevProvider"><i class="fas fa-user-md"></i> <span>Provider</span></div>
                        <div class="rsb-preview-item" id="rsbPrevClinic"><i class="fas fa-hospital"></i> <span>Clinic</span></div>
                        <div class="rsb-preview-item" id="rsbPrevRoom"><i class="fas fa-door-open"></i> <span>Room</span></div>
                        <div class="rsb-preview-item" id="rsbPrevAssistant"><i class="fas fa-user-nurse"></i> <span>Assistant</span></div>
                        <div class="rsb-preview-item" id="rsbPrevDates"><i class="fas fa-calendar"></i> <span>Dates</span></div>
                        <div class="rsb-preview-item" id="rsbPrevTime"><i class="fas fa-clock"></i> <span>Time</span></div>
                    </div>
                </div>
            `;
        }
        
        // Relational Schedule Builder State
        let rsbState = {
            provider: null,
            clinic: null,
            room: null,
            rooms: [],
            assistant: null,
            assistants: [],
            startDate: null,
            endDate: null,
            days: [],
            time: null,
            selectedElements: {}
        };
        
        function initRelationalBuilder() {
            const tablesContainer = document.getElementById('rsbTables');
            
            // Get data from masterData (synced source of truth)
            const providers = window.masterData ? window.masterData.getProviders() : [];
            const assistants = window.masterData ? window.masterData.getAssistants() : [];
            const clinics = window.masterData ? window.masterData.clinics : [];
            const rooms = window.masterData ? window.masterData.rooms : [];
            const timeSlots = window.masterData ? window.masterData.timeSlots : [];
            
            // Define tables based on mode - using synced masterData
            const tables = [
                {
                    id: 'provider',
                    title: sbMode === 'provider' ? 'Providers' : 'Employees',
                    icon: sbMode === 'provider' ? 'fa-user-md' : 'fa-user-nurse',
                    class: 'rsb-table-provider',
                    rows: sbMode === 'provider' 
                        ? providers.map(p => ({ id: p.id, name: p.title }))
                        : assistants.map(a => ({ id: a.id, name: a.title }))
                },
                {
                    id: 'clinic',
                    title: 'Clinics',
                    icon: 'fa-hospital',
                    class: 'rsb-table-clinic',
                    rows: clinics.map(c => ({ id: c.id, name: c.name }))
                },
                {
                    id: 'room',
                    title: 'Rooms',
                    icon: 'fa-door-open',
                    class: 'rsb-table-room',
                    rows: rooms.map(r => ({ id: r.id, name: r.name, clinicId: r.clinicId }))
                },
                {
                    id: 'assistant',
                    title: sbMode === 'provider' ? 'Assistants' : 'Providers',
                    icon: sbMode === 'provider' ? 'fa-user-nurse' : 'fa-user-md',
                    class: 'rsb-table-assistant',
                    rows: sbMode === 'provider'
                        ? [...assistants.map(a => ({ id: a.id, name: a.title.split(' ')[0] })), { id: 'none', name: 'None' }]
                        : providers.map(p => ({ id: p.id, name: p.title.replace('Dr. ', 'Dr. ').split(' ').slice(0,2).join(' ') }))
                },
                {
                    id: 'dates',
                    title: 'Date Range',
                    icon: 'fa-calendar-alt',
                    class: 'rsb-table-dates',
                    isDatePicker: true
                },
                {
                    id: 'time',
                    title: 'Time Slots',
                    icon: 'fa-clock',
                    class: 'rsb-table-time',
                    rows: timeSlots.map(t => ({ id: t.id, name: t.name }))
                }
            ];
            
            // Render tables
            let html = '';
            tables.forEach(table => {
                html += `<div class="rsb-table ${table.class}" id="rsbTable_${table.id}" data-table="${table.id}">
                    <div class="rsb-table-header">
                        <i class="fas ${table.icon}"></i> ${table.title}
                    </div>`;
                
                if (table.isDatePicker) {
                    html += `
                        <div style="padding: 0.75rem;">
                            <label style="font-size: 0.75rem; color: #64748b;">Start Date</label>
                            <input type="date" class="rsb-date-input" id="rsbStartDate" onchange="rsbUpdateDates()">
                            <label style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem; display: block;">End Date</label>
                            <input type="date" class="rsb-date-input" id="rsbEndDate" onchange="rsbUpdateDates()">
                            <div style="margin-top: 0.75rem;">
                                <label style="font-size: 0.75rem; color: #64748b;">Working Days</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.3rem;">
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDayMon" onchange="rsbUpdateDates()"> Mon
                                    </label>
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDayTue" onchange="rsbUpdateDates()"> Tue
                                    </label>
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDayWed" onchange="rsbUpdateDates()"> Wed
                                    </label>
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDayThu" onchange="rsbUpdateDates()"> Thu
                                    </label>
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDayFri" onchange="rsbUpdateDates()"> Fri
                                    </label>
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDaySat" onchange="rsbUpdateDates()"> Sat
                                    </label>
                                    <label style="font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                        <input type="checkbox" id="rsbDaySun" onchange="rsbUpdateDates()"> Sun
                                    </label>
                                </div>
                            </div>
                        </div>`;
                } else {
                    table.rows.forEach(row => {
                        let extraAttrs = '';
                        if (row.clinicId) {
                            extraAttrs = ` data-clinic-id="${row.clinicId}"`;
                        }
                        html += `<div class="rsb-row" id="rsbRow_${row.id}" data-table="${table.id}" data-id="${row.id}" data-name="${row.name}"${extraAttrs} onclick="rsbSelectRow(this)">
                            <div class="rsb-row-dot"></div>
                            <span class="rsb-row-text">${row.name}</span>
                            <span class="rsb-row-badge" style="display:none;"></span>
                        </div>`;
                    });
                }
                
                html += '</div>';
            });
            
            tablesContainer.innerHTML = html;
            
            // Initialize conflict badges after rendering
            setTimeout(() => {
                rsbUpdateProviderBadges();
                rsbUpdateAssistantBadges();
            }, 100);
        }
        
        function rsbSelectRow(element) {
            const table = element.dataset.table;
            const id = element.dataset.id;
            const name = element.dataset.name;
            const rowElement = document.getElementById('rsbRow_' + id);
            
            // Check if this row is already selected - if so, unselect it
            if (rowElement.classList.contains('connected')) {
                rsbUnselectRow(table, id, name);
            } else {
                // Select the row
                rsbSetValue(table, id, name, element);
            }
        }
        
        function rsbUnselectRow(table, id, name) {
            const rowElement = document.getElementById('rsbRow_' + id);
            rowElement.classList.remove('connected');
            
            // Clear the state for this table
            delete rsbState.selectedElements[table];
            
            if (table === 'provider') {
                rsbState.provider = null;
                document.getElementById('rsbPrevProvider').classList.remove('filled');
                document.getElementById('rsbPrevProvider').querySelector('span').textContent = 'Provider';
            } else if (table === 'clinic') {
                rsbState.clinic = null;
                document.getElementById('rsbPrevClinic').classList.remove('filled');
                document.getElementById('rsbPrevClinic').querySelector('span').textContent = 'Clinic';
                
                // Reset room filtering when clinic is deselected
                rsbResetRoomFiltering();
            } else if (table === 'room') {
                // Remove this room from the array
                const idx = rsbState.rooms.indexOf(name);
                if (idx > -1) {
                    rsbState.rooms.splice(idx, 1);
                }
                rsbState.room = rsbState.rooms.length > 0 ? rsbState.rooms.join(', ') : null;
                if (rsbState.rooms.length === 0) {
                    document.getElementById('rsbPrevRoom').classList.remove('filled');
                    document.getElementById('rsbPrevRoom').querySelector('span').textContent = 'Room';
                } else {
                    document.getElementById('rsbPrevRoom').querySelector('span').textContent = rsbState.rooms.length > 1 ? rsbState.rooms.length + ' rooms' : rsbState.rooms[0];
                }
            } else if (table === 'assistant') {
                // Remove this assistant from the array
                const idx = rsbState.assistants.indexOf(name);
                if (idx > -1) {
                    rsbState.assistants.splice(idx, 1);
                }
                rsbState.assistant = rsbState.assistants.length > 0 ? rsbState.assistants.join(', ') : null;
                if (rsbState.assistants.length === 0) {
                    document.getElementById('rsbPrevAssistant').classList.remove('filled');
                    document.getElementById('rsbPrevAssistant').querySelector('span').textContent = 'Assistant';
                } else {
                    document.getElementById('rsbPrevAssistant').querySelector('span').textContent = rsbState.assistants.length > 1 ? rsbState.assistants.length + ' selected' : rsbState.assistants[0];
                }
            } else if (table === 'time') {
                rsbState.time = null;
                document.getElementById('rsbPrevTime').classList.remove('filled');
                document.getElementById('rsbPrevTime').querySelector('span').textContent = 'Time';
                rsbClearConflicts('time');
            }
            
            // Refresh conflicts based on remaining selections
            rsbUpdateAllConflicts();
            
            // Hide create button if incomplete
            rsbCheckComplete();
        }
        
        function rsbSetValue(table, id, name, element) {
            // Get the element if not passed
            const rowElement = element || document.getElementById('rsbRow_' + id);
            
            // Store the selected element for this table
            rsbState.selectedElements[table] = { id, name, element: rowElement };
            
            if (table === 'provider') {
                rsbState.provider = name;
                document.getElementById('rsbPrevProvider').classList.add('filled');
                document.getElementById('rsbPrevProvider').querySelector('span').textContent = name.split(' ')[0];
                
                // Clear old provider conflicts and check new ones
                rsbClearConflicts('provider');
                const conflicts = rsbCheckProviderConflicts(name);
                conflicts.forEach(c => {
                    rsbAddConflict('provider', {
                        name: name.split(' ')[0],
                        days: c.days?.join(', ') || 'N/A',
                        time: `${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)}`,
                        location: c.clinic || ''
                    });
                });
            } else if (table === 'clinic') {
                rsbState.clinic = name;
                document.getElementById('rsbPrevClinic').classList.add('filled');
                document.getElementById('rsbPrevClinic').querySelector('span').textContent = name.split(' ')[0];
                
                // Filter rooms by selected clinic
                rsbFilterRoomsByClinic(name);
            } else if (table === 'room') {
                // Support multiple rooms
                if (!rsbState.rooms.includes(name)) {
                    rsbState.rooms.push(name);
                }
                rsbState.room = rsbState.rooms.join(', ');
                document.getElementById('rsbPrevRoom').classList.add('filled');
                document.getElementById('rsbPrevRoom').querySelector('span').textContent = rsbState.rooms.length > 1 ? rsbState.rooms.length + ' rooms' : name;
                
                // Clear old room conflicts and check new ones for all selected rooms
                rsbClearConflicts('room');
                rsbState.rooms.forEach(roomName => {
                    const conflicts = rsbCheckRoomAvailability(roomName);
                    conflicts.forEach(c => {
                        rsbAddConflict('room', {
                            name: roomName,
                            days: c.days?.join(', ') || 'N/A',
                            time: `${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)}`,
                            location: c.name || ''
                        });
                    });
                });
            } else if (table === 'assistant') {
                // Support multiple assistants
                if (!rsbState.assistants.includes(name)) {
                    rsbState.assistants.push(name);
                }
                rsbState.assistant = rsbState.assistants.join(', ');
                document.getElementById('rsbPrevAssistant').classList.add('filled');
                document.getElementById('rsbPrevAssistant').querySelector('span').textContent = rsbState.assistants.length > 1 ? rsbState.assistants.length + ' selected' : name;
                
                // Check assistant conflicts (if not "None") - add to tracking
                if (name !== 'None') {
                    const conflicts = rsbCheckAssistantConflicts(name);
                    conflicts.forEach(c => {
                        rsbAddConflict('assistant', {
                            name: name,
                            days: c.days?.join(', ') || 'N/A',
                            time: `${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)}`,
                            location: c.clinic || ''
                        });
                    });
                }
            } else if (table === 'time') {
                rsbState.time = name;
                document.getElementById('rsbPrevTime').classList.add('filled');
                document.getElementById('rsbPrevTime').querySelector('span').textContent = name.split(' ')[0];
                
                // Update all conflicts with time filter applied
                rsbUpdateAllConflicts();
            }
            
            // Mark row as connected
            document.getElementById('rsbRow_' + id).classList.add('connected');
            
            rsbCheckComplete();
        }
        
        function rsbUpdateDates() {
            const startDate = document.getElementById('rsbStartDate').value;
            const endDate = document.getElementById('rsbEndDate').value;
            const days = [];
            
            if (document.getElementById('rsbDayMon').checked) days.push('Mon');
            if (document.getElementById('rsbDayTue').checked) days.push('Tue');
            if (document.getElementById('rsbDayWed').checked) days.push('Wed');
            if (document.getElementById('rsbDayThu').checked) days.push('Thu');
            if (document.getElementById('rsbDayFri').checked) days.push('Fri');
            if (document.getElementById('rsbDaySat').checked) days.push('Sat');
            if (document.getElementById('rsbDaySun').checked) days.push('Sun');
            
            rsbState.startDate = startDate;
            rsbState.endDate = endDate;
            rsbState.days = days;
            
            if (startDate && endDate && days.length > 0) {
                document.getElementById('rsbPrevDates').classList.add('filled');
                const start = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('rsbPrevDates').querySelector('span').textContent = start + ' +';
                document.getElementById('rsbTable_dates').classList.add('highlight');
                
                // Re-evaluate all conflicts based on new date selection
                rsbUpdateAllConflicts();
                
                // Update time slot badges to show conflicts
                rsbUpdateTimeSlotBadges();
            } else {
                document.getElementById('rsbPrevDates').classList.remove('filled');
                document.getElementById('rsbPrevDates').querySelector('span').textContent = 'Dates';
                document.getElementById('rsbTable_dates').classList.remove('highlight');
                
                // Reset time slot badges and re-check conflicts
                rsbResetTimeSlotBadges();
                rsbUpdateAllConflicts();
            }
            
            rsbCheckComplete();
        }
        
        function rsbCheckComplete() {
            const hasProvider = rsbState.provider !== null;
            const hasClinic = rsbState.clinic !== null;
            const hasRoom = rsbState.rooms.length > 0;
            const hasAssistant = rsbState.assistant !== null;
            const hasDates = rsbState.startDate && rsbState.endDate && rsbState.days.length > 0;
            const hasTime = rsbState.time !== null;
            
            if (hasProvider && hasClinic && hasRoom && hasAssistant && hasDates && hasTime) {
                document.getElementById('rsbCreateBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('rsbCreateBtn').style.display = 'none';
            }
        }
        
        function rsbClearAll() {
            rsbState = {
                provider: null,
                clinic: null,
                room: null,
                rooms: [],
                assistant: null,
                assistants: [],
                startDate: null,
                endDate: null,
                days: [],
                time: null,
                selectedElements: {}
            };
            
            // Clear UI
            document.querySelectorAll('.rsb-row').forEach(r => r.classList.remove('selected', 'connected'));
            document.querySelectorAll('.rsb-preview-item').forEach(p => {
                p.classList.remove('filled');
            });
            document.getElementById('rsbPrevProvider').querySelector('span').textContent = 'Provider';
            document.getElementById('rsbPrevClinic').querySelector('span').textContent = 'Clinic';
            document.getElementById('rsbPrevRoom').querySelector('span').textContent = 'Room';
            document.getElementById('rsbPrevAssistant').querySelector('span').textContent = 'Assistant';
            document.getElementById('rsbPrevDates').querySelector('span').textContent = 'Dates';
            document.getElementById('rsbPrevTime').querySelector('span').textContent = 'Time';
            document.getElementById('rsbCreateBtn').style.display = 'none';
            document.getElementById('rsbStartDate').value = '';
            document.getElementById('rsbEndDate').value = '';
            document.querySelectorAll('[id^="rsbDay"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('.rsb-table').forEach(t => t.classList.remove('highlight'));
            
            // Reset validation states
            document.querySelectorAll('.rsb-row').forEach(r => {
                r.classList.remove('conflict', 'dimmed', 'hidden');
                const badge = r.querySelector('.rsb-row-badge');
                if (badge) badge.style.display = 'none';
            });
            
            // Clear all tracked conflicts
            rsbCurrentConflicts = { provider: [], room: [], assistant: [], time: [] };
            rsbHideConflictWarning();
        }
        
        // ======================
        // Scheduling Validations
        // ======================
        
        // Track all current conflicts
        let rsbCurrentConflicts = {
            provider: [],
            room: [],
            assistant: [],
            time: []
        };
        
        function rsbShowConflictWarning(message, category = 'general') {
            // No auto-hide - stays visible until cleared
            rsbRefreshConflictPanel();
        }
        
        function rsbAddConflict(category, conflictData) {
            if (!rsbCurrentConflicts[category]) {
                rsbCurrentConflicts[category] = [];
            }
            // Avoid duplicates
            const exists = rsbCurrentConflicts[category].some(c => 
                c.name === conflictData.name && c.time === conflictData.time && c.days === conflictData.days
            );
            if (!exists) {
                rsbCurrentConflicts[category].push(conflictData);
            }
            rsbRefreshConflictPanel();
        }
        
        function rsbClearConflicts(category) {
            if (category) {
                rsbCurrentConflicts[category] = [];
            } else {
                rsbCurrentConflicts = { provider: [], room: [], assistant: [], time: [] };
            }
            rsbRefreshConflictPanel();
        }
        
        function rsbRefreshConflictPanel() {
            const warning = document.getElementById('rsbConflictWarning');
            const header = document.getElementById('rsbConflictHeader');
            const text = document.getElementById('rsbConflictText');
            if (!warning || !text) return;
            
            const allConflicts = [
                ...rsbCurrentConflicts.provider.map(c => ({ ...c, type: 'Provider' })),
                ...rsbCurrentConflicts.room.map(c => ({ ...c, type: 'Room' })),
                ...rsbCurrentConflicts.assistant.map(c => ({ ...c, type: 'Assistant' })),
                ...rsbCurrentConflicts.time.map(c => ({ ...c, type: 'Time' }))
            ];
            
            if (allConflicts.length === 0) {
                warning.classList.remove('show');
                return;
            }
            
            // Build conflict list HTML
            let html = '';
            allConflicts.forEach(c => {
                const icon = c.type === 'Provider' ? 'ðŸ‘¨â€âš•ï¸' : 
                            c.type === 'Room' ? 'ðŸšª' : 
                            c.type === 'Assistant' ? 'ðŸ‘©â€âš•ï¸' : 'â°';
                html += `<div class="rsb-warning-item">${icon} <strong>${c.type}:</strong> ${c.name} - ${c.days} ${c.time} ${c.location ? 'at ' + c.location : ''}</div>`;
            });
            
            header.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${allConflicts.length} Conflict${allConflicts.length > 1 ? 's' : ''} Found`;
            text.innerHTML = html;
            warning.classList.remove('success');
            warning.classList.add('show');
        }
        
        function rsbHideConflictWarning() {
            const warning = document.getElementById('rsbConflictWarning');
            if (warning) warning.classList.remove('show');
        }
        
        function rsbShowSuccessPanel() {
            const warning = document.getElementById('rsbConflictWarning');
            const header = document.getElementById('rsbConflictHeader');
            const text = document.getElementById('rsbConflictText');
            if (!warning || !text) return;
            
            header.innerHTML = '<i class="fas fa-check-circle"></i> No Conflicts!';
            text.innerHTML = '<div class="rsb-warning-item">âœ… All selections are clear - ready to create schedule</div>';
            warning.classList.remove('show');
            warning.classList.add('success', 'show');
        }
        
        // 1. Filter rooms by selected clinic
        function rsbFilterRoomsByClinic(clinicName) {
            const roomTable = document.getElementById('rsbTable_room');
            if (!roomTable) return;
            
            const clinicData = window.masterData?.getClinicByName(clinicName);
            const clinicId = clinicData?.id;
            
            const rooms = roomTable.querySelectorAll('.rsb-row');
            rooms.forEach(room => {
                const roomClinicId = room.dataset.clinicId;
                const badge = room.querySelector('.rsb-row-badge');
                
                if (clinicId && roomClinicId) {
                    if (roomClinicId === clinicId) {
                        room.classList.remove('dimmed');
                        if (badge) {
                            badge.textContent = 'âœ“ Match';
                            badge.className = 'rsb-row-badge available';
                            badge.style.display = 'inline';
                        }
                    } else {
                        room.classList.add('dimmed');
                        if (badge) {
                            badge.textContent = 'Other Clinic';
                            badge.className = 'rsb-row-badge';
                            badge.style.display = 'inline';
                            badge.style.background = '#f1f5f9';
                            badge.style.color = '#64748b';
                        }
                    }
                } else {
                    room.classList.remove('dimmed');
                    if (badge) badge.style.display = 'none';
                }
            });
        }
        
        // Reset room filtering when clinic is deselected
        function rsbResetRoomFiltering() {
            const roomTable = document.getElementById('rsbTable_room');
            if (!roomTable) return;
            
            const rooms = roomTable.querySelectorAll('.rsb-row');
            rooms.forEach(room => {
                room.classList.remove('dimmed');
                const badge = room.querySelector('.rsb-row-badge');
                if (badge && !room.classList.contains('connected')) {
                    badge.style.display = 'none';
                }
            });
        }
        
        // Master function to update all conflicts based on current selection
        function rsbUpdateAllConflicts() {
            // Clear all existing conflicts
            rsbCurrentConflicts = { provider: [], room: [], assistant: [], time: [] };
            
            if (!window.myScheduleShifts) {
                rsbRefreshConflictPanel();
                return;
            }
            
            // Check provider conflicts
            if (rsbState.provider) {
                const conflicts = rsbCheckProviderConflicts(rsbState.provider);
                conflicts.forEach(c => {
                    // Only show if overlaps with selected dates/days/time
                    if (rsbIsRelevantConflict(c)) {
                        rsbCurrentConflicts.provider.push({
                            name: rsbState.provider.split(' ')[0],
                            days: rsbGetOverlappingDays(c),
                            time: `${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)}`,
                            location: c.clinic || ''
                        });
                    }
                });
            }
            
            // Check room conflicts
            if (rsbState.room) {
                const conflicts = rsbCheckRoomAvailability(rsbState.room);
                conflicts.forEach(c => {
                    if (rsbIsRelevantConflict(c)) {
                        rsbCurrentConflicts.room.push({
                            name: rsbState.room,
                            days: rsbGetOverlappingDays(c),
                            time: `${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)}`,
                            location: `by ${c.name || 'Unknown'}`
                        });
                    }
                });
            }
            
            // Check assistant conflicts
            rsbState.assistants.forEach(assistant => {
                if (assistant && assistant !== 'None') {
                    const conflicts = rsbCheckAssistantConflicts(assistant);
                    conflicts.forEach(c => {
                        if (rsbIsRelevantConflict(c)) {
                            rsbCurrentConflicts.assistant.push({
                                name: assistant,
                                days: rsbGetOverlappingDays(c),
                                time: `${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)}`,
                                location: c.clinic || ''
                            });
                        }
                    });
                }
            });
            
            // Show success if no conflicts and all required fields selected
            const totalConflicts = rsbCurrentConflicts.provider.length + 
                                   rsbCurrentConflicts.room.length + 
                                   rsbCurrentConflicts.assistant.length;
            
            if (totalConflicts === 0 && rsbState.provider && rsbState.room && rsbState.time && 
                rsbState.startDate && rsbState.endDate && rsbState.days.length > 0) {
                rsbShowSuccessPanel();
            } else {
                rsbRefreshConflictPanel();
            }
        }
        
        // Check if a conflict is relevant based on current date/day/time selection
        function rsbIsRelevantConflict(existingShift) {
            // If no dates selected, show all conflicts
            if (!rsbState.startDate || !rsbState.endDate || rsbState.days.length === 0) {
                return true;
            }
            
            // Check date overlap
            const selectedStart = new Date(rsbState.startDate);
            const selectedEnd = new Date(rsbState.endDate);
            const existingStart = new Date(existingShift.startDate);
            const existingEnd = new Date(existingShift.endDate);
            
            if (selectedEnd < existingStart || selectedStart > existingEnd) {
                return false; // No date overlap
            }
            
            // Check day overlap
            const dayOverlap = rsbState.days.some(day => existingShift.days?.includes(day));
            if (!dayOverlap) return false;
            
            // If time is selected, check time match
            if (rsbState.time) {
                const existingTime = `${existingShift.startTime} - ${existingShift.endTime}`;
                // Check if times overlap (simplified check)
                if (rsbState.time !== existingTime && !rsbState.time.includes(existingShift.startTime)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // Get the days that overlap between selection and existing shift
        function rsbGetOverlappingDays(existingShift) {
            if (!rsbState.days || rsbState.days.length === 0) {
                return existingShift.days?.join(', ') || 'N/A';
            }
            const overlapping = rsbState.days.filter(day => existingShift.days?.includes(day));
            return overlapping.length > 0 ? overlapping.join(', ') : existingShift.days?.join(', ') || 'N/A';
        }

        // 2. Check for provider scheduling conflicts
        function rsbCheckProviderConflicts(providerName) {
            if (!window.myScheduleShifts || !providerName) return [];
            
            const conflicts = window.myScheduleShifts.filter(shift => 
                shift.name === providerName || shift.name?.includes(providerName.split(' ')[1])
            );
            
            return conflicts;
        }
        
        // 3. Check for assistant scheduling conflicts
        function rsbCheckAssistantConflicts(assistantName) {
            if (!window.myScheduleShifts || !assistantName) return [];
            
            const conflicts = window.myScheduleShifts.filter(shift => 
                shift.assistant?.includes(assistantName)
            );
            
            return conflicts;
        }
        
        // 4. Check for room availability
        function rsbCheckRoomAvailability(roomName) {
            if (!window.myScheduleShifts || !roomName) return [];
            
            const conflicts = window.myScheduleShifts.filter(shift => 
                shift.room === roomName
            );
            
            return conflicts;
        }
        
        // 5. Check time overlap with selected dates/time
        function rsbCheckTimeOverlap(existingShift) {
            // Check if the existing shift overlaps with currently selected dates and time
            if (!rsbState.startDate || !rsbState.endDate || !rsbState.time) return false;
            
            const selectedStart = new Date(rsbState.startDate);
            const selectedEnd = new Date(rsbState.endDate);
            const existingStart = new Date(existingShift.startDate);
            const existingEnd = new Date(existingShift.endDate);
            
            // Check date range overlap
            if (selectedEnd < existingStart || selectedStart > existingEnd) {
                return false; // No date overlap
            }
            
            // Check day overlap
            const dayOverlap = rsbState.days.some(day => existingShift.days?.includes(day));
            if (!dayOverlap) return false;
            
            // Check time overlap (simplified - just compare time slots)
            if (rsbState.time === `${existingShift.startTime} - ${existingShift.endTime}`) {
                return true;
            }
            
            return true; // Has some overlap
        }
        
        // Update provider badges based on existing schedules
        function rsbUpdateProviderBadges() {
            const providerTable = document.getElementById('rsbTable_provider');
            if (!providerTable || !window.myScheduleShifts) return;
            
            const providers = providerTable.querySelectorAll('.rsb-row');
            providers.forEach(row => {
                const providerName = row.dataset.name;
                const badge = row.querySelector('.rsb-row-badge');
                const conflicts = rsbCheckProviderConflicts(providerName);
                
                if (conflicts.length > 0 && badge) {
                    badge.textContent = `${conflicts.length} shift${conflicts.length > 1 ? 's' : ''}`;
                    badge.className = 'rsb-row-badge booked';
                    badge.style.display = 'inline';
                } else if (badge) {
                    badge.style.display = 'none';
                }
            });
        }
        
        // Update assistant badges based on existing schedules
        function rsbUpdateAssistantBadges() {
            const assistantTable = document.getElementById('rsbTable_assistant');
            if (!assistantTable || !window.myScheduleShifts) return;
            
            const assistants = assistantTable.querySelectorAll('.rsb-row');
            assistants.forEach(row => {
                const assistantName = row.dataset.name;
                const badge = row.querySelector('.rsb-row-badge');
                
                if (assistantName === 'None') {
                    if (badge) badge.style.display = 'none';
                    return;
                }
                
                const conflicts = rsbCheckAssistantConflicts(assistantName);
                
                if (conflicts.length > 0 && badge) {
                    badge.textContent = `${conflicts.length} shift${conflicts.length > 1 ? 's' : ''}`;
                    badge.className = 'rsb-row-badge booked';
                    badge.style.display = 'inline';
                } else if (badge) {
                    badge.style.display = 'none';
                }
            });
        }
        
        // Validate current selection before creating schedule - with full details
        function rsbValidateSchedule() {
            const warnings = [];
            
            // Check provider conflicts with time overlap
            if (rsbState.provider) {
                const providerConflicts = rsbCheckProviderConflicts(rsbState.provider);
                const overlapping = providerConflicts.filter(c => rsbCheckTimeOverlap(c));
                if (overlapping.length > 0) {
                    const details = overlapping.map(c => 
                        `   â†’ ${c.days?.join(', ')} ${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)} at ${c.clinic}`
                    ).join('\n');
                    warnings.push(`ðŸ‘¨â€âš•ï¸ PROVIDER DOUBLE-BOOKED:\n   ${rsbState.provider} is already scheduled:\n${details}`);
                }
            }
            
            // Check assistant conflicts with time overlap
            if (rsbState.assistants.length > 0) {
                rsbState.assistants.forEach(assistant => {
                    if (assistant !== 'None') {
                        const assistantConflicts = rsbCheckAssistantConflicts(assistant);
                        const overlapping = assistantConflicts.filter(c => rsbCheckTimeOverlap(c));
                        if (overlapping.length > 0) {
                            const details = overlapping.map(c => 
                                `   â†’ ${c.days?.join(', ')} ${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)} at ${c.clinic}`
                            ).join('\n');
                            warnings.push(`ðŸ‘©â€âš•ï¸ ASSISTANT DOUBLE-BOOKED:\n   ${assistant} is already assigned:\n${details}`);
                        }
                    }
                });
            }
            
            // Check room availability with time overlap
            if (rsbState.room) {
                const roomConflicts = rsbCheckRoomAvailability(rsbState.room);
                const overlapping = roomConflicts.filter(c => rsbCheckTimeOverlap(c));
                if (overlapping.length > 0) {
                    const details = overlapping.map(c => 
                        `   â†’ ${c.days?.join(', ')} ${convertTo12Hour(c.startTime)}-${convertTo12Hour(c.endTime)} (${c.name})`
                    ).join('\n');
                    warnings.push(`ðŸšª ROOM DOUBLE-BOOKED:\n   ${rsbState.room} is already reserved:\n${details}`);
                }
            }
            
            return warnings;
        }
        
        // Check full conflicts when dates or time selected - shows real-time overlaps
        function rsbCheckFullConflicts(trigger) {
            if (!window.myScheduleShifts) return;
            
            const conflicts = [];
            
            // Only check if we have enough info
            if (!rsbState.startDate || !rsbState.endDate || rsbState.days.length === 0) return;
            
            // Check provider conflicts
            if (rsbState.provider) {
                const providerConflicts = rsbCheckProviderConflicts(rsbState.provider);
                providerConflicts.forEach(c => {
                    if (rsbCheckDateDayOverlap(c)) {
                        const timeMatch = rsbState.time ? rsbCheckTimeMatch(c) : true;
                        if (timeMatch || !rsbState.time) {
                            conflicts.push({
                                type: 'Provider',
                                name: rsbState.provider.split(' ')[0],
                                shift: c
                            });
                        }
                    }
                });
            }
            
            // Check room conflicts
            if (rsbState.room) {
                const roomConflicts = rsbCheckRoomAvailability(rsbState.room);
                roomConflicts.forEach(c => {
                    if (rsbCheckDateDayOverlap(c)) {
                        const timeMatch = rsbState.time ? rsbCheckTimeMatch(c) : true;
                        if (timeMatch || !rsbState.time) {
                            conflicts.push({
                                type: 'Room',
                                name: rsbState.room,
                                shift: c
                            });
                        }
                    }
                });
            }
            
            // Check assistant conflicts
            rsbState.assistants.forEach(assistant => {
                if (assistant !== 'None') {
                    const assistantConflicts = rsbCheckAssistantConflicts(assistant);
                    assistantConflicts.forEach(c => {
                        if (rsbCheckDateDayOverlap(c)) {
                            const timeMatch = rsbState.time ? rsbCheckTimeMatch(c) : true;
                            if (timeMatch || !rsbState.time) {
                                conflicts.push({
                                    type: 'Assistant',
                                    name: assistant,
                                    shift: c
                                });
                            }
                        }
                    });
                }
            });
            
            if (conflicts.length > 0) {
                const conflictDetails = conflicts.map(c => {
                    const dayMatch = rsbState.days.filter(d => c.shift.days?.includes(d)).join(', ');
                    return `â€¢ ${c.type} ${c.name}: ${dayMatch} ${c.shift.startTime}-${c.shift.endTime}`;
                }).join('\n');
                
                const headerText = trigger === 'time' 
                    ? `â° Time conflicts detected!` 
                    : `ðŸ“… Date/day conflicts found!`;
                    
                rsbShowConflictWarning(`${headerText}\n${conflictDetails}`);
            } else {
                // Show success if all selections are complete with no conflicts
                if (rsbState.provider && rsbState.room && rsbState.time) {
                    rsbShowSuccessMessage('âœ… No conflicts found - Schedule is clear!');
                }
            }
        }
        
        // Check if date ranges and days overlap (without time)
        function rsbCheckDateDayOverlap(existingShift) {
            if (!rsbState.startDate || !rsbState.endDate) return false;
            
            const selectedStart = new Date(rsbState.startDate);
            const selectedEnd = new Date(rsbState.endDate);
            const existingStart = new Date(existingShift.startDate);
            const existingEnd = new Date(existingShift.endDate);
            
            // Check date range overlap
            if (selectedEnd < existingStart || selectedStart > existingEnd) {
                return false;
            }
            
            // Check day overlap
            const dayOverlap = rsbState.days.some(day => existingShift.days?.includes(day));
            return dayOverlap;
        }
        
        // Check if time slots match
        function rsbCheckTimeMatch(existingShift) {
            if (!rsbState.time) return false;
            const existingTime = `${existingShift.startTime} - ${existingShift.endTime}`;
            return rsbState.time === existingTime || rsbState.time.includes(existingShift.startTime);
        }
        
        // Show success message (green)
        function rsbShowSuccessMessage(message) {
            const warning = document.getElementById('rsbConflictWarning');
            const text = document.getElementById('rsbConflictText');
            if (warning && text) {
                text.textContent = message;
                warning.style.background = '#f0fdf4';
                warning.style.borderColor = '#86efac';
                warning.style.color = '#166534';
                warning.classList.add('show');
                setTimeout(() => {
                    rsbHideConflictWarning();
                    warning.style.background = '#fef2f2';
                    warning.style.borderColor = '#fecaca';
                    warning.style.color = '#dc2626';
                }, 3000);
            }
        }
        
        // Update time slot badges to show which have conflicts
        function rsbUpdateTimeSlotBadges() {
            const timeTable = document.getElementById('rsbTable_time');
            if (!timeTable || !window.myScheduleShifts) return;
            
            const timeSlots = timeTable.querySelectorAll('.rsb-row');
            timeSlots.forEach(row => {
                const timeName = row.dataset.name;
                const badge = row.querySelector('.rsb-row-badge');
                
                // Temporarily set time to check conflicts
                const originalTime = rsbState.time;
                rsbState.time = timeName;
                
                let hasConflict = false;
                let conflictCount = 0;
                
                // Check provider
                if (rsbState.provider) {
                    const conflicts = rsbCheckProviderConflicts(rsbState.provider).filter(c => 
                        rsbCheckDateDayOverlap(c) && rsbCheckTimeMatch(c)
                    );
                    if (conflicts.length > 0) {
                        hasConflict = true;
                        conflictCount += conflicts.length;
                    }
                }
                
                // Check room
                if (rsbState.room) {
                    const conflicts = rsbCheckRoomAvailability(rsbState.room).filter(c => 
                        rsbCheckDateDayOverlap(c) && rsbCheckTimeMatch(c)
                    );
                    if (conflicts.length > 0) {
                        hasConflict = true;
                        conflictCount += conflicts.length;
                    }
                }
                
                // Check assistants
                rsbState.assistants.forEach(assistant => {
                    if (assistant !== 'None') {
                        const conflicts = rsbCheckAssistantConflicts(assistant).filter(c => 
                            rsbCheckDateDayOverlap(c) && rsbCheckTimeMatch(c)
                        );
                        if (conflicts.length > 0) {
                            hasConflict = true;
                            conflictCount += conflicts.length;
                        }
                    }
                });
                
                // Restore original time
                rsbState.time = originalTime;
                
                if (badge) {
                    if (hasConflict) {
                        badge.textContent = `${conflictCount} conflict${conflictCount > 1 ? 's' : ''}`;
                        badge.className = 'rsb-row-badge conflict';
                        badge.style.display = 'inline';
                        row.classList.add('conflict');
                    } else {
                        badge.textContent = 'âœ“ Clear';
                        badge.className = 'rsb-row-badge available';
                        badge.style.display = 'inline';
                        row.classList.remove('conflict');
                    }
                }
            });
        }
        
        // Reset time slot badges
        function rsbResetTimeSlotBadges() {
            const timeTable = document.getElementById('rsbTable_time');
            if (!timeTable) return;
            
            const timeSlots = timeTable.querySelectorAll('.rsb-row');
            timeSlots.forEach(row => {
                const badge = row.querySelector('.rsb-row-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
                row.classList.remove('conflict');
            });
        }
        
        function rsbCreateSchedule() {
            // Validate schedule before creating
            const warnings = rsbValidateSchedule();
            
            if (warnings.length > 0) {
                // Build a clearer warning message
                let warningMessage = 'âš ï¸ SCHEDULING CONFLICTS DETECTED âš ï¸\n\n';
                warningMessage += 'The following overlaps will occur:\n';
                warningMessage += 'â”€'.repeat(40) + '\n';
                warningMessage += warnings.join('\n\n');
                warningMessage += '\n' + 'â”€'.repeat(40) + '\n\n';
                warningMessage += 'ðŸ“Œ IMPORTANT: If you continue, the NEW schedule will be ADDED.\n';
                warningMessage += '   Existing schedules will NOT be modified or removed.\n';
                warningMessage += '   This means double-booking WILL occur.\n\n';
                warningMessage += 'Do you want to create this schedule anyway?';
                
                const proceed = confirm(warningMessage);
                if (!proceed) return;
            }
            
            const dateRange = rsbState.startDate && rsbState.endDate 
                ? `${new Date(rsbState.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} to ${new Date(rsbState.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`
                : 'N/A';
            
            const primaryLabel = sbMode === 'provider' ? 'Provider' : 'Employee';
            const secondaryLabel = sbMode === 'provider' ? 'Assistant(s)' : 'Provider(s)';
            
            // Parse time slot to get start and end times (convert 12-hour to 24-hour format)
            const timeParts = rsbState.time ? rsbState.time.split(' - ') : ['8:00 AM', '4:00 PM'];
            
            function convertTo24Hour(time12) {
                if (!time12) return '08:00';
                const match = time12.trim().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
                if (!match) return time12; // Already in 24-hour format
                let hours = parseInt(match[1]);
                const minutes = match[2];
                const period = match[3].toUpperCase();
                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;
                return `${hours.toString().padStart(2, '0')}:${minutes}`;
            }
            
            const startTime = convertTo24Hour(timeParts[0]?.trim()) || '08:00';
            const endTime = convertTo24Hour(timeParts[1]?.trim()) || '16:00';
            
            // Get clinic color from masterData
            const clinicData = window.masterData?.getClinicByName(rsbState.clinic);
            const clinicColor = clinicData?.color || '#10b981';
            
            // Determine doctor and assistant based on mode
            // In Provider mode: provider = doctor, assistant = employee
            // In Employee mode: provider = employee, assistant = doctor(s)
            // We always want doctor as the main name on the calendar
            let doctorName, assistantName;
            if (sbMode === 'provider') {
                doctorName = rsbState.provider;
                assistantName = rsbState.assistant !== 'None' ? rsbState.assistant : null;
            } else {
                // Employee mode - swap: assistant field contains doctor(s), provider field contains employee
                doctorName = rsbState.assistant !== 'None' ? rsbState.assistant : rsbState.provider;
                assistantName = rsbState.assistant !== 'None' ? rsbState.provider : null;
            }
            
            // Get rooms to create schedules for (support multiple rooms)
            const roomsToCreate = rsbState.rooms.length > 0 ? rsbState.rooms : [rsbState.room];
            
            // Create one schedule per room
            const createdShifts = [];
            roomsToCreate.forEach((roomName, index) => {
                const newShift = {
                    id: 'shift-' + Date.now() + '-' + index,
                    name: doctorName,
                    role: 'Provider',
                    startTime: startTime,
                    endTime: endTime,
                    clinic: rsbState.clinic,
                    room: roomName,
                    assistant: assistantName,
                    days: [...rsbState.days],
                    color: clinicColor,
                    startDate: rsbState.startDate,
                    endDate: rsbState.endDate
                };
                
                // Add to global schedule array
                if (window.myScheduleShifts) {
                    window.myScheduleShifts.push(newShift);
                    createdShifts.push(newShift);
                }
            });
            
            // Refresh My Schedule calendar if function exists
            if (typeof window.renderMyScheduleCalendar === 'function') {
                window.renderMyScheduleCalendar();
            }
            
            const roomsDisplay = roomsToCreate.join(', ');
            alert(`âœ… Schedule Created Successfully!\n\n${primaryLabel}: ${rsbState.provider}\nClinic: ${rsbState.clinic}\nRoom(s): ${roomsDisplay}\n${secondaryLabel}: ${rsbState.assistant}\nDates: ${dateRange}\nDays: ${rsbState.days.join(', ')}\nTime: ${rsbState.time}\n\n${createdShifts.length} schedule(s) created.`);
            closeScheduleManagerDynamic();
        }
        
        // Keep the old function for reference
        function createScheduleBuilderHTML() {
            return `
                <style>
                    .sb-header { position: absolute; top: 0; left: 0; right: 0; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #e2e8f0; }
                    .sb-title { color: #0f172a; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
                    .sb-close { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; width: 36px; height: 36px; border-radius: 8px; font-size: 1.3rem; cursor: pointer; }
                    .sb-close:hover { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
                    .sb-stations-list { position: absolute; top: 70px; right: 20px; display: flex; flex-direction: column; gap: 8px; }
                    .sb-station { width: 160px; height: auto; padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.06); border: 2px solid #e2e8f0; }
                    .sb-station:hover { transform: translateX(-4px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
                    .sb-station.active { border-color: #0891b2; background: #f0fdfa; }
                    .sb-station.completed { opacity: 0.7; cursor: pointer; }
                    .sb-station.completed:hover { opacity: 1; background: #fefce8; border-color: #facc15; }
                    .sb-station-provider.active { border-color: #10b981; background: #f0fdf4; }
                    .sb-station-clinic.active { border-color: #f59e0b; background: #fffbeb; }
                    .sb-station-room.active { border-color: #8b5cf6; background: #faf5ff; }
                    .sb-station-assistant.active { border-color: #ec4899; background: #fdf2f8; }
                    .sb-station-date.active { border-color: #ef4444; background: #fef2f2; }
                    .sb-station-time.active { border-color: #0891b2; background: #f0fdfa; }
                    .sb-icon { font-size: 1.3rem; width: 28px; text-align: center; }
                    .sb-station-provider .sb-icon { color: #10b981; }
                    .sb-station-clinic .sb-icon { color: #f59e0b; }
                    .sb-station-room .sb-icon { color: #8b5cf6; }
                    .sb-station-assistant .sb-icon { color: #ec4899; }
                    .sb-station-date .sb-icon { color: #ef4444; }
                    .sb-station-time .sb-icon { color: #0891b2; }
                    .sb-station-text { flex: 1; text-align: left; }
                    .sb-label { font-weight: 600; font-size: 0.8rem; color: #334155; }
                    .sb-value { font-size: 0.7rem; color: #94a3b8; margin-top: 2px; }
                    .sb-panel { position: absolute; bottom: 0; left: 0; right: 200px; background: white; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s; max-height: 50vh; overflow-y: auto; border-top: 1px solid #e2e8f0; box-shadow: 0 -10px 15px -3px rgba(0,0,0,0.1); }
                    .sb-panel.open { transform: translateY(0); }
                    .sb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
                    .sb-item { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 1rem; cursor: pointer; text-align: center; color: #334155; transition: all 0.2s; position: relative; }
                    .sb-item:hover { background: #f0fdfa; border-color: #0891b2; transform: translateY(-2px); }
                    .sb-collected { position: absolute; top: 75px; left: 20px; background: white; border-radius: 12px; padding: 1rem 1.25rem; color: #334155; min-width: 220px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
                    .sb-progress { position: absolute; bottom: 20px; left: 140px; display: flex; gap: 8px; background: white; padding: 12px 20px; border-radius: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
                    .sb-dot { width: 12px; height: 12px; border-radius: 50%; background: #e2e8f0; transition: all 0.3s; }
                    .sb-dot.active { background: #0891b2; box-shadow: 0 0 8px rgba(8,145,178,0.5); }
                    .sb-dot.completed { background: #10b981; }
                    .sb-submit { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 0.9rem 2rem; font-size: 1rem; font-weight: 600; border-radius: 8px; cursor: pointer; display: none; box-shadow: 0 4px 6px -1px rgba(16,185,129,0.3); }
                    .sb-submit.visible { display: block; animation: sb-bounce 0.5s; }
                    @keyframes sb-bounce { 0% { transform: translateX(-50%) scale(0); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }
                    .sb-reset { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; padding: 0.4rem 0.9rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; margin-right: 8px; }
                    .sb-reset:hover { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
                    .sb-check { margin-left: auto; color: #10b981; font-size: 1rem; display: none; }
                    .sb-station.completed .sb-check { display: block; }
                </style>
                
                <div class="sb-header">
                    <div class="sb-title">
                        <i class="fas fa-calendar-check" style="color: #0891b2;"></i> 
                        Schedule Builder 
                        <span style="font-size: 0.75rem; font-weight: 500; background: ${sbMode === 'provider' ? '#dcfce7' : '#fce7f3'}; color: ${sbMode === 'provider' ? '#166534' : '#9d174d'}; padding: 4px 12px; border-radius: 20px;">${sbMode === 'provider' ? 'Provider First' : 'Employee First'}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <button class="sb-reset" onclick="resetScheduleBuilder()"><i class="fas fa-redo"></i> Reset</button>
                        <button class="sb-close" onclick="closeScheduleManagerDynamic()">&times;</button>
                    </div>
                </div>
                
                <!-- Hidden spans to keep IDs for JS compatibility -->
                <span id="sbProvider" style="display:none;"></span>
                <span id="sbClinic" style="display:none;"></span>
                <span id="sbRoom" style="display:none;"></span>
                <span id="sbAssistant" style="display:none;"></span>
                <span id="sbDays" style="display:none;"></span>
                <span id="sbTime" style="display:none;"></span>
                
                <!-- Vertical stations list on the right -->
                <div class="sb-stations-list">
                    <div class="sb-station sb-station-provider active" id="sbStationProvider" onclick="sbOpenPanel('provider')">
                        <i class="fas ${sbMode === 'provider' ? 'fa-user-md' : 'fa-user-nurse'} sb-icon"></i>
                        <div class="sb-station-text">
                            <div class="sb-label">${sbMode === 'provider' ? 'Provider' : 'Employee'}</div>
                            <div class="sb-value" id="sbStationProviderVal">Click to select</div>
                        </div>
                        <i class="fas fa-check sb-check"></i>
                    </div>
                    
                    <div class="sb-station sb-station-clinic" id="sbStationClinic">
                        <i class="fas fa-hospital sb-icon"></i>
                        <div class="sb-station-text">
                            <div class="sb-label">Clinic</div>
                            <div class="sb-value" id="sbStationClinicVal">Click to select</div>
                        </div>
                        <i class="fas fa-check sb-check"></i>
                    </div>
                    
                    <div class="sb-station sb-station-room" id="sbStationRoom">
                        <i class="fas fa-door-open sb-icon"></i>
                        <div class="sb-station-text">
                            <div class="sb-label">Room</div>
                            <div class="sb-value" id="sbStationRoomVal">Click to select</div>
                        </div>
                        <i class="fas fa-check sb-check"></i>
                    </div>
                    
                    <div class="sb-station sb-station-assistant" id="sbStationAssistant">
                        <i class="fas ${sbMode === 'provider' ? 'fa-user-nurse' : 'fa-user-md'} sb-icon"></i>
                        <div class="sb-station-text">
                            <div class="sb-label">${sbMode === 'provider' ? 'Assistant(s)' : 'Provider(s)'}</div>
                            <div class="sb-value" id="sbStationAssistantVal">Click to select</div>
                        </div>
                        <i class="fas fa-check sb-check"></i>
                    </div>
                    
                    <div class="sb-station sb-station-date" id="sbStationDate">
                        <i class="fas fa-calendar-alt sb-icon"></i>
                        <div class="sb-station-text">
                            <div class="sb-label">Dates</div>
                            <div class="sb-value" id="sbStationDateVal">Click to select</div>
                        </div>
                        <i class="fas fa-check sb-check"></i>
                    </div>
                    
                    <div class="sb-station sb-station-time" id="sbStationTime">
                        <i class="fas fa-clock sb-icon"></i>
                        <div class="sb-station-text">
                            <div class="sb-label">Time</div>
                            <div class="sb-value" id="sbStationTimeVal">Click to select</div>
                        </div>
                        <i class="fas fa-check sb-check"></i>
                    </div>
                </div>
                
                <div class="sb-progress">
                    <div class="sb-dot" id="sbDot0"></div>
                    <div class="sb-dot" id="sbDot1"></div>
                    <div class="sb-dot" id="sbDot2"></div>
                    <div class="sb-dot" id="sbDot3"></div>
                    <div class="sb-dot" id="sbDot4"></div>
                    <div class="sb-dot" id="sbDot5"></div>
                </div>
                
                <button class="sb-submit" id="sbSubmit" onclick="sbSubmitSchedule()"><i class="fas fa-check-circle"></i> Create Schedule</button>
                
                <div class="sb-panel" id="sbPanel">
                    <div style="color: #0f172a; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;" id="sbPanelTitle">Select an option</div>
                    <div class="sb-grid" id="sbPanelGrid"></div>
                </div>
            `;
        }
        
        // Schedule builder state
        let sbData = { provider: null, clinic: null, room: null, assistant: null, assistants: [], startDate: null, endDate: null, days: null, time: null };
        let sbStep = 0;
        const sbSteps = ['provider', 'clinic', 'room', 'assistant', 'date', 'time'];
        
        // Schedule builder game data - Loaded dynamically from masterData
        const sbGameData = {
            providers: [], // Will be populated from masterData.getProviders()
            clinics: [],   // Will be populated from masterData.clinics
            rooms: {},     // Will be populated from masterData.rooms
            times: ['8:00 AM - 12:00 PM', '8:00 AM - 4:00 PM', '9:00 AM - 5:00 PM', '12:00 PM - 8:00 PM', '2:00 PM - 10:00 PM'],
            assistants: [] // Will be populated from masterData.getAssistants()
        };
        
        // Initialize sbGameData from masterData
        function initializeSbGameData() {
            // Load providers
            const providers = masterData.getProviders();
            sbGameData.providers = providers.map(p => ({
                name: p.title,
                role: p.extendedProps?.role || 'Provider',
                needsAssistant: true
            }));
            
            // Load clinics
            sbGameData.clinics = masterData.clinics.map(c => ({
                name: c.name,
                color: c.color || '#10b981'
            }));
            
            // Load rooms by clinic
            sbGameData.rooms = {};
            masterData.clinics.forEach(c => {
                sbGameData.rooms[c.name] = masterData.getRoomsByClinic(c.id).map(r => r.name);
            });
            
            // Load assistants
            const assistants = masterData.getAssistants();
            sbGameData.assistants = assistants.map(a => ({
                name: a.title,
                role: a.extendedProps?.role || 'Assistant',
                worksAlone: a.extendedProps?.staffType !== 'clinical'
            }));
            sbGameData.assistants.push({ name: 'None', role: 'Provider works alone', worksAlone: false });
            
            console.log('âœ… Schedule Builder data initialized from masterData');
        }
        
        function initScheduleBuilder() {
            // Initialize data from masterData
            initializeSbGameData();
            sbData = { provider: null, clinic: null, room: null, assistant: null, assistants: [], startDate: null, endDate: null, days: null, time: null };
            sbStep = 0;
            updateSbStations();
        }
        
        function resetScheduleBuilder() {
            sbData = { provider: null, clinic: null, room: null, assistant: null, assistants: [], startDate: null, endDate: null, days: null, time: null };
            sbStep = 0;
            document.getElementById('sbProvider').textContent = '-';
            document.getElementById('sbClinic').textContent = '-';
            document.getElementById('sbRoom').textContent = '-';
            document.getElementById('sbAssistant').textContent = '-';
            document.getElementById('sbDays').textContent = '-';
            document.getElementById('sbTime').textContent = '-';
            document.getElementById('sbStationProviderVal').textContent = 'Click to select';
            document.getElementById('sbStationClinicVal').textContent = 'Click to select';
            document.getElementById('sbStationRoomVal').textContent = 'Click to select';
            document.getElementById('sbStationAssistantVal').textContent = 'Click to select';
            document.getElementById('sbStationDateVal').textContent = 'Click to select';
            document.getElementById('sbStationTimeVal').textContent = 'Click to select';
            document.getElementById('sbSubmit').classList.remove('visible');
            document.getElementById('sbPanel').classList.remove('open');
            updateSbStations();
        }
        
        function updateSbStations() {
            const stations = ['Provider', 'Clinic', 'Room', 'Assistant', 'Date', 'Time'];
            const dataKeys = ['provider', 'clinic', 'room', 'assistant', 'days', 'time'];
            let completedCount = 0;
            
            stations.forEach((s, i) => {
                const el = document.getElementById('sbStation' + s);
                el.classList.remove('active', 'completed');
                
                // Check if this station has data
                const hasData = dataKeys[i] === 'assistant' ? (sbData.assistant || sbData.assistants.length > 0) : sbData[dataKeys[i]];
                
                if (hasData) {
                    el.classList.add('completed');
                    completedCount++;
                }
                
                // All stations are always clickable
                el.onclick = () => sbEditStation(i);
            });
            
            // Update progress dots based on completed items
            for (let i = 0; i < 6; i++) {
                const dot = document.getElementById('sbDot' + i);
                dot.classList.remove('active', 'completed');
                const hasData = dataKeys[i] === 'assistant' ? (sbData.assistant || sbData.assistants.length > 0) : sbData[dataKeys[i]];
                if (hasData) dot.classList.add('completed');
            }
            
            // Show submit button if all 6 items are filled
            if (completedCount === 6) {
                document.getElementById('sbSubmit').classList.add('visible');
            } else {
                document.getElementById('sbSubmit').classList.remove('visible');
            }
        }
        
        function sbEditStation(stepIndex) {
            // Simply open the panel for this station - don't reset anything
            sbOpenPanel(sbSteps[stepIndex]);
        }
        
        function sbOpenPanel(type) {
            const panel = document.getElementById('sbPanel');
            const grid = document.getElementById('sbPanelGrid');
            const title = document.getElementById('sbPanelTitle');
            let items = [];
            
            if (type === 'provider') {
                // In Provider mode: show providers. In Employee mode: show employees/assistants
                if (sbMode === 'provider') {
                    title.innerHTML = '<i class="fas fa-user-md"></i> Select a Provider';
                    items = sbGameData.providers.map(p => `<div class="sb-item" onclick="sbSelect('provider','${p.name}')"><i class="fas fa-user-md" style="font-size:1.5rem;color:#4ade80;"></i><div style="font-weight:600;margin-top:0.5rem;">${p.name}</div><div style="font-size:0.75rem;opacity:0.7;">${p.role}</div></div>`);
                } else {
                    // Employee mode - show employees/assistants first
                    title.innerHTML = '<i class="fas fa-user-nurse"></i> Select an Employee';
                    items = sbGameData.assistants.filter(a => a.name !== 'None').map(a => {
                        const badge = a.worksAlone ? '<span style="background:#fbbf24;color:#000;padding:2px 6px;border-radius:10px;font-size:0.6rem;margin-left:5px;">Can work alone</span>' : '';
                        return `<div class="sb-item" onclick="sbSelect('provider','${a.name}')"><i class="fas fa-user-nurse" style="font-size:1.5rem;color:#4ade80;"></i><div style="font-weight:600;margin-top:0.5rem;">${a.name}${badge}</div><div style="font-size:0.75rem;opacity:0.7;">${a.role}</div></div>`;
                    });
                }
            } else if (type === 'clinic') {
                title.innerHTML = '<i class="fas fa-hospital"></i> Select a Clinic';
                items = sbGameData.clinics.map(c => `<div class="sb-item" onclick="sbSelect('clinic','${c.name}')"><i class="fas fa-hospital" style="font-size:1.5rem;color:${c.color};"></i><div style="font-weight:600;margin-top:0.5rem;">${c.name}</div></div>`);
            } else if (type === 'room') {
                title.innerHTML = '<i class="fas fa-door-open"></i> Select a Room';
                const rooms = sbGameData.rooms[sbData.clinic] || [];
                items = rooms.map(r => `<div class="sb-item" onclick="sbSelect('room','${r}')"><i class="fas fa-door-open" style="font-size:1.5rem;color:#8b5cf6;"></i><div style="font-weight:600;margin-top:0.5rem;">${r}</div></div>`);
            } else if (type === 'assistant') {
                // In Provider mode: select assistants. In Employee mode: select providers
                if (sbMode === 'provider') {
                    // Provider mode - select assistants
                    const provider = sbGameData.providers.find(p => p.name === sbData.provider);
                    const needsAssistant = provider ? provider.needsAssistant : true;
                    
                    title.innerHTML = '<i class="fas fa-user-nurse"></i> Select Assistant(s) <span style="font-size:0.8rem;opacity:0.7;">(Select multiple if needed)</span>';
                    
                    if (!needsAssistant) {
                        // Provider works alone - show message and skip option
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                                <i class="fas fa-info-circle" style="font-size: 3rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                                <p style="margin-bottom: 1.5rem; opacity: 0.8;">${sbData.provider} typically works independently.</p>
                                <div class="sb-item" onclick="sbSelect('assistant','None')" style="display: inline-block; margin: 0.5rem;">
                                    <i class="fas fa-user-slash" style="font-size:1.5rem;color:#94a3b8;"></i>
                                    <div style="font-weight:600;margin-top:0.5rem;">No Assistant</div>
                                    <div style="font-size:0.75rem;opacity:0.7;">Continue without</div>
                                </div>
                                <div class="sb-item" onclick="sbShowAllAssistants()" style="display: inline-block; margin: 0.5rem;">
                                    <i class="fas fa-users" style="font-size:1.5rem;color:#ec4899;"></i>
                                    <div style="font-weight:600;margin-top:0.5rem;">Assign Anyway</div>
                                    <div style="font-size:0.75rem;opacity:0.7;">Show assistants</div>
                                </div>
                            </div>
                        `;
                        panel.classList.add('open');
                        return;
                    }
                    
                    // Multi-select assistant panel
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; margin-bottom: 1rem;">
                            <p style="opacity: 0.8; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> You can select multiple assistants to work with this provider.</p>
                        </div>
                        ${sbGameData.assistants.filter(a => a.name !== 'None').map(a => {
                            const badge = a.worksAlone ? '<span style="background:#fbbf24;color:#000;padding:2px 6px;border-radius:10px;font-size:0.6rem;margin-left:5px;">Can work alone</span>' : '';
                            return `
                                <label class="sb-item" style="cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                                    <input type="checkbox" id="sbAsst_${a.name.replace(/\s/g,'_')}" value="${a.name}" style="position:absolute;top:10px;right:10px;width:20px;height:20px;accent-color:#ec4899;">
                                    <i class="fas fa-user-nurse" style="font-size:1.5rem;color:#ec4899;"></i>
                                    <div style="font-weight:600;margin-top:0.5rem;">${a.name}${badge}</div>
                                    <div style="font-size:0.75rem;opacity:0.7;">${a.role}</div>
                                </label>
                            `;
                        }).join('')}
                        <div style="grid-column: 1/-1; margin-top: 1rem; display: flex; gap: 1rem;">
                            <button onclick="sbConfirmAssistants()" style="flex:1; padding: 1rem; background: linear-gradient(135deg, #ec4899, #db2777); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                                <i class="fas fa-check"></i> Confirm Selection
                            </button>
                            <button onclick="sbSelect('assistant','None')" style="padding: 1rem; background: rgba(148,163,184,0.3); border: 2px solid #94a3b8; color: white; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-user-slash"></i> No Assistant
                            </button>
                        </div>
                    `;
                    panel.classList.add('open');
                    return;
                } else {
                    // Employee mode - select providers
                    const employee = sbGameData.assistants.find(a => a.name === sbData.provider);
                    const canWorkAlone = employee ? employee.worksAlone : false;
                    
                    title.innerHTML = '<i class="fas fa-user-md"></i> Select Provider(s) <span style="font-size:0.8rem;opacity:0.7;">(Select multiple if needed)</span>';
                    
                    if (canWorkAlone) {
                        // Employee can work alone - show message and skip option
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                                <i class="fas fa-info-circle" style="font-size: 3rem; color: #60a5fa; margin-bottom: 1rem;"></i>
                                <p style="margin-bottom: 1.5rem; opacity: 0.8;">${sbData.provider} can work independently (e.g., hygienist cleanings).</p>
                                <div class="sb-item" onclick="sbSelect('assistant','None')" style="display: inline-block; margin: 0.5rem;">
                                    <i class="fas fa-user-slash" style="font-size:1.5rem;color:#94a3b8;"></i>
                                    <div style="font-weight:600;margin-top:0.5rem;">No Provider</div>
                                    <div style="font-size:0.75rem;opacity:0.7;">Work independently</div>
                                </div>
                                <div class="sb-item" onclick="sbShowAllProviders()" style="display: inline-block; margin: 0.5rem;">
                                    <i class="fas fa-users" style="font-size:1.5rem;color:#10b981;"></i>
                                    <div style="font-weight:600;margin-top:0.5rem;">Assign Anyway</div>
                                    <div style="font-size:0.75rem;opacity:0.7;">Show providers</div>
                                </div>
                            </div>
                        `;
                        panel.classList.add('open');
                        return;
                    }
                    
                    // Multi-select provider panel
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; margin-bottom: 1rem;">
                            <p style="opacity: 0.8; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Select the provider(s) this employee will work with.</p>
                        </div>
                        ${sbGameData.providers.map(p => {
                            const badge = !p.needsAssistant ? '<span style="background:#94a3b8;color:#000;padding:2px 6px;border-radius:10px;font-size:0.6rem;margin-left:5px;">Works alone</span>' : '';
                            return `
                                <label class="sb-item" style="cursor:pointer; display:flex; flex-direction:column; align-items:center; position:relative;">
                                    <input type="checkbox" id="sbProv_${p.name.replace(/\s/g,'_')}" value="${p.name}" style="position:absolute;top:10px;right:10px;width:20px;height:20px;accent-color:#10b981;">
                                    <i class="fas fa-user-md" style="font-size:1.5rem;color:#10b981;"></i>
                                    <div style="font-weight:600;margin-top:0.5rem;">${p.name}${badge}</div>
                                    <div style="font-size:0.75rem;opacity:0.7;">${p.role}</div>
                                </label>
                            `;
                        }).join('')}
                        <div style="grid-column: 1/-1; margin-top: 1rem; display: flex; gap: 1rem;">
                            <button onclick="sbConfirmProviders()" style="flex:1; padding: 1rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                                <i class="fas fa-check"></i> Confirm Selection
                            </button>
                            <button onclick="sbSelect('assistant','None')" style="padding: 1rem; background: rgba(148,163,184,0.3); border: 2px solid #94a3b8; color: white; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-user-slash"></i> No Provider
                            </button>
                        </div>
                    `;
                    panel.classList.add('open');
                    return;
                }
            } else if (type === 'date') {
                title.innerHTML = '<i class="fas fa-calendar-alt"></i> Select Schedule Dates';
                // Create a calendar date picker
                const today = new Date();
                const formatDate = (d) => d.toISOString().split('T')[0];
                const formatDisplay = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #f87171;">
                                    <i class="fas fa-calendar-plus"></i> Start Date
                                </label>
                                <input type="date" id="sbStartDate" value="${formatDate(today)}" min="${formatDate(today)}" 
                                    style="width: 100%; padding: 0.75rem; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #f87171;">
                                    <i class="fas fa-calendar-check"></i> End Date
                                </label>
                                <input type="date" id="sbEndDate" value="${formatDate(new Date(today.getTime() + 30*24*60*60*1000))}" min="${formatDate(today)}"
                                    style="width: 100%; padding: 0.75rem; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 1rem;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #f87171;">
                                <i class="fas fa-redo"></i> Working Days Pattern
                            </label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="sbDaysPattern">
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay0" checked style="accent-color: #f87171;"> <span>Mon</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay1" checked style="accent-color: #f87171;"> <span>Tue</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay2" checked style="accent-color: #f87171;"> <span>Wed</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay3" checked style="accent-color: #f87171;"> <span>Thu</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay4" checked style="accent-color: #f87171;"> <span>Fri</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay5" style="accent-color: #f87171;"> <span>Sat</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer;">
                                    <input type="checkbox" id="sbDay6" style="accent-color: #f87171;"> <span>Sun</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            <button onclick="sbQuickDays('weekdays')" style="padding: 0.5rem 1rem; background: rgba(248,113,113,0.3); border: 1px solid #f87171; color: white; border-radius: 20px; cursor: pointer;">Mon-Fri</button>
                            <button onclick="sbQuickDays('fullweek')" style="padding: 0.5rem 1rem; background: rgba(248,113,113,0.3); border: 1px solid #f87171; color: white; border-radius: 20px; cursor: pointer;">Mon-Sat</button>
                            <button onclick="sbQuickDays('mwf')" style="padding: 0.5rem 1rem; background: rgba(248,113,113,0.3); border: 1px solid #f87171; color: white; border-radius: 20px; cursor: pointer;">Mon,Wed,Fri</button>
                            <button onclick="sbQuickDays('tts')" style="padding: 0.5rem 1rem; background: rgba(248,113,113,0.3); border: 1px solid #f87171; color: white; border-radius: 20px; cursor: pointer;">Tue,Thu,Sat</button>
                        </div>
                        
                        <button onclick="sbConfirmDates()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #f87171, #ef4444); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer;">
                            <i class="fas fa-check"></i> Confirm Dates
                        </button>
                    </div>
                `;
                panel.classList.add('open');
                return;
            } else if (type === 'time') {
                title.innerHTML = '<i class="fas fa-clock"></i> Select Time Slot';
                items = sbGameData.times.map(t => `<div class="sb-item" onclick="sbSelect('time','${t}')"><i class="fas fa-clock" style="font-size:1.5rem;color:#2dd4bf;"></i><div style="font-weight:600;margin-top:0.5rem;">${t}</div></div>`);
            }
            
            grid.innerHTML = items.join('');
            panel.classList.add('open');
        }
        
        function sbSelect(type, value, arrayValue) {
            document.getElementById('sbPanel').classList.remove('open');
            
            if (type === 'provider') { sbData.provider = value; document.getElementById('sbProvider').textContent = value; document.getElementById('sbStationProviderVal').textContent = value.split(' ')[1]; }
            else if (type === 'clinic') { sbData.clinic = value; document.getElementById('sbClinic').textContent = value; document.getElementById('sbStationClinicVal').textContent = value; }
            else if (type === 'room') { sbData.room = value; document.getElementById('sbRoom').textContent = value; document.getElementById('sbStationRoomVal').textContent = value; }
            else if (type === 'assistant') { 
                sbData.assistant = value; 
                sbData.assistants = arrayValue || [value]; // Store as array
                document.getElementById('sbAssistant').textContent = value; 
                document.getElementById('sbStationAssistantVal').textContent = sbData.assistants.length > 1 ? sbData.assistants.length + ' selected' : value.split(' ')[0]; 
            }
            else if (type === 'date') { sbData.days = value; document.getElementById('sbDays').textContent = value; document.getElementById('sbStationDateVal').textContent = value; }
            else if (type === 'time') { sbData.time = value; document.getElementById('sbTime').textContent = value; document.getElementById('sbStationTimeVal').textContent = value; }
            
            updateSbStations();
            
            // Find next empty station and auto-open it
            const dataKeys = ['provider', 'clinic', 'room', 'assistant', 'days', 'time'];
            let nextEmpty = -1;
            for (let i = 0; i < 6; i++) {
                const hasData = dataKeys[i] === 'assistant' ? (sbData.assistant || sbData.assistants.length > 0) : sbData[dataKeys[i]];
                if (!hasData) {
                    nextEmpty = i;
                    break;
                }
            }
            
            if (nextEmpty >= 0) {
                setTimeout(() => sbOpenPanel(sbSteps[nextEmpty]), 300);
            }
        }
        
        function sbSubmitSchedule() {
            const dateRange = sbData.startDate && sbData.endDate ? 
                `${sbData.startDate} to ${sbData.endDate}` : sbData.days;
            const secondaryList = sbData.assistants && sbData.assistants.length > 0 
                ? sbData.assistants.join(', ') 
                : sbData.assistant;
            
            const primaryLabel = sbMode === 'provider' ? 'Provider' : 'Employee';
            const secondaryLabel = sbMode === 'provider' ? 'Assistant(s)' : 'Provider(s)';
            
            // Parse time slot to get start and end times
            const timeParts = sbData.time ? sbData.time.split(' - ') : ['08:00', '16:00'];
            const startTime = timeParts[0] || '08:00';
            const endTime = timeParts[1] || '16:00';
            
            // Get clinic color from masterData or sbGameData
            let clinicColor = '#10b981';
            if (window.masterData?.getClinicByName) {
                const clinicData = window.masterData.getClinicByName(sbData.clinic);
                clinicColor = clinicData?.color || '#10b981';
            } else if (sbGameData?.clinics) {
                const clinicData = sbGameData.clinics.find(c => c.name === sbData.clinic);
                clinicColor = clinicData?.color || '#10b981';
            }
            
            // Parse days to array format
            let daysArray = [];
            if (typeof sbData.days === 'string') {
                if (sbData.days.includes(',')) {
                    daysArray = sbData.days.split(',').map(d => d.trim().substring(0,3));
                } else if (sbData.days.includes('-')) {
                    // Handle ranges like Mon-Fri
                    const dayOrder = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const parts = sbData.days.split('-').map(d => d.trim().substring(0,3));
                    const startIdx = dayOrder.indexOf(parts[0]);
                    const endIdx = dayOrder.indexOf(parts[1]);
                    if (startIdx >= 0 && endIdx >= 0) {
                        for (let i = startIdx; i <= endIdx; i++) {
                            daysArray.push(dayOrder[i]);
                        }
                    }
                } else {
                    daysArray = [sbData.days.substring(0,3)];
                }
            } else if (Array.isArray(sbData.days)) {
                daysArray = sbData.days;
            }
            
            // Create new shift object
            const newShift = {
                id: 'shift-' + Date.now(),
                name: sbData.provider,
                role: sbMode === 'provider' ? 'Provider' : 'Employee',
                startTime: startTime,
                endTime: endTime,
                clinic: sbData.clinic,
                room: sbData.room,
                assistant: secondaryList !== 'None' ? secondaryList : null,
                days: daysArray.length > 0 ? daysArray : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                color: clinicColor,
                startDate: sbData.startDate,
                endDate: sbData.endDate
            };
            
            // Add to global schedule array
            if (window.myScheduleShifts) {
                window.myScheduleShifts.push(newShift);
                console.log('âœ… New schedule added to myScheduleShifts:', newShift);
                
                // Refresh My Schedule calendar if function exists
                if (typeof window.renderMyScheduleCalendar === 'function') {
                    window.renderMyScheduleCalendar();
                }
            }
            
            alert(`âœ… Schedule Created Successfully!\n\n${primaryLabel}: ${sbData.provider}\nClinic: ${sbData.clinic}\nRoom: ${sbData.room}\n${secondaryLabel}: ${secondaryList}\nDates: ${dateRange}\nDays: ${sbData.days}\nTime: ${sbData.time}`);
            closeScheduleManagerDynamic();
        }
        
        // Show all assistants even if provider doesn't need one (multi-select)
        function sbShowAllAssistants() {
            const grid = document.getElementById('sbPanelGrid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; margin-bottom: 1rem;">
                    <p style="opacity: 0.8; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Select one or more assistants (optional for this provider).</p>
                </div>
                ${sbGameData.assistants.filter(a => a.name !== 'None').map(a => {
                    const badge = a.worksAlone ? '<span style="background:#fbbf24;color:#000;padding:2px 6px;border-radius:10px;font-size:0.6rem;margin-left:5px;">Can work alone</span>' : '';
                    return `
                        <label class="sb-item" style="cursor:pointer; display:flex; flex-direction:column; align-items:center; position:relative;">
                            <input type="checkbox" id="sbAsst_${a.name.replace(/\s/g,'_')}" value="${a.name}" style="position:absolute;top:10px;right:10px;width:20px;height:20px;accent-color:#ec4899;">
                            <i class="fas fa-user-nurse" style="font-size:1.5rem;color:#ec4899;"></i>
                            <div style="font-weight:600;margin-top:0.5rem;">${a.name}${badge}</div>
                            <div style="font-size:0.75rem;opacity:0.7;">${a.role}</div>
                        </label>
                    `;
                }).join('')}
                <div style="grid-column: 1/-1; margin-top: 1rem; display: flex; gap: 1rem;">
                    <button onclick="sbConfirmAssistants()" style="flex:1; padding: 1rem; background: linear-gradient(135deg, #ec4899, #db2777); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        <i class="fas fa-check"></i> Confirm Selection
                    </button>
                    <button onclick="sbSelect('assistant','None')" style="padding: 1rem; background: rgba(148,163,184,0.3); border: 2px solid #94a3b8; color: white; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-user-slash"></i> No Assistant
                    </button>
                </div>
            `;
        }
        
        // Confirm multiple assistant selection
        function sbConfirmAssistants() {
            const checkboxes = document.querySelectorAll('#sbPanelGrid input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one assistant, or click "No Assistant" to continue without one.');
                return;
            }
            
            const selectedAssistants = Array.from(checkboxes).map(cb => cb.value);
            const displayText = selectedAssistants.length > 2 
                ? `${selectedAssistants.slice(0,2).join(', ')} +${selectedAssistants.length - 2}` 
                : selectedAssistants.join(', ');
            
            sbSelect('assistant', displayText, selectedAssistants);
        }
        
        // Show all providers when employee can work alone (Employee mode)
        function sbShowAllProviders() {
            const grid = document.getElementById('sbPanelGrid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; margin-bottom: 1rem;">
                    <p style="opacity: 0.8; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Select one or more providers (optional for this employee).</p>
                </div>
                ${sbGameData.providers.map(p => {
                    const badge = !p.needsAssistant ? '<span style="background:#94a3b8;color:#000;padding:2px 6px;border-radius:10px;font-size:0.6rem;margin-left:5px;">Works alone</span>' : '';
                    return `
                        <label class="sb-item" style="cursor:pointer; display:flex; flex-direction:column; align-items:center; position:relative;">
                            <input type="checkbox" id="sbProv_${p.name.replace(/\s/g,'_')}" value="${p.name}" style="position:absolute;top:10px;right:10px;width:20px;height:20px;accent-color:#10b981;">
                            <i class="fas fa-user-md" style="font-size:1.5rem;color:#10b981;"></i>
                            <div style="font-weight:600;margin-top:0.5rem;">${p.name}${badge}</div>
                            <div style="font-size:0.75rem;opacity:0.7;">${p.role}</div>
                        </label>
                    `;
                }).join('')}
                <div style="grid-column: 1/-1; margin-top: 1rem; display: flex; gap: 1rem;">
                    <button onclick="sbConfirmProviders()" style="flex:1; padding: 1rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        <i class="fas fa-check"></i> Confirm Selection
                    </button>
                    <button onclick="sbSelect('assistant','None')" style="padding: 1rem; background: rgba(148,163,184,0.3); border: 2px solid #94a3b8; color: white; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-user-slash"></i> No Provider
                    </button>
                </div>
            `;
        }
        
        // Confirm multiple provider selection (Employee mode)
        function sbConfirmProviders() {
            const checkboxes = document.querySelectorAll('#sbPanelGrid input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one provider, or click "No Provider" to continue without one.');
                return;
            }
            
            const selectedProviders = Array.from(checkboxes).map(cb => cb.value);
            const displayText = selectedProviders.length > 2 
                ? `${selectedProviders.slice(0,2).join(', ')} +${selectedProviders.length - 2}` 
                : selectedProviders.join(', ');
            
            sbSelect('assistant', displayText, selectedProviders);
        }
        
        // Quick day selection presets
        function sbQuickDays(preset) {
            const checkboxes = [0,1,2,3,4,5,6].map(i => document.getElementById('sbDay' + i));
            checkboxes.forEach(cb => cb.checked = false);
            
            if (preset === 'weekdays') {
                [0,1,2,3,4].forEach(i => checkboxes[i].checked = true);
            } else if (preset === 'fullweek') {
                [0,1,2,3,4,5].forEach(i => checkboxes[i].checked = true);
            } else if (preset === 'mwf') {
                [0,2,4].forEach(i => checkboxes[i].checked = true);
            } else if (preset === 'tts') {
                [1,3,5].forEach(i => checkboxes[i].checked = true);
            }
        }
        
        // Confirm date selection
        function sbConfirmDates() {
            const startDate = document.getElementById('sbStartDate').value;
            const endDate = document.getElementById('sbEndDate').value;
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const selectedDays = [];
            
            for (let i = 0; i < 7; i++) {
                if (document.getElementById('sbDay' + i).checked) {
                    selectedDays.push(dayNames[i]);
                }
            }
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            if (selectedDays.length === 0) {
                alert('Please select at least one working day');
                return;
            }
            
            sbData.startDate = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            sbData.endDate = new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            sbData.days = selectedDays.join(', ');
            
            document.getElementById('sbDays').textContent = sbData.days;
            document.getElementById('sbStationDateVal').textContent = sbData.startDate.split(',')[0];
            
            document.getElementById('sbPanel').classList.remove('open');
            updateSbStations();
            
            // Find next empty station and auto-open it
            const dataKeys = ['provider', 'clinic', 'room', 'assistant', 'days', 'time'];
            let nextEmpty = -1;
            for (let i = 0; i < 6; i++) {
                const hasData = dataKeys[i] === 'assistant' ? (sbData.assistant || sbData.assistants.length > 0) : sbData[dataKeys[i]];
                if (!hasData) {
                    nextEmpty = i;
                    break;
                }
            }
            
            if (nextEmpty >= 0) {
                setTimeout(() => sbOpenPanel(sbSteps[nextEmpty]), 300);
            }
        }

        // Close vendors management modal
        function closeVendorsManagement() {
            const modal = document.getElementById('vendorsManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Stop auto-refresh
            if (vendorsAutoRefreshInterval) {
                clearInterval(vendorsAutoRefreshInterval);
                vendorsAutoRefreshInterval = null;
            }
            // Clear form
            document.getElementById('createVendorForm').reset();
            document.getElementById('createVendorError').style.display = 'none';
        }

        // Create new vendor - NOW SYNCS WITH API
        async function createVendor(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editVendorId').value;
            const vendorName = document.getElementById('newVendorName').value.trim();
            const vendorTypeSelect = document.getElementById('newVendorType').value.trim();
            const customVendorType = document.getElementById('customVendorType').value.trim();
            const vendorType = vendorTypeSelect === 'Other' && customVendorType ? customVendorType : vendorTypeSelect;
            const contactName = document.getElementById('newVendorContactName').value.trim();
            const email = document.getElementById('newVendorEmail').value.trim();
            const phone = document.getElementById('newVendorPhone').value.trim();
            const alternatePhone = document.getElementById('newVendorAlternatePhone').value.trim();
            const address = document.getElementById('newVendorAddress').value.trim();
            const city = document.getElementById('newVendorCity').value.trim();
            const state = document.getElementById('newVendorState').value.trim();
            const zipCode = document.getElementById('newVendorZipCode').value.trim();
            const website = document.getElementById('newVendorWebsite').value.trim();
            const notes = document.getElementById('newVendorNotes').value.trim();
            const isActive = document.getElementById('newVendorIsActive').checked;
            const errorDiv = document.getElementById('createVendorError');
            
            // Validate required fields
            if (!vendorName) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please fill in all required fields.';
                return;
            }
            
            // Prepare vendor data for API
            const vendorData = {
                name: vendorName,
                vendorType: vendorType,
                contactPerson: contactName,
                email: email,
                phone: phone,
                alternatePhone: alternatePhone,
                address: address,
                city: city,
                state: state,
                zipCode: zipCode,
                website: website,
                notes: notes,
                isActive: isActive
            };
            
            try {
                let response;
                if (editId) {
                    // Update existing vendor via API
                    response = await fetch(`${API_BASE_URL}/vendors/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(vendorData)
                    });
                } else {
                    // Create new vendor via API
                    response = await fetch(`${API_BASE_URL}/vendors`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(vendorData)
                    });
                }
                
                if (response.ok) {
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d4edda';
                    errorDiv.style.borderColor = '#c3e6cb';
                    errorDiv.style.color = '#155724';
                    errorDiv.textContent = editId ? `Vendor "${vendorName}" updated successfully!` : `Vendor "${vendorName}" created successfully!`;
                    
                    // Sync vendors from API to refresh list
                    await syncVendorsFromAPI();
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Error saving vendor:', error);
                // Fallback to localStorage
                const vendors = loadVendors();
                
                if (editId) {
                    const index = vendors.findIndex(v => v.vendorID === parseInt(editId));
                    if (index !== -1) {
                        vendors[index] = {
                            ...vendors[index],
                            vendorName, vendorType, contactName, email, phone,
                            alternatePhone, address, city, state, zipCode,
                            website, notes, isActive,
                            modifiedDate: new Date().toISOString()
                        };
                    }
                } else {
                    const newVendor = {
                        vendorID: Date.now(),
                        vendorName, vendorType, contactName, email, phone,
                        alternatePhone, address, city, state, zipCode,
                        website, notes, isActive,
                        createdDate: new Date().toISOString()
                    };
                    vendors.push(newVendor);
                }
                saveVendors(vendors);
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#fff3cd';
                errorDiv.style.borderColor = '#ffc107';
                errorDiv.style.color = '#856404';
                errorDiv.textContent = `Vendor saved locally (offline mode)`;
            }
            
            // Reset form and hide
            document.getElementById('createVendorForm').reset();
            document.getElementById('editVendorId').value = '';
            closeVendorForm();
            
            // Refresh vendors list
            displayVendorsList();
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
            }, 3000);
        }

        // Display vendors list
        function displayVendorsList() {
            const vendors = loadVendors();
            const vendorsList = document.getElementById('vendorsList');
            
            if (!vendorsList) return;
            
            if (vendors.length === 0) {
                vendorsList.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No vendors added yet. Click "Add New Vendor" to get started.</td></tr>';
                return;
            }
            
            vendorsList.innerHTML = vendors.map(vendor => {
                const statusColor = vendor.isActive ? '#10b981' : '#ef4444';
                return `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="font-weight: 600;">${vendor.vendorName}</div>
                        ${vendor.email ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">${vendor.email}</div>` : ''}
                    </td>
                    <td style="padding: 1rem;">
                        ${vendor.vendorType ? `<span style="background: var(--accent-primary)20; color: var(--accent-primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${vendor.vendorType}</span>` : '<span style="color: var(--text-tertiary);">-</span>'}
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${vendor.contactName || '-'}</td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${vendor.phone || '-'}</td>
                    <td style="padding: 1rem;">
                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${vendor.isActive ? 'Active' : 'Inactive'}</span>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="editVendor(${vendor.vendorID})" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit Vendor">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteVendor(${vendor.vendorID})" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete Vendor">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Open Add Vendor Form
        function openAddVendorForm() {
            document.getElementById('vendorFormSection').style.display = 'block';
            document.getElementById('vendorFormTitle').textContent = 'Add New Vendor';
            document.getElementById('vendorSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Vendor';
            document.getElementById('editVendorId').value = '';
            document.getElementById('createVendorForm').reset();
            document.getElementById('vendorFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Vendor Form
        function closeVendorForm() {
            document.getElementById('vendorFormSection').style.display = 'none';
            document.getElementById('createVendorForm').reset();
            document.getElementById('editVendorId').value = '';
        }

        // Edit Vendor
        function editVendor(vendorID) {
            const vendors = loadVendors();
            const vendor = vendors.find(v => v.vendorID === vendorID);
            
            if (!vendor) return;
            
            document.getElementById('vendorFormSection').style.display = 'block';
            document.getElementById('vendorFormTitle').textContent = 'Edit Vendor';
            document.getElementById('vendorSubmitBtn').innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Update Vendor';
            document.getElementById('editVendorId').value = vendor.vendorID;
            
            document.getElementById('newVendorName').value = vendor.vendorName || '';
            document.getElementById('newVendorType').value = vendor.vendorType || '';
            document.getElementById('newVendorContactName').value = vendor.contactName || '';
            document.getElementById('newVendorEmail').value = vendor.email || '';
            document.getElementById('newVendorPhone').value = vendor.phone || '';
            document.getElementById('newVendorAlternatePhone').value = vendor.alternatePhone || '';
            document.getElementById('newVendorAddress').value = vendor.address || '';
            document.getElementById('newVendorCity').value = vendor.city || '';
            document.getElementById('newVendorState').value = vendor.state || '';
            document.getElementById('newVendorZipCode').value = vendor.zipCode || '';
            document.getElementById('newVendorWebsite').value = vendor.website || '';
            document.getElementById('newVendorNotes').value = vendor.notes || '';
            document.getElementById('newVendorIsActive').checked = vendor.isActive !== false;
            
            document.getElementById('vendorFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete vendor - NOW SYNCS WITH API
        async function deleteVendor(vendorID) {
            if (confirm('Are you sure you want to delete this vendor?')) {
                console.log('ðŸ—‘ï¸ Deleting vendor with ID:', vendorID, 'Type:', typeof vendorID);
                
                // Always remove from localStorage first
                const vendors = loadVendors();
                console.log('ðŸ“¦ Current vendors:', vendors.map(v => ({ id: v.vendorID, name: v.vendorName })));
                const updatedVendors = vendors.filter(v => {
                    const match = v.vendorID == vendorID; // Use == for type coercion
                    if (match) console.log('ðŸŽ¯ Found vendor to delete:', v.vendorName);
                    return !match;
                });
                saveVendors(updatedVendors);
                console.log('ðŸ’¾ Saved updated vendors, count:', updatedVendors.length);
                
                try {
                    // Try to delete via API (for database vendors)
                    const apiUrl = `${API_BASE_URL}/vendors/${vendorID}`;
                    console.log('ðŸŒ Calling DELETE:', apiUrl);
                    const response = await fetch(apiUrl, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    console.log('ðŸ“¡ API Response status:', response.status);
                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… Vendor deleted from API:', result);
                    } else {
                        const errorText = await response.text();
                        console.log('âš ï¸ API delete failed:', response.status, errorText);
                    }
                } catch (error) {
                    console.error('âŒ Error deleting vendor from API:', error);
                }
                
                displayVendorsList();
            }
        }

        // ============ EQUIPMENT MANAGEMENT ============
        
        // Load equipment from localStorage
        function loadEquipment() {
            const equipment = localStorage.getItem('equipment');
            return equipment ? JSON.parse(equipment) : [];
        }

        // Save equipment to localStorage and sync to API
        function saveEquipment(equipment, newItem = null) {
            localStorage.setItem('equipment', JSON.stringify(equipment));
            // Sync new item to API if provided
            if (newItem && typeof saveEquipmentToAPI === 'function') {
                saveEquipmentToAPI(newItem);
            }
        }

        // Open equipment management modal
        function openEquipmentManagement() {
            console.log('openEquipmentManagement called');
            const modal = document.getElementById('equipmentManagementModal');
            console.log('Equipment modal element:', modal);
            if (modal) {
                modal.style.display = 'flex';
                populateEquipmentOfficeDropdown();
                populateEquipmentVendorDropdown();
                displayEquipmentList();
            } else {
                alert('Equipment modal not found!');
            }
        }

        // Close equipment management modal
        function closeEquipmentManagement() {
            const modal = document.getElementById('equipmentManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Clear form
            document.getElementById('createEquipmentForm').reset();
            document.getElementById('createEquipmentError').style.display = 'none';
            // Clear edit mode
            document.getElementById('editEquipmentId').value = '';
            document.getElementById('equipmentFormTitle').textContent = 'Add New Equipment';
            document.getElementById('equipmentSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Equipment';
        }

        // Populate office dropdown for equipment
        function populateEquipmentOfficeDropdown() {
            const offices = loadOffices();
            const dropdown = document.getElementById('newEquipmentOffice');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Office</option>';
                offices.forEach(office => {
                    const option = document.createElement('option');
                    option.value = office.officeID;
                    option.textContent = office.officeName;
                    dropdown.appendChild(option);
                });
            }
        }

        // Populate vendor dropdown for equipment
        function populateEquipmentVendorDropdown() {
            const vendors = loadVendors();
            const dropdown = document.getElementById('newEquipmentVendor');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Vendor</option>';
                // Only show active vendors
                const activeVendors = vendors.filter(v => v.isActive !== false);
                activeVendors.sort((a, b) => a.vendorName.localeCompare(b.vendorName));
                activeVendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor.vendorID;
                    option.textContent = vendor.vendorName + (vendor.vendorType ? ` (${vendor.vendorType})` : '');
                    dropdown.appendChild(option);
                });
            }
        }

        // Toggle custom equipment type
        function toggleCustomEquipmentType() {
            const typeSelect = document.getElementById('newEquipmentType');
            const customBox = document.getElementById('customEquipmentTypeBox');
            const customInput = document.getElementById('customEquipmentType');
            
            if (typeSelect.value === 'Other') {
                customBox.style.display = 'block';
                customInput.focus();
            } else {
                customBox.style.display = 'none';
                customInput.value = '';
            }
        }

        // Cancel custom equipment type
        function cancelCustomEquipmentType() {
            const typeSelect = document.getElementById('newEquipmentType');
            const customBox = document.getElementById('customEquipmentTypeBox');
            const customInput = document.getElementById('customEquipmentType');
            
            typeSelect.value = '';
            customBox.style.display = 'none';
            customInput.value = '';
        }

        // Create or Update equipment
        function createEquipment(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editEquipmentId').value;
            const isEdit = !!editId;
            
            const equipmentName = document.getElementById('newEquipmentName').value.trim();
            const categorySelect = document.getElementById('newEquipmentCategory').value;
            const typeSelect = document.getElementById('newEquipmentType').value;
            const customType = document.getElementById('customEquipmentType').value.trim();
            const equipmentType = typeSelect === 'Other' && customType ? customType : typeSelect;
            const manufacturer = document.getElementById('newEquipmentManufacturer').value.trim();
            const model = document.getElementById('newEquipmentModel').value.trim();
            const serialNumber = document.getElementById('newEquipmentSerial').value.trim();
            const purchaseDate = document.getElementById('newEquipmentPurchaseDate').value;
            const warrantyExpiry = document.getElementById('newEquipmentWarranty').value;
            const lastServiceDate = document.getElementById('newEquipmentLastService').value;
            const nextServiceDate = document.getElementById('newEquipmentNextService').value;
            const officeId = document.getElementById('newEquipmentOffice').value;
            const location = document.getElementById('newEquipmentLocation').value.trim();
            const vendorId = document.getElementById('newEquipmentVendor').value;
            const status = document.getElementById('newEquipmentStatus').value;
            const condition = document.getElementById('newEquipmentCondition').value;
            const notes = document.getElementById('newEquipmentNotes').value.trim();
            const isActive = document.getElementById('newEquipmentIsActive').checked;
            const errorDiv = document.getElementById('createEquipmentError');
            
            // Validate required fields
            if (!equipmentName || !categorySelect) {
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
                errorDiv.textContent = 'Please fill in Equipment Name and Category.';
                return;
            }
            
            // Load existing equipment
            const equipment = loadEquipment();
            
            // Check for duplicate name (excluding current item if editing)
            const duplicate = equipment.find(e => 
                e.equipmentName.toLowerCase() === equipmentName.toLowerCase() && 
                (!isEdit || e.equipmentID !== parseInt(editId))
            );
            if (duplicate) {
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
                errorDiv.textContent = 'Equipment with this name already exists.';
                return;
            }
            
            // Get office name
            const offices = loadOffices();
            const selectedOffice = offices.find(o => o.officeID == officeId);
            const officeName = selectedOffice ? selectedOffice.officeName : '';
            
            // Get vendor name
            const vendors = loadVendors();
            const selectedVendor = vendors.find(v => v.vendorID == vendorId);
            const vendorName = selectedVendor ? selectedVendor.vendorName : '';
            
            if (isEdit) {
                // Update existing equipment
                const index = equipment.findIndex(e => e.equipmentID === parseInt(editId));
                if (index > -1) {
                    equipment[index] = {
                        ...equipment[index],
                        equipmentName,
                        category: categorySelect,
                        equipmentType,
                        manufacturer,
                        model,
                        serialNumber,
                        purchaseDate,
                        warrantyExpiry,
                        lastServiceDate,
                        nextServiceDate,
                        officeId,
                        officeName,
                        location,
                        vendorId,
                        vendorName,
                        status,
                        condition,
                        notes,
                        isActive,
                        modifiedDate: new Date().toISOString()
                    };
                    saveEquipment(equipment);
                    
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d4edda';
                    errorDiv.style.borderColor = '#c3e6cb';
                    errorDiv.style.color = '#155724';
                    errorDiv.textContent = `Equipment "${equipmentName}" updated successfully!`;
                }
            } else {
                // Create new equipment
                const newEquipment = {
                    equipmentID: Date.now(),
                    equipmentName,
                    category: categorySelect,
                    equipmentType,
                    manufacturer,
                    model,
                    serialNumber,
                    purchaseDate,
                    warrantyExpiry,
                    lastServiceDate,
                    nextServiceDate,
                    officeId,
                    officeName,
                    location,
                    vendorId,
                    vendorName,
                    status,
                    condition,
                    notes,
                    isActive,
                    createdDate: new Date().toISOString(),
                    modifiedDate: new Date().toISOString()
                };
                
                equipment.push(newEquipment);
                // Save to localStorage and sync to API
                saveEquipment(equipment, {
                    name: equipmentName,
                    serialNumber: serialNumber,
                    clinicId: officeId ? parseInt(officeId) : null,
                    status: status,
                    purchaseDate: purchaseDate || null,
                    warranty: warrantyExpiry || '',
                    notes: notes
                });
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.borderColor = '#c3e6cb';
                errorDiv.style.color = '#155724';
                errorDiv.textContent = `Equipment "${equipmentName}" created successfully!`;
            }
            
            // Reset form
            document.getElementById('createEquipmentForm').reset();
            document.getElementById('editEquipmentId').value = '';
            document.getElementById('equipmentFormTitle').textContent = 'Add New Equipment';
            document.getElementById('equipmentSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Equipment';
            document.getElementById('customEquipmentTypeBox').style.display = 'none';
            
            // Refresh list
            displayEquipmentList();
            updateInventoryBadges();
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Display equipment list
        function displayEquipmentList() {
            const equipment = loadEquipment();
            const equipmentList = document.getElementById('equipmentList');
            
            if (!equipmentList) return;
            
            if (equipment.length === 0) {
                equipmentList.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No equipment added yet. Click "Add New Equipment" to get started.</td></tr>';
                return;
            }
            
            // Sort by category then name
            equipment.sort((a, b) => {
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return a.equipmentName.localeCompare(b.equipmentName);
            });
            
            const statusColors = {
                'Operational': '#10b981',
                'Needs Service': '#f59e0b',
                'Under Repair': '#f97316',
                'Out of Service': '#ef4444',
                'Retired': '#6b7280'
            };
            
            equipmentList.innerHTML = equipment.map(item => {
                const statusColor = statusColors[item.status] || '#6b7280';
                const isServiceDue = item.nextServiceDate && new Date(item.nextServiceDate) < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
                
                return `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s; ${!item.isActive ? 'opacity: 0.6;' : ''}" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="font-weight: 600;">${item.equipmentName}</div>
                        ${item.manufacturer ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">${item.manufacturer}${item.model ? ' - ' + item.model : ''}</div>` : ''}
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: #f59e0b20; color: #f59e0b; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${item.category}</span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${item.officeName || item.location || '-'}</td>
                    <td style="padding: 1rem;">
                        <span style="background: ${statusColor}20; color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${item.status || 'Unknown'}</span>
                    </td>
                    <td style="padding: 1rem; color: ${isServiceDue ? '#ef4444' : 'var(--text-secondary)'};">
                        ${item.nextServiceDate ? new Date(item.nextServiceDate).toLocaleDateString() : '-'}
                        ${isServiceDue ? ' <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>' : ''}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="editEquipment(${item.equipmentID})" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit Equipment">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEquipment(${item.equipmentID})" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete Equipment">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Open Add Equipment Form
        function openAddEquipmentForm() {
            document.getElementById('equipmentFormSection').style.display = 'block';
            document.getElementById('equipmentFormTitle').textContent = 'Add New Equipment';
            document.getElementById('equipmentSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Equipment';
            document.getElementById('editEquipmentId').value = '';
            document.getElementById('createEquipmentForm').reset();
            document.getElementById('newEquipmentIsActive').checked = true;
            document.getElementById('equipmentFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Equipment Form
        function closeEquipmentForm() {
            document.getElementById('equipmentFormSection').style.display = 'none';
            document.getElementById('createEquipmentForm').reset();
            document.getElementById('editEquipmentId').value = '';
        }

        // Edit equipment
        function editEquipment(equipmentID) {
            const equipment = loadEquipment();
            const item = equipment.find(e => e.equipmentID === equipmentID);
            
            if (!item) return;
            
            // Show form section
            document.getElementById('equipmentFormSection').style.display = 'block';
            
            // Fill form with equipment data
            document.getElementById('editEquipmentId').value = item.equipmentID;
            document.getElementById('newEquipmentName').value = item.equipmentName || '';
            document.getElementById('newEquipmentCategory').value = item.category || '';
            document.getElementById('newEquipmentType').value = item.equipmentType || '';
            document.getElementById('newEquipmentManufacturer').value = item.manufacturer || '';
            document.getElementById('newEquipmentModel').value = item.model || '';
            document.getElementById('newEquipmentSerial').value = item.serialNumber || '';
            document.getElementById('newEquipmentPurchaseDate').value = item.purchaseDate || '';
            document.getElementById('newEquipmentWarranty').value = item.warrantyExpiry || '';
            document.getElementById('newEquipmentLastService').value = item.lastServiceDate || '';
            document.getElementById('newEquipmentNextService').value = item.nextServiceDate || '';
            document.getElementById('newEquipmentOffice').value = item.officeId || '';
            document.getElementById('newEquipmentLocation').value = item.location || '';
            document.getElementById('newEquipmentVendor').value = item.vendorId || '';
            document.getElementById('newEquipmentStatus').value = item.status || 'Operational';
            document.getElementById('newEquipmentCondition').value = item.condition || '';
            document.getElementById('newEquipmentNotes').value = item.notes || '';
            document.getElementById('newEquipmentIsActive').checked = item.isActive !== false;
            
            // Update form title and button
            document.getElementById('equipmentFormTitle').textContent = 'Edit Equipment';
            document.getElementById('equipmentSubmitBtn').innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Changes';
            
            // Scroll to form
            document.getElementById('equipmentFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete equipment
        function deleteEquipment(equipmentID) {
            if (confirm('Are you sure you want to delete this equipment?')) {
                const equipment = loadEquipment();
                const updatedEquipment = equipment.filter(e => e.equipmentID !== equipmentID);
                saveEquipment(updatedEquipment);
                displayEquipmentList();
                updateInventoryBadges();
            }
        }

        // ============ INSTRUMENTS MANAGEMENT ============
        
        // Load instruments from localStorage
        function loadInstruments() {
            const instruments = localStorage.getItem('instruments');
            return instruments ? JSON.parse(instruments) : [];
        }

        // Save instruments to localStorage and sync to API
        function saveInstruments(instruments, newItem = null) {
            localStorage.setItem('instruments', JSON.stringify(instruments));
            // Sync new item to API if provided
            if (newItem && typeof saveInstrumentToAPI === 'function') {
                saveInstrumentToAPI(newItem);
            }
        }

        // Open instruments management modal
        function openInstrumentsManagement() {
            const modal = document.getElementById('instrumentsManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                populateInstrumentOfficeDropdown();
                populateInstrumentVendorDropdown();
                displayInstrumentsList();
            }
        }

        // Close instruments management modal
        function closeInstrumentsManagement() {
            const modal = document.getElementById('instrumentsManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Clear form
            document.getElementById('createInstrumentForm').reset();
            document.getElementById('createInstrumentError').style.display = 'none';
            document.getElementById('editInstrumentId').value = '';
            document.getElementById('instrumentFormTitle').textContent = 'Add New Instrument';
            document.getElementById('instrumentSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Instrument';
        }

        // Populate office dropdown for instruments
        function populateInstrumentOfficeDropdown() {
            const offices = loadOffices();
            const dropdown = document.getElementById('newInstrumentOffice');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Office</option>';
                offices.forEach(office => {
                    const option = document.createElement('option');
                    option.value = office.officeID;
                    option.textContent = office.officeName;
                    dropdown.appendChild(option);
                });
            }
        }

        // Populate vendor dropdown for instruments
        function populateInstrumentVendorDropdown() {
            const vendors = loadVendors();
            const dropdown = document.getElementById('newInstrumentVendor');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Vendor</option>';
                const activeVendors = vendors.filter(v => v.isActive !== false);
                activeVendors.sort((a, b) => a.vendorName.localeCompare(b.vendorName));
                activeVendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor.vendorID;
                    option.textContent = vendor.vendorName + (vendor.vendorType ? ` (${vendor.vendorType})` : '');
                    dropdown.appendChild(option);
                });
            }
        }

        // Toggle custom category input visibility
        function toggleCustomInstrumentCategory() {
            const categorySelect = document.getElementById('newInstrumentCategory');
            const customWrapper = document.getElementById('customInstrumentCategoryWrapper');
            const customInput = document.getElementById('customInstrumentCategory');
            
            if (categorySelect.value === 'Other') {
                customWrapper.style.display = 'block';
                customInput.focus();
            } else {
                customWrapper.style.display = 'none';
                customInput.value = '';
            }
        }

        // Cancel custom category and reset to default selection
        function cancelCustomCategory() {
            document.getElementById('newInstrumentCategory').value = '';
            document.getElementById('customInstrumentCategoryWrapper').style.display = 'none';
            document.getElementById('customInstrumentCategory').value = '';
        }

        // Create or Update instrument
        function createInstrument(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editInstrumentId').value;
            const isEdit = !!editId;
            
            const instrumentName = document.getElementById('newInstrumentName').value.trim();
            let category = document.getElementById('newInstrumentCategory').value;
            const errorDiv = document.getElementById('createInstrumentError');
            
            // If "Other" is selected, use the custom category input
            if (category === 'Other') {
                const customCategory = document.getElementById('customInstrumentCategory').value.trim();
                if (customCategory) {
                    category = customCategory;
                } else {
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#fee';
                    errorDiv.style.borderColor = '#fcc';
                    errorDiv.style.color = '#c33';
                    errorDiv.textContent = 'Please enter a custom category name.';
                    document.getElementById('customInstrumentCategory').focus();
                    return;
                }
            }
            const instrumentType = document.getElementById('newInstrumentType').value.trim();
            const manufacturer = document.getElementById('newInstrumentManufacturer').value.trim();
            const quantity = parseInt(document.getElementById('newInstrumentQuantity').value) || 1;
            const officeId = document.getElementById('newInstrumentOffice').value;
            const location = document.getElementById('newInstrumentLocation').value.trim();
            const vendorId = document.getElementById('newInstrumentVendor').value;
            const sterilizationRequired = document.getElementById('newInstrumentSterilization').checked;
            const lastSterilized = document.getElementById('newInstrumentLastSterilized').value;
            const condition = document.getElementById('newInstrumentCondition').value;
            const notes = document.getElementById('newInstrumentNotes').value.trim();
            const isActive = document.getElementById('newInstrumentIsActive').checked;
            
            if (!instrumentName || !category) {
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
                errorDiv.textContent = 'Please fill in Instrument Name and Category.';
                return;
            }
            
            const instruments = loadInstruments();
            
            // Get office and vendor names
            const offices = loadOffices();
            const selectedOffice = offices.find(o => o.officeID == officeId);
            const officeName = selectedOffice ? selectedOffice.officeName : '';
            
            const vendors = loadVendors();
            const selectedVendor = vendors.find(v => v.vendorID == vendorId);
            const vendorName = selectedVendor ? selectedVendor.vendorName : '';
            
            if (isEdit) {
                const index = instruments.findIndex(i => i.instrumentID === parseInt(editId));
                if (index > -1) {
                    instruments[index] = {
                        ...instruments[index],
                        instrumentName,
                        category,
                        instrumentType,
                        manufacturer,
                        quantity,
                        officeId,
                        officeName,
                        location,
                        vendorId,
                        vendorName,
                        sterilizationRequired,
                        lastSterilized,
                        condition,
                        notes,
                        isActive,
                        modifiedDate: new Date().toISOString()
                    };
                    saveInstruments(instruments);
                    
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d4edda';
                    errorDiv.style.borderColor = '#c3e6cb';
                    errorDiv.style.color = '#155724';
                    errorDiv.textContent = `Instrument "${instrumentName}" updated successfully!`;
                }
            } else {
                const newInstrument = {
                    instrumentID: Date.now(),
                    instrumentName,
                    category,
                    instrumentType,
                    manufacturer,
                    quantity,
                    officeId,
                    officeName,
                    location,
                    vendorId,
                    vendorName,
                    sterilizationRequired,
                    lastSterilized,
                    condition,
                    notes,
                    isActive,
                    createdDate: new Date().toISOString(),
                    modifiedDate: new Date().toISOString()
                };
                
                instruments.push(newInstrument);
                // Save to localStorage and sync to API
                saveInstruments(instruments, {
                    name: instrumentName,
                    category: category,
                    clinicId: officeId ? parseInt(officeId) : null,
                    quantity: quantity || 1,
                    status: condition || 'available',
                    sterilizationDate: lastSterilized || null,
                    notes: notes
                });
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.borderColor = '#c3e6cb';
                errorDiv.style.color = '#155724';
                errorDiv.textContent = `Instrument "${instrumentName}" added successfully!`;
            }
            
            // Reset form
            document.getElementById('createInstrumentForm').reset();
            document.getElementById('editInstrumentId').value = '';
            document.getElementById('instrumentFormTitle').textContent = 'Add New Instrument';
            document.getElementById('instrumentSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Instrument';
            // Reset custom category input
            document.getElementById('customInstrumentCategoryWrapper').style.display = 'none';
            document.getElementById('customInstrumentCategory').value = '';
            
            displayInstrumentsList();
            updateInventoryBadges();
            
            setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
        }

        // Display instruments list
        function displayInstrumentsList() {
            const instruments = loadInstruments();
            const instrumentsList = document.getElementById('instrumentsList');
            
            if (!instrumentsList) return;
            
            if (instruments.length === 0) {
                instrumentsList.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No instruments added yet. Click "Add New Instrument" to get started.</td></tr>';
                return;
            }
            
            instruments.sort((a, b) => {
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return a.instrumentName.localeCompare(b.instrumentName);
            });
            
            const conditionColors = {
                'Excellent': '#10b981',
                'Good': '#22c55e',
                'Fair': '#f59e0b',
                'Poor': '#ef4444',
                'Needs Replacement': '#dc2626'
            };
            
            instrumentsList.innerHTML = instruments.map(item => {
                const conditionColor = conditionColors[item.condition] || '#6b7280';
                
                return `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s; ${!item.isActive ? 'opacity: 0.6;' : ''}" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="font-weight: 600;">${item.instrumentName}</div>
                        ${item.manufacturer ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">${item.manufacturer}</div>` : ''}
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: #06b6d420; color: #06b6d4; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${item.category}</span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${item.quantity || 1}</td>
                    <td style="padding: 1rem;">
                        ${item.condition ? `<span style="background: ${conditionColor}20; color: ${conditionColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${item.condition}</span>` : '-'}
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${item.officeName || item.location || '-'}</td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="editInstrument(${item.instrumentID})" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit Instrument">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteInstrument(${item.instrumentID})" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete Instrument">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Open Add Instrument Form
        function openAddInstrumentForm() {
            document.getElementById('instrumentFormSection').style.display = 'block';
            document.getElementById('instrumentFormTitle').textContent = 'Add New Instrument';
            document.getElementById('instrumentSubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Instrument';
            document.getElementById('editInstrumentId').value = '';
            document.getElementById('createInstrumentForm').reset();
            document.getElementById('newInstrumentIsActive').checked = true;
            document.getElementById('instrumentFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Instrument Form
        function closeInstrumentForm() {
            document.getElementById('instrumentFormSection').style.display = 'none';
            document.getElementById('createInstrumentForm').reset();
            document.getElementById('editInstrumentId').value = '';
        }

        // Edit instrument
        function editInstrument(instrumentID) {
            const instruments = loadInstruments();
            const item = instruments.find(i => i.instrumentID === instrumentID);
            
            if (!item) return;
            
            // Show form section
            document.getElementById('instrumentFormSection').style.display = 'block';
            
            // Standard categories list
            const standardCategories = ['Diagnostic', 'Surgical', 'Restorative', 'Endodontic', 'Periodontal', 'Orthodontic', 'Prosthodontic', 'Hygiene', 'Other'];
            
            document.getElementById('editInstrumentId').value = item.instrumentID;
            document.getElementById('newInstrumentName').value = item.instrumentName || '';
            
            // Check if category is a custom one
            if (item.category && !standardCategories.includes(item.category)) {
                // It's a custom category - set dropdown to "Other" and show custom input
                document.getElementById('newInstrumentCategory').value = 'Other';
                document.getElementById('customInstrumentCategoryWrapper').style.display = 'block';
                document.getElementById('customInstrumentCategory').value = item.category;
            } else {
                document.getElementById('newInstrumentCategory').value = item.category || '';
                document.getElementById('customInstrumentCategoryWrapper').style.display = 'none';
                document.getElementById('customInstrumentCategory').value = '';
            }
            
            document.getElementById('newInstrumentType').value = item.instrumentType || '';
            document.getElementById('newInstrumentManufacturer').value = item.manufacturer || '';
            document.getElementById('newInstrumentQuantity').value = item.quantity || 1;
            document.getElementById('newInstrumentOffice').value = item.officeId || '';
            document.getElementById('newInstrumentLocation').value = item.location || '';
            document.getElementById('newInstrumentVendor').value = item.vendorId || '';
            document.getElementById('newInstrumentSterilization').checked = item.sterilizationRequired || false;
            document.getElementById('newInstrumentLastSterilized').value = item.lastSterilized || '';
            document.getElementById('newInstrumentCondition').value = item.condition || '';
            document.getElementById('newInstrumentNotes').value = item.notes || '';
            document.getElementById('newInstrumentIsActive').checked = item.isActive !== false;
            
            document.getElementById('instrumentFormTitle').textContent = 'Edit Instrument';
            document.getElementById('instrumentSubmitBtn').innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Changes';
            
            document.getElementById('instrumentFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete instrument
        function deleteInstrument(instrumentID) {
            if (confirm('Are you sure you want to delete this instrument?')) {
                const instruments = loadInstruments();
                const updated = instruments.filter(i => i.instrumentID !== instrumentID);
                saveInstruments(updated);
                displayInstrumentsList();
                updateInventoryBadges();
            }
        }

        // ============ INVENTORY LIST VIEWS ============

        // Update sidebar badge counts
        function updateInventoryBadges() {
            const equipment = loadEquipment();
            const instruments = loadInstruments();
            const supplies = loadSupplies();
            const procedures = loadProcedures();
            
            const equipBadge = document.getElementById('equipmentCountBadge');
            const instBadge = document.getElementById('instrumentsCountBadge');
            const suppBadge = document.getElementById('suppliesCountBadge');
            const procBadge = document.getElementById('proceduresCountBadge');
            
            if (equipBadge) equipBadge.textContent = equipment.filter(e => e.isActive !== false).length;
            if (instBadge) instBadge.textContent = instruments.filter(i => i.isActive !== false).length;
            if (suppBadge) suppBadge.textContent = supplies.filter(s => s.isActive !== false).length;
            if (procBadge) procBadge.textContent = procedures.length;
        }

        // ---- EQUIPMENT LIST VIEW ----
        function openEquipmentListView() {
            const modal = document.getElementById('equipmentListModal');
            modal.style.display = 'flex';
            populateEquipmentListCategories();
            renderEquipmentListView();
        }

        function closeEquipmentListView() {
            document.getElementById('equipmentListModal').style.display = 'none';
        }

        function populateEquipmentListCategories() {
            const equipment = loadEquipment();
            const categories = [...new Set(equipment.map(e => e.category).filter(Boolean))];
            const select = document.getElementById('equipmentListCategory');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.sort().forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function filterEquipmentList() {
            renderEquipmentListView();
        }

        function renderEquipmentListView() {
            const equipment = loadEquipment().filter(e => e.isActive !== false);
            const search = document.getElementById('equipmentListSearch').value.toLowerCase();
            const category = document.getElementById('equipmentListCategory').value;
            const container = document.getElementById('equipmentListContent');
            
            let filtered = equipment;
            if (search) {
                filtered = filtered.filter(e => 
                    e.equipmentName?.toLowerCase().includes(search) ||
                    e.manufacturer?.toLowerCase().includes(search) ||
                    e.model?.toLowerCase().includes(search)
                );
            }
            if (category) {
                filtered = filtered.filter(e => e.category === category);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No equipment found.</p>';
                return;
            }
            
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-secondary); text-align: left;">
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Equipment Name</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Category</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Manufacturer</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Model</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Location</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(e => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75rem; font-weight: 500;">${e.equipmentName || '-'}</td>
                                <td style="padding: 0.75rem;">${e.category || '-'}</td>
                                <td style="padding: 0.75rem;">${e.manufacturer || '-'}</td>
                                <td style="padding: 0.75rem;">${e.model || '-'}</td>
                                <td style="padding: 0.75rem;">${e.officeName || '-'}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: ${e.status === 'Operational' ? '#d1fae5' : e.status === 'Needs Repair' ? '#fef3c7' : '#fee2e2'}; color: ${e.status === 'Operational' ? '#065f46' : e.status === 'Needs Repair' ? '#92400e' : '#991b1b'};">
                                        ${e.status || 'Unknown'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ---- INSTRUMENTS LIST VIEW ----
        function openInstrumentsListView() {
            const modal = document.getElementById('instrumentsListModal');
            modal.style.display = 'flex';
            populateInstrumentsListCategories();
            renderInstrumentsListView();
        }

        function closeInstrumentsListView() {
            document.getElementById('instrumentsListModal').style.display = 'none';
        }

        function populateInstrumentsListCategories() {
            const instruments = loadInstruments();
            const categories = [...new Set(instruments.map(i => i.category).filter(Boolean))];
            const select = document.getElementById('instrumentsListCategory');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.sort().forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function filterInstrumentsList() {
            renderInstrumentsListView();
        }

        function renderInstrumentsListView() {
            const instruments = loadInstruments().filter(i => i.isActive !== false);
            const search = document.getElementById('instrumentsListSearch').value.toLowerCase();
            const category = document.getElementById('instrumentsListCategory').value;
            const container = document.getElementById('instrumentsListContent');
            
            let filtered = instruments;
            if (search) {
                filtered = filtered.filter(i => 
                    i.instrumentName?.toLowerCase().includes(search) ||
                    i.manufacturer?.toLowerCase().includes(search) ||
                    i.instrumentType?.toLowerCase().includes(search)
                );
            }
            if (category) {
                filtered = filtered.filter(i => i.category === category);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No instruments found.</p>';
                return;
            }
            
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-secondary); text-align: left;">
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Instrument Name</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Category</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Type</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Manufacturer</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Qty</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Condition</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(i => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75rem; font-weight: 500;">${i.instrumentName || '-'}</td>
                                <td style="padding: 0.75rem;">${i.category || '-'}</td>
                                <td style="padding: 0.75rem;">${i.instrumentType || '-'}</td>
                                <td style="padding: 0.75rem;">${i.manufacturer || '-'}</td>
                                <td style="padding: 0.75rem;">${i.quantity || 1}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: ${i.condition === 'Excellent' || i.condition === 'Good' ? '#d1fae5' : i.condition === 'Fair' ? '#fef3c7' : '#fee2e2'}; color: ${i.condition === 'Excellent' || i.condition === 'Good' ? '#065f46' : i.condition === 'Fair' ? '#92400e' : '#991b1b'};">
                                        ${i.condition || 'Unknown'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ---- SUPPLIES LIST VIEW ----
        function openSuppliesListView() {
            const modal = document.getElementById('suppliesListModal');
            modal.style.display = 'flex';
            populateSuppliesListCategories();
            renderSuppliesListView();
        }

        function closeSuppliesListView() {
            document.getElementById('suppliesListModal').style.display = 'none';
        }

        function populateSuppliesListCategories() {
            const supplies = loadSupplies();
            const categories = [...new Set(supplies.map(s => s.category).filter(Boolean))];
            const select = document.getElementById('suppliesListCategory');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.sort().forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function filterSuppliesList() {
            renderSuppliesListView();
        }

        function renderSuppliesListView() {
            const supplies = loadSupplies().filter(s => s.isActive !== false);
            const search = document.getElementById('suppliesListSearch').value.toLowerCase();
            const category = document.getElementById('suppliesListCategory').value;
            const container = document.getElementById('suppliesListContent');
            
            let filtered = supplies;
            if (search) {
                filtered = filtered.filter(s => 
                    s.supplyName?.toLowerCase().includes(search) ||
                    s.manufacturer?.toLowerCase().includes(search) ||
                    s.sku?.toLowerCase().includes(search)
                );
            }
            if (category) {
                filtered = filtered.filter(s => s.category === category);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No supplies found.</p>';
                return;
            }
            
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-secondary); text-align: left;">
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Supply Name</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Category</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">SKU</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Qty</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Min Stock</th>
                            <th style="padding: 0.75rem; border-bottom: 2px solid var(--border-color);">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(s => {
                            const isLow = s.quantity <= (s.minStock || 0);
                            return `
                            <tr style="border-bottom: 1px solid var(--border-color); ${isLow ? 'background: #fef3c7;' : ''}">
                                <td style="padding: 0.75rem; font-weight: 500;">${s.supplyName || '-'}</td>
                                <td style="padding: 0.75rem;">${s.category || '-'}</td>
                                <td style="padding: 0.75rem;">${s.sku || '-'}</td>
                                <td style="padding: 0.75rem;">${s.quantity || 0}</td>
                                <td style="padding: 0.75rem;">${s.minStock || '-'}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: ${isLow ? '#fee2e2' : '#d1fae5'}; color: ${isLow ? '#991b1b' : '#065f46'};">
                                        ${isLow ? 'Low Stock' : 'In Stock'}
                                    </span>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        // ============ SUPPLIES MANAGEMENT ============
        
        // Load supplies from localStorage
        function loadSupplies() {
            const supplies = localStorage.getItem('supplies');
            return supplies ? JSON.parse(supplies) : [];
        }

        // Save supplies to localStorage and sync to API
        function saveSupplies(supplies, newItem = null) {
            localStorage.setItem('supplies', JSON.stringify(supplies));
            // Sync new item to API if provided
            if (newItem && typeof saveSupplyToAPI === 'function') {
                saveSupplyToAPI(newItem);
            }
        }

        // Open supplies management modal
        function openSuppliesManagement() {
            const modal = document.getElementById('suppliesManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                populateSupplyOfficeDropdown();
                populateSupplyVendorDropdown();
                displaySuppliesList();
            }
        }

        // Close supplies management modal
        function closeSuppliesManagement() {
            const modal = document.getElementById('suppliesManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            document.getElementById('createSupplyForm').reset();
            document.getElementById('createSupplyError').style.display = 'none';
            document.getElementById('editSupplyId').value = '';
            document.getElementById('supplyFormTitle').textContent = 'Add New Supply';
            document.getElementById('supplySubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Supply';
        }

        // Populate office dropdown for supplies
        function populateSupplyOfficeDropdown() {
            const offices = loadOffices();
            const dropdown = document.getElementById('newSupplyOffice');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Office</option>';
                offices.forEach(office => {
                    const option = document.createElement('option');
                    option.value = office.officeID;
                    option.textContent = office.officeName;
                    dropdown.appendChild(option);
                });
            }
        }

        // Populate vendor dropdown for supplies
        function populateSupplyVendorDropdown() {
            const vendors = loadVendors();
            const dropdown = document.getElementById('newSupplyVendor');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">Select Vendor</option>';
                const activeVendors = vendors.filter(v => v.isActive !== false);
                activeVendors.sort((a, b) => a.vendorName.localeCompare(b.vendorName));
                activeVendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor.vendorID;
                    option.textContent = vendor.vendorName + (vendor.vendorType ? ` (${vendor.vendorType})` : '');
                    dropdown.appendChild(option);
                });
            }
        }

        // Create or Update supply
        function createSupply(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editSupplyId').value;
            const isEdit = !!editId;
            
            const supplyName = document.getElementById('newSupplyName').value.trim();
            const category = document.getElementById('newSupplyCategory').value;
            const sku = document.getElementById('newSupplySKU').value.trim();
            const manufacturer = document.getElementById('newSupplyManufacturer').value.trim();
            const quantityInStock = parseInt(document.getElementById('newSupplyQuantity').value) || 0;
            const unit = document.getElementById('newSupplyUnit').value.trim();
            const reorderLevel = parseInt(document.getElementById('newSupplyReorderLevel').value) || 0;
            const officeId = document.getElementById('newSupplyOffice').value;
            const location = document.getElementById('newSupplyLocation').value.trim();
            const vendorId = document.getElementById('newSupplyVendor').value;
            const unitCost = parseFloat(document.getElementById('newSupplyUnitCost').value) || 0;
            const expirationDate = document.getElementById('newSupplyExpiration').value;
            const notes = document.getElementById('newSupplyNotes').value.trim();
            const isActive = document.getElementById('newSupplyIsActive').checked;
            const errorDiv = document.getElementById('createSupplyError');
            
            if (!supplyName || !category) {
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#fee';
                errorDiv.style.borderColor = '#fcc';
                errorDiv.style.color = '#c33';
                errorDiv.textContent = 'Please fill in Supply Name and Category.';
                return;
            }
            
            const supplies = loadSupplies();
            
            const offices = loadOffices();
            const selectedOffice = offices.find(o => o.officeID == officeId);
            const officeName = selectedOffice ? selectedOffice.officeName : '';
            
            const vendors = loadVendors();
            const selectedVendor = vendors.find(v => v.vendorID == vendorId);
            const vendorName = selectedVendor ? selectedVendor.vendorName : '';
            
            if (isEdit) {
                const index = supplies.findIndex(s => s.supplyID === parseInt(editId));
                if (index > -1) {
                    supplies[index] = {
                        ...supplies[index],
                        supplyName,
                        category,
                        sku,
                        manufacturer,
                        quantityInStock,
                        unit,
                        reorderLevel,
                        officeId,
                        officeName,
                        location,
                        vendorId,
                        vendorName,
                        unitCost,
                        expirationDate,
                        notes,
                        isActive,
                        modifiedDate: new Date().toISOString()
                    };
                    saveSupplies(supplies);
                    
                    errorDiv.style.display = 'block';
                    errorDiv.style.background = '#d4edda';
                    errorDiv.style.borderColor = '#c3e6cb';
                    errorDiv.style.color = '#155724';
                    errorDiv.textContent = `Supply "${supplyName}" updated successfully!`;
                }
            } else {
                const newSupply = {
                    supplyID: Date.now(),
                    supplyName,
                    category,
                    sku,
                    manufacturer,
                    quantityInStock,
                    unit,
                    reorderLevel,
                    officeId,
                    officeName,
                    location,
                    vendorId,
                    vendorName,
                    unitCost,
                    expirationDate,
                    notes,
                    isActive,
                    createdDate: new Date().toISOString(),
                    modifiedDate: new Date().toISOString()
                };
                
                supplies.push(newSupply);
                // Save to localStorage and sync to API
                saveSupplies(supplies, {
                    name: supplyName,
                    category: category,
                    clinicId: officeId ? parseInt(officeId) : null,
                    quantity: quantityInStock || 0,
                    minQuantity: reorderLevel || 0,
                    unit: unit,
                    unitPrice: unitCost || null,
                    notes: notes
                });
                
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.borderColor = '#c3e6cb';
                errorDiv.style.color = '#155724';
                errorDiv.textContent = `Supply "${supplyName}" added successfully!`;
            }
            
            document.getElementById('createSupplyForm').reset();
            document.getElementById('editSupplyId').value = '';
            document.getElementById('supplyFormTitle').textContent = 'Add New Supply';
            document.getElementById('supplySubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Supply';
            document.getElementById('supplyFormSection').style.display = 'none';
            
            displaySuppliesList();
            updateInventoryBadges();
            
            setTimeout(() => { errorDiv.style.display = 'none'; }, 3000);
        }

        // Display supplies list
        function displaySuppliesList() {
            const supplies = loadSupplies();
            const suppliesList = document.getElementById('suppliesList');
            
            if (!suppliesList) return;
            
            if (supplies.length === 0) {
                suppliesList.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No supplies added yet. Click "Add New Supply" to get started.</td></tr>';
                return;
            }
            
            supplies.sort((a, b) => {
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return a.supplyName.localeCompare(b.supplyName);
            });
            
            suppliesList.innerHTML = supplies.map(item => {
                const isLowStock = item.reorderLevel && item.quantityInStock <= item.reorderLevel;
                const isExpiringSoon = item.expirationDate && new Date(item.expirationDate) < new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                const isExpired = item.expirationDate && new Date(item.expirationDate) < new Date();
                
                return `
                <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s; ${!item.isActive ? 'opacity: 0.6;' : ''}" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <div style="font-weight: 600;">${item.supplyName}</div>
                        ${item.manufacturer ? `<div style="font-size: 0.8rem; color: var(--text-tertiary);">${item.manufacturer}</div>` : ''}
                    </td>
                    <td style="padding: 1rem;">
                        <span style="background: #8b5cf620; color: #8b5cf6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">${item.category}</span>
                    </td>
                    <td style="padding: 1rem; color: ${isLowStock ? '#f59e0b' : 'var(--text-secondary)'}; font-weight: ${isLowStock ? '600' : '400'};">
                        ${item.quantityInStock || 0} ${item.unit || ''}
                        ${isLowStock ? ' <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>' : ''}
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">${item.reorderLevel || '-'}</td>
                    <td style="padding: 1rem; color: ${isExpired ? '#ef4444' : isExpiringSoon ? '#f59e0b' : 'var(--text-secondary)'};">
                        ${item.expirationDate ? new Date(item.expirationDate).toLocaleDateString() : '-'}
                        ${isExpired ? ' <span style="color: #ef4444; font-size: 0.7rem;">(EXPIRED)</span>' : isExpiringSoon ? ' <i class="fas fa-clock" style="color: #f59e0b;"></i>' : ''}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="editSupply(${item.supplyID})" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Edit Supply">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSupply(${item.supplyID})" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete Supply">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Open Add Supply Form
        function openAddSupplyForm() {
            document.getElementById('supplyFormSection').style.display = 'block';
            document.getElementById('supplyFormTitle').textContent = 'Add New Supply';
            document.getElementById('supplySubmitBtn').innerHTML = '<i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>Add Supply';
            document.getElementById('editSupplyId').value = '';
            document.getElementById('createSupplyForm').reset();
            document.getElementById('newSupplyIsActive').checked = true;
            document.getElementById('supplyFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Close Supply Form
        function closeSupplyForm() {
            document.getElementById('supplyFormSection').style.display = 'none';
            document.getElementById('createSupplyForm').reset();
            document.getElementById('editSupplyId').value = '';
        }

        // Edit supply
        function editSupply(supplyID) {
            const supplies = loadSupplies();
            const item = supplies.find(s => s.supplyID === supplyID);
            
            if (!item) return;
            
            // Show the form section
            document.getElementById('supplyFormSection').style.display = 'block';
            
            document.getElementById('editSupplyId').value = item.supplyID;
            document.getElementById('newSupplyName').value = item.supplyName || '';
            document.getElementById('newSupplyCategory').value = item.category || '';
            document.getElementById('newSupplySKU').value = item.sku || '';
            document.getElementById('newSupplyManufacturer').value = item.manufacturer || '';
            document.getElementById('newSupplyQuantity').value = item.quantityInStock || 0;
            document.getElementById('newSupplyUnit').value = item.unit || '';
            document.getElementById('newSupplyReorderLevel').value = item.reorderLevel || 0;
            document.getElementById('newSupplyOffice').value = item.officeId || '';
            document.getElementById('newSupplyLocation').value = item.location || '';
            document.getElementById('newSupplyVendor').value = item.vendorId || '';
            document.getElementById('newSupplyUnitCost').value = item.unitCost || '';
            document.getElementById('newSupplyExpiration').value = item.expirationDate || '';
            document.getElementById('newSupplyNotes').value = item.notes || '';
            document.getElementById('newSupplyIsActive').checked = item.isActive !== false;
            
            document.getElementById('supplyFormTitle').textContent = 'Edit Supply';
            document.getElementById('supplySubmitBtn').innerHTML = '<i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Changes';
            
            document.getElementById('supplyFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete supply
        function deleteSupply(supplyID) {
            if (confirm('Are you sure you want to delete this supply?')) {
                const supplies = loadSupplies();
                const updated = supplies.filter(s => s.supplyID !== supplyID);
                saveSupplies(updated);
                displaySuppliesList();
                updateInventoryBadges();
            }
        }

        // ============ PHOTO & DOCUMENTS HANDLING ============
        
        // Store uploaded files temporarily
        let uploadedPhoto = null;
        let uploadedDocuments = [];
        let uploadedOfficeLogo = null;

        // Preview photo
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo size must be less than 5MB');
                    event.target.value = '';
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedPhoto = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        dataUrl: e.target.result
                    };
                    
                    // Show image preview - get elements fresh
                    const photoPreviewContainer = document.getElementById('photoPreview');
                    const previewImg = document.getElementById('photoPreviewImg');
                    const placeholderIcon = document.getElementById('photoPlaceholderIcon');
                    const removeBtn = document.getElementById('removePhotoBtn');
                    
                    console.log('Photo preview elements:', { previewImg, placeholderIcon, removeBtn }); // Debug
                    
                    if (previewImg) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                        previewImg.style.position = 'absolute';
                        previewImg.style.top = '0';
                        previewImg.style.left = '0';
                        previewImg.style.width = '100%';
                        previewImg.style.height = '100%';
                        previewImg.style.objectFit = 'cover';
                        previewImg.style.zIndex = '2';
                    }
                    if (placeholderIcon) {
                        placeholderIcon.style.display = 'none';
                    }
                    if (removeBtn) {
                        removeBtn.style.display = 'inline-flex';
                    }
                    
                    showNotification('Photo uploaded successfully!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove employee photo
        function removeEmployeePhoto() {
            uploadedPhoto = null;
            const fileInput = document.getElementById('employeePhoto');
            const previewImg = document.getElementById('photoPreviewImg');
            const placeholderIcon = document.getElementById('photoPlaceholderIcon');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            if (fileInput) fileInput.value = '';
            if (previewImg) {
                previewImg.src = '';
                previewImg.style.display = 'none';
            }
            if (placeholderIcon) placeholderIcon.style.display = 'block';
            if (removeBtn) removeBtn.style.display = 'none';
        }

        // Phone number auto-format
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) value = value.substring(0, 10);
            
            if (value.length >= 6) {
                input.value = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.substring(0, 3)}) ${value.substring(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        }

        // Initialize phone number formatting on all phone inputs
        function initPhoneFormatting() {
            const phoneInputs = document.querySelectorAll('input[type="tel"], input[id*="Phone"], input[id*="phone"]');
            phoneInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatPhoneNumber(this);
                });
                input.setAttribute('placeholder', '(555) 555-5555');
            });
        }

        // Load offices into dropdown
        async function loadOfficesForUserForm() {
            const officeSelect = document.getElementById('newOfficeLocation');
            if (!officeSelect) return;
            
            // Get offices from localStorage or API
            let offices = JSON.parse(localStorage.getItem('clinics') || '[]');
            
            // Try to get from API
            try {
                const response = await fetch('/api/clinics');
                if (response.ok) {
                    offices = await response.json();
                }
            } catch (e) {
                console.log('Using local offices data');
            }
            
            officeSelect.innerHTML = '<option value="">--Select Office--</option>';
            offices.forEach(office => {
                const name = office.Name || office.name || office.clinicName;
                officeSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }

        // Load supervisors into dropdown (users who are managers or admins)
        async function loadSupervisorsForUserForm() {
            const supervisorSelect = document.getElementById('newDirectSupervisor');
            if (!supervisorSelect) return;
            
            // Get users from localStorage or API
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Try to get from API
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    users = await response.json();
                }
            } catch (e) {
                console.log('Using local users data');
            }
            
            supervisorSelect.innerHTML = '<option value="">--Select Supervisor--</option>';
            users.forEach(user => {
                const name = user.FirstName && user.LastName 
                    ? `${user.FirstName} ${user.LastName}` 
                    : user.firstName && user.lastName 
                        ? `${user.firstName} ${user.lastName}` 
                        : user.name || user.username;
                const role = user.Role || user.role;
                if (name) {
                    supervisorSelect.innerHTML += `<option value="${name}">${name}${role ? ` (${role})` : ''}</option>`;
                }
            });
        }

        // Handle documents upload
        function handleDocumentsUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                uploadedDocuments = [];
                const documentsPreview = document.getElementById('documentsPreview');
                const documentsList = document.getElementById('documentsList');
                documentsPreview.innerHTML = '';
                
                Array.from(files).forEach(file => {
                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`File "${file.name}" is too large. Max size is 10MB`);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedDocuments.push({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            dataUrl: e.target.result
                        });
                        
                        // Create preview item
                        const docItem = document.createElement('div');
                        docItem.style.cssText = 'padding: 0.75rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; justify-content: space-between;';
                        
                        const fileIcon = file.type.includes('pdf') ? 'fa-file-pdf' : 
                                       file.type.includes('word') ? 'fa-file-word' : 
                                       file.type.includes('image') ? 'fa-file-image' : 'fa-file';
                        
                        const fileSizeKB = (file.size / 1024).toFixed(1);
                        
                        docItem.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas ${fileIcon}" style="font-size: 1.5rem; color: var(--accent-primary);"></i>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary); font-size: 0.9rem;">${file.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${fileSizeKB} KB</div>
                                </div>
                            </div>
                            <button type="button" onclick="removeDocument('${file.name}')" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        documentsPreview.appendChild(docItem);
                    };
                    reader.readAsDataURL(file);
                });
                
                documentsList.style.display = 'block';
            }
        }

        // Remove document from upload list
        function removeDocument(fileName) {
            uploadedDocuments = uploadedDocuments.filter(doc => doc.name !== fileName);
            const docItems = document.getElementById('documentsPreview').children;
            Array.from(docItems).forEach(item => {
                if (item.textContent.includes(fileName)) {
                    item.remove();
                }
            });
            
            if (uploadedDocuments.length === 0) {
                document.getElementById('documentsList').style.display = 'none';
                document.getElementById('employeeDocuments').value = '';
            }
        }

        // Preview office logo
        function previewOfficeLogo(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Logo size must be less than 5MB');
                    event.target.value = '';
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedOfficeLogo = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        dataUrl: e.target.result
                    };
                    
                    const preview = document.getElementById('officeLogoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Initialize auth check on page load (original code)
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUsers();
            updateUIForRole();
        });

        // Theme Management
        const root = document.documentElement;
        const themeToggle = document.querySelector('.theme-toggle');
        const accentButtons = document.querySelectorAll('.accent-btn');
        
        // Load saved preferences
        const savedTheme = localStorage.getItem('theme') || 'light';
        const savedAccent = localStorage.getItem('accent') || 'cyan';
        const savedThemePreset = localStorage.getItem('themePreset') || 'light';
        const savedRole = localStorage.getItem('userRole') || 'admin';
        
        root.setAttribute('data-theme', savedTheme);
        root.setAttribute('data-accent', savedAccent);
        root.setAttribute('data-theme-preset', savedThemePreset);
        root.setAttribute('data-role', savedRole);
        updateThemeIcon();
        updateAccentButtons();
        updateThemePresetButtons();
        updateRoleButtons();
        
        function toggleTheme() {
            const currentTheme = root.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon();
            
            // Force calendar to re-render events with new theme colors
            if (typeof calendar !== 'undefined' && calendar) {
                calendar.refetchEvents();
            }
        }
        
        function updateThemeIcon() {
            const theme = root.getAttribute('data-theme');
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        function setAccent(color) {
            root.setAttribute('data-accent', color);
            localStorage.setItem('accent', color);
            updateAccentButtons();
        }
        
        function updateAccentButtons() {
            const currentAccent = root.getAttribute('data-accent');
            accentButtons.forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(currentAccent));
            });
        }

        // Theme Preset Management
        function setThemePreset(preset) {
            root.setAttribute('data-theme-preset', preset);
            localStorage.setItem('themePreset', preset);
            updateThemePresetButtons();
            showNotification(`Theme changed to ${preset.charAt(0).toUpperCase() + preset.slice(1).replace('-', ' ')}`, 'success');
            
            // Force calendar to re-render events with new theme colors
            if (typeof calendar !== 'undefined' && calendar) {
                calendar.refetchEvents();
            }
        }

        function updateThemePresetButtons() {
            const currentPreset = root.getAttribute('data-theme-preset') || 'light';
            const presetButtons = document.querySelectorAll('.theme-preset-btn');
            presetButtons.forEach((btn, index) => {
                const presets = ['ocean', 'sunset', 'forest', 'professional', 'soft', 'vibrant', 'high-contrast'];
                btn.style.transform = presets[index] === currentPreset ? 'scale(1.15)' : 'scale(1)';
                btn.style.boxShadow = presets[index] === currentPreset ? '0 0 8px rgba(0,0,0,0.3)' : 'none';
            });
        }

        // Role Management
        function switchRole(role) {
            root.setAttribute('data-role', role);
            localStorage.setItem('userRole', role);
            updateRoleButtons();
            updateViewTitle();
            updateEventList();
            toggleUserStats(role);
            
            // Reload calendar with role-specific events
            if (calendar) {
                calendar.refetchEvents();
            }
        }

        function updateRoleButtons() {
            const currentRole = root.getAttribute('data-role');
            const roleButtons = document.querySelectorAll('.role-btn');
            roleButtons.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-role') === currentRole);
            });
            
            // Update user role display
            const roleDisplay = document.getElementById('currentRole');
            roleDisplay.textContent = currentRole === 'admin' ? 'Administrator' : 'User';
        }

        function updateViewTitle() {
            const currentRole = root.getAttribute('data-role');
            const viewTitle = document.getElementById('viewTitle');
            viewTitle.textContent = currentRole === 'admin' ? 'Schedule Overview' : 'My Schedule';
        }

        function toggleUserStats(role) {
            try {
                const adminStats = document.querySelector('.stats-grid.admin-only');
                const userStats = document.querySelector('[data-user-stats]');
                
                if (role === 'user') {
                    if (adminStats) adminStats.style.display = 'none';
                    if (userStats) userStats.style.display = 'grid';
                } else {
                    if (adminStats) adminStats.style.display = 'grid';
                    if (userStats) userStats.style.display = 'none';
                }
            } catch (error) {
                console.error('Error toggling user stats:', error);
            }
        }

        // Header Bar Toggle Function
        function toggleHeaderBar() {
            const header = document.querySelector('.header');
            const container = document.querySelector('.container');
            const button = document.getElementById('cornerToggleTop');
            const icon = button.querySelector('i');
            
            if (header.style.transform === 'translateY(-100%)') {
                // Show header
                header.style.transform = 'translateY(0)';
                container.classList.remove('header-hidden');
                icon.className = 'fas fa-chevron-up';
                button.setAttribute('title', 'Hide Header Bar');
            } else {
                // Hide header
                header.style.transform = 'translateY(-100%)';
                container.classList.add('header-hidden');
                icon.className = 'fas fa-chevron-down';
                button.setAttribute('title', 'Show Header Bar');
            }
        }

        // Employee Selection
        let selectedEmployee = 'all';
        let currentViewMode = 'date'; // 'date', 'employee', or 'room'
        
        // Table View State
        let isTableView = false;
        let currentSortColumn = 0;
        let sortAscending = true;

        // Declare openWorkingHours early so it's available for HTML onclick handlers
        function openWorkingHours() {
            // Toggle working hours display in the main calendar
            showWorkingHours = !showWorkingHours;
            
            // Update button state
            const btn = document.querySelector('[onclick="openWorkingHours()"]');
            if (btn) {
                if (showWorkingHours) {
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    btn.innerHTML = '<i class="fas fa-clock"></i> Hide Working Hours';
                } else {
                    btn.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
                    btn.innerHTML = '<i class="fas fa-clock"></i> Working Hours';
                }
            }
            
            // Re-render the custom calendar to show/hide working hours
            if (window.calendarInstance) {
                window.calendarInstance.render();
                
                // Initialize filters after rendering if working hours are shown
                if (showWorkingHours) {
                    setTimeout(() => {
                        initializeWorkingHoursFilters();
                    }, 100);
                }
            }
        }

        // Employee Data Type Management (Working Hours, Duties, Assistants)
        let currentEmployeeDataType = 'none'; // 'none', 'working-hours', 'duties', 'assistants'

        function toggleEmployeeDataType() {
            console.log('toggleEmployeeDataType called');
            const dropdown = document.getElementById('employeeDataTypeDropdown');
            const btn = document.getElementById('employeeDataTypeBtn');
            console.log('Dropdown element:', dropdown);
            console.log('Button element:', btn);
            
            if (dropdown && btn) {
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    // Position the dropdown below the button using fixed positioning
                    const btnRect = btn.getBoundingClientRect();
                    dropdown.style.position = 'fixed';
                    dropdown.style.top = (btnRect.bottom + 8) + 'px';
                    dropdown.style.left = (btnRect.left) + 'px';
                    dropdown.style.display = 'block';
                    console.log('Showing dropdown at:', dropdown.style.top, dropdown.style.left);
                    
                    // Restore checkmark state when opening dropdown
                    updateDropdownCheckmarks();
                } else {
                    dropdown.style.display = 'none';
                    console.log('Hiding dropdown');
                }
            } else {
                console.error('Dropdown or button element not found!');
            }
        }

        function updateDropdownCheckmarks() {
            // Remove all checkmarks first
            document.querySelectorAll('#employeeDataTypeDropdown .checkmark').forEach(check => {
                check.style.opacity = '0';
            });
            
            // Show checkmark for currently selected type
            if (currentEmployeeDataType === 'working-hours') {
                const whCheck = document.querySelector('#option-working-hours .checkmark');
                if (whCheck) whCheck.style.opacity = '1';
            } else if (currentEmployeeDataType === 'duties') {
                const dutyCheck = document.querySelector('#option-duties .checkmark');
                if (dutyCheck) dutyCheck.style.opacity = '1';
            } else if (currentEmployeeDataType === 'assistants') {
                const assistCheck = document.querySelector('#option-assistants .checkmark');
                if (assistCheck) assistCheck.style.opacity = '1';
            } else if (currentEmployeeDataType === 'none') {
                const clearCheck = document.querySelector('#option-clear .checkmark');
                if (clearCheck) clearCheck.style.opacity = '1';
            }
        }

        function selectEmployeeDataType(type) {
            console.log('selectEmployeeDataType called with type:', type);
            const btn = document.getElementById('employeeDataTypeBtn');
            const text = document.getElementById('employeeDataTypeText');
            const dropdown = document.getElementById('employeeDataTypeDropdown');
            
            console.log('Button:', btn, 'Text:', text, 'Dropdown:', dropdown);
            
            // Close dropdown
            if (dropdown) dropdown.style.display = 'none';
            
            // Remove all checkmarks first
            document.querySelectorAll('#employeeDataTypeDropdown .checkmark').forEach(check => {
                check.style.opacity = '0';
            });
            
            // Handle Clear Filter (none)
            if (type === 'none') {
                console.log('Clearing filter');
                currentEmployeeDataType = 'none';
                showWorkingHours = false;
                
                if (btn) {
                    btn.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
                }
                if (text) {
                    text.previousElementSibling.className = 'fas fa-clock';
                    text.textContent = 'Select Data Type';
                }
                // Show checkmark on Clear Filter
                const clearCheck = document.querySelector('#option-clear .checkmark');
                if (clearCheck) clearCheck.style.opacity = '1';
            }
            // Toggle if clicking the same type
            else if (currentEmployeeDataType === type) {
                console.log('Toggling OFF type:', type);
                // Turn off everything
                currentEmployeeDataType = 'none';
                showWorkingHours = false;
                
                if (btn) {
                    btn.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
                }
                if (text) {
                    text.previousElementSibling.className = 'fas fa-clock';
                    text.textContent = 'Select Data Type';
                }
            } else {
                console.log('Toggling ON type:', type, 'from:', currentEmployeeDataType);
                // Turn off all other types first (mutually exclusive)
                showWorkingHours = false;
                
                // Turn on new type
                currentEmployeeDataType = type;
                
                // Update button appearance
                if (btn) {
                    btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                }
                
                // Update button text, icon, and enable the selected type
                if (text) {
                    switch(type) {
                        case 'working-hours':
                            text.previousElementSibling.className = 'fas fa-clock';
                            text.textContent = 'Working Hours';
                            showWorkingHours = true;
                            // Show checkmark
                            const whCheck = document.querySelector('#option-working-hours .checkmark');
                            if (whCheck) whCheck.style.opacity = '1';
                            break;
                        case 'duties':
                            text.previousElementSibling.className = 'fas fa-clipboard-list';
                            text.textContent = 'Duties';
                            // Show checkmark
                            const dutyCheck = document.querySelector('#option-duties .checkmark');
                            if (dutyCheck) dutyCheck.style.opacity = '1';
                            break;
                        case 'assistants':
                            text.previousElementSibling.className = 'fas fa-user-friends';
                            text.textContent = 'Assistants';
                            // Show checkmark
                            const assistCheck = document.querySelector('#option-assistants .checkmark');
                            if (assistCheck) assistCheck.style.opacity = '1';
                            break;
                    }
                }
            }
            
            console.log('Current state - currentEmployeeDataType:', currentEmployeeDataType, 'showWorkingHours:', showWorkingHours);
            
            // Re-render the calendar to show/hide the selected data
            if (window.calendarInstance) {
                console.log('Rendering calendar...');
                window.calendarInstance.render();
                
                // Initialize filters after rendering if working hours are shown
                if (currentEmployeeDataType === 'working-hours') {
                    setTimeout(() => {
                        initializeWorkingHoursFilters();
                    }, 100);
                }
            } else {
                console.error('calendarInstance not found!');
            }
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }

        // Generate Tasks Events for Calendar Display
        function generateTasksEventsForRange(startDate, endDate) {
            console.log('generateTasksEventsForRange called:', startDate, endDate);
            const events = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            console.log('Tasks database length:', employeeTasksDatabase.length);
            
            employeeTasksDatabase.forEach(task => {
                // Skip tasks with no due date
                if (!task.dueDate) {
                    console.warn('Task has no due date:', task.title);
                    return;
                }
                
                const taskDate = new Date(task.dueDate);
                
                // Validate date
                if (isNaN(taskDate.getTime())) {
                    console.warn('Task has invalid due date:', task.title, task.dueDate);
                    return;
                }
                
                console.log('Checking task:', task.title, 'Date:', task.dueDate, 'Range:', start, '-', end);
                
                if (taskDate >= start && taskDate <= end) {
                    // Use default time if not specified
                    const taskTime = task.dueTime || '09:00';
                    
                    const newEvent = {
                        id: task.id,
                        title: 'ðŸ“‹ ' + task.title,
                        start: `${task.dueDate}T${taskTime}:00`,
                        end: `${task.dueDate}T${taskTime}:00`,
                        resourceId: task.employeeId,
                        employee: task.employeeId,
                        priority: task.priority,
                        isTask: true,
                        taskStatus: task.status,
                        description: task.description,
                        extendedProps: {
                            type: 'task',
                            status: task.status,
                            description: task.description
                        }
                    };
                    
                    console.log('Adding task event:', newEvent);
                    events.push(newEvent);
                }
            });
            
            console.log('Generated', events.length, 'task events');
            return events;
        }

        // Generate Duties Events for Calendar Display
        function generateDutiesEventsForRange(startDate, endDate) {
            const events = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Iterate through each day in range
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = d.toISOString().split('T')[0];
                
                employeeDutiesDatabase.forEach(duty => {
                    // Skip duties with no time defined
                    if (!duty.startTime || !duty.endTime) {
                        console.warn('Duty has no start/end time:', duty.title);
                        return;
                    }
                    
                    let shouldShow = false;
                    
                    if (duty.type === 'daily') {
                        shouldShow = true;
                    } else if (duty.type === 'recurring' && duty.days && duty.days.includes(dayName)) {
                        shouldShow = true;
                    }
                    
                    if (shouldShow) {
                        events.push({
                            id: `${duty.id}-${dateStr}`,
                            title: 'ðŸ“Œ ' + duty.title,
                            start: `${dateStr}T${duty.startTime}:00`,
                            end: `${dateStr}T${duty.endTime}:00`,
                            resourceId: duty.employeeId,
                            employee: duty.employeeId,
                            isDuty: true,
                            dutyType: duty.type,
                            description: duty.description,
                            extendedProps: {
                                type: 'duty',
                                dutyType: duty.type,
                                description: duty.description
                            }
                        });
                    }
                });
            }
            
            return events;
        }

        // Generate Assistants Events for Calendar Display
        function generateAssistantsEventsForRange(startDate, endDate) {
            const events = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Helper function to convert 24-hour time to 12-hour AM/PM format
            function formatTimeAMPM(time24) {
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            }
            
            // Sample assistant database - in real app this would come from backend
            const assistantsDatabase = [
                // Dr. Sarah Johnson's Assistants
                { id: 'a1', name: 'Emma Rodriguez', providerId: 'dr-sarah-johnson', startTime: '08:00', endTime: '16:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], color: '#6366f1', room: 'Room 1', clinic: 'Main Clinic' },
                { id: 'a2', name: 'Lisa Anderson', providerId: 'dr-sarah-johnson', startTime: '14:00', endTime: '22:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], color: '#84cc16', room: 'Room A', clinic: 'Downtown Clinic' },
                
                // Dr. Michael Chen's Assistants
                { id: 'a3', name: 'Lisa Anderson', providerId: 'dr-michael-chen', startTime: '08:00', endTime: '16:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], color: '#84cc16', room: 'Room 2', clinic: 'Main Clinic' },
                
                // Dr. Robert Lee's Assistants
                { id: 'a4', name: 'David Kim', providerId: 'dr-robert-lee', startTime: '08:00', endTime: '16:00', days: ['Monday', 'Tuesday', 'Thursday', 'Friday', 'Saturday'], color: '#f97316', room: 'Room B', clinic: 'Downtown Clinic' },
                
                // Dr. Patricia Martinez's Assistants
                { id: 'a5', name: 'Michelle White', providerId: 'dr-patricia-martinez', startTime: '10:00', endTime: '18:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], color: '#ef4444', room: 'Room C', clinic: 'Downtown Clinic' },
                { id: 'a6', name: 'Michelle White', providerId: 'dr-patricia-martinez', startTime: '10:00', endTime: '18:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], color: '#ef4444', room: 'Suite 2', clinic: 'Uptown Clinic' },
                
                // Dr. Jennifer Garcia (No assigned assistant but can add temporary)
                
                // Dr. William Taylor's Assistants
                { id: 'a7', name: 'David Kim', providerId: 'dr-william-taylor', startTime: '08:00', endTime: '16:00', days: ['Monday', 'Tuesday', 'Friday', 'Saturday'], color: '#f97316', room: 'Suite 4', clinic: 'Uptown Clinic' },
            ];
            
            // Iterate through each day in range
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = d.toISOString().split('T')[0];
                
                assistantsDatabase.forEach(assistant => {
                    // Check if assistant works on this day
                    if (assistant.days.includes(dayName)) {
                        const startHour = parseInt(assistant.startTime.split(':')[0]);
                        const endHour = parseInt(assistant.endTime.split(':')[0]);
                        const duration = endHour - startHour;
                        
                        const startTimeAMPM = formatTimeAMPM(assistant.startTime);
                        const endTimeAMPM = formatTimeAMPM(assistant.endTime);
                        
                        events.push({
                            id: `${assistant.id}-${dateStr}`,
                            title: `${assistant.name}`,
                            start: `${dateStr}T${assistant.startTime}:00`,
                            end: `${dateStr}T${assistant.endTime}:00`,
                            resourceId: assistant.providerId,
                            provider: assistant.providerId,
                            isAssistant: true,
                            assistantName: assistant.name,
                            timeRange: `${startTimeAMPM} - ${endTimeAMPM}`,
                            extendedProps: {
                                type: 'assistant',
                                assistantId: assistant.id,
                                assistantName: assistant.name,
                                room: assistant.room,
                                timeRange: `${startTimeAMPM} - ${endTimeAMPM}`,
                                daysWorked: assistant.days.join(', ')
                            }
                        });
                    }
                });
            }
            
            console.log('Generated assistant events:', events.length);
            return events;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('employeeDataTypeDropdown');
            const btn = document.getElementById('employeeDataTypeBtn');
            
            if (dropdown && btn) {
                if (!btn.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            }
        });

        function selectEmployee(employeeId) {
            selectedEmployee = employeeId;
            
            // Update UI
            document.querySelectorAll('.employee-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-employee="${employeeId}"]`).classList.add('active');
            
            // Refetch calendar events
            if (calendar) {
                calendar.refetchEvents();
            }
        }

        // View Mode Switching
        function switchViewMode(mode) {
            currentViewMode = mode;
            
            // Update toggle buttons
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view-mode="${mode}"]`).classList.add('active');
            
            // Show/hide event filter controls based on view mode
            const filterControls = document.getElementById('eventFilterControls');
            if (filterControls) {
                if (mode === 'provider') {
                    filterControls.style.display = 'block';
                    updateEventFilterUI();
                } else {
                    filterControls.style.display = 'none';
                }
            }
            
            // Update resource filter UI (preserves filter state for this view)
            updateFilterUI();
            
            // Update calendar view mode (for custom calendar)
            if (window.updateCalendarViewMode) {
                window.updateCalendarViewMode(mode);
            } else {
                // Use custom calendar's built-in view switching
                if (window.calendarInstance && window.calendarInstance.render) {
                    window.calendarInstance.render();
                    
                    // Update legend after view changes
                    setTimeout(() => {
                        updateResourceLegend(mode);
                    }, 300);
                }
            }
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }

        // ===== ZOOM FUNCTIONALITY =====
        let currentZoom = 1.0;
        const minZoom = 0.1;
        const maxZoom = 2.0;

        function zoomCalendar(delta) {
            currentZoom += delta;
            currentZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom));
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1.0;
            applyZoom();
        }

        function applyZoom() {
            const gridWrapper = document.getElementById('calendarGridWrapper');
            if (gridWrapper) {
                gridWrapper.style.transform = `scale(${currentZoom})`;
                gridWrapper.style.transformOrigin = 'top left';
                gridWrapper.style.width = `${100 / currentZoom}%`;
            }
            // Update zoom level display
            const zoomLevelEl = document.getElementById('zoomLevel');
            if (zoomLevelEl) {
                zoomLevelEl.textContent = Math.round(currentZoom * 100) + '%';
            }
        }

        // Optional: Add mouse wheel zoom with Ctrl key
        document.addEventListener('DOMContentLoaded', function() {
            const calendar = document.getElementById('calendar');
            if (calendar) {
                calendar.addEventListener('wheel', function(e) {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? -0.1 : 0.1;
                        zoomCalendar(delta);
                    }
                }, { passive: false });
            }
        });

        // ===== END ZOOM FUNCTIONALITY =====

        // ===== IMPROVED DYNAMIC FILTER SYSTEM =====
        
        // Clinic filter for date view
        let clinicFilter = '';
        
        // ===== COLUMN REORDERING SYSTEM =====
        let resourceColumnOrder = {};
        
        function loadColumnOrder() {
            try {
                const saved = localStorage.getItem('reformDental_columnOrder');
                if (saved) resourceColumnOrder = JSON.parse(saved);
            } catch (e) {
                console.warn('Could not load column order:', e);
            }
        }
        
        function saveColumnOrder() {
            try {
                localStorage.setItem('reformDental_columnOrder', JSON.stringify(resourceColumnOrder));
            } catch (e) {
                console.warn('Could not save column order:', e);
            }
        }
        
        function getSortedResources(resources, viewMode, dateStr) {
            if (!resources || resources.length === 0) return resources;
            const key = `${viewMode}-${dateStr}`;
            const order = resourceColumnOrder[key];
            if (!order) return resources;
            
            const sorted = [...resources];
            sorted.sort((a, b) => {
                const aIdx = order.indexOf(a.id);
                const bIdx = order.indexOf(b.id);
                if (aIdx === -1) return 1;
                if (bIdx === -1) return -1;
                return aIdx - bIdx;
            });
            return sorted;
        }
        
        // Track filter state per view mode
        let filterStatePerView = {
            date: null,
            employee: null,
            room: null,
            provider: null,
            event: null
        };
        
        // Track which resources exist in which view
        let resourcesMap = {
            employee: [],
            room: [],
            provider: [],
            event: []
        };
        
        // Initialize resources map when page loads
        function initializeResourcesMap() {
            resourcesMap.employee = employeeResources;
            resourcesMap.provider = providerResources;
            resourcesMap.room = roomResources;
            resourcesMap.event = eventTypeResources;
        }
        
        // Show/hide filter based on view mode and populate dropdown
        function updateFilterUI() {
            const filterContainer = document.getElementById('viewFilterContainer');
            const clinicFilterContainer = document.getElementById('clinicFilterContainer');
            const filterSelect = document.getElementById('resourceFilterSelect');
            const filterLabel = document.getElementById('filterLabel');
            
            if (!filterContainer || !filterSelect) return;
            
            // Determine if current view should show resource filter (employee, room, provider, event)
            const shouldShowResourceFilter = ['employee', 'room', 'provider', 'event'].includes(currentViewMode);
            
            // Clinic filter shows for all views
            const shouldShowClinicFilter = true;
            
            if (shouldShowResourceFilter) {
                filterContainer.style.display = 'flex';
                if (clinicFilterContainer) clinicFilterContainer.style.display = 'flex';
                
                // Get resources for current view
                let resources = [];
                let labelText = 'Filter:';
                
                if (currentViewMode === 'employee') {
                    resources = resourcesMap.employee;
                    labelText = 'Filter by Employee:';
                } else if (currentViewMode === 'room') {
                    resources = resourcesMap.room;
                    labelText = 'Filter by Room:';
                } else if (currentViewMode === 'provider') {
                    resources = resourcesMap.provider;
                    labelText = 'Filter by Provider:';
                } else if (currentViewMode === 'event') {
                    resources = resourcesMap.event;
                    labelText = 'Filter by Event Type:';
                }
                
                // Update label
                if (filterLabel) {
                    filterLabel.textContent = labelText;
                }
                
                // Populate dropdown with resources
                filterSelect.innerHTML = '<option value="">-- All Items --</option>';
                
                resources.forEach(resource => {
                    const option = document.createElement('option');
                    option.value = resource.id;
                    option.textContent = resource.title;
                    filterSelect.appendChild(option);
                });
                
                // Restore the filter selection for this view from saved state
                const savedFilter = filterStatePerView[currentViewMode];
                filterSelect.value = savedFilter || '';
                
                // Update badge to show current filter
                updateFilterBadge();
            } else if (shouldShowClinicFilter) {
                filterContainer.style.display = 'none';
                if (clinicFilterContainer) {
                    clinicFilterContainer.style.display = 'flex';
                    const clinicSelect = document.getElementById('clinicFilterSelect');
                    if (clinicSelect) {
                        clinicSelect.value = clinicFilter;
                    }
                }
            } else {
                filterContainer.style.display = 'none';
                if (clinicFilterContainer) clinicFilterContainer.style.display = 'none';
            }
        }
        
        // Apply the selected resource filter dynamically
        function applyResourceFilter(resourceId) {
            // Save filter state for current view
            filterStatePerView[currentViewMode] = resourceId || null;
            
            // Update badge
            updateFilterBadge();
            
            // Re-render calendar dynamically (don't destroy it)
            if (window.calendarInstance && window.calendarInstance.render) {
                window.calendarInstance.render();
            }
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }
        
        // Update the filter badge display
        function updateFilterBadge() {
            const badge = document.getElementById('activeFilterBadge');
            const currentFilter = filterStatePerView[currentViewMode];
            
            if (currentFilter && badge) {
                const resource = resourcesMap[currentViewMode]?.find(r => r.id === currentFilter);
                if (resource) {
                    badge.innerHTML = `<div class="active-filter-badge"><i class="fas fa-filter"></i> ${resource.title}</div>`;
                    badge.style.display = 'block';
                    return;
                }
            }
            
            if (badge) {
                badge.style.display = 'none';
            }
        }
        
        // Clear the filter
        function clearResourceFilter() {
            filterStatePerView[currentViewMode] = null;
            const filterSelect = document.getElementById('resourceFilterSelect');
            
            if (filterSelect) {
                filterSelect.value = '';
            }
            
            updateFilterBadge();
            
            // Re-render calendar dynamically
            if (window.calendarInstance && window.calendarInstance.render) {
                window.calendarInstance.render();
            }
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }

        // Apply clinic filter (for date view)
        function applyClinicFilter(clinicId) {
            clinicFilter = clinicId || '';
            
            // Re-render calendar dynamically
            if (window.calendarInstance && window.calendarInstance.render) {
                window.calendarInstance.render();
            }
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }
        
        // Clear clinic filter
        function clearClinicFilter() {
            clinicFilter = '';
            const clinicSelect = document.getElementById('clinicFilterSelect');
            
            if (clinicSelect) {
                clinicSelect.value = '';
            }
            
            // Re-render calendar dynamically
            if (window.calendarInstance && window.calendarInstance.render) {
                window.calendarInstance.render();
            }
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }
        
        // Helper function to filter resources based on selected filter for current view
        function getFilteredResources(baseResources, viewMode) {
            const filter = filterStatePerView[viewMode];
            
            if (!filter || !baseResources) {
                return baseResources;
            }
            
            // For room view, need to convert room ID back to title
            if (viewMode === 'room' && filter.startsWith('room-')) {
                const roomName = filter
                    .substring(5)
                    .split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                return baseResources.filter(r => r.title === roomName);
            }
            
            // For employee, provider, and event views, match by ID
            return baseResources.filter(r => r.id === filter);
        }

        // Get filtered events based on current filters
        function getFilteredEvents() {
            let filteredEvents = eventDatabase;
            
            // Apply clinic filter for all views
            if (clinicFilter) {
                filteredEvents = filteredEvents.filter(event => {
                    // Check if event has explicit clinic property
                    if (event.clinic && event.clinic === clinicFilter) {
                        return true;
                    }
                    
                    // Otherwise, check if the event's employee belongs to this clinic
                    const employeeId = event.employee || event.resourceId;
                    if (employeeId && employeeId !== 'all') {
                        const employee = employeeResources.find(emp => emp.id === employeeId);
                        if (employee) {
                            const clinics = employee.extendedProps?.clinics || employee.clinics || [];
                            if (clinics.includes(clinicFilter)) {
                                return true;
                            }
                        }
                    }
                    
                    // Check resourceIds array
                    if (event.resourceIds && Array.isArray(event.resourceIds)) {
                        return event.resourceIds.some(resId => {
                            const employee = employeeResources.find(emp => emp.id === resId);
                            if (employee) {
                                const clinics = employee.extendedProps?.clinics || employee.clinics || [];
                                return clinics.includes(clinicFilter);
                            }
                            return false;
                        });
                    }
                    
                    // Check attendees
                    if (event.attendees && Array.isArray(event.attendees)) {
                        return event.attendees.some(attendeeId => {
                            const employee = employeeResources.find(emp => emp.id === attendeeId);
                            if (employee) {
                                const clinics = employee.extendedProps?.clinics || employee.clinics || [];
                                return clinics.includes(clinicFilter);
                            }
                            return false;
                        });
                    }
                    
                    return false;
                });
            }
            
            // Get the current filter for this view
            const currentFilter = filterStatePerView[currentViewMode];
            
            // Filter by selected resource if in single-resource view
            if (currentFilter && ['employee', 'provider'].includes(currentViewMode)) {
                filteredEvents = filteredEvents.filter(event => {
                    return event.resourceId === currentFilter || event.employee === currentFilter;
                });
            }
            
            // Filter by room if room view with filter
            if (currentFilter && currentViewMode === 'room') {
                let selectedRoom = currentFilter;
                
                // If it starts with 'room-', convert it back to the room name
                if (selectedRoom.startsWith('room-')) {
                    selectedRoom = selectedRoom
                        .substring(5)
                        .split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                }
                
                filteredEvents = filteredEvents.filter(event => {
                    return event.location === selectedRoom || 
                           event.location === currentFilter ||
                           event.resourceId === currentFilter;
                });
            }
            
            // Filter by event type if event view with filter
            if (currentFilter && currentViewMode === 'event') {
                const eventTypeId = currentFilter;
                let eventType = eventTypeId;
                
                if (eventTypeId.startsWith('event-type-')) {
                    eventType = eventTypeId.substring(11);
                }
                
                filteredEvents = filteredEvents.filter(event => {
                    const eventTypeFromDb = (event.type || 'other').toString().toLowerCase();
                    return eventTypeFromDb === eventType;
                });
            }
            
            return filteredEvents;
        }

        // Render legend showing all employees/rooms/providers or events
        function updateResourceLegend(viewMode) {
            const legendContainer = document.getElementById('resourceLegendContainer');
            if (!legendContainer) return;

            let resources = [];
            let title = '';

            if (viewMode === 'employee') {
                resources = employeeResources;
                title = '<i class="fas fa-users"></i> Employees';
            } else if (viewMode === 'room') {
                resources = roomResources;
                title = '<i class="fas fa-door-open"></i> Rooms';
            } else if (viewMode === 'provider') {
                resources = providerResources;
                title = '<i class="fas fa-user-md"></i> Providers';
            } else if (viewMode === 'event') {
                // Build a compact event-by-day list for the next 7 days
                const now = new Date();
                const days = [];
                for (let d = 0; d < 7; d++) {
                    const day = new Date(now.getFullYear(), now.getMonth(), now.getDate() + d);
                    days.push(day);
                }

                let htmlEvents = `
                    <div class="legend-panel">
                        <div class="legend-panel-title"><i class="fas fa-calendar-check"></i> Events (Next 7 days)</div>
                        <div class="legend-items">
                `;

                days.forEach(day => {
                    const YYYY = day.getFullYear();
                    const MM = String(day.getMonth() + 1).padStart(2, '0');
                    const DD = String(day.getDate()).padStart(2, '0');
                    const dateStr = `${YYYY}-${MM}-${DD}`;
                    const events = eventDatabase.filter(e => e.start && e.start.indexOf(dateStr) === 0);

                    htmlEvents += `<div style="padding:0.5rem 0.25rem; border-bottom:1px solid var(--border-color);"><div style="font-weight:700; color:var(--text-primary); margin-bottom:0.35rem;">${day.toLocaleDateString(undefined,{ weekday: 'short', month: 'short', day: 'numeric' })}</div>`;

                    if (events.length === 0) {
                        htmlEvents += `<div style="color:var(--text-secondary); font-size:0.85rem;">No events</div>`;
                    } else {
                        events.forEach(ev => {
                            const employeeNames = {
                                'all': 'All Staff',
                                'john-smith': 'John Smith',
                                'sarah-johnson': 'Sarah Johnson',
                                'mike-davis': 'Mike Davis',
                                'emily-brown': 'Emily Brown',
                                'james-wilson': 'James Wilson'
                            };
                            htmlEvents += `
                                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;">
                                    <div style="width:8px;height:8px;border-radius:50%;background:${ev.backgroundColor};flex-shrink:0;"></div>
                                    <div style="flex:1;min-width:0;font-size:0.85rem;color:var(--text-primary);">
                                        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${ev.title}</div>
                                        <div style="font-size:0.75rem;color:var(--text-secondary);">${employeeNames[ev.employee] || ev.employee} â€¢ ${ev.location || ''}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    htmlEvents += `</div>`;
                });

                htmlEvents += `</div></div>`;
                legendContainer.innerHTML = htmlEvents;
                return;
            }

            if (!resources || resources.length === 0) {
                legendContainer.innerHTML = '';
                return;
            }

            let html = `
                <div class="legend-panel">
                    <div class="legend-panel-title">${title}</div>
                    <div class="legend-items">
            `;

            resources.forEach(resource => {
                const initials = resource.title.split(' ').map(n => n[0]).join('');
                html += `
                    <div class="legend-item-row">
                        <div class="legend-item-avatar" style="background: ${resource.extendedProps.color};">
                            ${initials}
                        </div>
                        <div class="legend-item-info">
                            <div class="legend-item-name">${resource.title}</div>
                            <div class="legend-item-role">${resource.extendedProps.role}</div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            legendContainer.innerHTML = html;
        }

        // Employee Resources Data - Loaded from User Management (localStorage)
        // This will be populated dynamically from users stored in localStorage
        let employeeResources = [];
        
        // Function to load employees from user management into employeeResources
        function loadEmployeeResourcesFromUsers() {
            const users = loadUsers();
            employeeResources = [];
            
            Object.keys(users).forEach(username => {
                const user = users[username];
                // Skip admin account and inactive users
                if (username === 'admin' || user.employeeStatus === 'Inactive') return;
                
                // Determine type based on staffType
                let type = 'assistant';
                if (user.staffType === 'clinical' && user.employeeType === 'Full-time Provider') {
                    type = 'provider';
                } else if (user.staffType === 'clinical') {
                    type = 'assistant';
                }
                
                employeeResources.push({
                    id: username.toLowerCase().replace(/\s+/g, '-'),
                    title: user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || username,
                    extendedProps: {
                        role: user.jobTitle || 'Staff',
                        type: type,
                        staffType: user.staffType || 'non-clinical',
                        color: user.color || '#06b6d4',
                        clinics: [],
                        assignedProvider: null
                    }
                });
            });
            
            console.log('âœ… Loaded', employeeResources.length, 'employees from User Management');
            return employeeResources;
        }

        // ========================================
        // MASTER DATA - Single Source of Truth
        // ========================================
        const masterData = {
            // Clinics - Loaded from localStorage or empty
            clinics: [],
            
            // Rooms - Loaded from localStorage or empty
            rooms: [],
            
            // Time Slots (Standard options)
            timeSlots: [
                { id: 'time1', name: '8:00 AM - 12:00 PM', start: '08:00', end: '12:00' },
                { id: 'time2', name: '8:00 AM - 4:00 PM', start: '08:00', end: '16:00' },
                { id: 'time3', name: '9:00 AM - 5:00 PM', start: '09:00', end: '17:00' },
                { id: 'time4', name: '12:00 PM - 8:00 PM', start: '12:00', end: '20:00' },
                { id: 'time5', name: '2:00 PM - 10:00 PM', start: '14:00', end: '22:00' }
            ],
            
            // Helper methods
            getProviders: function() {
                return employeeResources.filter(e => e.extendedProps?.type === 'provider');
            },
            getAssistants: function() {
                return employeeResources.filter(e => e.extendedProps?.type === 'assistant');
            },
            getAllEmployees: function() {
                return employeeResources || [];
            },
            getClinicById: function(id) {
                return this.clinics.find(c => c.id === id);
            },
            getClinicByName: function(name) {
                return this.clinics.find(c => c.name === name);
            },
            getRoomsByClinic: function(clinicId) {
                return this.rooms.filter(r => r.clinicId === clinicId);
            },
            getEmployeeById: function(id) {
                return employeeResources.find(e => e.id === id);
            },
            getEmployeeByName: function(name) {
                return employeeResources.find(e => e.title === name || e.title.includes(name));
            },
            // Load clinics from localStorage
            loadClinics: function() {
                const stored = localStorage.getItem('clinics');
                if (stored) {
                    this.clinics = JSON.parse(stored);
                }
                return this.clinics;
            },
            // Save clinics to localStorage
            saveClinics: function(clinics) {
                this.clinics = clinics || this.clinics;
                localStorage.setItem('clinics', JSON.stringify(this.clinics));
            },
            // Load rooms from localStorage
            loadRooms: function() {
                const stored = localStorage.getItem('rooms');
                if (stored) {
                    this.rooms = JSON.parse(stored);
                }
                return this.rooms;
            },
            // Save rooms to localStorage
            saveRooms: function(rooms) {
                this.rooms = rooms || this.rooms;
                localStorage.setItem('rooms', JSON.stringify(this.rooms));
            },
            // Initialize all data from localStorage
            initialize: function() {
                this.loadClinics();
                this.loadRooms();
                loadEmployeeResourcesFromUsers();
                console.log('âœ… Master data initialized from localStorage');
            }
        };
        
        // Initialize master data on load
        masterData.initialize();
        
        // Sync data to all schedule builders
        function syncMasterDataToScheduleBuilders() {
            // Sync to sbGameData if it exists
            if (typeof sbGameData !== 'undefined') {
                sbGameData.providers = masterData.getProviders().map(p => ({
                    name: p.title,
                    role: p.extendedProps.role,
                    needsAssistant: true
                }));
                sbGameData.clinics = masterData.clinics.map(c => ({
                    name: c.name,
                    color: c.color
                }));
                sbGameData.rooms = {};
                masterData.clinics.forEach(c => {
                    sbGameData.rooms[c.name] = masterData.getRoomsByClinic(c.id).map(r => r.name);
                });
                sbGameData.assistants = masterData.getAssistants().map(a => ({
                    name: a.title.split(' ')[0], // First name only for display
                    role: a.extendedProps.role,
                    worksAlone: false
                }));
                sbGameData.assistants.push({ name: 'None', role: 'Provider works alone', worksAlone: false });
            }
            
            // Sync to gameData if it exists (for other schedule builder)
            if (typeof gameData !== 'undefined' && gameData.providers) {
                gameData.providers = masterData.getProviders().map((p, i) => ({
                    id: i + 1,
                    name: p.title,
                    role: p.extendedProps.role,
                    icon: 'fa-user-md'
                }));
                gameData.clinics = masterData.clinics.map((c, i) => ({
                    id: i + 1,
                    name: c.name,
                    color: c.color,
                    icon: c.icon
                }));
                gameData.rooms = masterData.rooms.map((r, i) => ({
                    id: i + 1,
                    name: r.name,
                    clinic: masterData.getClinicById(r.clinicId)?.name || ''
                }));
            }
            
            console.log('âœ… Master data synced to all schedule builders');
        }
        
        // Sync schedule shifts from master data
        function syncMyScheduleShifts() {
            if (typeof window.myScheduleShiftsData !== 'undefined') {
                // Update employee names in shifts to match master data
                window.myScheduleShiftsData.forEach(shift => {
                    const employee = masterData.getEmployeeByName(shift.name);
                    if (employee) {
                        shift.name = employee.title;
                    }
                    const clinic = masterData.getClinicByName(shift.clinic);
                    if (clinic) {
                        shift.color = clinic.color;
                    }
                });
                console.log('âœ… Schedule shifts synced with master data');
            }
        }
        
        // Sync tasks to ensure employee IDs match
        function syncTasksWithMasterData() {
            if (typeof employeeTasksDatabase !== 'undefined') {
                employeeTasksDatabase.forEach(task => {
                    const employee = masterData.getEmployeeById(task.employeeId);
                    if (!employee) {
                        // Try to find by name pattern
                        const namePart = task.employeeId.replace(/-/g, ' ');
                        const found = employeeResources.find(e => 
                            e.id.includes(task.employeeId.split('-')[1]) ||
                            e.title.toLowerCase().includes(namePart.split(' ').pop())
                        );
                        if (found) {
                            console.log(`Task ${task.id}: Mapped ${task.employeeId} to ${found.id}`);
                        }
                    }
                });
                console.log('âœ… Tasks synced with master data');
            }
        }
        
        // Sync duties with master data
        function syncDutiesWithMasterData() {
            if (typeof employeeDutiesDatabase !== 'undefined') {
                employeeDutiesDatabase.forEach(duty => {
                    const employee = masterData.getEmployeeById(duty.employeeId);
                    if (!employee) {
                        const namePart = duty.employeeId.replace(/-/g, ' ');
                        const found = employeeResources.find(e => 
                            e.id.includes(duty.employeeId.split('-')[1]) ||
                            e.title.toLowerCase().includes(namePart.split(' ').pop())
                        );
                        if (found) {
                            console.log(`Duty ${duty.id}: Mapped ${duty.employeeId} to ${found.id}`);
                        }
                    }
                });
                console.log('âœ… Duties synced with master data');
            }
        }
        
        // Get data summary for an employee - shows all their schedules, tasks, and duties
        function getEmployeeDataSummary(employeeId) {
            const employee = masterData.getEmployeeById(employeeId);
            if (!employee) return null;
            
            const summary = {
                employee: {
                    id: employee.id,
                    name: employee.title,
                    role: employee.extendedProps?.role,
                    type: employee.extendedProps?.type,
                    clinics: employee.extendedProps?.clinics || []
                },
                schedules: [],
                tasks: [],
                duties: []
            };
            
            // Get schedules
            if (window.myScheduleShiftsData) {
                summary.schedules = window.myScheduleShiftsData.filter(s => 
                    s.name === employee.title || s.assistant === employee.title
                );
            }
            
            // Get tasks
            if (typeof employeeTasksDatabase !== 'undefined') {
                summary.tasks = employeeTasksDatabase.filter(t => t.employeeId === employeeId);
            }
            
            // Get duties
            if (typeof employeeDutiesDatabase !== 'undefined') {
                summary.duties = employeeDutiesDatabase.filter(d => d.employeeId === employeeId);
            }
            
            return summary;
        }
        
        // Get all data summary
        function getAllDataSummary() {
            const providers = masterData.getProviders();
            const assistants = masterData.getAssistants();
            
            return {
                totalProviders: providers.length,
                totalAssistants: assistants.length,
                totalClinics: masterData.clinics.length,
                totalRooms: masterData.rooms.length,
                totalSchedules: window.myScheduleShiftsData?.length || 0,
                totalTasks: typeof employeeTasksDatabase !== 'undefined' ? employeeTasksDatabase.length : 0,
                totalDuties: typeof employeeDutiesDatabase !== 'undefined' ? employeeDutiesDatabase.length : 0,
                providers: providers.map(p => p.title),
                assistants: assistants.map(a => a.title),
                clinics: masterData.clinics.map(c => c.name)
            };
        }
        
        // Expose globally
        window.getEmployeeDataSummary = getEmployeeDataSummary;
        window.getAllDataSummary = getAllDataSummary;
        
        // Master sync function - call this to sync everything
        function syncAllData() {
            console.log('ðŸ”„ Starting master data sync...');
            syncMasterDataToScheduleBuilders();
            syncMyScheduleShifts();
            syncTasksWithMasterData();
            syncDutiesWithMasterData();
            
            // Log summary
            const summary = getAllDataSummary();
            console.log('ðŸ“Š Data Summary:', summary);
            console.log('âœ… All data synchronized successfully!');
        }
        
        // Make master data globally accessible
        window.masterData = masterData;
        window.syncAllData = syncAllData;

        // Provider Resources (subset of employees who are providers/doctors)
        const providerResources = employeeResources.filter(r => {
            return r.extendedProps && r.extendedProps.type === 'provider';
        }).map((r) => ({
            ...r
        }));

        // Event Data
        // Helper function to categorize events as Dental or General
        function getEventCategory(eventType) {
            const dentalTypes = ['appointment', 'duty'];
            const generalTypes = ['maintenance', 'meeting', 'training', 'project'];
            
            if (dentalTypes.includes(eventType?.toLowerCase())) {
                return 'dental';
            } else if (generalTypes.includes(eventType?.toLowerCase())) {
                return 'general';
            }
            return 'general'; // Default
        }

        // Event Database - Loaded from localStorage
        let eventDatabase = [];
        
        // Load events from localStorage
        function loadEventDatabase() {
            const stored = localStorage.getItem('calendarEvents');
            if (stored) {
                try {
                    eventDatabase = JSON.parse(stored);
                } catch (e) {
                    console.warn('Could not parse calendar events:', e);
                    eventDatabase = [];
                }
            }
            return eventDatabase;
        }
        
        // Save events to localStorage
        function saveEventDatabase(events) {
            eventDatabase = events || eventDatabase;
            localStorage.setItem('calendarEvents', JSON.stringify(eventDatabase));
        }
        
        // Initialize events from localStorage
        loadEventDatabase();

        // Room Resources - Built from masterData.rooms
        let roomResources = [];
        
        function buildRoomResources() {
            const colors = ['#0ea5e9', '#6366f1', '#f97316', '#10b981', '#ec4899', '#a855f7', '#14b8a6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16'];
            
            roomResources = masterData.rooms.map((room, index) => {
                const initials = room.name.split(' ').map(word => word[0]).join('').toUpperCase();
                return {
                    id: 'room-' + room.name.toLowerCase().replace(/\s+/g, '-'),
                    title: room.name,
                    initials: initials,
                    extendedProps: {
                        role: 'Room',
                        color: colors[index % colors.length],
                        clinicId: room.clinicId,
                        roomCategory: room.roomCategory
                    }
                };
            });
            
            return roomResources;
        }
        
        // Build room resources initially
        buildRoomResources();

        // Event Type Resources (group events by their `type` for the "By Event" headers)
        let eventTypeMap = {};
        let eventTypeColors = {};
        const typePalette = ['#0ea5e9', '#6366f1', '#f97316', '#10b981', '#ec4899', '#a855f7', '#14b8a6', '#f59e0b', '#ef4444', '#8b5cf6'];
        
        function buildEventTypeResources() {
            eventTypeMap = {};
            eventTypeColors = {};
            
            // Collect types and pick a representative color from first event of that type
            eventDatabase.forEach((ev, idx) => {
                const t = (ev.type || 'other').toString().toLowerCase();
                if (!eventTypeMap[t]) {
                    eventTypeMap[t] = {
                        id: 'event-type-' + t,
                        key: t,
                        title: (t === 'other') ? 'Other' : t.charAt(0).toUpperCase() + t.slice(1),
                        color: ev.backgroundColor || typePalette[Object.keys(eventTypeMap).length % typePalette.length]
                    };
                    eventTypeColors[t] = eventTypeMap[t].color;
                }
            });
            
            return Object.values(eventTypeMap).map(t => ({
                id: t.id,
                title: t.title,
                extendedProps: {
                    role: 'Event Type',
                    color: t.color
                }
            }));
        }

        let eventTypeResources = buildEventTypeResources();
        // Helper: map location text -> room resource id
        function getRoomIdFromLocation(location) {
            if (!location) return null;
            return 'room-' + location.toLowerCase().replace(/\s+/g, '-');
        }

        // Helper: Get the correct people list based on event category
        function getEventPeople(event) {
            if (event.eventCategory === 'dental') {
                return {
                    people: event.assistants || [],
                    label: 'Assistants'
                };
            } else {
                return {
                    people: event.attendees || [],
                    label: 'Attendees'
                };
            }
        }

        // Provider Event Filtering
        let providerEventFilter = 'general'; // 'dental', 'general', or 'all'

        function setProviderEventFilter(filter) {
            providerEventFilter = filter;
            if (calendar) {
                calendar.refetchEvents();
            }
            updateEventFilterUI();
            
            // Refresh table view if active
            if (isTableView) {
                populateTable();
            }
        }

        function getFilteredEventsForProvider(events, resourceId) {
            const currentRole = root.getAttribute('data-role');
            
            // Only filter for non-admin users (employees)
            if (currentRole !== 'admin' && resourceId) {
                // Check if this resourceId is a provider
                const resource = providerResources.find(r => r.id === resourceId);
                if (resource) {
                    // For providers, filter by eventCategory
                    if (providerEventFilter === 'dental') {
                        return events.filter(e => e.eventCategory === 'dental' || !e.eventCategory);
                    } else if (providerEventFilter === 'general') {
                        return events.filter(e => e.eventCategory === 'general');
                    }
                    // If 'all', return all events
                }
            }
            return events;
        }

        function updateEventFilterUI() {
            const filterButtons = document.querySelectorAll('[data-event-filter]');
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-event-filter') === providerEventFilter) {
                    btn.classList.add('active');
                }
            });
        }




        // FullCalendar Initialization
        let calendar;
        let showWorkingHours = false;

        // Employee Tasks Database - Loaded from localStorage
        let employeeTasksDatabase = [];
        
        // Load tasks from localStorage
        function loadEmployeeTasks() {
            const stored = localStorage.getItem('employeeTasks');
            if (stored) {
                try {
                    employeeTasksDatabase = JSON.parse(stored);
                } catch (e) {
                    console.warn('Could not parse employee tasks:', e);
                    employeeTasksDatabase = [];
                }
            }
            return employeeTasksDatabase;
        }
        
        // Save tasks to localStorage
        function saveEmployeeTasks(tasks) {
            employeeTasksDatabase = tasks || employeeTasksDatabase;
            localStorage.setItem('employeeTasks', JSON.stringify(employeeTasksDatabase));
        }
        
        // Initialize tasks from localStorage
        loadEmployeeTasks();

        // Employee Duties Database - Loaded from localStorage
        let employeeDutiesDatabase = [];
        
        // Load duties from localStorage
        function loadEmployeeDuties() {
            const stored = localStorage.getItem('employeeDuties');
            if (stored) {
                try {
                    employeeDutiesDatabase = JSON.parse(stored);
                } catch (e) {
                    console.warn('Could not parse employee duties:', e);
                    employeeDutiesDatabase = [];
                }
            }
            return employeeDutiesDatabase;
        }
        
        // Save duties to localStorage
        function saveEmployeeDuties(duties) {
            employeeDutiesDatabase = duties || employeeDutiesDatabase;
            localStorage.setItem('employeeDuties', JSON.stringify(employeeDutiesDatabase));
        }
        
        // Initialize duties from localStorage
        loadEmployeeDuties();

        // Automatically convert tasks from employeeTasksDatabase to calendar events
        // This happens AFTER all databases are defined but BEFORE the calendar initializes
        function convertTasksToEvents() {
            console.log('Converting tasks to calendar events...');
            employeeTasksDatabase.forEach(task => {
                if (!task.dueDate) {
                    console.warn('Skipping task without due date:', task.title);
                    return;
                }
                
                const taskTime = task.dueTime || '09:00';
                const taskEvent = {
                    id: task.id,
                    title: 'ðŸ“‹ ' + task.title,
                    start: `${task.dueDate}T${taskTime}:00`,
                    end: `${task.dueDate}T${taskTime}:00`,
                    resourceId: task.employeeId,
                    employee: task.employeeId,
                    priority: task.priority,
                    description: task.description,
                    notes: `Status: ${task.status}`,
                    paid: false,
                    overdue: task.status === 'overdue',
                    type: 'task',
                    eventCategory: 'task',
                    isTask: true,
                    taskStatus: task.status
                };
                
                // Check if event with this ID already exists to avoid duplicates
                const existingIndex = eventDatabase.findIndex(e => e.id === task.id);
                if (existingIndex === -1) {
                    eventDatabase.push(taskEvent);
                    console.log('Added task event:', task.title, 'for employee:', task.employeeId);
                } else {
                    // Update existing
                    eventDatabase[existingIndex] = taskEvent;
                }
            });
            console.log('Task conversion complete. Total events:', eventDatabase.length);
        }

        // Convert tasks immediately after all databases are defined
        convertTasksToEvents();

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            // Initialize resources map for filtering
            try {
                if (typeof initializeResourcesMap === 'function') {
                    initializeResourcesMap();
                }
            } catch (e) {
                console.warn('Resources not ready yet:', e.message);
            }
            
            // If calendar element doesn't exist, skip initialization
            if (!calendarEl) {
                console.warn('Calendar element not found');
                return;
            }
            // Apply view-specific CSS class for alignment fixes
            try {
                // Remove all view-mode classes first
                calendarEl.classList.remove('view-mode-room', 'view-mode-employee', 'view-mode-provider', 'view-mode-event');
                
                // Add the appropriate class based on current view mode
                if (currentViewMode === 'room') {
                    calendarEl.classList.add('view-mode-room');
                } else if (currentViewMode === 'employee') {
                    calendarEl.classList.add('view-mode-employee');
                } else if (currentViewMode === 'provider') {
                    calendarEl.classList.add('view-mode-provider');
                } else if (currentViewMode === 'event') {
                    calendarEl.classList.add('view-mode-event');
                }
            } catch (e) {
                // ignore
            }
            
            const currentRole = root.getAttribute('data-role');
            
            let calendarConfig = {
                initialDate: '2025-11-09',
                editable: true,
                droppable: true,
                eventDrop: handleEventDrop,
                eventClick: handleEventClick,
                eventContent: function(arg) {
                    let html = '<div class="event-badge-container">';
                    
                    // Priority flag indicator
                    const priority = arg.event.extendedProps.priority || 'low';
                    const priorityColors = {
                        'critical': '#dc2626',
                        'high': '#d97706',
                        'medium': '#ca8a04',
                        'low': '#059669'
                    };
                    
                    html += `<span class="event-priority-flag" style="background-color: ${priorityColors[priority]};" title="Priority: ${priority}"></span>`;
                    
                    // Overdue badge
                    if (arg.event.extendedProps.overdue) {
                        html += '<span class="event-mini-badge overdue">!</span>';
                    }
                    
                    // Paid badge
                    if (arg.event.extendedProps.paid) {
                        html += '<span class="event-mini-badge paid">$</span>';
                    }
                    
                    html += '<span class="fc-event-title">' + arg.event.title.replace('ðŸ’° ', '').replace('âš ï¸ ', '') + '</span>';
                    html += '</div>';
                    
                    return { html: html };
                },
                
                events: function(info, successCallback, failureCallback) {
                    let filteredEvents = getFilteredEvents();

                    // Merge in working-hours blocks as events when enabled
                    const workingHoursEvents = generateWorkingHoursEventsForRange(info.start, info.end);
                    if (workingHoursEvents && workingHoursEvents.length) {
                        filteredEvents = filteredEvents.concat(workingHoursEvents);
                    }


                    // Filter by role
                    if (currentRole === 'user') {
                        // User only sees their own events (for demo, showing john-smith)
                        filteredEvents = filteredEvents.filter(e => 
                            e.employee === 'john-smith' || e.employee === 'all'
                        );
                    }

                    const processedEvents = [];

                    filteredEvents.forEach(event => {
                        let titleWithBadges = event.title;

                        // Add paid indicator
                        if (event.paid) {
                            titleWithBadges = 'ðŸ’° ' + titleWithBadges;
                        }

                        // Add overdue indicator
                        if (event.overdue) {
                            titleWithBadges = 'âš ï¸ ' + titleWithBadges;
                        }

                        // EMPLOYEE or ROOM resource modes
                        if (currentViewMode === 'employee' || currentViewMode === 'room' || currentViewMode === 'provider' || currentViewMode === 'event') {

                            if (currentViewMode === 'employee') {
                                // Events assigned to multiple employees
                                if (event.resourceIds && Array.isArray(event.resourceIds)) {
                                    event.resourceIds.forEach(resId => {
                                        processedEvents.push({
                                            ...event,
                                            resourceId: resId,
                                            resourceIds: undefined,
                                            title: titleWithBadges
                                        });
                                    });
                                }
                                // Single-employee event
                                else if (event.resourceId) {
                                    processedEvents.push({
                                        ...event,
                                        title: titleWithBadges
                                    });
                                }
                            }

                            // PROVIDER mapping: mirror employee-like behavior but limited to providerResources
                            if (currentViewMode === 'provider') {
                                const availableProviderIds = providerResources.map(p => p.id);
                                
                                // Apply dental/general filter for providers
                                let shouldIncludeEvent = true;
                                if (providerEventFilter === 'dental') {
                                    shouldIncludeEvent = !event.eventCategory || event.eventCategory === 'dental';
                                } else if (providerEventFilter === 'general') {
                                    shouldIncludeEvent = event.eventCategory === 'general';
                                }

                                if (event.resourceIds && Array.isArray(event.resourceIds)) {
                                    event.resourceIds.forEach(resId => {
                                        if (availableProviderIds.indexOf(resId) !== -1 && shouldIncludeEvent) {
                                            processedEvents.push({
                                                ...event,
                                                resourceId: resId,
                                                resourceIds: undefined,
                                                title: titleWithBadges,
                                                extendedProps: { 
                                                    ...(event.extendedProps||{}), 
                                                    assistants: event.assistants || [],
                                                    attendees: event.attendees || [],
                                                    eventCategory: event.eventCategory
                                                }
                                            });
                                        }
                                    });
                                }
                                else if (event.resourceId && availableProviderIds.indexOf(event.resourceId) !== -1 && shouldIncludeEvent) {
                                    processedEvents.push({
                                        ...event,
                                        resourceId: event.resourceId,
                                        title: titleWithBadges,
                                        extendedProps: { 
                                            ...(event.extendedProps||{}), 
                                            assistants: event.assistants || [],
                                            attendees: event.attendees || [],
                                            eventCategory: event.eventCategory
                                        }
                                    });
                                }
                                else if (event.employee && availableProviderIds.indexOf(event.employee) !== -1 && shouldIncludeEvent) {
                                    processedEvents.push({
                                        ...event,
                                        resourceId: event.employee,
                                        title: titleWithBadges,
                                        extendedProps: { 
                                            ...(event.extendedProps||{}), 
                                            assistants: event.assistants || [],
                                            attendees: event.attendees || [],
                                            eventCategory: event.eventCategory
                                        }
                                    });
                                }
                            }

                            if (currentViewMode === 'room') {
                                const roomId = getRoomIdFromLocation(event.location);
                                if (roomId) {
                                    processedEvents.push({
                                        ...event,
                                        resourceId: roomId,
                                        resourceIds: undefined,
                                        title: titleWithBadges
                                    });
                                } else {
                                    // No location: still show it (unassigned)
                                    processedEvents.push({
                                        ...event,
                                        title: titleWithBadges
                                    });
                                }
                            }

                            // Event-focused: assign events to event-type resource rows and keep providers/assistants as meta
                            if (currentViewMode === 'event') {
                                // Resource row will be the event's `type` (grouped). If no type, use 'other'.
                                const typeKey = (event.type || 'other').toString().toLowerCase();
                                const typeResourceId = 'event-type-' + typeKey;

                                // Determine provider ids attached to this event (for display in the event block/modal)
                                const providerIds = [];
                                const availableProviderIds = providerResources.map(p=>p.id);
                                if (event.resourceIds && Array.isArray(event.resourceIds)) {
                                    event.resourceIds.forEach(rid => { if (availableProviderIds.indexOf(rid) !== -1) providerIds.push(rid); });
                                }
                                if (event.resourceId && availableProviderIds.indexOf(event.resourceId) !== -1) {
                                    if (providerIds.indexOf(event.resourceId) === -1) providerIds.push(event.resourceId);
                                }
                                if (event.employee && availableProviderIds.indexOf(event.employee) !== -1) {
                                    if (providerIds.indexOf(event.employee) === -1) providerIds.push(event.employee);
                                }

                                // Place the event on the event-type resource row and copy assistants/attendees/providers into extendedProps
                                processedEvents.push({
                                    ...event,
                                    resourceId: typeResourceId,
                                    resourceIds: undefined,
                                    title: titleWithBadges,
                                    extendedProps: { 
                                        ...(event.extendedProps||{}), 
                                        assistants: event.assistants || [], 
                                        attendees: event.attendees || [],
                                        providers: providerIds,
                                        eventCategory: event.eventCategory
                                    }
                                });

                                return; // done with this event for event mode
                            }

                        } else {
                            // DATE mode (normal Month / Week / Day)
                            processedEvents.push({
                                ...event,
                                title: titleWithBadges
                            });
                        }
                    });

                    successCallback(processedEvents);
                },
                
                eventDidMount: function(arg) {
                    // Simply set the priority attribute and let CSS handle all styling
                    const priority = arg.event.extendedProps.priority || 'low';
                    arg.el.setAttribute('data-priority', priority);
                }
            };


// Configure view based on mode
            if (currentViewMode === 'date') {
                // Standard date-based views with Month, Week, Day options
                calendarConfig.initialView = 'dayGridMonth';
                calendarConfig.headerToolbar = {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                };
                calendarConfig.buttonText = {
                    today: 'Today',
                    month: 'Month',
                    week: 'Week',
                    day: 'Day'
                };
            } else if (currentViewMode === 'employee') {
                // Employee-based resource views: Week Ã— Employee and Day Ã— Employee
                calendarConfig.initialView = 'resourceTimeGridDay';
                calendarConfig.headerToolbar = {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'resourceTimeGridWeek,resourceTimeGridDay'
                };
                calendarConfig.buttonText = {
                    today: 'Today',
                    week: 'Week',
                    day: 'Day'
                };
                calendarConfig.resources = getFilteredResources(employeeResources, 'employee');
                calendarConfig.resourceAreaWidth = filterStatePerView.employee ? '0px' : '30px';
                calendarConfig.resourceLabelText = function(resource) {
                    return resource.title;
                };
                calendarConfig.resourceLabelDidMount = function(arg) {
                    const container = arg.el;
                    container.innerHTML = '';
                    
                    const label = document.createElement('div');
                    
                    // Check if we're in week view or day view
                    const isWeekView = window.calendarInstance && window.calendarInstance.view && window.calendarInstance.view.type === 'resourceTimeGridWeek';
                    
                    if (isWeekView) {
                        // Week view: vertical text for employee names
                        label.style.cssText = `font-family: inherit; font-size: 0.6rem; font-weight: 500; color: var(--text-primary); writing-mode: vertical-rl; transform: rotate(180deg); padding: 4px 0; line-height: 1.3; white-space: nowrap;`;
                    } else {
                        // Day view: small text
                        label.style.cssText = `font-family: inherit; font-size: 0.35rem; font-weight: 500; color: var(--text-primary); text-align: center; overflow: hidden; text-overflow: ellipsis; padding: 0; line-height: 1.2; white-space: nowrap;`;
                    }
                    
                    label.textContent = arg.resource.title;
                    label.title = arg.resource.title;
                    
                    container.appendChild(label);
                };
                calendarConfig.slotMinTime = '07:00:00';
                calendarConfig.slotMaxTime = '19:00:00';
                calendarConfig.resourceOrder = 'title';
                calendarConfig.slotLabelInterval = '00:30:00';
                calendarConfig.slotLabelFormat = { hour: 'numeric', minute: '2-digit', meridiem: 'short' };
                calendarConfig.slotDuration = '00:60:00';
            } else if (currentViewMode === 'room') {
                // Room-based resource views: Week Ã— Room and Day Ã— Room
                calendarConfig.initialView = 'resourceTimeGridDay';
                calendarConfig.headerToolbar = {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'resourceTimeGridWeek,resourceTimeGridDay'
                };
                calendarConfig.buttonText = {
                    today: 'Today',
                    week: 'Week',
                    day: 'Day'
                };
                calendarConfig.resources = getFilteredResources(roomResources, 'room');
                calendarConfig.resourceAreaWidth = filterStatePerView.room ? '0px' : '40px';
                calendarConfig.resourceLabelText = function(resource) {
                    return resource.title;
                };
                calendarConfig.resourceLabelDidMount = function(arg) {
                    const container = arg.el;
                    container.innerHTML = '';
                    
                    const label = document.createElement('div');
                    
                    // Check if we're in week view or day view
                    const isWeekView = window.calendarInstance && window.calendarInstance.view && window.calendarInstance.view.type === 'resourceTimeGridWeek';
                    
                    if (isWeekView) {
                        // Week view: vertical text for room names
                        label.style.cssText = `font-family: inherit; font-size: 0.6rem; font-weight: 500; color: var(--text-primary); writing-mode: vertical-rl; transform: rotate(180deg); padding: 4px 0; line-height: 1.3; white-space: nowrap;`;
                    } else {
                        // Day view: small text (perfect)
                        label.style.cssText = `font-family: inherit; font-size: 0.35rem; font-weight: 500; color: var(--text-primary); text-align: center; overflow: hidden; text-overflow: ellipsis; padding: 0; line-height: 1.2; white-space: nowrap;`;
                    }
                    
                    label.textContent = arg.resource.title;
                    label.title = arg.resource.title;
                    
                    container.appendChild(label);
                };
                calendarConfig.slotMinTime = '07:00:00';
                calendarConfig.slotMaxTime = '19:00:00';
                calendarConfig.resourceOrder = 'title';
                calendarConfig.slotLabelInterval = '00:30:00';
                calendarConfig.slotLabelFormat = { hour: 'numeric', minute: '2-digit', meridiem: 'short' };
                calendarConfig.slotDuration = '00:60:00';
            } else if (currentViewMode === 'provider') {
                // Provider-based resource views: Week Ã— Provider and Day Ã— Provider
                calendarConfig.initialView = 'resourceTimeGridDay';
                calendarConfig.headerToolbar = {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'resourceTimeGridWeek,resourceTimeGridDay'
                };
                calendarConfig.buttonText = {
                    today: 'Today',
                    week: 'Week',
                    day: 'Day'
                };
                calendarConfig.resources = getFilteredResources(providerResources, 'provider');
                calendarConfig.resourceAreaWidth = filterStatePerView.provider ? '0px' : '30px';
                calendarConfig.resourceLabelText = function(resource) {
                    return resource.title;
                };
                calendarConfig.resourceLabelDidMount = function(arg) {
                    const container = arg.el;
                    container.innerHTML = '';
                    
                    const label = document.createElement('div');
                    
                    // Check if we're in week view or day view
                    const isWeekView = window.calendarInstance && window.calendarInstance.view && window.calendarInstance.view.type === 'resourceTimeGridWeek';
                    
                    if (isWeekView) {
                        // Week view: vertical text for provider names
                        label.style.cssText = `font-family: inherit; font-size: 0.6rem; font-weight: 500; color: var(--text-primary); writing-mode: vertical-rl; transform: rotate(180deg); padding: 4px 0; line-height: 1.3; white-space: nowrap;`;
                    } else {
                        // Day view: small text
                        label.style.cssText = `font-family: inherit; font-size: 0.35rem; font-weight: 500; color: var(--text-primary); text-align: center; overflow: hidden; text-overflow: ellipsis; padding: 0; line-height: 1.2; white-space: nowrap;`;
                    }
                    
                    label.textContent = arg.resource.title;
                    label.title = arg.resource.title;
                    
                    container.appendChild(label);
                };
                calendarConfig.slotMinTime = '07:00:00';
                calendarConfig.slotMaxTime = '19:00:00';
                calendarConfig.resourceOrder = 'title';
                calendarConfig.slotLabelInterval = '00:30:00';
                calendarConfig.slotLabelFormat = { hour: 'numeric', minute: '2-digit', meridiem: 'short' };
                calendarConfig.slotDuration = '00:60:00';
            } else if (currentViewMode === 'event') {
                // Event-focused resource views: Week and Day showing event-type headers (not providers)
                calendarConfig.initialView = 'resourceTimeGridDay';
                calendarConfig.headerToolbar = {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'resourceTimeGridWeek,resourceTimeGridDay'
                };
                calendarConfig.buttonText = {
                    today: 'Today',
                    week: 'Week',
                    day: 'Day'
                };
                // Resources are now event types (e.g., Meeting, Training, Appointment)
                calendarConfig.resources = getFilteredResources(eventTypeResources, 'event');
                calendarConfig.resourceAreaWidth = filterStatePerView.event ? '0px' : '30px';
                calendarConfig.resourceLabelText = function(resource) {
                    return resource.title;
                };
                calendarConfig.resourceLabelDidMount = function(arg) {
                    const container = arg.el;
                    container.innerHTML = '';
                    
                    const label = document.createElement('div');
                    label.style.cssText = `font-family: inherit; font-size: 0.35rem; font-weight: 500; color: var(--text-primary); text-align: center; overflow: hidden; text-overflow: ellipsis; padding: 0; line-height: 1.2; white-space: nowrap;`;
                    label.textContent = arg.resource.title;
                    label.title = arg.resource.title;
                    
                    container.appendChild(label);
                };
                // Keep time bounds similar to resource views
                calendarConfig.slotMinTime = '07:00:00';
                calendarConfig.slotMaxTime = '19:00:00';
                calendarConfig.resourceOrder = 'title';
                calendarConfig.slotLabelInterval = '00:30:00';
                calendarConfig.slotLabelFormat = { hour: 'numeric', minute: '2-digit', meridiem: 'short' };
                calendarConfig.slotDuration = '00:60:00';
            }

            // Shared: configure week resource view to group by day then resource
            calendarConfig.views = {
    resourceTimeGridWeek: {
        datesAboveResources: true
    },
    resourceTimeGridDay: {
        datesAboveResources: true
    }
};

// Custom Calendar Implementation
            let calendar = window.calendarInstance = {
                currentDate: new Date(2025, 10, 9), // November 9, 2025
                currentView: currentViewMode === 'date' ? 'month' : 'resourceDay',
                viewMode: currentViewMode, // 'date', 'employee', 'room', 'provider', 'event'
                draggedEvent: null,
                
                render: function() {
                    this.renderCalendar();
                    
                    // Sync quick calendar if it exists
                    if (typeof quickCalendarDate !== 'undefined') {
                        quickCalendarDate = new Date(this.currentDate);
                        if (typeof renderQuickCalendar === 'function') {
                            renderQuickCalendar();
                        }
                    }
                },
                
                renderCalendar: function() {
                    const container = document.getElementById('calendar');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    container.className = 'custom-calendar';
                    
                    // Determine view buttons based on viewMode
                    let viewButtons = '';
                    if (this.viewMode === 'date') {
                        viewButtons = `
                            <button class="view-btn ${this.currentView === 'month' ? 'active' : ''}" onclick="changeCalendarView('month')">Month</button>
                            <button class="view-btn ${this.currentView === 'week' ? 'active' : ''}" onclick="changeCalendarView('week')">Week</button>
                            <button class="view-btn ${this.currentView === 'day' ? 'active' : ''}" onclick="changeCalendarView('day')">Day</button>
                        `;
                    } else {
                        viewButtons = `
                            <button class="view-btn ${this.currentView === 'resourceWeek' ? 'active' : ''}" onclick="changeCalendarView('resourceWeek')">Week</button>
                            <button class="view-btn ${this.currentView === 'resourceDay' ? 'active' : ''}" onclick="changeCalendarView('resourceDay')">Day</button>
                        `;
                    }
                    
                    // Create header
                    const header = document.createElement('div');
                    header.className = 'calendar-header';
                    
                    // Build filter controls - show in all views when working hours are enabled
                    let filterControls = '';
                    if (showWorkingHours) {
                        filterControls = `
                            <select id="whClinicFilter" class="nav-btn" onchange="applyWorkingHoursFilters()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; cursor: pointer;">
                                <option value="">All Clinics</option>
                                <option value="clinic1">Main Clinic</option>
                                <option value="clinic2">Downtown Clinic</option>
                                <option value="clinic3">Uptown Clinic</option>
                            </select>
                        `;
                    }
                    
                    header.innerHTML = `
                        <div class="calendar-nav">
                            <button class="nav-btn" onclick="navigateCalendar('prev')" title="Previous (â† Arrow)"><i class="fas fa-chevron-left"></i></button>
                            <button class="nav-btn" onclick="navigateCalendar('today')" title="Today (T key)">Today</button>
                            <button class="nav-btn" onclick="navigateCalendar('next')" title="Next (â†’ Arrow)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <h2 class="calendar-title">${this.getDateRangeString()}</h2>
                        <div class="calendar-view-buttons">
                            ${viewButtons}
                            ${filterControls}
                            <button class="nav-btn help-btn" onclick="showCalendarHelp()" title="Keyboard Shortcuts">
                                <i class="fas fa-keyboard"></i>
                            </button>
                            <button class="nav-btn search-btn" onclick="toggleCalendarSearch()" title="Search Events (Ctrl+F)">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(header);
                    
                    // Add top scrollbar placeholder (will be populated for week views)
                    const topScrollbar = document.createElement('div');
                    topScrollbar.className = 'top-scrollbar-wrapper';
                    topScrollbar.style.display = 'none'; // Hidden by default
                    container.appendChild(topScrollbar);
                    
                    // Create calendar body
                    const body = document.createElement('div');
                    body.className = 'calendar-body';
                    
                    if (this.viewMode === 'date') {
                        if (this.currentView === 'month') {
                            body.appendChild(this.renderMonthView());
                        } else if (this.currentView === 'week') {
                            body.appendChild(this.renderWeekView());
                        } else {
                            body.appendChild(this.renderDayView());
                        }
                    } else {
                        if (this.currentView === 'resourceWeek') {
                            body.appendChild(this.renderResourceWeekView());
                        } else {
                            body.appendChild(this.renderResourceDayView());
                        }
                    }
                    
                    container.appendChild(body);
                    
                    // Add top scrollbar for week views with horizontal overflow
                    setTimeout(() => {
                        const topScrollbarWrapper = container.querySelector('.top-scrollbar-wrapper');
                        
                        if (topScrollbarWrapper) {
                            // Target the specific scrollable element - check for both regular and resource grids
                            const scrollElement = body.querySelector('.time-grid.resource-grid') || body.querySelector('.time-grid');
                            
                            if (scrollElement && scrollElement.scrollWidth > scrollElement.clientWidth) {
                                console.log('Setup:', {
                                    scrollWidth: scrollElement.scrollWidth,
                                    clientWidth: scrollElement.clientWidth
                                });
                                
                                // Show the top scrollbar
                                topScrollbarWrapper.style.display = 'block';
                                
                                // Set the content width to match the scrollable content
                                const topScrollbarContent = document.createElement('div');
                                topScrollbarContent.className = 'top-scrollbar-content';
                                topScrollbarContent.style.width = scrollElement.scrollWidth + 'px';
                                
                                topScrollbarWrapper.innerHTML = '';
                                topScrollbarWrapper.appendChild(topScrollbarContent);
                                
                                let isSyncingTop = false;
                                let isSyncingBottom = false;
                                
                                // Sync scrolling - when top scrollbar moves, move the time-grid
                                topScrollbarWrapper.onscroll = function(e) {
                                    if (isSyncingBottom) return;
                                    isSyncingTop = true;
                                    scrollElement.scrollLeft = topScrollbarWrapper.scrollLeft;
                                    isSyncingTop = false;
                                };
                                
                                // When time-grid scrolls, move the top scrollbar
                                scrollElement.onscroll = function(e) {
                                    if (isSyncingTop) return;
                                    isSyncingBottom = true;
                                    topScrollbarWrapper.scrollLeft = scrollElement.scrollLeft;
                                    isSyncingBottom = false;
                                };
                                
                                console.log('Scrollbars synced successfully');
                            } else {
                                console.log('No scrollable element found or no overflow');
                                topScrollbarWrapper.style.display = 'none';
                            }
                        }
                    }, 400);
                    
                    // Update header title
                    const headerTitleEl = document.getElementById('viewTitle');
                    if (headerTitleEl) {
                        headerTitleEl.textContent = this.getDateRangeString();
                    }
                    
                    // Enable drag and drop
                    this.enableDragAndDrop();
                },
                
                renderMonthView: function() {
                    const table = document.createElement('table');
                    table.className = 'calendar-month-table';
                    
                    // Header with day names
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                        const th = document.createElement('th');
                        th.textContent = day;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    // Body with dates
                    const tbody = document.createElement('tbody');
                    const dates = this.getMonthDates();
                    const today = new Date();
                    
                    for (let week of dates) {
                        const row = document.createElement('tr');
                        for (let date of week) {
                            const cell = document.createElement('td');
                            const isToday = date.toDateString() === today.toDateString();
                            const isCurrentMonth = date.getMonth() === this.currentDate.getMonth();
                            
                            cell.className = `calendar-day ${isToday ? 'today' : ''} ${!isCurrentMonth ? 'other-month' : ''}`;
                            cell.innerHTML = `
                                <div class="day-number">${date.getDate()}</div>
                                <div class="day-events">${this.renderEventsForDate(date)}</div>
                            `;
                            cell.onclick = () => this.handleDateClick(date);
                            row.appendChild(cell);
                        }
                        tbody.appendChild(row);
                    }
                    table.appendChild(tbody);
                    
                    return table;
                },
                
                renderWeekView: function() {
                    const container = document.createElement('div');
                    container.className = 'calendar-time-grid-view';
                    
                    const weekStart = this.getWeekStart(this.currentDate);
                    const weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(weekStart);
                        date.setDate(weekStart.getDate() + i);
                        weekDates.push(date);
                    }
                    
                    // Create time grid
                    const grid = this.createTimeGrid(weekDates);
                    container.appendChild(grid);
                    
                    return container;
                },
                
                renderDayView: function() {
                    const container = document.createElement('div');
                    container.className = 'calendar-time-grid-view';
                    
                    const grid = this.createTimeGrid([this.currentDate]);
                    container.appendChild(grid);
                    
                    return container;
                },
                
                renderResourceWeekView: function() {
                    const container = document.createElement('div');
                    container.className = 'calendar-resource-view';
                    
                    const weekStart = this.getWeekStart(this.currentDate);
                    const weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(weekStart);
                        date.setDate(weekStart.getDate() + i);
                        weekDates.push(date);
                    }
                    
                    const grid = this.createResourceTimeGrid(weekDates);
                    container.appendChild(grid);
                    
                    return container;
                },
                
                renderResourceDayView: function() {
                    const container = document.createElement('div');
                    container.className = 'calendar-resource-view';
                    
                    const grid = this.createResourceTimeGrid([this.currentDate]);
                    container.appendChild(grid);
                    
                    return container;
                },
                
                createTimeGrid: function(dates) {
                    const grid = document.createElement('div');
                    grid.className = 'time-grid';
                    
                    // Header with dates
                    const header = document.createElement('div');
                    header.className = 'time-grid-header';
                    header.innerHTML = '<div class="time-label-header"></div>';
                    
                    dates.forEach(date => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'day-header';
                        const isToday = date.toDateString() === new Date().toDateString();
                        dayHeader.innerHTML = `
                            <div class="day-name">${date.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                            <div class="day-date ${isToday ? 'today' : ''}">${date.getDate()}</div>
                        `;
                        header.appendChild(dayHeader);
                    });
                    grid.appendChild(header);
                    
                    // Time slots
                    const slotsContainer = document.createElement('div');
                    slotsContainer.className = 'time-slots-container';
                    
                    for (let hour = 7; hour < 23; hour++) {
                        const row = document.createElement('div');
                        row.className = 'time-slot-row';
                        
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'time-label';
                        timeLabel.textContent = this.formatHour(hour);
                        row.appendChild(timeLabel);
                        
                        dates.forEach(date => {
                            const slot = document.createElement('div');
                            slot.className = 'time-slot';
                            slot.dataset.date = date.toISOString().split('T')[0];
                            slot.dataset.hour = hour;
                            
                            // Add events for this slot
                            const slotEvents = this.getEventsForSlot(date, hour);
                            slotEvents.forEach(event => {
                                const eventEl = this.createEventElement(event, false);
                                slot.appendChild(eventEl);
                            });
                            
                            // Make droppable
                            slot.ondragover = (e) => {
                                e.preventDefault();
                                // Add visual feedback
                                slot.style.background = 'rgba(59, 130, 246, 0.1)';
                                slot.style.borderTop = '2px solid #3b82f6';
                            };
                            slot.ondragleave = (e) => {
                                // Remove visual feedback
                                slot.style.background = '';
                                slot.style.borderTop = '';
                            };
                            slot.ondrop = (e) => {
                                // Remove visual feedback
                                slot.style.background = '';
                                slot.style.borderTop = '';
                                this.handleDrop(e, date, hour);
                            };
                            
                            // Make clickable to create new event
                            slot.onclick = (e) => {
                                if (e.target === slot) {
                                    this.handleSlotClick(date, hour);
                                }
                            };
                            
                            row.appendChild(slot);
                        });
                        
                        slotsContainer.appendChild(row);
                    }
                    grid.appendChild(slotsContainer);
                    
                    return grid;
                },
                
                createResourceTimeGrid: function(dates) {
                    const grid = document.createElement('div');
                    grid.className = 'time-grid resource-grid';
                    
                    // Get resources based on viewMode
                    let resources = this.getResources();
                    if (resources.length === 0) {
                        grid.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No resources to display</div>';
                        return grid;
                    }
                    
                    // Sort resources by saved column order
                    const firstDate = dates[0].toISOString().split('T')[0];
                    resources = getSortedResources(resources, this.viewMode, firstDate);
                    
                    // Header
                    const header = document.createElement('div');
                    header.className = 'time-grid-header resource-header';
                    header.style.display = 'flex';
                    header.innerHTML = '<div class="time-label-header" style="width: 80px; flex-shrink: 0;"></div><div class="resource-label-header" style="width: 100px; flex-shrink: 0;">Resources</div>';
                    
                    dates.forEach(date => {
                        const dayContainer = document.createElement('div');
                        dayContainer.style.display = 'flex';
                        dayContainer.style.flexDirection = 'column';
                        dayContainer.style.flex = '1';
                        dayContainer.style.minWidth = `${resources.length * 120}px`;
                        dayContainer.style.borderRight = '2px solid var(--border-color)';
                        
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'day-header';
                        dayHeader.style.width = '100%';
                        const isToday = date.toDateString() === new Date().toDateString();
                        dayHeader.innerHTML = `
                            <div class="day-name">${date.toLocaleDateString('en-US', {weekday: 'short'})}</div>
                            <div class="day-date ${isToday ? 'today' : ''}">${date.getDate()}</div>
                        `;
                        dayContainer.appendChild(dayHeader);
                        header.appendChild(dayContainer);
                    });
                    grid.appendChild(header);
                    
                    // Resource labels row - DRAGGABLE
                    const resourceRow = document.createElement('div');
                    resourceRow.className = 'resource-labels-row';
                    resourceRow.innerHTML = '<div class="time-label"></div><div class="resource-spacer"></div>';
                    
                    let draggedLabel = null;
                    
                    dates.forEach(date => {
                        resources.forEach((resource, resIndex) => {
                            const label = document.createElement('div');
                            label.className = 'resource-label';
                            label.textContent = resource.title;
                            label.title = resource.title;
                            label.draggable = true;
                            label.dataset.resourceId = resource.id;
                            label.dataset.index = resIndex;
                            
                            // Drag start
                            label.addEventListener('dragstart', (e) => {
                                draggedLabel = label;
                                label.classList.add('dragging');
                                e.dataTransfer.effectAllowed = 'move';
                            });
                            
                            // Drag over
                            label.addEventListener('dragover', (e) => {
                                e.preventDefault();
                                if (label !== draggedLabel && draggedLabel) {
                                    label.classList.add('drag-over');
                                }
                            });
                            
                            // Drag leave
                            label.addEventListener('dragleave', () => {
                                label.classList.remove('drag-over');
                            });
                            
                            // Drop
                            label.addEventListener('drop', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                if (draggedLabel && draggedLabel !== label) {
                                    const dragIdx = parseInt(draggedLabel.dataset.index);
                                    const targetIdx = parseInt(label.dataset.index);
                                    
                                    // Swap in array
                                    [resources[dragIdx], resources[targetIdx]] = [resources[targetIdx], resources[dragIdx]];
                                    
                                    // Save new order
                                    const newOrder = resources.map(r => r.id);
                                    resourceColumnOrder[`${window.currentViewMode}-${firstDate}`] = newOrder;
                                    saveColumnOrder();
                                    
                                    // Re-render
                                    if (window.calendarInstance && window.calendarInstance.render) {
                                        window.calendarInstance.render();
                                    }
                                    
                                    label.classList.remove('drag-over');
                                }
                            });
                            
                            // Drag end
                            label.addEventListener('dragend', () => {
                                if (draggedLabel) draggedLabel.classList.remove('dragging');
                                document.querySelectorAll('.resource-label.drag-over').forEach(el => {
                                    el.classList.remove('drag-over');
                                });
                                draggedLabel = null;
                            });
                            
                            resourceRow.appendChild(label);
                        });
                    });
                    grid.appendChild(resourceRow);
                    
                    // Unscheduled items banner (only show in employee view when relevant)
                    if (this.viewMode === 'employee' && (currentEmployeeDataType === 'duties' || currentEmployeeDataType === 'none')) {
                        const unscheduledRow = document.createElement('div');
                        unscheduledRow.className = 'unscheduled-items-row';
                        unscheduledRow.innerHTML = '<div class="time-label">Unscheduled</div><div class="resource-spacer"></div>';
                        
                        dates.forEach(date => {
                            resources.forEach(resource => {
                                const unscheduledCell = document.createElement('div');
                                unscheduledCell.className = 'unscheduled-cell';
                                
                                // Get unscheduled items for this resource
                                const unscheduledItems = this.getUnscheduledItemsForResource(resource.id);
                                
                                if (unscheduledItems.length > 0) {
                                    unscheduledItems.forEach(item => {
                                        const itemEl = document.createElement('div');
                                        itemEl.className = currentEmployeeDataType === 'duties' ? 'unscheduled-duty-chip' : 'unscheduled-task-chip';
                                        itemEl.textContent = item.title || item.description || 'Untitled';
                                        itemEl.title = item.description || item.title || 'No description';
                                        itemEl.onclick = (e) => {
                                            e.stopPropagation();
                                            // Show details modal for unscheduled item
                                            alert(`${currentEmployeeDataType === 'duties' ? 'Duty' : 'Task'}: ${item.title || item.description}\n\nThis item needs to be scheduled.`);
                                        };
                                        unscheduledCell.appendChild(itemEl);
                                    });
                                } else {
                                    unscheduledCell.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.7rem; font-style: italic;">â€”</span>';
                                }
                                
                                unscheduledRow.appendChild(unscheduledCell);
                            });
                        });
                        
                        grid.appendChild(unscheduledRow);
                    }
                    
                    // Time slots
                    const slotsContainer = document.createElement('div');
                    slotsContainer.className = 'time-slots-container resource-slots';
                    
                    for (let hour = 7; hour < 23; hour++) {
                        const row = document.createElement('div');
                        row.className = 'time-slot-row';
                        
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'time-label';
                        timeLabel.textContent = this.formatHour(hour);
                        row.appendChild(timeLabel);
                        
                        const spacer = document.createElement('div');
                        spacer.className = 'resource-spacer';
                        row.appendChild(spacer);
                        
                        dates.forEach(date => {
                            resources.forEach(resource => {
                                const slot = document.createElement('div');
                                slot.className = 'time-slot resource-slot';
                                slot.dataset.date = date.toISOString().split('T')[0];
                                slot.dataset.hour = hour;
                                slot.dataset.resourceId = resource.id;
                                
                                // Add events for this slot and resource
                                const slotEvents = this.getEventsForResourceSlot(date, hour, resource.id);
                                
                                // For assistants mode, position events side-by-side if multiple
                                if (currentEmployeeDataType === 'assistants' && slotEvents.length > 0) {
                                    const assistantEvents = slotEvents.filter(e => e.isAssistant || e.extendedProps?.type === 'assistant');
                                    const otherEvents = slotEvents.filter(e => !e.isAssistant && e.extendedProps?.type !== 'assistant');
                                    
                                    if (assistantEvents.length > 1) {
                                        // Multiple assistants - position them side by side
                                        const widthPercent = 100 / assistantEvents.length;
                                        assistantEvents.forEach((event, index) => {
                                            const eventEl = this.createEventElement(event, true);
                                            
                                            // Calculate event duration in hours
                                            const duration = this.calculateEventDuration(event);
                                            
                                            eventEl.style.position = 'absolute';
                                            eventEl.style.left = `${index * widthPercent}%`;
                                            eventEl.style.width = `${widthPercent - 0.5}%`;
                                            eventEl.style.height = duration >= 1 ? `${duration * 60}px` : '100%';
                                            eventEl.style.boxSizing = 'border-box';
                                            eventEl.style.zIndex = '10';
                                            slot.appendChild(eventEl);
                                        });
                                    } else {
                                        // Single assistant - full width with proper height
                                        assistantEvents.forEach(event => {
                                            const eventEl = this.createEventElement(event, true);
                                            const duration = this.calculateEventDuration(event);
                                            if (duration >= 1) {
                                                eventEl.style.position = 'absolute';
                                                eventEl.style.width = '100%';
                                                eventEl.style.height = `${duration * 60}px`;
                                                eventEl.style.zIndex = '10';
                                            }
                                            slot.appendChild(eventEl);
                                        });
                                    }
                                    
                                    // Add other events if any
                                    otherEvents.forEach(event => {
                                        const eventEl = this.createEventElement(event, true);
                                        slot.appendChild(eventEl);
                                    });
                                } else {
                                    // Normal mode - just add events
                                    slotEvents.forEach(event => {
                                        const eventEl = this.createEventElement(event, true);
                                        slot.appendChild(eventEl);
                                    });
                                }
                                
                                // Make droppable
                                slot.ondragover = (e) => {
                                    e.preventDefault();
                                    // Add visual feedback
                                    slot.style.background = 'rgba(59, 130, 246, 0.1)';
                                    slot.style.borderTop = '2px solid #3b82f6';
                                };
                                slot.ondragleave = (e) => {
                                    // Remove visual feedback
                                    slot.style.background = '';
                                    slot.style.borderTop = '';
                                };
                                slot.ondrop = (e) => {
                                    // Remove visual feedback
                                    slot.style.background = '';
                                    slot.style.borderTop = '';
                                    this.handleResourceDrop(e, date, hour, resource.id);
                                };
                                
                                // Make clickable to create new event
                                slot.onclick = (e) => {
                                    if (e.target === slot) {
                                        this.handleResourceSlotClick(date, hour, resource.id);
                                    }
                                };
                                
                                row.appendChild(slot);
                            });
                        });
                        
                        slotsContainer.appendChild(row);
                    }
                    grid.appendChild(slotsContainer);
                    
                    return grid;
                },
                
                getMonthDates: function() {
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(firstDay.getDate() - firstDay.getDay());
                    
                    const weeks = [];
                    let currentDate = new Date(startDate);
                    
                    for (let week = 0; week < 6; week++) {
                        const weekDates = [];
                        for (let day = 0; day < 7; day++) {
                            weekDates.push(new Date(currentDate));
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        weeks.push(weekDates);
                        if (currentDate.getMonth() !== month && week >= 4) break;
                    }
                    
                    return weeks;
                },
                
                renderEventsForDate: function(date) {
                    const dateStr = date.toISOString().split('T')[0];
                    let filteredEvents = [];
                    
                    console.log('renderEventsForDate - currentEmployeeDataType:', currentEmployeeDataType);
                    
                    // Show selected data type or regular events (including task events)
                    if (showWorkingHours && currentEmployeeDataType === 'working-hours') {
                        // Show ONLY working hours
                        const whEvents = generateWorkingHoursEventsForRange(date, date);
                        if (whEvents && whEvents.length > 0) {
                            filteredEvents = whEvents;
                        }
                    } else if (currentEmployeeDataType === 'duties') {
                        // Show ONLY duties
                        const dutyEvents = generateDutiesEventsForRange(date, date);
                        if (dutyEvents && dutyEvents.length > 0) {
                            filteredEvents = dutyEvents;
                        }
                    } else if (currentEmployeeDataType === 'assistants') {
                        // Show ONLY assistants
                        const assistantEvents = generateAssistantsEventsForRange(date, date);
                        console.log('renderEventsForDate - assistant events:', assistantEvents.length);
                        if (assistantEvents && assistantEvents.length > 0) {
                            filteredEvents = assistantEvents;
                        }
                    } else {
                        // Show regular events (including task events) by default
                        filteredEvents = getFilteredEvents();
                    }
                    
                    const dayEvents = filteredEvents.filter(e => e.start && e.start.startsWith(dateStr));
                    
                    if (dayEvents.length === 0) return '';
                    
                    let html = '';
                    let regularEvents = dayEvents.filter(e => !e.isWorkingHours);
                    let workingHoursEvents = dayEvents.filter(e => e.isWorkingHours);
                    
                    // Show regular events first (max 3)
                    regularEvents.slice(0, 3).forEach(event => {
                        const priorityClass = event.priority || 'low';
                        html += `<div class="event-item priority-${priorityClass}" title="${event.title}" onclick="handleEventClick({event: ${JSON.stringify(event).replace(/"/g, '&quot;')}}); event.stopPropagation();">
                            ${event.overdue ? '<span class="badge overdue">!</span>' : ''}
                            ${event.paid ? '<span class="badge paid">$</span>' : ''}
                            <span class="event-title">${event.title}</span>
                        </div>`;
                    });
                    
                    const remaining = regularEvents.length - 3;
                    if (remaining > 0) {
                        html += `<div class="event-more">+${remaining} more</div>`;
                    }
                    
                    // Show working hours indicator at bottom if present
                    if (workingHoursEvents.length > 0 && regularEvents.length < 3) {
                        html += `<div class="event-item working-hours-indicator" title="${workingHoursEvents.length} staff scheduled" style="background: #f3f4f6; color: #9ca3af; font-size: 0.65rem; padding: 1px 3px; border: 1px solid #e5e7eb; margin-top: 2px;">
                            <i class="fas fa-user-clock" style="font-size: 0.55rem;"></i> ${workingHoursEvents.length}
                        </div>`;
                    }
                    
                    return html;
                },
                
                getMonthYearString: function() {
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                    return `${months[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                },
                
                getDateRangeString: function() {
                    if (this.currentView === 'month') {
                        return this.getMonthYearString();
                    } else if (this.currentView === 'week' || this.currentView === 'resourceWeek') {
                        const weekStart = this.getWeekStart(this.currentDate);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return `${weekStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} â€“ ${weekEnd.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
                    } else {
                        return this.currentDate.toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
                    }
                },
                
                getWeekStart: function(date) {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day;
                    return new Date(d.setDate(diff));
                },
                
                formatHour: function(hour) {
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    return `${displayHour}:00 ${period}`;
                },
                
                getEventsForSlot: function(date, hour) {
                    const dateStr = date.toISOString().split('T')[0];
                    let filteredEvents = [];
                    
                    console.log('getEventsForSlot - currentEmployeeDataType:', currentEmployeeDataType);
                    
                    // Show selected data type or regular events
                    if (showWorkingHours && currentEmployeeDataType === 'working-hours') {
                        // Show ONLY working hours
                        console.log('Loading working hours events');
                        const whEvents = generateWorkingHoursEventsForRange(date, date);
                        if (whEvents && whEvents.length > 0) {
                            filteredEvents = whEvents;
                        }
                    } else if (currentEmployeeDataType === 'duties') {
                        // Show ONLY duties
                        console.log('Loading duties events');
                        const dutyEvents = generateDutiesEventsForRange(date, date);
                        if (dutyEvents && dutyEvents.length > 0) {
                            filteredEvents = dutyEvents;
                        }
                    } else if (currentEmployeeDataType === 'assistants') {
                        // Show ONLY assistants
                        console.log('Loading assistants events');
                        const assistantEvents = generateAssistantsEventsForRange(date, date);
                        console.log('Assistant events loaded:', assistantEvents.length);
                        if (assistantEvents && assistantEvents.length > 0) {
                            filteredEvents = assistantEvents;
                        }
                    } else {
                        // Show regular events by default
                        console.log('Loading regular events');
                        filteredEvents = getFilteredEvents();
                    }
                    
                    return filteredEvents.filter(event => {
                        if (!event.start) return false;
                        const eventDate = event.start.split('T')[0];
                        if (eventDate !== dateStr) return false;
                        
                        const eventTime = event.start.split('T')[1];
                        if (!eventTime) return false;
                        
                        const eventHour = parseInt(eventTime.split(':')[0]);
                        return eventHour === hour;
                    });
                },
                
                getUnscheduledItemsForResource: function(resourceId) {
                    let allItems = [];
                    
                    // Get duties without time/date
                    if (currentEmployeeDataType === 'duties') {
                        allItems = employeeDutiesDatabase.filter(duty => {
                            const hasEmployee = duty.employeeId === resourceId;
                            const lacksTime = !duty.start || !duty.end || !duty.date;
                            return hasEmployee && lacksTime;
                        });
                    } else if (currentEmployeeDataType === 'none') {
                        // For tasks view, check task database for unscheduled items
                        allItems = employeeTasksDatabase.filter(task => {
                            const hasEmployee = task.employeeId === resourceId;
                            const lacksTime = !task.start || !task.end || !task.date;
                            return hasEmployee && lacksTime;
                        });
                    }
                    
                    return allItems;
                },
                
                getEventsForResourceSlot: function(date, hour, resourceId) {
                    const dateStr = date.toISOString().split('T')[0];
                    let filteredEvents = [];
                    
                    console.log('getEventsForResourceSlot called - Date:', dateStr, 'Hour:', hour, 'ResourceId:', resourceId, 'DataType:', currentEmployeeDataType);
                    
                    // Show selected data type or regular events
                    if (showWorkingHours && currentEmployeeDataType === 'working-hours') {
                        // Show ONLY working hours
                        const whEvents = generateWorkingHoursEventsForRange(date, date);
                        if (whEvents && whEvents.length > 0) {
                            filteredEvents = whEvents;
                        }
                    } else if (currentEmployeeDataType === 'duties') {
                        // Show ONLY duties
                        const dutyEvents = generateDutiesEventsForRange(date, date);
                        if (dutyEvents && dutyEvents.length > 0) {
                            filteredEvents = dutyEvents;
                        }
                    } else if (currentEmployeeDataType === 'assistants') {
                        // Show ONLY assistants
                        console.log('Loading assistants for resource slot');
                        const assistantEvents = generateAssistantsEventsForRange(date, date);
                        console.log('Assistant events generated:', assistantEvents.length);
                        if (assistantEvents && assistantEvents.length > 0) {
                            filteredEvents = assistantEvents;
                        }
                    } else {
                        // Show regular events by default
                        filteredEvents = getFilteredEvents();
                    }
                    
                    console.log('Filtered events before slot filtering:', filteredEvents.length);
                    
                    const slotEvents = filteredEvents.filter(event => {
                        console.log('Checking event:', event.title, 'Start:', event.start);
                        
                        if (!event.start) {
                            console.log('  - No start time, skipping');
                            return false;
                        }
                        
                        const eventDate = event.start.split('T')[0];
                        if (eventDate !== dateStr) {
                            console.log('  - Date mismatch:', eventDate, '!==', dateStr);
                            return false;
                        }
                        
                        const eventTime = event.start.split('T')[1];
                        if (!eventTime) {
                            console.log('  - No event time, skipping');
                            return false;
                        }
                        
                        const eventHour = parseInt(eventTime.split(':')[0]);
                        if (eventHour !== hour) {
                            console.log('  - Hour mismatch:', eventHour, '!==', hour);
                            return false;
                        }
                        
                        // Check resource match based on viewMode
                        if (currentEmployeeDataType === 'assistants' && this.viewMode === 'provider') {
                            // In assistants mode with provider columns, match by provider ID (assistants stack in provider cells)
                            const matches = event.resourceId === resourceId || event.provider === resourceId;
                            console.log('  - Assistant/Provider match check:', event.resourceId, '===', resourceId, '?', matches);
                            return matches;
                        } else if (this.viewMode === 'employee' || this.viewMode === 'provider') {
                            const matches = event.resourceId === resourceId || event.employee === resourceId || 
                                   (event.resourceIds && event.resourceIds.includes(resourceId));
                            console.log('  - Resource match check:', event.resourceId, '===', resourceId, '?', matches);
                            return matches;
                        } else if (this.viewMode === 'room') {
                            const roomId = getRoomIdFromLocation(event.location);
                            return roomId === resourceId;
                        } else if (this.viewMode === 'event') {
                            const typeKey = (event.type || 'other').toString().toLowerCase();
                            return 'event-type-' + typeKey === resourceId;
                        }
                        
                        return false;
                    });
                    
                    console.log('Final slot events:', slotEvents.length, slotEvents);
                    return slotEvents;
                },
                
                getResources: function() {
                    // Always return resources based on current viewMode
                    // Even if working hours are shown, we should display the correct resource type
                    
                    // In assistants mode, still show provider columns (assistants will stack within cells)
                    
                    if (this.viewMode === 'employee') {
                        return getFilteredResources(employeeResources, 'employee');
                    } else if (this.viewMode === 'room') {
                        return getFilteredResources(roomResources, 'room');
                    } else if (this.viewMode === 'provider') {
                        return getFilteredResources(providerResources, 'provider');
                    } else if (this.viewMode === 'event') {
                        return getFilteredResources(eventTypeResources, 'event');
                    } else if (this.viewMode === 'date') {
                        // Date view doesn't use resources
                        return [];
                    }
                    
                    return [];
                },
                
                getAssistantResources: function() {
                    // Build a list of unique assistants from the database as separate columns
                    const assistantDatabase = [
                        { id: 'a1', name: 'Sarah Johnson', providerId: 'john-smith', providerName: 'John Smith', startTime: '08:00', endTime: '12:00', days: ['Monday', 'Wednesday', 'Friday', 'Sunday'], color: '#10b981' },
                        { id: 'a2', name: 'Mike Chen', providerId: 'john-smith', providerName: 'John Smith', startTime: '13:00', endTime: '17:00', days: ['Tuesday', 'Thursday', 'Saturday'], color: '#3b82f6' },
                        { id: 'a9', name: 'Amy Rodriguez', providerId: 'john-smith', providerName: 'John Smith', startTime: '13:00', endTime: '17:00', days: ['Saturday', 'Sunday'], color: '#f97316' },
                        { id: 'a3', name: 'Emma Davis', providerId: 'mike-davis', providerName: 'Mike Davis', startTime: '08:00', endTime: '12:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], color: '#f59e0b' },
                        { id: 'a4', name: 'James Wilson', providerId: 'mike-davis', providerName: 'Mike Davis', startTime: '13:00', endTime: '17:00', days: ['Monday', 'Wednesday', 'Friday', 'Sunday'], color: '#8b5cf6' },
                        { id: 'a5', name: 'Lisa Anderson', providerId: 'mike-davis', providerName: 'Mike Davis', startTime: '09:00', endTime: '15:00', days: ['Tuesday', 'Thursday', 'Saturday'], color: '#ec4899' },
                        { id: 'a6', name: 'Robert Martinez', providerId: 'emily-brown', providerName: 'Emily Brown', startTime: '10:00', endTime: '14:00', days: ['Monday', 'Wednesday', 'Friday'], color: '#14b8a6' },
                        { id: 'a7', name: 'Jennifer Lee', providerId: 'james-wilson', providerName: 'James Wilson', startTime: '08:00', endTime: '12:00', days: ['Tuesday', 'Thursday', 'Saturday'], color: '#f43f5e' },
                        { id: 'a8', name: 'David Brown', providerId: 'james-wilson', providerName: 'James Wilson', startTime: '14:00', endTime: '18:00', days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Sunday'], color: '#6366f1' },
                    ];
                    
                    // Convert assistants to resource format with icons to differentiate
                    return assistantDatabase.map(assistant => ({
                        id: assistant.id,
                        title: assistant.name,
                        extendedProps: {
                            color: assistant.color,
                            assistantId: assistant.id,
                            assistantName: assistant.name,
                            providerId: assistant.providerId,
                            providerName: assistant.providerName,
                            isAssistant: true
                        }
                    }));
                },
                
                createEventElement: function(event, isResource) {
                    const eventEl = document.createElement('div');
                    const isWorkingHours = event.isWorkingHours || event.type === 'working-hours';
                    const isTask = event.isTask || false;
                    const isDuty = event.isDuty || false;
                    const isAssistant = event.isAssistant || event.extendedProps?.type === 'assistant';
                    
                    // Determine styling based on event type
                    let eventClass = 'calendar-event ';
                    if (isWorkingHours) {
                        eventClass += 'working-hours-block';
                    } else if (isTask) {
                        eventClass += 'task-block priority-' + (event.priority || 'medium');
                    } else if (isDuty) {
                        eventClass += 'duty-block';
                    } else if (isAssistant) {
                        eventClass += 'assistant-block';
                    } else {
                        eventClass += 'priority-' + (event.priority || 'low');
                    }
                    
                    eventEl.className = eventClass;
                    eventEl.draggable = !isWorkingHours && !isTask && !isDuty;
                    eventEl.dataset.eventId = event.id;
                    
                    if (isWorkingHours) {
                        eventEl.dataset.type = 'working-hours';
                    } else if (isTask) {
                        eventEl.dataset.type = 'task';
                        eventEl.style.background = '#fef3c7';
                        eventEl.style.borderLeft = '4px solid #f59e0b';
                        eventEl.style.color = '#78350f';
                    } else if (isDuty) {
                        eventEl.dataset.type = 'duty';
                        eventEl.style.background = '#dbeafe';
                        eventEl.style.borderLeft = '4px solid #3b82f6';
                        eventEl.style.color = '#1e40af';
                    } else if (isAssistant) {
                        eventEl.dataset.type = 'assistant';
                        eventEl.style.background = event.backgroundColor || '#e0e7ff';
                        eventEl.style.borderLeft = '3px solid ' + (event.borderColor || '#6366f1');
                        eventEl.style.color = '#1e1b4b';
                        eventEl.style.fontSize = '0.7rem';
                        eventEl.style.padding = '2px 4px';
                    }
                    
                    let badges = '';
                    if (!isWorkingHours && !isTask && !isDuty) {
                        if (event.overdue) badges += '<span class="event-badge overdue">!</span>';
                        if (event.paid) badges += '<span class="event-badge paid">$</span>';
                    }
                    
                    // Calculate event duration for height
                    const duration = this.calculateEventDuration(event);
                    // Don't set height/position for assistants in resource view - handled in slot creation
                    if (duration >= 1 && !isAssistant) {
                        // Each hour is 60px, subtract small margin for visual clarity
                        eventEl.style.height = `${duration * 60 - 2}px`;
                        eventEl.style.position = 'absolute';
                        eventEl.style.width = 'calc(100% - 4px)';
                        eventEl.style.zIndex = isWorkingHours ? '1' : '2';
                    }
                    
                    // Extract time for display
                    let timeStr = '';
                    if (event.start) {
                        const time = event.start.split('T')[1];
                        if (time) {
                            const [hour, minute] = time.split(':');
                            const h = parseInt(hour);
                            const period = h >= 12 ? 'PM' : 'AM';
                            const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
                            timeStr = `${displayHour}:${minute} ${period}`;
                        }
                    }
                    
                    if (isWorkingHours) {
                        eventEl.innerHTML = `
                            <span class="event-text" style="font-size: 0.65rem; opacity: 0.8;">${event.title}</span>
                        `;
                    } else if (isAssistant) {
                        // Special rendering for assistant events - compact display with room number
                        const room = event.extendedProps?.room || 'N/A';
                        const timeRange = event.extendedProps?.timeRange || timeStr;
                        eventEl.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 1px;">
                                <div style="font-weight: 600; font-size: 0.7rem;">ðŸ‘¤ ${event.title}</div>
                                <div style="font-size: 0.65rem; opacity: 0.85;">ðŸšª Room ${room}</div>
                                <div style="font-size: 0.6rem; opacity: 0.7;">${timeRange}</div>
                            </div>
                        `;
                    } else {
                        // Add resize handles for multi-hour events
                        const resizeHandles = duration >= 1 ? `
                            <div class="event-resize-handle event-resize-top" data-event-id="${event.id}" style="position: absolute; top: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; background: rgba(59, 130, 246, 0.3); border-top: 2px solid #3b82f6; opacity: 0; transition: opacity 0.2s;"></div>
                            <div class="event-resize-handle event-resize-bottom" data-event-id="${event.id}" style="position: absolute; bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; background: rgba(59, 130, 246, 0.3); border-bottom: 2px solid #3b82f6; opacity: 0; transition: opacity 0.2s;"></div>
                        ` : '';
                        
                        eventEl.innerHTML = `
                            ${resizeHandles}
                            <div class="event-time">${timeStr}</div>
                            ${badges}
                            <span class="event-text">${event.title}</span>
                        `;
                        
                        // Show handles on hover
                        if (duration >= 1) {
                            eventEl.onmouseenter = () => {
                                const handles = eventEl.querySelectorAll('.event-resize-handle');
                                handles.forEach(h => h.style.opacity = '1');
                            };
                            eventEl.onmouseleave = () => {
                                const handles = eventEl.querySelectorAll('.event-resize-handle');
                                handles.forEach(h => h.style.opacity = '0');
                            };
                        }
                    }
                    
                    if (!isWorkingHours) {
                        // Prevent dragging when clicking on resize handles
                        eventEl.ondragstart = (e) => {
                            if (e.target.classList.contains('event-resize-handle')) {
                                e.preventDefault();
                                return false;
                            }
                            this.handleDragStart(e, event);
                        };
                        
                        eventEl.onclick = (e) => {
                            // Don't open event details when clicking resize handles
                            if (e.target.classList.contains('event-resize-handle')) {
                                e.stopPropagation();
                                return;
                            }
                            e.stopPropagation();
                            handleEventClick({event: event});
                        };
                        
                        // Add resize functionality
                        if (duration >= 1) {
                            setTimeout(() => {
                                const topHandle = eventEl.querySelector('.event-resize-top');
                                const bottomHandle = eventEl.querySelector('.event-resize-bottom');
                                
                                if (topHandle) {
                                    topHandle.onmousedown = (e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        this.startResize(e, event, 'top', eventEl);
                                    };
                                }
                                
                                if (bottomHandle) {
                                    bottomHandle.onmousedown = (e) => {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        this.startResize(e, event, 'bottom', eventEl);
                                    };
                                }
                            }, 0);
                        }
                        
                        // Add right-click context menu
                        eventEl.oncontextmenu = (e) => {
                            e.preventDefault();
                            this.showEventContextMenu(e, event);
                        };
                    } else {
                        // Working hours blocks are clickable to show shift details
                        eventEl.style.cursor = 'pointer';
                        eventEl.onclick = (e) => {
                            e.stopPropagation();
                            showWorkingHoursShiftDetails(event);
                        };
                    }
                    
                    return eventEl;
                },
                
                showEventContextMenu: function(e, event) {
                    const existingMenu = document.querySelector('.event-context-menu');
                    if (existingMenu) existingMenu.remove();
                    
                    const menu = document.createElement('div');
                    menu.className = 'event-context-menu';
                    menu.style.cssText = `
                        position: fixed;
                        left: ${e.clientX}px;
                        top: ${e.clientY}px;
                        background: var(--card-bg);
                        border: 1px solid var(--border-color);
                        border-radius: 6px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        min-width: 150px;
                        padding: 0.5rem 0;
                    `;
                    
                    const menuItems = [
                        { label: 'Edit Event', icon: 'fa-edit', action: () => handleEventClick({event: event}) },
                        { label: 'Duplicate', icon: 'fa-copy', action: () => this.duplicateEvent(event) },
                        { label: 'Delete', icon: 'fa-trash', action: () => this.deleteEvent(event), danger: true }
                    ];
                    
                    menuItems.forEach(item => {
                        const menuItem = document.createElement('div');
                        menuItem.style.cssText = `
                            padding: 0.5rem 1rem;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            color: ${item.danger ? '#dc2626' : 'var(--text-primary)'};
                            transition: background 0.2s;
                        `;
                        menuItem.innerHTML = `<i class="fas ${item.icon}"></i> ${item.label}`;
                        menuItem.onmouseover = () => menuItem.style.background = 'var(--bg-secondary)';
                        menuItem.onmouseout = () => menuItem.style.background = 'transparent';
                        menuItem.onclick = () => {
                            item.action();
                            menu.remove();
                        };
                        menu.appendChild(menuItem);
                    });
                    
                    document.body.appendChild(menu);
                    
                    setTimeout(() => {
                        document.addEventListener('click', function closeMenu() {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        });
                    }, 100);
                },
                
                duplicateEvent: function(event) {
                    const newEvent = {
                        ...event,
                        id: 'event-' + Date.now(),
                        title: event.title + ' (Copy)'
                    };
                    eventDatabase.push(newEvent);
                    this.render();
                },
                
                deleteEvent: function(event) {
                    if (confirm(`Delete event \"${event.title}\"?`)) {
                        const index = eventDatabase.findIndex(e => e.id === event.id);
                        if (index !== -1) {
                            eventDatabase.splice(index, 1);
                            this.render();
                        }
                    }
                },
                
                handleDragStart: function(e, event) {
                    // Prevent dragging working hours events
                    if (event.isWorkingHours || event.type === 'working-hours') {
                        e.preventDefault();
                        return false;
                    }
                    
                    this.draggedEvent = event;
                    this.draggedElement = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.innerHTML);
                    
                    // Use requestAnimationFrame to apply styles after drag image is captured
                    requestAnimationFrame(() => {
                        if (this.draggedElement) {
                            this.draggedElement.style.opacity = '0.3';
                            this.draggedElement.style.pointerEvents = 'none';
                        }
                    });
                },
                
                handleDrop: function(e, date, hour) {
                    e.preventDefault();
                    if (!this.draggedEvent) return;
                    
                    const dateStr = date.toISOString().split('T')[0];
                    const timeStr = `${hour.toString().padStart(2, '0')}:00:00`;
                    
                    // Calculate duration BEFORE modifying the event
                    const duration = this.calculateEventDuration(this.draggedEvent);
                    
                    // Get original start hour for comparison
                    const origStart = new Date(this.draggedEvent.start);
                    const origHour = origStart.getHours();
                    
                    alert(`Moving event from ${origHour}:00 to ${hour}:00\nDuration: ${duration} hours\nNew time will be: ${hour}:00 to ${hour + duration}:00`);
                    
                    console.log('Dragging event:', this.draggedEvent.title);
                    console.log('Original start:', this.draggedEvent.start);
                    console.log('Original end:', this.draggedEvent.end);
                    console.log('Calculated duration:', duration, 'hours');
                    console.log('Dropping at hour:', hour);
                    console.log('New start will be:', `${dateStr}T${timeStr}`);
                    
                    // Update event
                    const eventIndex = eventDatabase.findIndex(ev => ev.id === this.draggedEvent.id);
                    if (eventIndex !== -1) {
                        const newStart = `${dateStr}T${timeStr}`;
                        const endHour = hour + duration;
                        const newEnd = `${dateStr}T${endHour.toString().padStart(2, '0')}:00:00`;
                        
                        console.log('New end will be:', newEnd);
                        
                        eventDatabase[eventIndex].start = newStart;
                        eventDatabase[eventIndex].end = newEnd;
                    }
                    
                    this.draggedEvent = null;
                    this.draggedElement = null;
                    this.render();
                },
                
                handleResourceDrop: function(e, date, hour, resourceId) {
                    e.preventDefault();
                    if (!this.draggedEvent) return;
                    
                    const dateStr = date.toISOString().split('T')[0];
                    const timeStr = `${hour.toString().padStart(2, '0')}:00:00`;
                    
                    // Update event
                    const eventIndex = eventDatabase.findIndex(ev => ev.id === this.draggedEvent.id);
                    if (eventIndex !== -1) {
                        eventDatabase[eventIndex].start = `${dateStr}T${timeStr}`;
                        const duration = this.calculateEventDuration(this.draggedEvent);
                        const endHour = hour + duration;
                        eventDatabase[eventIndex].end = `${dateStr}T${endHour.toString().padStart(2, '0')}:00:00`;
                        
                        // Update resource
                        if (this.viewMode === 'employee' || this.viewMode === 'provider') {
                            eventDatabase[eventIndex].resourceId = resourceId;
                            eventDatabase[eventIndex].employee = resourceId;
                        } else if (this.viewMode === 'room') {
                            // Find room title from resourceId
                            const resource = roomResources.find(r => r.id === resourceId);
                            if (resource) {
                                eventDatabase[eventIndex].location = resource.title;
                            }
                        }
                    }
                    
                    this.draggedEvent = null;
                    this.draggedElement = null;
                    this.render();
                },
                
                calculateEventDuration: function(event) {
                    if (!event.start || !event.end) return 1;
                    const start = new Date(event.start);
                    const end = new Date(event.end);
                    const diffMs = end - start;
                    const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));
                    return Math.max(1, diffHours);
                },
                
                // Resize event handlers
                startResize: function(e, event, handleType, eventEl) {
                    this.resizingEvent = event;
                    this.resizeType = handleType;
                    this.resizeStartY = e.clientY;
                    this.resizeCurrentY = e.clientY;
                    
                    const start = new Date(event.start);
                    const end = new Date(event.end);
                    this.resizeOriginalStart = start.getHours();
                    this.resizeOriginalEnd = end.getHours();
                    
                    // Add global mouse move and up handlers
                    document.onmousemove = (e) => this.handleResize(e, eventEl);
                    document.onmouseup = () => this.endResize();
                    
                    // Visual feedback
                    eventEl.style.opacity = '0.7';
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                },
                
                handleResize: function(e, eventEl) {
                    if (!this.resizingEvent) return;
                    
                    this.resizeCurrentY = e.clientY;
                    const deltaY = e.clientY - this.resizeStartY;
                    const hoursDelta = Math.round(deltaY / 60); // Approximate 60px per hour
                    
                    if (this.resizeType === 'top') {
                        // Adjust start time
                        const newStartHour = Math.max(7, Math.min(22, this.resizeOriginalStart + hoursDelta));
                        if (newStartHour < this.resizeOriginalEnd) {
                            const newHeight = (this.resizeOriginalEnd - newStartHour) * 60 - 2;
                            eventEl.style.height = `${newHeight}px`;
                        }
                    } else {
                        // Adjust end time
                        const newEndHour = Math.max(8, Math.min(23, this.resizeOriginalEnd + hoursDelta));
                        if (newEndHour > this.resizeOriginalStart) {
                            const newHeight = (newEndHour - this.resizeOriginalStart) * 60 - 2;
                            eventEl.style.height = `${newHeight}px`;
                        }
                    }
                },
                
                endResize: function() {
                    if (!this.resizingEvent) return;
                    
                    document.onmousemove = null;
                    document.onmouseup = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // Calculate final times based on mouse movement
                    const eventIndex = eventDatabase.findIndex(ev => ev.id === this.resizingEvent.id);
                    if (eventIndex !== -1) {
                        const event = eventDatabase[eventIndex];
                        const start = new Date(event.start);
                        const dateStr = start.toISOString().split('T')[0];
                        
                        // Get the resize delta
                        const deltaY = this.resizeCurrentY - this.resizeStartY;
                        const hoursDelta = Math.round(deltaY / 60);
                        
                        if (this.resizeType === 'top') {
                            // Adjust start time
                            const newStartHour = Math.max(7, Math.min(22, this.resizeOriginalStart + hoursDelta));
                            if (newStartHour < this.resizeOriginalEnd) {
                                eventDatabase[eventIndex].start = `${dateStr}T${newStartHour.toString().padStart(2, '0')}:00:00`;
                            }
                        } else {
                            // Adjust end time
                            const newEndHour = Math.max(8, Math.min(23, this.resizeOriginalEnd + hoursDelta));
                            if (newEndHour > this.resizeOriginalStart) {
                                eventDatabase[eventIndex].end = `${dateStr}T${newEndHour.toString().padStart(2, '0')}:00:00`;
                            }
                        }
                    }
                    
                    this.resizingEvent = null;
                    this.resizeType = null;
                    this.resizeCurrentY = null;
                    this.render();
                },
                
                enableDragAndDrop: function() {
                    const events = document.querySelectorAll('.calendar-event');
                    events.forEach(event => {
                        event.ondragend = (e) => {
                            e.target.style.opacity = '1';
                        };
                    });
                },
                
                handleSlotClick: function(date, hour) {
                    // Quick create event at this time
                    const dateStr = date.toISOString().split('T')[0];
                    const startTime = `${hour.toString().padStart(2, '0')}:00:00`;
                    const endTime = `${(hour + 1).toString().padStart(2, '0')}:00:00`;
                    
                    // Pre-fill modal with date and time
                    if (window.openEventModal) {
                        window.openEventModal();
                        setTimeout(() => {
                            const dateInput = document.getElementById('eventDate');
                            const startInput = document.getElementById('eventStartTime');
                            const endInput = document.getElementById('eventEndTime');
                            
                            if (dateInput) dateInput.value = dateStr;
                            if (startInput) startInput.value = startTime.substring(0, 5);
                            if (endInput) endInput.value = endTime.substring(0, 5);
                        }, 100);
                    }
                },
                
                handleResourceSlotClick: function(date, hour, resourceId) {
                    const dateStr = date.toISOString().split('T')[0];
                    const startTime = `${hour.toString().padStart(2, '0')}:00:00`;
                    const endTime = `${(hour + 1).toString().padStart(2, '0')}:00:00`;
                    
                    if (window.openEventModal) {
                        window.openEventModal();
                        setTimeout(() => {
                            const dateInput = document.getElementById('eventDate');
                            const startInput = document.getElementById('eventStartTime');
                            const endInput = document.getElementById('eventEndTime');
                            
                            if (dateInput) dateInput.value = dateStr;
                            if (startInput) startInput.value = startTime.substring(0, 5);
                            if (endInput) endInput.value = endTime.substring(0, 5);
                            
                            // Pre-select resource if in employee/provider mode
                            if (this.viewMode === 'employee' || this.viewMode === 'provider') {
                                const employeeSelect = document.getElementById('eventEmployee');
                                if (employeeSelect) {
                                    employeeSelect.value = resourceId;
                                }
                            }
                        }, 100);
                    }
                },
                
                handleDateClick: function(date) {
                    // Show all events for this date in a modal
                    const dateStr = date.toISOString().split('T')[0];
                    let filteredEvents = [];
                    
                    // Show selected data type or regular events
                    if (showWorkingHours && currentEmployeeDataType === 'working-hours') {
                        // Show ONLY working hours
                        const whEvents = generateWorkingHoursEventsForRange(date, date);
                        if (whEvents && whEvents.length > 0) {
                            filteredEvents = whEvents;
                        }
                    } else if (currentEmployeeDataType === 'duties') {
                        // Show ONLY duties
                        const dutyEvents = generateDutiesEventsForRange(date, date);
                        if (dutyEvents && dutyEvents.length > 0) {
                            filteredEvents = dutyEvents;
                        }
                    } else {
                        // Show regular events (including task events) by default
                        filteredEvents = getFilteredEvents();
                    }
                    
                    const dayEvents = filteredEvents.filter(e => e.start && e.start.startsWith(dateStr));
                    
                    if (dayEvents.length === 0) {
                        // No events - offer to create one
                        if (confirm('No events on this date. Would you like to add an event?')) {
                            openAddEventModal({ date: dateStr });
                        }
                        return;
                    }
                    
                    const regularEvents = dayEvents.filter(e => !e.isWorkingHours);
                    const workingHoursEvents = dayEvents.filter(e => e.isWorkingHours);
                    
                    let eventsHtml = '';
                    
                    // Add "Create Event" button at the top
                    eventsHtml += `<div style="margin-bottom: 1rem;">
                        <button onclick="document.getElementById('dayEventsModal').remove(); openAddEventModal({ date: '${dateStr}' });" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-plus"></i> Add Event to This Date
                        </button>
                    </div>`;
                    
                    // Regular events
                    if (regularEvents.length > 0) {
                        eventsHtml += '<div style="margin-bottom: 1rem;"><h4 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Events</h4>';
                        regularEvents.forEach(event => {
                            const time = event.start.split('T')[1] ? event.start.split('T')[1].substring(0, 5) : '';
                            const priorityColors = { critical: '#dc2626', high: '#d97706', medium: '#ca8a04', low: '#059669' };
                            const color = priorityColors[event.priority] || priorityColors.low;
                            eventsHtml += `<div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; border-left: 4px solid ${color}; margin-bottom: 0.5rem; cursor: pointer;" onclick="document.getElementById('dayEventsModal').remove(); handleEventClick({event: ${JSON.stringify(event).replace(/"/g, '&quot;')}});">
                                <div style="font-weight: 600; color: var(--text-primary);">${event.title}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">${time}</div>
                            </div>`;
                        });
                        eventsHtml += '</div>';
                    }
                    
                    // Working hours
                    if (workingHoursEvents.length > 0) {
                        eventsHtml += '<div><h4 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Working Hours (' + workingHoursEvents.length + ' shifts)</h4>';
                        workingHoursEvents.forEach(event => {
                            const props = event.extendedProps || {};
                            const time = `${props.shiftStart || ''} - ${props.shiftEnd || ''}`;
                            const empName = event.title.replace(' â€“ Working Hours', '');
                            eventsHtml += `<div style="padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border-left: 3px solid #9ca3af; margin-bottom: 0.5rem; cursor: pointer;">
                                <div style="font-weight: 600; color: #6b7280; font-style: italic;">${empName}</div>
                                <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 0.25rem;">${time}</div>
                            </div>`;
                        });
                        eventsHtml += '</div>';
                    }
                    
                    const modalHtml = `
                        <div id="dayEventsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.75rem;">
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</h3>
                                        <p style="color: var(--text-secondary); margin: 0.25rem 0 0 0; font-size: 0.85rem;">${dayEvents.length} total items</p>
                                    </div>
                                    <button onclick="document.getElementById('dayEventsModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
                                </div>
                                ${eventsHtml}
                                <button onclick="document.getElementById('dayEventsModal').remove()" style="margin-top: 1rem; width: 100%; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Close</button>
                            </div>
                        </div>
                    `;
                    
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHtml;
                    const modalEl = modalContainer.firstElementChild;
                    
                    // Close on background click
                    modalEl.addEventListener('click', function(e) {
                        if (e.target.id === 'dayEventsModal') {
                            modalEl.remove();
                        }
                    });
                    
                    document.body.appendChild(modalEl);
                },
                
                on: function(event, callback) {
                    // Stub for compatibility
                },
                
                setOption: function(option, value) {
                    // Stub for compatibility
                }
            };
            
            calendar.render();
            
            // Navigation functions
            window.navigateCalendar = function(direction) {
                if (direction === 'prev') {
                    if (calendar.currentView === 'month') {
                        calendar.currentDate.setMonth(calendar.currentDate.getMonth() - 1);
                    } else if (calendar.currentView === 'week' || calendar.currentView === 'resourceWeek') {
                        calendar.currentDate.setDate(calendar.currentDate.getDate() - 7);
                    } else {
                        calendar.currentDate.setDate(calendar.currentDate.getDate() - 1);
                    }
                } else if (direction === 'next') {
                    if (calendar.currentView === 'month') {
                        calendar.currentDate.setMonth(calendar.currentDate.getMonth() + 1);
                    } else if (calendar.currentView === 'week' || calendar.currentView === 'resourceWeek') {
                        calendar.currentDate.setDate(calendar.currentDate.getDate() + 7);
                    } else {
                        calendar.currentDate.setDate(calendar.currentDate.getDate() + 1);
                    }
                } else if (direction === 'today') {
                    calendar.currentDate = new Date();
                }
                
                // Sync quick calendar
                if (typeof quickCalendarDate !== 'undefined') {
                    quickCalendarDate = new Date(calendar.currentDate);
                    if (typeof renderQuickCalendar === 'function') {
                        renderQuickCalendar();
                    }
                }
                
                calendar.render();
                
                // Refresh table view if active
                if (isTableView) {
                    populateTable();
                }
            };
            
            window.changeCalendarView = function(view) {
                calendar.currentView = view;
                calendar.render();
                
                // Refresh table view if active
                if (isTableView) {
                    populateTable();
                }
            };
            
            // Function to update view mode when switching between date/employee/room/provider/event
            window.updateCalendarViewMode = function(mode) {
                calendar.viewMode = mode;
                if (mode === 'date') {
                    calendar.currentView = 'month';
                } else {
                    calendar.currentView = 'resourceDay';
                }
                
                // Show/Hide employee data type dropdown based on view mode
                const dropdownContainer = document.getElementById('employeeDataTypeContainer');
                if (dropdownContainer) {
                    if (mode === 'employee' || mode === 'provider') {
                        dropdownContainer.style.display = 'inline-block';
                        
                        // Show/hide Assistants option based on view mode
                        const assistantsOption = document.getElementById('option-assistants');
                        if (assistantsOption) {
                            if (mode === 'provider') {
                                assistantsOption.style.display = 'flex';
                            } else {
                                assistantsOption.style.display = 'none';
                                // If assistants was selected in employee view, reset
                                if (currentEmployeeDataType === 'assistants') {
                                    selectEmployeeDataType('none');
                                }
                            }
                        }
                    } else {
                        dropdownContainer.style.display = 'none';
                        // Reset the data type when leaving employee/provider view
                        currentEmployeeDataType = 'none';
                        showWorkingHours = false;
                        const btn = document.getElementById('employeeDataTypeBtn');
                        if (btn) {
                            btn.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
                        }
                    }
                }
                
                calendar.render();
                updateResourceLegend(mode);
                
                // Refresh table view if active
                if (isTableView) {
                    populateTable();
                }
            };
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                // Arrow keys for navigation
                if (e.key === 'ArrowLeft' && !e.shiftKey) {
                    e.preventDefault();
                    navigateCalendar('prev');
                } else if (e.key === 'ArrowRight' && !e.shiftKey) {
                    e.preventDefault();
                    navigateCalendar('next');
                } else if (e.key === 't' || e.key === 'T') {
                    // T for today
                    e.preventDefault();
                    navigateCalendar('today');
                } else if (e.key === 'm' || e.key === 'M') {
                    // M for month view
                    e.preventDefault();
                    if (calendar.viewMode === 'date') changeCalendarView('month');
                } else if (e.key === 'w' || e.key === 'W') {
                    // W for week view
                    e.preventDefault();
                    if (calendar.viewMode === 'date') {
                        changeCalendarView('week');
                    } else {
                        changeCalendarView('resourceWeek');
                    }
                } else if (e.key === 'd' || e.key === 'D') {
                    // D for day view
                    e.preventDefault();
                    if (calendar.viewMode === 'date') {
                        changeCalendarView('day');
                    } else {
                        changeCalendarView('resourceDay');
                    }
                } else if (e.key === 'n' || e.key === 'N') {
                    // N for new event
                    e.preventDefault();
                    if (window.openEventModal) openEventModal();
                } else if (e.key === '?' && e.shiftKey) {
                    // ? for help
                    e.preventDefault();
                    showCalendarHelp();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    // Ctrl+F for search
                    e.preventDefault();
                    toggleCalendarSearch();
                }
            });
            
            // Calendar search functionality
            let calendarSearchVisible = false;
            
            window.toggleCalendarSearch = function() {
                const existingSearch = document.querySelector('.calendar-search-box');
                if (existingSearch) {
                    existingSearch.remove();
                    calendarSearchVisible = false;
                    // Clear highlights
                    document.querySelectorAll('.calendar-event.search-highlight').forEach(el => {
                        el.classList.remove('search-highlight');
                    });
                    return;
                }
                
                calendarSearchVisible = true;
                const searchBox = document.createElement('div');
                searchBox.className = 'calendar-search-box';
                searchBox.style.cssText = `
                    position: absolute;
                    top: 70px;
                    right: 20px;
                    background: var(--card-bg);
                    border: 2px solid var(--accent-primary);
                    border-radius: 8px;
                    padding: 1rem;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 100;
                    min-width: 300px;
                    animation: slideInDown 0.2s ease-out;
                `;
                
                searchBox.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-search" style="color: var(--accent-primary);"></i>
                        <input type="text" id="calendarSearchInput" placeholder="Search events..." 
                               style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                        <button onclick="toggleCalendarSearch()" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 1.2rem;">&times;</button>
                    </div>
                    <div id="searchResults" style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;"></div>
                `;
                
                document.querySelector('.custom-calendar').appendChild(searchBox);
                
                const input = document.getElementById('calendarSearchInput');
                input.focus();
                
                input.oninput = function() {
                    const query = this.value.toLowerCase();
                    const resultDiv = document.getElementById('searchResults');
                    
                    // Clear previous highlights
                    document.querySelectorAll('.calendar-event.search-highlight').forEach(el => {
                        el.classList.remove('search-highlight');
                    });
                    
                    if (!query) {
                        resultDiv.textContent = '';
                        return;
                    }
                    
                    // Search events
                    const allEvents = document.querySelectorAll('.calendar-event');
                    let matches = 0;
                    
                    allEvents.forEach(el => {
                        const text = el.textContent.toLowerCase();
                        if (text.includes(query)) {
                            el.classList.add('search-highlight');
                            matches++;
                        }
                    });
                    
                    resultDiv.textContent = matches > 0 ? `Found ${matches} match${matches !== 1 ? 'es' : ''}` : 'No matches found';
                };
            };
            
            // Add search highlight CSS dynamically
            const searchStyle = document.createElement('style');
            searchStyle.textContent = `
                .calendar-event.search-highlight {
                    box-shadow: 0 0 0 3px var(--accent-primary) !important;
                    animation: pulse 1s infinite;
                }
                
                @keyframes pulse {
                    0%, 100% { box-shadow: 0 0 0 3px var(--accent-primary); }
                    50% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.4); }
                }
                
                @keyframes slideInDown {
                    from {
                        opacity: 0;
                        transform: translateY(-10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(searchStyle);
            
            // Calendar help modal
            window.showCalendarHelp = function() {
                const helpModal = document.createElement('div');
                helpModal.className = 'calendar-help-modal';
                helpModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.2s ease-out;
                `;
                
                const helpContent = document.createElement('div');
                helpContent.style.cssText = `
                    background: var(--card-bg);
                    border-radius: 12px;
                    padding: 2rem;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                `;
                
                helpContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: var(--text-primary);"><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
                        <button onclick="this.closest('.calendar-help-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
                    </div>
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>â†  â†’</kbd>
                            <span style="color: var(--text-primary);">Navigate previous/next period</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>T</kbd>
                            <span style="color: var(--text-primary);">Jump to today</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>M</kbd>
                            <span style="color: var(--text-primary);">Switch to month view</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>W</kbd>
                            <span style="color: var(--text-primary);">Switch to week view</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>D</kbd>
                            <span style="color: var(--text-primary);">Switch to day view</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>N</kbd>
                            <span style="color: var(--text-primary);">Create new event</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 1rem; align-items: center;">
                            <kbd>?</kbd>
                            <span style="color: var(--text-primary);">Show this help</span>
                        </div>
                    </div>
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.95rem;">Mouse Actions</h3>
                        <div style="display: grid; gap: 0.75rem; font-size: 0.9rem;">
                            <div style="color: var(--text-primary);"><strong>Click empty slot:</strong> Create new event</div>
                            <div style="color: var(--text-primary);"><strong>Click event:</strong> Edit event</div>
                            <div style="color: var(--text-primary);"><strong>Drag event:</strong> Move to different time/date</div>
                            <div style="color: var(--text-primary);"><strong>Right-click event:</strong> Quick actions menu</div>
                        </div>
                    </div>
                `;
                
                helpModal.appendChild(helpContent);
                document.body.appendChild(helpModal);
                
                helpModal.onclick = (e) => {
                    if (e.target === helpModal) helpModal.remove();
                };
            };

            // Update resource legend for employee/room views
            setTimeout(() => {
                updateResourceLegend(currentViewMode);
                
                // Initialize dropdown visibility based on current view mode
                const dropdownContainer = document.getElementById('employeeDataTypeContainer');
                console.log('Initializing dropdown visibility - currentViewMode:', currentViewMode);
                console.log('Dropdown container element:', dropdownContainer);
                if (dropdownContainer) {
                    if (currentViewMode === 'employee' || currentViewMode === 'provider') {
                        dropdownContainer.style.display = 'inline-block';
                        console.log('Dropdown container set to visible');
                    } else {
                        console.log('Not in employee/provider view, keeping dropdown hidden');
                    }
                } else {
                    console.error('Dropdown container not found!');
                }
            }, 200);
        }

        // Navigation Section Toggle & Dashboard Section Toggle

        // Navigate to date from small calendar widget
        
        // Quick Calendar State
        let quickCalendarDate = new Date(2025, 10, 16); // November 16, 2025
        let quickCalendarOpen = false;

        // Toggle Quick Calendar Dropdown
        function toggleQuickCalendar() {
            quickCalendarOpen = !quickCalendarOpen;
            
            // Find the dropdown and chevron in the active view
            const activeView = document.querySelector('.content-view.active');
            const dropdown = activeView ? activeView.querySelector('.quick-calendar-dropdown') : document.getElementById('quickCalendarDropdown');
            const chevron = activeView ? activeView.querySelector('#quickCalendarChevron') : document.getElementById('quickCalendarChevron');
            
            if (dropdown) {
                if (quickCalendarOpen) {
                    dropdown.classList.add('active');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                } else {
                    dropdown.classList.remove('active');
                    if (chevron) chevron.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const activeView = document.querySelector('.content-view.active');
            const dropdown = activeView ? activeView.querySelector('.quick-calendar-dropdown') : null;
            const button = dropdown?.previousElementSibling;
            
            if (quickCalendarOpen && dropdown && button && 
                !dropdown.contains(e.target) && !button.contains(e.target)) {
                toggleQuickCalendar();
            }
        });

        // Initialize Quick Calendar
        function initQuickCalendar() {
            renderQuickCalendar();
        }

        // Render Quick Calendar
        function renderQuickCalendar() {
            const year = quickCalendarDate.getFullYear();
            const month = quickCalendarDate.getMonth();
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const monthYearText = `${monthNames[month]} ${year}`;
            
            // Find elements in active view or use fallback
            const activeView = document.querySelector('.content-view.active');
            const monthDisplay = activeView ? activeView.querySelector('#quickCalendarMonth') : document.getElementById('quickCalendarMonth');
            if (monthDisplay) {
                monthDisplay.textContent = monthYearText;
            }
            
            // Update button text if it exists
            const buttonDate = activeView ? activeView.querySelector('#quickCalendarButtonDate') : document.getElementById('quickCalendarButtonDate');
            if (buttonDate) {
                buttonDate.textContent = monthYearText;
            }
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            // Clear existing days (keep day headers)
            const grid = activeView ? activeView.querySelector('#quickCalendarGrid') : document.getElementById('quickCalendarGrid');
            if (!grid) return;
            
            // Get existing day headers before clearing
            const existingHeaders = Array.from(grid.querySelectorAll(':scope > div:nth-child(-n+7)'));
            
            // Clear the grid
            grid.innerHTML = '';
            
            // Re-add day headers if they exist, otherwise create them
            if (existingHeaders.length === 7) {
                existingHeaders.forEach(header => grid.appendChild(header.cloneNode(true)));
            } else {
                // Create day headers
                const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                dayNames.forEach(dayName => {
                    const headerEl = document.createElement('div');
                    headerEl.style.cssText = 'font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;';
                    headerEl.textContent = dayName;
                    grid.appendChild(headerEl);
                });
            }
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = isCurrentMonth ? today.getDate() : -1;
            
            // Add days from previous month
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayEl = document.createElement('div');
                dayEl.style.cssText = 'padding: 0.4rem; color: var(--text-secondary); opacity: 0.4; font-size: 0.8rem; text-align: center;';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
            
            // Add days of current month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const isToday = day === todayDate;
                
                dayEl.style.cssText = `
                    padding: 0.4rem;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.2s;
                    font-size: 0.8rem;
                    font-weight: 500;
                    text-align: center;
                    color: ${isToday ? 'white' : '#2d3748'};
                    ${isToday ? 'background: var(--accent-primary); font-weight: 600;' : ''}
                `;
                
                dayEl.textContent = day;
                dayEl.onmouseover = function() {
                    if (!isToday) this.style.background = 'var(--accent-light)';
                };
                dayEl.onmouseout = function() {
                    if (!isToday) this.style.background = 'transparent';
                };
                dayEl.onclick = function(e) {
                    e.stopPropagation(); // Prevent closing the dropdown
                    quickCalendarDate = new Date(year, month, day);
                    
                    // Sync main calendar
                    if (window.calendarInstance) {
                        window.calendarInstance.currentDate = new Date(quickCalendarDate);
                        window.calendarInstance.render();
                    }
                    
                    // Sync My Schedule calendar if it exists
                    if (typeof window.myScheduleGoToDate === 'function') {
                        window.myScheduleGoToDate(quickCalendarDate);
                    }
                    
                    renderQuickCalendar();
                    
                    // Refresh table view if active
                    if (typeof isTableView !== 'undefined' && isTableView && typeof populateTable === 'function') {
                        populateTable();
                    }
                };
                
                grid.appendChild(dayEl);
            }
            
            // Add days from next month
            const totalCells = grid.children.length - 7; // Subtract day headers
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = document.createElement('div');
                dayEl.style.cssText = 'padding: 0.4rem; color: var(--text-secondary); opacity: 0.4; font-size: 0.8rem; text-align: center;';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
        }

        // Previous Month
        function quickCalendarPrevMonth() {
            quickCalendarDate.setMonth(quickCalendarDate.getMonth() - 1);
            
            // Sync main calendar
            if (window.calendarInstance) {
                window.calendarInstance.currentDate = new Date(quickCalendarDate);
                window.calendarInstance.render();
            }
            
            renderQuickCalendar();
            
            // Refresh table view if active
            if (typeof isTableView !== 'undefined' && isTableView && typeof populateTable === 'function') {
                populateTable();
            }
        }

        // Next Month
        function quickCalendarNextMonth() {
            quickCalendarDate.setMonth(quickCalendarDate.getMonth() + 1);
            
            // Sync main calendar
            if (window.calendarInstance) {
                window.calendarInstance.currentDate = new Date(quickCalendarDate);
                window.calendarInstance.render();
            }
            
            renderQuickCalendar();
            
            // Refresh table view if active
            if (typeof isTableView !== 'undefined' && isTableView && typeof populateTable === 'function') {
                populateTable();
            }
        }
        
                // Jump quick calendar to today
                function quickCalendarToday() {
                    const today = new Date();
                    quickCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    renderQuickCalendar();
                    // If main calendar exists, navigate it to today as well
                    try {
                        if (calendar && typeof calendar.gotoDate === 'function') {
                            calendar.gotoDate(today);
                            showNotification('Calendar jumped to today', 'info');
                        }
                    } catch (e) {
                        console.error('Error navigating calendar to today:', e);
                    }
                }
        
        // Navigate to date from small calendar widget (original function)
        function goToCalendarDate(day) {
            console.log('=== goToCalendarDate called with day:', day);
            
            // Check if calendar exists
            if (typeof calendar === 'undefined') {
                console.error('âŒ Calendar is UNDEFINED! Retrying...');
                setTimeout(function() {
                    goToCalendarDate(day);
                }, 1000);
                return;
            }
            
            if (!calendar) {
                console.error('âŒ Calendar is NULL or FALSE! Retrying...');
                setTimeout(function() {
                    goToCalendarDate(day);
                }, 1000);
                return;
            }
            
            try {
                // Use the quick calendar's month and year
                const year = quickCalendarDate.getFullYear();
                const month = quickCalendarDate.getMonth();
                const date = new Date(year, month, day);
                
                console.log('âœ“ Date created:', date);
                console.log('âœ“ Calendar object exists:', typeof calendar);
                console.log('âœ“ Calendar has gotoDate:', typeof calendar.gotoDate);
                
                console.log('â†’ Attempting to navigate to:', date.toDateString());
                
                const result = calendar.gotoDate(date);
                
                console.log('âœ“ Navigation result:', result);
                console.log('âœ… Navigation successful!');
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                showNotification(`Calendar jumped to ${monthNames[month]} ${day}, ${year}`, 'info');
            } catch(error) {
                console.error('âŒ ERROR navigating calendar:');
                console.error('Error message:', error.message);
                console.error('Error:', error);
                console.error('Full stack:', error.stack);
            }
        }

        function initializeNavToggle() {
            // Handle Navigation Sections
            const navSections = document.querySelectorAll('.nav-section');
            
            navSections.forEach(section => {
                const navTitle = section.querySelector('.nav-title');
                
                if (navTitle) {
                    navTitle.addEventListener('click', function(e) {
                        e.preventDefault();
                        section.classList.toggle('collapsed');
                    });
                }
            });

            // Handle Dashboard Sections
            const dashboardSections = document.querySelectorAll('.dashboard-section');
            
            dashboardSections.forEach(section => {
                const header = section.querySelector('.dashboard-section-header');
                
                if (header) {
                    header.addEventListener('click', function(e) {
                        e.preventDefault();
                        section.classList.toggle('collapsed');
                    });
                }
            });
        }

        // Content View Toggle (Calendar vs Duties)
        function switchContentView(viewName, event) {
            if (event) {
                event.preventDefault();
            }
            
            try {
                // Close all management modals first
                closeAllManagementModals();
                
                // Hide task management sidebar and new task button when switching views
                // (they only appear when using "Manage Tasks" from settings menu)
                const managementSidebar = document.getElementById('taskManagementSidebar');
                const newTaskBtn = document.getElementById('newTaskBtn');
                if (managementSidebar) managementSidebar.classList.add('hidden');
                if (newTaskBtn) newTaskBtn.style.display = 'none';
                
                // Hide all content views
                const views = document.querySelectorAll('.content-view');
                views.forEach(view => view.classList.remove('active'));
                
                // Show selected view
                const selectedView = document.getElementById('view-' + viewName);
                if (selectedView) {
                    selectedView.classList.add('active');

                    // Ensure new view is scrolled into the top of the main content
                    const mainContent = document.querySelector('.main-content');
                    try {
                        if (mainContent) mainContent.scrollTop = 0;
                        // Also scroll the selected view into view for smaller screens
                        selectedView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } catch (e) {
                        // ignore scroll errors on older browsers
                    }
                }

                // Update active nav items
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                if (event && event.target.closest('.nav-item')) {
                    event.target.closest('.nav-item').classList.add('active');
                }

                // Populate duties if switching to duties view
                if (viewName === 'duties') {
                    const dutiesArea = document.getElementById('dutiesContentArea');
                    if (dutiesArea && !dutiesArea.hasAttribute('data-populated')) {
                        dutiesArea.setAttribute('data-populated', 'true');
                        const dutyList = document.querySelector('.duty-list');
                        if (dutyList) {
                            // Clone the duty list to avoid duplicate IDs
                            dutiesArea.innerHTML = dutyList.innerHTML;
                        }
                    }
                }

                // If switching to calendar, make sure the calendar section is visible
                if (viewName === 'calendar') {
                    try {
                        const calSection = document.getElementById('calendarSection') || document.querySelector('.calendar-section');
                        if (calSection) calSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Give FullCalendar a moment to resize correctly
                        if (window.calendar && typeof calendar.updateSize === 'function') {
                            setTimeout(() => calendar.updateSize(), 250);
                        }
                        // Also refresh the event list preview on the right
                        updateEventList();
                    } catch (e) {
                        console.error('Error adjusting scroll for calendar view:', e);
                    }
                }

                // Render Quick Calendar for the active view
                setTimeout(() => {
                    renderQuickCalendar();
                }, 100);

                // Ensure sidebar is visible for schedule view
                if (viewName === 'schedule') {
                    setTimeout(() => {
                        const sidebar = selectedView ? selectedView.querySelector('.sidebar-right') : null;
                        if (sidebar && sidebar.classList.contains('hidden')) {
                            sidebar.classList.remove('hidden');
                        }
                    }, 50);
                }

            } catch (error) {
                console.error('Error switching content view:', error);
            }
        }

        // Sticky Notes Board Functions
        let stickyNotes = [];
        let stickySelectedColor = 'yellow';
        let stickyDraggedNote = null;
        let stickyOffsetX = 0;
        let stickyOffsetY = 0;
        let stickyResizingNote = null;
        let stickyResizeStartX = 0;
        let stickyResizeStartY = 0;
        let stickyResizeStartWidth = 0;
        let stickyResizeStartHeight = 0;

        function initStickyNotesBoard() {
            const board = document.getElementById('stickyBoard');
            const clearBtn = document.getElementById('stickyClearBtn');
            const printBtn = document.getElementById('stickyPrintBtn');
            const pdfBtn = document.getElementById('stickySaveBtn');
            const colorOptions = document.querySelectorAll('.sticky-color-option');

            if (!board) return;

            // Color drag and drop
            colorOptions.forEach(option => {
                option.draggable = true;
                
                option.addEventListener('dragstart', (e) => {
                    const color = option.dataset.color;
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('text/plain', color);
                    option.style.opacity = '0.6';
                });
                
                option.addEventListener('dragend', (e) => {
                    option.style.opacity = '1';
                });
            });

            // Board drop handler
            board.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                board.style.backgroundColor = 'rgba(0, 0, 0, 0.02)';
            });

            board.addEventListener('dragleave', (e) => {
                if (e.target === board) {
                    board.style.backgroundColor = 'white';
                }
            });

            board.addEventListener('drop', (e) => {
                e.preventDefault();
                board.style.backgroundColor = 'white';
                
                const color = e.dataTransfer.getData('text/plain');
                if (color) {
                    const rect = board.getBoundingClientRect();
                    const x = e.clientX - rect.left - 110; // Center the note
                    const y = e.clientY - rect.top - 80;
                    createStickyNote('', Math.max(0, x), Math.max(0, y), color);
                }
            });

            // Clear all button
            clearBtn.addEventListener('click', () => {
                if (stickyNotes.length > 0 && confirm('Are you sure you want to delete all notes?')) {
                    stickyNotes.forEach(note => note.element.remove());
                    stickyNotes = [];
                    updateStickyStats();
                    saveStickyNotes();
                }
            });

            // Print button
            if (printBtn) {
                printBtn.addEventListener('click', printStickyNotes);
            }

            // Save PDF button
            if (pdfBtn) {
                pdfBtn.addEventListener('click', saveStickyNotesAsPDF);
            }

            // Load saved notes and recycle bin
            loadStickyNotes();
            loadStickyRecycleBin();
        }

        function createStickyNote(text = '', x = null, y = null, color = null) {
            const board = document.getElementById('stickyBoard');
            if (!board) return;

            const noteDiv = document.createElement('div');
            const noteId = Date.now() + Math.random();
            const noteColor = color || stickySelectedColor;

            // Random position if not specified
            if (x === null) {
                x = Math.random() * (board.offsetWidth - 220);
                y = Math.random() * (board.offsetHeight - 150);
                x = Math.max(0, Math.min(x, board.offsetWidth - 220));
                y = Math.max(0, Math.min(y, board.offsetHeight - 150));
            }

            noteDiv.className = `sticky-note-item ${noteColor}`;
            noteDiv.id = `stickynote-${noteId}`;
            noteDiv.style.left = x + 'px';
            noteDiv.style.top = y + 'px';

            const now = new Date();
            const dateStr = now.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateTimeStr = `${dateStr}\n${timeStr}`;

            noteDiv.innerHTML = `
                <div class="sticky-note-header-item">
                    <span class="sticky-note-time-item">${dateTimeStr}</span>
                    <button class="sticky-note-close-item">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <textarea class="sticky-note-content-item" placeholder="Write something..."></textarea>
                <div class="sticky-note-resize-handle"></div>
            `;

            board.appendChild(noteDiv);

            const textarea = noteDiv.querySelector('.sticky-note-content-item');
            const closeBtn = noteDiv.querySelector('.sticky-note-close-item');
            const resizeHandle = noteDiv.querySelector('.sticky-note-resize-handle');

            if (text) {
                textarea.value = text;
            }

            // Make draggable
            noteDiv.addEventListener('mousedown', startStickyDrag);

            // Add resize functionality
            resizeHandle.addEventListener('mousedown', (e) => startStickyResize(e, noteDiv));

            // Close note
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteStickyNote(noteId);
            });

            // Auto-save on change
            textarea.addEventListener('change', saveStickyNotes);

            const noteObj = {
                id: noteId,
                element: noteDiv,
                text: text,
                x: x,
                y: y,
                color: noteColor
            };

            stickyNotes.push(noteObj);
            updateStickyStats();
            saveStickyNotes();

            return noteObj;
        }

        function startStickyDrag(e) {
            if (e.target.closest('.sticky-note-content-item') || e.target.closest('.sticky-note-close-item') || e.target.closest('.sticky-note-resize-handle')) {
                return;
            }

            stickyDraggedNote = e.currentTarget;
            stickyDraggedNote.classList.add('dragging');

            const rect = stickyDraggedNote.getBoundingClientRect();
            const board = document.getElementById('stickyBoard');
            const boardRect = board.getBoundingClientRect();

            stickyOffsetX = e.clientX - rect.left;
            stickyOffsetY = e.clientY - rect.top;

            document.addEventListener('mousemove', stickydrag);
            document.addEventListener('mouseup', stopStickyDrag);
        }

        function stickydrag(e) {
            if (!stickyDraggedNote) return;

            const board = document.getElementById('stickyBoard');
            const boardRect = board.getBoundingClientRect();
            
            let x = e.clientX - boardRect.left - stickyOffsetX;
            let y = e.clientY - boardRect.top - stickyOffsetY;

            x = Math.max(0, Math.min(x, board.offsetWidth - stickyDraggedNote.offsetWidth));
            y = Math.max(0, Math.min(y, board.offsetHeight - stickyDraggedNote.offsetHeight));

            stickyDraggedNote.style.left = x + 'px';
            stickyDraggedNote.style.top = y + 'px';
        }

        function stopStickyDrag() {
            if (stickyDraggedNote) {
                stickyDraggedNote.classList.remove('dragging');

                const noteId = parseInt(stickyDraggedNote.id.replace('stickynote-', ''));
                const note = stickyNotes.find(n => n.id === noteId);
                if (note) {
                    note.x = parseInt(stickyDraggedNote.style.left);
                    note.y = parseInt(stickyDraggedNote.style.top);
                    note.text = stickyDraggedNote.querySelector('.sticky-note-content-item').value;
                }

                saveStickyNotes();
                stickyDraggedNote = null;
            }

            document.removeEventListener('mousemove', stickydrag);
            document.removeEventListener('mouseup', stopStickyDrag);
        }

        function startStickyResize(e, noteElement) {
            e.preventDefault();
            e.stopPropagation();
            
            stickyResizingNote = noteElement;
            stickyResizeStartX = e.clientX;
            stickyResizeStartY = e.clientY;
            stickyResizeStartWidth = noteElement.offsetWidth;
            stickyResizeStartHeight = noteElement.offsetHeight;

            document.addEventListener('mousemove', stickydragResize);
            document.addEventListener('mouseup', stopStickyResize);
        }

        function stickydragResize(e) {
            if (!stickyResizingNote) return;

            const deltaX = e.clientX - stickyResizeStartX;
            const deltaY = e.clientY - stickyResizeStartY;

            let newWidth = stickyResizeStartWidth + deltaX;
            let newHeight = stickyResizeStartHeight + deltaY;

            // Minimum size constraints
            newWidth = Math.max(180, newWidth);
            newHeight = Math.max(160, newHeight);

            stickyResizingNote.style.width = newWidth + 'px';
            stickyResizingNote.style.height = newHeight + 'px';
        }

        function stopStickyResize() {
            if (stickyResizingNote) {
                const noteId = parseInt(stickyResizingNote.id.replace('stickynote-', ''));
                const note = stickyNotes.find(n => n.id === noteId);
                if (note) {
                    note.text = stickyResizingNote.querySelector('.sticky-note-content-item').value;
                }
                saveStickyNotes();
                stickyResizingNote = null;
            }

            document.removeEventListener('mousemove', stickydragResize);
            document.removeEventListener('mouseup', stopStickyResize);
        }

        // Search Sticky Notes
        window.searchStickyNotes = function(query) {
            const searchInput = document.getElementById('stickySearchInput');
            const clearBtn = document.getElementById('stickySearchClear');
            const resultsDiv = document.getElementById('stickySearchResults');
            const countSpan = document.getElementById('stickySearchCount');
            
            // Show/hide clear button
            if (clearBtn) {
                clearBtn.style.display = query.length > 0 ? 'block' : 'none';
            }
            
            if (!query.trim()) {
                // Reset all notes to visible
                stickyNotes.forEach(note => {
                    note.element.style.opacity = '1';
                    note.element.style.transform = 'scale(1)';
                    note.element.style.pointerEvents = 'auto';
                    note.element.classList.remove('sticky-search-highlight');
                });
                if (resultsDiv) resultsDiv.style.display = 'none';
                return;
            }
            
            const searchLower = query.toLowerCase();
            let matchCount = 0;
            
            stickyNotes.forEach(note => {
                const textarea = note.element.querySelector('.sticky-note-content-item');
                const noteText = textarea ? textarea.value.toLowerCase() : '';
                
                if (noteText.includes(searchLower)) {
                    // Match found - highlight and bring to front
                    note.element.style.opacity = '1';
                    note.element.style.transform = 'scale(1.02)';
                    note.element.style.pointerEvents = 'auto';
                    note.element.classList.add('sticky-search-highlight');
                    note.element.style.zIndex = '100';
                    matchCount++;
                } else {
                    // No match - dim
                    note.element.style.opacity = '0.3';
                    note.element.style.transform = 'scale(0.98)';
                    note.element.style.pointerEvents = 'none';
                    note.element.classList.remove('sticky-search-highlight');
                    note.element.style.zIndex = '1';
                }
            });
            
            // Show results count
            if (resultsDiv && countSpan) {
                resultsDiv.style.display = 'block';
                countSpan.textContent = matchCount;
            }
        };
        
        // Clear search
        window.clearStickySearch = function() {
            const searchInput = document.getElementById('stickySearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchStickyNotes('');
                searchInput.focus();
            }
        };

        // Recycle Bin for deleted sticky notes
        let stickyRecycleBin = [];
        
        // Load recycle bin from localStorage
        function loadStickyRecycleBin() {
            const saved = localStorage.getItem('reformdentalStickyRecycleBin');
            if (saved) {
                try {
                    stickyRecycleBin = JSON.parse(saved);
                    updateRecycleBinCount();
                } catch (e) {
                    stickyRecycleBin = [];
                }
            }
        }
        
        // Save recycle bin to localStorage
        function saveStickyRecycleBin() {
            localStorage.setItem('reformdentalStickyRecycleBin', JSON.stringify(stickyRecycleBin));
            updateRecycleBinCount();
        }
        
        // Update recycle bin badge count
        function updateRecycleBinCount() {
            const badge = document.getElementById('stickyRecycleBinCount');
            if (badge) {
                if (stickyRecycleBin.length > 0) {
                    badge.textContent = stickyRecycleBin.length;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // Create shredding animation
        function createShredAnimation(element) {
            const rect = element.getBoundingClientRect();
            const board = document.getElementById('stickyBoard');
            const boardRect = board.getBoundingClientRect();
            
            // Create shred strips
            const numStrips = 8;
            const stripWidth = rect.width / numStrips;
            
            for (let i = 0; i < numStrips; i++) {
                const strip = document.createElement('div');
                strip.className = 'shred-strip';
                strip.style.cssText = `
                    position: absolute;
                    left: ${rect.left - boardRect.left + (i * stripWidth)}px;
                    top: ${rect.top - boardRect.top}px;
                    width: ${stripWidth}px;
                    height: ${rect.height}px;
                    background: ${getComputedStyle(element).background};
                    border-radius: 2px;
                    --rotate: ${(Math.random() - 0.5) * 30}deg;
                    animation: shredStrip 0.8s ease-in forwards;
                    animation-delay: ${i * 0.05}s;
                    z-index: 1000;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                `;
                board.appendChild(strip);
                
                // Remove strip after animation
                setTimeout(() => strip.remove(), 1000 + (i * 50));
            }
        }
        
        // Play shredding sound effect (optional visual feedback)
        function playShredEffect(element) {
            // Add shake before shred
            element.style.animation = 'none';
            element.offsetHeight; // Trigger reflow
            element.style.transition = 'transform 0.1s';
            
            let shakeCount = 0;
            const shakeInterval = setInterval(() => {
                element.style.transform = `rotate(${(Math.random() - 0.5) * 5}deg) scale(${1 - shakeCount * 0.02})`;
                shakeCount++;
                if (shakeCount > 5) {
                    clearInterval(shakeInterval);
                    // Start shredding
                    createShredAnimation(element);
                    element.classList.add('sticky-shredding');
                }
            }, 50);
        }

        function deleteStickyNote(noteId) {
            const note = stickyNotes.find(n => n.id === noteId);
            if (note) {
                // Get note data before deleting
                const textarea = note.element.querySelector('.sticky-note-content-item');
                const noteData = {
                    id: note.id,
                    text: textarea ? textarea.value : '',
                    x: parseInt(note.element.style.left),
                    y: parseInt(note.element.style.top),
                    color: note.color,
                    deletedAt: new Date().toISOString()
                };
                
                // Add to recycle bin
                stickyRecycleBin.unshift(noteData);
                // Keep only last 20 deleted notes
                if (stickyRecycleBin.length > 20) {
                    stickyRecycleBin = stickyRecycleBin.slice(0, 20);
                }
                saveStickyRecycleBin();
                
                // Play shredding animation
                playShredEffect(note.element);
                
                // Remove after animation
                setTimeout(() => {
                    note.element.remove();
                    stickyNotes = stickyNotes.filter(n => n.id !== noteId);
                    updateStickyStats();
                    saveStickyNotes();
                }, 600);
            }
        }
        
        // Open Recycle Bin Modal
        window.openStickyRecycleBin = function() {
            let itemsHtml = '';
            
            if (stickyRecycleBin.length === 0) {
                itemsHtml = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-recycle" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Recycle bin is empty</p>
                        <p style="font-size: 0.8rem;">Deleted notes will appear here</p>
                    </div>
                `;
            } else {
                stickyRecycleBin.forEach((note, index) => {
                    const deletedDate = new Date(note.deletedAt);
                    const timeAgo = getTimeAgo(deletedDate);
                    const previewText = note.text.substring(0, 50) + (note.text.length > 50 ? '...' : '') || '(empty note)';
                    const colorMap = {
                        'yellow': '#FFF59D',
                        'pink': '#F48FB1',
                        'blue': '#81D4FA',
                        'green': '#A5D6A7',
                        'purple': '#CE93D8',
                        'orange': '#FFB74D'
                    };
                    const bgColor = colorMap[note.color] || '#FFF59D';
                    
                    itemsHtml += `
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${bgColor};">
                            <div style="width: 40px; height: 40px; background: ${bgColor}; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-sticky-note" style="color: rgba(0,0,0,0.4);"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${previewText}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Deleted ${timeAgo}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="restoreStickyNote(${index})" style="padding: 0.4rem 0.6rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Restore">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button onclick="permanentlyDeleteStickyNote(${index})" style="padding: 0.4rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Delete Forever">
                                    <i class="fas fa-fire"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            const modalHtml = `
                <div id="stickyRecycleBinModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 450px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 80vh; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-recycle" style="color: #6b7280;"></i>
                                Recycle Bin
                                <span style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 400;">(${stickyRecycleBin.length} items)</span>
                            </h3>
                            <button onclick="document.getElementById('stickyRecycleBinModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <div style="flex: 1; overflow-y: auto; margin-bottom: 1rem;">
                            ${itemsHtml}
                        </div>
                        
                        ${stickyRecycleBin.length > 0 ? `
                        <div style="display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <button onclick="restoreAllStickyNotes()" style="flex: 1; padding: 0.6rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                <i class="fas fa-undo"></i> Restore All
                            </button>
                            <button onclick="emptyRecycleBin()" style="flex: 1; padding: 0.6rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                <i class="fas fa-fire"></i> Empty Bin
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };
        
        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }
        
        // Restore a single note
        window.restoreStickyNote = function(index) {
            const noteData = stickyRecycleBin[index];
            if (noteData) {
                createStickyNote(noteData.text, noteData.x, noteData.y, noteData.color);
                stickyRecycleBin.splice(index, 1);
                saveStickyRecycleBin();
                document.getElementById('stickyRecycleBinModal').remove();
                openStickyRecycleBin(); // Refresh modal
            }
        };
        
        // Permanently delete a note
        window.permanentlyDeleteStickyNote = function(index) {
            stickyRecycleBin.splice(index, 1);
            saveStickyRecycleBin();
            document.getElementById('stickyRecycleBinModal').remove();
            openStickyRecycleBin(); // Refresh modal
        };
        
        // Restore all notes
        window.restoreAllStickyNotes = function() {
            stickyRecycleBin.forEach(noteData => {
                createStickyNote(noteData.text, noteData.x, noteData.y, noteData.color);
            });
            stickyRecycleBin = [];
            saveStickyRecycleBin();
            document.getElementById('stickyRecycleBinModal').remove();
        };
        
        // Empty recycle bin
        window.emptyRecycleBin = function() {
            if (confirm('Permanently delete all notes in the recycle bin? This cannot be undone!')) {
                stickyRecycleBin = [];
                saveStickyRecycleBin();
                document.getElementById('stickyRecycleBinModal').remove();
            }
        };

        function updateStickyStats() {
            const totalDisplay = document.getElementById('stickytotalNotes');
            if (totalDisplay) {
                totalDisplay.textContent = stickyNotes.length;
            }
        }

        function saveStickyNotes() {
            const notesData = stickyNotes.map(note => ({
                id: note.id,
                text: note.element.querySelector('.sticky-note-content-item').value,
                x: parseInt(note.element.style.left),
                y: parseInt(note.element.style.top),
                color: note.color
            }));

            localStorage.setItem('reformdentalStickyNotes', JSON.stringify(notesData));
        }

        function loadStickyNotes() {
            const saved = localStorage.getItem('reformdentalStickyNotes');
            if (saved) {
                try {
                    const notesData = JSON.parse(saved);
                    notesData.forEach(noteData => {
                        createStickyNote(noteData.text, noteData.x, noteData.y, noteData.color);
                    });
                } catch (e) {
                    console.error('Error loading sticky notes:', e);
                }
            }
        }

        function printStickyNotes() {
            const board = document.getElementById('stickyBoard');
            const printWindow = window.open('', '_blank');
            
            const headerHTML = `
                <html>
                <head>
                    <title>Sticky Notes - ReformDental</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            background: white;
                        }
                        h1 {
                            text-align: center;
                            color: #333;
                            margin-bottom: 10px;
                            font-size: 28px;
                        }
                        .print-date {
                            text-align: center;
                            color: #999;
                            margin-bottom: 30px;
                            font-size: 12px;
                        }
                        .sticky-note-print {
                            display: inline-block;
                            width: 180px;
                            min-height: 150px;
                            padding: 15px;
                            margin: 10px;
                            border-radius: 8px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            page-break-inside: avoid;
                            border: 1px solid rgba(0, 0, 0, 0.1);
                            vertical-align: top;
                        }
                        .sticky-note-print.yellow { background: #FFF59D; }
                        .sticky-note-print.pink { background: #F48FB1; color: white; }
                        .sticky-note-print.blue { background: #81D4FA; }
                        .sticky-note-print.green { background: #A5D6A7; }
                        .sticky-note-print.purple { background: #CE93D8; color: white; }
                        .sticky-note-print.orange { background: #FFB74D; }
                        
                        .note-header {
                            font-size: 10px;
                            margin-bottom: 8px;
                            padding-bottom: 8px;
                            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                        }
                        .note-content {
                            font-size: 12px;
                            line-height: 1.4;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <h1>ðŸ“Œ Sticky Notes Board</h1>
                    <div class="print-date">Printed on: ${new Date().toLocaleString()}</div>
            `;
            
            let notesHTML = '';
            stickyNotes.forEach(note => {
                const content = note.element.querySelector('.sticky-note-content-item').value;
                const timeElement = note.element.querySelector('.sticky-note-time-item');
                const time = timeElement ? timeElement.textContent : 'No date';
                notesHTML += `
                    <div class="sticky-note-print ${note.color}">
                        <div class="note-header">${time}</div>
                        <div class="note-content">${content || '(empty note)'}</div>
                    </div>
                `;
            });
            
            const closingHTML = `
                </body>
                </html>
            `;
            
            printWindow.document.write(headerHTML + notesHTML + closingHTML);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function saveStickyNotesAsPDF() {
            const board = document.getElementById('stickyBoard');
            
            if (stickyNotes.length === 0) {
                alert('No notes to save!');
                return;
            }
            
            // Create a container for PDF content
            const pdfContent = document.createElement('div');
            pdfContent.style.padding = '20px';
            pdfContent.style.backgroundColor = '#f5f5f5';
            
            // Add title
            const title = document.createElement('h1');
            title.textContent = 'ðŸ“Œ Sticky Notes Board';
            title.style.textAlign = 'center';
            title.style.marginBottom = '10px';
            title.style.color = '#333';
            pdfContent.appendChild(title);
            
            // Add date
            const dateInfo = document.createElement('div');
            dateInfo.textContent = `Generated on: ${new Date().toLocaleString()}`;
            dateInfo.style.textAlign = 'center';
            dateInfo.style.color = '#999';
            dateInfo.style.fontSize = '12px';
            dateInfo.style.marginBottom = '30px';
            pdfContent.appendChild(dateInfo);
            
            // Add notes
            const notesContainer = document.createElement('div');
            notesContainer.style.display = 'flex';
            notesContainer.style.flexWrap = 'wrap';
            notesContainer.style.gap = '15px';
            
            stickyNotes.forEach(note => {
                const noteDiv = document.createElement('div');
                noteDiv.style.width = '200px';
                noteDiv.style.padding = '15px';
                noteDiv.style.borderRadius = '8px';
                noteDiv.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                noteDiv.style.pageBreakInside = 'avoid';
                
                // Apply color
                const colorMap = {
                    yellow: 'background: #FFF59D;',
                    pink: 'background: #F48FB1; color: white;',
                    blue: 'background: #81D4FA;',
                    green: 'background: #A5D6A7;',
                    purple: 'background: #CE93D8; color: white;',
                    orange: 'background: #FFB74D;'
                };
                noteDiv.setAttribute('style', (noteDiv.getAttribute('style') || '') + colorMap[note.color]);
                
                const timeElement = note.element.querySelector('.sticky-note-time-item');
                const time = timeElement ? timeElement.textContent : 'No date';
                const content = note.element.querySelector('.sticky-note-content-item').value;
                
                noteDiv.innerHTML = `
                    <div style="font-size: 10px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
                        ${time}
                    </div>
                    <div style="font-size: 12px; line-height: 1.4; white-space: pre-wrap;">
                        ${content || '(empty note)'}
                    </div>
                `;
                notesContainer.appendChild(noteDiv);
            });
            
            pdfContent.appendChild(notesContainer);
            
            // PDF options
            const opt = {
                margin: 10,
                filename: `sticky-notes-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' },
                pagebreak: { mode: 'avoid-all' }
            };
            
            html2pdf().set(opt).from(pdfContent).save();
        }

        
    document.addEventListener('DOMContentLoaded', function () {
        try {
            var calendarSection = document.getElementById('calendarSection');
            if (calendarSection) {
                var header = calendarSection.querySelector('.section-header');
                var viewSwitcher = calendarSection.querySelector('.view-mode-switcher');
                var filterContainer = document.getElementById('viewFilterContainer');
                var eventFilterControls = document.getElementById('eventFilterControls');

                if (header) {
                    if (viewSwitcher && viewSwitcher.parentElement !== header) {
                        header.appendChild(viewSwitcher);
                    }
                    if (filterContainer && filterContainer.parentElement !== header) {
                        header.appendChild(filterContainer);
                    }
                    if (eventFilterControls && eventFilterControls.parentElement !== header) {
                        header.appendChild(eventFilterControls);
                    }
                }
            }
        } catch (e) {
            console.error('Error merging calendar header rows:', e);
        }

            try {
                // Load saved column orders
                loadColumnOrder();
                
                initializeCalendar();
                initQuickCalendar();
                updateEventList();
                toggleUserStats(savedRole);
                initializeNavToggle();
                // Call updateFloatingTasksCount if it's defined
                if (typeof updateFloatingTasksCount === 'function') {
                    updateFloatingTasksCount();
                }
                
                // Ensure calendar renders after initialization
                setTimeout(() => {
                    if (window.calendarInstance) {
                        window.calendarInstance.render();
                    }
                    
                    // Ensure right sidebar is visible in schedule view on page load
                    const scheduleView = document.getElementById('view-schedule');
                    if (scheduleView && scheduleView.classList.contains('active')) {
                        const sidebar = scheduleView.querySelector('.sidebar-right');
                        if (sidebar && sidebar.classList.contains('hidden')) {
                            sidebar.classList.remove('hidden');
                            localStorage.setItem('rightSidebarHidden', 'false');
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('Error during page initialization:', error);
            }
        });

        // Event Drop Handler (Drag & Drop)
        function handleEventDrop(info) {
            const currentRole = root.getAttribute('data-role');
            const event = info.event;
            
            // Find the event in database
            const eventIndex = eventDatabase.findIndex(e => e.id === event.id);
            
            if (eventIndex !== -1) {
                // Update event date/time
                eventDatabase[eventIndex].start = event.start.toISOString();
                if (event.end) {
                    eventDatabase[eventIndex].end = event.end.toISOString();
                }
                
                // In employee view, also update the assigned employee
                if (currentViewMode === 'employee' && event.getResources) {
                    const resources = event.getResources();
                    if (resources && resources.length > 0) {
                        const newEmployeeId = resources[0].id;
                        eventDatabase[eventIndex].resourceId = newEmployeeId;
                        eventDatabase[eventIndex].employee = newEmployeeId;
                        
                        // Get employee name
                        const employeeName = employeeResources.find(r => r.id === newEmployeeId)?.title || newEmployeeId;
                        
                        // Show confirmation with employee name
                        showNotification(`Event reassigned to ${employeeName}!`, 'success');
                    }
                } else {
                    // Show confirmation
                    showNotification('Event moved successfully!', 'success');
                }
            }
        }

        // Event Click Handler
        
        // Event Click Handler
        
        function handleEventClick(info) {
            const event = info.event;
            const eventData = eventDatabase.find(e => e.id === event.id);

            // Normal scheduled tasks / appointments
            if (eventData) {
                openEventModal(eventData);
                return;
            }

            const ext = event.extendedProps || {};

            // Special handling for Working Hours events that are injected into the main calendar
            if (ext.isWorkingHours) {
                // Try to find the staff member in the working-hours database
                let staff = null;
                if (typeof whStaffDatabase !== 'undefined' && Array.isArray(whStaffDatabase)) {
                    staff = whStaffDatabase.find(s => s.id === ext.staffId);
                }

                const staffName = (ext.staffName || (staff && staff.name) || event.title || 'Staff Member');
                const staffType = staff && staff.type ? staff.type : null; // 'provider' or 'assistant'

                // Clinics the staff works at
                let clinics = [];
                if (ext.clinics && Array.isArray(ext.clinics)) {
                    clinics = ext.clinics;
                } else if (staff && Array.isArray(staff.clinics)) {
                    clinics = staff.clinics;
                }

                let providerName = '';
                let assistantNames = [];
                let roomName = '';
                let clinicName = '';

                // Use providerAssignments + clinicDetails to figure out provider/assistant pairing
                if (typeof providerAssignments !== 'undefined' && clinics.length > 0) {
                    for (let ci = 0; ci < clinics.length; ci++) {
                        const cId = clinics[ci];
                        const clinicInfo = (typeof clinicDetails !== 'undefined' && clinicDetails[cId]) ? clinicDetails[cId] : null;
                        const cName = clinicInfo ? clinicInfo.name : cId;
                        const assignments = providerAssignments[cId] || [];

                        for (let ai = 0; ai < assignments.length; ai++) {
                            const a = assignments[ai];
                            if (!a) continue;

                            if (staffType === 'provider' && a.providerId === (staff && staff.id)) {
                                providerName = a.providerName || staffName;
                                if (a.assistantName) {
                                    assistantNames.push(a.assistantName);
                                }
                                roomName = a.room || roomName;
                                clinicName = cName;
                                // don't break; collect all assistants for this provider
                            }

                            if (staffType === 'assistant' && a.assistantId === (staff && staff.id)) {
                                providerName = a.providerName || providerName;
                                roomName = a.room || roomName;
                                clinicName = cName;
                                // for assistants we only need to know which provider(s) they support
                            }
                        }
                    }
                }

                let shiftPeopleLabel = '';
                let shiftPeople = [];

                if (staffType === 'provider') {
                    shiftPeopleLabel = 'Assistants';
                    shiftPeople = assistantNames;
                } else if (staffType === 'assistant') {
                    shiftPeopleLabel = 'Provider';
                    if (providerName) {
                        shiftPeople = [providerName];
                    }
                } else {
                    shiftPeopleLabel = 'Shift Information';
                    shiftPeople = [];
                }

                const synthetic = {
                    id: event.id,
                    title: staffName + ' â€“ Working Hours',
                    start: event.start,
                    end: event.end,
                    paid: false,
                    overdue: false,
                    priority: 'low',

                    // For modal:
                    employee: ext.employee || staffName,
                    assistants: [],
                    attendees: [],
                    eventCategory: 'working-hours',
                    location: roomName,

                    // Working-hours specific info
                    isWorkingHours: true,
                    staffType: staffType,
                    providerName: providerName,
                    assistantNames: assistantNames,
                    clinicName: clinicName,
                    shiftPeopleLabel: shiftPeopleLabel,
                    shiftPeople: shiftPeople,

                    description: '',
                    notes: ''
                };

                openEventModal(synthetic);
                return;
            }
        }

        // Modal Functions
// Modal Functions
        function openEventModal(eventData) {
            const modal = document.getElementById('eventModal');
            
            // Set title
            document.getElementById('modalTitle').textContent = eventData.title.replace('ðŸ’° ', '').replace('âš ï¸ ', '');
            
            // Set badges
            let badgesHTML = '';
            if (eventData.paid) {
                badgesHTML += '<span class="modal-badge paid"><i class="fas fa-dollar-sign"></i> Paid Task</span>';
            }
            if (eventData.overdue) {
                badgesHTML += '<span class="modal-badge overdue"><i class="fas fa-exclamation-triangle"></i> Overdue</span>';
            }
            badgesHTML += `<span class="modal-badge priority-${eventData.priority}"><i class="fas fa-flag"></i> ${eventData.priority.charAt(0).toUpperCase() + eventData.priority.slice(1)} Priority</span>`;
            document.getElementById('modalBadges').innerHTML = badgesHTML;
            
            // Set time
            const startTime = new Date(eventData.start);
            const endTime = new Date(eventData.end);
            document.getElementById('modalTime').textContent = 
                `${startTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'})} - ${endTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'})}`;
            
            // Set employee
            const employeeNames = {
                'all': 'All Staff',
                'john-smith': 'John Smith',
                'sarah-johnson': 'Sarah Johnson',
                'mike-davis': 'Mike Davis',
                'emily-brown': 'Emily Brown',
                'james-wilson': 'James Wilson'
            };
            const baseEmployeeName = employeeNames[eventData.employee] || eventData.employee || 'Unassigned';
            let employeeLabel = baseEmployeeName;
            if (eventData.isWorkingHours && eventData.staffType) {
                if (eventData.staffType === 'provider') {
                    employeeLabel += ' (Provider)';
                } else if (eventData.staffType === 'assistant') {
                    employeeLabel += ' (Assistant)';
                }
            }
            document.getElementById('modalEmployee').textContent = employeeLabel;

            // Assistants or Attendees based on event category
            
            const eventCategory = eventData.eventCategory || 'general';
            let peopleList = [];
            let peopleLabel = 'Attendees';

            // Default behavior for nonâ€“working-hours events
            if (!eventData.isWorkingHours) {
                if (eventCategory === 'dental') {
                    peopleList = eventData.assistants || [];
                    peopleLabel = 'Assistants';
                } else {
                    peopleList = eventData.attendees || [];
                    peopleLabel = 'Attendees';
                }
            } else {
                // Special behavior for WORKING HOURS
                const staffType = eventData.staffType;

                if (staffType === 'provider') {
                    peopleLabel = 'Assistants';
                    peopleList = eventData.shiftPeople || eventData.assistantNames || [];
                } else if (staffType === 'assistant') {
                    peopleLabel = 'Provider';
                    if (eventData.shiftPeople && eventData.shiftPeople.length) {
                        peopleList = eventData.shiftPeople;
                    } else if (eventData.providerName) {
                        peopleList = [eventData.providerName];
                    } else {
                        peopleList = [];
                    }
                } else {
                    // Fallback label if type is unknown
                    peopleLabel = 'Shift Information';
                    peopleList = eventData.shiftPeople || [];
                }
            }

            if (peopleList && peopleList.length > 0) {
                // For working-hours, names are plain strings (provider/assistant names),
                // for other events we still try to resolve via employeeNames map.
                let names;
                if (eventData.isWorkingHours) {
                    names = peopleList;
                } else {
                    names = peopleList.map(p => employeeNames[p] || p);
                }

                document.getElementById('modalAssistants').textContent = names.join(', ');
                document.getElementById('modalAssistantsLabel').textContent = peopleLabel;
                document.getElementById('modalAssistantsSection').style.display = 'flex';
            } else {
                document.getElementById('modalAssistants').textContent = '';
                document.getElementById('modalAssistantsSection').style.display = 'none';
            }

            // Set location
// Set location
            document.getElementById('modalLocation').textContent = eventData.location;
            
            // Set priority
            document.getElementById('modalPriority').textContent = eventData.priority.charAt(0).toUpperCase() + eventData.priority.slice(1);
            
            // Set description
            document.getElementById('modalDescription').textContent = eventData.description;
            
            // Set notes
            if (eventData.notes) {
                document.getElementById('modalNotes').textContent = eventData.notes;
                document.getElementById('modalNotesSection').style.display = 'block';
            } else {
                document.getElementById('modalNotesSection').style.display = 'none';
            }
            
            // Show modal
            modal.classList.add('active');
        }

        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            modal.classList.remove('active');
        }

        function openAddEventModal(prefilledData = {}) {
            const modal = document.getElementById('addEventModal');
            const form = document.getElementById('eventForm');
            const modalTitle = document.getElementById('addEventModalTitle');
            
            // Check if elements exist
            if (!modal || !form || !modalTitle) {
                console.error('Modal elements not found:', { modal, form, modalTitle });
                return;
            }
            
            // Reset form
            form.reset();
            document.getElementById('eventId').value = '';
            
            // Set title
            modalTitle.textContent = prefilledData.id ? 'Edit Event' : 'Add New Event';
            
            // Populate employee dropdown
            const employeeSelect = document.getElementById('eventEmployee');
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            
            if (employeeResources && Array.isArray(employeeResources)) {
                employeeResources.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.title + (emp.extendedProps ? ` (${emp.extendedProps.role})` : '');
                    employeeSelect.appendChild(option);
                });
            }
            
            // Prefill data if provided
            if (prefilledData.date) {
                document.getElementById('eventStartDate').value = prefilledData.date;
                document.getElementById('eventEndDate').value = prefilledData.date;
            }
            
            if (prefilledData.time) {
                document.getElementById('eventStartTime').value = prefilledData.time;
                // Set end time to 1 hour later
                const [hours, minutes] = prefilledData.time.split(':');
                const endHour = (parseInt(hours) + 1).toString().padStart(2, '0');
                document.getElementById('eventEndTime').value = `${endHour}:${minutes}`;
            }
            
            if (prefilledData.employee) {
                document.getElementById('eventEmployee').value = prefilledData.employee;
            }
            
            if (prefilledData.id) {
                document.getElementById('eventId').value = prefilledData.id;
                document.getElementById('eventTitle').value = prefilledData.title || '';
                document.getElementById('eventType').value = prefilledData.type || 'appointment';
                document.getElementById('eventLocation').value = prefilledData.location || '';
                document.getElementById('eventPriority').value = prefilledData.priority || 'medium';
                document.getElementById('eventDescription').value = prefilledData.description || '';
                document.getElementById('eventNotes').value = prefilledData.notes || '';
                
                if (prefilledData.start) {
                    const startDate = new Date(prefilledData.start);
                    document.getElementById('eventStartDate').value = startDate.toISOString().split('T')[0];
                    document.getElementById('eventStartTime').value = startDate.toTimeString().slice(0, 5);
                }
                
                if (prefilledData.end) {
                    const endDate = new Date(prefilledData.end);
                    document.getElementById('eventEndDate').value = endDate.toISOString().split('T')[0];
                    document.getElementById('eventEndTime').value = endDate.toTimeString().slice(0, 5);
                }
            } else {
                // Set default times if not prefilled
                if (!prefilledData.time) {
                    const now = new Date();
                    const hour = now.getHours().toString().padStart(2, '0');
                    document.getElementById('eventStartTime').value = `${hour}:00`;
                    document.getElementById('eventEndTime').value = `${(parseInt(hour) + 1).toString().padStart(2, '0')}:00`;
                }
                
                // Set default date if not prefilled
                if (!prefilledData.date) {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('eventStartDate').value = today;
                    document.getElementById('eventEndDate').value = today;
                }
            }
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeAddEventModal() {
            const modal = document.getElementById('addEventModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function saveEvent(e) {
            e.preventDefault();
            
            const eventId = document.getElementById('eventId').value;
            const title = document.getElementById('eventTitle').value;
            const type = document.getElementById('eventType').value;
            const startDate = document.getElementById('eventStartDate').value;
            const startTime = document.getElementById('eventStartTime').value;
            const endDate = document.getElementById('eventEndDate').value;
            const endTime = document.getElementById('eventEndTime').value;
            const employee = document.getElementById('eventEmployee').value;
            const location = document.getElementById('eventLocation').value;
            const priority = document.getElementById('eventPriority').value;
            const description = document.getElementById('eventDescription').value;
            const notes = document.getElementById('eventNotes').value;
            
            // Determine event category based on type
            let eventCategory = 'general';
            if (type === 'appointment' || type === 'duty') {
                eventCategory = 'dental';
            } else if (type === 'task' || type === 'floating-task' || type === 'bonus-task') {
                eventCategory = 'task';
            } else if (type === 'pto' || type === 'vacation' || type === 'sick-leave') {
                eventCategory = 'pto';
            }
            
            // Create event object
            const newEvent = {
                id: eventId || 'event-' + Date.now(),
                title: title,
                start: `${startDate}T${startTime}:00`,
                end: `${endDate}T${endTime}:00`,
                resourceId: employee,
                employee: employee,
                location: location,
                priority: priority,
                description: description,
                notes: notes,
                type: type,
                eventCategory: eventCategory,
                paid: false,
                overdue: false
            };
            
            // Add task-specific properties
            if (eventCategory === 'task') {
                newEvent.isTask = true;
                newEvent.taskStatus = 'pending';
                newEvent.isFloatingTask = type === 'floating-task';
                newEvent.isBonusTask = type === 'bonus-task';
            }
            
            // Add PTO-specific properties
            if (eventCategory === 'pto') {
                newEvent.isPTO = true;
                newEvent.ptoType = type;
            }
            
            // Add or update event in database
            if (eventId) {
                // Update existing event
                const index = eventDatabase.findIndex(e => e.id === eventId);
                if (index !== -1) {
                    eventDatabase[index] = newEvent;
                    showNotification('Event updated successfully!', 'success');
                }
            } else {
                // Add new event
                eventDatabase.push(newEvent);
                showNotification('Event created successfully!', 'success');
            }
            
            // Refresh calendar
            if (calendar) {
                calendar.refetchEvents();
            }
            
            // Close modal
            closeAddEventModal();
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('addEventModal');
            if (modal && e.target === modal) {
                closeAddEventModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('addEventModal');
                if (modal && modal.style.display === 'flex') {
                    closeAddEventModal();
                }
            }
        });

        function editEvent() {
            // Placeholder for edit event functionality
            alert('Edit Event functionality - to be implemented with form');
        }

        // Table View Functions
        function toggleTableView() {
            isTableView = !isTableView;
            const calendarDiv = document.getElementById('calendar');
            const tableDiv = document.getElementById('tableView');
            const toggleBtn = document.getElementById('tableViewToggleBtn');
            
            if (isTableView) {
                calendarDiv.style.display = 'none';
                tableDiv.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-calendar"></i> Show Calendar';
                toggleBtn.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
                toggleBtn.style.color = 'white';
                toggleBtn.style.border = 'none';
                populateTable();
            } else {
                calendarDiv.style.display = 'block';
                tableDiv.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-table"></i> Show as Table';
                toggleBtn.style.background = 'var(--bg-secondary)';
                toggleBtn.style.color = 'var(--text-primary)';
                toggleBtn.style.border = '1px solid var(--border-color)';
            }
        }

        function populateTable() {
            const tbody = document.getElementById('eventsTableBody');
            const rowCount = document.getElementById('tableRowCount');
            
            // Get filtered events
            let events = getFilteredEvents();
            
            // Filter by calendar's current date range
            if (window.calendarInstance && window.calendarInstance.currentDate && window.calendarInstance.currentView) {
                const currentDate = new Date(window.calendarInstance.currentDate);
                const view = window.calendarInstance.currentView;
                
                let startDate, endDate;
                
                if (view === 'month') {
                    // Show entire month
                    startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59);
                } else if (view === 'week' || view === 'resourceWeek') {
                    // Show current week
                    const dayOfWeek = currentDate.getDay();
                    startDate = new Date(currentDate);
                    startDate.setDate(currentDate.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                } else if (view === 'day' || view === 'resourceDay') {
                    // Show current day
                    startDate = new Date(currentDate);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(currentDate);
                    endDate.setHours(23, 59, 59, 999);
                }
                
                // Filter events by date range
                if (startDate && endDate) {
                    events = events.filter(event => {
                        const eventStart = new Date(event.start);
                        return eventStart >= startDate && eventStart <= endDate;
                    });
                }
            }
            
            // Sort events by date by default
            events.sort((a, b) => new Date(a.start) - new Date(b.start));
            
            rowCount.textContent = `(${events.length} events)`;
            
            tbody.innerHTML = '';
            
            if (events.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <div>No events found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            events.forEach(event => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--border-color)';
                row.style.transition = 'background 0.2s';
                row.onmouseover = () => row.style.background = 'var(--bg-secondary)';
                row.onmouseout = () => row.style.background = 'transparent';
                
                // Date
                const startDate = new Date(event.start);
                const dateStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                // Time
                const timeStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const endDate = event.end ? new Date(event.end) : null;
                const endTimeStr = endDate ? endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';
                const fullTimeStr = endTimeStr ? `${timeStr} - ${endTimeStr}` : timeStr;
                
                // Employee name
                const employeeResource = employeeResources.find(e => e.id === event.employee);
                const employeeName = employeeResource ? employeeResource.title : event.employee || 'Unassigned';
                
                // Priority colors
                const priorityColors = {
                    critical: { bg: '#fee2e2', text: '#dc2626', icon: 'fa-exclamation-circle' },
                    high: { bg: '#fef3c7', text: '#d97706', icon: 'fa-arrow-up' },
                    medium: { bg: '#dbeafe', text: '#2563eb', icon: 'fa-minus' },
                    low: { bg: '#d1fae5', text: '#059669', icon: 'fa-arrow-down' }
                };
                const priority = event.priority || 'medium';
                const priorityStyle = priorityColors[priority] || priorityColors.medium;
                
                // Type badge colors
                const typeColors = {
                    appointment: '#3b82f6',
                    duty: '#8b5cf6',
                    meeting: '#ec4899',
                    training: '#f59e0b',
                    task: '#10b981',
                    'floating-task': '#14b8a6',
                    'bonus-task': '#f97316',
                    pto: '#ef4444',
                    vacation: '#06b6d4',
                    'sick-leave': '#64748b'
                };
                const typeColor = typeColors[event.type] || '#6b7280';
                
                row.innerHTML = `
                    <td style="padding: 0.75rem 1rem; color: var(--text-primary); font-weight: 500; white-space: nowrap;">${dateStr}</td>
                    <td style="padding: 0.75rem 1rem; color: var(--text-secondary); font-size: 0.9rem; white-space: nowrap;">${fullTimeStr}</td>
                    <td style="padding: 0.75rem 1rem; color: var(--text-primary); font-weight: 500;">${event.title}</td>
                    <td style="padding: 0.75rem 1rem;">
                        <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${typeColor}20; color: ${typeColor}; border-radius: 12px; font-size: 0.85rem; font-weight: 600; white-space: nowrap;">
                            ${event.type.charAt(0).toUpperCase() + event.type.slice(1).replace('-', ' ')}
                        </span>
                    </td>
                    <td style="padding: 0.75rem 1rem; color: var(--text-primary);">${employeeName}</td>
                    <td style="padding: 0.75rem 1rem;">
                        <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; background: ${priorityStyle.bg}; color: ${priorityStyle.text}; border-radius: 12px; font-size: 0.85rem; font-weight: 600; white-space: nowrap;">
                            <i class="fas ${priorityStyle.icon}"></i>
                            ${priority.charAt(0).toUpperCase() + priority.slice(1)}
                        </span>
                    </td>
                    <td style="padding: 0.75rem 1rem; color: var(--text-secondary); font-size: 0.9rem;">${event.location || '-'}</td>
                    <td style="padding: 0.75rem 1rem; text-align: center;">
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="viewEventDetails('${event.id}')" style="padding: 0.4rem 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editEventFromTable('${event.id}')" style="padding: 0.4rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEvent('${event.id}')" style="padding: 0.4rem 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('eventsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle sort direction if clicking same column
            if (currentSortColumn === columnIndex) {
                sortAscending = !sortAscending;
            } else {
                sortAscending = true;
                currentSortColumn = columnIndex;
            }
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                // Handle date sorting
                if (columnIndex === 0) {
                    return sortAscending ? 
                        new Date(aValue) - new Date(bValue) : 
                        new Date(bValue) - new Date(aValue);
                }
                
                // String comparison
                return sortAscending ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icons
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                const icon = header.querySelector('i.fa-sort, i.fa-sort-up, i.fa-sort-down');
                if (icon) {
                    if (index === columnIndex) {
                        icon.className = sortAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                }
            });
        }

        function filterTable() {
            const searchInput = document.getElementById('tableSearch');
            const filter = searchInput.value.toLowerCase();
            const tbody = document.getElementById('eventsTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('tableRowCount').textContent = `(${visibleCount} of ${rows.length} events)`;
        }

        function exportTableToCSV() {
            const table = document.getElementById('eventsTable');
            const rows = Array.from(table.querySelectorAll('tr:not([style*="display: none"])'));
            
            let csv = [];
            
            rows.forEach(row => {
                const cols = Array.from(row.querySelectorAll('th, td'));
                const rowData = cols.slice(0, -1).map(col => {
                    let text = col.textContent.trim();
                    // Remove icons from text
                    text = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
                    return `"${text.replace(/"/g, '""')}"`;
                });
                csv.push(rowData.join(','));
            });
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `events_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Events exported successfully!', 'success');
        }

        function viewEventDetails(eventId) {
            const event = eventDatabase.find(e => e.id === eventId);
            if (event) {
                handleEventClick({ event: event });
            }
        }

        function editEventFromTable(eventId) {
            const event = eventDatabase.find(e => e.id === eventId);
            if (event) {
                openAddEventModal(event);
            }
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                const index = eventDatabase.findIndex(e => e.id === eventId);
                if (index !== -1) {
                    eventDatabase.splice(index, 1);
                    showNotification('Event deleted successfully!', 'success');
                    
                    if (isTableView) {
                        populateTable();
                    } else if (calendar) {
                        calendar.refetchEvents();
                    }
                }
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            // Simple notification - can be enhanced with toast library
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 9999;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateEventList() {
            const currentRole = root.getAttribute('data-role');
            const eventList = document.getElementById('eventList');
            
            // Get today's events
            const today = '2025-11-09';
            let todayEvents = eventDatabase.filter(e => e.start.startsWith(today));
            
            // Filter by role
            if (currentRole === 'user') {
                todayEvents = todayEvents.filter(e => 
                    e.employee === 'john-smith' || e.employee === 'all'
                );
            }
            
            if (currentRole === 'admin' && selectedEmployee !== 'all') {
                todayEvents = todayEvents.filter(e => 
                    e.employee === selectedEmployee || e.employee === 'all'
                );
            }
            
            // Sort by start time
            todayEvents.sort((a, b) => new Date(a.start) - new Date(b.start));
            
            // Generate HTML
            let html = '';
            todayEvents.forEach(event => {
                const startTime = new Date(event.start);
                const timeStr = startTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
                const employeeNames = {
                    'all': 'All Staff',
                    'john-smith': 'John Smith',
                    'sarah-johnson': 'Sarah Johnson',
                    'mike-davis': 'Mike Davis',
                    'emily-brown': 'Emily Brown',
                    'james-wilson': 'James Wilson'
                };
                
                html += `
                    <div class="event-item" style="border-left-color: ${event.backgroundColor};" onclick='openEventModal(${JSON.stringify(event)})'>
                        <div class="event-header">
                            <div class="event-title">
                                ${event.overdue ? '<i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>' : ''}
                                ${event.paid ? '<i class="fas fa-dollar-sign" style="color: #10b981;"></i>' : ''}
                                ${event.title.replace('ðŸ’° ', '').replace('âš ï¸ ', '')}
                            </div>
                            <span class="event-time">${timeStr}</span>
                        </div>
                        <div class="event-details">
                            <span><i class="fas fa-user"></i> ${employeeNames[event.employee]}</span>
                            <span><i class="fas fa-map-marker-alt"></i> ${event.location}</span>
                            <span><i class="fas fa-flag"></i> ${event.priority.charAt(0).toUpperCase() + event.priority.slice(1)}</span>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-calendar-check" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No events scheduled for today</p>
                    </div>
                `;
            }
            
            if (eventList) {
                eventList.innerHTML = html;
            }
        }

        // Filter Functions
        function applyFilters() {
            try {
                const departmentFilter = document.getElementById('filterDepartment').value;
                const priorityFilter = document.getElementById('filterPriority').value;
                const frequencyFilter = document.getElementById('filterFrequency').value;
                const statusFilter = document.getElementById('filterStatus').value;

                const dutyItems = document.querySelectorAll('.duty-item');
                let visibleCount = 0;

                dutyItems.forEach(item => {
                    const itemDepartment = item.getAttribute('data-department');
                    const itemPriority = item.getAttribute('data-priority');
                    const itemFrequency = item.getAttribute('data-frequency');
                    const itemStatus = item.getAttribute('data-status');

                    const matchesDepartment = departmentFilter === 'all' || itemDepartment === departmentFilter;
                    const matchesPriority = priorityFilter === 'all' || itemPriority === priorityFilter;
                    const matchesFrequency = frequencyFilter === 'all' || itemFrequency === frequencyFilter;
                    const matchesStatus = statusFilter === 'all' || itemStatus === statusFilter;

                    if (matchesDepartment && matchesPriority && matchesFrequency && matchesStatus) {
                        item.style.display = 'block';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Update the duty count badge in navigation - using querySelector without :has()
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    const icon = item.querySelector('i');
                    if (icon && icon.classList.contains('fa-clipboard-check')) {
                        const badge = item.querySelector('.nav-badge');
                        if (badge) {
                            badge.textContent = visibleCount;
                        }
                    }
                });

                // Show message if no results
                showFilterMessage(visibleCount);
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        }

        function clearFilters() {
            try {
                document.getElementById('filterDepartment').value = 'all';
                document.getElementById('filterPriority').value = 'all';
                document.getElementById('filterFrequency').value = 'all';
                document.getElementById('filterStatus').value = 'all';
                applyFilters();
            } catch (error) {
                console.error('Error clearing filters:', error);
            }
        }

        function showFilterMessage(count) {
            try {
                // Remove existing message if any
                const existingMessage = document.querySelector('.filter-message');
                if (existingMessage) {
                    existingMessage.remove();
                }

                if (count === 0) {
                    const dutyList = document.querySelector('.duty-list');
                    if (dutyList) {
                        const message = document.createElement('div');
                        message.className = 'filter-message';
                        message.style.cssText = 'padding: 2rem; text-align: center; color: var(--text-secondary);';
                        message.innerHTML = `
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No duties match your filters</p>
                            <p style="font-size: 0.9rem;">Try adjusting your filter criteria</p>
                        `;
                        dutyList.appendChild(message);
                    }
                }
            } catch (error) {
                console.error('Error showing filter message:', error);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                closeEventModal();
            }
        });
    </script>

<script>
/* ==== ADDED: Theme/Font color + Fullscreen wiring ==== */
(function() {
  const root = document.documentElement;
  // restore saved prefs
  const savedAccent    = localStorage.getItem('accent');
  const savedFontColor = localStorage.getItem('fontColor');
  if (savedAccent)    root.setAttribute('data-accent', savedAccent);
  if (savedFontColor) root.setAttribute('data-fontcolor', savedFontColor);

  // dropdown wiring
  const accentSelect = document.getElementById('accentSelect');
  const fontColorSelect = document.getElementById('fontColorSelect');
  if (accentSelect) {
    accentSelect.value = root.getAttribute('data-accent') || 'cyan';
    accentSelect.addEventListener('change', (e)=>{
      const val = e.target.value;
      root.setAttribute('data-accent', val);
      localStorage.setItem('accent', val);
      if (window.calendar && typeof calendar.updateSize === 'function') setTimeout(()=>calendar.updateSize(), 50);
    });
  }
  if (fontColorSelect) {
    fontColorSelect.value = root.getAttribute('data-fontcolor') || 'default';
    fontColorSelect.addEventListener('change', (e)=>{
      const val = e.target.value;
      root.setAttribute('data-fontcolor', val);
      localStorage.setItem('fontColor', val);
    });
  }

  // fullscreen functionality removed
})();

// Floating Tasks Database - Loaded from API
const floatingTasksDatabase = [];

// Current Event ID for modal
let currentEventId = null;

// Floating Tasks Functions
function toggleFloatingTasksPanel() {
    const panel = document.getElementById('floatingTasksPanel');
    if (!panel) {
        console.error('Floating tasks panel not found');
        return;
    }
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        renderFloatingTasks();
    }
}

function closeFloatingTasksPanel() {
    const panel = document.getElementById('floatingTasksPanel');
    if (!panel) return;
    panel.classList.remove('active');
}

function minimizeFloatingTasksPanel() {
    const panel = document.getElementById('floatingTasksPanel');
    panel.classList.toggle('minimized');
}

function renderFloatingTasks() {
    const body = document.getElementById('floatingTasksBody');
    
    // Get floating tasks from tasksData (database-backed)
    const floatingTasks = window.tasksData.filter(t => t.taskType === 'Floating' && t.status !== 'Completed' && !t.claimedBy);
    
    if (floatingTasks.length === 0) {
        body.innerHTML = `
            <div class="no-floating-tasks">
                <i class="fas fa-clipboard-check"></i>
                <p>No floating tasks available</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Check back later for new tasks</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    floatingTasks.forEach(task => {
        html += `
            <div class="floating-task-item">
                <div class="floating-task-header">
                    <div class="floating-task-title">${task.title}</div>
                    <div class="floating-task-badges">
                        <span class="floating-task-badge priority"><i class="fas fa-flag"></i></span>
                        ${task.isPaid ? `<span class="floating-task-badge" style="background: #10b981;"><i class="fas fa-dollar-sign"></i></span>` : ''}
                    </div>
                </div>
                <div class="floating-task-desc">${task.description}</div>
                <div class="floating-task-meta">
                    <span><i class="fas fa-clock"></i>${task.timeEstimate || task.estimatedTime + ' mins'}</span>
                    <span><i class="fas fa-map-marker-alt"></i>${task.location || 'Any Location'}</span>
                    <span><i class="fas fa-calendar"></i>Due: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'Flexible'}</span>
                    ${task.isPaid && task.payAmount ? `<span style="color: #10b981; font-weight: 600;"><i class="fas fa-dollar-sign"></i>$${task.payAmount}</span>` : ''}
                </div>
                <div class="floating-task-actions">
                    <button class="claim-task-btn" onclick="claimFloatingTask('${task.id}')">
                        <i class="fas fa-hand-pointer"></i>
                        Claim This Task
                    </button>
                    <button class="dismiss-task-btn" onclick="dismissFloatingTask('${task.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    body.innerHTML = html;
    if (typeof updateFloatingTasksCount === 'function') {
        updateFloatingTasksCount();
    }
}

async function claimFloatingTask(taskId) {
    const taskIndex = window.tasksData.findIndex(t => t.id == taskId);
    if (taskIndex === -1) return;
    
    const task = window.tasksData[taskIndex];
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    try {
        // Update task in database
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...task,
                claimedBy: currentUser ? currentUser.email : 'Unknown',
                claimedAt: new Date().toISOString(),
                status: 'In Progress'
            })
        });
        
        if (response.ok) {
            // Update local data
            window.tasksData[taskIndex].claimedBy = currentUser ? currentUser.email : 'Unknown';
            window.tasksData[taskIndex].claimedAt = new Date().toISOString();
            window.tasksData[taskIndex].status = 'In Progress';
            
            // Add to event database for calendar display
            const newEvent = {
                id: 'claimed-' + taskId,
                title: task.title,
                start: new Date(task.dueDate + 'T09:00:00').toISOString(),
                end: new Date(task.dueDate + 'T' + (9 + parseInt(task.timeEstimate || '1')) + ':00:00').toISOString(),
                resourceId: currentUser ? currentUser.id : 'john-smith',
                employee: currentUser ? currentUser.id : 'john-smith',
                location: task.location || 'Any Location',
                priority: task.priority,
                description: task.description,
                notes: task.isPaid ? `Paid task: $${task.payAmount}` : '',
                paid: task.isPaid,
                overdue: false,
                completed: false,
                type: 'floating'
            };
            
            eventDatabase.push(newEvent);
            
            // Update UI
            renderFloatingTasks();
            updateFloatingTasksCount();
            if (calendar) calendar.refetchEvents();
            showNotification(`Task "${task.title}" claimed successfully!`, 'success');
            
            const remainingFloating = window.tasksData.filter(t => t.taskType === 'Floating' && t.status !== 'Completed' && !t.claimedBy).length;
            if (remainingFloating === 0) {
                setTimeout(closeFloatingTasksPanel, 1500);
            }
        } else {
            throw new Error('Failed to claim task');
        }
    } catch (error) {
        console.error('Error claiming floating task:', error);
        showNotification('Failed to claim task', 'error');
    }
}

async function dismissFloatingTask(taskId) {
    const taskIndex = window.tasksData.findIndex(t => t.id == taskId);
    if (taskIndex !== -1) {
        try {
            const task = window.tasksData[taskIndex];
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...task,
                    status: 'Dismissed'
                })
            });
            
            if (response.ok) {
                window.tasksData[taskIndex].status = 'Dismissed';
                renderFloatingTasks();
                updateFloatingTasksCount();
                showNotification('Task dismissed', 'info');
                
                const remainingFloating = window.tasksData.filter(t => t.taskType === 'Floating' && t.status !== 'Completed' && !t.claimedBy).length;
                if (remainingFloating === 0) {
                    setTimeout(closeFloatingTasksPanel, 1500);
                }
            }
        } catch (error) {
            console.error('Error dismissing floating task:', error);
            showNotification('Failed to dismiss task', 'error');
        }
    }
}

function updateFloatingTasksCount() {
    try {
        // Count floating tasks from database-backed tasksData
        const count = window.tasksData.filter(t => t.taskType === 'Floating' && t.status !== 'Completed' && !t.claimedBy).length;
        const badge = document.getElementById('floatingTasksBadge');
        if (badge) {
            badge.textContent = count;
        }
        
        const navBadge = document.getElementById('floatingTasksNavBadge');
        if (navBadge) {
            navBadge.textContent = count;
        }
        
        const notification = document.getElementById('floatingTasksNotification');
        if (notification) {
            if (count > 0) {
                notification.style.display = 'block';
            } else {
                notification.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error updating floating tasks count:', error);
    }
}

// Bonus Tasks Functions
async function claimBonusTask(taskId) {
    const taskIndex = window.tasksData.findIndex(t => t.id == taskId);
    if (taskIndex === -1) return;
    
    const task = window.tasksData[taskIndex];
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    try {
        // Update task in database
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...task,
                claimedBy: currentUser ? currentUser.email : 'Unknown',
                claimedAt: new Date().toISOString(),
                status: 'In Progress'
            })
        });
        
        if (response.ok) {
            // Update local data
            window.tasksData[taskIndex].claimedBy = currentUser ? currentUser.email : 'Unknown';
            window.tasksData[taskIndex].claimedAt = new Date().toISOString();
            window.tasksData[taskIndex].status = 'In Progress';
            
            renderBonusTasks();
            updateBonusTasksCount();
            showNotification(`Bonus task "${task.title}" claimed! Earned $${task.payAmount || '0'}`, 'success');
            
            const remainingBonus = window.tasksData.filter(t => t.taskType === 'Bonus' && t.status !== 'Completed' && !t.claimedBy).length;
            if (remainingBonus === 0) {
                setTimeout(closeBonusTasksPanel, 1500);
            }
        } else {
            throw new Error('Failed to claim task');
        }
    } catch (error) {
        console.error('Error claiming bonus task:', error);
        showNotification('Failed to claim bonus task', 'error');
    }
}

async function dismissBonusTask(taskId) {
    const taskIndex = window.tasksData.findIndex(t => t.id == taskId);
    if (taskIndex !== -1) {
        try {
            // Update task status to dismissed in database
            const task = window.tasksData[taskIndex];
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...task,
                    status: 'Dismissed'
                })
            });
            
            if (response.ok) {
                window.tasksData[taskIndex].status = 'Dismissed';
                renderBonusTasks();
                updateBonusTasksCount();
                showNotification('Bonus task dismissed', 'info');
                
                const remainingBonus = window.tasksData.filter(t => t.taskType === 'Bonus' && t.status !== 'Completed' && !t.claimedBy).length;
                if (remainingBonus === 0) {
                    setTimeout(closeBonusTasksPanel, 1500);
                }
            }
        } catch (error) {
            console.error('Error dismissing bonus task:', error);
            showNotification('Failed to dismiss task', 'error');
        }
    }
}

function updateBonusTasksCount() {
    try {
        // Count bonus tasks from database-backed tasksData
        const count = window.tasksData.filter(t => t.taskType === 'Bonus' && t.status !== 'Completed' && !t.claimedBy).length;
        const badge = document.getElementById('bonusTasksBadge');
        if (badge) {
            badge.textContent = count;
        }
        
        const navBadge = document.getElementById('bonusTasksNavBadge');
        if (navBadge) {
            navBadge.textContent = count;
        }
    } catch (error) {
        console.error('Error updating bonus tasks count:', error);
    }
}


// Mark as Completed Function
function markAsCompleted() {
    if (!currentEventId) return;
    
    const eventIndex = eventDatabase.findIndex(e => e.id === currentEventId);
    if (eventIndex !== -1) {
        eventDatabase[eventIndex].completed = !eventDatabase[eventIndex].completed;
        
        if (eventDatabase[eventIndex].completed) {
            showNotification('Task marked as completed!', 'success');
        } else {
            showNotification('Task marked as incomplete', 'info');
        }
        
        // Refresh calendar
        if (calendar) calendar.refetchEvents();
        
        // Close modal
        closeEventModal();
    }
}

// Update your openEventModal function to set currentEventId and handle completed status
// Add this at the start of your existing openEventModal function:
// currentEventId = eventData.id;

// And update the mark completed button based on status:
// const markBtn = document.getElementById('markCompletedBtn');
// if (eventData.completed) {
//     markBtn.innerHTML = '<i class="fas fa-undo"></i> Mark as Incomplete';
//     markBtn.style.background = '#6c757d';
// } else {
//     markBtn.innerHTML = '<i class="fas fa-check-circle"></i> Mark as Completed';
//     markBtn.style.background = '#10b981';
// }

// Update your event rendering to show completed status
// Add 'completed' badge to modal badges if event is completed

// ========== PROCEDURES MODULE ==========

// Get dynamic instrument database from localStorage
function getInstrumentDatabase() {
    const savedInstruments = loadInstruments();
    const dynamicDatabase = {};
    
    // All available categories (always show these)
    const allCategories = ['Diagnostic', 'Surgical', 'Restorative', 'Endodontic', 'Periodontal', 'Orthodontic', 'Prosthodontic', 'Hygiene', 'Other'];
    
    // Initialize all categories as empty arrays
    allCategories.forEach(cat => {
        dynamicDatabase[cat] = [];
    });
    
    // If we have saved instruments, organize them by category
    if (savedInstruments && savedInstruments.length > 0) {
        // Instrument type to icon mapping
        const typeIcons = {
            'mirror': 'fa-microscope',
            'explorer': 'fa-compass',
            'probe': 'fa-ruler',
            'scaler': 'fa-grip-lines',
            'curette': 'fa-screwdriver',
            'forceps': 'fa-grip',
            'elevator': 'fa-arrow-up',
            'scalpel': 'fa-cut',
            'handpiece': 'fa-cog',
            'bur': 'fa-circle',
            'file': 'fa-file',
            'plugger': 'fa-hammer',
            'spatula': 'fa-spoon',
            'syringe': 'fa-syringe',
            'clamp': 'fa-compress-alt',
            'tweezers': 'fa-grip',
            'gauze': 'fa-scroll',
            'cotton': 'fa-circle-notch',
            'suction': 'fa-wind',
            'ejector': 'fa-wind'
        };
        
        savedInstruments.filter(i => i.isActive !== false).forEach(instrument => {
            const category = instrument.category || 'Other';
            if (!dynamicDatabase[category]) {
                dynamicDatabase[category] = [];
            }
            
            // Determine icon based on instrument name/type
            let icon = 'fa-tools';
            const nameLower = (instrument.instrumentName + ' ' + (instrument.instrumentType || '')).toLowerCase();
            for (const [key, iconClass] of Object.entries(typeIcons)) {
                if (nameLower.includes(key)) {
                    icon = iconClass;
                    break;
                }
            }
            
            dynamicDatabase[category].push({
                id: 'inst-' + instrument.instrumentID,
                name: instrument.instrumentName,
                icon: icon,
                category: category,
                quantity: instrument.quantity || 1,
                manufacturer: instrument.manufacturer,
                condition: instrument.condition
            });
        });
    }
    
    return dynamicDatabase;
}

// Legacy static database (kept for backward compatibility with existing procedures)
const instrumentDatabase = {
    diagnostic: [
        { id: 'mirror-1', name: 'Mouth Mirror', icon: 'fa-microscope', category: 'diagnostic' },
        { id: 'explorer-1', name: 'Explorer', icon: 'fa-compass', category: 'diagnostic' },
        { id: 'probe-1', name: 'Periodontal Probe', icon: 'fa-ruler', category: 'diagnostic' },
        { id: 'tweezers-1', name: 'Tweezers', icon: 'fa-hand-holding-tweezers', category: 'diagnostic' }
    ],
    surgical: [
        { id: 'scalpel-1', name: 'Scalpel Handle', icon: 'fa-cut', category: 'surgical' },
        { id: 'forceps-1', name: 'Extraction Forceps', icon: 'fa-grip', category: 'surgical' },
        { id: 'elevator-1', name: 'Periosteal Elevator', icon: 'fa-arrow-up', category: 'surgical' },
        { id: 'bone-file-1', name: 'Bone File', icon: 'fa-file', category: 'surgical' },
        { id: 'retractor-1', name: 'Retractor', icon: 'fa-arrow-left', category: 'surgical' }
    ],
    cutting: [
        { id: 'highspeed-1', name: 'High Speed Handpiece', icon: 'fa-bolt', category: 'cutting' },
        { id: 'lowspeed-1', name: 'Low Speed Handpiece', icon: 'fa-cog', category: 'cutting' },
        { id: 'bur-round-1', name: 'Round Bur', icon: 'fa-circle', category: 'cutting' },
        { id: 'bur-tapered-1', name: 'Tapered Bur', icon: 'fa-cone', category: 'cutting' },
        { id: 'bur-fissure-1', name: 'Fissure Bur', icon: 'fa-equals', category: 'cutting' }
    ],
    filling: [
        { id: 'condenser-1', name: 'Plugger', icon: 'fa-hammer', category: 'filling' },
        { id: 'spatula-1', name: 'Mixing Spatula', icon: 'fa-spoon', category: 'filling' },
        { id: 'matrix-1', name: 'Matrix Band', icon: 'fa-layer-group', category: 'filling' },
        { id: 'wedge-1', name: 'Wedge', icon: 'fa-arrow-right', category: 'filling' }
    ],
    suction: [
        { id: 'saliva-ejector-1', name: 'Saliva Ejector', icon: 'fa-wind', category: 'suction' },
        { id: 'high-volume-1', name: 'High Volume Evacuator', icon: 'fa-fan', category: 'suction' }
    ],
    misc: [
        { id: 'gauze-1', name: 'Gauze Pad', icon: 'fa-scroll', category: 'misc' },
        { id: 'cotton-1', name: 'Cotton Roll', icon: 'fa-circle-notch', category: 'misc' },
        { id: 'bib-1', name: 'Patient Bib', icon: 'fa-vest', category: 'misc' }
    ]
};

// Procedure Database - Load from localStorage
function loadProcedures() {
    const saved = localStorage.getItem('procedureDatabase');
    if (saved) {
        const procedures = JSON.parse(saved);
        // Convert date strings back to Date objects
        procedures.forEach(p => {
            if (p.createdDate) p.createdDate = new Date(p.createdDate);
        });
        return procedures;
    }
    return []; // Start empty - no hardcoded procedures
}

function saveProcedures() {
    localStorage.setItem('procedureDatabase', JSON.stringify(procedureDatabase));
}

let procedureDatabase = loadProcedures();
let currentProcedure = null;
let currentProcedureMode = 'new';

function initProceduresModule() {
    renderProceduresList();
    renderCategoryButtons();
    // Get first category from dynamic database
    const dynamicDb = getInstrumentDatabase();
    const firstCategory = Object.keys(dynamicDb)[0] || 'Diagnostic';
    renderInstrumentsList(firstCategory);
    renderTray();
}

function renderProceduresList() {
    const list = document.getElementById('proceduresList');
    if (procedureDatabase.length === 0) {
        list.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);"><i class="fas fa-inbox"></i><p>No procedures yet</p></div>';
        return;
    }
    let html = '';
    procedureDatabase.forEach(proc => {
        html += `
            <div class="procedure-item ${currentProcedure?.id === proc.id ? 'active' : ''}" onclick="selectProcedure('${proc.id}')">
                <div class="procedure-item-name">${proc.name}</div>
                <div class="procedure-item-meta">
                    <span><i class="fas fa-clock"></i>${proc.estimatedTime}m</span>
                    <span><i class="fas fa-cube"></i>${proc.instruments.length}</span>
                    ${proc.isTemplate ? '<span style="color: var(--accent-primary);"><i class="fas fa-star"></i>Template</span>' : ''}
                </div>
            </div>
        `;
    });
    list.innerHTML = html;
}

function selectProcedure(procId) {
    currentProcedure = procedureDatabase.find(p => p.id === procId);
    currentProcedureMode = 'edit';
    renderProceduresList();
    renderTray();
    updateDeleteButton();
}

function renderCategoryButtons() {
    const container = document.getElementById('categoryButtons');
    const dynamicDb = getInstrumentDatabase();
    const categories = Object.keys(dynamicDb);
    let html = '';
    const firstCategory = categories[0] || 'Diagnostic';
    categories.forEach((cat, index) => {
        const count = dynamicDb[cat]?.length || 0;
        html += `<button class="category-btn ${index === 0 ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat} <span style="font-size: 0.75rem; opacity: 0.7;">(${count})</span></button>`;
    });
    container.innerHTML = html;
}

function filterByCategory(category) {
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderInstrumentsList(category);
}

function renderInstrumentsList(category) {
    const list = document.getElementById('instrumentsList');
    const dynamicDb = getInstrumentDatabase();
    const instruments = dynamicDb[category] || [];
    
    if (instruments.length === 0) {
        list.innerHTML = `<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">
            <i class="fas fa-inbox" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <p style="margin: 0;">No instruments in this category.</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">Add instruments via <strong>Manage Instruments</strong> in Settings.</p>
        </div>`;
        return;
    }
    
    let html = '';
    instruments.forEach(instrument => {
        const isSelected = currentProcedure?.instruments.includes(instrument.id);
        html += `
            <div class="instrument-option ${isSelected ? 'selected' : ''}" onclick="toggleInstrument('${instrument.id}')" title="${instrument.manufacturer ? 'Manufacturer: ' + instrument.manufacturer : ''}${instrument.quantity > 1 ? ' | Qty: ' + instrument.quantity : ''}">
                <span class="instrument-option-icon"><i class="fas ${instrument.icon}"></i></span>
                <span class="instrument-option-name">${instrument.name}${instrument.quantity > 1 ? ' <small>(' + instrument.quantity + ')</small>' : ''}</span>
            </div>
        `;
    });
    list.innerHTML = html;
}

function toggleInstrument(instrumentId) {
    if (!currentProcedure) {
        currentProcedure = {
            id: 'proc-new-' + Date.now(),
            name: 'New Procedure',
            description: '',
            category: 'general',
            estimatedTime: 30,
            instruments: [],
            createdDate: new Date(),
            isTemplate: false
        };
        currentProcedureMode = 'new';
        renderProceduresList();
    }
    const index = currentProcedure.instruments.indexOf(instrumentId);
    if (index > -1) {
        currentProcedure.instruments.splice(index, 1);
    } else {
        currentProcedure.instruments.push(instrumentId);
    }
    // Get current active category - extract just the category name without the count
    const activeBtn = document.querySelector('.category-btn.active');
    let currentCategory = 'Diagnostic';
    if (activeBtn) {
        currentCategory = activeBtn.textContent.split('(')[0].trim();
    }
    renderInstrumentsList(currentCategory);
    renderTray();
}

function renderTray() {
    const tray = document.getElementById('trayVisual');
    if (!currentProcedure || currentProcedure.instruments.length === 0) {
        tray.innerHTML = '<div style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1rem;"><i class="fas fa-info-circle"></i>&nbsp; Select instruments to populate the tray</div>';
        return;
    }
    let html = '';
    const dynamicDb = getInstrumentDatabase();
    
    currentProcedure.instruments.forEach((instrumentId) => {
        // First check dynamic database
        let instrument = Object.values(dynamicDb).flat().find(i => i.id === instrumentId);
        
        // Fallback to legacy static database for backwards compatibility
        if (!instrument) {
            instrument = Object.values(instrumentDatabase).flat().find(i => i.id === instrumentId);
        }
        
        if (instrument) {
            html += `
                <div class="instrument-slot filled">
                    <div class="instrument-slot-icon"><i class="fas ${instrument.icon}"></i></div>
                    <div class="instrument-name">${instrument.name}</div>
                    <button class="slot-remove-btn" onclick="removeInstrument('${instrumentId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }
    });
    const emptySlots = Math.max(5, 10 - currentProcedure.instruments.length);
    for (let i = 0; i < emptySlots; i++) {
        html += '<div class="instrument-slot"><div class="instrument-slot-label">Empty Slot</div></div>';
    }
    tray.innerHTML = html;
}

function removeInstrument(instrumentId) {
    if (currentProcedure) {
        const index = currentProcedure.instruments.indexOf(instrumentId);
        if (index > -1) {
            currentProcedure.instruments.splice(index, 1);
        }
        renderTray();
        // Get current active category - extract just the category name without the count
        const activeBtn = document.querySelector('.category-btn.active');
        let currentCategory = 'Diagnostic';
        if (activeBtn) {
            currentCategory = activeBtn.textContent.split('(')[0].trim();
        }
        renderInstrumentsList(currentCategory);
    }
}

function saveProcedure() {
    if (!currentProcedure || !currentProcedure.name) {
        alert('Please name the procedure before saving');
        return;
    }
    if (currentProcedure.instruments.length === 0) {
        alert('Please add at least one instrument to the procedure');
        return;
    }
    if (currentProcedureMode === 'new') {
        currentProcedure.id = 'proc-' + Date.now();
        procedureDatabase.push(currentProcedure);
    }
    currentProcedureMode = 'edit';
    saveProcedures(); // Persist to localStorage
    renderProceduresList();
    showNotification(`Procedure "${currentProcedure.name}" saved successfully!`, 'success');
}

function clearProcedure() {
    if (confirm('Clear all instruments from this procedure?')) {
        if (currentProcedure) {
            currentProcedure.instruments = [];
            renderTray();
            renderInstrumentsList(document.querySelector('.category-btn.active')?.textContent.toLowerCase() || 'diagnostic');
            showNotification('Procedure cleared', 'info');
        }
    }
}

function deleteProcedure() {
    if (!currentProcedure) return;
    if (confirm(`Delete procedure "${currentProcedure.name}"?`)) {
        const index = procedureDatabase.findIndex(p => p.id === currentProcedure.id);
        if (index > -1) {
            procedureDatabase.splice(index, 1);
            saveProcedures(); // Persist to localStorage
            currentProcedure = null;
            currentProcedureMode = 'new';
            renderProceduresList();
            renderTray();
            updateDeleteButton();
            showNotification('Procedure deleted', 'success');
        }
    }
}

function updateDeleteButton() {
    const deleteBtn = document.getElementById('deleteProcedureBtn');
    if (currentProcedure && currentProcedureMode === 'edit') {
        deleteBtn.style.display = 'flex';
    } else {
        deleteBtn.style.display = 'none';
    }
}

function saveProcedureTemplate() {
    if (!currentProcedure) {
        alert('Please select or create a procedure first');
        return;
    }
    currentProcedure.isTemplate = true;
    saveProcedures(); // Persist to localStorage
    renderProceduresList();
    showNotification(`"${currentProcedure.name}" saved as template!`, 'success');
}

function openProcedureModal(mode) {
    const modal = document.getElementById('procedureModal');
    const title = document.getElementById('procedureModalTitle');
    if (mode === 'new') {
        title.textContent = 'Create New Procedure';
        document.getElementById('procedureNameInput').value = '';
        document.getElementById('procedureDescInput').value = '';
        document.getElementById('procedureTimeInput').value = '';
        document.getElementById('procedureCategoryInput').value = 'general';
    } else if (currentProcedure) {
        title.textContent = 'Edit Procedure';
        document.getElementById('procedureNameInput').value = currentProcedure.name;
        document.getElementById('procedureDescInput').value = currentProcedure.description;
        document.getElementById('procedureTimeInput').value = currentProcedure.estimatedTime;
        document.getElementById('procedureCategoryInput').value = currentProcedure.category;
    }
    modal.classList.add('active');
}

function closeProcedureModal() {
    document.getElementById('procedureModal').classList.remove('active');
}

function saveProcedureModal() {
    const name = document.getElementById('procedureNameInput').value.trim();
    const desc = document.getElementById('procedureDescInput').value.trim();
    const time = parseInt(document.getElementById('procedureTimeInput').value) || 30;
    const category = document.getElementById('procedureCategoryInput').value;
    if (!name) {
        alert('Please enter a procedure name');
        return;
    }
    if (!currentProcedure) {
        currentProcedure = {
            id: 'proc-' + Date.now(),
            name: name,
            description: desc,
            category: category,
            estimatedTime: time,
            instruments: [],
            createdDate: new Date(),
            isTemplate: false
        };
        procedureDatabase.push(currentProcedure);
        currentProcedureMode = 'edit';
    } else {
        currentProcedure.name = name;
        currentProcedure.description = desc;
        currentProcedure.category = category;
        currentProcedure.estimatedTime = time;
    }
    saveProcedures(); // Persist to localStorage
    renderProceduresList();
    renderTray();
    updateDeleteButton();
    closeProcedureModal();
    showNotification(`Procedure "${name}" updated!`, 'success');
}

// Initialize procedures when page loads

// Bonus Tasks Database - Loaded from API
const bonusTasksDatabase = [];

function toggleBonusTasksPanel() {
    const panel = document.getElementById('bonusTasksPanel');
    if (!panel) {
        console.error('Bonus tasks panel not found');
        return;
    }
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        renderBonusTasks();
    }
}

function closeBonusTasksPanel() {
    const panel = document.getElementById('bonusTasksPanel');
    if (!panel) return;
    panel.classList.remove('active');
}

function minimizeBonusTasksPanel() {
    const panel = document.getElementById('bonusTasksPanel');
    panel.classList.toggle('minimized');
}

function renderBonusTasks() {
    const body = document.getElementById('bonusTasksBody');
    
    // Get bonus tasks from tasksData (database-backed)
    const bonusTasks = window.tasksData.filter(t => t.taskType === 'Bonus' && t.status !== 'Completed' && !t.claimedBy);
    
    if (bonusTasks.length === 0) {
        body.innerHTML = `
            <div class="no-floating-tasks">
                <i class="fas fa-star"></i>
                <p>No bonus tasks available</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem;">You're all caught up!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    bonusTasks.forEach(task => {
        html += `
            <div class="floating-task-item">
                <div class="floating-task-header">
                    <div class="floating-task-title">${task.title}</div>
                    <div class="floating-task-badges">
                        <span class="floating-task-badge" style="background: #eab308; color: white;"><i class="fas fa-star"></i></span>
                    </div>
                </div>
                <div class="floating-task-desc">${task.description}</div>
                <div class="floating-task-meta">
                    <span><i class="fas fa-clock"></i>${task.timeEstimate || task.estimatedTime + ' mins'}</span>
                    <span><i class="fas fa-map-marker-alt"></i>${task.location || 'Any Location'}</span>
                    <span><i class="fas fa-calendar"></i>Due: ${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'Flexible'}</span>
                    <span style="color: #eab308; font-weight: 600;"><i class="fas fa-star"></i>$${task.payAmount || '0'}</span>
                </div>
                <div class="floating-task-actions">
                    <button class="claim-task-btn" onclick="claimBonusTask('${task.id}')">
                        <i class="fas fa-hand-pointer"></i>
                        Claim This Bonus
                    </button>
                    <button class="dismiss-task-btn" onclick="dismissBonusTask('${task.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    body.innerHTML = html;
}

window.addEventListener('load', function() {
    setTimeout(() => {
        try {
            if (typeof initializeResourcesMap === 'function') {
                initializeResourcesMap();
            }
        } catch (e) {
            console.warn('Could not initialize resources:', e.message);
        }
        if (typeof updateFilterUI === 'function') {
            updateFilterUI();
        }
        initProceduresModule();
        
        // Initialize floating tasks
        if (typeof updateFloatingTasksCount === 'function') {
            updateFloatingTasksCount();
        }
        
        // Initialize bonus tasks
        if (typeof updateBonusTasksCount === 'function') {
            updateBonusTasksCount();
        }
    }, 500);
});

        // =============== WORKING HOURS CALENDAR FUNCTIONS ===============
        let whCurrentDate = new Date();
                let whCurrentView = 'month';


        // Staff data - Loaded dynamically from User Management
        // Use employeeResources which is populated from localStorage
        function getWhStaffDatabase() {
            return employeeResources.map((emp, index) => ({
                id: index + 1,
                name: emp.title,
                initials: emp.title.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(),
                role: emp.extendedProps?.role || 'Staff',
                type: emp.extendedProps?.type || 'assistant',
                clinics: emp.extendedProps?.clinics || []
            }));
        }

        // Clinic details - Loaded from masterData
        function getClinicDetails() {
            const details = {};
            masterData.clinics.forEach(clinic => {
                details[clinic.id] = {
                    name: clinic.name,
                    color: clinic.color || '#10b981',
                    shortName: clinic.name.split(' ')[0]
                };
            });
            return details;
        }

        // Rooms for each clinic - Loaded from masterData
        function getClinicRooms() {
            const rooms = {};
            masterData.clinics.forEach(clinic => {
                rooms[clinic.id] = masterData.getRoomsByClinic(clinic.id).map(r => r.name);
            });
            return rooms;
        }

        // Provider-Assistant-Room assignments - Loaded from schedules (localStorage)
        function getProviderAssignments() {
            const assignments = {};
            // Initialize empty assignments for each clinic
            masterData.clinics.forEach(clinic => {
                assignments[clinic.id] = [];
            });
            
            // Load from saved schedules if available
            const savedSchedules = localStorage.getItem('scheduleData');
            if (savedSchedules) {
                try {
                    const schedules = JSON.parse(savedSchedules);
                    // Process schedules into assignments
                    schedules.forEach(schedule => {
                        const clinicId = masterData.getClinicByName(schedule.clinic)?.id;
                        if (clinicId && assignments[clinicId]) {
                            assignments[clinicId].push({
                                providerId: null,
                                providerName: schedule.provider || schedule.employee,
                                assistantId: null,
                                assistantName: schedule.assistant,
                                room: schedule.room,
                                shift: `${schedule.startTime || '08:00'}-${schedule.endTime || '16:00'}`
                            });
                        }
                    });
                } catch (e) {
                    console.warn('Could not parse schedule data:', e);
                }
            }
            return assignments;
        }

        // Legacy compatibility - these will reference the dynamic functions
        const whStaffDatabase = [];
        const clinicDetails = {};
        const clinicRooms = {};
        const providerAssignments = {};
        
        const clinics = [];

        // Shift patterns - will be generated dynamically based on user schedules
        // For now, default to standard weekday schedule
        function getEmployeeShiftPattern(employeeId) {
            // Check if there's a saved schedule for this employee
            const savedSchedules = localStorage.getItem('employeeSchedules');
            if (savedSchedules) {
                try {
                    const schedules = JSON.parse(savedSchedules);
                    if (schedules[employeeId]) {
                        return schedules[employeeId];
                    }
                } catch (e) {}
            }
            
            // Default: weekdays 8-4, weekends off
            return (dayOfWeek) => {
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    return { type: 'off', start: '', end: '' };
                }
                return { type: 'morning', start: '08:00', end: '16:00' };
            };
        }

        const employeeShiftPatterns = {};

        function whGenerateShifts(employeeId, date) {
            const dayOfWeek = date.getDay();
            const dateStr = date.toISOString().split('T')[0];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Get pattern function for this employee
            const patternFn = employeeShiftPatterns[employeeId] || getEmployeeShiftPattern(employeeId);
            
            if (!patternFn) {
                return { date: dateStr, type: 'off', startTime: '', endTime: '' };
            }
            
            const pattern = patternFn(dayOfWeek);
            return { date: dateStr, type: pattern.type, startTime: pattern.start, endTime: pattern.end };
        }


        function generateWorkingHoursEventsForRange(startDate, endDate) {
            const events = [];

            // If working hours are not toggled on, return empty list
            if (!showWorkingHours) {
                return events;
            }

            if (!startDate || !endDate) {
                return events;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (!employeeResources || !Array.isArray(employeeResources) || employeeResources.length === 0) {
                console.warn('employeeResources not available for working hours');
                return events;
            }

            // Normalize to date-only loop
            let current = new Date(start.getFullYear(), start.getMonth(), start.getDate());
            const last = new Date(end.getFullYear(), end.getMonth(), end.getDate());

            while (current <= last) {
                employeeResources.forEach(employee => {
                    const shift = whGenerateShifts(employee.id, current);
                    if (!shift || shift.type === 'off' || !shift.startTime || !shift.endTime) {
                        return;
                    }

                    const dateStr = shift.date;
                    const startIso = dateStr + 'T' + shift.startTime + ':00';
                    const endIso = dateStr + 'T' + shift.endTime + ':00';
                    
                    // Find clinic and assignment info for this employee
                    let clinicInfo = null;
                    let assignmentInfo = null;
                    
                    // Map employee IDs to provider/assistant IDs for matching
                    const employeeMapping = {
                        'dr-sarah-johnson': { type: 'provider', id: 1 },
                        'dr-michael-chen': { type: 'provider', id: 2 },
                        'dr-robert-lee': { type: 'provider', id: 6 },
                        'dr-patricia-martinez': { type: 'provider', id: 7 },
                        'dr-jennifer-garcia': { type: 'provider', id: 10 },
                        'dr-william-taylor': { type: 'provider', id: 11 },
                        'emma-rodriguez': { type: 'assistant', id: 3 },
                        'james-williams': { type: 'assistant', id: 4 },
                        'lisa-anderson': { type: 'assistant', id: 5 },
                        'david-kim': { type: 'assistant', id: 8 },
                        'susan-brown': { type: 'assistant', id: 9 },
                        'michelle-white': { type: 'assistant', id: 12 }
                    };
                    
                    const empMapping = employeeMapping[employee.id];
                    
                    for (const [clinicId, assignments] of Object.entries(providerAssignments)) {
                        let assignment = null;
                        
                        if (empMapping) {
                            if (empMapping.type === 'provider') {
                                assignment = assignments.find(a => a.providerId === empMapping.id);
                            } else if (empMapping.type === 'assistant') {
                                assignment = assignments.find(a => a.assistantId === empMapping.id);
                            }
                        }
                        
                        // Fallback to name matching
                        if (!assignment) {
                            assignment = assignments.find(a => 
                                a.providerName === employee.title || a.assistantName === employee.title
                            );
                        }
                        
                        if (assignment) {
                            clinicInfo = clinics.find(c => c.id === clinicId);
                            assignmentInfo = assignment;
                            break;
                        }
                    }

                    events.push({
                        id: 'wh-' + employee.id + '-' + dateStr,
                        title: employee.title + ' â€“ Working Hours',
                        start: startIso,
                        end: endIso,
                        employee: employee.id,
                        resourceId: employee.id,
                        type: 'working-hours',
                        eventCategory: 'general',
                        isWorkingHours: true,
                        shiftType: shift.type,
                        extendedProps: {
                            employeeName: employee.title,
                            shiftStart: shift.startTime,
                            shiftEnd: shift.endTime,
                            clinic: clinicInfo ? clinicInfo.name : 'Unassigned',
                            clinicId: clinicInfo ? clinicInfo.id : null,
                            room: assignmentInfo ? assignmentInfo.room : 'N/A',
                            isProvider: assignmentInfo && (assignmentInfo.providerId === empMapping?.id || assignmentInfo.providerName === employee.title),
                            isAssistant: assignmentInfo && (assignmentInfo.assistantId === empMapping?.id || assignmentInfo.assistantName === employee.title),
                            providerName: assignmentInfo && (assignmentInfo.assistantId === empMapping?.id || assignmentInfo.assistantName === employee.title) ? assignmentInfo.providerName : null,
                            assistantName: assignmentInfo && (assignmentInfo.providerId === empMapping?.id || assignmentInfo.providerName === employee.title) ? assignmentInfo.assistantName : null
                        }
                    });
                });

                current.setDate(current.getDate() + 1);
            }

            return events;
        }


        function closeWorkingHours() {
            document.getElementById('workingHoursContainer').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // Initialize working hours calendar
        function renderWorkingHoursCalendar() {
            whRenderCalendar();
        }
        
        // Show shift details modal for working hours
        function showWorkingHoursShiftDetails(event) {
            const props = event.extendedProps || {};
            const employeeName = props.employeeName || event.title.replace(' â€“ Working Hours', '');
            const shiftStart = props.shiftStart || 'N/A';
            const shiftEnd = props.shiftEnd || 'N/A';
            const clinic = props.clinic || 'Unassigned';
            const room = props.room || 'N/A';
            const isProvider = props.isProvider;
            const isAssistant = props.isAssistant;
            const providerName = props.providerName;
            const assistantName = props.assistantName;
            
            const role = isProvider ? 'Provider' : isAssistant ? 'Assistant' : 'Staff';
            
            let relationshipInfo = '';
            if (isProvider && assistantName) {
                relationshipInfo = `<div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-top: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ‘¥ Assistant:</div>
                    <div style="font-weight: 600; color: var(--text-primary);">${assistantName}</div>
                </div>`;
            } else if (isAssistant && providerName) {
                relationshipInfo = `<div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-top: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ‘¨â€âš•ï¸ Provider:</div>
                    <div style="font-weight: 600; color: var(--text-primary);">${providerName}</div>
                </div>`;
            }
            
            const modalHtml = `
                <div id="shiftDetailsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                    <i class="fas fa-clock" style="color: #10b981; margin-right: 0.5rem;"></i>
                                    Working Hours Shift
                                </h3>
                                <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.9rem;">${event.start.split('T')[0]}</p>
                            </div>
                            <button onclick="document.getElementById('shiftDetailsModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="padding: 1rem; background: var(--accent-light); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ðŸ‘¤ Employee</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${employeeName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">${role}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">â° Start Time</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${shiftStart}</div>
                                </div>
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">â° End Time</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${shiftEnd}</div>
                                </div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ¥ Clinic</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${clinic}</div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸšª Room</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${room}</div>
                            </div>
                            
                            ${relationshipInfo}
                        </div>
                        
                        <button onclick="document.getElementById('shiftDetailsModal').remove()" style="margin-top: 1.5rem; width: 100%; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            // Close on background click
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'shiftDetailsModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        }

        // Show shift detail with Edit and Delete options - CRUD operations
        window.showShiftDetail = function(shiftId) {
            const shift = window.myScheduleShifts.find(s => s.id === shiftId);
            if (!shift) {
                alert('Shift not found!');
                return;
            }
            
            // Find ALL related shifts (same provider, clinic, time) to show merged view
            const relatedShifts = window.myScheduleShifts.filter(s => 
                (s.name || '').trim() === (shift.name || '').trim() &&
                (s.clinic || '').trim() === (shift.clinic || '').trim() &&
                (s.startTime || '').trim() === (shift.startTime || '').trim() &&
                (s.endTime || '').trim() === (shift.endTime || '').trim()
            );
            
            // Collect all related shift IDs for group operations
            const relatedShiftIds = relatedShifts.map(s => s.id);
            
            // Merge rooms from all related shifts
            const allRooms = [];
            relatedShifts.forEach(s => {
                if (s.room && !allRooms.includes(s.room)) {
                    allRooms.push(s.room);
                }
            });
            const mergedRooms = allRooms.join(', ');
            
            // Merge assistants from all related shifts
            const allAssistants = [];
            relatedShifts.forEach(s => {
                if (s.assistant) {
                    s.assistant.split(', ').forEach(a => {
                        if (a.trim() && !allAssistants.includes(a.trim())) {
                            allAssistants.push(a.trim());
                        }
                    });
                }
            });
            const mergedAssistants = allAssistants.join(', ');
            
            // Convert times to 12-hour format
            function convertTo12HourFormat(time24) {
                if (!time24) return time24;
                const [hours, minutes] = time24.split(':');
                let hours24 = parseInt(hours);
                const period = hours24 >= 12 ? 'PM' : 'AM';
                hours24 = hours24 % 12 || 12;
                return `${hours24}:${minutes} ${period}`;
            }
            
            const startTimeDisplay = convertTo12HourFormat(shift.startTime);
            const endTimeDisplay = convertTo12HourFormat(shift.endTime);
            
            const assistantInfo = mergedAssistants ? `
                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-top: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ‘¥ Assistant(s):</div>
                    <div style="font-weight: 600; color: var(--text-primary);">${mergedAssistants}</div>
                </div>
            ` : `
                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-top: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">No Assistant Assigned</div>
                </div>
            `;
            
            const dateRange = shift.startDate && shift.endDate 
                ? `${new Date(shift.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${new Date(shift.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`
                : 'Recurring Schedule';
            
            // Show count if multiple schedules are merged
            const scheduleCountInfo = relatedShifts.length > 1 
                ? `<div style="font-size: 0.75rem; color: var(--accent-primary); margin-top: 0.25rem;"><i class="fas fa-layer-group" style="margin-right: 0.3rem;"></i>${relatedShifts.length} schedules merged</div>` 
                : '';
            
            const modalHtml = `
                <div id="shiftDetailsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                    <i class="fas fa-calendar-check" style="color: ${shift.color}; margin-right: 0.5rem;"></i>
                                    Schedule Details
                                </h3>
                                ${scheduleCountInfo}
                            </div>
                            <button onclick="document.getElementById('shiftDetailsModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="padding: 1rem; background: var(--accent-light); border-radius: 8px; border-left: 4px solid ${shift.color};">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ðŸ‘¤ Provider/Employee</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${shift.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">${shift.role}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">â° Start Time</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${startTimeDisplay}</div>
                                </div>
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">â° End Time</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${endTimeDisplay}</div>
                                </div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ¥ Clinic</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${shift.clinic}</div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸšª Room(s)</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${mergedRooms || 'N/A'}</div>
                            </div>
                            
                            ${assistantInfo}
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ“… Working Days</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${shift.days ? shift.days.join(', ') : 'N/A'}</div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ“† Date Range</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${dateRange}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                            <button onclick="editShiftGroup('${relatedShiftIds.join(',')}')" style="flex: 1; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteShiftGroup('${relatedShiftIds.join(',')}')" style="flex: 1; padding: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-trash"></i> Delete ${relatedShifts.length > 1 ? 'All' : ''}
                            </button>
                        </div>
                        
                        <button onclick="document.getElementById('shiftDetailsModal').remove()" style="margin-top: 0.75rem; width: 100%; padding: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'shiftDetailsModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        };
        
        // Delete Shift Function
        window.deleteShift = function(shiftId) {
            const shift = window.myScheduleShifts.find(s => s.id === shiftId);
            if (!shift) {
                alert('Shift not found!');
                return;
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete this schedule?\n\n${shift.name}\n${shift.clinic} - ${shift.room}\n${shift.days?.join(', ')}\n${shift.startTime} - ${shift.endTime}\n\nThis action cannot be undone.`);
            
            if (confirmDelete) {
                // Remove from array
                const index = window.myScheduleShifts.findIndex(s => s.id === shiftId);
                if (index > -1) {
                    window.myScheduleShifts.splice(index, 1);
                    console.log('ðŸ—‘ï¸ Shift deleted:', shiftId);
                    
                    // Close modal
                    const modal = document.getElementById('shiftDetailsModal');
                    if (modal) modal.remove();
                    
                    // Refresh calendar
                    if (typeof window.renderMyScheduleCalendar === 'function') {
                        window.renderMyScheduleCalendar();
                    }
                    
                    alert('âœ… Schedule deleted successfully!');
                }
            }
        };
        
        // Edit Shift Function - Opens edit modal
        window.editShift = function(shiftId) {
            const shift = window.myScheduleShifts.find(s => s.id === shiftId);
            if (!shift) {
                alert('Shift not found!');
                return;
            }
            
            // Close the details modal first
            const detailsModal = document.getElementById('shiftDetailsModal');
            if (detailsModal) detailsModal.remove();
            
            // Get options from masterData
            const providers = window.masterData ? window.masterData.getProviders() : [];
            const assistants = window.masterData ? window.masterData.getAssistants() : [];
            const clinics = window.masterData ? window.masterData.clinics : [];
            const rooms = window.masterData ? window.masterData.rooms : [];
            const timeSlots = window.masterData ? window.masterData.timeSlots : [];
            
            // Build provider options
            let providerOptions = providers.map(p => 
                `<option value="${p.title}" ${shift.name === p.title ? 'selected' : ''}>${p.title}</option>`
            ).join('');
            
            // Build assistant options
            let assistantOptions = `<option value="">None</option>` + assistants.map(a => 
                `<option value="${a.title}" ${shift.assistant === a.title ? 'selected' : ''}>${a.title}</option>`
            ).join('');
            
            // Build clinic options
            let clinicOptions = clinics.map(c => 
                `<option value="${c.name}" ${shift.clinic === c.name ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            // Build room options
            let roomOptions = rooms.map(r => 
                `<option value="${r.name}" ${shift.room === r.name ? 'selected' : ''}>${r.name}</option>`
            ).join('');
            
            // Build time slot options
            let timeOptions = timeSlots.map(t => {
                const timeValue = t.name;
                const currentTime = `${shift.startTime} - ${shift.endTime}`;
                return `<option value="${t.name}" ${currentTime === t.name ? 'selected' : ''}>${t.name}</option>`;
            }).join('');
            
            // Days checkboxes
            const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let daysCheckboxes = daysOfWeek.map(day => `
                <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                    <input type="checkbox" id="editDay${day}" ${shift.days?.includes(day) ? 'checked' : ''}>
                    <span style="font-size: 0.85rem;">${day}</span>
                </label>
            `).join('');
            
            const modalHtml = `
                <div id="editShiftModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 1rem;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 2rem; max-width: 550px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                    <i class="fas fa-edit" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                                    Edit Schedule
                                </h3>
                                <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.8rem;">ID: ${shift.id}</p>
                            </div>
                            <button onclick="document.getElementById('editShiftModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="editShiftForm" style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="hidden" id="editShiftId" value="${shift.id}">
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-user-md" style="margin-right: 0.3rem; color: #10b981;"></i>Provider/Employee
                                </label>
                                <select id="editShiftProvider" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${providerOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-hospital" style="margin-right: 0.3rem; color: #f59e0b;"></i>Clinic
                                </label>
                                <select id="editShiftClinic" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${clinicOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-door-open" style="margin-right: 0.3rem; color: #8b5cf6;"></i>Room
                                </label>
                                <select id="editShiftRoom" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${roomOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-user-nurse" style="margin-right: 0.3rem; color: #ec4899;"></i>Assistant
                                </label>
                                <select id="editShiftAssistant" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${assistantOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-clock" style="margin-right: 0.3rem; color: #0891b2;"></i>Time Slot
                                </label>
                                <select id="editShiftTime" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${timeOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-calendar-day" style="margin-right: 0.3rem; color: #ef4444;"></i>Working Days
                                </label>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    ${daysCheckboxes}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                        <i class="fas fa-calendar" style="margin-right: 0.3rem;"></i>Start Date
                                    </label>
                                    <input type="date" id="editShiftStartDate" value="${shift.startDate || ''}" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                        <i class="fas fa-calendar" style="margin-right: 0.3rem;"></i>End Date
                                    </label>
                                    <input type="date" id="editShiftEndDate" value="${shift.endDate || ''}" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                </div>
                            </div>
                        </form>
                        
                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                            <button onclick="saveShiftEdit()" style="flex: 1; padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button onclick="document.getElementById('editShiftModal').remove()" style="flex: 1; padding: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'editShiftModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        };
        
        // Save Shift Edit
        window.saveShiftEdit = function() {
            const shiftId = document.getElementById('editShiftId').value;
            const shiftIndex = window.myScheduleShifts.findIndex(s => s.id === shiftId);
            
            if (shiftIndex === -1) {
                alert('Shift not found!');
                return;
            }
            
            // Get form values
            const provider = document.getElementById('editShiftProvider').value;
            const clinic = document.getElementById('editShiftClinic').value;
            const room = document.getElementById('editShiftRoom').value;
            const assistant = document.getElementById('editShiftAssistant').value || null;
            const timeSlot = document.getElementById('editShiftTime').value;
            const startDate = document.getElementById('editShiftStartDate').value;
            const endDate = document.getElementById('editShiftEndDate').value;
            
            // Get selected days
            const days = [];
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
                if (document.getElementById('editDay' + day)?.checked) {
                    days.push(day);
                }
            });
            
            if (days.length === 0) {
                alert('Please select at least one working day.');
                return;
            }
            
            // Parse time slot
            const timeParts = timeSlot.split(' - ');
            const startTime = timeParts[0] || '08:00';
            const endTime = timeParts[1] || '16:00';
            
            // Get clinic color
            const clinicData = window.masterData?.getClinicByName(clinic);
            const color = clinicData?.color || window.myScheduleShifts[shiftIndex].color;
            
            // Update the shift
            window.myScheduleShifts[shiftIndex] = {
                ...window.myScheduleShifts[shiftIndex],
                name: provider,
                clinic: clinic,
                room: room,
                assistant: assistant,
                startTime: startTime,
                endTime: endTime,
                days: days,
                startDate: startDate,
                endDate: endDate,
                color: color
            };
            
            console.log('âœï¸ Shift updated:', window.myScheduleShifts[shiftIndex]);
            
            // Close modal
            const modal = document.getElementById('editShiftModal');
            if (modal) modal.remove();
            
            // Refresh calendar
            if (typeof window.renderMyScheduleCalendar === 'function') {
                window.renderMyScheduleCalendar();
            }
            
            alert('âœ… Schedule updated successfully!');
        };
        
        // Delete Shift Group Function - Deletes all related shifts
        window.deleteShiftGroup = function(shiftIdsString) {
            const shiftIds = shiftIdsString.split(',').filter(id => id.trim());
            
            if (shiftIds.length === 0) {
                alert('No shifts to delete!');
                return;
            }
            
            const firstShift = window.myScheduleShifts.find(s => s.id === shiftIds[0]);
            if (!firstShift) {
                alert('Shift not found!');
                return;
            }
            
            const message = shiftIds.length > 1 
                ? `Are you sure you want to delete ALL ${shiftIds.length} related schedules?\n\n${firstShift.name}\n${firstShift.clinic}\n${firstShift.days?.join(', ')}\n${firstShift.startTime} - ${firstShift.endTime}\n\nThis will delete all rooms assigned to this time slot. This action cannot be undone.`
                : `Are you sure you want to delete this schedule?\n\n${firstShift.name}\n${firstShift.clinic} - ${firstShift.room}\n${firstShift.days?.join(', ')}\n${firstShift.startTime} - ${firstShift.endTime}\n\nThis action cannot be undone.`;
            
            const confirmDelete = confirm(message);
            
            if (confirmDelete) {
                let deletedCount = 0;
                
                // Delete all shifts with these IDs (in reverse order to avoid index issues)
                shiftIds.forEach(shiftId => {
                    const index = window.myScheduleShifts.findIndex(s => s.id === shiftId);
                    if (index > -1) {
                        window.myScheduleShifts.splice(index, 1);
                        deletedCount++;
                    }
                });
                
                console.log(`ðŸ—‘ï¸ Deleted ${deletedCount} shift(s)`);
                
                // Close modal
                const modal = document.getElementById('shiftDetailsModal');
                if (modal) modal.remove();
                
                // Refresh calendar
                if (typeof window.renderMyScheduleCalendar === 'function') {
                    window.renderMyScheduleCalendar();
                }
                
                alert(`âœ… ${deletedCount > 1 ? deletedCount + ' schedules' : 'Schedule'} deleted successfully!`);
            }
        };
        
        // Edit Shift Group Function - Opens edit modal for all related shifts
        window.editShiftGroup = function(shiftIdsString) {
            const shiftIds = shiftIdsString.split(',').filter(id => id.trim());
            
            if (shiftIds.length === 0) {
                alert('No shifts to edit!');
                return;
            }
            
            // Get the first shift as reference
            const shift = window.myScheduleShifts.find(s => s.id === shiftIds[0]);
            if (!shift) {
                alert('Shift not found!');
                return;
            }
            
            // Collect all rooms from the group
            const allRooms = [];
            shiftIds.forEach(id => {
                const s = window.myScheduleShifts.find(sh => sh.id === id);
                if (s && s.room && !allRooms.includes(s.room)) {
                    allRooms.push(s.room);
                }
            });
            
            // Close the details modal first
            const detailsModal = document.getElementById('shiftDetailsModal');
            if (detailsModal) detailsModal.remove();
            
            // Get options from masterData
            const providers = window.masterData ? window.masterData.getProviders() : [];
            const assistants = window.masterData ? window.masterData.getAssistants() : [];
            const clinics = window.masterData ? window.masterData.clinics : [];
            const rooms = window.masterData ? window.masterData.rooms : [];
            const timeSlots = window.masterData ? window.masterData.timeSlots : [];
            
            // Build provider options
            let providerOptions = providers.map(p => 
                `<option value="${p.title}" ${shift.name === p.title ? 'selected' : ''}>${p.title}</option>`
            ).join('');
            
            // Build assistant checkboxes (multi-select)
            const currentAssistants = shift.assistant ? shift.assistant.split(', ').map(a => a.trim()) : [];
            let assistantCheckboxes = assistants.map(a => `
                <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer; padding: 0.3rem;">
                    <input type="checkbox" class="editGroupAssistant" value="${a.title}" ${currentAssistants.includes(a.title) ? 'checked' : ''}>
                    <span style="font-size: 0.85rem;">${a.title}</span>
                </label>
            `).join('');
            
            // Build clinic options
            let clinicOptions = clinics.map(c => 
                `<option value="${c.name}" ${shift.clinic === c.name ? 'selected' : ''}>${c.name}</option>`
            ).join('');
            
            // Build room options (checkboxes for multi-select)
            let roomCheckboxes = rooms.map(r => `
                <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer; padding: 0.3rem;">
                    <input type="checkbox" class="editGroupRoom" value="${r.name}" ${allRooms.includes(r.name) ? 'checked' : ''}>
                    <span style="font-size: 0.85rem;">${r.name} <span style="color: var(--text-secondary); font-size: 0.75rem;">(${r.clinic})</span></span>
                </label>
            `).join('');
            
            // Build time slot options
            let timeOptions = timeSlots.map(t => {
                const timeValue = t.name;
                const currentTime = `${shift.startTime} - ${shift.endTime}`;
                return `<option value="${t.name}" ${currentTime === t.name ? 'selected' : ''}>${t.name}</option>`;
            }).join('');
            
            // Days checkboxes
            const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let daysCheckboxes = daysOfWeek.map(day => `
                <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                    <input type="checkbox" id="editGroupDay${day}" ${shift.days?.includes(day) ? 'checked' : ''}>
                    <span style="font-size: 0.85rem;">${day}</span>
                </label>
            `).join('');
            
            const roomsInfo = allRooms.length > 1 
                ? `<div style="color: #f59e0b; font-size: 0.8rem; margin-bottom: 0.5rem;"><i class="fas fa-info-circle"></i> Editing ${allRooms.length} rooms: ${allRooms.join(', ')}</div>`
                : '';
            
            const modalHtml = `
                <div id="editShiftModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 1rem;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 2rem; max-width: 550px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                    <i class="fas fa-edit" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                                    Edit Schedule Group
                                </h3>
                                ${roomsInfo}
                            </div>
                            <button onclick="document.getElementById('editShiftModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="editShiftGroupForm" style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="hidden" id="editGroupShiftIds" value="${shiftIds.join(',')}">
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-user-md" style="margin-right: 0.3rem; color: #10b981;"></i>Provider/Employee
                                </label>
                                <select id="editGroupProvider" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${providerOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-hospital" style="margin-right: 0.3rem; color: #f59e0b;"></i>Clinic
                                </label>
                                <select id="editGroupClinic" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${clinicOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-door-open" style="margin-right: 0.3rem; color: #8b5cf6;"></i>Rooms (select multiple)
                                </label>
                                <div style="max-height: 150px; overflow-y: auto; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px;">
                                    ${roomCheckboxes}
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-user-nurse" style="margin-right: 0.3rem; color: #ec4899;"></i>Assistants (select multiple)
                                </label>
                                <div style="max-height: 150px; overflow-y: auto; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px;">
                                    ${assistantCheckboxes}
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                    <i class="fas fa-clock" style="margin-right: 0.3rem; color: #0891b2;"></i>Time Slot
                                </label>
                                <select id="editGroupTime" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                    ${timeOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-calendar-day" style="margin-right: 0.3rem; color: #ef4444;"></i>Working Days
                                </label>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    ${daysCheckboxes}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                        <i class="fas fa-calendar" style="margin-right: 0.3rem;"></i>Start Date
                                    </label>
                                    <input type="date" id="editGroupStartDate" value="${shift.startDate || ''}" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3rem;">
                                        <i class="fas fa-calendar" style="margin-right: 0.3rem;"></i>End Date
                                    </label>
                                    <input type="date" id="editGroupEndDate" value="${shift.endDate || ''}" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-secondary);">
                                </div>
                            </div>
                        </form>
                        
                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                            <button onclick="saveShiftGroupEdit()" style="flex: 1; padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button onclick="document.getElementById('editShiftModal').remove()" style="flex: 1; padding: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'editShiftModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        };
        
        // Save Shift Group Edit
        window.saveShiftGroupEdit = function() {
            const shiftIdsString = document.getElementById('editGroupShiftIds').value;
            const shiftIds = shiftIdsString.split(',').filter(id => id.trim());
            
            if (shiftIds.length === 0) {
                alert('No shifts to update!');
                return;
            }
            
            // Get form values
            const provider = document.getElementById('editGroupProvider').value;
            const clinic = document.getElementById('editGroupClinic').value;
            const timeSlot = document.getElementById('editGroupTime').value;
            const startDate = document.getElementById('editGroupStartDate').value;
            const endDate = document.getElementById('editGroupEndDate').value;
            
            // Get selected rooms
            const selectedRooms = [];
            document.querySelectorAll('.editGroupRoom:checked').forEach(cb => {
                selectedRooms.push(cb.value);
            });
            
            if (selectedRooms.length === 0) {
                alert('Please select at least one room.');
                return;
            }
            
            // Get selected assistants
            const selectedAssistants = [];
            document.querySelectorAll('.editGroupAssistant:checked').forEach(cb => {
                selectedAssistants.push(cb.value);
            });
            const assistantString = selectedAssistants.join(', ');
            
            // Get selected days
            const days = [];
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
                if (document.getElementById('editGroupDay' + day)?.checked) {
                    days.push(day);
                }
            });
            
            if (days.length === 0) {
                alert('Please select at least one working day.');
                return;
            }
            
            // Parse time slot
            const timeParts = timeSlot.split(' - ');
            const startTime = timeParts[0] || '08:00';
            const endTime = timeParts[1] || '16:00';
            
            // Get clinic color
            const clinicData = window.masterData?.getClinicByName(clinic);
            const color = clinicData?.color || '#3b82f6';
            
            // Get role from provider
            const providerData = window.masterData?.employees?.find(e => e.title === provider);
            const role = providerData?.role || 'Staff';
            
            // Delete all old shifts
            shiftIds.forEach(shiftId => {
                const index = window.myScheduleShifts.findIndex(s => s.id === shiftId);
                if (index > -1) {
                    window.myScheduleShifts.splice(index, 1);
                }
            });
            
            // Create new shifts for each selected room
            const timestamp = Date.now();
            selectedRooms.forEach((room, index) => {
                const newShift = {
                    id: `shift-${timestamp}-${index}`,
                    name: provider,
                    role: role,
                    clinic: clinic,
                    room: room,
                    assistant: assistantString || null,
                    startTime: startTime,
                    endTime: endTime,
                    days: days,
                    startDate: startDate,
                    endDate: endDate,
                    color: color
                };
                window.myScheduleShifts.push(newShift);
            });
            
            console.log(`âœï¸ Updated group: ${selectedRooms.length} shift(s) created`);
            
            // Close modal
            const modal = document.getElementById('editShiftModal');
            if (modal) modal.remove();
            
            // Refresh calendar
            if (typeof window.renderMyScheduleCalendar === 'function') {
                window.renderMyScheduleCalendar();
            }
            
            alert(`âœ… Schedule updated successfully! (${selectedRooms.length} room(s))`);
        };

        // ==========================================
        // TASK MANAGEMENT SYSTEM - FULL CRUD
        // ==========================================
        
        // Global Tasks Data Store - Loaded from API
        window.tasksData = [];
        
        // Global Duties Data Store - Loaded from API
        window.dutiesData = [];
        
        // Load Duties from API
        async function loadDutiesFromAPI() {
            try {
                const response = await fetch('/api/duties');
                if (response.ok) {
                    window.dutiesData = await response.json();
                    console.log('Loaded duties from API:', window.dutiesData.length);
                    renderDutiesCheckboxes();
                    renderMyDuties();
                    return window.dutiesData;
                }
            } catch (error) {
                console.error('Error loading duties:', error);
            }
            return [];
        }
        
        // Render duties checkboxes in user creation form
        function renderDutiesCheckboxes() {
            const container = document.getElementById('dutiesCheckboxContainer');
            if (!container) return;
            
            if (window.dutiesData.length === 0) {
                container.innerHTML = `
                    <div style="color: var(--text-tertiary); font-style: italic; padding: 1rem; grid-column: 1 / -1; text-align: center;">
                        <i class="fas fa-info-circle"></i> No duties available. Create duties in the Duties management section.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.dutiesData.map(duty => `
                <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: var(--card-bg); border-radius: 6px; cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--accent-primary)'" 
                       onmouseout="this.style.borderColor='var(--border-color)'">
                    <input type="checkbox" name="selectedDuties" value="${duty.Id}" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${duty.Name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                            <i class="fas fa-clock" style="margin-right: 0.25rem;"></i>${duty.ScheduleTime || duty.Schedule}
                            ${duty.ScheduleDay ? `<span style="margin-left: 0.5rem;"><i class="fas fa-calendar" style="margin-right: 0.25rem;"></i>${duty.ScheduleDay}</span>` : ''}
                        </div>
                        ${duty.Description ? `<div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem;">${duty.Description.substring(0, 60)}${duty.Description.length > 60 ? '...' : ''}</div>` : ''}
                    </div>
                </label>
            `).join('');
        }
        
        // Select/Clear all duties
        function selectAllDuties() {
            document.querySelectorAll('input[name="selectedDuties"]').forEach(cb => cb.checked = true);
        }
        
        function clearAllDuties() {
            document.querySelectorAll('input[name="selectedDuties"]').forEach(cb => cb.checked = false);
        }
        
        // Get selected duty IDs
        function getSelectedDutyIds() {
            const selected = [];
            document.querySelectorAll('input[name="selectedDuties"]:checked').forEach(cb => {
                selected.push(parseInt(cb.value));
            });
            return selected;
        }
        
        // Assign duties to user
        async function assignDutiesToUser(userId, dutyIds) {
            try {
                for (const dutyId of dutyIds) {
                    await fetch(`/api/duties/${dutyId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...window.dutiesData.find(d => d.Id === dutyId),
                            assignedToUserId: userId
                        })
                    });
                }
                console.log(`Assigned ${dutyIds.length} duties to user ${userId}`);
            } catch (error) {
                console.error('Error assigning duties:', error);
            }
        }
        
        // Render My Duties in the duties view
        function renderMyDuties() {
            const container = document.getElementById('myDutiesContainer');
            if (!container) return;
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Filter duties for current user if logged in
            let myDuties = window.dutiesData;
            if (currentUser && currentUser.id) {
                myDuties = window.dutiesData.filter(d => d.AssignedToUserId == currentUser.id);
            }
            
            if (myDuties.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-clipboard-check" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p>No duties assigned</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Talk to your supervisor to get duties assigned.</p>
                    </div>
                `;
                return;
            }
            
            const priorityColors = {
                'High': '#ef4444',
                'Medium': '#eab308',
                'Low': '#10b981'
            };
            
            container.innerHTML = myDuties.map(duty => `
                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${priorityColors[duty.Priority] || '#3b82f6'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${duty.Name}</div>
                        <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: ${priorityColors[duty.Priority] || '#3b82f6'}20; color: ${priorityColors[duty.Priority] || '#3b82f6'}; border-radius: 4px;">${duty.Priority}</span>
                    </div>
                    ${duty.Description ? `<div style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.25rem;">${duty.Description}</div>` : ''}
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        ${duty.ScheduleTime ? `<span><i class="fas fa-clock"></i> ${duty.ScheduleTime}</span>` : ''}
                        ${duty.ScheduleDay ? `<span><i class="fas fa-calendar"></i> ${duty.ScheduleDay}</span>` : ''}
                        ${duty.Schedule && !duty.ScheduleTime && !duty.ScheduleDay ? `<span><i class="fas fa-sync"></i> ${duty.Schedule}</span>` : ''}
                        ${duty.Location ? `<span><i class="fas fa-map-marker-alt"></i> ${duty.Location}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Duties Management Modal Functions
        let editingDutyId = null;
        
        function openDutiesManagement() {
            const modal = document.getElementById('dutiesManagementModal');
            if (modal) {
                modal.style.display = 'flex';
                renderDutiesList();
            }
        }
        
        function closeDutiesManagement() {
            const modal = document.getElementById('dutiesManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
            editingDutyId = null;
            resetDutyForm();
        }
        
        function renderDutiesList() {
            const container = document.getElementById('dutiesListContainer');
            if (!container) return;
            
            // Update count
            const countEl = document.getElementById('dutiesCount');
            if (countEl) countEl.textContent = window.dutiesData.length;
            
            if (window.dutiesData.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-clipboard-check" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p>No duties created yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Create your first duty using the form.</p>
                    </div>
                `;
                return;
            }
            
            const priorityColors = {
                'High': '#ef4444',
                'Medium': '#eab308',
                'Low': '#10b981'
            };
            
            container.innerHTML = window.dutiesData.map(duty => `
                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${priorityColors[duty.Priority] || '#3b82f6'}; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${duty.Name}</div>
                            ${duty.Description ? `<div style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.25rem;">${duty.Description.substring(0, 80)}${duty.Description.length > 80 ? '...' : ''}</div>` : ''}
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                ${duty.ScheduleTime ? `<span style="margin-right: 0.75rem;"><i class="fas fa-clock"></i> ${duty.ScheduleTime}</span>` : ''}
                                ${duty.ScheduleDay ? `<span><i class="fas fa-calendar"></i> ${duty.ScheduleDay}</span>` : ''}
                                ${duty.AssignedToName ? `<span style="margin-left: 0.75rem;"><i class="fas fa-user"></i> ${duty.AssignedToName}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editDuty(${duty.Id})" style="padding: 0.4rem 0.6rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteDuty(${duty.Id})" style="padding: 0.4rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function resetDutyForm() {
            document.getElementById('dutyName').value = '';
            document.getElementById('dutyDescription').value = '';
            document.getElementById('dutySchedule').value = 'Daily';
            document.getElementById('dutyScheduleTime').value = '';
            document.getElementById('dutyScheduleDay').value = '';
            document.getElementById('dutyLocation').value = '';
            document.getElementById('dutyPriority').value = 'Medium';
            document.getElementById('dutyFormTitle').textContent = 'Add New Duty';
            document.getElementById('saveDutyBtn').innerHTML = '<i class="fas fa-plus"></i> Add Duty';
            editingDutyId = null;
        }
        
        function editDuty(dutyId) {
            const duty = window.dutiesData.find(d => d.Id === dutyId);
            if (!duty) return;
            
            editingDutyId = dutyId;
            document.getElementById('dutyName').value = duty.Name || '';
            document.getElementById('dutyDescription').value = duty.Description || '';
            document.getElementById('dutySchedule').value = duty.Schedule || 'Daily';
            document.getElementById('dutyScheduleTime').value = duty.ScheduleTime || '';
            document.getElementById('dutyScheduleDay').value = duty.ScheduleDay || '';
            document.getElementById('dutyLocation').value = duty.Location || '';
            document.getElementById('dutyPriority').value = duty.Priority || 'Medium';
            document.getElementById('dutyFormTitle').textContent = 'Edit Duty';
            document.getElementById('saveDutyBtn').innerHTML = '<i class="fas fa-save"></i> Update Duty';
        }
        
        async function saveDuty(event) {
            event.preventDefault();
            
            const dutyData = {
                name: document.getElementById('dutyName').value.trim(),
                description: document.getElementById('dutyDescription').value.trim(),
                schedule: document.getElementById('dutySchedule').value,
                scheduleTime: document.getElementById('dutyScheduleTime').value.trim(),
                scheduleDay: document.getElementById('dutyScheduleDay').value.trim(),
                location: document.getElementById('dutyLocation').value.trim(),
                priority: document.getElementById('dutyPriority').value
            };
            
            if (!dutyData.name) {
                showNotification('Please enter a duty name', 'error');
                return;
            }
            
            try {
                const url = editingDutyId ? `/api/duties/${editingDutyId}` : '/api/duties';
                const method = editingDutyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dutyData)
                });
                
                if (response.ok) {
                    showNotification(editingDutyId ? 'Duty updated successfully!' : 'Duty created successfully!', 'success');
                    resetDutyForm();
                    await loadDutiesFromAPI();
                    renderDutiesList();
                } else {
                    throw new Error('Failed to save duty');
                }
            } catch (error) {
                console.error('Error saving duty:', error);
                showNotification('Failed to save duty', 'error');
            }
        }
        
        async function deleteDuty(dutyId) {
            if (!confirm('Are you sure you want to delete this duty?')) return;
            
            try {
                const response = await fetch(`/api/duties/${dutyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Duty deleted successfully!', 'success');
                    await loadDutiesFromAPI();
                    renderDutiesList();
                } else {
                    throw new Error('Failed to delete duty');
                }
            } catch (error) {
                console.error('Error deleting duty:', error);
                showNotification('Failed to delete duty', 'error');
            }
        }
        
        // ============================================
        // TEAM CHAT FUNCTIONS
        // ============================================
        let currentChatUserId = null;
        let currentChatType = 'direct'; // 'direct', 'group', 'announcement'
        let currentChatTab = 'direct';
        let chatPollingInterval = null;
        let lastMessageTimestamp = null;
        let chatUsersCache = [];
        
        function openChat() {
            const modal = document.getElementById('chatModal');
            if (modal) {
                modal.style.display = 'flex';
                currentChatTab = 'direct';
                currentChatType = 'direct';
                loadConversations();
                startChatPolling();
                updateOnlineStatus(true);
            }
        }
        
        function closeChat() {
            const modal = document.getElementById('chatModal');
            if (modal) {
                modal.style.display = 'none';
            }
            stopChatPolling();
            currentChatUserId = null;
            hideNewChatPanel();
        }
        
        // Switch between chat tabs (direct, group, announcements)
        function switchChatTab(tab) {
            console.log('ðŸ“‘ Switching to tab:', tab);
            currentChatTab = tab;
            currentChatType = tab === 'announcements' ? 'announcement' : tab;
            currentChatUserId = null;
            
            // Hide new chat panel if open
            hideNewChatPanel();
            
            // Update tab button styles
            const directBtn = document.getElementById('chatTabDirect');
            const groupBtn = document.getElementById('chatTabGroup');
            const annBtn = document.getElementById('chatTabAnnouncements');
            
            [directBtn, groupBtn, annBtn].forEach(btn => {
                if (btn) {
                    btn.style.background = 'var(--bg-tertiary)';
                    btn.style.color = 'var(--text-secondary)';
                }
            });
            
            if (tab === 'direct' && directBtn) {
                directBtn.style.background = 'var(--accent-primary)';
                directBtn.style.color = 'white';
            } else if (tab === 'group' && groupBtn) {
                groupBtn.style.background = 'var(--accent-primary)';
                groupBtn.style.color = 'white';
            } else if (tab === 'announcements' && annBtn) {
                annBtn.style.background = 'var(--accent-primary)';
                annBtn.style.color = 'white';
            }
            
            // Update button text and visibility
            const newChatBtn = document.getElementById('newChatBtn');
            const newChatBtnText = document.getElementById('newChatBtnText');
            
            if (newChatBtn && newChatBtnText) {
                if (tab === 'direct') {
                    newChatBtn.style.display = 'flex';
                    newChatBtnText.textContent = 'New Chat';
                } else if (tab === 'group') {
                    newChatBtn.style.display = 'flex';
                    newChatBtnText.textContent = 'New Group';
                } else if (tab === 'announcements') {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                        newChatBtn.style.display = 'flex';
                        newChatBtnText.textContent = 'New Announcement';
                    } else {
                        newChatBtn.style.display = 'none';
                    }
                }
            }
            
            // Reset chat area
            resetChatArea();
            
            // Load appropriate content based on tab
            if (tab === 'direct') {
                loadConversations();
            } else if (tab === 'group') {
                loadGroupChats();
            } else if (tab === 'announcements') {
                loadAnnouncements();
            }
        }
        
        // Reset chat area to placeholder
        function resetChatArea() {
            const chatHeader = document.getElementById('chatAreaHeader');
            const messageInput = document.getElementById('messageInputArea');
            const messagesArea = document.getElementById('messagesArea');
            
            if (chatHeader) chatHeader.style.display = 'none';
            if (messageInput) messageInput.style.display = 'none';
            if (messagesArea) {
                messagesArea.innerHTML = `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-tertiary);">
                        <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">Select a conversation or start a new chat</p>
                    </div>
                `;
            }
        }
        
        // Close current conversation and go back to list
        function closeChatConversation() {
            console.log('ðŸ”™ Closing conversation');
            currentChatUserId = null;
            resetChatArea();
        }
        
        // Load group chats
        async function loadGroupChats() {
            const container = document.getElementById('conversationsList');
            if (!container) return;
            
            // Load group chats from localStorage (will integrate with API later)
            const groupChats = JSON.parse(localStorage.getItem('groupChats') || '[]');
            
            if (groupChats.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p style="margin: 0;">No group chats yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Create a group to start chatting with multiple team members</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = groupChats.map(group => `
                <div onclick="selectGroupChat('${group.id}')" style="padding: 0.75rem; background: transparent; border-radius: 8px; cursor: pointer; margin-bottom: 0.25rem; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: var(--text-primary);">${group.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-tertiary);">
                                ${group.members?.length || 0} members
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Load announcements
        async function loadAnnouncements() {
            const container = document.getElementById('conversationsList');
            if (!container) return;
            
            // Load announcements from localStorage (will integrate with API later)
            const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            
            if (announcements.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-bullhorn" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p style="margin: 0;">No announcements yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Announcements from management will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = announcements.map(ann => `
                <div onclick="selectAnnouncement('${ann.id}')" style="padding: 0.75rem; background: transparent; border-radius: 8px; cursor: pointer; margin-bottom: 0.25rem; transition: all 0.2s; border-left: 3px solid ${ann.priority === 'high' ? '#ef4444' : ann.priority === 'medium' ? '#f59e0b' : '#10b981'};" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: var(--text-primary);">${ann.title}</div>
                            <div style="font-size: 0.8rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${ann.content?.substring(0, 50)}${ann.content?.length > 50 ? '...' : ''}
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                                ${ann.author} â€¢ ${formatChatTime(ann.createdAt)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Select group chat
        function selectGroupChat(groupId) {
            const groupChats = JSON.parse(localStorage.getItem('groupChats') || '[]');
            const group = groupChats.find(g => g.id === groupId);
            if (!group) return;
            
            // Set chat type
            currentChatType = 'group';
            currentChatUserId = groupId;
            
            // Show chat area
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatAreaHeader').style.display = 'block';
            document.getElementById('messageInputArea').style.display = 'block';
            
            // Update header
            document.getElementById('chatUserAvatar').innerHTML = '<i class="fas fa-users"></i>';
            document.getElementById('chatUserAvatar').style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
            document.getElementById('chatUserName').textContent = group.name;
            document.getElementById('chatUserStatus').textContent = `${group.members?.length || 0} members`;
            
            // Load group messages
            const messages = group.messages || [];
            displayMessages(messages, true);
        }
        
        // Select announcement
        function selectAnnouncement(annId) {
            const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            const ann = announcements.find(a => a.id === annId);
            if (!ann) return;
            
            // Set chat type
            currentChatType = 'announcement';
            currentChatUserId = annId;
            
            // Show chat area (read-only for announcements unless admin)
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatAreaHeader').style.display = 'block';
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                document.getElementById('messageInputArea').style.display = 'block';
            } else {
                document.getElementById('messageInputArea').style.display = 'none';
            }
            
            // Update header
            document.getElementById('chatUserAvatar').innerHTML = '<i class="fas fa-bullhorn"></i>';
            document.getElementById('chatUserAvatar').style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            document.getElementById('chatUserName').textContent = ann.title;
            document.getElementById('chatUserStatus').textContent = `By ${ann.author} â€¢ ${formatChatTime(ann.createdAt)}${ann.recipients ? ` â€¢ Sent to ${ann.recipients.length} employees` : ''}`;
            
            // Display announcement content
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = `
                <div style="max-width: 90%; padding: 1rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-bullhorn"></i> ${ann.title}
                    </div>
                    <div style="color: #78350f; white-space: pre-wrap;">${ann.content}</div>
                    <div style="font-size: 0.75rem; color: #92400e; margin-top: 0.75rem; opacity: 0.8;">
                        Posted by ${ann.author} on ${new Date(ann.createdAt).toLocaleDateString()}
                    </div>
                </div>
                ${ann.replies && ann.replies.length > 0 ? ann.replies.map(reply => `
                    <div style="max-width: 80%; margin-left: auto; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">${reply.author}</div>
                        <div style="color: var(--text-primary);">${reply.content}</div>
                    </div>
                `).join('') : ''}
            `;
        }
        
        // Display messages helper
        function displayMessages(messages, isGroup = false) {
            const messagesArea = document.getElementById('messagesArea');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!messages || messages.length === 0) {
                messagesArea.innerHTML = `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-tertiary);">
                        <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                        <p style="margin: 0;">No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            messagesArea.innerHTML = messages.map(msg => {
                const isOwn = msg.senderId === currentUser.username || msg.sender === currentUser.name;
                return `
                    <div style="display: flex; ${isOwn ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                        <div style="max-width: 70%; padding: 0.75rem 1rem; background: ${isOwn ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${isOwn ? 'white' : 'var(--text-primary)'}; border-radius: ${isOwn ? '12px 12px 0 12px' : '12px 12px 12px 0'};">
                            ${isGroup && !isOwn ? `<div style="font-size: 0.7rem; font-weight: 600; margin-bottom: 0.25rem; opacity: 0.8;">${msg.sender || 'Unknown'}</div>` : ''}
                            <div>${msg.content || msg.message}</div>
                            <div style="font-size: 0.65rem; opacity: 0.7; margin-top: 0.25rem; text-align: right;">
                                ${formatChatTime(msg.timestamp || msg.createdAt)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        // Show new chat/group/announcement panel
        function showNewChatPanel() {
            if (currentChatTab === 'direct') {
                showDirectChatPanel();
            } else if (currentChatTab === 'group') {
                showCreateGroupPanel();
            } else if (currentChatTab === 'announcements') {
                showCreateAnnouncementPanel();
            }
        }
        
        // Show direct chat user selection panel
        function showDirectChatPanel() {
            const panel = document.getElementById('newChatPanel');
            if (panel) {
                panel.style.display = 'block';
                panel.innerHTML = `
                    <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                        <button onclick="hideNewChatPanel()" style="background: none; border: none; cursor: pointer; color: var(--text-tertiary); font-size: 1.25rem;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h4 style="margin: 0; color: var(--text-primary);">Start New Chat</h4>
                    </div>
                    <div style="padding: 1rem;">
                        <input type="text" id="userSearchInput" placeholder="Search team members..." oninput="filterChatUsers()" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); margin-bottom: 1rem;">
                    </div>
                    <div id="chatUsersList" style="padding: 0 1rem; overflow-y: auto; max-height: calc(100% - 140px);">
                        <!-- Users will be loaded here -->
                    </div>
                `;
                loadChatUsers();
            }
        }
        
        // Show create group panel
        function showCreateGroupPanel() {
            const panel = document.getElementById('newChatPanel');
            if (panel) {
                panel.style.display = 'block';
                panel.innerHTML = `
                    <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                        <button onclick="hideNewChatPanel()" style="background: none; border: none; cursor: pointer; color: var(--text-tertiary); font-size: 1.25rem;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h4 style="margin: 0; color: var(--text-primary);">Create New Group</h4>
                    </div>
                    <div style="padding: 1rem; overflow-y: auto; max-height: calc(100vh - 200px);">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">Group Name *</label>
                            <input type="text" id="newGroupName" placeholder="Enter group name..." style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">
                                <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>Select Members *
                            </label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <button type="button" onclick="selectAllGroupMembers()" style="padding: 0.4rem 0.75rem; font-size: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-check-double"></i> Select All
                                </button>
                                <button type="button" onclick="clearAllGroupMembers()" style="padding: 0.4rem 0.75rem; font-size: 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                            </div>
                            <div id="groupMembersList" style="max-height: 250px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                                Loading members...
                            </div>
                            <div id="groupMembersCount" style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                0 members selected
                            </div>
                        </div>
                        <button onclick="createGroup()" style="width: 100%; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Create Group
                        </button>
                    </div>
                `;
                loadGroupMembers();
            }
        }
        
        // Show create announcement panel
        function showCreateAnnouncementPanel() {
            const panel = document.getElementById('newChatPanel');
            if (panel) {
                panel.style.display = 'block';
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                panel.innerHTML = `
                    <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                        <button onclick="hideNewChatPanel()" style="background: none; border: none; cursor: pointer; color: var(--text-tertiary); font-size: 1.25rem;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h4 style="margin: 0; color: var(--text-primary);">Create Announcement</h4>
                    </div>
                    <div style="padding: 1rem; overflow-y: auto; max-height: calc(100vh - 200px);">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">Title *</label>
                            <input type="text" id="announcementTitle" placeholder="Announcement title..." style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">Content *</label>
                            <textarea id="announcementContent" placeholder="Write your announcement..." rows="4" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); resize: vertical;"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">Priority</label>
                            <select id="announcementPriority" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="low">ðŸŸ¢ Low - General Information</option>
                                <option value="medium" selected>ðŸŸ¡ Medium - Important Update</option>
                                <option value="high">ðŸ”´ High - Urgent/Critical</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">
                                <i class="fas fa-users" style="margin-right: 0.5rem;"></i>Select Recipients *
                            </label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <button type="button" onclick="selectAllAnnouncementRecipients()" style="padding: 0.4rem 0.75rem; font-size: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-check-double"></i> Select All
                                </button>
                                <button type="button" onclick="clearAllAnnouncementRecipients()" style="padding: 0.4rem 0.75rem; font-size: 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                            </div>
                            <div id="announcementRecipientsList" style="max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                                Loading employees...
                            </div>
                            <div id="announcementRecipientsCount" style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                0 employees selected
                            </div>
                        </div>
                        <button onclick="createAnnouncement()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-bullhorn"></i> Post Announcement
                        </button>
                    </div>
                `;
                loadAnnouncementRecipients();
            }
        }
        
        // Load employees for announcement recipients
        async function loadAnnouncementRecipients() {
            const container = document.getElementById('announcementRecipientsList');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading employees...</p>';
            
            try {
                // Load all users from database
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to load users');
                
                const dbUsers = await response.json();
                console.log('ðŸ‘¥ Loaded announcement recipients from database:', dbUsers.length);
                
                if (dbUsers.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 1rem;">No employees found</p>';
                    return;
                }
                
                container.innerHTML = dbUsers.map(emp => `
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; cursor: pointer; border-radius: 6px; transition: background 0.2s; border: 1px solid transparent;" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)'" onmouseout="this.style.background='transparent'; this.style.borderColor='transparent'">
                        <input type="checkbox" name="announcementRecipients" value="${emp.Id}" onchange="updateAnnouncementRecipientsCount()" style="width: 20px; height: 20px; accent-color: #f59e0b; cursor: pointer; flex-shrink: 0;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--text-primary); font-size: 0.9rem;">${emp.FirstName} ${emp.LastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">${emp.Role || 'Staff'}</div>
                        </div>
                    </label>
                `).join('');
                
            } catch (error) {
                console.error('Error loading announcement recipients:', error);
                container.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 1rem;"><i class="fas fa-exclamation-circle"></i> Failed to load employees</p>';
            }
        }
        
        // Select all announcement recipients
        function selectAllAnnouncementRecipients() {
            const checkboxes = document.querySelectorAll('input[name="announcementRecipients"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateAnnouncementRecipientsCount();
        }
        
        // Clear all announcement recipients
        function clearAllAnnouncementRecipients() {
            const checkboxes = document.querySelectorAll('input[name="announcementRecipients"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateAnnouncementRecipientsCount();
        }
        
        // Update recipients count display
        function updateAnnouncementRecipientsCount() {
            const checkboxes = document.querySelectorAll('input[name="announcementRecipients"]:checked');
            const countDisplay = document.getElementById('announcementRecipientsCount');
            if (countDisplay) {
                countDisplay.textContent = `${checkboxes.length} employee${checkboxes.length !== 1 ? 's' : ''} selected`;
                countDisplay.style.color = checkboxes.length > 0 ? 'var(--accent-primary)' : 'var(--text-tertiary)';
            }
        }
        
        // Load members for group creation
        async function loadGroupMembers() {
            const container = document.getElementById('groupMembersList');
            if (!container) return;
            
            container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading members...</p>';
            
            const userId = await getCurrentUserId();
            
            try {
                // Load users from database
                const response = await fetch(`/api/chat?action=users&userId=${userId}`);
                if (!response.ok) throw new Error('Failed to load users');
                
                const dbUsers = await response.json();
                console.log('ðŸ‘¥ Loaded group members from database:', dbUsers.length);
                
                if (dbUsers.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: 1rem;">No other team members found</p>';
                    return;
                }
                
                container.innerHTML = dbUsers.map(member => `
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; cursor: pointer; border-radius: 6px; transition: background 0.2s; border: 1px solid transparent;" onmouseover="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)'" onmouseout="this.style.background='transparent'; this.style.borderColor='transparent'">
                        <input type="checkbox" name="groupMembers" value="${member.Id}" onchange="updateGroupMembersCount()" style="width: 20px; height: 20px; accent-color: #06b6d4; cursor: pointer; flex-shrink: 0; border: 2px solid var(--border-color); border-radius: 4px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--text-primary); font-size: 0.9rem;">${member.FirstName} ${member.LastName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">${member.Role || 'Staff'}</div>
                        </div>
                        <span class="checkmark-indicator" style="width: 24px; height: 24px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; color: transparent; font-size: 0.75rem; transition: all 0.2s;">âœ“</span>
                    </label>
                `).join('');
                
            } catch (error) {
                console.error('Error loading group members:', error);
                container.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 1rem;"><i class="fas fa-exclamation-circle"></i> Failed to load members</p>';
            }
        }
        
        // Select all group members
        function selectAllGroupMembers() {
            const checkboxes = document.querySelectorAll('input[name="groupMembers"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateGroupMembersCount();
        }
        
        // Clear all group members
        function clearAllGroupMembers() {
            const checkboxes = document.querySelectorAll('input[name="groupMembers"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateGroupMembersCount();
        }
        
        // Update group members count display
        function updateGroupMembersCount() {
            const checkboxes = document.querySelectorAll('input[name="groupMembers"]:checked');
            const countDisplay = document.getElementById('groupMembersCount');
            if (countDisplay) {
                countDisplay.textContent = `${checkboxes.length} member${checkboxes.length !== 1 ? 's' : ''} selected`;
                countDisplay.style.color = checkboxes.length > 0 ? 'var(--accent-primary)' : 'var(--text-tertiary)';
            }
        }
        
        // Create new group
        function createGroup() {
            const name = document.getElementById('newGroupName')?.value?.trim();
            if (!name) {
                alert('Please enter a group name');
                return;
            }
            
            const checkboxes = document.querySelectorAll('input[name="groupMembers"]:checked');
            const members = Array.from(checkboxes).map(cb => cb.value);
            
            if (members.length === 0) {
                alert('Please select at least one member');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            members.push(currentUser.username); // Add creator to group
            
            const newGroup = {
                id: 'group-' + Date.now(),
                name: name,
                members: members,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username,
                messages: []
            };
            
            const groupChats = JSON.parse(localStorage.getItem('groupChats') || '[]');
            groupChats.push(newGroup);
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
            
            hideNewChatPanel();
            loadGroupChats();
            showNotification('Group created successfully!', 'success');
        }
        
        // Create new announcement
        function createAnnouncement() {
            const title = document.getElementById('announcementTitle')?.value?.trim();
            const content = document.getElementById('announcementContent')?.value?.trim();
            const priority = document.getElementById('announcementPriority')?.value || 'medium';
            
            if (!title || !content) {
                alert('Please enter a title and content');
                return;
            }
            
            // Get selected recipients
            const checkboxes = document.querySelectorAll('input[name="announcementRecipients"]:checked');
            const recipients = Array.from(checkboxes).map(cb => cb.value);
            
            if (recipients.length === 0) {
                alert('Please select at least one recipient');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            const newAnnouncement = {
                id: 'ann-' + Date.now(),
                title: title,
                content: content,
                priority: priority,
                author: currentUser.name || currentUser.username || 'Admin',
                recipients: recipients,
                createdAt: new Date().toISOString(),
                replies: []
            };
            
            const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            announcements.unshift(newAnnouncement); // Add to beginning
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            hideNewChatPanel();
            loadAnnouncements();
            showNotification(`Announcement posted to ${recipients.length} employee${recipients.length !== 1 ? 's' : ''}!`, 'success');
        }
        
        async function updateOnlineStatus(isOnline) {
            try {
                const userId = await getCurrentUserId();
                if (!userId) return;
                
                await fetch('/api/chat?action=status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, isOnline })
                });
            } catch (error) {
                console.error('Error updating online status:', error);
            }
        }
        
        // Cache for users loaded from API for chat
        let chatUserIdCache = null;
        let currentDbUserId = null; // Store the database user ID
        
        async function getCurrentUserId() {
            // Return cached ID if we have it
            if (currentDbUserId) {
                return currentDbUserId;
            }
            
            // Get logged-in user from localStorage
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                console.log('âŒ No current user in localStorage');
                return null;
            }
            
            try {
                const currentUserData = JSON.parse(storedUser);
                console.log('ðŸ‘¤ Current user data:', currentUserData);
                
                // Check if user has a stored database ID
                if (currentUserData.dbId) {
                    currentDbUserId = currentUserData.dbId;
                    console.log('âœ… Using stored database ID:', currentDbUserId);
                    return currentDbUserId;
                }
                
                // Fetch users from API to get the ID
                if (!chatUserIdCache) {
                    const response = await fetch('/api/users');
                    if (response.ok) {
                        chatUserIdCache = await response.json();
                        console.log('ðŸ“¥ Loaded users from API:', chatUserIdCache.length, 'users');
                    }
                }
                
                if (chatUserIdCache && chatUserIdCache.length > 0) {
                    // Find matching user by name or username (case-insensitive)
                    const loggedInUser = chatUserIdCache.find(u => {
                        const fnMatch = u.FirstName?.toLowerCase() === currentUserData.firstName?.toLowerCase();
                        const lnMatch = u.LastName?.toLowerCase() === currentUserData.lastName?.toLowerCase();
                        const unMatch = u.Username?.toLowerCase() === currentUserData.username?.toLowerCase();
                        const nameMatch = `${u.FirstName} ${u.LastName}`.toLowerCase() === currentUserData.name?.toLowerCase();
                        return (fnMatch && lnMatch) || unMatch || nameMatch;
                    });
                    
                    if (loggedInUser) {
                        currentDbUserId = loggedInUser.Id;
                        console.log('âœ… Found user in database with ID:', currentDbUserId);
                        
                        // Store the database ID for future use
                        currentUserData.dbId = currentDbUserId;
                        localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                        
                        return currentDbUserId;
                    } else {
                        console.warn('âš ï¸ User not found in database. Available users:', chatUserIdCache.map(u => `${u.FirstName} ${u.LastName} (${u.Username})`));
                        return null;
                    }
                }
                
                console.warn('âš ï¸ No users loaded from database');
                return null;
                
            } catch (e) {
                console.error('Error getting current user ID:', e);
                return null;
            }
        }
        
        async function loadConversations() {
            const container = document.getElementById('conversationsList');
            if (!container) return;
            
            const userId = await getCurrentUserId();
            console.log('ðŸ“‹ Loading conversations for user ID:', userId);
            
            if (!userId) {
                container.innerHTML = `
                    <div style="padding: 1.5rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-user-slash" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p style="margin: 0;">User not found in database</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Your account needs to be synced with the database to use chat.</p>
                    </div>`;
                return;
            }
            
            try {
                const response = await fetch(`/api/chat?action=conversations&userId=${userId}`);
                console.log('ðŸ“‹ Conversations API response status:', response.status);
                if (!response.ok) throw new Error('Failed to load conversations');
                
                const conversations = await response.json();
                console.log('ðŸ“‹ Loaded conversations:', conversations.length);
                
                if (conversations.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p style="margin: 0;">No conversations yet</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Start a new chat to begin messaging</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = conversations.map(conv => `
                    <div onclick="selectConversation(${conv.OtherUserId}, '${(conv.FirstName || '').replace(/'/g, "\\'")}', '${(conv.LastName || '').replace(/'/g, "\\'")}', ${conv.IsOnline ? 'true' : 'false'})" style="padding: 0.75rem; background: transparent; border-radius: 8px; cursor: pointer; margin-bottom: 0.25rem; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'" data-userid="${conv.OtherUserId}">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="position: relative;">
                                <div style="width: 44px; height: 44px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1rem;">
                                    ${conv.FirstName?.[0] || ''}${conv.LastName?.[0] || ''}
                                </div>
                                <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: ${conv.IsOnline ? '#10b981' : '#6b7280'}; border-radius: 50%; border: 2px solid var(--bg-secondary);"></div>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: var(--text-primary);">${conv.FirstName} ${conv.LastName}</span>
                                    ${conv.UnreadCount > 0 ? `<span style="background: var(--accent-primary); color: white; font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 999px; font-weight: 600;">${conv.UnreadCount}</span>` : ''}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${conv.LastMessage ? (conv.LastMessageSenderId === userId ? 'You: ' : '') + conv.LastMessage.substring(0, 30) + (conv.LastMessage.length > 30 ? '...' : '') : 'No messages yet'}
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-tertiary);">
                                    ${conv.LastMessageTime ? formatChatTime(conv.LastMessageTime) : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading conversations:', error);
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-tertiary);">Failed to load conversations</div>';
            }
        }
        
        async function selectConversation(otherUserId, firstName, lastName, isOnline) {
            console.log('ðŸ“¨ Selecting conversation with user ID:', otherUserId, firstName, lastName);
            
            // Reset chat type and set new user
            currentChatType = 'direct';
            currentChatUserId = otherUserId;
            
            // Clear messages immediately to prevent showing old messages
            const messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                messagesArea.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-tertiary);"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
            }
            
            // Update UI to show chat area
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatAreaHeader').style.display = 'block';
            document.getElementById('messageInputArea').style.display = 'block';
            hideNewChatPanel();
            
            // Update header with passed user info (more reliable than cache lookup)
            if (firstName || lastName) {
                document.getElementById('chatUserAvatar').textContent = `${firstName?.[0] || ''}${lastName?.[0] || ''}`;
                document.getElementById('chatUserAvatar').style.background = 'var(--accent-primary)';
                document.getElementById('chatUserAvatar').innerHTML = `${firstName?.[0] || ''}${lastName?.[0] || ''}`;
                document.getElementById('chatUserName').textContent = `${firstName || ''} ${lastName || ''}`.trim();
                document.getElementById('chatUserStatus').textContent = isOnline ? 'Online' : 'Offline';
            } else {
                // Fallback to cache lookup
                const user = chatUsersCache.find(u => u.Id === otherUserId) || 
                             window.usersData?.find(u => u.Id === otherUserId);
                
                if (user) {
                    document.getElementById('chatUserAvatar').textContent = `${user.FirstName?.[0] || ''}${user.LastName?.[0] || ''}`;
                    document.getElementById('chatUserAvatar').style.background = 'var(--accent-primary)';
                    document.getElementById('chatUserName').textContent = `${user.FirstName} ${user.LastName}`;
                    document.getElementById('chatUserStatus').textContent = user.IsOnline ? 'Online' : 'Offline';
                }
            }
            
            // Highlight selected conversation in the list
            document.querySelectorAll('#conversationsList > div[data-userid]').forEach(el => {
                if (parseInt(el.dataset.userid) === otherUserId) {
                    el.style.background = 'var(--bg-tertiary)';
                } else {
                    el.style.background = 'transparent';
                }
            });
            
            // Load messages for this specific user
            await loadMessages(otherUserId);
            
            // Mark messages as read
            try {
                const userId = await getCurrentUserId();
                await fetch('/api/chat?action=markRead', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, otherUserId })
                });
            } catch (e) {
                console.error('Error marking messages as read:', e);
            }
            
            // Refresh conversations to update unread counts
            loadConversations();
            updateUnreadBadge();
        }
        
        async function loadMessages(otherUserId) {
            const container = document.getElementById('messagesArea');
            if (!container) return;
            
            // Verify we're loading for the correct user
            if (currentChatType !== 'direct' || currentChatUserId !== otherUserId) {
                console.log('âš ï¸ Chat context changed, skipping message load');
                return;
            }
            
            const userId = await getCurrentUserId();
            if (!userId) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-tertiary);">Please log in to view messages</div>';
                return;
            }
            
            console.log('ðŸ“¬ Loading messages between user', userId, 'and', otherUserId);
            
            try {
                const response = await fetch(`/api/chat?action=messages&userId=${userId}&otherUserId=${otherUserId}`);
                if (!response.ok) throw new Error('Failed to load messages');
                
                // Double-check the context hasn't changed while we were fetching
                if (currentChatType !== 'direct' || currentChatUserId !== otherUserId) {
                    console.log('âš ï¸ Chat context changed during fetch, discarding messages');
                    return;
                }
                
                const messages = await response.json();
                console.log('ðŸ“¬ Loaded', messages.length, 'messages for user', otherUserId);
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-tertiary);">
                            <i class="fas fa-comment-dots" style="font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                            <p style="margin: 0;">No messages yet</p>
                            <p style="font-size: 0.85rem;">Send a message to start the conversation</p>
                        </div>
                    `;
                    return;
                }
                
                // Update last message timestamp for polling
                if (messages.length > 0) {
                    lastMessageTimestamp = messages[messages.length - 1].SentAt;
                }
                
                container.innerHTML = messages.map(msg => {
                    const isMe = msg.SenderId === userId;
                    return `
                        <div style="display: flex; justify-content: ${isMe ? 'flex-end' : 'flex-start'}; margin-bottom: 0.5rem;">
                            <div style="max-width: 70%; padding: 0.75rem 1rem; background: ${isMe ? 'var(--accent-primary)' : 'var(--bg-secondary)'}; color: ${isMe ? 'white' : 'var(--text-primary)'}; border-radius: 18px; border-bottom-${isMe ? 'right' : 'left'}-radius: 4px;">
                                <div style="word-wrap: break-word;">${escapeHtml(msg.Message)}</div>
                                <div style="font-size: 0.65rem; opacity: 0.7; margin-top: 0.25rem; text-align: ${isMe ? 'right' : 'left'};">
                                    ${formatChatTime(msg.SentAt)}
                                    ${isMe && msg.IsRead ? ' <i class="fas fa-check-double"></i>' : isMe ? ' <i class="fas fa-check"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
                
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><i class="fas fa-exclamation-circle"></i> Failed to load messages</div>';
            }
        }
        
        async function sendMessage(event) {
            event.preventDefault();
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatUserId) return;
            
            const userId = await getCurrentUserId();
            if (!userId) return;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        senderId: userId,
                        receiverId: currentChatUserId,
                        message: message
                    })
                });
                
                if (response.ok) {
                    input.value = '';
                    await loadMessages(currentChatUserId);
                    loadConversations();
                } else {
                    throw new Error('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        }
        
        function hideNewChatPanel() {
            const panel = document.getElementById('newChatPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }
        
        async function loadChatUsers() {
            const container = document.getElementById('chatUsersList');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--text-tertiary);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            const userId = await getCurrentUserId();
            console.log('ðŸ‘¥ Loading chat users, current user ID:', userId);
            
            try {
                const response = await fetch(`/api/chat?action=users&userId=${userId}`);
                console.log('ðŸ‘¥ Chat users API response status:', response.status);
                if (!response.ok) throw new Error('Failed to load users');
                
                chatUsersCache = await response.json();
                console.log('ðŸ‘¥ Loaded', chatUsersCache.length, 'users from database');
                
                if (chatUsersCache.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 1.5rem; color: var(--text-tertiary);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p style="margin: 0;">No other users found</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Add team members to start chatting</p>
                        </div>
                    `;
                } else {
                    renderChatUsersList(chatUsersCache);
                }
                
            } catch (error) {
                console.error('Error loading users from API:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: var(--text-tertiary);">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 0.5rem; color: #ef4444;"></i>
                        <p style="margin: 0;">Failed to load users</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Fallback: Load users from localStorage
        function loadChatUsersFromLocalStorage() {
            const container = document.getElementById('chatUsersList');
            if (!container) return;
            
            const storedUsers = localStorage.getItem('users');
            const usersData = storedUsers ? JSON.parse(storedUsers) : {};
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Convert localStorage users to the same format as API users
            const users = Object.entries(usersData)
                .filter(([username]) => username !== currentUser.username && username !== 'admin')
                .map(([username, user]) => ({
                    Id: user.id || username,
                    Username: username,
                    FirstName: user.firstName || username,
                    LastName: user.lastName || '',
                    Role: user.role || 'User',
                    IsOnline: false
                }));
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: var(--text-tertiary);">
                        <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                        <p style="margin: 0;">No team members found</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Add users in User Management first</p>
                    </div>
                `;
                return;
            }
            
            chatUsersCache = users;
            renderChatUsersListLocal(users);
        }
        
        // Render users from localStorage format
        function renderChatUsersListLocal(users) {
            const container = document.getElementById('chatUsersList');
            if (!container) return;
            
            container.innerHTML = users.map(user => `
                <div onclick="startChatWithLocal('${user.Username}', '${user.FirstName}', '${user.LastName}')" style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="position: relative;">
                            <div style="width: 40px; height: 40px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                ${user.FirstName?.[0] || ''}${user.LastName?.[0] || ''}
                            </div>
                            <div style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #6b7280; border-radius: 50%; border: 2px solid var(--bg-secondary);"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${user.FirstName} ${user.LastName || ''}</div>
                            <div style="font-size: 0.8rem; color: var(--text-tertiary);">${user.Role || 'Staff'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Start chat with local user (create if needed in DB)
        async function startChatWithLocal(username, firstName, lastName) {
            console.log('ðŸ“§ Starting chat with local user:', username, firstName, lastName);
            hideNewChatPanel();
            
            // Try to find user in API cache first
            let userId = null;
            if (chatUserIdCache) {
                const apiUser = chatUserIdCache.find(u => 
                    u.Username === username || 
                    (u.FirstName === firstName && u.LastName === lastName)
                );
                userId = apiUser?.Id;
            }
            
            if (userId) {
                selectConversation(userId, firstName, lastName, false);
            } else {
                // Show message that user needs to be synced to database
                showNotification('This user needs to be synced to the database first. Try logging in as this user or sync users.', 'warning');
            }
        }
        
        function renderChatUsersList(users) {
            const container = document.getElementById('chatUsersList');
            if (!container) return;
            
            container.innerHTML = users.map(user => `
                <div onclick="startChatWith(${user.Id})" style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="position: relative;">
                            <div style="width: 40px; height: 40px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                ${user.FirstName?.[0] || ''}${user.LastName?.[0] || ''}
                            </div>
                            <div style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: ${user.IsOnline ? '#10b981' : '#6b7280'}; border-radius: 50%; border: 2px solid var(--bg-secondary);"></div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${user.FirstName} ${user.LastName}</div>
                            <div style="font-size: 0.8rem; color: var(--text-tertiary);">${user.Role || 'Staff'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterChatUsers() {
            const search = document.getElementById('userSearchInput').value.toLowerCase();
            const filtered = chatUsersCache.filter(u => 
                `${u.FirstName} ${u.LastName}`.toLowerCase().includes(search)
            );
            renderChatUsersList(filtered);
        }
        
        function startChatWith(userId) {
            console.log('ðŸ’¬ startChatWith called with userId:', userId);
            
            // Hide the new chat panel first
            hideNewChatPanel();
            
            // Set to direct chat mode
            currentChatTab = 'direct';
            currentChatType = 'direct';
            
            // Find user info from cache
            const user = chatUsersCache.find(u => u.Id === userId);
            console.log('ðŸ’¬ Found user in cache:', user);
            
            if (user) {
                selectConversation(userId, user.FirstName, user.LastName, user.IsOnline);
            } else {
                selectConversation(userId, null, null, false);
            }
        }
        
        function startChatPolling() {
            // Poll for new messages every 5 seconds
            chatPollingInterval = setInterval(async () => {
                // Only poll when on direct messages tab AND viewing a specific conversation
                if (currentChatTab === 'direct' && currentChatType === 'direct' && currentChatUserId) {
                    await loadMessages(currentChatUserId);
                    await loadConversations();
                }
                // Always update unread badge
                await updateUnreadBadge();
            }, 5000);
        }
        
        function stopChatPolling() {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
        }
        
        async function updateUnreadBadge() {
            try {
                const userId = await getCurrentUserId();
                if (!userId) return;
                
                const response = await fetch(`/api/chat?action=unreadCount&userId=${userId}`);
                if (!response.ok) return;
                
                const data = await response.json();
                const count = data.UnreadCount || 0;
                
                // Update badge on all chat buttons
                const chatBadges = document.querySelectorAll('.chat-unread-badge');
                chatBadges.forEach(badge => {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error updating unread badge:', error);
            }
        }
        
        function formatChatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            // Less than 1 minute
            if (diff < 60000) return 'Just now';
            
            // Less than 1 hour
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            
            // Less than 24 hours
            if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Less than 7 days
            if (diff < 604800000) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return days[date.getDay()];
            }
            
            // Otherwise show date
            return date.toLocaleDateString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Start background badge updates when logged in
        function initChatNotifications() {
            setInterval(updateUnreadBadge, 30000); // Update every 30 seconds
            updateUnreadBadge(); // Initial check
        }
        
        // Update online status when page closes
        window.addEventListener('beforeunload', () => {
            updateOnlineStatus(false);
        });
        
        // ============================================
        // END TEAM CHAT FUNCTIONS
        // ============================================
        
        // Task Templates - Now customizable!
        window.taskTemplates = [
            {
                id: 'daily-close',
                title: 'Daily Close Checklist',
                description: 'Complete end-of-day closing procedures including cash reconciliation, equipment shutdown, and security check.',
                priority: 'High',
                category: 'Administrative',
                recurrence: 'Daily',
                linkedContext: { type: 'Process', value: 'Daily Close' },
                completionCriteria: 'All items checked off + initials',
                complianceFlag: false,
                estimatedTime: 30,
                icon: 'fa-door-closed',
                iconColor: '#ef4444'
            },
            {
                id: 'sterilization',
                title: 'Sterilization Task',
                description: 'Run sterilization cycle on designated equipment per OSHA protocol.',
                priority: 'Critical',
                category: 'Clinical',
                recurrence: 'Daily',
                linkedContext: { type: 'Equipment', value: 'Sterilization Equipment' },
                completionCriteria: 'Cycle complete + logged',
                complianceFlag: true,
                estimatedTime: 45,
                icon: 'fa-pump-medical',
                iconColor: '#10b981'
            },
            {
                id: 'equipment-check',
                title: 'Equipment Maintenance Check',
                description: 'Perform routine maintenance check on dental equipment.',
                priority: 'Medium',
                category: 'Equipment',
                recurrence: 'Weekly',
                linkedContext: { type: 'Equipment', value: '' },
                completionCriteria: 'Checklist completed + issues logged',
                complianceFlag: false,
                estimatedTime: 30,
                icon: 'fa-tools',
                iconColor: '#f59e0b'
            },
            {
                id: 'patient-followup',
                title: 'Patient Follow-up Call',
                description: 'Contact patient to check on post-procedure recovery.',
                priority: 'Medium',
                category: 'Clinical',
                recurrence: 'One-time',
                linkedContext: { type: 'Patient', value: '' },
                completionCriteria: 'Call logged in patient record',
                complianceFlag: false,
                estimatedTime: 10,
                icon: 'fa-phone',
                iconColor: '#3b82f6'
            },
            {
                id: 'compliance-audit',
                title: 'Compliance Audit Task',
                description: 'Complete compliance review per regulatory requirements.',
                priority: 'High',
                category: 'Compliance',
                recurrence: 'Monthly',
                linkedContext: { type: 'Process', value: '' },
                completionCriteria: 'Audit report completed + filed',
                complianceFlag: true,
                estimatedTime: 60,
                icon: 'fa-clipboard-check',
                iconColor: '#8b5cf6'
            },
            {
                id: 'supply-order',
                title: 'Supply Order',
                description: 'Review inventory and place order for supplies.',
                priority: 'Medium',
                category: 'Administrative',
                recurrence: 'Weekly',
                linkedContext: { type: 'Process', value: 'Inventory' },
                completionCriteria: 'Order placed + confirmation received',
                complianceFlag: false,
                estimatedTime: 20,
                icon: 'fa-boxes',
                iconColor: '#ec4899'
            }
        ];
        
        // Template icon options for selection
        const templateIconOptions = [
            { icon: 'fa-door-closed', label: 'Door/Close', color: '#ef4444' },
            { icon: 'fa-pump-medical', label: 'Medical', color: '#10b981' },
            { icon: 'fa-tools', label: 'Tools', color: '#f59e0b' },
            { icon: 'fa-phone', label: 'Phone', color: '#3b82f6' },
            { icon: 'fa-clipboard-check', label: 'Clipboard', color: '#8b5cf6' },
            { icon: 'fa-boxes', label: 'Boxes', color: '#ec4899' },
            { icon: 'fa-broom', label: 'Cleaning', color: '#14b8a6' },
            { icon: 'fa-file-medical', label: 'Medical File', color: '#f43f5e' },
            { icon: 'fa-calendar-check', label: 'Calendar', color: '#6366f1' },
            { icon: 'fa-user-nurse', label: 'Staff', color: '#0ea5e9' },
            { icon: 'fa-tooth', label: 'Dental', color: '#84cc16' },
            { icon: 'fa-envelope', label: 'Email', color: '#a855f7' },
            { icon: 'fa-money-bill', label: 'Financial', color: '#22c55e' },
            { icon: 'fa-shield-alt', label: 'Compliance', color: '#8b5cf6' },
            { icon: 'fa-laptop', label: 'Computer', color: '#64748b' },
            { icon: 'fa-truck', label: 'Delivery', color: '#78716c' }
        ];
        
        // Priority colors
        const priorityColors = {
            'Critical': '#dc2626',
            'High': '#f59e0b',
            'Medium': '#3b82f6',
            'Low': '#10b981'
        };
        
        // Status colors
        const statusColors = {
            'Pending': '#eab308',
            'In Progress': '#3b82f6',
            'Completed': '#10b981',
            'Overdue': '#ef4444'
        };
        
        // Task Calendar State
        let taskCalendarDate = new Date();
        let taskCalendarOpen = false;
        let taskDateRangeMode = 'week'; // 'today', 'week', 'month', 'all', 'custom'
        let taskDateRangeStart = null;
        let taskDateRangeEnd = null;
        
        // Initialize date range to this week
        (function() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            taskDateRangeStart = new Date(today);
            taskDateRangeStart.setDate(today.getDate() - dayOfWeek);
            taskDateRangeStart.setHours(0, 0, 0, 0);
            
            taskDateRangeEnd = new Date(taskDateRangeStart);
            taskDateRangeEnd.setDate(taskDateRangeStart.getDate() + 6);
            taskDateRangeEnd.setHours(23, 59, 59, 999);
        })();
        
        // Toggle Task Calendar
        window.toggleTaskCalendar = function() {
            taskCalendarOpen = !taskCalendarOpen;
            const dropdown = document.getElementById('taskCalendarDropdown');
            const chevron = document.getElementById('taskCalendarChevron');
            
            if (dropdown) {
                if (taskCalendarOpen) {
                    dropdown.classList.add('active');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                    renderTaskCalendar();
                } else {
                    dropdown.classList.remove('active');
                    if (chevron) chevron.style.transform = 'rotate(0deg)';
                }
            }
        };
        
        // Render Task Calendar
        function renderTaskCalendar() {
            const year = taskCalendarDate.getFullYear();
            const month = taskCalendarDate.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const monthDisplay = document.getElementById('taskCalendarMonth');
            if (monthDisplay) {
                monthDisplay.textContent = monthNames[month] + ' ' + year;
            }
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('taskCalendarGrid');
            if (!grid) return;
            
            // Clear and rebuild with headers
            grid.innerHTML = '';
            const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            dayNames.forEach(function(name) {
                const headerEl = document.createElement('div');
                headerEl.style.cssText = 'font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; padding: 0.25rem; text-align: center;';
                headerEl.textContent = name;
                grid.appendChild(headerEl);
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Count tasks per day for this month
            const taskCountByDay = {};
            var monthStr = String(month + 1).padStart(2, '0');
            var prefix = year + '-' + monthStr;
            window.tasksData.forEach(function(task) {
                var taskDate = task.dueDate;
                if (taskDate && taskDate.indexOf(prefix) === 0) {
                    var day = parseInt(taskDate.split('-')[2]);
                    taskCountByDay[day] = (taskCountByDay[day] || 0) + 1;
                }
            });
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayEl = document.createElement('div');
                dayEl.style.cssText = 'padding: 0.4rem; color: var(--text-secondary); opacity: 0.4; font-size: 0.8rem; text-align: center;';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const dateObj = new Date(year, month, day);
                dateObj.setHours(0, 0, 0, 0);
                
                const isToday = dateObj.getTime() === today.getTime();
                const isInRange = taskDateRangeStart && taskDateRangeEnd && 
                                  dateObj >= taskDateRangeStart && dateObj <= taskDateRangeEnd;
                const taskCount = taskCountByDay[day] || 0;
                
                dayEl.style.padding = '0.3rem';
                dayEl.style.cursor = 'pointer';
                dayEl.style.borderRadius = '6px';
                dayEl.style.transition = 'all 0.2s';
                dayEl.style.fontSize = '0.8rem';
                dayEl.style.fontWeight = '500';
                dayEl.style.textAlign = 'center';
                dayEl.style.position = 'relative';
                dayEl.style.color = isToday ? 'white' : (isInRange ? 'var(--accent-dark)' : 'var(--text-primary)');
                dayEl.style.background = isToday ? 'var(--accent-primary)' : (isInRange ? 'var(--accent-light)' : 'transparent');
                if (isInRange && !isToday) dayEl.style.fontWeight = '700';
                
                if (taskCount > 0) {
                    var countSpan = document.createElement('span');
                    countSpan.style.cssText = 'position: absolute; top: 0; right: 2px; font-size: 0.55rem; font-weight: 700;';
                    countSpan.style.color = isToday ? '#fef3c7' : '#ef4444';
                    countSpan.textContent = taskCount;
                    dayEl.textContent = day;
                    dayEl.appendChild(countSpan);
                } else {
                    dayEl.textContent = day;
                }
                
                (function(d, isTdy, isRng) {
                    dayEl.onmouseover = function() {
                        if (!isTdy && !isRng) this.style.background = 'var(--accent-light)';
                    };
                    dayEl.onmouseout = function() {
                        if (!isTdy && !isRng) this.style.background = 'transparent';
                    };
                    dayEl.onclick = function(e) {
                        e.stopPropagation();
                        selectTaskDate(new Date(year, month, d));
                    };
                })(day, isToday, isInRange);
                
                grid.appendChild(dayEl);
            }
            
            // Next month days
            const totalCells = grid.children.length - 7;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = document.createElement('div');
                dayEl.style.cssText = 'padding: 0.4rem; color: var(--text-secondary); opacity: 0.4; font-size: 0.8rem; text-align: center;';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
        }
        
        // Select specific date
        function selectTaskDate(date) {
            taskDateRangeMode = 'custom';
            taskDateRangeStart = new Date(date);
            taskDateRangeStart.setHours(0, 0, 0, 0);
            taskDateRangeEnd = new Date(date);
            taskDateRangeEnd.setHours(23, 59, 59, 999);
            
            updateTaskDateDisplay();
            renderTaskCalendar();
            renderTasksList();
            toggleTaskCalendar();
        }
        
        // Set date range preset
        window.setTaskDateRange = function(mode) {
            taskDateRangeMode = mode;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            switch(mode) {
                case 'today':
                    taskDateRangeStart = new Date(today);
                    taskDateRangeEnd = new Date(today);
                    taskDateRangeEnd.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    const dayOfWeek = today.getDay();
                    taskDateRangeStart = new Date(today);
                    taskDateRangeStart.setDate(today.getDate() - dayOfWeek);
                    taskDateRangeEnd = new Date(taskDateRangeStart);
                    taskDateRangeEnd.setDate(taskDateRangeStart.getDate() + 6);
                    taskDateRangeEnd.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    taskDateRangeStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    taskDateRangeEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    taskDateRangeEnd.setHours(23, 59, 59, 999);
                    break;
                case 'all':
                    taskDateRangeStart = null;
                    taskDateRangeEnd = null;
                    break;
            }
            
            taskCalendarDate = new Date(today);
            updateTaskDateDisplay();
            renderTaskCalendar();
            renderTasksList();
            toggleTaskCalendar();
        };
        
        // Navigate weeks
        window.taskCalendarPrevWeek = function() {
            if (!taskDateRangeStart) {
                setTaskDateRange('week');
                return;
            }
            taskDateRangeStart.setDate(taskDateRangeStart.getDate() - 7);
            taskDateRangeEnd.setDate(taskDateRangeEnd.getDate() - 7);
            taskCalendarDate = new Date(taskDateRangeStart);
            taskDateRangeMode = 'week';
            updateTaskDateDisplay();
            renderTasksList();
            if (taskCalendarOpen) renderTaskCalendar();
        };
        
        window.taskCalendarNextWeek = function() {
            if (!taskDateRangeStart) {
                setTaskDateRange('week');
                return;
            }
            taskDateRangeStart.setDate(taskDateRangeStart.getDate() + 7);
            taskDateRangeEnd.setDate(taskDateRangeEnd.getDate() + 7);
            taskCalendarDate = new Date(taskDateRangeStart);
            taskDateRangeMode = 'week';
            updateTaskDateDisplay();
            renderTasksList();
            if (taskCalendarOpen) renderTaskCalendar();
        };
        
        // Navigate months in calendar
        window.taskCalendarPrevMonth = function() {
            taskCalendarDate.setMonth(taskCalendarDate.getMonth() - 1);
            renderTaskCalendar();
        };
        
        window.taskCalendarNextMonth = function() {
            taskCalendarDate.setMonth(taskCalendarDate.getMonth() + 1);
            renderTaskCalendar();
        };
        
        // Jump to today
        window.taskCalendarToday = function() {
            setTaskDateRange('week');
        };
        
        // Update date display
        function updateTaskDateDisplay() {
            const buttonDate = document.getElementById('taskCalendarButtonDate');
            const rangeText = document.getElementById('taskDateRangeText');
            
            const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const formatDateLong = (d) => d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            let displayText = '';
            let rangeDescription = '';
            
            if (taskDateRangeMode === 'all' || !taskDateRangeStart) {
                displayText = 'All Tasks';
                rangeDescription = 'Showing all tasks';
            } else if (taskDateRangeMode === 'today') {
                displayText = 'Today';
                rangeDescription = `Showing tasks for today (${formatDateLong(taskDateRangeStart)})`;
            } else if (taskDateRangeMode === 'week') {
                displayText = `${formatDate(taskDateRangeStart)} - ${formatDate(taskDateRangeEnd)}`;
                rangeDescription = `Showing tasks for week: ${formatDate(taskDateRangeStart)} - ${formatDate(taskDateRangeEnd)}`;
            } else if (taskDateRangeMode === 'month') {
                const monthName = taskDateRangeStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                displayText = monthName;
                rangeDescription = `Showing tasks for ${monthName}`;
            } else if (taskDateRangeMode === 'custom') {
                displayText = formatDateLong(taskDateRangeStart);
                rangeDescription = `Showing tasks for ${formatDateLong(taskDateRangeStart)}`;
            }
            
            if (buttonDate) buttonDate.textContent = displayText;
            if (rangeText) rangeText.textContent = rangeDescription;
        }
        
        // Initialize Tasks View
        function initTasksView() {
            populateTaskAssigneeFilter();
            updateTaskDateDisplay();
            renderTasksList();
            updateTaskStats();
            renderThisWeekTasks();
            updateCategoryBadges();
            renderTemplatesSidebar();
            // Pre-render sidebar calendar (will show when expanded)
            renderTaskSidebarCalendar();
        }
        
        // Populate assignee filter dropdown
        function populateTaskAssigneeFilter() {
            const filterEl = document.getElementById('taskFilterAssignee');
            if (!filterEl) return;
            
            const employees = window.masterData ? [...window.masterData.getProviders(), ...window.masterData.getAssistants()] : [];
            
            let options = '<option value="">All Assignees</option>';
            employees.forEach(emp => {
                options += `<option value="${emp.title}">${emp.title}</option>`;
            });
            filterEl.innerHTML = options;
        }
        
        // Render tasks list
        window.renderTasksList = function() {
            const container = document.getElementById('tasksListContainer');
            if (!container) return;
            
            // Get current user role and name
            const userRole = localStorage.getItem('userRole');
            const userName = localStorage.getItem('userName');
            
            // Get filters
            const statusFilter = document.getElementById('taskFilterStatus')?.value || '';
            const priorityFilter = document.getElementById('taskFilterPriority')?.value || '';
            const categoryFilter = document.getElementById('taskFilterCategory')?.value || '';
            const assigneeFilter = document.getElementById('taskFilterAssignee')?.value || '';
            
            // Filter tasks by dropdown filters
            let filteredTasks = window.tasksData.filter(task => {
                // For non-admin users, only show tasks assigned to them (primary or secondary)
                if (userRole !== 'admin' && userName) {
                    const isAssignedToUser = task.assignee === userName || task.secondaryAssignee === userName;
                    if (!isAssignedToUser) return false;
                }
                
                if (statusFilter && task.status !== statusFilter) return false;
                if (priorityFilter && task.priority !== priorityFilter) return false;
                if (categoryFilter && task.category !== categoryFilter) return false;
                if (assigneeFilter && task.assignee !== assigneeFilter) return false;
                return true;
            });
            
            // Filter by date range (if set)
            if (taskDateRangeStart && taskDateRangeEnd) {
                filteredTasks = filteredTasks.filter(task => {
                    // Parse the date string as local time (not UTC)
                    var parts = task.dueDate.split('-');
                    var taskDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    taskDate.setHours(0, 0, 0, 0);
                    return taskDate >= taskDateRangeStart && taskDate <= taskDateRangeEnd;
                });
            }
            
            // Update date range count
            const countEl = document.getElementById('taskDateRangeCount');
            if (countEl) {
                countEl.textContent = `${filteredTasks.length} task${filteredTasks.length !== 1 ? 's' : ''}`;
            }
            
            // Update overdue status and AUTO-ESCALATE priority based on days overdue
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            filteredTasks.forEach(task => {
                if (task.status === 'Completed') return;
                
                const dueDate = new Date(task.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const diffTime = today - dueDate;
                const daysOverdue = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (daysOverdue > 0) {
                    task.status = 'Overdue';
                    task.daysOverdue = daysOverdue;
                    
                    // Store original priority if not already stored
                    if (!task.originalPriority) {
                        task.originalPriority = task.priority;
                    }
                    
                    // AUTO-ESCALATE PRIORITY based on days overdue:
                    // Low â†’ Medium (3+ days) â†’ High (6+ days) â†’ Critical (9+ days)
                    // Medium â†’ High (3+ days) â†’ Critical (6+ days)
                    // High â†’ Critical (2+ days)
                    const original = task.originalPriority;
                    
                    if (original === 'Low') {
                        if (daysOverdue >= 9) task.priority = 'Critical';
                        else if (daysOverdue >= 6) task.priority = 'High';
                        else if (daysOverdue >= 3) task.priority = 'Medium';
                    } else if (original === 'Medium') {
                        if (daysOverdue >= 6) task.priority = 'Critical';
                        else if (daysOverdue >= 3) task.priority = 'High';
                    } else if (original === 'High') {
                        if (daysOverdue >= 2) task.priority = 'Critical';
                    }
                } else {
                    task.daysOverdue = 0;
                }
            });
            
            // Sort: Overdue first (most overdue at top), then by due date, then by priority
            const priorityOrder = { 'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
            filteredTasks.sort((a, b) => {
                if (a.status === 'Overdue' && b.status !== 'Overdue') return -1;
                if (b.status === 'Overdue' && a.status !== 'Overdue') return 1;
                // Most overdue first
                if (a.status === 'Overdue' && b.status === 'Overdue') {
                    return (b.daysOverdue || 0) - (a.daysOverdue || 0);
                }
                if (a.status === 'Completed' && b.status !== 'Completed') return 1;
                if (b.status === 'Completed' && a.status !== 'Completed') return -1;
                if (a.dueDate !== b.dueDate) return a.dueDate.localeCompare(b.dueDate);
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-clipboard-check" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>No tasks found</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredTasks.forEach(task => {
                const priorityColor = priorityColors[task.priority] || '#6b7280';
                const statusColor = statusColors[task.status] || '#6b7280';
                const dueDateFormatted = new Date(task.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const isOverdue = task.status === 'Overdue';
                const isCompleted = task.status === 'Completed';
                const daysOverdue = task.daysOverdue || 0;
                const wasEscalated = task.originalPriority && task.originalPriority !== task.priority;
                
                html += `
                    <div class="task-card" onclick="showTaskDetail('${task.id}')" style="padding: 1rem; background: ${isOverdue ? '#fef2f2' : 'var(--bg-secondary)'}; border-radius: 8px; border-left: 4px solid ${priorityColor}; cursor: pointer; transition: all 0.2s; ${isCompleted ? 'opacity: 0.7;' : ''}" onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem; ${isCompleted ? 'text-decoration: line-through;' : ''}">${task.title}</span>
                                    ${task.complianceFlag ? '<i class="fas fa-shield-alt" style="color: var(--accent-primary); font-size: 0.75rem;" title="Compliance Task"></i>' : ''}
                                    ${wasEscalated ? '<i class="fas fa-arrow-up" style="color: #ef4444; font-size: 0.7rem;" title="Priority escalated due to being overdue"></i>' : ''}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                    <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: ${priorityColor}20; color: ${priorityColor}; border-radius: 4px; font-weight: 600;">${task.priority}${wasEscalated ? ' â¬†' : ''}</span>
                                    <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-weight: 600;">${task.status}</span>
                                    ${isOverdue && daysOverdue > 0 ? `<span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: #fecaca; color: #b91c1c; border-radius: 4px; font-weight: 700;"><i class="fas fa-exclamation-triangle" style="margin-right: 0.2rem;"></i>${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue</span>` : ''}
                                    <span style="font-size: 0.7rem; color: var(--text-secondary);"><i class="fas fa-folder" style="margin-right: 0.2rem;"></i>${task.category}</span>
                                    <span style="font-size: 0.7rem; color: var(--text-secondary);"><i class="fas fa-user" style="margin-right: 0.2rem;"></i>${task.assignee.split(' ')[0]}</span>
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 100px;">
                                <div style="font-size: 0.75rem; color: ${isOverdue ? '#ef4444' : 'var(--text-secondary)'}; font-weight: ${isOverdue ? '600' : '400'};">
                                    <i class="fas fa-calendar" style="margin-right: 0.2rem;"></i>${dueDateFormatted}
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    <i class="fas fa-clock" style="margin-right: 0.2rem;"></i>${task.dueTime || 'EOD'}
                                </div>
                                ${task.recurrence !== 'One-time' ? `<div style="font-size: 0.65rem; color: var(--accent-primary); margin-top: 0.25rem;"><i class="fas fa-redo" style="margin-right: 0.2rem;"></i>${task.recurrence}</div>` : ''}
                                ${wasEscalated ? `<div style="font-size: 0.6rem; color: #ef4444; margin-top: 0.25rem; font-style: italic;">was ${task.originalPriority}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateTaskStats();
            updateCategoryBadges();
        };
        
        // Update task statistics
        function updateTaskStats() {
            const pending = window.tasksData.filter(t => t.status === 'Pending').length;
            const inProgress = window.tasksData.filter(t => t.status === 'In Progress').length;
            const completed = window.tasksData.filter(t => t.status === 'Completed').length;
            const overdue = window.tasksData.filter(t => t.status === 'Overdue').length;
            
            const pendingEl = document.getElementById('taskStatPending');
            const inProgressEl = document.getElementById('taskStatInProgress');
            const completedEl = document.getElementById('taskStatCompleted');
            const overdueEl = document.getElementById('taskStatOverdue');
            
            if (pendingEl) pendingEl.textContent = pending;
            if (inProgressEl) inProgressEl.textContent = inProgress;
            if (completedEl) completedEl.textContent = completed;
            if (overdueEl) overdueEl.textContent = overdue;
        }
        
        // Update category badges
        function updateCategoryBadges() {
            const categories = ['Clinical', 'Administrative', 'Compliance', 'Equipment', 'Facility'];
            categories.forEach(cat => {
                const count = window.tasksData.filter(t => t.category === cat && t.status !== 'Completed').length;
                const badge = document.getElementById('catBadge' + cat);
                if (badge) badge.textContent = count;
            });
        }
        
        // Render this week's tasks
        function renderThisWeekTasks() {
            const container = document.getElementById('tasksThisWeekList');
            if (!container) return;
            
            const today = new Date();
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            const thisWeekTasks = window.tasksData.filter(task => {
                const dueDate = new Date(task.dueDate);
                return dueDate >= today && dueDate <= weekEnd && task.status !== 'Completed';
            }).slice(0, 5);
            
            if (thisWeekTasks.length === 0) {
                container.innerHTML = '<div style="padding: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); text-align: center;">No tasks due this week</div>';
                return;
            }
            
            let html = '';
            thisWeekTasks.forEach(task => {
                const priorityColor = priorityColors[task.priority];
                html += `
                    <a href="#" class="nav-item" onclick="showTaskDetail('${task.id}'); return false;" style="border-left: 3px solid ${priorityColor};">
                        <i class="fas fa-circle" style="color: ${priorityColor}; font-size: 0.5rem;"></i>
                        <span style="font-size: 0.8rem;">${task.title.substring(0, 20)}${task.title.length > 20 ? '...' : ''}</span>
                    </a>
                `;
            });
            container.innerHTML = html;
        }
        
        // Clear task filters
        window.clearTaskFilters = function() {
            document.getElementById('taskFilterStatus').value = '';
            document.getElementById('taskFilterPriority').value = '';
            document.getElementById('taskFilterCategory').value = '';
            document.getElementById('taskFilterAssignee').value = '';
            // Reset date range to this week
            setTaskDateRange('week');
        };
        
        // Close task calendar when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('taskCalendarDropdown');
            const button = document.getElementById('taskCalendarButton');
            
            if (taskCalendarOpen && dropdown && button && 
                !dropdown.contains(e.target) && !button.contains(e.target)) {
                toggleTaskCalendar();
            }
        });
        
        // ==========================================
        // TASK SIDEBAR QUICK CALENDAR
        // ==========================================
        
        let taskSidebarCalendarOpen = false;
        let taskSidebarCalendarDate = new Date();
        
        // Toggle sidebar calendar
        window.toggleTaskSidebarCalendar = function() {
            taskSidebarCalendarOpen = !taskSidebarCalendarOpen;
            const container = document.getElementById('taskSidebarCalendarContainer');
            const chevron = document.getElementById('taskSidebarCalendarChevron');
            
            if (container) {
                container.style.display = taskSidebarCalendarOpen ? 'block' : 'none';
                if (chevron) {
                    chevron.style.transform = taskSidebarCalendarOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                }
                if (taskSidebarCalendarOpen) {
                    renderTaskSidebarCalendar();
                }
            }
        };
        
        // Navigate months
        window.taskSidebarCalendarPrevMonth = function() {
            taskSidebarCalendarDate.setMonth(taskSidebarCalendarDate.getMonth() - 1);
            renderTaskSidebarCalendar();
        };
        
        window.taskSidebarCalendarNextMonth = function() {
            taskSidebarCalendarDate.setMonth(taskSidebarCalendarDate.getMonth() + 1);
            renderTaskSidebarCalendar();
        };
        
        // Render sidebar calendar
        function renderTaskSidebarCalendar() {
            const year = taskSidebarCalendarDate.getFullYear();
            const month = taskSidebarCalendarDate.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const monthDisplay = document.getElementById('taskSidebarCalendarMonth');
            if (monthDisplay) {
                monthDisplay.textContent = `${monthNames[month]} ${year}`;
            }
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('taskSidebarCalendarGrid');
            if (!grid) return;
            
            // Clear and rebuild with headers
            grid.innerHTML = '';
            var dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            dayNames.forEach(function(name) {
                var headerEl = document.createElement('div');
                headerEl.style.cssText = 'font-weight: 600; color: var(--text-secondary); font-size: 0.7rem; padding: 0.2rem; text-align: center;';
                headerEl.textContent = name;
                grid.appendChild(headerEl);
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Count tasks per day for indicators
            const taskCountByDay = {};
            var monthStr = String(month + 1).padStart(2, '0');
            var prefix = year + '-' + monthStr;
            window.tasksData.forEach(function(task) {
                var taskDate = task.dueDate;
                if (taskDate && taskDate.indexOf(prefix) === 0) {
                    var day = parseInt(taskDate.split('-')[2]);
                    taskCountByDay[day] = (taskCountByDay[day] || 0) + 1;
                }
            });
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayEl = document.createElement('div');
                dayEl.style.cssText = 'padding: 0.25rem; color: var(--text-secondary); opacity: 0.4; font-size: 0.75rem; text-align: center;';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const dateObj = new Date(year, month, day);
                dateObj.setHours(0, 0, 0, 0);
                
                const isToday = dateObj.getTime() === today.getTime();
                const isInRange = taskDateRangeStart && taskDateRangeEnd && 
                                  dateObj >= taskDateRangeStart && dateObj <= taskDateRangeEnd;
                const taskCount = taskCountByDay[day] || 0;
                
                dayEl.style.padding = '0.25rem';
                dayEl.style.cursor = 'pointer';
                dayEl.style.borderRadius = '4px';
                dayEl.style.transition = 'all 0.2s';
                dayEl.style.fontSize = '0.75rem';
                dayEl.style.fontWeight = '500';
                dayEl.style.textAlign = 'center';
                dayEl.style.position = 'relative';
                dayEl.style.color = isToday ? 'white' : (isInRange ? 'var(--accent-dark)' : 'var(--text-primary)');
                dayEl.style.background = isToday ? 'var(--accent-primary)' : (isInRange ? 'var(--accent-light)' : 'transparent');
                
                // Show task indicator dot
                dayEl.textContent = day;
                if (taskCount > 0 && !isToday) {
                    var dotSpan = document.createElement('span');
                    dotSpan.style.cssText = 'position: absolute; bottom: 1px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%;';
                    dotSpan.style.background = taskCount > 2 ? '#ef4444' : '#f59e0b';
                    dayEl.appendChild(dotSpan);
                }
                
                (function(d, isTdy, isRng) {
                    dayEl.onmouseover = function() {
                        if (!isTdy) this.style.background = isRng ? 'var(--accent-secondary)' : 'var(--accent-light)';
                        if (!isTdy && isRng) this.style.color = 'white';
                    };
                    dayEl.onmouseout = function() {
                        this.style.background = isTdy ? 'var(--accent-primary)' : (isRng ? 'var(--accent-light)' : 'transparent');
                        if (!isTdy && isRng) this.style.color = 'var(--accent-dark)';
                    };
                    dayEl.onclick = function() {
                        // Select this specific date
                        taskDateRangeMode = 'custom';
                        taskDateRangeStart = new Date(year, month, d);
                        taskDateRangeStart.setHours(0, 0, 0, 0);
                        taskDateRangeEnd = new Date(year, month, d);
                        taskDateRangeEnd.setHours(23, 59, 59, 999);
                        taskCalendarDate = new Date(year, month, d);
                        
                        updateTaskDateDisplay();
                        renderTaskSidebarCalendar();
                        renderTasksList();
                        
                        // Also update the header dropdown calendar if open
                        if (taskCalendarOpen) renderTaskCalendar();
                    };
                })(day, isToday, isInRange);
                
                grid.appendChild(dayEl);
            }
            
            // Next month days
            const totalCells = grid.children.length - 7;
            const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells + 7;
            for (let day = 1; day <= remainingCells && grid.children.length < 49; day++) {
                const dayEl = document.createElement('div');
                dayEl.style.cssText = 'padding: 0.25rem; color: var(--text-secondary); opacity: 0.4; font-size: 0.75rem; text-align: center;';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
        }
        
        // Filter by category from sidebar
        window.filterTasksByCategory = function(category) {
            document.getElementById('taskFilterCategory').value = category;
            renderTasksList();
        };
        
        // Show task detail modal
        window.showTaskDetail = function(taskId) {
            const task = window.tasksData.find(t => t.id === taskId);
            if (!task) {
                alert('Task not found!');
                return;
            }
            
            const userRole = localStorage.getItem('userRole');
            const isAdmin = userRole === 'admin';
            const priorityColor = priorityColors[task.priority];
            const statusColor = statusColors[task.status];
            const dueDateFormatted = new Date(task.dueDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const daysOverdue = task.daysOverdue || 0;
            const wasEscalated = task.originalPriority && task.originalPriority !== task.priority;
            
            const modalHtml = `
                <div id="taskDetailModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <span style="padding: 0.25rem 0.6rem; background: ${priorityColor}20; color: ${priorityColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${task.priority}${wasEscalated ? ' â¬†' : ''}</span>
                                    <span style="padding: 0.25rem 0.6rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${task.status}</span>
                                    ${daysOverdue > 0 ? `<span style="padding: 0.25rem 0.6rem; background: #fecaca; color: #b91c1c; border-radius: 4px; font-size: 0.75rem; font-weight: 700;"><i class="fas fa-exclamation-triangle"></i> ${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue</span>` : ''}
                                    ${task.complianceFlag ? '<span style="padding: 0.25rem 0.6rem; background: var(--accent-light); color: var(--accent-dark); border-radius: 4px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-shield-alt"></i> Compliance</span>' : ''}
                                </div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">${task.title}</h3>
                            </div>
                            <button onclick="document.getElementById('taskDetailModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        ${wasEscalated ? `
                        <div style="padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; color: #b91c1c; font-weight: 600;">
                                <i class="fas fa-arrow-up"></i> Priority Escalated: Originally <strong>${task.originalPriority}</strong> â†’ Now <strong>${task.priority}</strong>
                            </div>
                            <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                                This task has been overdue for ${daysOverdue} day${daysOverdue > 1 ? 's' : ''}, causing automatic priority escalation.
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: var(--text-primary); line-height: 1.5;">${task.description}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-user"></i> Assigned To</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.assignee}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-user-friends"></i> Backup</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.secondaryAssignee || 'None'}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-calendar"></i> Due Date</div>
                                <div style="font-weight: 600; color: ${task.status === 'Overdue' ? '#ef4444' : 'var(--text-primary)'}; font-size: 0.9rem;">${dueDateFormatted}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-clock"></i> Due Time</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.dueTime || 'End of Day'}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-folder"></i> Category</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.category}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-redo"></i> Recurrence</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.recurrence}${task.recurrenceDay ? ' - ' + task.recurrenceDay : ''}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-user-tie"></i> Manager</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.manager || 'Not Assigned'}</div>
                            </div>
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-hourglass-half"></i> Est. Time</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.estimatedTime || '?'} mins</div>
                            </div>
                        </div>
                        
                        ${task.linkedContext ? `
                        <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;"><i class="fas fa-link"></i> Linked Context</div>
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${task.linkedContext.type}: ${task.linkedContext.value}</div>
                        </div>
                        ` : ''}
                        
                        <div style="padding: 0.75rem; background: #dcfce7; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: #166534; margin-bottom: 0.25rem;"><i class="fas fa-check-circle"></i> Completion Criteria</div>
                            <div style="font-weight: 600; color: #166534; font-size: 0.9rem;">${task.completionCriteria}</div>
                        </div>
                        
                        ${task.status === 'Completed' ? `
                        <div style="padding: 0.75rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; color: #166534;"><i class="fas fa-check-circle"></i> Completed by <strong>${task.completedBy}</strong> on ${new Date(task.completedAt).toLocaleString()}</div>
                            ${task.notes ? `<div style="font-size: 0.8rem; color: #166534; margin-top: 0.5rem;"><i class="fas fa-sticky-note"></i> ${task.notes}</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${task.status !== 'Completed' ? `
                            <button onclick="markTaskComplete('${task.id}')" style="flex: 1; min-width: 120px; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            <button onclick="updateTaskStatus('${task.id}', 'In Progress')" style="flex: 1; min-width: 120px; padding: 0.75rem; background: var(--accent-secondary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-play"></i> In Progress
                            </button>
                            ` : ''}
                            ${isAdmin ? `
                            <button onclick="openEditTaskModal('${task.id}')" style="flex: 1; min-width: 100px; padding: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteTask('${task.id}')" style="flex: 1; min-width: 100px; padding: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'taskDetailModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        };
        
        // Mark task as complete
        window.markTaskComplete = function(taskId) {
            const task = window.tasksData.find(t => t.id === taskId);
            if (!task) return;
            
            const notes = prompt('Add completion notes (optional):');
            
            task.status = 'Completed';
            task.completedAt = new Date().toISOString();
            task.completedBy = 'Current User'; // In real app, get from session
            task.notes = notes || '';
            
            document.getElementById('taskDetailModal')?.remove();
            renderTasksList();
            renderThisWeekTasks();
            alert('âœ… Task marked as complete!');
        };
        
        // Update task status
        window.updateTaskStatus = function(taskId, newStatus) {
            const task = window.tasksData.find(t => t.id === taskId);
            if (!task) return;
            
            task.status = newStatus;
            document.getElementById('taskDetailModal')?.remove();
            renderTasksList();
            renderThisWeekTasks();
        };
        
        // Delete task
        window.deleteTask = function(taskId) {
            const task = window.tasksData.find(t => t.id === taskId);
            if (!task) return;
            
            if (!confirm(`Are you sure you want to delete this task?\n\n"${task.title}"\n\nThis action cannot be undone.`)) return;
            
            const index = window.tasksData.findIndex(t => t.id === taskId);
            if (index > -1) {
                window.tasksData.splice(index, 1);
                document.getElementById('taskDetailModal')?.remove();
                renderTasksList();
                renderThisWeekTasks();
                alert('ðŸ—‘ï¸ Task deleted successfully!');
            }
        };
        
        // Open create task modal
        window.openCreateTaskModal = function() {
            openTaskFormModal(null);
        };
        
        // Open edit task modal
        window.openEditTaskModal = function(taskId) {
            document.getElementById('taskDetailModal')?.remove();
            openTaskFormModal(taskId);
        };
        
        // Create task from template
        window.createTaskFromTemplate = function(templateId) {
            const template = window.taskTemplates.find(t => t.id === templateId);
            if (!template) {
                alert('Template not found!');
                return;
            }
            
            openTaskFormModal(null, template);
        };
        
        // Render templates in sidebar
        window.renderTemplatesSidebar = function() {
            const container = document.getElementById('templatesSidebarList');
            if (!container) return;
            
            let html = '';
            window.taskTemplates.forEach(template => {
                html += `
                    <a href="#" class="nav-item" onclick="createTaskFromTemplate('${template.id}'); return false;">
                        <i class="fas ${template.icon || 'fa-tasks'}" style="color: ${template.iconColor || '#6b7280'};"></i>
                        <span>${template.title.length > 20 ? template.title.substring(0, 20) + '...' : template.title}</span>
                    </a>
                `;
            });
            container.innerHTML = html;
        };
        
        // Open Manage Templates Modal
        window.openManageTemplatesModal = function() {
            let templatesHtml = '';
            window.taskTemplates.forEach(template => {
                const priorityColor = priorityColors[template.priority] || '#6b7280';
                templatesHtml += `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="width: 36px; height: 36px; background: ${template.iconColor}20; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${template.icon || 'fa-tasks'}" style="color: ${template.iconColor || '#6b7280'};"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${template.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                <span style="color: ${priorityColor};">${template.priority}</span> â€¢ ${template.category} â€¢ ${template.recurrence}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="openEditTemplateModal('${template.id}')" style="background: none; border: none; color: #f59e0b; cursor: pointer; padding: 0.5rem;" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTemplate('${template.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.5rem;" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            const modalHtml = `
                <div id="manageTemplatesModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 550px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                <i class="fas fa-layer-group" style="color: var(--accent-color); margin-right: 0.5rem;"></i>
                                Manage Task Templates
                            </h3>
                            <button onclick="document.getElementById('manageTemplatesModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                <i class="fas fa-info-circle"></i> Templates allow you to quickly create common tasks with pre-filled values. Click on a template in the sidebar to create a task from it.
                            </div>
                            
                            <div id="templatesListManage">
                                ${templatesHtml || '<p style="text-align: center; color: var(--text-secondary);">No templates yet. Create your first one!</p>'}
                            </div>
                        </div>
                        
                        <button onclick="document.getElementById('manageTemplatesModal').remove(); openCreateTemplateModal();" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-plus"></i> Create New Template
                        </button>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'manageTemplatesModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        };
        
        // Open Create Template Modal
        window.openCreateTemplateModal = function() {
            openTemplateFormModal(null);
        };
        
        // Open Edit Template Modal
        window.openEditTemplateModal = function(templateId) {
            document.getElementById('manageTemplatesModal')?.remove();
            openTemplateFormModal(templateId);
        };
        
        // Delete Template
        window.deleteTemplate = function(templateId) {
            const template = window.taskTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            if (!confirm(`Delete template "${template.title}"?\n\nThis will not affect existing tasks created from this template.`)) return;
            
            const index = window.taskTemplates.findIndex(t => t.id === templateId);
            if (index > -1) {
                window.taskTemplates.splice(index, 1);
                renderTemplatesSidebar();
                // Refresh the manage modal if open
                document.getElementById('manageTemplatesModal')?.remove();
                openManageTemplatesModal();
                alert('ðŸ—‘ï¸ Template deleted!');
            }
        };
        
        // Template Form Modal (Create/Edit)
        function openTemplateFormModal(templateId) {
            const template = templateId ? window.taskTemplates.find(t => t.id === templateId) : null;
            const isEdit = !!template;
            const data = template || {};
            
            // Build icon selector grid
            let iconGrid = '';
            templateIconOptions.forEach(opt => {
                const isSelected = data.icon === opt.icon;
                iconGrid += `
                    <div class="icon-option" onclick="selectTemplateIcon('${opt.icon}', '${opt.color}')" 
                         data-icon="${opt.icon}" 
                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; border: 2px solid ${isSelected ? opt.color : 'transparent'}; background: ${isSelected ? opt.color + '20' : 'var(--bg-secondary)'};">
                        <i class="fas ${opt.icon}" style="color: ${opt.color};"></i>
                    </div>
                `;
            });
            
            const modalHtml = `
                <div id="templateFormModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                <i class="fas ${isEdit ? 'fa-edit' : 'fa-plus-circle'}" style="color: ${isEdit ? '#f59e0b' : '#10b981'}; margin-right: 0.5rem;"></i>
                                ${isEdit ? 'Edit Template' : 'Create New Template'}
                            </h3>
                            <button onclick="document.getElementById('templateFormModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="templateForm" style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="hidden" id="templateFormId" value="${template?.id || ''}">
                            <input type="hidden" id="templateFormIcon" value="${data.icon || 'fa-tasks'}">
                            <input type="hidden" id="templateFormIconColor" value="${data.iconColor || '#6b7280'}">
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Template Name *</label>
                                <input type="text" id="templateFormTitle" value="${data.title || ''}" placeholder="e.g., Weekly Inventory Check" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Icon</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                    ${iconGrid}
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Description *</label>
                                <textarea id="templateFormDescription" placeholder="What should be done when this task is assigned..." required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem; min-height: 70px; resize: vertical;">${data.description || ''}</textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Default Priority *</label>
                                    <select id="templateFormPriority" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>Low</option>
                                        <option value="Medium" ${data.priority === 'Medium' || !data.priority ? 'selected' : ''}>Medium</option>
                                        <option value="High" ${data.priority === 'High' ? 'selected' : ''}>High</option>
                                        <option value="Critical" ${data.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Category *</label>
                                    <select id="templateFormCategory" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="Clinical" ${data.category === 'Clinical' ? 'selected' : ''}>Clinical</option>
                                        <option value="Administrative" ${data.category === 'Administrative' ? 'selected' : ''}>Administrative</option>
                                        <option value="Compliance" ${data.category === 'Compliance' ? 'selected' : ''}>Compliance</option>
                                        <option value="Equipment" ${data.category === 'Equipment' ? 'selected' : ''}>Equipment</option>
                                        <option value="Marketing" ${data.category === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                        <option value="Facility" ${data.category === 'Facility' ? 'selected' : ''}>Facility</option>
                                        <option value="Business Center" ${data.category === 'Business Center' ? 'selected' : ''}>Business Center</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Recurrence</label>
                                    <select id="templateFormRecurrence" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="One-time" ${data.recurrence === 'One-time' || !data.recurrence ? 'selected' : ''}>One-time</option>
                                        <option value="Daily" ${data.recurrence === 'Daily' ? 'selected' : ''}>Daily</option>
                                        <option value="Weekly" ${data.recurrence === 'Weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="Monthly" ${data.recurrence === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                        <option value="Quarterly" ${data.recurrence === 'Quarterly' ? 'selected' : ''}>Quarterly</option>
                                        <option value="Annually" ${data.recurrence === 'Annually' || data.recurrence === 'Annual' ? 'selected' : ''}>Annually</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Linked Context Type</label>
                                    <select id="templateFormContextType" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="">None</option>
                                        <option value="Room" ${data.linkedContext?.type === 'Room' ? 'selected' : ''}>Room</option>
                                        <option value="Equipment" ${data.linkedContext?.type === 'Equipment' ? 'selected' : ''}>Equipment</option>
                                        <option value="Process" ${data.linkedContext?.type === 'Process' ? 'selected' : ''}>Process</option>
                                        <option value="Patient" ${data.linkedContext?.type === 'Patient' ? 'selected' : ''}>Patient</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Default Context Value</label>
                                    <input type="text" id="templateFormContextValue" value="${data.linkedContext?.value || ''}" placeholder="e.g., Operatory 1" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Completion Criteria *</label>
                                    <input type="text" id="templateFormCriteria" value="${data.completionCriteria || ''}" placeholder="e.g., Photo uploaded, logged in system" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Est. Time (mins)</label>
                                    <input type="number" id="templateFormEstTime" value="${data.estimatedTime || 30}" min="5" step="5" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="templateFormCompliance" ${data.complianceFlag ? 'checked' : ''}>
                                <label for="templateFormCompliance" style="font-size: 0.85rem; color: var(--text-primary);">
                                    <i class="fas fa-shield-alt" style="color: var(--accent-primary);"></i> This is a compliance/regulatory task
                                </label>
                            </div>
                        </form>
                        
                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                            <button onclick="saveTemplate()" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-save"></i> ${isEdit ? 'Save Changes' : 'Create Template'}
                            </button>
                            <button onclick="document.getElementById('templateFormModal').remove(); openManageTemplatesModal();" style="flex: 1; padding: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'templateFormModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        }
        
        // Select template icon
        window.selectTemplateIcon = function(icon, color) {
            document.getElementById('templateFormIcon').value = icon;
            document.getElementById('templateFormIconColor').value = color;
            
            // Update visual selection
            document.querySelectorAll('#templateFormModal .icon-option').forEach(el => {
                if (el.dataset.icon === icon) {
                    el.style.border = `2px solid ${color}`;
                    el.style.background = color + '20';
                } else {
                    el.style.border = '2px solid transparent';
                    el.style.background = 'var(--bg-secondary)';
                }
            });
        };
        
        // Save template (create or update)
        window.saveTemplate = function() {
            const form = document.getElementById('templateForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const templateId = document.getElementById('templateFormId').value;
            const isEdit = !!templateId;
            
            const contextType = document.getElementById('templateFormContextType').value;
            const contextValue = document.getElementById('templateFormContextValue').value;
            
            const templateData = {
                id: templateId || 'template-' + Date.now(),
                title: document.getElementById('templateFormTitle').value,
                description: document.getElementById('templateFormDescription').value,
                priority: document.getElementById('templateFormPriority').value,
                category: document.getElementById('templateFormCategory').value,
                recurrence: document.getElementById('templateFormRecurrence').value,
                linkedContext: contextType ? { type: contextType, value: contextValue } : null,
                completionCriteria: document.getElementById('templateFormCriteria').value,
                complianceFlag: document.getElementById('templateFormCompliance').checked,
                estimatedTime: parseInt(document.getElementById('templateFormEstTime').value) || 30,
                icon: document.getElementById('templateFormIcon').value,
                iconColor: document.getElementById('templateFormIconColor').value
            };
            
            if (isEdit) {
                const index = window.taskTemplates.findIndex(t => t.id === templateId);
                if (index > -1) {
                    window.taskTemplates[index] = templateData;
                }
            } else {
                window.taskTemplates.push(templateData);
            }
            
            document.getElementById('templateFormModal')?.remove();
            renderTemplatesSidebar();
            openManageTemplatesModal();
            alert(`âœ… Template ${isEdit ? 'updated' : 'created'} successfully!`);
        };

        // Get equipment categories dynamically from saved equipment
        function getEquipmentCategories() {
            const equipment = loadEquipment ? loadEquipment() : [];
            const categories = {};
            
            // Default categories as fallback
            const defaultCategories = {
                'Sterilization': ['Autoclave #1', 'Autoclave #2', 'Ultrasonic Cleaner'],
                'Imaging': ['X-Ray Unit', 'Panoramic X-Ray', 'Intraoral Camera', 'CBCT Scanner'],
                'Dental Chairs': ['Operatory 1 Chair', 'Operatory 2 Chair', 'Operatory 3 Chair'],
                'Handpieces': ['High-Speed Handpiece', 'Low-Speed Handpiece', 'Electric Handpiece'],
                'Lasers': ['Diode Laser', 'CO2 Laser', 'Soft Tissue Laser'],
                'Lab Equipment': ['Curing Light', 'Amalgamator', 'Model Trimmer'],
                'Computers': ['Front Desk PC', 'Operatory 1 PC', 'Server'],
                'HVAC/Facility': ['HVAC System', 'Compressor', 'Vacuum Pump'],
                'Other': []
            };
            
            // Build categories from saved equipment
            equipment.forEach(item => {
                if (item.isActive !== false) {
                    const cat = item.category || 'Other';
                    if (!categories[cat]) {
                        categories[cat] = [];
                    }
                    if (!categories[cat].includes(item.equipmentName)) {
                        categories[cat].push(item.equipmentName);
                    }
                }
            });
            
            // Merge with defaults for empty categories
            Object.keys(defaultCategories).forEach(cat => {
                if (!categories[cat]) {
                    categories[cat] = defaultCategories[cat];
                }
            });
            
            return categories;
        }
        
        // Equipment categories for linked equipment selection (legacy reference)
        const equipmentCategories = {
            'Sterilization': ['Autoclave #1', 'Autoclave #2', 'Ultrasonic Cleaner', 'Sterilization Pouches', 'Chemical Indicators'],
            'Imaging': ['X-Ray Unit', 'Panoramic X-Ray', 'Intraoral Camera', 'CBCT Scanner', 'Digital Sensors'],
            'Dental Chairs': ['Operatory 1 Chair', 'Operatory 2 Chair', 'Operatory 3 Chair', 'Operatory 4 Chair', 'Hygiene Chair 1', 'Hygiene Chair 2'],
            'Handpieces': ['High-Speed Handpiece', 'Low-Speed Handpiece', 'Electric Handpiece', 'Prophy Handpiece'],
            'Lasers': ['Diode Laser', 'CO2 Laser', 'Soft Tissue Laser'],
            'Lab Equipment': ['Curing Light', 'Amalgamator', 'Model Trimmer', 'Vacuum Former'],
            'Computers': ['Front Desk PC', 'Operatory 1 PC', 'Operatory 2 PC', 'Server', 'Tablet'],
            'HVAC/Facility': ['HVAC System', 'Compressor', 'Vacuum Pump', 'Nitrous System', 'Water Filtration'],
            'Other': ['Waiting Room TV', 'Phone System', 'Security System', 'Fire Extinguisher']
        };

        // Task form modal (Create/Edit) - Enhanced Version
        function openTaskFormModal(taskId, template = null) {
            const task = taskId ? window.tasksData.find(t => t.id === taskId) : null;
            const isEdit = !!task;
            const data = task || template || {};
            
            // Get dynamic equipment categories
            const dynamicEquipmentCategories = getEquipmentCategories();
            
            // Get employees from masterData
            const employees = window.masterData ? [...window.masterData.getProviders(), ...window.masterData.getAssistants()] : [];
            
            // Get vendors from localStorage
            const vendors = loadVendors ? loadVendors() : [];
            
            // Get users from localStorage
            const storedUsers = localStorage.getItem('users');
            const usersData = storedUsers ? JSON.parse(storedUsers) : {};
            const usersList = Object.entries(usersData).map(([username, user]) => ({
                id: username,
                name: user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : username,
                role: user.role || 'User'
            }));
            
            // Build assignee options with users and vendors
            let assigneeOptions = '<option value="">Select Assignee</option>';
            assigneeOptions += '<optgroup label="ðŸ‘¤ Users/Employees">';
            employees.forEach(emp => {
                assigneeOptions += `<option value="${emp.title}" ${data.assignee === emp.title ? 'selected' : ''}>${emp.title}</option>`;
            });
            usersList.forEach(user => {
                if (!employees.some(e => e.title === user.name)) {
                    assigneeOptions += `<option value="${user.name}" ${data.assignee === user.name ? 'selected' : ''}>${user.name} (${user.role})</option>`;
                }
            });
            assigneeOptions += '</optgroup>';
            assigneeOptions += '<optgroup label="ðŸ¢ Vendors">';
            vendors.forEach(vendor => {
                assigneeOptions += `<option value="vendor:${vendor.vendorName}" ${data.assignee === 'vendor:' + vendor.vendorName ? 'selected' : ''}>${vendor.vendorName} (Vendor)</option>`;
            });
            assigneeOptions += '</optgroup>';
            
            // Build manager options
            let managerOptions = '<option value="">Select Manager</option>';
            managerOptions += '<optgroup label="ðŸ‘¤ Users/Employees">';
            employees.forEach(emp => {
                managerOptions += `<option value="${emp.title}" ${data.manager === emp.title ? 'selected' : ''}>${emp.title}</option>`;
            });
            usersList.forEach(user => {
                if (!employees.some(e => e.title === user.name)) {
                    managerOptions += `<option value="${user.name}" ${data.manager === user.name ? 'selected' : ''}>${user.name} (${user.role})</option>`;
                }
            });
            managerOptions += '</optgroup>';
            managerOptions += '<optgroup label="ðŸ¢ Vendors">';
            vendors.forEach(vendor => {
                managerOptions += `<option value="vendor:${vendor.vendorName}" ${data.manager === 'vendor:' + vendor.vendorName ? 'selected' : ''}>${vendor.vendorName} (Vendor)</option>`;
            });
            managerOptions += '</optgroup>';
            
            // Build equipment category options from dynamic categories
            let equipmentCategoryOptions = '<option value="">Select Category</option>';
            Object.keys(dynamicEquipmentCategories).forEach(cat => {
                equipmentCategoryOptions += `<option value="${cat}" ${data.linkedEquipment?.category === cat ? 'selected' : ''}>${cat}</option>`;
            });
            
            // Get existing categories for multi-select
            const categories = ['Clinical', 'Administrative', 'Compliance', 'Equipment', 'Marketing', 'Facility', 'Business Center'];
            const selectedCategories = Array.isArray(data.categories) ? data.categories : (data.category ? [data.category] : []);
            
            // Tomorrow's date as default
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toISOString().split('T')[0];
            
            const modalHtml = `
                <div id="taskFormModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 1.5rem; max-width: 750px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                <i class="fas ${isEdit ? 'fa-edit' : 'fa-plus-circle'}" style="color: ${isEdit ? '#f59e0b' : '#10b981'}; margin-right: 0.5rem;"></i>
                                ${isEdit ? 'Edit Task' : 'Create New Task'}
                            </h3>
                            <button onclick="document.getElementById('taskFormModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">&times;</button>
                        </div>
                        
                        <form id="taskForm" style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="hidden" id="taskFormId" value="${task?.id || ''}">
                            
                            <!-- Required Fields Notice -->
                            <div style="background: #fef3c7; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.75rem; color: #92400e;">
                                <i class="fas fa-exclamation-triangle"></i> Required fields are marked with *
                            </div>
                            
                            <!-- Task Title -->
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Task Title *</label>
                                <input type="text" id="taskFormTitle" value="${data.title || ''}" placeholder="Short, action-oriented title (e.g., Weekly Autoclave Spore Test)" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                            </div>
                            
                            <!-- Task Type & Location -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Task Type *</label>
                                    <select id="taskFormTaskType" onchange="toggleTaskTypeFields()" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="Regular" ${data.taskType === 'Regular' || !data.taskType ? 'selected' : ''}>ðŸ“‹ Regular Task</option>
                                        <option value="Floating" ${data.taskType === 'Floating' ? 'selected' : ''}>ðŸŽ¯ Floating Task (Claim-based)</option>
                                        <option value="Bonus" ${data.taskType === 'Bonus' ? 'selected' : ''}>â­ Bonus Task (Paid)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Location</label>
                                    <input type="text" id="taskFormLocation" value="${data.location || ''}" placeholder="e.g., Front Desk, Operatory 1, Any Room" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                            </div>
                            
                            <!-- Bonus/Paid Task Fields (Hidden by default) -->
                            <div id="taskFormBonusFields" style="display: ${data.taskType === 'Bonus' || data.isPaid ? 'grid' : 'none'}; grid-template-columns: 1fr 1fr; gap: 1rem; background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1rem; border-radius: 8px; border: 2px solid #f59e0b;">
                                <div style="grid-column: 1 / -1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-star" style="color: #f59e0b;"></i>
                                        <span style="font-weight: 600; color: #92400e;">Bonus Task Payment</span>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: #92400e;">This Task is Paid</label>
                                    <div style="margin-top: 0.25rem;">
                                        <label style="display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="taskFormIsPaid" ${data.isPaid ? 'checked' : ''} onchange="togglePayAmountField()">
                                            <span style="font-size: 0.9rem; color: #92400e;">Yes, this task offers bonus pay</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: #92400e;">Pay Amount ($)</label>
                                    <input type="number" id="taskFormPayAmount" value="${data.payAmount || ''}" placeholder="e.g., 25.00" min="0" step="0.01" style="width: 100%; padding: 0.6rem; border: 1px solid #f59e0b; border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem; background: white;">
                                </div>
                            </div>
                            
                            <!-- Time Estimate for Floating/Bonus -->
                            <div id="taskFormTimeEstimateRow" style="display: ${data.taskType === 'Floating' || data.taskType === 'Bonus' ? 'block' : 'none'};">
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Time Estimate</label>
                                <input type="text" id="taskFormTimeEstimate" value="${data.timeEstimate || ''}" placeholder="e.g., 30 mins, 1 hour, 2 hours" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Description *</label>
                                <textarea id="taskFormDescription" placeholder="What exactly needs to be done? Include standards or references if applicable..." required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem; min-height: 80px; resize: vertical;">${data.description || ''}</textarea>
                            </div>
                            
                            <!-- Primary & Secondary Assignee -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Primary Assignee * <i class="fas fa-search" style="color: var(--text-secondary); font-size: 0.7rem;"></i></label>
                                    <select id="taskFormAssignee" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        ${assigneeOptions}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Secondary/Backup Assignee <i class="fas fa-search" style="color: var(--text-secondary); font-size: 0.7rem;"></i></label>
                                    <select id="taskFormSecondary" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="">None</option>
                                        ${assigneeOptions.replace('Select Assignee', 'None')}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Due Date, Time, Priority -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Due Date *</label>
                                    <input type="date" id="taskFormDueDate" value="${data.dueDate || defaultDate}" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Due Time</label>
                                    <input type="time" id="taskFormDueTime" value="${data.dueTime || '17:00'}" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Priority * <i class="fas fa-clock" title="Higher priorities auto-escalate" style="color: #f59e0b; font-size: 0.7rem;"></i></label>
                                    <select id="taskFormPriority" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="Low" ${data.priority === 'Low' ? 'selected' : ''}>ðŸŸ¢ Low</option>
                                        <option value="Medium" ${data.priority === 'Medium' || !data.priority ? 'selected' : ''}>ðŸŸ¡ Medium</option>
                                        <option value="High" ${data.priority === 'High' ? 'selected' : ''}>ðŸŸ  High</option>
                                        <option value="Critical" ${data.priority === 'Critical' ? 'selected' : ''}>ðŸ”´ Critical (Auto-Escalate)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Categories (Multi-Select Checkboxes) -->
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">Categories * (Select all that apply)</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px;">
                                    ${categories.map(cat => `
                                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: var(--card-bg); border-radius: 4px; cursor: pointer; font-size: 0.85rem; border: 1px solid var(--border-color);">
                                            <input type="checkbox" name="taskCategories" value="${cat}" ${selectedCategories.includes(cat) ? 'checked' : ''} style="margin-right: 0.25rem;">
                                            ${cat}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Recurrence & Status -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Recurrence</label>
                                    <select id="taskFormRecurrence" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="One-time" ${data.recurrence === 'One-time' || !data.recurrence ? 'selected' : ''}>One-time</option>
                                        <option value="Daily" ${data.recurrence === 'Daily' ? 'selected' : ''}>Daily</option>
                                        <option value="Weekly" ${data.recurrence === 'Weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="Monthly" ${data.recurrence === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                        <option value="Quarterly" ${data.recurrence === 'Quarterly' ? 'selected' : ''}>Quarterly</option>
                                        <option value="Annually" ${data.recurrence === 'Annually' || data.recurrence === 'Annual' ? 'selected' : ''}>Annually</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Status</label>
                                    <select id="taskFormStatus" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        <option value="Pending" ${data.status === 'Pending' || !data.status ? 'selected' : ''}>Pending</option>
                                        <option value="In Progress" ${data.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="Completed" ${data.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        <option value="Overdue" ${data.status === 'Overdue' ? 'selected' : ''}>Overdue</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Task Visibility (Public/Private) -->
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.75rem;">
                                    <i class="fas fa-eye" style="color: var(--accent-primary);"></i> Task Visibility
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem; font-size: 0.75rem;" title="Public tasks are visible to all employees. Private tasks are only visible to selected employees."></i>
                                </label>
                                <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; background: var(--card-bg); border-radius: 6px; border: 2px solid ${!data.visibility || data.visibility === 'public' ? 'var(--accent-primary)' : 'var(--border-color)'};" onclick="toggleTaskVisibility('public')">
                                        <input type="radio" name="taskVisibility" value="public" ${!data.visibility || data.visibility === 'public' ? 'checked' : ''} onchange="toggleTaskVisibility('public')" style="accent-color: var(--accent-primary);">
                                        <i class="fas fa-globe" style="color: #10b981;"></i>
                                        <span style="font-size: 0.9rem;">Public</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; background: var(--card-bg); border-radius: 6px; border: 2px solid ${data.visibility === 'private' ? 'var(--accent-primary)' : 'var(--border-color)'};" onclick="toggleTaskVisibility('private')">
                                        <input type="radio" name="taskVisibility" value="private" ${data.visibility === 'private' ? 'checked' : ''} onchange="toggleTaskVisibility('private')" style="accent-color: var(--accent-primary);">
                                        <i class="fas fa-lock" style="color: #f59e0b;"></i>
                                        <span style="font-size: 0.9rem;">Private</span>
                                    </label>
                                </div>
                                <div id="taskPrivateEmployeesContainer" style="display: ${data.visibility === 'private' ? 'block' : 'none'};">
                                    <label style="font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users"></i> Select employees who can view this task:
                                    </label>
                                    <div id="taskPrivateEmployeesList" style="max-height: 150px; overflow-y: auto; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5rem;">
                                        ${buildPrivateEmployeeCheckboxes(data.visibleTo || [])}
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                        <button type="button" onclick="selectAllPrivateEmployees()" style="padding: 0.4rem 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                            <i class="fas fa-check-double"></i> Select All
                                        </button>
                                        <button type="button" onclick="clearAllPrivateEmployees()" style="padding: 0.4rem 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                            <i class="fas fa-times"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Manager & Estimated Time -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Task Manager/Overseer <i class="fas fa-search" style="color: var(--text-secondary); font-size: 0.7rem;"></i></label>
                                    <select id="taskFormManager" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                        ${managerOptions}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Est. Time (mins)</label>
                                    <input type="number" id="taskFormEstTime" value="${data.estimatedTime || 30}" min="5" step="5" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                </div>
                            </div>
                            
                            <!-- Linked Equipment (Category > Subcategory) -->
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-cog" style="color: var(--accent-primary);"></i> Linked Equipment
                                </label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Equipment Category</label>
                                        <select id="taskFormEquipmentCategory" onchange="updateEquipmentItems()" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                            ${equipmentCategoryOptions}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.75rem; color: var(--text-secondary);">Equipment Item</label>
                                        <select id="taskFormEquipmentItem" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem;">
                                            <option value="">Select Item</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Completion Criteria -->
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Completion Criteria *</label>
                                <textarea id="taskFormCriteria" placeholder="What counts as 'done'? (e.g., Photo of test + log entry, Checkbox + initials, Logged in system)" required style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; margin-top: 0.25rem; min-height: 60px; resize: vertical;">${data.completionCriteria || ''}</textarea>
                            </div>
                            
                            <!-- Training Information -->
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">
                                    <i class="fas fa-graduation-cap" style="color: #8b5cf6;"></i> Training Instructions
                                </label>
                                <textarea id="taskFormTraining" placeholder="Explain the steps to complete this task, or paste a link to pre-recorded training video/document..." style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; min-height: 60px; resize: vertical;">${data.trainingInstructions || ''}</textarea>
                                <div style="margin-top: 0.5rem;">
                                    <label style="font-size: 0.75rem; color: var(--text-secondary);">Training Link (Optional)</label>
                                    <input type="text" id="taskFormTrainingLink" value="${data.trainingLink || ''}" placeholder="Link or file path to training resource" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; margin-top: 0.25rem;">
                                </div>
                            </div>
                            
                            <!-- Compliance Flag -->
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="taskFormCompliance" ${data.complianceFlag ? 'checked' : ''}>
                                <label for="taskFormCompliance" style="font-size: 0.85rem; color: var(--text-primary);">
                                    <i class="fas fa-shield-alt" style="color: var(--accent-primary);"></i> This is a compliance/regulatory task
                                </label>
                            </div>
                        </form>
                        
                        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                            <button onclick="saveTask()" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-save"></i> ${isEdit ? 'Save Changes' : 'Create Task'}
                            </button>
                            <button onclick="document.getElementById('taskFormModal').remove()" style="flex: 1; padding: 0.75rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'taskFormModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
            
            // Set secondary assignee if editing
            if (task?.secondaryAssignee) {
                document.getElementById('taskFormSecondary').value = task.secondaryAssignee;
            }
            
            // Set equipment if editing
            if (data.linkedEquipment?.category) {
                document.getElementById('taskFormEquipmentCategory').value = data.linkedEquipment.category;
                updateEquipmentItems();
                if (data.linkedEquipment?.item) {
                    setTimeout(() => {
                        document.getElementById('taskFormEquipmentItem').value = data.linkedEquipment.item;
                    }, 100);
                }
            }
            
            // Initialize task type fields visibility
            toggleTaskTypeFields();
        }
        
        // Toggle Task Type fields (Bonus/Floating)
        window.toggleTaskTypeFields = function() {
            const taskType = document.getElementById('taskFormTaskType')?.value;
            const bonusFields = document.getElementById('taskFormBonusFields');
            const timeEstimateRow = document.getElementById('taskFormTimeEstimateRow');
            
            if (bonusFields) {
                bonusFields.style.display = (taskType === 'Bonus') ? 'grid' : 'none';
                // Auto-check isPaid for Bonus tasks
                if (taskType === 'Bonus') {
                    document.getElementById('taskFormIsPaid').checked = true;
                }
            }
            
            if (timeEstimateRow) {
                timeEstimateRow.style.display = (taskType === 'Floating' || taskType === 'Bonus') ? 'block' : 'none';
            }
        };
        
        // Toggle Pay Amount field
        window.togglePayAmountField = function() {
            const isPaid = document.getElementById('taskFormIsPaid')?.checked;
            const payAmountInput = document.getElementById('taskFormPayAmount');
            if (payAmountInput) {
                payAmountInput.disabled = !isPaid;
                if (!isPaid) payAmountInput.value = '';
            }
        };
        
        // Build private employee checkboxes for task visibility
        window.buildPrivateEmployeeCheckboxes = function(selectedEmployees = []) {
            const storedUsers = localStorage.getItem('users');
            const usersData = storedUsers ? JSON.parse(storedUsers) : {};
            const employees = Object.entries(usersData).map(([username, user]) => ({
                id: username,
                name: user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : username,
                role: user.role || 'User',
                jobTitle: user.jobTitle || ''
            }));
            
            if (employees.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary); padding: 0.5rem; font-size: 0.85rem;">No employees found</p>';
            }
            
            let html = '';
            employees.forEach(emp => {
                const isChecked = selectedEmployees.includes(emp.id) || selectedEmployees.includes(emp.name);
                html += `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem; cursor: pointer; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="taskPrivateEmployees" value="${emp.id}" ${isChecked ? 'checked' : ''} style="accent-color: var(--accent-primary);">
                        <span style="font-size: 0.85rem; color: var(--text-primary);">${emp.name}</span>
                        <span style="font-size: 0.75rem; color: var(--text-tertiary); margin-left: auto;">${emp.jobTitle || emp.role}</span>
                    </label>
                `;
            });
            return html;
        };
        
        // Toggle task visibility (public/private)
        window.toggleTaskVisibility = function(visibility) {
            const privateContainer = document.getElementById('taskPrivateEmployeesContainer');
            const publicRadio = document.querySelector('input[name="taskVisibility"][value="public"]');
            const privateRadio = document.querySelector('input[name="taskVisibility"][value="private"]');
            
            // Update radio button states
            if (visibility === 'public') {
                publicRadio.checked = true;
                privateRadio.checked = false;
            } else {
                publicRadio.checked = false;
                privateRadio.checked = true;
            }
            
            // Update container styles
            const publicLabel = publicRadio.closest('label');
            const privateLabel = privateRadio.closest('label');
            
            if (visibility === 'public') {
                publicLabel.style.borderColor = 'var(--accent-primary)';
                privateLabel.style.borderColor = 'var(--border-color)';
                if (privateContainer) privateContainer.style.display = 'none';
            } else {
                publicLabel.style.borderColor = 'var(--border-color)';
                privateLabel.style.borderColor = 'var(--accent-primary)';
                if (privateContainer) {
                    privateContainer.style.display = 'block';
                    // Refresh employee list
                    const listContainer = document.getElementById('taskPrivateEmployeesList');
                    if (listContainer) {
                        listContainer.innerHTML = buildPrivateEmployeeCheckboxes([]);
                    }
                }
            }
        };
        
        // Select all private employees
        window.selectAllPrivateEmployees = function() {
            const checkboxes = document.querySelectorAll('input[name="taskPrivateEmployees"]');
            checkboxes.forEach(cb => cb.checked = true);
        };
        
        // Clear all private employees
        window.clearAllPrivateEmployees = function() {
            const checkboxes = document.querySelectorAll('input[name="taskPrivateEmployees"]');
            checkboxes.forEach(cb => cb.checked = false);
        };
        
        // Get selected private employees
        window.getSelectedPrivateEmployees = function() {
            const checkboxes = document.querySelectorAll('input[name="taskPrivateEmployees"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        };
        
        // Update equipment items based on category selection
        window.updateEquipmentItems = function() {
            const category = document.getElementById('taskFormEquipmentCategory').value;
            const itemSelect = document.getElementById('taskFormEquipmentItem');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            // Get dynamic equipment categories
            const dynamicCategories = getEquipmentCategories();
            
            if (category && dynamicCategories[category]) {
                dynamicCategories[category].forEach(item => {
                    itemSelect.innerHTML += `<option value="${item}">${item}</option>`;
                });
            }
        };
        
        // Save task (create or update) - Enhanced Version
        window.saveTask = function() {
            const form = document.getElementById('taskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get selected categories
            const categoryCheckboxes = document.querySelectorAll('input[name="taskCategories"]:checked');
            const selectedCategories = Array.from(categoryCheckboxes).map(cb => cb.value);
            
            if (selectedCategories.length === 0) {
                alert('Please select at least one category.');
                return;
            }
            
            const taskId = document.getElementById('taskFormId').value;
            const isEdit = !!taskId;
            
            // Get linked equipment
            const equipmentCategory = document.getElementById('taskFormEquipmentCategory').value;
            const equipmentItem = document.getElementById('taskFormEquipmentItem').value;
            
            // Get task type fields
            const taskType = document.getElementById('taskFormTaskType')?.value || 'Regular';
            const location = document.getElementById('taskFormLocation')?.value || null;
            const isPaid = document.getElementById('taskFormIsPaid')?.checked || false;
            const payAmount = document.getElementById('taskFormPayAmount')?.value ? parseFloat(document.getElementById('taskFormPayAmount').value) : null;
            const timeEstimate = document.getElementById('taskFormTimeEstimate')?.value || null;
            
            // Get task visibility
            const visibilityRadio = document.querySelector('input[name="taskVisibility"]:checked');
            const visibility = visibilityRadio ? visibilityRadio.value : 'public';
            const visibleTo = visibility === 'private' ? getSelectedPrivateEmployees() : [];
            
            const taskData = {
                id: taskId || 'task-' + Date.now(),
                title: document.getElementById('taskFormTitle').value,
                description: document.getElementById('taskFormDescription').value,
                assignee: document.getElementById('taskFormAssignee').value,
                secondaryAssignee: document.getElementById('taskFormSecondary').value || null,
                dueDate: document.getElementById('taskFormDueDate').value,
                dueTime: document.getElementById('taskFormDueTime').value,
                priority: document.getElementById('taskFormPriority').value,
                categories: selectedCategories,
                category: selectedCategories[0], // Keep primary category for backward compatibility
                recurrence: document.getElementById('taskFormRecurrence').value,
                status: document.getElementById('taskFormStatus').value,
                manager: document.getElementById('taskFormManager').value || null,
                estimatedTime: parseInt(document.getElementById('taskFormEstTime').value) || 30,
                linkedEquipment: equipmentCategory ? { category: equipmentCategory, item: equipmentItem } : null,
                completionCriteria: document.getElementById('taskFormCriteria').value,
                trainingInstructions: document.getElementById('taskFormTraining').value || null,
                trainingLink: document.getElementById('taskFormTrainingLink').value || null,
                complianceFlag: document.getElementById('taskFormCompliance').checked,
                // New task type fields
                taskType: taskType,
                location: location,
                isPaid: isPaid,
                payAmount: payAmount,
                timeEstimate: timeEstimate,
                claimedBy: null,
                claimedAt: null,
                // Task visibility
                visibility: visibility,
                visibleTo: visibleTo,
                // Timestamps
                createdAt: new Date().toISOString(),
                createdBy: 'Admin',
                completedAt: null,
                completedBy: null,
                completedTime: null,
                notes: ''
            };
            
            if (isEdit) {
                const index = window.tasksData.findIndex(t => t.id === taskId);
                if (index > -1) {
                    // Preserve some fields
                    taskData.createdAt = window.tasksData[index].createdAt;
                    taskData.createdBy = window.tasksData[index].createdBy;
                    taskData.completedAt = window.tasksData[index].completedAt;
                    taskData.completedBy = window.tasksData[index].completedBy;
                    taskData.completedTime = window.tasksData[index].completedTime;
                    taskData.notes = window.tasksData[index].notes;
                    taskData.claimedBy = window.tasksData[index].claimedBy;
                    taskData.claimedAt = window.tasksData[index].claimedAt;
                    window.tasksData[index] = taskData;
                    // Update in database
                    if (typeof updateTaskViaAPI === 'function') {
                        updateTaskViaAPI(taskId.replace('task-', ''), {
                            title: taskData.title,
                            description: taskData.description,
                            dueDate: taskData.dueDate || null,
                            priority: taskData.priority,
                            status: taskData.status,
                            category: taskData.category,
                            taskType: taskData.taskType,
                            location: taskData.location,
                            isPaid: taskData.isPaid,
                            payAmount: taskData.payAmount,
                            timeEstimate: taskData.timeEstimate,
                            assignee: taskData.assignee
                        });
                    }
                }
            } else {
                window.tasksData.push(taskData);
                // Save to database
                if (typeof saveTaskToAPI === 'function') {
                    saveTaskToAPI({
                        title: taskData.title,
                        description: taskData.description,
                        dueDate: taskData.dueDate || null,
                        priority: taskData.priority,
                        status: taskData.status,
                        category: taskData.category,
                        taskType: taskData.taskType,
                        location: taskData.location,
                        isPaid: taskData.isPaid,
                        payAmount: taskData.payAmount,
                        timeEstimate: taskData.timeEstimate,
                        assignee: taskData.assignee
                    });
                }
            }
            
            // Save to localStorage
            localStorage.setItem('tasksData', JSON.stringify(window.tasksData));
            
            document.getElementById('taskFormModal')?.remove();
            renderTasksList();
            renderThisWeekTasks();
            alert(`âœ… Task ${isEdit ? 'updated' : 'created'} successfully!`);
        };
        
        // Initialize tasks when switching to tasks view
        const originalSwitchContent = window.switchContentView || switchContentView;
        if (typeof switchContentView === 'function') {
            const _origSwitch = switchContentView;
            switchContentView = function(viewName, event) {
                _origSwitch(viewName, event);
                if (viewName === 'tasks') {
                    setTimeout(initTasksView, 100);
                }
            };
        }

        // Show working hours detail from schedule list (legacy - keeping for compatibility)
        function showWorkingHoursDetail(employeeName, role, startTime, endTime, clinic, room, assistant) {
            const assistantInfo = assistant ? `
                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-top: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ‘¥ Assistant:</div>
                    <div style="font-weight: 600; color: var(--text-primary);">${assistant}</div>
                </div>
            ` : `
                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; margin-top: 0.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">No Assistant Assigned</div>
                </div>
            `;
            
            const modalHtml = `
                <div id="shiftDetailsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0;">
                                    <i class="fas fa-clock" style="color: #10b981; margin-right: 0.5rem;"></i>
                                    Working Hours Shift
                                </h3>
                                <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.9rem;">${new Date().toISOString().split('T')[0]}</p>
                            </div>
                            <button onclick="document.getElementById('shiftDetailsModal').remove()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="padding: 1rem; background: var(--accent-light); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ðŸ‘¤ Employee</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${employeeName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">${role}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">â° Start Time</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${startTime}</div>
                                </div>
                                <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">â° End Time</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${endTime}</div>
                                </div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸ¥ Clinic</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${clinic}</div>
                            </div>
                            
                            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">ðŸšª Room</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${room}</div>
                            </div>
                            
                            ${assistantInfo}
                        </div>
                        
                        <button onclick="document.getElementById('shiftDetailsModal').remove()" style="margin-top: 1.5rem; width: 100%; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            const modalEl = modalContainer.firstElementChild;
            
            // Close on background click
            modalEl.addEventListener('click', function(e) {
                if (e.target.id === 'shiftDetailsModal') {
                    modalEl.remove();
                }
            });
            
            document.body.appendChild(modalEl);
        }

        // ========== PDF EXPORT FUNCTIONS ==========
        function exportWorkingHoursToPDF() {
            if (whCurrentView === 'month') {
                exportMonthViewToPDF();
            } else if (whCurrentView === 'week') {
                exportWeekViewToPDF();
            } else {
                exportDayViewToPDF();
            }
        }

        function exportMonthViewToPDF() {
            const filename = `ReformDental_Schedule_${whCurrentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).replace(' ', '_')}.pdf`;
            
            const opt = {
                margin: [8, 8, 12, 8],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: true, logging: false },
                jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4', compress: true }
            };

            const exportContent = document.createElement('div');
            exportContent.style.padding = '0';
            exportContent.style.fontFamily = 'Arial, sans-serif';
            exportContent.style.backgroundColor = '#ffffff';
            exportContent.style.width = '100%';
            
            // Header
            const header = document.createElement('div');
            header.style.marginBottom = '8px';
            header.style.borderBottom = '3px solid #10b981';
            header.style.paddingBottom = '6px';
            header.style.pageBreakAfter = 'avoid';
            header.innerHTML = `
                <h1 style="margin: 0 0 2px 0; color: #10b981; font-size: 18px; font-weight: bold;">ReformDental - Monthly Schedule</h1>
                <p style="margin: 2px 0; color: #555; font-size: 10px;">
                    <strong>${whCurrentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</strong> | Generated: ${new Date().toLocaleDateString('en-US')}
                </p>
            `;
            exportContent.appendChild(header);

            // Create simple list-based month view
            const year = whCurrentDate.getFullYear();
            const month = whCurrentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const filteredStaff = getFilteredStaffDatabase();

            const daysContainer = document.createElement('div');
            daysContainer.style.width = '100%';
            daysContainer.style.display = 'grid';
            daysContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
            daysContainer.style.gap = '6px';

            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                const dayName = cellDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                const dayBox = document.createElement('div');
                dayBox.style.marginBottom = '0';
                dayBox.style.pageBreakInside = 'avoid';
                dayBox.style.backgroundColor = '#f9f9f9';
                dayBox.style.border = '1px solid #ddd';
                dayBox.style.borderRadius = '3px';
                dayBox.style.padding = '6px';

                const dayHeader = document.createElement('div');
                dayHeader.style.backgroundColor = '#10b981';
                dayHeader.style.color = 'white';
                dayHeader.style.padding = '4px 6px';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.fontSize = '11px';
                dayHeader.style.marginBottom = '4px';
                dayHeader.style.borderRadius = '2px';
                dayHeader.innerHTML = `${dayName} ${day}`;
                dayBox.appendChild(dayHeader);

                const shiftsContainer = document.createElement('div');
                shiftsContainer.style.fontSize = '9px';

                let hasContent = false;
                filteredStaff.forEach(staff => {
                    const shift = whGenerateShifts(staff.id, cellDate);
                    if (shift.type !== 'off' && isDateInFilterRange(cellDate)) {
                        hasContent = true;
                        const shiftBox = document.createElement('div');
                        shiftBox.style.marginBottom = '2px';
                        shiftBox.style.padding = '3px 4px';
                        shiftBox.style.backgroundColor = getShiftColor(shift.type);
                        shiftBox.style.color = 'white';
                        shiftBox.style.borderRadius = '2px';
                        shiftBox.style.lineHeight = '1.2';
                        shiftBox.style.fontSize = '8px';
                        
                        const icon = staff.type === 'provider' ? 'ðŸ‘¨â€âš•ï¸' : 'ðŸ‘¤';
                        shiftBox.innerHTML = `<strong>${icon} ${staff.name}</strong> ${getShiftLabel(shift.type)}`;
                        shiftsContainer.appendChild(shiftBox);
                    }
                });

                if (!hasContent) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.style.color = '#999';
                    emptyDiv.style.fontSize = '10px';
                    emptyDiv.style.fontStyle = 'italic';
                    emptyDiv.style.padding = '4px';
                    emptyDiv.textContent = '(No schedule)';
                    shiftsContainer.appendChild(emptyDiv);
                }

                dayBox.appendChild(shiftsContainer);
                daysContainer.appendChild(dayBox);
            }

            exportContent.appendChild(daysContainer);

            // Add legend at end
            const legend = document.createElement('div');
            legend.style.marginTop = '12px';
            legend.style.borderTop = '2px solid #ddd';
            legend.style.paddingTop = '10px';
            legend.style.fontSize = '10px';
            legend.innerHTML = `
                <strong>Legend:</strong> 
                <span style="display: inline-block; margin-left: 10px;"><span style="display: inline-block; width: 10px; height: 10px; background: #10b981; margin-right: 4px;"></span>Morning (8 AM-4 PM)</span>
                <span style="display: inline-block; margin-left: 10px;"><span style="display: inline-block; width: 10px; height: 10px; background: #3b82f6; margin-right: 4px;"></span>Evening (4-10 PM)</span>
                <span style="display: inline-block; margin-left: 10px;"><span style="display: inline-block; width: 10px; height: 10px; background: #8b5cf6; margin-right: 4px;"></span>Night (10 PM-6 AM)</span>
            `;
            exportContent.appendChild(legend);

            html2pdf().set(opt).from(exportContent).save();
        }

        function exportWeekViewToPDF() {
            const weekStart = new Date(whCurrentDate);
            weekStart.setDate(whCurrentDate.getDate() - whCurrentDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const filename = `ReformDental_Weekly_Schedule_${weekStart.toLocaleDateString('en-US').replace(/\//g, '-')}.pdf`;
            
            const opt = {
                margin: [8, 8, 12, 8],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: true, logging: false },
                jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4', compress: true }
            };

            const exportContent = document.createElement('div');
            exportContent.style.padding = '0';
            exportContent.style.fontFamily = 'Arial, sans-serif';
            exportContent.style.backgroundColor = '#ffffff';
            exportContent.style.width = '100%';
            
            // Header
            const header = document.createElement('div');
            header.style.marginBottom = '8px';
            header.style.borderBottom = '3px solid #3b82f6';
            header.style.paddingBottom = '6px';
            header.style.pageBreakAfter = 'avoid';
            header.innerHTML = `
                <h1 style="margin: 0 0 2px 0; color: #3b82f6; font-size: 18px; font-weight: bold;">ReformDental - Weekly Schedule</h1>
                <p style="margin: 2px 0; color: #555; font-size: 10px;">
                    <strong>${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</strong> | Generated: ${new Date().toLocaleDateString('en-US')}
                </p>
            `;
            exportContent.appendChild(header);

            // Create week layout
            const filteredStaff = getFilteredStaffDatabase();
            
            for (let day = 0; day < 7; day++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + day);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dayNum = date.getDate();

                const dayBox = document.createElement('div');
                dayBox.style.marginBottom = '8px';
                dayBox.style.pageBreakInside = 'avoid';
                dayBox.style.backgroundColor = '#f9f9f9';
                dayBox.style.border = '2px solid #3b82f6';
                dayBox.style.borderRadius = '3px';
                dayBox.style.padding = '8px';

                const dayHeader = document.createElement('div');
                dayHeader.style.backgroundColor = '#3b82f6';
                dayHeader.style.color = 'white';
                dayHeader.style.padding = '6px';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.fontSize = '11px';
                dayHeader.style.marginBottom = '6px';
                dayHeader.style.borderRadius = '2px';
                dayHeader.innerHTML = `${dayName} - ${dayNum}`;
                dayBox.appendChild(dayHeader);

                const staffContainer = document.createElement('div');
                staffContainer.style.fontSize = '8px';

                let dayHasContent = false;

                filteredStaff.forEach(staff => {
                    if (staff.type === 'provider') {
                        staff.clinics.forEach(clinicId => {
                            const assignments = providerAssignments[clinicId] || [];
                            const providerAssigns = assignments.filter(a => a.providerId === staff.id);
                            
                            providerAssigns.forEach(assign => {
                                dayHasContent = true;
                                const staffCard = document.createElement('div');
                                staffCard.style.marginBottom = '4px';
                                staffCard.style.padding = '4px';
                                staffCard.style.backgroundColor = '#dbeafe';
                                staffCard.style.border = '1px solid #3b82f6';
                                staffCard.style.borderRadius = '2px';
                                staffCard.style.lineHeight = '1.2';
                                staffCard.innerHTML = `
                                    <strong style="color: #1e40af; font-size: 9px;">ðŸ‘¨â€âš•ï¸ ${staff.name}</strong><br>
                                    <small style="font-size: 8px;">Clinic: ${clinicDetails[clinicId].name}</small><br>
                                    <small style="font-size: 8px;">Room: ${assign.room} | Asst: ${assign.assistantName || '-'}</small><br>
                                    <small style="font-size: 8px; font-weight: bold; color: #1e40af;">â° ${assign.shift}</small>
                                `;
                                staffContainer.appendChild(staffCard);
                            });
                        });
                    } else if (staff.type === 'assistant') {
                        staff.clinics.forEach(clinicId => {
                            const assignments = providerAssignments[clinicId] || [];
                            const assistantAssigns = assignments.filter(a => a.assistantId === staff.id);
                            
                            assistantAssigns.forEach(assign => {
                                dayHasContent = true;
                                const staffCard = document.createElement('div');
                                staffCard.style.marginBottom = '4px';
                                staffCard.style.padding = '4px';
                                staffCard.style.backgroundColor = '#fef3c7';
                                staffCard.style.border = '1px solid #f59e0b';
                                staffCard.style.borderRadius = '2px';
                                staffCard.style.lineHeight = '1.2';
                                staffCard.innerHTML = `
                                    <strong style="color: #92400e; font-size: 9px;">ðŸ‘¤ ${staff.name}</strong><br>
                                    <small style="font-size: 8px;">Provider: ${assign.providerName}</small><br>
                                    <small style="font-size: 8px;">Room: ${assign.room}</small><br>
                                    <small style="font-size: 8px; font-weight: bold; color: #92400e;">â° ${assign.shift}</small>
                                `;
                                staffContainer.appendChild(staffCard);
                            });
                        });
                    }
                });

                if (!dayHasContent) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.style.color = '#999';
                    emptyDiv.style.fontSize = '9px';
                    emptyDiv.style.fontStyle = 'italic';
                    emptyDiv.style.padding = '4px';
                    emptyDiv.textContent = 'No schedule for this day';
                    staffContainer.appendChild(emptyDiv);
                }

                dayBox.appendChild(staffContainer);
                exportContent.appendChild(dayBox);
            }

            html2pdf().set(opt).from(exportContent).save();
        }

        function getShiftColor(type) {
            const colors = {
                'morning': '#10b981',
                'afternoon': '#3b82f6',
                'evening': '#8b5cf6',
                'night': '#6366f1'
            };
            return colors[type] || '#999';
        }

        function getShiftLabel(type) {
            const labels = {
                'morning': '(8 AM - 4 PM)',
                'afternoon': '(4 PM - 10 PM)',
                'evening': '(4 PM - 10 PM)',
                'night': '(10 PM - 6 AM)'
            };
            return labels[type] || '';
        }

        function exportDayViewToPDF() {
            const filename = `ReformDental_Daily_Schedule_${whCurrentDate.toLocaleDateString('en-US').replace(/\//g, '-')}.pdf`;
            
            const opt = {
                margin: [10, 10, 15, 10],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: true, logging: false },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4', compress: true }
            };

            const exportContent = document.createElement('div');
            exportContent.style.padding = '0';
            exportContent.style.fontFamily = 'Arial, sans-serif';
            exportContent.style.backgroundColor = '#fff';
            
            const header = document.createElement('div');
            header.style.marginBottom = '15px';
            header.style.background = 'linear-gradient(135deg, #10b981, #6ee7b7)';
            header.style.color = 'white';
            header.style.padding = '15px';
            header.style.borderRadius = '6px';
            header.style.textAlign = 'center';
            header.style.pageBreakAfter = 'avoid';
            header.innerHTML = `
                <h1 style="margin: 0 0 5px 0; font-size: 22px; font-weight: bold;">${whCurrentDate.toLocaleDateString('en-US', { weekday: 'long' })}</h1>
                <p style="margin: 0; font-size: 14px;">${whCurrentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                <p style="margin: 5px 0 0 0; font-size: 10px;">Generated: ${new Date().toLocaleDateString('en-US')}</p>
            `;
            exportContent.appendChild(header);

            const filteredStaff = getFilteredStaffDatabase();
            const contentDiv = document.createElement('div');

            let hasContent = false;

            filteredStaff.forEach(staff => {
                const shift = whGenerateShifts(staff.id, whCurrentDate);
                
                if (staff.type === 'provider') {
                    staff.clinics.forEach(clinicId => {
                        const assignments = providerAssignments[clinicId] || [];
                        const providerAssigns = assignments.filter(a => a.providerId === staff.id);
                        
                        providerAssigns.forEach(assign => {
                            hasContent = true;
                            const card = document.createElement('div');
                            card.style.marginBottom = '12px';
                            card.style.padding = '12px';
                            card.style.backgroundColor = '#dbeafe';
                            card.style.border = '2px solid #3b82f6';
                            card.style.borderRadius = '5px';
                            card.style.pageBreakInside = 'avoid';
                            card.innerHTML = `
                                <h3 style="margin: 0 0 8px 0; color: #1e40af; font-size: 13px;">ðŸ‘¨â€âš•ï¸ ${staff.name}</h3>
                                <div style="backgroundColor: white; padding: 8px; border-radius: 3px; font-size: 11px; line-height: 1.5;">
                                    <p style="margin: 3px 0;"><strong>Clinic:</strong> ${clinicDetails[clinicId].name}</p>
                                    <p style="margin: 3px 0;"><strong>Room:</strong> ${assign.room}</p>
                                    <p style="margin: 3px 0;"><strong>Assistant:</strong> ${assign.assistantName || 'No Assistant'}</p>
                                    <p style="margin: 3px 0;"><strong>Shift:</strong> ${assign.shift}</p>
                                </div>
                            `;
                            contentDiv.appendChild(card);
                        });
                    });
                } else if (staff.type === 'assistant') {
                    staff.clinics.forEach(clinicId => {
                        const assignments = providerAssignments[clinicId] || [];
                        const assistantAssigns = assignments.filter(a => a.assistantId === staff.id);
                        
                        assistantAssigns.forEach(assign => {
                            hasContent = true;
                            const card = document.createElement('div');
                            card.style.marginBottom = '12px';
                            card.style.padding = '12px';
                            card.style.backgroundColor = '#fef3c7';
                            card.style.border = '2px solid #f59e0b';
                            card.style.borderRadius = '5px';
                            card.style.pageBreakInside = 'avoid';
                            card.innerHTML = `
                                <h3 style="margin: 0 0 8px 0; color: #92400e; font-size: 13px;">ðŸ‘¤ ${staff.name}</h3>
                                <div style="backgroundColor: white; padding: 8px; border-radius: 3px; font-size: 11px; line-height: 1.5;">
                                    <p style="margin: 3px 0;"><strong>Clinic:</strong> ${clinicDetails[clinicId].name}</p>
                                    <p style="margin: 3px 0;"><strong>Provider:</strong> ${assign.providerName}</p>
                                    <p style="margin: 3px 0;"><strong>Room:</strong> ${assign.room}</p>
                                    <p style="margin: 3px 0;"><strong>Shift:</strong> ${assign.shift}</p>
                                </div>
                            `;
                            contentDiv.appendChild(card);
                        });
                    });
                } else {
                    if (shift.type !== 'off') {
                        hasContent = true;
                        const card = document.createElement('div');
                        card.style.marginBottom = '12px';
                        card.style.padding = '12px';
                        card.style.backgroundColor = '#f3f4f6';
                        card.style.border = '2px solid #6b7280';
                        card.style.borderRadius = '5px';
                        card.style.pageBreakInside = 'avoid';
                        card.innerHTML = `
                            <h3 style="margin: 0 0 8px 0; color: #4b5563; font-size: 13px;">${staff.name}</h3>
                            <div style="backgroundColor: white; padding: 8px; border-radius: 3px; font-size: 11px; line-height: 1.5;">
                                <p style="margin: 3px 0;"><strong>Clinic:</strong> ${clinicDetails[staff.clinics[0]].name}</p>
                                <p style="margin: 3px 0;"><strong>Role:</strong> Clinic Staff</p>
                                <p style="margin: 3px 0;"><strong>Shift:</strong> ${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}</p>
                            </div>
                        `;
                        contentDiv.appendChild(card);
                    }
                }
            });

            if (!hasContent) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.padding = '20px';
                emptyDiv.style.textAlign = 'center';
                emptyDiv.style.color = '#999';
                emptyDiv.style.fontSize = '14px';
                emptyDiv.textContent = 'No schedule for this day';
                contentDiv.appendChild(emptyDiv);
            }

            exportContent.appendChild(contentDiv);
            html2pdf().set(opt).from(exportContent).save();
        }

        function switchWorkingHoursView(view) {
            whCurrentView = view;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            document.getElementById('whMonthView').classList.toggle('hidden', view !== 'month');
            document.getElementById('whWeekView').classList.toggle('hidden', view !== 'week');
            document.getElementById('whDayView').classList.toggle('hidden', view !== 'day');
            
            whRenderCalendar();
        }

        function workingHoursPrevious() {
            if (whCurrentView === 'month') whCurrentDate.setMonth(whCurrentDate.getMonth() - 1);
            else if (whCurrentView === 'week') whCurrentDate.setDate(whCurrentDate.getDate() - 7);
            else whCurrentDate.setDate(whCurrentDate.getDate() - 1);
            whRenderCalendar();
        }

        function workingHoursNext() {
            if (whCurrentView === 'month') whCurrentDate.setMonth(whCurrentDate.getMonth() + 1);
            else if (whCurrentView === 'week') whCurrentDate.setDate(whCurrentDate.getDate() + 7);
            else whCurrentDate.setDate(whCurrentDate.getDate() + 1);
            whRenderCalendar();
        }

        function workingHoursGoToday() {
            whCurrentDate = new Date();
            whRenderCalendar();
        }

        function whRenderCalendar() {
            whUpdateDateDisplay();
            whRenderMiniCalendar();
            if (whCurrentView === 'month') whRenderMonth();
            else if (whCurrentView === 'week') whRenderWeekView();
            else if (whCurrentView === 'day') whRenderDay();
        }

        function whUpdateDateDisplay() {
            const display = document.getElementById('whCurrentDate');
            if (whCurrentView === 'month') {
                display.textContent = whCurrentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            } else if (whCurrentView === 'week') {
                const weekStart = new Date(whCurrentDate);
                weekStart.setDate(whCurrentDate.getDate() - whCurrentDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                display.textContent = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
                display.textContent = whCurrentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            }
        }

        function whRenderMonth() {
            console.log('=== RENDERING MONTH VIEW ===');
            const year = whCurrentDate.getFullYear();
            const month = whCurrentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const monthDaysContainer = document.getElementById('whMonthDays');
            if (!monthDaysContainer) {
                console.error('whMonthDays container not found!');
                return;
            }
            monthDaysContainer.innerHTML = '';
            
            // Get filtered staff for this month
            const filteredStaff = getFilteredStaffDatabase();
            console.log('Filtered staff for month view:', filteredStaff.length);
            filteredStaff.forEach(emp => {
                console.log('  - Processing:', emp.id, emp.title);
            });
            
            // Add previous month's days
            for (let i = firstDay - 1; i >= 0; i--) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell other-month';
                cell.innerHTML = `<div class="cell-date">${daysInPrevMonth - i}</div>`;
                monthDaysContainer.appendChild(cell);
            }
            
            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const date = new Date(year, month, day);
                cell.className = 'calendar-cell';
                if (date.toDateString() === new Date().toDateString()) cell.classList.add('today');
                
                let html = `<div class="cell-date">${day}</div><div class="cell-shifts">`;
                let shiftCount = 0;
                
                filteredStaff.forEach(employee => {
                    const shift = whGenerateShifts(employee.id, date);
                    console.log(`  ${employee.title} on ${date.toDateString()}: ${shift.type}`);
                    if (shift.type !== 'off' && isDateInFilterRange(date)) {
                        const role = employee.extendedProps?.role || 'Staff';
                        const timeRange = `${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}`;
                        const shiftColor = employee.extendedProps?.color || '#10b981';
                        const badgeId = `badge-${employee.id}-${date.toISOString().split('T')[0]}`;
                        
                        // Create simpler badge without nested spans
                        html += `<div class="shift-badge ${shift.type}" 
                                 id="${badgeId}"
                                 style="cursor: pointer; border-left: 4px solid ${shiftColor}; pointer-events: auto;" 
                                 data-employee-id="${employee.id}" 
                                 data-shift-date="${date.toISOString().split('T')[0]}" 
                                 data-shift-start="${shift.startTime}" 
                                 data-shift-end="${shift.endTime}">
                            ${employee.title} â€¢ ${timeRange}
                        </div>`;
                        shiftCount++;
                    }
                });
                
                console.log(`Day ${day}: ${shiftCount} shifts found`);
                html += '</div>';
                cell.innerHTML = html;
                monthDaysContainer.appendChild(cell);
            }
            
            // Add next month's days
            const remaining = 42 - monthDaysContainer.children.length;
            for (let day = 1; day <= remaining; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell other-month';
                cell.innerHTML = `<div class="cell-date">${day}</div>`;
                monthDaysContainer.appendChild(cell);
            }
            
            // Add event delegation listener to container
            monthDaysContainer.addEventListener('click', function(e) {
                const badge = e.target.closest('.shift-badge');
                if (badge) {
                    console.log('Shift badge clicked via delegation!');
                    const employeeId = badge.getAttribute('data-employee-id');
                    const shiftDate = badge.getAttribute('data-shift-date');
                    const shiftStart = badge.getAttribute('data-shift-start');
                    const shiftEnd = badge.getAttribute('data-shift-end');
                    console.log('Calling showWorkingHoursDetails:', employeeId, shiftDate, shiftStart, shiftEnd);
                    showWorkingHoursDetails(employeeId, shiftDate, shiftStart, shiftEnd);
                }
            });
            
            console.log('=== MONTH VIEW RENDERED ===');
        }

        function whRenderWeekView() {
            const weekStart = new Date(whCurrentDate);
            weekStart.setDate(whCurrentDate.getDate() - whCurrentDate.getDay());
            
            // Render header with day names and dates
            const headerContainer = document.getElementById('whWeekTimelineHeader');
            headerContainer.innerHTML = '';
            
            for (let day = 0; day < 7; day++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + day);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();
                
                const header = document.createElement('div');
                header.className = 'timeline-day-header';
                header.innerHTML = `${dayName}<br><strong>${dayNum}</strong>`;
                headerContainer.appendChild(header);
            }
            
            // Render grid with day columns
            const gridContainer = document.getElementById('whWeekTimelineGrid');
            gridContainer.innerHTML = '';
            
            const filteredStaff = getFilteredStaffDatabase();
            
            for (let day = 0; day < 7; day++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + day);
                
                const dayColumn = document.createElement('div');
                dayColumn.className = 'week-day-column';
                
                // Highlight today
                if (date.toDateString() === new Date().toDateString()) {
                    dayColumn.classList.add('today');
                }
                
                // Add day header
                const dayHeader = document.createElement('div');
                dayHeader.style.fontWeight = '700';
                dayHeader.style.fontSize = '0.95rem';
                dayHeader.style.marginBottom = '0.75rem';
                dayHeader.style.color = 'var(--text-primary)';
                dayHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                dayColumn.appendChild(dayHeader);
                
                // Create content area for cards
                const contentArea = document.createElement('div');
                contentArea.style.display = 'flex';
                contentArea.style.flexDirection = 'column';
                contentArea.style.gap = '0.75rem';
                
                // Build staff cards for this day with same detail as day view
                let hasContent = false;
                
                filteredStaff.forEach(staff => {
                    const shift = whGenerateShifts(staff.id, date);
                    
                    if (staff.type === 'provider') {
                        // Show provider with their rooms and assistants
                        staff.clinics.forEach(clinicId => {
                            const assignments = providerAssignments[clinicId] || [];
                            const providerAssigns = assignments.filter(a => a.providerId === staff.id);
                            
                            providerAssigns.forEach(assign => {
                                hasContent = true;
                                const card = document.createElement('div');
                                card.className = 'day-provider-card';
                                card.style.borderLeftColor = clinicDetails[clinicId].color;
                                card.style.fontSize = '0.8rem';
                                card.style.padding = '0.6rem';
                                
                                let cardHtml = `
                                    <div class="day-provider-name" style="font-size: 0.9rem;">ðŸ‘¨â€âš•ï¸ ${staff.name}</div>
                                    <div class="clinic-section-header" style="font-size: 0.75rem;">${clinicDetails[clinicId].name}</div>
                                    <div class="day-room-detail">
                                        <div class="day-room-name">${assign.room}</div>
                                `;
                                
                                if (assign.assistantName) {
                                    cardHtml += `<div class="day-assistant">ðŸ‘¤ ${assign.assistantName}</div>`;
                                } else {
                                    cardHtml += `<div class="day-assistant" style="font-style: italic; color: var(--text-secondary);">No Assistant</div>`;
                                }
                                
                                cardHtml += `
                                        <div class="day-shift"><i class="fas fa-clock"></i> ${assign.shift}</div>
                                    </div>
                                `;
                                
                                card.innerHTML = cardHtml;
                                contentArea.appendChild(card);
                            });
                        });
                    } else if (staff.type === 'assistant') {
                        // Show assistant with their providers
                        staff.clinics.forEach(clinicId => {
                            const assignments = providerAssignments[clinicId] || [];
                            const assistantAssigns = assignments.filter(a => a.assistantId === staff.id);
                            
                            assistantAssigns.forEach(assign => {
                                hasContent = true;
                                const card = document.createElement('div');
                                card.className = 'day-provider-card';
                                card.style.borderLeftColor = clinicDetails[clinicId].color;
                                card.style.fontSize = '0.8rem';
                                card.style.padding = '0.6rem';
                                
                                const cardHtml = `
                                    <div class="day-provider-name" style="font-size: 0.9rem;">ðŸ‘¤ ${staff.name}</div>
                                    <div class="clinic-section-header" style="font-size: 0.75rem;">${clinicDetails[clinicId].name}</div>
                                    <div class="day-room-detail">
                                        <div class="day-room-name">ðŸ‘¨â€âš•ï¸ ${assign.providerName}</div>
                                        <div class="day-shift"><i class="fas fa-door-open"></i> ${assign.room}</div>
                                        <div class="day-shift"><i class="fas fa-clock"></i> ${assign.shift}</div>
                                    </div>
                                `;
                                
                                card.innerHTML = cardHtml;
                                contentArea.appendChild(card);
                            });
                        });
                    } else {
                        // Other staff
                        if (shift.type !== 'off') {
                            hasContent = true;
                            const card = document.createElement('div');
                            card.className = 'day-provider-card';
                            card.style.borderLeftColor = clinicDetails[staff.clinics[0]].color;
                            card.style.fontSize = '0.8rem';
                            card.style.padding = '0.6rem';
                            
                            card.innerHTML = `
                                <div class="day-provider-name" style="font-size: 0.9rem;">${staff.name}</div>
                                <div class="clinic-section-header" style="font-size: 0.75rem;">${clinicDetails[staff.clinics[0]].name}</div>
                                <div class="day-room-detail">
                                    <div style="color: var(--text-secondary); font-style: italic; font-size: 0.75rem;">Clinic Staff</div>
                                    <div class="day-shift"><i class="fas fa-clock"></i> ${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}</div>
                                </div>
                            `;
                            
                            contentArea.appendChild(card);
                        }
                    }
                });
                
                if (!hasContent) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.style.color = 'var(--text-secondary)';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.fontSize = '0.9rem';
                    emptyMsg.style.padding = '1rem';
                    emptyMsg.textContent = 'No schedule';
                    contentArea.appendChild(emptyMsg);
                }
                
                dayColumn.appendChild(contentArea);
                gridContainer.appendChild(dayColumn);
            }
        }

        function whRenderWeek() {
            const weekStart = new Date(whCurrentDate);
            weekStart.setDate(whCurrentDate.getDate() - whCurrentDate.getDay());
            
            const filteredStaff = getFilteredStaffDatabase();
            const numEmployees = Math.max(filteredStaff.length, 1);
            const numDays = 7;
            
            // Generate time slots (6 AM to 10 PM)
            const timeSlots = [];
            for (let hour = 6; hour < 22; hour++) {
                timeSlots.push(hour);
            }
            
            // Build week header with dates and employee names
            const weekHeader = document.getElementById('whWeekHeader');
            weekHeader.innerHTML = '<div class="week-time-label">Time</div>';
            
            // Create column layout: Time | Day1Emp1 | Day1Emp2 | ... | Day2Emp1 | etc
            const gridTemplateColumns = `80px repeat(${numDays * numEmployees}, 1fr)`;
            weekHeader.style.display = 'grid';
            weekHeader.style.gridTemplateColumns = gridTemplateColumns;
            
            // Add date column headers
            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + dayIdx);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayDate = date.getDate();
                
                const dateCol = document.createElement('div');
                dateCol.className = 'week-date-column-header';
                dateCol.innerHTML = `<div class="week-date-name">${dayName}</div><div class="week-date-num">${dayDate}</div>`;
                dateCol.style.gridColumn = `${dayIdx * numEmployees + 2} / span ${numEmployees}`;
                dateCol.style.borderBottom = '2px solid var(--accent-primary)';
                weekHeader.appendChild(dateCol);
            }
            
            // Add employee sub-headers
            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                filteredStaff.forEach((staff, staffIdx) => {
                    const empHeader = document.createElement('div');
                    empHeader.className = 'week-employee-column-header';
                    empHeader.textContent = staff.title;
                    empHeader.style.gridColumn = `${dayIdx * numEmployees + staffIdx + 2}`;
                    weekHeader.appendChild(empHeader);
                });
            }
            
            // Build timeline grid
            const weekTimeline = document.getElementById('whWeekTimeline');
            weekTimeline.innerHTML = '';
            weekTimeline.style.display = 'grid';
            weekTimeline.style.gridTemplateColumns = gridTemplateColumns;
            weekTimeline.style.gridAutoRows = '60px';
            
            // Add time labels and shift blocks
            timeSlots.forEach((hour, hourIdx) => {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-row';
                timeLabel.style.gridRow = `${hourIdx + 1}`;
                timeLabel.style.gridColumn = '1';
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
                timeLabel.textContent = `${displayHour} ${ampm}`;
                weekTimeline.appendChild(timeLabel);
                
                // Add cells for each day/employee combination
                for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + dayIdx);
                    
                    filteredStaff.forEach((staff, staffIdx) => {
                        const shift = whGenerateShifts(staff.id, date);
                        const colIdx = dayIdx * numEmployees + staffIdx + 2;
                        
                        if (shift.type !== 'off' && isDateInFilterRange(date)) {
                            const startHour = parseInt(shift.startTime.split(':')[0]);
                            const endHour = parseInt(shift.endTime.split(':')[0]);
                            
                            // Only render on the first hour of the shift
                            if (hour === startHour) {
                                const cell = document.createElement('div');
                                cell.className = `shift-event-badge ${shift.type}`;
                                cell.textContent = `${staff.title}\n${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}`;
                                cell.title = `${staff.title} - ${convertTo12Hour(shift.startTime)} to ${convertTo12Hour(shift.endTime)}`;
                                cell.style.gridColumn = colIdx;
                                cell.style.gridRow = `${hourIdx + 1} / span ${endHour - startHour}`;
                                cell.style.margin = '3px';
                                cell.style.whiteSpace = 'pre-wrap';
                                cell.style.fontSize = '0.7rem';
                                cell.style.padding = '6px 4px';
                                cell.style.cursor = 'pointer';
                                
                                // Store data for click handler
                                cell.dataset.employeeId = staff.id;
                                cell.dataset.shiftDate = date.toISOString().split('T')[0];
                                cell.dataset.shiftStart = shift.startTime;
                                cell.dataset.shiftEnd = shift.endTime;
                                
                                // Add click listener
                                cell.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    console.log('Week shift clicked:', this.dataset.employeeId);
                                    showWorkingHoursDetails(
                                        this.dataset.employeeId,
                                        this.dataset.shiftDate,
                                        this.dataset.shiftStart,
                                        this.dataset.shiftEnd
                                    );
                                });
                                
                                weekTimeline.appendChild(cell);
                            }
                        } else if (shift.type === 'off' && isDateInFilterRange(date) && hour === timeSlots[0]) {
                            // Show OFF status only once per day/employee
                            const cell = document.createElement('div');
                            cell.className = 'shift-event-badge off';
                            cell.textContent = 'OFF';
                            cell.style.gridColumn = colIdx;
                            cell.style.gridRow = `${hourIdx + 1}`;
                            cell.style.margin = '3px';
                            cell.style.fontSize = '0.65rem';
                            cell.style.padding = '4px';
                            weekTimeline.appendChild(cell);
                        }
                    });
                }
            });
        }

        function whRenderDay() {
            console.log('=== RENDERING DAY VIEW ===');
            const dayHeader = document.getElementById('whDayHeader');
            const dayName = whCurrentDate.toLocaleDateString('en-US', { weekday: 'long' });
            const dayDate = whCurrentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            dayHeader.innerHTML = `<h3>${dayName}</h3><p>${dayDate}</p>`;
            
            // Get filtered staff for this day
            const filteredStaff = getFilteredStaffDatabase();
            console.log('Day view - Filtered staff:', filteredStaff.length, 'employees');
            
            const dayContent = document.getElementById('whDayContent');
            if (!dayContent) {
                console.error('whDayContent not found!');
                return;
            }
            dayContent.innerHTML = '';
            
            // Create a grid container
            const gridContainer = document.createElement('div');
            gridContainer.className = 'day-view-grid';
            gridContainer.style.display = 'flex';
            gridContainer.style.flexDirection = 'column';
            gridContainer.style.gap = '1rem';
            
            let shiftCount = 0;
            let offCount = 0;
            
            filteredStaff.forEach(employee => {
                const shift = whGenerateShifts(employee.id, whCurrentDate);
                console.log(`Day view - ${employee.title}: ${shift.type} (${shift.startTime}-${shift.endTime})`);
                
                if (shift.type === 'off') {
                    // Show as off day
                    const card = document.createElement('div');
                    card.className = 'day-provider-card';
                    card.style.borderLeftColor = employee.extendedProps?.color || '#10b981';
                    card.style.opacity = '0.6';
                    card.innerHTML = `
                        <div class="day-provider-name" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">ðŸŒ™</span>
                            <span>${employee.title}</span>
                        </div>
                        <div class="day-shift" style="color: var(--text-secondary);">Day Off</div>
                    `;
                    gridContainer.appendChild(card);
                    offCount++;
                } else {
                    // Show shift details
                    const card = document.createElement('div');
                    card.className = 'day-provider-card';
                    card.style.borderLeftColor = employee.extendedProps?.color || '#10b981';
                    card.style.cursor = 'pointer';
                    
                    const startTime = new Date(`2000-01-01T${shift.startTime}:00`);
                    const endTime = new Date(`2000-01-01T${shift.endTime}:00`);
                    
                    card.innerHTML = `
                        <div class="day-provider-name" style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">ðŸ‘¤</span>
                            <span>${employee.title}</span>
                        </div>
                        <div class="clinic-section-header">${employee.extendedProps?.role || 'Staff'}</div>
                        <div class="day-room-detail">
                            <div class="day-shift"><i class="fas fa-clock"></i> ${startTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                            <div class="day-shift" style="text-transform: capitalize;"><i class="fas fa-briefcase"></i> ${shift.type} Shift</div>
                        </div>
                    `;
                    
                    // Store data in element for click handler
                    card.dataset.employeeId = employee.id;
                    card.dataset.shiftDate = whCurrentDate.toISOString().split('T')[0];
                    card.dataset.shiftStart = shift.startTime;
                    card.dataset.shiftEnd = shift.endTime;
                    
                    // Add click listener
                    card.addEventListener('click', function() {
                        console.log('Day card clicked:', this.dataset.employeeId);
                        showWorkingHoursDetails(
                            this.dataset.employeeId, 
                            this.dataset.shiftDate, 
                            this.dataset.shiftStart, 
                            this.dataset.shiftEnd
                        );
                    });
                    
                    gridContainer.appendChild(card);
                    shiftCount++;
                }
            });
            
            console.log(`Day view complete: ${shiftCount} shifts, ${offCount} days off`);
            
            if (filteredStaff.length === 0) {
                gridContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No employees to display</div>';
            }
            
            dayContent.appendChild(gridContainer);
            console.log('=== DAY VIEW RENDERED ===');
        }

        // Helper function to convert 24-hour time to 12-hour AM/PM format
        function convertTo12Hour(time24) {
            if (!time24) return time24;
            const [hours, minutes] = time24.split(':');
            let hours24 = parseInt(hours);
            const period = hours24 >= 12 ? 'PM' : 'AM';
            hours24 = hours24 % 12 || 12;
            return `${hours24}:${minutes} ${period}`;
        }

        // ========== FILTER STATE MANAGEMENT ==========
        const whFilterState = {
            clinic: '',
            employee: '',
            dateStart: null,
            dateEnd: null
        };

        // Initialize filters on page load
        function initializeWorkingHoursFilters() {
            const employeeSelect = document.getElementById('whEmployeeFilter');
            
            // If element doesn't exist, don't try to initialize
            if (!employeeSelect) {
                console.warn('whEmployeeFilter element not found in DOM');
                return;
            }
            
            updateEmployeeFilterByClinic();
            
            // Clear date filters
            const dateStartEl = document.getElementById('whDateFilterStart');
            const dateEndEl = document.getElementById('whDateFilterEnd');
            if (dateStartEl) dateStartEl.value = '';
            if (dateEndEl) dateEndEl.value = '';
            
            // Reset filters
            whFilterState.clinic = '';
            whFilterState.employee = '';
            whFilterState.dateStart = null;
            whFilterState.dateEnd = null;
            
            console.log('Filter initialization complete');
        }
        
        // Update employee dropdown based on selected clinic
        function updateEmployeeFilterByClinic() {
            const employeeSelect = document.getElementById('whEmployeeFilter');
            if (!employeeSelect) return;
            
            const currentEmployee = whFilterState.employee;
            employeeSelect.innerHTML = '<option value="">All Employees</option>';
            
            // Use employeeResources (unified database)
            if (employeeResources && Array.isArray(employeeResources)) {
                let filteredEmployees = employeeResources;
                
                // If clinic is selected, filter employees by clinic
                if (whFilterState.clinic) {
                    filteredEmployees = employeeResources.filter(emp => {
                        const clinics = emp.extendedProps?.clinics || [];
                        return clinics.includes(whFilterState.clinic);
                    });
                    console.log('Filtered employees for clinic', whFilterState.clinic, ':', filteredEmployees.map(e => e.title));
                }
                
                filteredEmployees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.title;
                    employeeSelect.appendChild(option);
                });
                
                // Restore previous selection if still valid
                if (currentEmployee) {
                    const isStillValid = filteredEmployees.some(emp => emp.id === currentEmployee);
                    if (isStillValid) {
                        employeeSelect.value = currentEmployee;
                    } else {
                        whFilterState.employee = '';
                    }
                }
                
                console.log('Updated employee filter with', filteredEmployees.length, 'employees');
            } else {
                console.warn('employeeResources not available');
            }
        }

        // Get filtered employee list for working hours display
        function getFilteredStaffDatabase() {
            if (!employeeResources || employeeResources.length === 0) {
                console.warn('employeeResources is empty or not defined');
                return [];
            }
            
            let filtered = [...employeeResources];
            
            console.log('=== GET FILTERED STAFF DATABASE ===');
            console.log('Starting with employee count:', filtered.length);
            console.log('All employees:', filtered.map(e => ({ id: e.id, title: e.title, role: e.extendedProps?.role })));

            // Filter by clinic if selected
            if (whFilterState.clinic) {
                console.log('Filtering by clinic:', whFilterState.clinic);
                filtered = filtered.filter(employee => {
                    const clinics = employee.extendedProps?.clinics || [];
                    const matches = clinics.includes(whFilterState.clinic);
                    console.log(`  Employee ${employee.title} - clinics: [${clinics.join(', ')}] - matches: ${matches}`);
                    return matches;
                });
                console.log('After clinic filter:', filtered.length, filtered.map(e => e.title));
            }

            // Filter by employee if selected
            if (whFilterState.employee) {
                console.log('Filtering by employee:', whFilterState.employee);
                filtered = filtered.filter(employee => {
                    const matches = employee.id == whFilterState.employee;
                    console.log(`  Employee ${employee.title} (id: ${employee.id}) - matches: ${matches}`);
                    if (matches) {
                        // Log sample shifts for this employee
                        const testDate = new Date();
                        const shift = whGenerateShifts(employee.id, testDate);
                        console.log(`    Sample shift for today: ${shift.type} ${shift.startTime}-${shift.endTime}`);
                    }
                    return matches;
                });
                console.log('After employee filter:', filtered.length, filtered.map(e => e.title));
            }

            console.log('=== FINAL FILTERED RESULT ===');
            console.log('Returning:', filtered.length, 'employees');
            filtered.forEach(e => {
                console.log(`  - ${e.id}: ${e.title} (${e.extendedProps?.role})`);
            });
            return filtered;
        }

        // Check if a date is within the filter range
        function isDateInFilterRange(date) {
            if (!whFilterState.dateStart && !whFilterState.dateEnd) {
                return true;
            }

            const dateTime = date.getTime();
            if (whFilterState.dateStart && dateTime < whFilterState.dateStart.getTime()) {
                return false;
            }
            if (whFilterState.dateEnd) {
                const endDate = new Date(whFilterState.dateEnd);
                endDate.setHours(23, 59, 59, 999);
                if (dateTime > endDate.getTime()) {
                    return false;
                }
            }

            return true;
        }

        // Mini Calendar Variables
        let whMiniCalendarDate = new Date();
        let whIsDragging = false;
        let whDragOffsetX = 0;
        let whDragOffsetY = 0;

        // Enable dragging for mini calendar
        function whEnableDrag() {
            const calendar = document.getElementById('whMiniCalendar');
            const header = calendar.querySelector('.wh-mini-calendar-header');
            
            header.addEventListener('mousedown', (e) => {
                whIsDragging = true;
                whDragOffsetX = e.clientX - calendar.offsetLeft;
                whDragOffsetY = e.clientY - calendar.offsetTop;
                header.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!whIsDragging) return;
                const calendar = document.getElementById('whMiniCalendar');
                calendar.style.left = (e.clientX - whDragOffsetX) + 'px';
                calendar.style.top = (e.clientY - whDragOffsetY) + 'px';
                calendar.style.right = 'auto';
                calendar.style.bottom = 'auto';
            });

            document.addEventListener('mouseup', () => {
                whIsDragging = false;
                header.style.cursor = 'grab';
            });
        }

        // Show/hide month/year picker
        function whShowMonthYearPicker() {
            const picker = document.getElementById('whMonthYearPicker');
            if (!picker) return;
            
            const isOpen = picker.classList.contains('open');
            
            if (!isOpen) {
                whPopulatePickerOptions();
                picker.classList.add('open');
            } else {
                picker.classList.remove('open');
            }
        }

        // Populate month and year options in picker
        function whPopulatePickerOptions() {
            const picker = document.getElementById('whMonthYearPicker');
            if (!picker) return;

            const year = whMiniCalendarDate.getFullYear();
            const month = whMiniCalendarDate.getMonth();
            const currentYear = new Date().getFullYear();

            // Find or create months section
            let monthsSection = picker.querySelector('.wh-months-section');
            if (!monthsSection) {
                monthsSection = document.createElement('div');
                monthsSection.className = 'wh-months-section';
                monthsSection.innerHTML = '<div class="wh-picker-section-title">Month</div>';
                const monthsGrid = document.createElement('div');
                monthsGrid.className = 'wh-months-grid';
                monthsSection.appendChild(monthsGrid);
                picker.appendChild(monthsSection);
            }

            // Update month options
            const monthsGrid = monthsSection.querySelector('.wh-months-grid');
            monthsGrid.innerHTML = '';
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            months.forEach((mon, idx) => {
                const opt = document.createElement('div');
                opt.className = 'wh-month-year-option';
                if (idx === month) opt.classList.add('active');
                opt.textContent = mon;
                opt.onclick = () => whSelectMonth(idx);
                monthsGrid.appendChild(opt);
            });

            // Find or create years section
            let yearsSection = picker.querySelector('.wh-years-section');
            if (!yearsSection) {
                yearsSection = document.createElement('div');
                yearsSection.className = 'wh-years-section';
                yearsSection.innerHTML = '<div class="wh-picker-section-title">Year</div>';
                const yearsGrid = document.createElement('div');
                yearsGrid.className = 'wh-years-grid';
                yearsSection.appendChild(yearsGrid);
                picker.appendChild(yearsSection);
            }

            // Update year options (current year Â± 5 years)
            const yearsGrid = yearsSection.querySelector('.wh-years-grid');
            yearsGrid.innerHTML = '';
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                const opt = document.createElement('div');
                opt.className = 'wh-month-year-option';
                if (y === year) opt.classList.add('active');
                opt.textContent = y;
                opt.onclick = () => whSelectYear(y);
                yearsGrid.appendChild(opt);
            }
        }

        // Select month from picker
        function whSelectMonth(monthIndex) {
            whMiniCalendarDate.setMonth(monthIndex);
            whCurrentDate.setMonth(monthIndex);
            whRenderMiniCalendar();
            switchWorkingHoursView('month');
            whShowMonthYearPicker();
        }

        // Select year from picker
        function whSelectYear(selectedYear) {
            whMiniCalendarDate.setFullYear(selectedYear);
            whCurrentDate.setFullYear(selectedYear);
            whRenderMiniCalendar();
            switchWorkingHoursView('month');
            whShowMonthYearPicker();
        }

        // Render mini calendar
        function whRenderMiniCalendar() {
            const year = whMiniCalendarDate.getFullYear();
            const month = whMiniCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const container = document.getElementById('whMiniCalendar');
            
            // Preserve picker if it exists and is open
            let pickerHTML = '';
            const existingPicker = container.querySelector('#whMonthYearPicker');
            const pickerWasOpen = existingPicker && existingPicker.classList.contains('open');
            const isMinimized = container.classList.contains('minimized');
            
            container.innerHTML = '';

            // Header with month/year and nav buttons
            const header = document.createElement('div');
            header.className = 'wh-mini-calendar-header';
            header.innerHTML = `
                <div class="wh-mini-calendar-nav">
                    <button onclick="whPrevMiniMonth()"><i class="fas fa-chevron-left"></i></button>
                    <button onclick="whNextMiniMonth()"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="wh-mini-calendar-month" onclick="whShowMonthYearPicker()" style="user-select: none; flex: 1;">${new Date(year, month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</div>
                <div class="wh-mini-calendar-header-actions">
                    <button class="wh-mini-toggle-btn" onclick="whToggleMiniCalendar()" title="Toggle minimize">
                        <i class="fas ${isMinimized ? 'fa-expand' : 'fa-compress'}"></i>
                    </button>
                </div>
            `;
            container.appendChild(header);

            // Month/Year Picker
            const picker = document.createElement('div');
            picker.id = 'whMonthYearPicker';
            picker.className = 'wh-month-year-picker';
            if (pickerWasOpen) picker.classList.add('open');
            container.appendChild(picker);

            // Weekday headers
            const weekdays = document.createElement('div');
            weekdays.className = 'wh-mini-calendar-weekdays';
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'wh-mini-calendar-weekday';
                dayEl.textContent = day;
                weekdays.appendChild(dayEl);
            });
            container.appendChild(weekdays);

            // Days grid
            const days = document.createElement('div');
            days.className = 'wh-mini-calendar-days';

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayEl = document.createElement('div');
                dayEl.className = 'wh-mini-calendar-day other-month';
                dayEl.textContent = daysInPrevMonth - i;
                days.appendChild(dayEl);
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'wh-mini-calendar-day';
                dayEl.textContent = day;

                const currentDate = new Date(year, month, day);

                // Check if today
                if (currentDate.toDateString() === today.toDateString()) {
                    dayEl.classList.add('today');
                }

                // Check if selected (current whCurrentDate)
                if (currentDate.toDateString() === whCurrentDate.toDateString()) {
                    dayEl.classList.add('selected');
                }

                // Click to navigate
                dayEl.onclick = () => {
                    whCurrentDate = new Date(year, month, day);
                    whRenderMiniCalendar();
                    switchWorkingHoursView('day');
                };

                days.appendChild(dayEl);
            }

            // Next month days
            const remaining = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= remaining; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'wh-mini-calendar-day other-month';
                dayEl.textContent = day;
                days.appendChild(dayEl);
            }

            container.appendChild(days);

            // Add Today button
            const todayBtn = document.createElement('button');
            todayBtn.className = 'wh-mini-calendar-today-btn';
            todayBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Today';
            todayBtn.onclick = whMiniCalendarGoToday;
            container.appendChild(todayBtn);
            
            // Populate picker options if it was open
            if (pickerWasOpen) {
                whPopulatePickerOptions();
            }
            
            // Enable dragging
            setTimeout(() => whEnableDrag(), 100);
        }

        function whPrevMiniMonth() {
            whMiniCalendarDate.setMonth(whMiniCalendarDate.getMonth() - 1);
            whRenderMiniCalendar();
        }

        function whNextMiniMonth() {
            whMiniCalendarDate.setMonth(whMiniCalendarDate.getMonth() + 1);
            whRenderMiniCalendar();
        }

        // Toggle minimize/maximize mini calendar
        function whToggleMiniCalendar() {
            const container = document.getElementById('whMiniCalendar');
            container.classList.toggle('minimized');
        }

        // Jump to today in mini calendar
        function whMiniCalendarGoToday() {
            whMiniCalendarDate = new Date();
            whCurrentDate = new Date();
            whRenderCalendar();
            whRenderMiniCalendar();
        }

        // Apply working hours filters and re-render
        function applyWorkingHoursFilters() {
            console.log('=== FILTER APPLICATION START ===');
            
            try {
                // Update filter state - safely check if elements exist
                const clinicFilterEl = document.getElementById('whClinicFilter');
                
                if (clinicFilterEl) {
                    whFilterState.clinic = clinicFilterEl.value;
                    console.log('Clinic filter selected:', whFilterState.clinic);
                }

                console.log('Filter State:', whFilterState);
                
                // Force re-render by calling changeCalendarView with current view
                if (window.changeCalendarView && window.calendarInstance) {
                    const currentView = window.calendarInstance.currentView;
                    window.changeCalendarView(currentView);
                }

                console.log('=== FILTER APPLICATION COMPLETE ===');
            } catch (e) {
                console.error('Error in applyWorkingHoursFilters:', e);
            }
        }

        // Show employee profile card with clinic assignments and relationships
        function showEmployeeProfileCard(employeeId) {
            const employee = employeeResources.find(emp => emp.id == employeeId);
            if (!employee) return;

            // Populate employee info
            const initials = employee.title.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('empAvatar').textContent = initials;
            document.getElementById('empName').textContent = employee.title;
            document.getElementById('empRole').textContent = employee.extendedProps?.role || 'Staff';

            const clinicsContent = document.getElementById('clinicsContent');
            clinicsContent.innerHTML = '';

            // Show employee role and color
            const roleSection = document.createElement('div');
            roleSection.className = 'clinic-section';
            roleSection.style.padding = '1rem';
            roleSection.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: ${employee.extendedProps?.color || '#10b981'};"></div>
                    <div>
                        <strong>${employee.extendedProps?.role || 'Staff'}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">ID: ${employee.id}</div>
                    </div>
                </div>
            `;
            clinicsContent.appendChild(roleSection);

            document.getElementById('employeeProfileCard').classList.remove('hidden');
        }

        // Show information for a provider (doctor)
        function showProviderInfo(container, employee, clinicId) {
            const assignments = providerAssignments[clinicId] || [];
            const providerAssigns = assignments.filter(a => a.providerId === employee.id);

            if (providerAssigns.length === 0) {
                const noAssign = document.createElement('div');
                noAssign.className = 'no-assistant';
                noAssign.innerHTML = '<i class="fas fa-user-slash"></i> No assistants assigned';
                container.appendChild(noAssign);
                return;
            }

            providerAssigns.forEach(assign => {
                const providerItem = document.createElement('div');
                providerItem.className = 'provider-item';
                providerItem.style.borderLeftColor = clinicDetails[clinicId].color;

                let html = `<div class="provider-name">${assign.room}</div>`;
                
                if (assign.assistantName) {
                    html += `
                        <div class="assistant-info">
                            <i class="fas fa-user"></i>
                            <span>${assign.assistantName}</span>
                        </div>
                    `;
                } else {
                    html += `<div class="no-assistant"><i class="fas fa-user-slash"></i> No Assistant</div>`;
                }

                html += `<div class="shift-time"><i class="fas fa-clock"></i> ${assign.shift}</div>`;

                providerItem.innerHTML = html;
                container.appendChild(providerItem);
            });
        }

        // Show information for an assistant
        function showAssistantInfo(container, employee, clinicId) {
            const assignments = providerAssignments[clinicId] || [];
            const assistantAssigns = assignments.filter(a => a.assistantId === employee.id);

            if (assistantAssigns.length === 0) {
                const clinicOnlyInfo = document.createElement('div');
                clinicOnlyInfo.className = 'clinic-only-info';
                clinicOnlyInfo.innerHTML = `<i class="fas fa-building"></i> No Provider Assigned`;
                container.appendChild(clinicOnlyInfo);
                return;
            }

            assistantAssigns.forEach(assign => {
                const assistantItem = document.createElement('div');
                assistantItem.className = 'provider-item';
                assistantItem.style.borderLeftColor = clinicDetails[clinicId].color;

                const html = `
                    <div class="provider-name"><i class="fas fa-user-md"></i> ${assign.providerName}</div>
                    <div class="room-info"><i class="fas fa-door-open"></i> ${assign.room}</div>
                    <div class="shift-time"><i class="fas fa-clock"></i> ${assign.shift}</div>
                `;

                assistantItem.innerHTML = html;
                container.appendChild(assistantItem);
            });
        }

        // Close employee profile card
        function closeEmployeeProfileCard() {
            document.getElementById('employeeProfileCard').classList.add('hidden');
        }
        function resetWorkingHoursFilters() {
            // Clear all filter dropdowns
            const clinicFilter = document.getElementById('whClinicFilter');
            if (clinicFilter) {
                clinicFilter.value = '';
            }
            
            // Reset filter state
            whFilterState.clinic = '';
            whFilterState.employee = '';
            whFilterState.dateStart = null;
            whFilterState.dateEnd = null;
            
            // Re-render the main calendar
            if (window.calendarInstance) {
                window.calendarInstance.render();
            }
        }

        // ========== SYNC MECHANISMS WITH OTHER CALENDARS ==========

        // Sync working hours with big calendar employees
        function syncWorkingHoursWithBigCalendar() {
            // Get filtered staff
            const filteredStaff = getFilteredStaffDatabase();
            
            // Update big calendar with filtered employee data
            // This assumes your big calendar is using FullCalendar
            if (window.bigCalendar && window.bigCalendar.getApi) {
                const api = window.bigCalendar.getApi();
                
                // Remove all existing resource events
                const events = api.getEvents();
                events.forEach(event => {
                    if (event.extendedProps && event.extendedProps.type === 'workingHours') {
                        event.remove();
                    }
                });

                // Add new events for filtered staff
                filteredStaff.forEach(staff => {
                    // Generate events for the calendar view range
                    const calendarInfo = api.currentData.calendarOptions;
                    const viewStart = api.view.activeStart;
                    const viewEnd = api.view.activeEnd;

                    // Create working hours events
                    const currentDate = new Date(viewStart);
                    while (currentDate < viewEnd) {
                        if (isDateInFilterRange(currentDate)) {
                            const shift = whGenerateShifts(staff.id, new Date(currentDate));
                            if (shift.type !== 'off') {
                                api.addEvent({
                                    title: `${staff.name} - ${shift.type}`,
                                    start: `${currentDate.toISOString().split('T')[0]}T${shift.startTime}:00`,
                                    end: `${currentDate.toISOString().split('T')[0]}T${shift.endTime}:00`,
                                    resourceId: staff.id,
                                    extendedProps: {
                                        type: 'workingHours',
                                        shiftType: shift.type,
                                        staffId: staff.id
                                    },
                                    backgroundColor: getShiftColor(shift.type)
                                });
                            }
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                });
            }
        }

        // Sync working hours with quick calendar
        function syncWorkingHoursWithQuickCalendar() {
            // Get filtered staff
            const filteredStaff = getFilteredStaffDatabase();
            
            // Update quick calendar display
            if (window.quickCalendarContainer) {
                const container = document.getElementById(window.quickCalendarContainer);
                if (container) {
                    // Update the quick calendar with filtered data
                    // This might involve updating event displays or indicator dots
                    filteredStaff.forEach(staff => {
                        const staffElement = container.querySelector(`[data-staff-id="${staff.id}"]`);
                        if (staffElement) {
                            const shift = whGenerateShifts(staff.id, whCurrentDate);
                            const shiftIndicator = staffElement.querySelector('.shift-indicator');
                            if (shiftIndicator) {
                                shiftIndicator.className = `shift-indicator ${shift.type}`;
                                shiftIndicator.textContent = shift.type !== 'off' ? `${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}` : 'Off';
                            }
                        }
                    });
                }
            }
        }

        // Sync working hours with schedule view
        function syncWorkingHoursWithScheduleView() {
            // Get filtered staff and date range
            const filteredStaff = getFilteredStaffDatabase();
            const scheduleContainer = document.getElementById('scheduleViewContainer');
            
            if (scheduleContainer) {
                // Update schedule table/view with filtered data
                filteredStaff.forEach(staff => {
                    const staffRow = scheduleContainer.querySelector(`[data-staff-id="${staff.id}"]`);
                    if (staffRow) {
                        // Update shift information for each day in filter range
                        let currentDate = whFilterState.dateStart || new Date();
                        const endDate = whFilterState.dateEnd || new Date();
                        
                        while (currentDate <= endDate) {
                            const shift = whGenerateShifts(staff.id, new Date(currentDate));
                            const dayCell = staffRow.querySelector(`[data-date="${currentDate.toISOString().split('T')[0]}"]`);
                            if (dayCell) {
                                dayCell.className = `schedule-day-cell ${shift.type}`;
                                dayCell.textContent = shift.type !== 'off' ? `${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}` : 'Off';
                            }
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                });
            }
        }

        // Helper function to get shift color based on type
        function getShiftColor(shiftType) {
            const colors = {
                'morning': '#10b981',
                'afternoon': '#3b82f6',
                'evening': '#8b5cf6',
                'off': '#ef4444'
            };
            return colors[shiftType] || '#gray';
        }

        // Modified render functions to use filtered data
        function whRenderMonthWithFilters() {
            const filteredStaff = getFilteredStaffDatabase();
            const monthDaysContainer = document.getElementById('whMonthDays');
            monthDaysContainer.innerHTML = '';

            const year = whCurrentDate.getFullYear();
            const month = whCurrentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            const startDate = firstDay.getDay();

            for (let i = startDate - 1; i >= 0; i--) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell other-month';
                cell.innerHTML = `<div class="cell-date">${prevMonthDays - i}</div>`;
                monthDaysContainer.appendChild(cell);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cell = document.createElement('div');
                const cellDate = new Date(year, month, day);
                
                cell.className = 'calendar-cell';
                if (cellDate.toDateString() === new Date().toDateString()) {
                    cell.classList.add('today');
                }

                let cellContent = `<div class="cell-date">${day}</div><div class="cell-shifts">`;

                filteredStaff.forEach(staff => {
                    const shift = whGenerateShifts(staff.id, cellDate);
                    if (shift.type !== 'off') {
                        cellContent += `<div class="mini-shift ${shift.type}" title="${staff.name}">${staff.initials}</div>`;
                    }
                });

                cellContent += '</div>';
                cell.innerHTML = cellContent;
                monthDaysContainer.appendChild(cell);
            }

            const remaining = 42 - (startDate + lastDay.getDate());
            for (let day = 1; day <= remaining; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell other-month';
                cell.innerHTML = `<div class="cell-date">${day}</div>`;
                monthDaysContainer.appendChild(cell);
            }
        }

        function whRenderWeekWithFilters() {
            const filteredStaff = getFilteredStaffDatabase();
            const weekStart = new Date(whCurrentDate);
            weekStart.setDate(whCurrentDate.getDate() - whCurrentDate.getDay());
            
            const weekHeader = document.getElementById('whWeekHeader');
            weekHeader.innerHTML = '<div class="week-time-label">Time</div>';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayDate = date.getDate();
                const col = document.createElement('div');
                col.className = 'week-day-column';
                col.innerHTML = `<div class="week-day-name">${dayName}</div><div class="week-day-date">${dayDate}</div>`;
                weekHeader.appendChild(col);
            }
            
            const weekTimeline = document.getElementById('whWeekTimeline');
            weekTimeline.innerHTML = '';
            
            for (let hour = 6; hour < 22; hour++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-row';
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
                timeLabel.textContent = `${displayHour} ${ampm}`;
                weekTimeline.appendChild(timeLabel);
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    const cell = document.createElement('div');
                    cell.className = 'time-cell';
                    
                    if (isDateInFilterRange(date)) {
                        filteredStaff.forEach(staff => {
                            const shift = whGenerateShifts(staff.id, date);
                            if (shift.type !== 'off') {
                                const startHour = parseInt(shift.startTime.split(':')[0]);
                                const endHour = parseInt(shift.endTime.split(':')[0]);
                                
                                if (hour >= startHour && hour < endHour) {
                                    const badge = document.createElement('div');
                                    badge.className = `shift-event-badge ${shift.type}`;
                                    badge.textContent = staff.initials;
                                    badge.title = `${staff.name} - ${convertTo12Hour(shift.startTime)} to ${convertTo12Hour(shift.endTime)}`;
                                    cell.appendChild(badge);
                                }
                            }
                        });
                    }
                    
                    weekTimeline.appendChild(cell);
                }
            }
        }

        function whRenderDayWithFilters() {
            const filteredStaff = getFilteredStaffDatabase();
            const dayHeader = document.getElementById('whDayHeader');
            const dayName = whCurrentDate.toLocaleDateString('en-US', { weekday: 'long' });
            const dayDate = whCurrentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            dayHeader.innerHTML = `<h3>${dayName}</h3><p>${dayDate}</p>`;
            
            const dayContent = document.getElementById('whDayContent');
            dayContent.innerHTML = '';
            
            if (!isDateInFilterRange(whCurrentDate)) {
                dayContent.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No data available for the selected date range</div>';
                return;
            }

            filteredStaff.forEach(staff => {
                const shift = whGenerateShifts(staff.id, whCurrentDate);
                const block = document.createElement('div');
                block.className = 'staff-shift-block';
                
                let html = `<div class="staff-name-header">${staff.name}</div><div class="shift-time-display">`;
                if (shift.type !== 'off') {
                    html += `<div class="shift-time-item ${shift.type}">${convertTo12Hour(shift.startTime)} - ${convertTo12Hour(shift.endTime)}</div>`;
                } else {
                    html += `<div class="shift-time-item off">Off</div>`;
                }
                html += '</div>';
                
                block.innerHTML = html;
                dayContent.appendChild(block);
            });
        }

        // Close on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const container = document.getElementById('workingHoursContainer');
                if (container && !container.classList.contains('hidden')) {
                    closeWorkingHours();
                }
            }
        });

        // Show working hours details when clicking on a shift badge
        function showWorkingHoursDetails(employeeId, date, startTime, endTime) {
            try {
                console.log('showWorkingHoursDetails called:', employeeId);
                
                const employee = employeeResources.find(e => e.id === employeeId);
                if (!employee) {
                    console.error('Employee not found:', employeeId);
                    return;
                }
                
                console.log('Found employee:', employee.title);
                
                // Update header
                const initials = employee.title.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                document.getElementById('empAvatar').textContent = initials;
                document.getElementById('empName').textContent = employee.title;
                document.getElementById('empRole').textContent = employee.extendedProps?.role || 'Staff';
                
                // Create content
                const clinicsContent = document.getElementById('clinicsContent');
                clinicsContent.innerHTML = '';
                
                const dateObj = new Date(date + 'T00:00:00');
                const startDateTime = new Date(date + 'T' + startTime + ':00');
                const endDateTime = new Date(date + 'T' + endTime + ':00');
                
                const isProvider = (employee.extendedProps?.role || '').toLowerCase().includes('dentist') || 
                                 (employee.extendedProps?.role || '').toLowerCase().includes('hygienist');
                
                const html = `
                    <div style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; font-weight: bold;">Position Type</div>
                            <div style="font-size: 1rem; font-weight: bold; margin-top: 0.25rem;">${isProvider ? 'ðŸ‘¨â€âš•ï¸ Provider' : 'ðŸ‘¤ Employee'}</div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; font-weight: bold;">Department</div>
                            <div style="font-size: 1rem; margin-top: 0.25rem;">${employee.extendedProps?.role || 'Staff'}</div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; font-weight: bold;">Shift Date</div>
                            <div style="font-size: 1rem; margin-top: 0.25rem;">${dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                            <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; font-weight: bold;">Working Hours</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: var(--accent-primary); margin-top: 0.25rem;">
                                ${startDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} - ${endDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </div>
                `;
                
                clinicsContent.innerHTML = html;
                
                // Show card
                const card = document.getElementById('employeeProfileCard');
                if (card) {
                    card.classList.remove('hidden');
                    console.log('Card shown successfully');
                } else {
                    console.error('employeeProfileCard not found');
                }
                
            } catch (e) {
                console.error('Error in showWorkingHoursDetails:', e);
            }
        }

        // Test function to manually trigger details display
        window.testShowDetails = function() {
            console.log('=== TEST SHOW DETAILS ===');
            if (employeeResources && employeeResources.length > 0) {
                const testEmp = employeeResources[0];
                console.log('Testing with employee:', testEmp.title);
                showWorkingHoursDetails(testEmp.id, '2025-11-22', '08:00', '16:00');
            } else {
                console.error('No employees available for testing');
            }
        };

        // Test function - run this from console: testWorkingHoursClick()
        window.testWorkingHoursClick = function() {
            console.log('=== TESTING WORKING HOURS CLICK ===');
            const badges = document.querySelectorAll('.shift-badge');
            console.log('Found', badges.length, 'shift badges');
            
            if (badges.length > 0) {
                const firstBadge = badges[0];
                console.log('First badge:', firstBadge);
                console.log('Data:', {
                    employeeId: firstBadge.getAttribute('data-employee-id'),
                    date: firstBadge.getAttribute('data-shift-date'),
                    start: firstBadge.getAttribute('data-shift-start'),
                    end: firstBadge.getAttribute('data-shift-end')
                });
                console.log('Manually triggering click...');
                firstBadge.click();
            } else {
                console.log('No shift badges found! Make sure working hours are visible.');
            }
        };

        // Initialize filters when DOM is ready
        let filterInitRetries = 0;
        const MAX_FILTER_RETRIES = 10;
        
        function ensureFilterInitialization() {
            // Wait for DOM and employee resources to be ready
            const employeeFilterEl = document.getElementById('whEmployeeFilter');
            
            if (!employeeFilterEl) {
                if (filterInitRetries < MAX_FILTER_RETRIES) {
                    filterInitRetries++;
                    setTimeout(ensureFilterInitialization, 500);
                }
                return;
            }
            
            if (typeof employeeResources === 'undefined' || employeeResources.length === 0) {
                if (filterInitRetries < MAX_FILTER_RETRIES) {
                    filterInitRetries++;
                    console.log('Waiting for employee data... (' + filterInitRetries + '/' + MAX_FILTER_RETRIES + ')');
                    setTimeout(ensureFilterInitialization, 500);
                } else {
                    console.log('No employees found after max retries - this is OK if no employees are configured');
                }
                return;
            }
            
            console.log('Initializing working hours filters...');
            console.log('Employee resources available:', employeeResources.length);
            initializeWorkingHoursFilters();
        }
        
        // TROUBLESHOOTING FUNCTION - Run this in browser console if filters aren't working
        window.debugWorkingHours = function() {
            console.log('=== WORKING HOURS DEBUGGING ===\n');
            
            console.log('1. Employee Resources Status:');
            console.log('   - employeeResources exists:', typeof employeeResources !== 'undefined');
            console.log('   - Employee count:', employeeResources?.length || 0);
            if (employeeResources && employeeResources.length > 0) {
                console.log('   - First employee:', employeeResources[0]);
            }
            
            console.log('\n2. Filter Elements:');
            console.log('   - Employee filter exists:', !!document.getElementById('whEmployeeFilter'));
            console.log('   - Date start exists:', !!document.getElementById('whDateFilterStart'));
            console.log('   - Date end exists:', !!document.getElementById('whDateFilterEnd'));
            
            console.log('\n3. Filter State:');
            console.log('   - whFilterState:', window.whFilterState);
            
            console.log('\n4. Functions:');
            console.log('   - initializeWorkingHoursFilters:', typeof initializeWorkingHoursFilters);
            console.log('   - applyWorkingHoursFilters:', typeof applyWorkingHoursFilters);
            console.log('   - getFilteredStaffDatabase:', typeof getFilteredStaffDatabase);
            
            console.log('\n5. Test Filter:');
            const testFiltered = getFilteredStaffDatabase();
            console.log('   - getFilteredStaffDatabase() returns:', testFiltered.length, 'employees');
            
            console.log('\n6. Working Hours Container:');
            console.log('   - Container exists:', !!document.getElementById('workingHoursContainer'));
            console.log('   - Container visible:', !document.getElementById('workingHoursContainer')?.classList.contains('hidden'));
            
            console.log('\n7. Recommended Actions:');
            if (!employeeResources || employeeResources.length === 0) {
                console.log('   âš ï¸ Employee resources not found. Make sure employeeResources is populated.');
            } else {
                console.log('   âœ“ Employee resources loaded');
            }
            console.log('   âœ“ Run: initializeWorkingHoursFilters()');
            console.log('   âœ“ Run: applyWorkingHoursFilters()');
            
            console.log('\n=== END DEBUG ===');
        };
        
        // Try to initialize on multiple events
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', ensureFilterInitialization);
        } else {
            // DOM already loaded
            ensureFilterInitialization();
        }
        
        // Also try initialization when working hours is opened
        document.addEventListener('click', function(e) {
            // If user clicks to open working hours and filters aren't initialized
            if (e.target.closest('[onclick*="openWorkingHours"]') || 
                e.target.closest('button')?.textContent?.includes('Hours')) {
                setTimeout(ensureFilterInitialization, 100);
            }
        });

        // ============ KANBAN BOARD FUNCTIONALITY ============
        
        // Drag and Drop functionality for Kanban cards
        let draggedCard = null;

        // Initialize drag and drop
        function initializeKanbanDragDrop() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column-body');

            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove drag-over class from all columns
            document.querySelectorAll('.kanban-column-body').forEach(column => {
                column.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (e.target === this) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedCard !== this) {
                // Move the card to new column
                this.appendChild(draggedCard);
                
                // Update column badges
                updateKanbanBadges();
                
                // Log the status change
                const newStatus = this.closest('.kanban-column').dataset.status;
                const projectId = draggedCard.dataset.projectId;
                console.log(`Project ${projectId} moved to ${newStatus}`);
            }

            return false;
        }

        // Update badge counts for each column
        function updateKanbanBadges() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const badge = column.querySelector('.kanban-column-badge');
                const cardCount = column.querySelectorAll('.kanban-card').length;
                badge.textContent = cardCount;
            });
            
            // Update header stats
            updateKanbanStats();
        }

        // Update kanban statistics
        function updateKanbanStats() {
            const allCards = document.querySelectorAll('.kanban-card');
            const doneCards = document.querySelectorAll('.kanban-column.done .kanban-card');
            const backlogCards = document.querySelectorAll('.kanban-column.backlog .kanban-card');
            const todoCards = document.querySelectorAll('.kanban-column.todo .kanban-card');
            const inProgressCards = document.querySelectorAll('.kanban-column.in-progress .kanban-card');
            const reviewCards = document.querySelectorAll('.kanban-column.review .kanban-card');
            
            document.getElementById('totalProjects').textContent = allCards.length;
            document.getElementById('activeProjects').textContent = 
                todoCards.length + inProgressCards.length + reviewCards.length;
            document.getElementById('completedProjects').textContent = doneCards.length;
            
            // Count overdue (simplified - checking for red dates)
            const overdueCards = document.querySelectorAll('.kanban-card-due').length;
            document.getElementById('overdueProjects').textContent = overdueCards;
        }

        // Filter projects by type
        function filterProjects(filterType) {
            const filterButtons = document.querySelectorAll('.kanban-filter');
            const allCards = document.querySelectorAll('.kanban-card');
            
            // Update active filter button
            filterButtons.forEach(btn => {
                if (btn.dataset.filter === filterType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Apply filter
            if (filterType === 'all') {
                allCards.forEach(card => card.style.display = 'block');
            } else if (filterType === 'active') {
                allCards.forEach(card => {
                    const isDone = card.closest('.kanban-column').dataset.status === 'done';
                    card.style.display = isDone ? 'none' : 'block';
                });
            } else if (filterType === 'completed') {
                allCards.forEach(card => {
                    const isDone = card.closest('.kanban-column').dataset.status === 'done';
                    card.style.display = isDone ? 'block' : 'none';
                });
            } else if (filterType === 'my') {
                // This would filter by current user - simplified version
                allCards.forEach(card => card.style.display = 'block');
            }
            
            updateKanbanBadges();
        }

        // Open new project modal (placeholder)
        function openNewProjectModal() {
            alert('New Project Modal - To be implemented\n\nThis would open a modal form to create a new project with:\n- Project name\n- Description\n- Priority level\n- Assigned team members\n- Due date\n- Tags');
        }

        // Initialize filter buttons
        function initializeKanbanFilters() {
            const filterButtons = document.querySelectorAll('.kanban-filter');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterType = this.dataset.filter;
                    filterProjects(filterType);
                });
            });
        }

        // Initialize kanban board when projects view is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if kanban board exists
            if (document.getElementById('kanbanBoard')) {
                initializeKanbanDragDrop();
                initializeKanbanFilters();
                updateKanbanStats();
            }
        });

        // Re-initialize when switching to projects view
        if (typeof switchContentView !== 'undefined') {
            const originalSwitchContentView = switchContentView;
            switchContentView = function(viewName, event) {
                originalSwitchContentView(viewName, event);
            
                if (viewName === 'projects') {
                    setTimeout(() => {
                        initializeKanbanDragDrop();
                        initializeKanbanFilters();
                        updateKanbanStats();
                    }, 100);
                }
            };
        }

        </script>

<!-- Procedure Modal -->
<div class="procedure-modal-overlay" id="procedureModal">
    <div class="procedure-modal-content">
        <div class="procedure-modal-header">
            <h2 class="procedure-modal-title" id="procedureModalTitle">New Procedure</h2>
            <button class="procedure-modal-close" onclick="closeProcedureModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="procedure-modal-body">
            <div class="form-group">
                <label class="form-label">Procedure Name</label>
                <input type="text" class="form-input" id="procedureNameInput" placeholder="e.g., Root Canal Setup">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="procedureDescInput" placeholder="Description of the procedure" rows="3" style="resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Estimated Time (minutes)</label>
                <input type="number" class="form-input" id="procedureTimeInput" placeholder="60" min="1">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-input" id="procedureCategoryInput">
                    <option value="general">General Procedure</option>
                    <option value="surgical">Surgical</option>
                    <option value="restoration">Restoration</option>
                    <option value="cleaning">Cleaning &amp; Preventive</option>
                    <option value="cosmetic">Cosmetic</option>
                </select>
            </div>
        </div>
        <div class="procedure-modal-actions">
            <button class="action-btn action-btn-secondary" onclick="closeProcedureModal()">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="saveProcedureModal()">Save Procedure</button>
        </div>
    </div>
</div>




<!-- Floating Tasks Panel -->
<div class="floating-tasks-panel" id="floatingTasksPanel">
    <div class="floating-tasks-header" onclick="minimizeFloatingTasksPanel()">
        <div class="floating-tasks-title">
            <i class="fas fa-clipboard-list"></i>
            <span>Available Tasks</span>
            <span class="floating-tasks-badge" id="floatingTasksBadge">5</span>
        </div>
        <div class="floating-tasks-controls">
            <button class="floating-tasks-btn" onclick="event.stopPropagation(); minimizeFloatingTasksPanel()">
                <i class="fas fa-minus"></i>
            </button>
            <button class="floating-tasks-btn" onclick="event.stopPropagation(); closeFloatingTasksPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="floating-tasks-body" id="floatingTasksBody">
        <!-- Tasks will be populated here -->
    </div>
</div>

<!-- Bonus Tasks Panel -->
<div class="floating-tasks-panel" id="bonusTasksPanel" style="bottom: 5rem; border: 2px solid #eab308;">
    <div class="floating-tasks-header" onclick="minimizeBonusTasksPanel()" style="background: linear-gradient(135deg, #eab308, #facc15);">
        <div class="floating-tasks-title">
            <i class="fas fa-star"></i>
            <span>Bonus Tasks</span>
            <span class="floating-tasks-badge" id="bonusTasksBadge" style="background: white; color: #eab308;">3</span>
        </div>
        <div class="floating-tasks-controls">
            <button class="floating-tasks-btn" onclick="event.stopPropagation(); minimizeBonusTasksPanel()">
                <i class="fas fa-minus"></i>
            </button>
            <button class="floating-tasks-btn" onclick="event.stopPropagation(); closeBonusTasksPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="floating-tasks-body" id="bonusTasksBody">
        <!-- Bonus Tasks will be populated here -->
    </div>
</div>


<!-- ==================== WORKING HOURS CALENDAR ==================== -->
<!-- Add this before </body> tag -->

<!-- Working Hours Calendar Container -->
<div class="working-hours-container hidden" id="workingHoursContainer">
    <div class="working-hours-wrapper">
    <div class="working-hours-header">
        <div class="working-hours-title">
            <i class="fas fa-clock"></i>
            <h2>Working Hours & Staff Schedule</h2>
        </div>

        <div class="working-hours-controls">
            <div class="view-toggles">
                <button class="view-toggle-btn active" data-view="month" onclick="switchWorkingHoursView('month')">
                    <i class="fas fa-calendar"></i> Month
                </button>
                <button class="view-toggle-btn" data-view="week" onclick="switchWorkingHoursView('week')">
                    <i class="fas fa-calendar-week"></i> Week
                </button>
                <button class="view-toggle-btn" data-view="day" onclick="switchWorkingHoursView('day')">
                    <i class="fas fa-calendar-day"></i> Day
                </button>
            </div>

            <div class="date-navigation">
                <button class="nav-icon-btn" onclick="workingHoursPrevious()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="current-date-display" id="whCurrentDate"></span>
                <button class="nav-icon-btn" onclick="workingHoursNext()">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button class="nav-icon-btn" onclick="workingHoursGoToday()">Today</button>
            </div>

            <button class="close-modal-btn" onclick="closeWorkingHours()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Filters Section -->
        <div class="working-hours-filters" style="margin-top: 0.75rem; display: flex; gap: 1rem; padding: 0.75rem; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); background: var(--bg-secondary); border-radius: 4px; align-items: center; flex-wrap: wrap;">
            <div class="filter-group" style="display: flex; align-items: center; gap: 0.5rem;">
                <label style="color: var(--text-primary); font-weight: 600; font-size: 0.85rem; white-space: nowrap;">ðŸ¥ Clinic:</label>
                <select id="whClinicFilter" class="form-input" onchange="applyWorkingHoursFilters()" style="min-width: 120px; padding: 0.4rem 0.6rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary); font-size: 0.8rem;">
                    <option value="">All Clinics</option>
                    <option value="clinic1">Main Clinic</option>
                    <option value="clinic2">Downtown Clinic</option>
                    <option value="clinic3">Uptown Clinic</option>
                </select>
            </div>

            <div class="filter-group" style="display: flex; align-items: center; gap: 0.5rem;">
                <label style="color: var(--text-primary); font-weight: 600; font-size: 0.85rem; white-space: nowrap;">ðŸ‘¤ Employee:</label>
                <select id="whEmployeeFilter" class="form-input" onchange="applyWorkingHoursFilters()" style="min-width: 120px; padding: 0.4rem 0.6rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-primary); font-size: 0.8rem;">
                    <option value="">All Employees</option>
                </select>
            </div>

            <button class="nav-icon-btn" onclick="testShowDetails()" style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #ff6b35 !important; color: white !important; border-color: #ff5722 !important; border: 2px solid #ff5722 !important; font-weight: bold;">
                ðŸ§ª TEST CLICK
            </button>

            <button class="nav-icon-btn" onclick="resetWorkingHoursFilters()" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">
                <i class="fas fa-redo"></i> Reset
            </button>

            <button class="nav-icon-btn" onclick="exportWorkingHoursToPDF()" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; background: #10b981; color: white; border-color: #059669;">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
        </div>
    </div>

    <div class="working-hours-content">
        <div class="working-hours-legend">
            <div style="margin-bottom: 1rem;">
                <h3 style="margin: 0 0 0.75rem 0; color: var(--text-primary); font-size: 0.95rem;">Shift Schedule</h3>
                <div class="legend-row">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #10b981;"></span>
                        <div>
                            <div style="font-weight: 600;">Morning Shift</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">8:00 AM - 4:00 PM</div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #3b82f6;"></span>
                        <div>
                            <div style="font-weight: 600;">Evening Shift</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">4:00 PM - 10:00 PM</div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #8b5cf6;"></span>
                        <div>
                            <div style="font-weight: 600;">Night Shift</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">10:00 PM - 6:00 AM</div>
                        </div>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #ef4444;"></span>
                        <div>
                            <div style="font-weight: 600;">Off/Not Scheduled</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Not working</div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.75rem; font-size: 0.85rem; color: var(--text-secondary);">
                <strong>Note:</strong> Shifts are non-overlapping and cover the full 24-hour day. Each employee works exactly one shift or is off.
            </div>
        </div>

        <!-- Month View -->
        <div id="whMonthView" class="working-hours-view month-calendar-view">
            <div class="calendar-grid-header">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            </div>
            <div class="calendar-grid" id="whMonthDays"></div>
        </div>

        <!-- Week View - Timeline Style -->
        <div id="whWeekView" class="working-hours-view week-calendar-view hidden">
            <div class="week-timeline-header" id="whWeekTimelineHeader"></div>
            <div class="week-timeline-body">
                <div class="week-timeline-grid" id="whWeekTimelineGrid"></div>
            </div>
        </div>

        <!-- Day View -->
        <div id="whDayView" class="working-hours-view day-calendar-view hidden">
            <div class="day-header" id="whDayHeader"></div>
            <div class="day-content" id="whDayContent"></div>
        </div>
    </div>
    </div>
    
    <!-- Mini Calendar Widget (Floating) -->
    <div id="whMiniCalendar" class="wh-mini-calendar"></div>
</div>

<!-- Employee Profile Card -->
<div class="employee-profile-card hidden" id="employeeProfileCard">
    <div class="employee-card-header">
        <div class="employee-avatar" id="empAvatar"></div>
        <div class="employee-info" style="flex: 1;">
            <h4 id="empName"></h4>
            <p id="empRole"></p>
        </div>
        <button class="close-employee-card" onclick="closeEmployeeProfileCard()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div id="clinicsContent"></div>
</div>


<!-- ============================================ -->
<!-- SIDEBAR TOGGLE JAVASCRIPT -->
<!-- ============================================ -->
<script>
// Sidebar Toggle Functions
function initSidebarToggle() {
    // Check localStorage for sidebar states
    const leftSidebarHidden = localStorage.getItem('leftSidebarHidden') === 'true';
    const rightSidebarHidden = localStorage.getItem('rightSidebarHidden') === 'true';

    if (leftSidebarHidden) hideSidebarLeft();
    if (rightSidebarHidden) hideSidebarRight();
}

function toggleSidebarLeft() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar.classList.contains('hidden')) {
        showSidebarLeft();
    } else {
        hideSidebarLeft();
    }
}

function hideSidebarLeft() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.add('hidden');
    localStorage.setItem('leftSidebarHidden', 'true');
    updateToggleButtons();
    // Trigger calendar re-render
    setTimeout(() => {
        if (window.calendarInstance) {
            window.calendarInstance.render();
        }
    }, 100);
}

function showSidebarLeft() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.remove('hidden');
    localStorage.setItem('leftSidebarHidden', 'false');
    updateToggleButtons();
    // Trigger calendar re-render
    setTimeout(() => {
        if (window.calendarInstance) {
            window.calendarInstance.render();
        }
    }, 100);
}

function toggleSidebarRight() {
    const activeView = document.querySelector('.content-view.active');
    const sidebar = activeView ? activeView.querySelector('.sidebar-right') : null;
    if (sidebar) {
        if (sidebar.classList.contains('hidden')) {
            showSidebarRight();
        } else {
            hideSidebarRight();
        }
    }
}

function hideSidebarRight() {
    const activeView = document.querySelector('.content-view.active');
    const sidebar = activeView ? activeView.querySelector('.sidebar-right') : null;
    if (sidebar) {
        sidebar.classList.add('hidden');
        localStorage.setItem('rightSidebarHidden', 'true');
        updateToggleButtons();
        // Trigger calendar re-render
        setTimeout(() => {
            if (window.calendarInstance) {
                window.calendarInstance.render();
            }
        }, 100);
    }
}

function showSidebarRight() {
    const activeView = document.querySelector('.content-view.active');
    const sidebar = activeView ? activeView.querySelector('.sidebar-right') : null;
    if (sidebar) {
        sidebar.classList.remove('hidden');
        localStorage.setItem('rightSidebarHidden', 'false');
        updateToggleButtons();
    }
    // Trigger calendar re-render
    setTimeout(() => {
        if (window.calendarInstance) {
            window.calendarInstance.render();
        }
    }, 100);
}

function updateToggleButtons() {
    const leftSidebar = document.querySelector('.sidebar');
    const activeView = document.querySelector('.content-view.active');
    const rightSidebar = activeView ? activeView.querySelector('.sidebar-right') : null;
    
    const leftBtn = document.getElementById('toggleBtnLeft');
    const rightBtn = document.getElementById('toggleBtnRight');
    const cornerLeftBtn = document.getElementById('cornerToggleLeft');
    const cornerRightBtn = document.getElementById('cornerToggleRight');

    if (leftBtn) {
        if (leftSidebar.classList.contains('hidden')) {
            leftBtn.setAttribute('title', 'Show Left Sidebar');
            leftBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        } else {
            leftBtn.setAttribute('title', 'Hide Left Sidebar');
            leftBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        }
    }

    if (cornerLeftBtn) {
        if (leftSidebar.classList.contains('hidden')) {
            cornerLeftBtn.setAttribute('title', 'Show Left Sidebar (Alt + L)');
            cornerLeftBtn.innerHTML = '<i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>';
        } else {
            cornerLeftBtn.setAttribute('title', 'Hide Left Sidebar (Alt + L)');
            cornerLeftBtn.innerHTML = '<i class="fas fa-chevron-left" style="font-size: 0.6rem;"></i>';
        }
    }

    if (rightBtn && rightSidebar) {
        if (rightSidebar.classList.contains('hidden')) {
            rightBtn.setAttribute('title', 'Show Right Sidebar');
            rightBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        } else {
            rightBtn.setAttribute('title', 'Hide Right Sidebar');
            rightBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        }
    }

    if (cornerRightBtn && rightSidebar) {
        if (rightSidebar.classList.contains('hidden')) {
            cornerRightBtn.setAttribute('title', 'Show Right Sidebar (Alt + R)');
            cornerRightBtn.innerHTML = '<i class="fas fa-chevron-left" style="font-size: 0.6rem;"></i>';
        } else {
            cornerRightBtn.setAttribute('title', 'Hide Right Sidebar (Alt + R)');
            cornerRightBtn.innerHTML = '<i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>';
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initSidebarToggle();
    updateToggleButtons();
    initMobileMenu();
    initChatHighlight();
});

// ============ CHAT HIGHLIGHT FUNCTIONS ============
function initChatHighlight() {
    // Style all chat nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.onclick && item.onclick.toString().includes('openChat')) {
            item.classList.add('chat-nav-item');
            item.style.background = 'linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(8, 145, 178, 0.1))';
            item.style.border = '1px solid rgba(6, 182, 212, 0.4)';
            item.style.borderRadius = '8px';
            item.style.marginTop = '0.5rem';
            
            const icon = item.querySelector('i');
            if (icon) icon.style.color = '#06b6d4';
            
            const span = item.querySelector('span:not(.chat-unread-badge)');
            if (span) {
                span.style.color = '#06b6d4';
                span.style.fontWeight = '600';
                span.innerHTML = 'ðŸ’¬ Team Chat';
            }
        }
    });
    
    // Fetch unread count immediately
    fetchUnreadChatCount();
    
    // Check for new messages every 15 seconds
    setInterval(fetchUnreadChatCount, 15000);
    
    // Add periodic attention animation to floating button
    setInterval(() => {
        const floatingBtn = document.getElementById('floatingChatBtn');
        if (floatingBtn && !floatingBtn.classList.contains('has-messages')) {
            floatingBtn.style.animation = 'none';
            floatingBtn.offsetHeight; // Trigger reflow
            floatingBtn.style.animation = 'chat-bounce 0.6s ease';
            setTimeout(() => {
                floatingBtn.style.animation = 'chat-pulse 2s infinite';
            }, 600);
        }
    }, 30000); // Every 30 seconds
}

// Fetch unread message count from API
async function fetchUnreadChatCount() {
    try {
        const currentUserId = await getCurrentUserId();
        if (!currentUserId) {
            console.log('âš ï¸ No user ID found for unread count');
            return;
        }
        
        console.log('ðŸ“¬ Fetching unread count for user:', currentUserId);
        const response = await fetch(`${API_BASE_URL}/chat?action=unreadCount&userId=${currentUserId}`);
        if (response.ok) {
            const data = await response.json();
            updateChatBadges(data.unreadCount || 0);
            console.log('ðŸ“¬ Unread messages:', data.unreadCount || 0);
        } else {
            console.log('âš ï¸ Unread count API error:', response.status);
        }
    } catch (error) {
        console.log('âš ï¸ Could not fetch unread count:', error.message);
    }
}

// Update chat badge counts
function updateChatBadges(unreadCount) {
    const floatingBadge = document.getElementById('floatingChatBadge');
    const floatingBtn = document.getElementById('floatingChatBtn');
    
    if (unreadCount > 0) {
        if (floatingBadge) {
            floatingBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            floatingBadge.style.display = 'flex';
        }
        if (floatingBtn) floatingBtn.classList.add('has-messages');
        
        // Update sidebar badges
        document.querySelectorAll('.chat-unread-badge').forEach(badge => {
            badge.textContent = unreadCount;
            badge.style.display = 'flex';
        });
        document.querySelectorAll('.chat-nav-item').forEach(item => {
            item.classList.add('has-unread');
        });
    } else {
        if (floatingBadge) floatingBadge.style.display = 'none';
        if (floatingBtn) floatingBtn.classList.remove('has-messages');
        document.querySelectorAll('.chat-unread-badge').forEach(badge => {
            badge.style.display = 'none';
        });
        document.querySelectorAll('.chat-nav-item').forEach(item => {
            item.classList.remove('has-unread');
        });
    }
}

// ============ MOBILE MENU FUNCTIONS ============
function initMobileMenu() {
    // Check screen size and show/hide mobile menu button
    function checkMobileView() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        if (window.innerWidth <= 768) {
            if (mobileMenuBtn) mobileMenuBtn.style.display = 'flex';
        } else {
            if (mobileMenuBtn) mobileMenuBtn.style.display = 'none';
            closeMobileSidebar();
        }
    }
    
    checkMobileView();
    window.addEventListener('resize', checkMobileView);
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('mainSidebar') || document.querySelector('.sidebar');
    const overlay = document.getElementById('mobileOverlay');
    const menuBtn = document.getElementById('mobileMenuBtn');
    
    if (sidebar.classList.contains('mobile-open')) {
        closeMobileSidebar();
    } else {
        sidebar.classList.add('mobile-open');
        if (overlay) overlay.classList.add('active');
        if (menuBtn) menuBtn.innerHTML = '<i class="fas fa-times"></i>';
    }
}

function closeMobileSidebar() {
    const sidebar = document.getElementById('mainSidebar') || document.querySelector('.sidebar');
    const sidebarRight = document.querySelector('.sidebar-right');
    const overlay = document.getElementById('mobileOverlay');
    const menuBtn = document.getElementById('mobileMenuBtn');
    
    if (sidebar) sidebar.classList.remove('mobile-open');
    if (sidebarRight) sidebarRight.classList.remove('mobile-open');
    if (overlay) overlay.classList.remove('active');
    if (menuBtn) menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
}

// Close mobile sidebar when clicking a nav link
document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768) {
        if (e.target.closest('.nav-link') || e.target.closest('.nav-item')) {
            closeMobileSidebar();
        }
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt + L to toggle left sidebar
    if (e.altKey && e.key === 'l') {
        e.preventDefault();
        toggleSidebarLeft();
    }
    // Alt + R to toggle right sidebar
    if (e.altKey && e.key === 'r') {
        e.preventDefault();
        toggleSidebarRight();
    }
    // Escape to close mobile sidebar
    if (e.key === 'Escape' && window.innerWidth <= 768) {
        closeMobileSidebar();
    }
});
</script>

<!-- Add/Edit Event Modal -->
<div id="addEventModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: var(--text-primary); font-size: 1.5rem;">
                <i class="fas fa-calendar-plus" style="color: var(--accent-primary); margin-right: 0.5rem;"></i>
                <span id="addEventModalTitle">Add New Event</span>
            </h2>
            <button onclick="closeAddEventModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-secondary)'; this.style.color='var(--text-primary)';" onmouseout="this.style.background='none'; this.style.color='var(--text-secondary)';">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="eventForm" onsubmit="saveEvent(event)" style="padding: 1.5rem;">
            <input type="hidden" id="eventId" value="">
            
            <!-- Event Title -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-heading" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Event Title *
                </label>
                <input type="text" id="eventTitle" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;" placeholder="Enter event title">
            </div>
            
            <!-- Event Type -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-tag" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Event Type *
                </label>
                <select id="eventType" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                    <optgroup label="Appointments & Duties">
                        <option value="appointment">Appointment</option>
                        <option value="duty">Duty</option>
                    </optgroup>
                    <optgroup label="Tasks">
                        <option value="task">Task</option>
                        <option value="floating-task">Floating Task</option>
                        <option value="bonus-task">Bonus Task</option>
                    </optgroup>
                    <optgroup label="Time Off">
                        <option value="pto">PTO (Paid Time Off)</option>
                        <option value="vacation">Vacation</option>
                        <option value="sick-leave">Sick Leave</option>
                    </optgroup>
                    <optgroup label="Other Events">
                        <option value="meeting">Meeting</option>
                        <option value="training">Training</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="project">Project</option>
                        <option value="other">Other</option>
                    </optgroup>
                </select>
            </div>
            
            <!-- Date and Time -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                        <i class="fas fa-calendar" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                        Start Date *
                    </label>
                    <input type="date" id="eventStartDate" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                        <i class="fas fa-clock" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                        Start Time *
                    </label>
                    <input type="time" id="eventStartTime" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                        <i class="fas fa-calendar" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                        End Date *
                    </label>
                    <input type="date" id="eventEndDate" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                        <i class="fas fa-clock" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                        End Time *
                    </label>
                    <input type="time" id="eventEndTime" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                </div>
            </div>
            
            <!-- Employee Assignment -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-user" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Assign to Employee *
                </label>
                <select id="eventEmployee" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                    <option value="">Select Employee</option>
                </select>
            </div>
            
            <!-- Location -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Location
                </label>
                <input type="text" id="eventLocation" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;" placeholder="e.g., Room 1, Conference Room">
            </div>
            
            <!-- Priority -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Priority
                </label>
                <select id="eventPriority" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem;">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            
            <!-- Description -->
            <div style="margin-bottom: 1.25rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-align-left" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Description
                </label>
                <textarea id="eventDescription" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; resize: vertical;" placeholder="Enter event description"></textarea>
            </div>
            
            <!-- Notes -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-sticky-note" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Notes
                </label>
                <textarea id="eventNotes" rows="2" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; resize: vertical;" placeholder="Additional notes"></textarea>
            </div>
            
            <!-- Form Actions -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button type="button" onclick="closeAddEventModal()" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-primary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                    Cancel
                </button>
                <button type="submit" style="padding: 0.75rem 1.5rem; border: none; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">
                    <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                    Save Event
                </button>
            </div>
        </form>
    </div>
</div>

<!-- User Management Modal -->
<div id="userManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="modal-content" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-users-cog"></i>
                User Management
            </h3>
            <button onclick="closeUserManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- HR Info Banner -->
            <div style="background: linear-gradient(135deg, #8b5cf610, #7c3aed10); border: 1px solid #8b5cf640; border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 0.75rem; border-radius: 10px;">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 1.25rem; color: white;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">HR Management</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Click the <span style="background: #8b5cf6; color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem;"><i class="fas fa-file-invoice-dollar"></i></span> button on any employee to view or edit their salary, benefits, and employment details.</div>
                </div>
            </div>

            <!-- Add New User Button on Top -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h4 style="margin: 0; color: var(--text-primary);">
                    <i class="fas fa-users" style="margin-right: 0.5rem; color: var(--accent-primary);"></i>
                    Existing Users
                </h4>
                <button onclick="openAddUserModal()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-user-plus"></i>
                    Add New User
                </button>
            </div>

            <!-- Users List as Table -->
            <div style="background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--bg-secondary);">
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Name</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Username</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Role</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Job Title</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Status</th>
                            <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList">
                        <!-- Users will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add New User Modal - Full Screen -->
<div id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10002; align-items: center; justify-content: center;">
    <div style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow: hidden; background: var(--bg-primary);">
        <div style="position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #10b981, #059669); border-bottom: 1px solid var(--border-color); padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem; color: white;">
                <i class="fas fa-user-plus"></i>
                Create New Employee
            </h3>
            <button class="close-btn" onclick="closeAddUserModal()" style="color: white; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 2rem; height: calc(100vh - 80px); overflow-y: auto;">
            <form id="createUserForm" onsubmit="createUser(event)" style="max-width: 1200px; margin: 0 auto;">
                    
                    <!-- Personal Information Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">Personal Information</h5>
                        <div style="display: grid; grid-template-columns: 0.5fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newTitle">
                                    Title
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Professional title or salutation (Dr., Mr., Mrs., etc.)"></i>
                                </label>
                                <select id="newTitle" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);" onchange="toggleCustomTitle('new')">
                                    <option value="">--</option>
                                    <option value="Dr.">Dr.</option>
                                    <option value="Mr.">Mr.</option>
                                    <option value="Mrs.">Mrs.</option>
                                    <option value="Ms.">Ms.</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div id="newCustomTitleContainer" style="display: none; margin-top: 0.5rem;">
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="text" id="newCustomTitle" placeholder="Enter custom title..." maxlength="20" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-primary);">
                                        <button type="button" onclick="cancelCustomTitle('new')" style="padding: 0.5rem; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer;" title="Cancel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newFirstName">
                                    First Name *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's legal first name as it appears on official documents"></i>
                                </label>
                                <input type="text" id="newFirstName" required placeholder="First name">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newMiddleName">
                                    Middle Name
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's middle name (optional)"></i>
                                </label>
                                <input type="text" id="newMiddleName" placeholder="Middle name">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newLastName">
                                    Last Name *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's legal last name as it appears on official documents"></i>
                                </label>
                                <input type="text" id="newLastName" required placeholder="Last name">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newGender">
                                    Gender
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's gender identity (optional)"></i>
                                </label>
                                <select id="newGender" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="">--Select--</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Non-Binary">Non-Binary</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newDateOfBirth">
                                    Date of Birth
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's date of birth for records and benefits eligibility"></i>
                                </label>
                                <input type="date" id="newDateOfBirth" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newSSN">
                                    SSN/EIN
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Social Security Number or Employer Identification Number for tax purposes. This information is encrypted."></i>
                                </label>
                                <input type="text" id="newSSN" placeholder="XXX-XX-XXXX">
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">Contact Information</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newPersonalEmail">
                                    Personal Email
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's personal email address for backup contact"></i>
                                </label>
                                <input type="email" id="newPersonalEmail" placeholder="personal@email.com">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newWorkEmail">
                                    Work Email *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Primary work email for official communications and system notifications"></i>
                                </label>
                                <input type="email" id="newWorkEmail" required placeholder="work@company.com">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newHomePhone">
                                    Home Phone
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's home telephone number (optional)"></i>
                                </label>
                                <input type="tel" id="newHomePhone" placeholder="(555) 555-5555">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newCellPhone">
                                    Cell Phone
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's mobile phone number for urgent contact"></i>
                                </label>
                                <input type="tel" id="newCellPhone" placeholder="(555) 555-5555">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newAddress">
                                Address
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Employee's home address. You can type or use the location button to auto-detect."></i>
                            </label>
                            <div style="display: flex; gap: 0.5rem; position: relative;">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" id="newAddress" placeholder="Start typing address..." style="width: 100%;" oninput="handleAddressInput('new', this.value)" autocomplete="off">
                                    <div id="newAddressSuggestions" class="address-suggestions" style="display: none;"></div>
                                </div>
                                <button type="button" onclick="detectLocation('new')" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap;" title="Detect my location">
                                    <i class="fas fa-location-arrow"></i>
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newCity">City</label>
                                <input type="text" id="newCity" placeholder="City">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newState">State</label>
                                <input type="text" id="newState" placeholder="State" maxlength="2">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newZipCode">Zip Code</label>
                                <input type="text" id="newZipCode" placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contact Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                            Emergency Contact
                            <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem; font-size: 0.85rem;" title="Person to contact in case of emergency during work hours"></i>
                        </h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="emergencyContactName">Contact Name</label>
                                <input type="text" id="emergencyContactName" placeholder="Full name">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="emergencyContactRelationship">Relationship</label>
                                <input type="text" id="emergencyContactRelationship" placeholder="e.g., Spouse, Parent">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="emergencyContactPhone">Contact Phone</label>
                                <input type="tel" id="emergencyContactPhone" placeholder="(555) 555-5555">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="emergencyContactEmail">Contact Email</label>
                                <input type="email" id="emergencyContactEmail" placeholder="emergency@email.com">
                            </div>
                        </div>
                    </div>

                    <!-- Employment Information Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">Employment Information</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newUsername">
                                    Username *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Unique login username for the employee to access the system"></i>
                                </label>
                                <input type="text" id="newUsername" required placeholder="username">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newPassword">
                                    Password *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Initial password for the employee account. Should be changed on first login."></i>
                                </label>
                                <input type="password" id="newPassword" required placeholder="Enter password">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newJobTitle">
                                    Job Title *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Official job title for this employee (e.g., Dental Hygienist, Receptionist)"></i>
                                </label>
                                <input type="text" id="newJobTitle" required placeholder="Job title">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newRole">
                                    Role *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="System access level: User (basic), Manager (team oversight), Admin (full access)"></i>
                                </label>
                                <select id="newRole" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="user">User</option>
                                    <option value="manager">Manager</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newStaffType">
                                    Staff Type *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Clinical: works directly with patients. Non-Clinical: administrative or support roles"></i>
                                </label>
                                <select id="newStaffType" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="clinical">Clinical</option>
                                    <option value="non-clinical">Non-Clinical</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newEmployeeType">
                                    Employee Type *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Provider: dentist, hygienist. Assistant/Staff: dental assistant, front desk, etc."></i>
                                </label>
                                <select id="newEmployeeType" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="provider">Provider</option>
                                    <option value="assistant">Assistant/Staff</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newHireDate">
                                    Hire Date *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="The employee's official start date with the company"></i>
                                </label>
                                <input type="date" id="newHireDate" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newEmployeeStatus">
                                    Employee Status *
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Current employment status. Changing to Terminated or Resigned will show separation details"></i>
                                </label>
                                <select id="newEmployeeStatus" required onchange="toggleNewSeparationFields()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="Active">Active</option>
                                    <option value="On Leave">On Leave</option>
                                    <option value="Terminated">Terminated</option>
                                    <option value="Resigned">Resigned</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newNextReviewDate">
                                    Next Review Date
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Date for the employee's next performance review"></i>
                                </label>
                                <input type="date" id="newNextReviewDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newColor">
                                    Calendar Color
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Color used to display this employee on the scheduling calendar"></i>
                                </label>
                                <input type="color" id="newColor" value="#06b6d4" style="width: 100%; height: 45px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newOfficeLocation">
                                    Office Location
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Select the primary office where this employee works"></i>
                                </label>
                                <select id="newOfficeLocation" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="">--Select Office--</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="newDirectSupervisor">
                                    Direct Supervisor
                                    <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Select the manager or supervisor who this employee reports to"></i>
                                </label>
                                <select id="newDirectSupervisor" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="">--Select Supervisor--</option>
                                </select>
                            </div>
                        </div>
                        <!-- Separation Fields - shown only when status is not Active -->
                        <div id="newSeparationFieldsContainer" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h5 style="margin: 0 0 1rem 0; color: #ef4444; font-size: 0.9rem;"><i class="fas fa-user-times" style="margin-right: 0.5rem;"></i>Separation Details</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="newSeparationDate">Separation Date</label>
                                    <input type="date" id="newSeparationDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: white; color: var(--text-primary);">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="newSeparationReason">Separation Reason</label>
                                    <input type="text" id="newSeparationReason" placeholder="Reason for separation" style="background: white;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assigned Duties Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                            <i class="fas fa-clipboard-check" style="margin-right: 0.5rem;"></i>Assigned Duties
                        </h5>
                        <p style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 1rem;">Select the duties this employee will be responsible for:</p>
                        <div id="dutiesCheckboxContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; max-height: 300px; overflow-y: auto; padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="color: var(--text-tertiary); font-style: italic; padding: 1rem; grid-column: 1 / -1; text-align: center;">
                                <i class="fas fa-spinner fa-spin"></i> Loading duties...
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                            <button type="button" onclick="selectAllDuties()" style="padding: 0.5rem 1rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button type="button" onclick="clearAllDuties()" style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-times"></i> Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Photo & Documents Section -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">Photo & Documents</h5>
                        
                        <!-- Photo Upload -->
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label for="employeePhoto">Employee Photo</label>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div id="photoPreview" style="width: 100px; height: 100px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: var(--bg-secondary); position: relative;">
                                    <i class="fas fa-user" style="font-size: 2.5rem; color: var(--text-tertiary);" id="photoPlaceholderIcon"></i>
                                    <img id="photoPreviewImg" src="" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="employeePhoto" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button type="button" onclick="document.getElementById('employeePhoto').click()" style="padding: 0.75rem 1.5rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent-secondary)'" onmouseout="this.style.background='var(--accent-primary)'">
                                            <i class="fas fa-upload" style="margin-right: 0.5rem;"></i>
                                            Upload Photo
                                        </button>
                                        <button type="button" id="removePhotoBtn" onclick="removeEmployeePhoto()" style="display: none; padding: 0.75rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-tertiary);">JPG, PNG or GIF (max. 5MB)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Upload -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="employeeDocuments">Documents</label>
                            <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem; background: var(--bg-secondary);">
                                <input type="file" id="employeeDocuments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleDocumentsUpload(event)">
                                <button type="button" onclick="document.getElementById('employeeDocuments').click()" style="padding: 0.75rem 1.5rem; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; width: 100%;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--card-bg)'">
                                    <i class="fas fa-file-upload" style="margin-right: 0.5rem;"></i>
                                    Upload Documents (Resume, Certifications, etc.)
                                </button>
                                <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--text-tertiary); text-align: center;">PDF, DOC, DOCX, JPG, PNG (max. 10MB each)</p>
                                <div id="documentsList" style="margin-top: 1rem; display: none;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.9rem;">Selected Files:</div>
                                    <div id="documentsPreview" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="createUserError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <button type="button" onclick="closeAddUserModal()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                        <button type="submit" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>
                            Create Employee
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reset Data Modal -->
<div id="resetDataModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10000; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 550px; max-width: 95vw; margin: auto; border-radius: 12px; overflow: hidden; background: var(--card-bg);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #ef4444, #dc2626); padding: 1.5rem;">
            <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-exclamation-triangle"></i>
                Reset Application Data
            </h3>
            <button class="close-btn" onclick="closeResetDataModal()" style="color: white; font-size: 1.5rem;">&times;</button>
        </div>
        
        <div style="padding: 1.5rem;">
            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: #991b1b; font-weight: 500;">
                    <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
                    Warning: This action cannot be undone!
                </p>
            </div>
            
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Select which data you want to reset:</p>
            
            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetClinics" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--text-primary);"><i class="fas fa-hospital" style="color: #10b981; margin-right: 0.5rem;"></i>Clinics</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetRooms" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--text-primary);"><i class="fas fa-door-open" style="color: #8b5cf6; margin-right: 0.5rem;"></i>Rooms</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetUsers" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--text-primary);"><i class="fas fa-users" style="color: #3b82f6; margin-right: 0.5rem;"></i>Users (except admin)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetSchedules" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--text-primary);"><i class="fas fa-calendar-alt" style="color: #06b6d4; margin-right: 0.5rem;"></i>Schedules, Events & Tasks</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetStickyNotes" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--text-primary);"><i class="fas fa-sticky-note" style="color: #f59e0b; margin-right: 0.5rem;"></i>Sticky Notes</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetVendors" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--text-primary);"><i class="fas fa-truck" style="color: #ec4899; margin-right: 0.5rem;"></i>Vendors</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; cursor: pointer;">
                    <input type="checkbox" id="resetAll" onchange="toggleResetAll()" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: #dc2626; font-weight: 600;"><i class="fas fa-trash-alt" style="margin-right: 0.5rem;"></i>Reset ALL Data (Complete Reset)</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeResetDataModal()" style="padding: 0.75rem 1.5rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Cancel
                </button>
                <button onclick="executeResetData()" style="padding: 0.75rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    <i class="fas fa-trash-alt" style="margin-right: 0.5rem;"></i>Reset Selected Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Permission Management Modal -->
<div id="permissionManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10000; align-items: center; justify-content: center;">
    <div class="modal-content" style="width: 95vw; max-width: 1200px; height: 90vh; margin: auto; border-radius: 12px; overflow: hidden; background: var(--card-bg); display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 1.25rem 1.5rem; flex-shrink: 0;">
            <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-shield-alt"></i>
                Permission Management
            </h3>
            <button class="close-btn" onclick="closePermissionsManagement()" style="color: white; font-size: 1.5rem;">&times;</button>
        </div>
        
        <div style="display: flex; flex: 1; overflow: hidden;">
            <!-- User Selection Panel -->
            <div style="width: 280px; border-right: 1px solid var(--border-color); background: var(--bg-secondary); display: flex; flex-direction: column; flex-shrink: 0;">
                <div style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                    <input type="text" id="permUserSearch" placeholder="Search users..." oninput="filterPermissionUsers(this.value)" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                </div>
                <div id="permissionUsersList" style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                    <!-- User list will be populated dynamically -->
                </div>
            </div>
            
            <!-- Permission Editor Panel -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div id="noUserSelectedMessage" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary);">
                    <i class="fas fa-user-shield" style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.1rem;">Select a user to manage permissions</p>
                </div>
                
                <div id="permissionEditorPanel" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
                    <!-- Selected User Header -->
                    <div style="padding: 1rem 1.5rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div id="selectedUserAvatar" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #7c3aed); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;"></div>
                                <div>
                                    <h4 id="selectedUserName" style="margin: 0; color: var(--text-primary);"></h4>
                                    <p id="selectedUserRole" style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);"></p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="applyPermissionPreset('full')" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;" title="Grant all permissions">
                                    <i class="fas fa-check-double"></i> Full Access
                                </button>
                                <button onclick="applyPermissionPreset('readonly')" style="padding: 0.5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;" title="View only permissions">
                                    <i class="fas fa-eye"></i> Read Only
                                </button>
                                <button onclick="applyPermissionPreset('minimal')" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;" title="Minimal permissions">
                                    <i class="fas fa-minus-circle"></i> Minimal
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Permission Categories -->
                    <div id="permissionCategoriesContainer" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                        <!-- Categories will be populated dynamically -->
                    </div>
                    
                    <!-- Save Button -->
                    <div style="padding: 1rem 1.5rem; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; flex-shrink: 0;">
                        <button onclick="closePermissionsManagement()" style="padding: 0.75rem 1.5rem; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">
                            Cancel
                        </button>
                        <button onclick="saveUserPermissions()" style="padding: 0.75rem 1.5rem; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Permissions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal - Full Screen -->
<div id="editUserModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10001; align-items: center; justify-content: center;">
    <div style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow: hidden; background: var(--bg-primary);">
        <div style="position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 1.5rem;">
            <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-user-edit"></i>
                Edit User
            </h3>
            <button class="close-btn" onclick="closeEditUserModal()" style="color: white; font-size: 1.5rem; background: none; border: none; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 2rem; height: calc(100vh - 80px); overflow-y: auto;">
            <div id="editUserError" style="display: none; padding: 0.75rem; margin-bottom: 1rem; background: #fee; border: 1px solid #fcc; color: #c33; border-radius: 8px;"></div>
            
            <form id="editUserForm" onsubmit="saveEditedUser(event)" style="max-width: 1200px; margin: 0 auto;">
                <!-- Account Information -->
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;"><i class="fas fa-key" style="margin-right: 0.5rem;"></i>Account Information</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editUsername">Username</label>
                            <input type="text" id="editUsername" disabled style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-secondary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editUserRole">Role *</label>
                            <select id="editUserRole" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="user">User</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editPassword">New Password</label>
                            <input type="password" id="editPassword" placeholder="Leave blank to keep current">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editConfirmPassword">Confirm Password</label>
                            <input type="password" id="editConfirmPassword" placeholder="Confirm new password">
                        </div>
                    </div>
                </div>
                
                <!-- Personal Information -->
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;"><i class="fas fa-user" style="margin-right: 0.5rem;"></i>Personal Information</h5>
                    <div style="display: grid; grid-template-columns: 0.5fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editTitle">Title</label>
                            <select id="editTitle" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);" onchange="toggleCustomTitle('edit')">
                                <option value="">--</option>
                                <option value="Dr.">Dr.</option>
                                <option value="Mr.">Mr.</option>
                                <option value="Mrs.">Mrs.</option>
                                <option value="Ms.">Ms.</option>
                                <option value="Other">Other</option>
                            </select>
                            <div id="editCustomTitleContainer" style="display: none; margin-top: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" id="editCustomTitle" placeholder="Enter custom title..." maxlength="20" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-primary);">
                                    <button type="button" onclick="cancelCustomTitle('edit')" style="padding: 0.5rem; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer;" title="Cancel">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editFirstName">First Name *</label>
                            <input type="text" id="editFirstName" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editMiddleName">Middle Name</label>
                            <input type="text" id="editMiddleName">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editLastName">Last Name *</label>
                            <input type="text" id="editLastName" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editGender">Gender</label>
                            <select id="editGender" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select--</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Non-Binary">Non-Binary</option>
                                <option value="Prefer not to say">Prefer not to say</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editDateOfBirth">Date of Birth</label>
                            <input type="date" id="editDateOfBirth" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                </div>
                
                <!-- Contact Information -->
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;"><i class="fas fa-phone" style="margin-right: 0.5rem;"></i>Contact Information</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editPersonalEmail">Personal Email</label>
                            <input type="email" id="editPersonalEmail">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editWorkEmail">Work Email</label>
                            <input type="email" id="editWorkEmail">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editHomePhone">Home Phone</label>
                            <input type="tel" id="editHomePhone">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editCellPhone">Cell Phone</label>
                            <input type="tel" id="editCellPhone">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editAddress">Address</label>
                        <div style="display: flex; gap: 0.5rem; position: relative;">
                            <div style="flex: 1; position: relative;">
                                <input type="text" id="editAddress" placeholder="Start typing address..." style="width: 100%;" oninput="handleAddressInput('edit', this.value)" autocomplete="off">
                                <div id="editAddressSuggestions" class="address-suggestions" style="display: none;"></div>
                            </div>
                            <button type="button" onclick="detectLocation('edit')" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap;" title="Detect my location">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editCity">City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editState">State</label>
                            <input type="text" id="editState" maxlength="2">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editZipCode">Zip Code</label>
                            <input type="text" id="editZipCode">
                        </div>
                    </div>
                </div>
                
                <!-- Employment Information -->
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;"><i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Employment Information</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editJobTitle">Job Title</label>
                            <input type="text" id="editJobTitle">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editDepartment">Department</label>
                            <input type="text" id="editDepartment">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editStaffType">Staff Type</label>
                            <select id="editStaffType" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select--</option>
                                <option value="clinical">Clinical</option>
                                <option value="non-clinical">Non-Clinical</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editEmployeeType">Employee Type</label>
                            <select id="editEmployeeType" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select--</option>
                                <option value="provider">Provider</option>
                                <option value="assistant">Assistant</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editEmployeeStatus">Status</label>
                            <select id="editEmployeeStatus" onchange="toggleEditSeparationFields()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="On Leave">On Leave</option>
                                <option value="Terminated">Terminated</option>
                                <option value="Resigned">Resigned</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editHireDate">Hire Date</label>
                            <input type="date" id="editHireDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    <!-- Separation Fields - shown only when status is not Active -->
                    <div id="editSeparationFieldsContainer" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                        <h5 style="margin: 0 0 1rem 0; color: #ef4444; font-size: 0.9rem;"><i class="fas fa-user-times" style="margin-right: 0.5rem;"></i>Separation Details</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="editSeparationDate">Separation Date</label>
                                <input type="date" id="editSeparationDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: white; color: var(--text-primary);">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="editSeparationReason">Separation Reason</label>
                                <input type="text" id="editSeparationReason" placeholder="Reason for separation" style="background: white;">
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editHourlyRate">Hourly Rate ($)</label>
                            <input type="number" id="editHourlyRate" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editSalary">Salary ($)</label>
                            <input type="number" id="editSalary" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="editColor">Calendar Color</label>
                            <input type="color" id="editColor" value="#06b6d4" style="width: 100%; height: 42px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                </div>

                <!-- Photo & Documents Section -->
                <div style="margin-bottom: 1.5rem; padding: 1rem 0; border-top: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">Photo & Documents</h5>
                    
                    <!-- Photo Upload -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label for="editEmployeePhoto">Employee Photo</label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div id="editPhotoPreview" style="width: 100px; height: 100px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: var(--bg-secondary);">
                                <i class="fas fa-user" style="font-size: 2.5rem; color: var(--text-tertiary);"></i>
                            </div>
                            <div style="flex: 1;">
                                <input type="file" id="editEmployeePhoto" accept="image/*" style="display: none;" onchange="previewEditPhoto(event)">
                                <button type="button" onclick="document.getElementById('editEmployeePhoto').click()" style="padding: 0.75rem 1.5rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent-secondary)'" onmouseout="this.style.background='var(--accent-primary)'">
                                    <i class="fas fa-upload" style="margin-right: 0.5rem;"></i>
                                    Upload Photo
                                </button>
                                <button type="button" onclick="removeEditPhoto()" id="editRemovePhotoBtn" style="display: none; margin-left: 0.5rem; padding: 0.75rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-tertiary);">JPG, PNG or GIF (max. 5MB)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Documents Upload -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editEmployeeDocuments">Documents</label>
                        <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem; background: var(--bg-secondary);">
                            <input type="file" id="editEmployeeDocuments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleEditDocumentsUpload(event)">
                            <button type="button" onclick="document.getElementById('editEmployeeDocuments').click()" style="padding: 0.75rem 1.5rem; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; width: 100%;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--card-bg)'">
                                <i class="fas fa-file-upload" style="margin-right: 0.5rem;"></i>
                                Upload Documents (Resume, Certifications, etc.)
                            </button>
                            <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: var(--text-tertiary); text-align: center;">PDF, DOC, DOCX, JPG, PNG (max. 10MB each)</p>
                            <div id="editDocumentsList" style="margin-top: 1rem;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.9rem;">Documents:</div>
                                <div id="editDocumentsPreview" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="button" onclick="closeEditUserModal()" style="padding: 0.75rem 1.5rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">
                        Cancel
                    </button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- HR Information Modal -->
<div id="hrInfoModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10003; align-items: center; justify-content: center;">
    <div style="width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; background: var(--bg-primary); border-radius: 12px; margin: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div style="position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 1.25rem 1.5rem; border-radius: 12px 12px 0 0;">
            <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;">
                <i class="fas fa-file-invoice-dollar"></i>
                HR Information
            </h3>
            <button class="close-btn" onclick="closeHRInfoModal()" style="color: white; font-size: 1.5rem; background: none; border: none; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 1.5rem;">
            <!-- Employee Header -->
            <div id="hrEmployeeHeader" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1.5rem;">
                <div id="hrEmployeePhoto" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #7c3aed); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 600;">
                    JD
                </div>
                <div>
                    <h4 id="hrEmployeeName" style="margin: 0 0 0.25rem 0; color: var(--text-primary);">John Doe</h4>
                    <p id="hrEmployeeJobTitle" style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Job Title â€¢ Office Location</p>
                </div>
            </div>
            
            <form id="hrInfoForm" onsubmit="saveHRInfo(event)">
                <input type="hidden" id="hrEmployeeId">
                
                <!-- Employment Type Section -->
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                        <i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>Employment Type
                    </h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrEmploymentType">
                                Employment Type *
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Full-time, Part-time, Contract, or Temporary employment status"></i>
                            </label>
                            <select id="hrEmploymentType" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select--</option>
                                <option value="Full-Time">Full-Time</option>
                                <option value="Part-Time">Part-Time</option>
                                <option value="Contract">Contract</option>
                                <option value="Temporary">Temporary</option>
                                <option value="Intern">Intern</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrActiveStatus">
                                Active Status *
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Whether the employee is currently active in the system"></i>
                            </label>
                            <select id="hrActiveStatus" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Compensation Section -->
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                        <i class="fas fa-dollar-sign" style="margin-right: 0.5rem;"></i>Compensation
                    </h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrPayType">
                                Pay Type
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Whether the employee is paid salary or hourly"></i>
                            </label>
                            <select id="hrPayType" onchange="toggleHRPayFields()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select--</option>
                                <option value="Salary">Salary</option>
                                <option value="Hourly">Hourly</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;" id="hrSalaryField">
                            <label for="hrSalary">
                                Annual Salary
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Annual salary amount before taxes"></i>
                            </label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">$</span>
                                <input type="number" id="hrSalary" placeholder="0.00" step="0.01" min="0" style="padding-left: 28px; width: 100%; padding-right: 0.75rem; padding-top: 0.75rem; padding-bottom: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;" id="hrHourlyFields" style="display: none;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrHourlyRate">
                                Hourly Rate
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Pay rate per hour worked"></i>
                            </label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);">$</span>
                                <input type="number" id="hrHourlyRate" placeholder="0.00" step="0.01" min="0" style="padding-left: 28px; width: 100%; padding-right: 0.75rem; padding-top: 0.75rem; padding-bottom: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrExpectedHours">
                                Expected Hours/Week
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Expected number of hours worked per week"></i>
                            </label>
                            <input type="number" id="hrExpectedHours" placeholder="40" min="0" max="168" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                </div>
                
                <!-- Benefits Section -->
                <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                        <i class="fas fa-heart" style="margin-right: 0.5rem;"></i>Benefits
                    </h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrBenefitStartDate">
                                Benefits Start Date
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Date when employee becomes eligible for benefits"></i>
                            </label>
                            <input type="date" id="hrBenefitStartDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="hrBenefitEndDate">
                                Benefits End Date
                                <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Date when benefits coverage ends (leave blank if ongoing)"></i>
                            </label>
                            <input type="date" id="hrBenefitEndDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="margin-bottom: 0.75rem; display: block;">
                            Benefits Enrolled
                            <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Select all benefits this employee is enrolled in"></i>
                        </label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="hrBenefitHealth" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                <span style="color: var(--text-primary);">Health Insurance</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="hrBenefitDental" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                <span style="color: var(--text-primary);">Dental Insurance</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="hrBenefitVision" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                <span style="color: var(--text-primary);">Vision Insurance</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="hrBenefit401k" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                <span style="color: var(--text-primary);">401(k) Retirement</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="hrBenefitPTO" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                <span style="color: var(--text-primary);">Paid Time Off</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="hrBenefitLife" style="width: 18px; height: 18px; accent-color: var(--accent-primary);">
                                <span style="color: var(--text-primary);">Life Insurance</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Notes Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                        <i class="fas fa-sticky-note" style="margin-right: 0.5rem;"></i>HR Notes
                    </h5>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="hrNotes">
                            Internal Notes
                            <i class="fas fa-info-circle" style="color: var(--text-tertiary); cursor: help; margin-left: 0.25rem;" title="Private HR notes about this employee (not visible to employee)"></i>
                        </label>
                        <textarea id="hrNotes" rows="3" placeholder="Any additional HR notes or comments..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); resize: vertical; font-family: inherit;"></textarea>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button type="button" onclick="closeHRInfoModal()" style="padding: 0.75rem 1.5rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">
                        Cancel
                    </button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i>Save HR Info
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rooms Management Modal -->
<div id="roomsManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-door-open" style="color: var(--accent-primary);"></i>
                Rooms Management
            </h3>
            <button onclick="closeRoomsManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Rooms List First -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--text-primary);">Rooms</h4>
                    <button onclick="openAddRoomForm()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(6, 182, 212, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(6, 182, 212, 0.3)'">
                        <i class="fas fa-plus-circle"></i>
                        Add New Room
                    </button>
                </div>
                <div style="background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Room</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Office</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Type</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Category</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Status</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="roomsList">
                            <!-- Rooms will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Room Form (Hidden by default) -->
            <div id="roomFormSection" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 id="roomFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Room</h4>
                <input type="hidden" id="editRoomId" value="">
                <form id="createRoomForm" onsubmit="createRoom(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeID">Office</label>
                            <select id="newOfficeID" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select Office--</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newRoomNumber">Room Number *</label>
                            <input type="text" id="newRoomNumber" required placeholder="e.g., 101, A-1" maxlength="20">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newRoomName">Room Name *</label>
                            <input type="text" id="newRoomName" required placeholder="e.g., Exam Room 1" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newRoomType">Room Type *</label>
                            <select id="newRoomType" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);" onchange="toggleCustomRoomType()">
                                <option value="">--Select Type--</option>
                                <option value="Exam Room">Exam Room</option>
                                <option value="Surgery Room">Surgery Room</option>
                                <option value="Consultation Room">Consultation Room</option>
                                <option value="X-Ray Room">X-Ray Room</option>
                                <option value="Lab">Lab</option>
                                <option value="Office">Office</option>
                                <option value="Storage">Storage</option>
                                <option value="Break Room">Break Room</option>
                                <option value="Front Desk">Front Desk</option>
                                <option value="Conference Room">Conference Room</option>
                                <option value="Other">Other</option>
                            </select>
                            <div id="customRoomTypeContainer" style="display: none; margin-top: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" id="newCustomRoomType" placeholder="Enter custom room type..." maxlength="50" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <button type="button" onclick="cancelCustomRoomType()" style="padding: 0.75rem 1rem; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newRoomCategory">Room Category *</label>
                            <select id="newRoomCategory" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">--Select Category--</option>
                                <option value="clinical">Clinical</option>
                                <option value="non-clinical">Non-Clinical</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newDimensions">Dimensions</label>
                            <input type="text" id="newDimensions" placeholder="e.g., 12x15 ft, 4x5 m" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newRoomColor">Calendar Color</label>
                            <input type="color" id="newRoomColor" value="#06b6d4" style="width: 100%; height: 45px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newRoomStatus">Status *</label>
                            <select id="newRoomStatus" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="Active">Active</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newRoomNotes">Notes</label>
                        <textarea id="newRoomNotes" placeholder="Additional notes about this room..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 80px; resize: vertical;" maxlength="500"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="newIsActive" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Room is Active</span>
                        </label>
                    </div>

                    <div id="createRoomError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" id="roomSubmitBtn" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>
                            Add Room
                        </button>
                        <button type="button" onclick="closeRoomForm()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Office Management Modal -->
<div id="officesManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-building" style="color: var(--accent-primary);"></i>
                Office Management
            </h3>
            <button onclick="closeOfficesManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Offices List First -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--text-primary);">Offices</h4>
                    <button onclick="openAddOfficeForm()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(6, 182, 212, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(6, 182, 212, 0.3)'">
                        <i class="fas fa-plus-circle"></i>
                        Add New Office
                    </button>
                </div>
                <div style="background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Office Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Phone</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Address</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Status</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 600; color: var(--text-primary); border-bottom: 1px solid var(--border-color);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="officesList">
                            <!-- Offices will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Office Form (Hidden by default) -->
            <div id="officeFormSection" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 id="officeFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Office</h4>
                <input type="hidden" id="editOfficeId" value="">
                <form id="createOfficeForm" onsubmit="createOffice(event)">
                    <!-- Office Logo Upload -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="officeLogoUpload">
                            <i class="fas fa-image" style="margin-right: 0.5rem;"></i>
                            Office Logo
                        </label>
                        <div style="display: flex; gap: 1rem; align-items: start;">
                            <div id="officeLogoPreview" style="width: 150px; height: 150px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: var(--bg-secondary);">
                                <i class="fas fa-building" style="font-size: 3rem; color: var(--text-tertiary);"></i>
                            </div>
                            <div style="flex: 1;">
                                <input type="file" id="officeLogoUpload" accept="image/*" onchange="previewOfficeLogo(event)" style="margin-bottom: 0.5rem;">
                                <div style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 0.5rem;">
                                    <i class="fas fa-info-circle" style="margin-right: 0.3rem;"></i>
                                    Maximum file size: 5MB. Recommended: Square logo (500x500px or larger)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeName">Office Name *</label>
                            <input type="text" id="newOfficeName" required placeholder="e.g., Main Office, Downtown Branch" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficePhone">Phone</label>
                            <input type="tel" id="newOfficePhone" placeholder="(555) 555-5555" maxlength="20">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newOfficeAddress">Address</label>
                        <input type="text" id="newOfficeAddress" placeholder="Street address" maxlength="200">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeCity">City</label>
                            <input type="text" id="newOfficeCity" placeholder="City" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeState">State</label>
                            <input type="text" id="newOfficeState" placeholder="State" maxlength="50">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeZipCode">Zip Code</label>
                            <input type="text" id="newOfficeZipCode" placeholder="12345" maxlength="20">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeEmail">Email</label>
                            <input type="email" id="newOfficeEmail" placeholder="office@email.com" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeWebsite">Website</label>
                            <input type="text" id="newOfficeWebsite" placeholder="Website or link" maxlength="200">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newDefaultDentist">Default Dentist</label>
                            <input type="text" id="newDefaultDentist" placeholder="Dr. Name" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeColor">Calendar Color</label>
                            <input type="color" id="newOfficeColor" value="#06b6d4" style="width: 100%; height: 45px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newTaxonomyNumber">Taxonomy Number</label>
                            <input type="text" id="newTaxonomyNumber" placeholder="Taxonomy #" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newClinicNPI">Clinic NPI</label>
                            <input type="text" id="newClinicNPI" placeholder="NPI Number" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newClinicTIN">Clinic TIN</label>
                            <input type="text" id="newClinicTIN" placeholder="TIN Number" maxlength="200">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newLegalName">Legal Name</label>
                            <input type="text" id="newLegalName" placeholder="Legal business name" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newLegalAddress">Legal Address</label>
                            <input type="text" id="newLegalAddress" placeholder="Legal address" maxlength="300">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newOfficeStatus">Status *</label>
                            <select id="newOfficeStatus" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Operating Hours Section -->
                    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 1rem 0; color: var(--accent-primary); font-size: 0.95rem;">
                            <i class="fas fa-clock" style="margin-right: 0.5rem;"></i>
                            Operating Hours
                        </h5>
                        <div style="display: grid; gap: 0.75rem;">
                            <!-- Monday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="dayMonday" style="width: 16px; height: 16px;">
                                    <span>Monday</span>
                                </label>
                                <input type="time" id="mondayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="mondayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <!-- Tuesday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="dayTuesday" style="width: 16px; height: 16px;">
                                    <span>Tuesday</span>
                                </label>
                                <input type="time" id="tuesdayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="tuesdayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <!-- Wednesday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="dayWednesday" style="width: 16px; height: 16px;">
                                    <span>Wednesday</span>
                                </label>
                                <input type="time" id="wednesdayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="wednesdayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <!-- Thursday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="dayThursday" style="width: 16px; height: 16px;">
                                    <span>Thursday</span>
                                </label>
                                <input type="time" id="thursdayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="thursdayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <!-- Friday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="dayFriday" style="width: 16px; height: 16px;">
                                    <span>Friday</span>
                                </label>
                                <input type="time" id="fridayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="fridayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <!-- Saturday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="daySaturday" style="width: 16px; height: 16px;">
                                    <span>Saturday</span>
                                </label>
                                <input type="time" id="saturdayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="saturdayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <!-- Sunday -->
                            <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 0.75rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="daySunday" style="width: 16px; height: 16px;">
                                    <span>Sunday</span>
                                </label>
                                <input type="time" id="sundayOpen" placeholder="Open" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                                <input type="time" id="sundayClose" placeholder="Close" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newOfficeDescription">Description</label>
                        <textarea id="newOfficeDescription" placeholder="Additional information about this office..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 80px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="newOfficeIsActive" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Office is Active</span>
                        </label>
                    </div>

                    <div id="createOfficeError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" id="officeSubmitBtn" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>
                            Add Office
                        </button>
                        <button type="button" onclick="closeOfficeForm()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Equipment List View Modal -->
<div id="equipmentListModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 90vw; max-width: 1000px; max-height: 90vh; overflow-y: auto; background: var(--bg-primary);">
        <div style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-tools" style="color: var(--accent-primary);"></i>
                Equipment Inventory
            </h3>
            <button onclick="closeEquipmentListView()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <input type="text" id="equipmentListSearch" placeholder="Search equipment..." oninput="filterEquipmentList()" style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                <select id="equipmentListCategory" onchange="filterEquipmentList()" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="equipmentListContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- Instruments List View Modal -->
<div id="instrumentsListModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 90vw; max-width: 1000px; max-height: 90vh; overflow-y: auto; background: var(--bg-primary);">
        <div style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-syringe" style="color: #10b981;"></i>
                Instruments Inventory
            </h3>
            <button onclick="closeInstrumentsListView()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <input type="text" id="instrumentsListSearch" placeholder="Search instruments..." oninput="filterInstrumentsList()" style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                <select id="instrumentsListCategory" onchange="filterInstrumentsList()" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="instrumentsListContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- Supplies List View Modal -->
<div id="suppliesListModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 90vw; max-width: 1000px; max-height: 90vh; overflow-y: auto; background: var(--bg-primary);">
        <div style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-boxes" style="color: #8b5cf6;"></i>
                Supplies Inventory
            </h3>
            <button onclick="closeSuppliesListView()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="padding: 1.5rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <input type="text" id="suppliesListSearch" placeholder="Search supplies..." oninput="filterSuppliesList()" style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                <select id="suppliesListCategory" onchange="filterSuppliesList()" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="suppliesListContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- Office Plan Management Modal -->
<div id="officePlanModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 90vw; max-width: 1200px; max-height: 90vh; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-map-marked-alt" style="color: var(--accent-primary);"></i>
                Office Plan Management
            </h3>
            <button class="close-btn" onclick="closeOfficePlan()">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Upload/Change Office Plan Form -->
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">Upload or Change Office Plan</h4>
                <form id="officePlanForm" onsubmit="saveOfficePlan(event)">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="officePlanTitle">Plan Title</label>
                        <input type="text" id="officePlanTitle" placeholder="e.g., Main Office Floor Plan" maxlength="100" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Upload Method</label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="uploadMethod" value="file" checked onchange="toggleUploadMethod()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Upload File</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="uploadMethod" value="url" onchange="toggleUploadMethod()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Image URL</span>
                            </label>
                        </div>
                        
                        <div id="fileUploadSection">
                            <input type="file" id="officePlanFile" accept="image/*" onchange="previewOfficePlan(event)" style="width: 100%; padding: 0.75rem; border: 2px dashed var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); cursor: pointer;">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">Supported formats: JPG, PNG, GIF, SVG</p>
                        </div>
                        
                        <div id="urlUploadSection" style="display: none;">
                            <input type="text" id="officePlanUrl" placeholder="Enter image URL or file path" onchange="previewOfficePlanUrl()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="officePlanDescription">Description</label>
                        <textarea id="officePlanDescription" placeholder="Additional notes about the office plan..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div id="officePlanError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                            Save Office Plan
                        </button>
                        <button type="button" onclick="clearOfficePlan()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-eraser" style="margin-right: 0.5rem;"></i>
                            Clear
                        </button>
                    </div>
                </form>
            </div>

            <!-- Current Office Plan Preview -->
            <div>
                <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">Current Office Plan</h4>
                <div id="officePlanPreview" style="background: var(--card-bg); padding: 2rem; border-radius: 8px; text-align: center; border: 2px solid var(--border-color);">
                    <img id="officePlanImage" src="" alt="Office Plan" style="max-width: 100%; max-height: 60vh; object-fit: contain; border-radius: 8px; cursor: pointer; display: none;" onclick="viewFullScreen()">
                    <div id="noOfficePlanPlaceholder" style="padding: 3rem; color: var(--text-tertiary);">
                        <i class="fas fa-map-marked-alt" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">No office plan uploaded yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Upload a floor plan or office layout image above</p>
                    </div>
                    <div id="officePlanInfo" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 6px; display: none;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;" id="officePlanTitleDisplay">Office Plan</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);" id="officePlanDescDisplay">Click image to view full screen</div>
                    </div>
                </div>
                
                <!-- Sample Layout Templates -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h5 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.95rem;">
                        <i class="fas fa-th-large" style="color: var(--accent-primary); margin-right: 0.5rem;"></i>
                        Quick Templates (Click to use)
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                        <div onclick="useOfficePlanTemplate('dental')" style="cursor: pointer; padding: 1rem; background: var(--card-bg); border-radius: 8px; text-align: center; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='transparent'">
                            <i class="fas fa-tooth" style="font-size: 2rem; color: #06b6d4; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Dental Office</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">4 Operatories</div>
                        </div>
                        <div onclick="useOfficePlanTemplate('small')" style="cursor: pointer; padding: 1rem; background: var(--card-bg); border-radius: 8px; text-align: center; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='transparent'">
                            <i class="fas fa-clinic-medical" style="font-size: 2rem; color: #10b981; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Small Clinic</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">2 Rooms</div>
                        </div>
                        <div onclick="useOfficePlanTemplate('large')" style="cursor: pointer; padding: 1rem; background: var(--card-bg); border-radius: 8px; text-align: center; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='transparent'">
                            <i class="fas fa-hospital" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Large Practice</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">8+ Rooms</div>
                        </div>
                        <div onclick="useOfficePlanTemplate('custom')" style="cursor: pointer; padding: 1rem; background: var(--card-bg); border-radius: 8px; text-align: center; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='transparent'">
                            <i class="fas fa-edit" style="font-size: 2rem; color: #8b5cf6; margin-bottom: 0.5rem;"></i>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-primary);">Custom</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">Draw Your Own</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Master Settings Modal -->
<div id="masterSettingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 95vw; max-width: 800px; height: auto; max-height: 90vh; margin: auto; border-radius: 16px; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-sliders-h" style="color: #6366f1;"></i>
                Master Settings
            </h3>
            <button onclick="closeMasterSettings()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Company Branding Section -->
            <div style="margin-bottom: 2rem; background: var(--card-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color);">
                <h4 style="margin: 0 0 1.5rem 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
                    <i class="fas fa-palette" style="color: #6366f1;"></i>
                    Company Branding
                </h4>
                
                <!-- Logo Upload -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Company Logo</label>
                    <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                        <div id="logoPreviewBox" style="width: 120px; height: 120px; border: 2px dashed var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); overflow: hidden;">
                            <i class="fas fa-image" id="logoPreviewPlaceholder" style="font-size: 2.5rem; color: var(--text-tertiary);"></i>
                            <img id="logoPreviewImg" src="" alt="Logo Preview" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                        <div style="flex: 1;">
                            <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                            <button onclick="document.getElementById('logoFileInput').click()" style="padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-upload"></i>
                                Upload Logo
                            </button>
                            <button onclick="removeLogo()" style="padding: 0.5rem 1rem; background: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i> Remove Logo
                            </button>
                            <p style="margin: 0.75rem 0 0 0; font-size: 0.8rem; color: var(--text-tertiary);">Recommended: Square image, 200x200px or larger. PNG or JPG format.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Company Name -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Company Name</label>
                    <input type="text" id="settingsCompanyName" placeholder="Enter company name" value="ReformDental" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--bg-secondary); color: var(--text-primary);">
                </div>
                
                <!-- Tagline -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Tagline / Subtitle</label>
                    <input type="text" id="settingsTagline" placeholder="Enter tagline" value="Management System" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--bg-secondary); color: var(--text-primary);">
                </div>
            </div>
            
            <!-- Save Button -->
            <div style="display: flex; justify-content: flex-end; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <button onclick="closeMasterSettings()" style="padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cancel
                </button>
                <button onclick="saveMasterSettings()" style="padding: 0.75rem 2rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-save"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Vendors Management Modal -->
<div id="vendorsManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-truck" style="color: var(--accent-primary);"></i>
                Vendors Management
            </h3>
            <button onclick="closeVendorsManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Vendors List Section - FIRST -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list" style="color: var(--accent-primary);"></i>
                        Vendors List
                    </h4>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="refreshVendorsFromAPI()" style="padding: 0.75rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'" title="Refresh from database">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button onclick="openAddVendorForm()" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                            <i class="fas fa-plus"></i>
                            Add New Vendor
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Vendor Name</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Type</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Contact</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Phone</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: center; color: var(--text-secondary); font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendorsList">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Vendor Form - Hidden by default -->
            <div id="vendorFormSection" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 id="vendorFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Vendor</h4>
                <form id="createVendorForm" onsubmit="createVendor(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorName">Vendor Name *</label>
                            <input type="text" id="newVendorName" required placeholder="Vendor company name" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorType">Vendor Type</label>
                            <select id="newVendorType" onchange="toggleCustomVendorType()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Type</option>
                                <option value="Dental Supplies">Dental Supplies</option>
                                <option value="Lab">Lab</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Software">Software</option>
                                <option value="Services">Services</option>
                                <option value="Office Supplies">Office Supplies</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Other">Other</option>
                            </select>
                            <div id="customVendorTypeBox" style="display: none; margin-top: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="customVendorType" placeholder="Enter custom vendor type" maxlength="100" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <button type="button" onclick="cancelCustomVendorType()" style="padding: 0.75rem 1rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorContactName">Contact Name</label>
                            <input type="text" id="newVendorContactName" placeholder="Contact person" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorEmail">Email</label>
                            <input type="email" id="newVendorEmail" placeholder="vendor@email.com" maxlength="100">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorPhone">Phone</label>
                            <input type="tel" id="newVendorPhone" placeholder="(555) 555-5555" maxlength="20">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorAlternatePhone">Alternate Phone</label>
                            <input type="tel" id="newVendorAlternatePhone" placeholder="(555) 555-5555" maxlength="20">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newVendorAddress">Address</label>
                        <input type="text" id="newVendorAddress" placeholder="Street address" maxlength="200">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorCity">City</label>
                            <input type="text" id="newVendorCity" placeholder="City" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorState">State</label>
                            <input type="text" id="newVendorState" placeholder="State" maxlength="50">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newVendorZipCode">Zip Code</label>
                            <input type="text" id="newVendorZipCode" placeholder="12345" maxlength="20">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newVendorWebsite">Website</label>
                        <input type="text" id="newVendorWebsite" placeholder="Website or link" maxlength="200">
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newVendorNotes">Notes</label>
                        <textarea id="newVendorNotes" placeholder="Additional information about this vendor..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 80px; resize: vertical;" maxlength="500"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="newVendorIsActive" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Vendor is Active</span>
                        </label>
                    </div>

                    <input type="hidden" id="editVendorId" value="">
                    <div id="createVendorError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" id="vendorSubmitBtn" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>
                            Add Vendor
                        </button>
                        <button type="button" onclick="closeVendorForm()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Duties Management Modal -->
<div id="dutiesManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 90vw; max-width: 1000px; max-height: 90vh; margin: 0; border-radius: 12px; overflow: hidden; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-clipboard-check" style="color: var(--accent-primary);"></i>
                Duties Management
            </h3>
            <button onclick="closeDutiesManagement()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-tertiary);">&times;</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem; max-height: calc(90vh - 80px); overflow-y: auto;">
            <!-- Duty Form -->
            <div style="background: var(--card-bg); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--border-color);">
                <h4 id="dutyFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Duty</h4>
                <form onsubmit="saveDuty(event)">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="dutyName">Duty Name *</label>
                        <input type="text" id="dutyName" required placeholder="e.g., Morning Sterilization" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="dutyDescription">Description</label>
                        <textarea id="dutyDescription" rows="2" placeholder="Describe the duty..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); resize: vertical;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="dutySchedule">Schedule</label>
                            <select id="dutySchedule" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="dutyPriority">Priority</label>
                            <select id="dutyPriority" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="High">High</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="dutyScheduleTime">Time</label>
                            <input type="text" id="dutyScheduleTime" placeholder="e.g., 7:30 AM" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="dutyScheduleDay">Day/Frequency</label>
                            <input type="text" id="dutyScheduleDay" placeholder="e.g., Every Friday" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="dutyLocation">Location</label>
                        <input type="text" id="dutyLocation" placeholder="e.g., Sterilization Room" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px;">
                        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                        Assign duties to employees when creating or editing users in <strong>Manage Users</strong>.
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" id="saveDutyBtn" style="flex: 1; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-plus"></i> Add Duty
                        </button>
                        <button type="button" onclick="resetDutyForm()" style="padding: 0.75rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </form>
            </div>
            <!-- Duties List -->
            <div style="background: var(--card-bg); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--border-color);">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">
                    <i class="fas fa-list" style="margin-right: 0.5rem;"></i>All Duties
                    <span style="font-size: 0.8rem; font-weight: normal; color: var(--text-tertiary); margin-left: 0.5rem;">(<span id="dutiesCount">0</span> total)</span>
                </h4>
                <div id="dutiesListContainer" style="max-height: 400px; overflow-y: auto;">
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chat Button -->
<button class="floating-chat-btn" id="floatingChatBtn" onclick="openChat()" title="Team Chat">
    <i class="fas fa-comments"></i>
    <span class="floating-chat-badge" id="floatingChatBadge" style="display: none;">0</span>
</button>

<!-- Team Chat Modal -->
<div id="chatModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10003; align-items: center; justify-content: center;">
    <div style="width: 90vw; max-width: 900px; height: 80vh; max-height: 700px; background: var(--bg-primary); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <!-- Chat Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1rem 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-comments" style="color: var(--accent-primary);"></i>
                Team Chat
            </h3>
            <button onclick="closeChat()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-tertiary);">&times;</button>
        </div>
        
        <!-- Chat Content -->
        <div style="display: flex; flex: 1; overflow: hidden;">
            <!-- Conversations Sidebar -->
            <div style="width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column;">
                <!-- Chat Type Tabs -->
                <div style="display: flex; border-bottom: 1px solid var(--border-color);">
                    <button id="chatTabDirect" onclick="switchChatTab('direct')" style="flex: 1; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;">
                        <i class="fas fa-user"></i> Direct
                    </button>
                    <button id="chatTabGroup" onclick="switchChatTab('group')" style="flex: 1; padding: 0.75rem; background: var(--bg-tertiary); color: var(--text-secondary); border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;">
                        <i class="fas fa-users"></i> Groups
                    </button>
                    <button id="chatTabAnnouncements" onclick="switchChatTab('announcements')" style="flex: 1; padding: 0.75rem; background: var(--bg-tertiary); color: var(--text-secondary); border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;">
                        <i class="fas fa-bullhorn"></i> News
                    </button>
                </div>
                
                <!-- New Chat/Group Button -->
                <div style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                    <button id="newChatBtn" onclick="showNewChatPanel()" style="width: 100%; padding: 0.75rem; background: var(--accent-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i class="fas fa-plus"></i> <span id="newChatBtnText">New Chat</span>
                    </button>
                </div>
                
                <!-- Conversations List -->
                <div id="conversationsList" style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                    <div style="padding: 2rem; text-align: center; color: var(--text-tertiary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            
            <!-- Chat Area -->
            <div style="flex: 1; display: flex; flex-direction: column; background: var(--bg-primary);">
                <!-- Chat Header (selected conversation) -->
                <div id="chatAreaHeader" style="display: none; padding: 1rem 1.5rem; background: var(--card-bg); border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <button onclick="closeChatConversation()" style="background: none; border: none; cursor: pointer; color: var(--text-tertiary); font-size: 1.1rem; padding: 0.25rem; margin-right: 0.25rem;" title="Close conversation">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div id="chatUserAvatar" style="width: 40px; height: 40px; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;"></div>
                        <div style="flex: 1;">
                            <div id="chatUserName" style="font-weight: 600; color: var(--text-primary);"></div>
                            <div id="chatUserStatus" style="font-size: 0.75rem; color: var(--text-tertiary);"></div>
                        </div>
                        <button onclick="closeChatConversation()" style="background: none; border: none; cursor: pointer; color: var(--text-tertiary); font-size: 1.25rem; padding: 0.5rem;" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div id="messagesArea" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
                    <div id="chatPlaceholder" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-tertiary);">
                        <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">Select a conversation or start a new chat</p>
                    </div>
                </div>
                
                <!-- Message Input -->
                <div id="messageInputArea" style="display: none; padding: 1rem 1.5rem; background: var(--card-bg); border-top: 1px solid var(--border-color);">
                    <form onsubmit="sendMessage(event)" style="display: flex; gap: 0.75rem;">
                        <input type="text" id="messageInput" placeholder="Type a message..." style="flex: 1; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 24px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.95rem;" autocomplete="off">
                        <button type="submit" style="width: 44px; height: 44px; background: var(--accent-primary); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- New Chat Panel (hidden by default) -->
            <div id="newChatPanel" style="display: none; position: absolute; left: 280px; top: 60px; bottom: 0; right: 0; background: var(--bg-primary); z-index: 10;">
                <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                    <button onclick="hideNewChatPanel()" style="background: none; border: none; cursor: pointer; color: var(--text-tertiary); font-size: 1.25rem;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 style="margin: 0; color: var(--text-primary);">Start New Chat</h4>
                </div>
                <div style="padding: 1rem;">
                    <input type="text" id="userSearchInput" placeholder="Search team members..." oninput="filterChatUsers()" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); margin-bottom: 1rem;">
                </div>
                <div id="chatUsersList" style="padding: 0 1rem; overflow-y: auto; max-height: calc(100% - 140px);">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Equipment Management Modal -->
<div id="equipmentManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-cog" style="color: #f59e0b;"></i>
                Equipment Management
            </h3>
            <button onclick="closeEquipmentManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Equipment List Section - FIRST -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list" style="color: var(--accent-primary);"></i>
                        Equipment Inventory
                    </h4>
                    <button onclick="openAddEquipmentForm()" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <i class="fas fa-plus"></i>
                        Add New Equipment
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Equipment Name</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Category</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Location</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Status</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Next Service</th>
                                <th style="padding: 1rem; text-align: center; color: var(--text-secondary); font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentList">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Equipment Form - Hidden by default -->
            <div id="equipmentFormSection" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 id="equipmentFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Equipment</h4>
                <form id="createEquipmentForm" onsubmit="createEquipment(event)">
                    <input type="hidden" id="editEquipmentId" value="">
                    
                    <!-- Row 1: Name & Category -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentName">Equipment Name *</label>
                            <input type="text" id="newEquipmentName" required placeholder="e.g., Autoclave #1, X-Ray Unit" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentCategory">Category *</label>
                            <select id="newEquipmentCategory" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Category</option>
                                <option value="Sterilization">Sterilization</option>
                                <option value="Imaging">Imaging</option>
                                <option value="Dental Chairs">Dental Chairs</option>
                                <option value="Handpieces">Handpieces</option>
                                <option value="Lasers">Lasers</option>
                                <option value="Lab Equipment">Lab Equipment</option>
                                <option value="Computers">Computers</option>
                                <option value="HVAC/Facility">HVAC/Facility</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Row 2: Type -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newEquipmentType">Equipment Type</label>
                        <select id="newEquipmentType" onchange="toggleCustomEquipmentType()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            <option value="">Select Type</option>
                            <option value="Autoclave">Autoclave</option>
                            <option value="Ultrasonic Cleaner">Ultrasonic Cleaner</option>
                            <option value="X-Ray Unit">X-Ray Unit</option>
                            <option value="Panoramic X-Ray">Panoramic X-Ray</option>
                            <option value="CBCT Scanner">CBCT Scanner</option>
                            <option value="Intraoral Camera">Intraoral Camera</option>
                            <option value="Dental Chair">Dental Chair</option>
                            <option value="High-Speed Handpiece">High-Speed Handpiece</option>
                            <option value="Low-Speed Handpiece">Low-Speed Handpiece</option>
                            <option value="Electric Handpiece">Electric Handpiece</option>
                            <option value="Diode Laser">Diode Laser</option>
                            <option value="Curing Light">Curing Light</option>
                            <option value="Computer/Workstation">Computer/Workstation</option>
                            <option value="Server">Server</option>
                            <option value="Compressor">Compressor</option>
                            <option value="Vacuum Pump">Vacuum Pump</option>
                            <option value="HVAC System">HVAC System</option>
                            <option value="Other">Other</option>
                        </select>
                        <div id="customEquipmentTypeBox" style="display: none; margin-top: 0.5rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="customEquipmentType" placeholder="Enter custom type" maxlength="100" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <button type="button" onclick="cancelCustomEquipmentType()" style="padding: 0.75rem 1rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 3: Manufacturer & Model -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentManufacturer">Manufacturer</label>
                            <input type="text" id="newEquipmentManufacturer" placeholder="e.g., A-dec, Planmeca, Dentsply" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentModel">Model</label>
                            <input type="text" id="newEquipmentModel" placeholder="Model number" maxlength="100">
                        </div>
                    </div>
                    
                    <!-- Row 4: Serial Number -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newEquipmentSerial">Serial Number</label>
                        <input type="text" id="newEquipmentSerial" placeholder="Serial number" maxlength="100">
                    </div>
                    
                    <!-- Row 5: Purchase & Warranty Dates -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentPurchaseDate">Purchase Date</label>
                            <input type="date" id="newEquipmentPurchaseDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentWarranty">Warranty Expiry</label>
                            <input type="date" id="newEquipmentWarranty" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <!-- Row 6: Service Dates -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentLastService">Last Service Date</label>
                            <input type="date" id="newEquipmentLastService" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentNextService">Next Service Due</label>
                            <input type="date" id="newEquipmentNextService" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <!-- Row 7: Office & Location -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentOffice">Office</label>
                            <select id="newEquipmentOffice" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Office</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentLocation">Location/Room</label>
                            <input type="text" id="newEquipmentLocation" placeholder="e.g., Operatory 1, Lab, Front Desk" maxlength="100">
                        </div>
                    </div>
                    
                    <!-- Row 7.5: Vendor -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newEquipmentVendor">Vendor (Supplier/Service Provider)</label>
                        <select id="newEquipmentVendor" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            <option value="">Select Vendor</option>
                        </select>
                    </div>
                    
                    <!-- Row 8: Status & Condition -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentStatus">Status</label>
                            <select id="newEquipmentStatus" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="Operational">Operational</option>
                                <option value="Needs Service">Needs Service</option>
                                <option value="Under Repair">Under Repair</option>
                                <option value="Out of Service">Out of Service</option>
                                <option value="Retired">Retired</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newEquipmentCondition">Condition</label>
                            <select id="newEquipmentCondition" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Condition</option>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newEquipmentNotes">Notes</label>
                        <textarea id="newEquipmentNotes" placeholder="Additional information, maintenance history, special instructions..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 80px; resize: vertical;" maxlength="1000"></textarea>
                    </div>
                    
                    <!-- Active Checkbox -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="newEquipmentIsActive" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Equipment is Active</span>
                        </label>
                    </div>

                    <div id="createEquipmentError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" id="equipmentSubmitBtn" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>
                            Add Equipment
                        </button>
                        <button type="button" onclick="closeEquipmentForm()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Instruments Management Modal -->
<div id="instrumentsManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-tools" style="color: #06b6d4;"></i>
                Instruments Management
            </h3>
            <button onclick="closeInstrumentsManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Instruments List Section - FIRST -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list" style="color: var(--accent-primary);"></i>
                        Instruments Inventory
                    </h4>
                    <button onclick="openAddInstrumentForm()" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <i class="fas fa-plus"></i>
                        Add New Instrument
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Instrument Name</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Category</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Quantity</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Condition</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Location</th>
                                <th style="padding: 1rem; text-align: center; color: var(--text-secondary); font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="instrumentsList">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Instrument Form - Hidden by default -->
            <div id="instrumentFormSection" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 id="instrumentFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Instrument</h4>
                <form id="createInstrumentForm" onsubmit="createInstrument(event)">
                    <input type="hidden" id="editInstrumentId" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentName">Instrument Name *</label>
                            <input type="text" id="newInstrumentName" required placeholder="e.g., Explorer #23, Scaler H6/7" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentCategory">Category *</label>
                            <select id="newInstrumentCategory" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);" onchange="toggleCustomInstrumentCategory()">
                                <option value="">Select Category</option>
                                <option value="Diagnostic">Diagnostic</option>
                                <option value="Surgical">Surgical</option>
                                <option value="Restorative">Restorative</option>
                                <option value="Endodontic">Endodontic</option>
                                <option value="Periodontal">Periodontal</option>
                                <option value="Orthodontic">Orthodontic</option>
                                <option value="Prosthodontic">Prosthodontic</option>
                                <option value="Hygiene">Hygiene</option>
                                <option value="Other">Other (Add New)</option>
                            </select>
                            <div id="customInstrumentCategoryWrapper" style="display: none; margin-top: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" id="customInstrumentCategory" placeholder="Enter new category name" maxlength="50" style="flex: 1; padding: 0.75rem; border: 1px solid var(--accent-primary); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                    <button type="button" onclick="cancelCustomCategory()" style="padding: 0.75rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); cursor: pointer; white-space: nowrap;" title="Cancel">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentType">Instrument Type</label>
                            <input type="text" id="newInstrumentType" placeholder="e.g., Mirror, Probe, Forceps" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentManufacturer">Manufacturer</label>
                            <input type="text" id="newInstrumentManufacturer" placeholder="e.g., Hu-Friedy, Premier" maxlength="100">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentQuantity">Quantity</label>
                            <input type="number" id="newInstrumentQuantity" min="1" value="1" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentOffice">Office</label>
                            <select id="newInstrumentOffice" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Office</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentLocation">Location/Room</label>
                            <input type="text" id="newInstrumentLocation" placeholder="e.g., Operatory 1, Sterilization" maxlength="100">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newInstrumentVendor">Vendor</label>
                        <select id="newInstrumentVendor" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            <option value="">Select Vendor</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="newInstrumentSterilization" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Sterilization Required</span>
                            </label>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentLastSterilized">Last Sterilized</label>
                            <input type="date" id="newInstrumentLastSterilized" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newInstrumentCondition">Condition</label>
                            <select id="newInstrumentCondition" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Condition</option>
                                <option value="Excellent">Excellent</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                                <option value="Needs Replacement">Needs Replacement</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newInstrumentNotes">Notes</label>
                        <textarea id="newInstrumentNotes" placeholder="Additional information..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 60px; resize: vertical;" maxlength="500"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="newInstrumentIsActive" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Instrument is Active</span>
                        </label>
                    </div>

                    <div id="createInstrumentError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" id="instrumentSubmitBtn" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>
                            Add Instrument
                        </button>
                        <button type="button" onclick="closeInstrumentForm()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Supplies Management Modal -->
<div id="suppliesManagementModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div class="login-card" style="width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto; background: var(--bg-primary);">
        <div class="login-header" style="display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; background: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-boxes" style="color: #8b5cf6;"></i>
                Supplies Management
            </h3>
            <button onclick="closeSuppliesManagement()" style="background: #ef4444; color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Close">&times;</button>
        </div>
        
        <div class="modal-body" style="padding: 2rem;">
            <!-- Supplies List Section - FIRST -->
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list" style="color: var(--accent-primary);"></i>
                        Supplies Inventory
                    </h4>
                    <button onclick="openAddSupplyForm()" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <i class="fas fa-plus"></i>
                        Add New Supply
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Supply Name</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Category</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Stock</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Reorder Level</th>
                                <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 600;">Expiration</th>
                                <th style="padding: 1rem; text-align: center; color: var(--text-secondary); font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliesList">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Supply Form - Hidden by default -->
            <div id="supplyFormSection" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 id="supplyFormTitle" style="margin: 0 0 1rem 0; color: var(--text-primary);">Add New Supply</h4>
                <form id="createSupplyForm" onsubmit="createSupply(event)">
                    <input type="hidden" id="editSupplyId" value="">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyName">Supply Name *</label>
                            <input type="text" id="newSupplyName" required placeholder="e.g., Gloves (Medium), Cotton Rolls" maxlength="200">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyCategory">Category *</label>
                            <select id="newSupplyCategory" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Category</option>
                                <option value="Disposables">Disposables</option>
                                <option value="Dental Materials">Dental Materials</option>
                                <option value="Anesthetics">Anesthetics</option>
                                <option value="Infection Control">Infection Control</option>
                                <option value="Office Supplies">Office Supplies</option>
                                <option value="Lab Supplies">Lab Supplies</option>
                                <option value="PPE">PPE</option>
                                <option value="Impression Materials">Impression Materials</option>
                                <option value="Cements & Adhesives">Cements & Adhesives</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplySKU">SKU / Item Number</label>
                            <input type="text" id="newSupplySKU" placeholder="Product SKU or catalog number" maxlength="50">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyManufacturer">Manufacturer / Brand</label>
                            <input type="text" id="newSupplyManufacturer" placeholder="e.g., 3M, Dentsply" maxlength="100">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyQuantity">Qty in Stock</label>
                            <input type="number" id="newSupplyQuantity" min="0" value="0" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyUnit">Unit</label>
                            <input type="text" id="newSupplyUnit" placeholder="e.g., boxes, packs" maxlength="30">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyReorderLevel">Reorder Level</label>
                            <input type="number" id="newSupplyReorderLevel" min="0" value="0" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyUnitCost">Unit Cost ($)</label>
                            <input type="number" id="newSupplyUnitCost" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyOffice">Office</label>
                            <select id="newSupplyOffice" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">Select Office</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyLocation">Storage Location</label>
                            <input type="text" id="newSupplyLocation" placeholder="e.g., Cabinet A, Supply Room" maxlength="100">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="newSupplyExpiration">Expiration Date</label>
                            <input type="date" id="newSupplyExpiration" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newSupplyVendor">Vendor</label>
                        <select id="newSupplyVendor" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
                            <option value="">Select Vendor</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="newSupplyNotes">Notes</label>
                        <textarea id="newSupplyNotes" placeholder="Additional information, storage requirements, etc." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); min-height: 60px; resize: vertical;" maxlength="500"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="newSupplyIsActive" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Supply is Active</span>
                        </label>
                    </div>

                    <div id="createSupplyError" class="login-error" style="display: none;"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" id="supplySubmitBtn" class="login-btn" style="width: auto; padding: 0.75rem 2rem;">
                            <i class="fas fa-plus-circle" style="margin-right: 0.5rem;"></i>
                            Add Supply
                        </button>
                        <button type="button" onclick="closeSupplyForm()" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Manager Modal - Gamified Snowball Builder -->
<div id="scheduleManagerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: red; z-index: 99999;">
    <div style="padding: 50px; background: white; margin: 50px;">
        <h1>TEST - Schedule Manager Modal is Working!</h1>
        <button onclick="closeScheduleManager()" style="padding: 20px; font-size: 20px;">Close This</button>
    </div>
</div>

<!-- Schedule Manager Real Content (hidden for now) -->
<div id="scheduleManagerContent" style="display: none;">
    <style>
        /* Schedule Builder Game Styles */
        #scheduleManagerModal .schedule-game-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
        }
        
        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        .game-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .game-title i {
            color: #60a5fa;
        }
        
        .game-close-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .game-close-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        /* Snowball */
        .snowball {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #e0e7ff, #a5b4fc);
            border-radius: 50%;
            cursor: grab;
            z-index: 50;
            box-shadow: 
                0 0 20px rgba(255,255,255,0.5),
                0 0 40px rgba(165, 180, 252, 0.3),
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 5px 5px 10px rgba(255,255,255,0.8);
            transition: width 0.5s, height 0.5s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        
        .snowball:active {
            cursor: grabbing;
        }
        
        .snowball.collected-1 {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #bbf7d0, #4ade80);
            box-shadow: 
                0 0 30px rgba(74, 222, 128, 0.6),
                0 0 60px rgba(74, 222, 128, 0.3),
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 5px 5px 10px rgba(255,255,255,0.8);
        }
        
        .snowball.collected-2 {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #fde68a, #fbbf24);
            box-shadow: 
                0 0 40px rgba(251, 191, 36, 0.6),
                0 0 80px rgba(251, 191, 36, 0.3),
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 5px 5px 10px rgba(255,255,255,0.8);
        }
        
        .snowball.collected-3 {
            width: 120px;
            height: 120px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #c4b5fd, #8b5cf6);
            box-shadow: 
                0 0 50px rgba(139, 92, 246, 0.6),
                0 0 100px rgba(139, 92, 246, 0.3),
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 5px 5px 10px rgba(255,255,255,0.8);
        }
        
        .snowball.collected-4 {
            width: 140px;
            height: 140px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #fecaca, #f87171);
            box-shadow: 
                0 0 60px rgba(248, 113, 113, 0.6),
                0 0 120px rgba(248, 113, 113, 0.3),
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 5px 5px 10px rgba(255,255,255,0.8);
        }
        
        .snowball.collected-5 {
            width: 160px;
            height: 160px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #99f6e4, #2dd4bf);
            box-shadow: 
                0 0 70px rgba(45, 212, 191, 0.6),
                0 0 140px rgba(45, 212, 191, 0.3),
                inset -10px -10px 20px rgba(0,0,0,0.1),
                inset 5px 5px 10px rgba(255,255,255,0.8);
            animation: pulse-complete 1s infinite;
        }
        
        @keyframes pulse-complete {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .snowball-content {
            text-align: center;
            font-size: 0.7rem;
            color: rgba(0,0,0,0.6);
            font-weight: 600;
            padding: 5px;
            pointer-events: none;
        }
        
        /* Station styles */
        .game-station {
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .game-station:hover {
            transform: scale(1.05);
        }
        
        .game-station.active {
            animation: station-glow 1.5s infinite;
        }
        
        .game-station.completed {
            opacity: 0.5;
            transform: scale(0.9);
        }
        
        .game-station.drop-zone {
            animation: drop-ready 0.5s infinite;
        }
        
        @keyframes station-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,255,255,0.6), 0 0 60px rgba(255,255,255,0.3); }
        }
        
        @keyframes drop-ready {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
        }
        
        .station-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .station-label {
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .station-value {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            opacity: 0.8;
            max-width: 130px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Station colors */
        .station-provider {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.3), rgba(34, 197, 94, 0.5));
            border: 3px solid #4ade80;
            color: #4ade80;
        }
        
        .station-clinic {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.5));
            border: 3px solid #fbbf24;
            color: #fbbf24;
        }
        
        .station-room {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.5));
            border: 3px solid #8b5cf6;
            color: #8b5cf6;
        }
        
        .station-date {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.3), rgba(239, 68, 68, 0.5));
            border: 3px solid #f87171;
            color: #f87171;
        }
        
        .station-time {
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.3), rgba(20, 184, 166, 0.5));
            border: 3px solid #2dd4bf;
            color: #2dd4bf;
        }
        
        /* Selection Panel */
        .selection-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .selection-panel.open {
            transform: translateY(0);
        }
        
        .selection-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .selection-item {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            color: white;
        }
        
        .selection-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .selection-item i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        /* Progress indicator */
        .progress-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 70;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }
        
        .progress-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        
        .progress-dot.completed {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }
        
        .progress-dot.active {
            background: #60a5fa;
            box-shadow: 0 0 15px #60a5fa;
            animation: pulse-dot 1s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        
        /* Collected items display */
        .collected-display {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            color: white;
            z-index: 70;
            min-width: 200px;
        }
        
        .collected-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
        }
        
        .collected-item:last-child {
            border-bottom: none;
        }
        
        .collected-item i {
            width: 20px;
        }
        
        .collected-item .label {
            opacity: 0.6;
            width: 60px;
        }
        
        .collected-item .value {
            font-weight: 600;
        }
        
        /* Submit button */
        .submit-schedule-btn {
            position: absolute;
            bottom: 80px;
            right: 30px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            z-index: 70;
            display: none;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 40px rgba(74, 222, 128, 0.4);
            transition: all 0.3s;
        }
        
        .submit-schedule-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 50px rgba(74, 222, 128, 0.5);
        }
        
        .submit-schedule-btn.visible {
            display: flex;
            animation: bounce-in 0.5s;
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Reset button */
        .reset-btn {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            z-index: 70;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .reset-btn:hover {
            background: rgba(239, 68, 68, 0.5);
        }
        
        /* Particle effects */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: float-up 2s forwards;
        }
        
        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(0); }
        }
        
        /* Instruction overlay */
        .game-instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            padding: 2rem 3rem;
            border-radius: 20px;
            color: white;
            text-align: center;
            z-index: 80;
            max-width: 400px;
        }
        
        .game-instructions h2 {
            margin-bottom: 1rem;
            color: #60a5fa;
        }
        
        .game-instructions p {
            margin-bottom: 1.5rem;
            opacity: 0.8;
            line-height: 1.6;
        }
        
        .start-game-btn {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .start-game-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 100;
        }
    </style>
    
    <div class="schedule-game-container" id="scheduleGameContainer">
        <!-- Header -->
        <div class="game-header">
            <div class="game-title">
                <i class="fas fa-snowflake"></i>
                Schedule Builder
            </div>
            <button class="game-close-btn" onclick="closeScheduleManager()">&times;</button>
        </div>
        
        <!-- Reset Button -->
        <button class="reset-btn" onclick="resetScheduleGame()">
            <i class="fas fa-redo"></i> Reset
        </button>
        
        <!-- Collected Items Display -->
        <div class="collected-display" id="collectedDisplay">
            <div style="font-weight: 700; margin-bottom: 0.5rem; color: #60a5fa;">
                <i class="fas fa-clipboard-list"></i> Building Schedule
            </div>
            <div class="collected-item">
                <i class="fas fa-user-md" style="color: #4ade80;"></i>
                <span class="label">Provider:</span>
                <span class="value" id="displayProvider">-</span>
            </div>
            <div class="collected-item">
                <i class="fas fa-hospital" style="color: #fbbf24;"></i>
                <span class="label">Clinic:</span>
                <span class="value" id="displayClinic">-</span>
            </div>
            <div class="collected-item">
                <i class="fas fa-door-open" style="color: #8b5cf6;"></i>
                <span class="label">Room:</span>
                <span class="value" id="displayRoom">-</span>
            </div>
            <div class="collected-item">
                <i class="fas fa-calendar" style="color: #f87171;"></i>
                <span class="label">Days:</span>
                <span class="value" id="displayDate">-</span>
            </div>
            <div class="collected-item">
                <i class="fas fa-clock" style="color: #2dd4bf;"></i>
                <span class="label">Time:</span>
                <span class="value" id="displayTime">-</span>
            </div>
        </div>
        
        <!-- Stations -->
        <div class="game-station station-provider active" id="stationProvider" style="top: 15%; left: 10%;">
            <i class="fas fa-user-md station-icon"></i>
            <div class="station-label">Provider</div>
            <div class="station-value" id="stationProviderValue">Click to select</div>
        </div>
        
        <div class="game-station station-clinic" id="stationClinic" style="top: 15%; right: 10%;">
            <i class="fas fa-hospital station-icon"></i>
            <div class="station-label">Clinic</div>
            <div class="station-value" id="stationClinicValue">Waiting...</div>
        </div>
        
        <div class="game-station station-room" id="stationRoom" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <i class="fas fa-door-open station-icon"></i>
            <div class="station-label">Room</div>
            <div class="station-value" id="stationRoomValue">Waiting...</div>
        </div>
        
        <div class="game-station station-date" id="stationDate" style="bottom: 20%; left: 10%;">
            <i class="fas fa-calendar-alt station-icon"></i>
            <div class="station-label">Days</div>
            <div class="station-value" id="stationDateValue">Waiting...</div>
        </div>
        
        <div class="game-station station-time" id="stationTime" style="bottom: 20%; right: 10%;">
            <i class="fas fa-clock station-icon"></i>
            <div class="station-label">Time</div>
            <div class="station-value" id="stationTimeValue">Waiting...</div>
        </div>
        
        <!-- The Snowball -->
        <div class="snowball" id="snowball" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div class="snowball-content">
                <i class="fas fa-snowflake" style="font-size: 1.5rem;"></i>
                <div>Drag me!</div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-dot active" data-step="provider"></div>
            <div class="progress-dot" data-step="clinic"></div>
            <div class="progress-dot" data-step="room"></div>
            <div class="progress-dot" data-step="date"></div>
            <div class="progress-dot" data-step="time"></div>
        </div>
        
        <!-- Submit Button -->
        <button class="submit-schedule-btn" id="submitScheduleBtn" onclick="submitSchedule()">
            <i class="fas fa-check-circle"></i>
            Create Schedule
        </button>
        
        <!-- Selection Panel -->
        <div class="selection-panel" id="selectionPanel">
            <div class="selection-title" id="selectionTitle">
                <i class="fas fa-list"></i>
                Select an option
            </div>
            <div class="selection-grid" id="selectionGrid">
                <!-- Options populated dynamically -->
            </div>
        </div>
        
        <!-- Instructions Overlay -->
        <div class="game-instructions" id="gameInstructions">
            <h2><i class="fas fa-gamepad"></i> Schedule Builder</h2>
            <p>Build a schedule by clicking on the glowing stations to collect information. Watch your snowball grow as it gathers data!</p>
            <p style="font-size: 0.9rem;"><strong>Steps:</strong> Provider â†’ Clinic â†’ Room â†’ Days â†’ Time</p>
            <button class="start-game-btn" onclick="startScheduleGame()">
                <i class="fas fa-play"></i> Start Building
            </button>
        </div>
    </div>
    
    <script>
    // Schedule Builder Game Logic
    (function() {
        let scheduleData = {
            provider: null,
            clinic: null,
            room: null,
            days: null,
            time: null
        };
        
        let currentStep = 0;
        const steps = ['provider', 'clinic', 'room', 'date', 'time'];
        
        // Game data - Loaded dynamically from masterData
        const gameData = {
            providers: [], // Will be populated from masterData
            clinics: [],   // Will be populated from masterData
            rooms: [],     // Will be populated from masterData
            days: [
                { id: 1, name: 'Mon-Fri', value: 'Mon,Tue,Wed,Thu,Fri' },
                { id: 2, name: 'Mon-Sat', value: 'Mon,Tue,Wed,Thu,Fri,Sat' },
                { id: 3, name: 'Mon,Wed,Fri', value: 'Mon,Wed,Fri' },
                { id: 4, name: 'Tue,Thu,Sat', value: 'Tue,Thu,Sat' },
                { id: 5, name: 'Weekends', value: 'Sat,Sun' },
                { id: 6, name: 'Custom...', value: 'custom' }
            ],
            times: [
                { id: 1, name: '08:00 - 12:00', start: '08:00', end: '12:00' },
                { id: 2, name: '08:00 - 16:00', start: '08:00', end: '16:00' },
                { id: 3, name: '09:00 - 17:00', start: '09:00', end: '17:00' },
                { id: 4, name: '12:00 - 20:00', start: '12:00', end: '20:00' },
                { id: 5, name: '14:00 - 22:00', start: '14:00', end: '22:00' },
                { id: 6, name: 'Custom...', value: 'custom' }
            ]
        };
        
        // Initialize gameData from masterData
        function initializeGameData() {
            // Load providers
            const providers = masterData.getProviders();
            gameData.providers = providers.map((p, i) => ({
                id: i + 1,
                name: p.title,
                role: p.extendedProps?.role || 'Provider',
                icon: 'fa-user-md'
            }));
            
            // Load clinics
            gameData.clinics = masterData.clinics.map((c, i) => ({
                id: i + 1,
                name: c.name,
                color: c.color || '#10b981',
                icon: c.icon || 'fa-hospital'
            }));
            
            // Load rooms
            gameData.rooms = masterData.rooms.map((r, i) => ({
                id: i + 1,
                name: r.name,
                clinic: masterData.getClinicById(r.clinicId)?.name || ''
            }));
            
            console.log('âœ… Game data initialized from masterData');
        }
        
        window.startScheduleGame = function() {
            // Initialize data from masterData
            initializeGameData();
            document.getElementById('gameInstructions').style.display = 'none';
            updateStationStates();
        };
        
        window.resetScheduleGame = function() {
            scheduleData = { provider: null, clinic: null, room: null, days: null, time: null };
            currentStep = 0;
            
            // Reset snowball
            const snowball = document.getElementById('snowball');
            snowball.className = 'snowball';
            snowball.innerHTML = '<div class="snowball-content"><i class="fas fa-snowflake" style="font-size: 1.5rem;"></i><div>Drag me!</div></div>';
            
            // Reset displays
            document.getElementById('displayProvider').textContent = '-';
            document.getElementById('displayClinic').textContent = '-';
            document.getElementById('displayRoom').textContent = '-';
            document.getElementById('displayDate').textContent = '-';
            document.getElementById('displayTime').textContent = '-';
            
            // Reset station values
            document.getElementById('stationProviderValue').textContent = 'Click to select';
            document.getElementById('stationClinicValue').textContent = 'Waiting...';
            document.getElementById('stationRoomValue').textContent = 'Waiting...';
            document.getElementById('stationDateValue').textContent = 'Waiting...';
            document.getElementById('stationTimeValue').textContent = 'Waiting...';
            
            // Hide submit button
            document.getElementById('submitScheduleBtn').classList.remove('visible');
            
            // Close selection panel
            document.getElementById('selectionPanel').classList.remove('open');
            
            updateStationStates();
            updateProgressBar();
        };
        
        function updateStationStates() {
            const stations = ['Provider', 'Clinic', 'Room', 'Date', 'Time'];
            stations.forEach((station, index) => {
                const el = document.getElementById('station' + station);
                el.classList.remove('active', 'completed');
                
                if (index < currentStep) {
                    el.classList.add('completed');
                } else if (index === currentStep) {
                    el.classList.add('active');
                }
            });
        }
        
        function updateProgressBar() {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < currentStep) {
                    dot.classList.add('completed');
                } else if (index === currentStep) {
                    dot.classList.add('active');
                }
            });
        }
        
        function createParticles(x, y, color) {
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.width = Math.random() * 10 + 5 + 'px';
                particle.style.height = particle.style.width;
                particle.style.background = color;
                particle.style.transform = `translate(${(Math.random() - 0.5) * 100}px, 0)`;
                document.getElementById('scheduleGameContainer').appendChild(particle);
                
                setTimeout(() => particle.remove(), 2000);
            }
        }
        
        function showSelectionPanel(type) {
            const panel = document.getElementById('selectionPanel');
            const grid = document.getElementById('selectionGrid');
            const title = document.getElementById('selectionTitle');
            
            let items = [];
            let titleText = '';
            let icon = '';
            
            switch(type) {
                case 'provider':
                    items = gameData.providers;
                    titleText = 'Select a Provider';
                    icon = 'fa-user-md';
                    break;
                case 'clinic':
                    items = gameData.clinics;
                    titleText = 'Select a Clinic';
                    icon = 'fa-hospital';
                    break;
                case 'room':
                    items = gameData.rooms.filter(r => r.clinic === scheduleData.clinic);
                    titleText = 'Select a Room';
                    icon = 'fa-door-open';
                    break;
                case 'date':
                    items = gameData.days;
                    titleText = 'Select Working Days';
                    icon = 'fa-calendar-alt';
                    break;
                case 'time':
                    items = gameData.times;
                    titleText = 'Select Time Slot';
                    icon = 'fa-clock';
                    break;
            }
            
            title.innerHTML = '<i class="fas ' + icon + '"></i> ' + titleText;
            
            grid.innerHTML = items.map(item => `
                <div class="selection-item" onclick="selectItem('${type}', '${item.name}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <i class="fas ${item.icon || icon}" style="color: ${item.color || '#60a5fa'}"></i>
                    <div style="font-weight: 600;">${item.name}</div>
                    ${item.role ? '<div style="font-size: 0.75rem; opacity: 0.7;">' + item.role + '</div>' : ''}
                </div>
            `).join('');
            
            panel.classList.add('open');
        }
        
        window.selectItem = function(type, name, data) {
            const panel = document.getElementById('selectionPanel');
            panel.classList.remove('open');
            
            // Store data
            if (type === 'date') {
                scheduleData.days = name;
            } else if (type === 'time') {
                scheduleData.time = name;
            } else {
                scheduleData[type] = name;
            }
            
            // Update display
            const displayMap = {
                provider: 'displayProvider',
                clinic: 'displayClinic',
                room: 'displayRoom',
                date: 'displayDate',
                time: 'displayTime'
            };
            document.getElementById(displayMap[type]).textContent = name;
            
            // Update station value
            const stationMap = {
                provider: 'stationProviderValue',
                clinic: 'stationClinicValue',
                room: 'stationRoomValue',
                date: 'stationDateValue',
                time: 'stationTimeValue'
            };
            document.getElementById(stationMap[type]).textContent = name;
            
            // Update snowball
            const snowball = document.getElementById('snowball');
            currentStep++;
            snowball.className = 'snowball collected-' + currentStep;
            
            // Create particles
            const station = document.getElementById('station' + type.charAt(0).toUpperCase() + type.slice(1));
            const rect = station.getBoundingClientRect();
            createParticles(rect.left + rect.width/2, rect.top + rect.height/2, getStationColor(type));
            
            updateStationStates();
            updateProgressBar();
            
            // Check if complete
            if (currentStep === 5) {
                document.getElementById('submitScheduleBtn').classList.add('visible');
                celebrateCompletion();
            }
        };
        
        function getStationColor(type) {
            const colors = {
                provider: '#4ade80',
                clinic: '#fbbf24',
                room: '#8b5cf6',
                date: '#f87171',
                time: '#2dd4bf'
            };
            return colors[type];
        }
        
        function celebrateCompletion() {
            // Create confetti
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-20px';
                    confetti.style.background = ['#4ade80', '#fbbf24', '#8b5cf6', '#f87171', '#2dd4bf', '#60a5fa'][Math.floor(Math.random() * 6)];
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    confetti.style.animation = `confetti-fall ${2 + Math.random() * 2}s linear forwards`;
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 50);
            }
            
            // Add confetti animation
            if (!document.getElementById('confettiStyle')) {
                const style = document.createElement('style');
                style.id = 'confettiStyle';
                style.textContent = `
                    @keyframes confetti-fall {
                        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        window.submitSchedule = function() {
            // Create success message
            const message = `
                âœ… Schedule Created Successfully!
                
                Provider: ${scheduleData.provider}
                Clinic: ${scheduleData.clinic}
                Room: ${scheduleData.room}
                Days: ${scheduleData.days}
                Time: ${scheduleData.time}
            `;
            
            alert(message);
            resetScheduleGame();
        };
        
        // Setup station click handlers
        document.addEventListener('DOMContentLoaded', function() {
            const stationTypes = ['provider', 'clinic', 'room', 'date', 'time'];
            
            stationTypes.forEach((type, index) => {
                const station = document.getElementById('station' + type.charAt(0).toUpperCase() + type.slice(1));
                station.addEventListener('click', function() {
                    if (index === currentStep) {
                        showSelectionPanel(type);
                    }
                });
            });
        });
        
        // Also setup immediately in case DOM is ready
        if (document.readyState !== 'loading') {
            const stationTypes = ['provider', 'clinic', 'room', 'date', 'time'];
            stationTypes.forEach((type, index) => {
                const station = document.getElementById('station' + type.charAt(0).toUpperCase() + type.slice(1));
                if (station) {
                    station.onclick = function() {
                        if (index === currentStep) {
                            showSelectionPanel(type);
                        }
                    };
                }
            });
        }
    })();
    </script>
</div>

<script>
// Office Plan Management Functions
let currentOfficePlan = {
    title: '',
    description: '',
    imageUrl: '',
    uploadDate: null
};

function showOfficePlan() {
    const modal = document.getElementById('officePlanModal');
    if (modal) {
        modal.style.display = 'flex';
        loadCurrentOfficePlan();
    }
}

function closeOfficePlan() {
    const modal = document.getElementById('officePlanModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function toggleUploadMethod() {
    const fileSection = document.getElementById('fileUploadSection');
    const urlSection = document.getElementById('urlUploadSection');
    const selectedMethod = document.querySelector('input[name="uploadMethod"]:checked').value;
    
    if (selectedMethod === 'file') {
        fileSection.style.display = 'block';
        urlSection.style.display = 'none';
    } else {
        fileSection.style.display = 'none';
        urlSection.style.display = 'block';
    }
}

function previewOfficePlan(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('officePlanImage');
            img.src = e.target.result;
            img.style.display = 'block';
            document.getElementById('noOfficePlanPlaceholder').style.display = 'none';
            document.getElementById('officePlanInfo').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function previewOfficePlanUrl() {
    const url = document.getElementById('officePlanUrl').value;
    if (url) {
        const img = document.getElementById('officePlanImage');
        img.src = url;
        img.style.display = 'block';
        document.getElementById('noOfficePlanPlaceholder').style.display = 'none';
        document.getElementById('officePlanInfo').style.display = 'block';
    }
}

// Use office plan template
function useOfficePlanTemplate(templateType) {
    const templates = {
        dental: {
            title: 'Dental Office Layout - 4 Operatories',
            description: 'Standard dental office with reception, 4 operatories, sterilization area, and staff room',
            // Generate a simple dental office layout as SVG data URL
            imageUrl: generateDentalLayoutSVG()
        },
        small: {
            title: 'Small Clinic Layout - 2 Rooms',
            description: 'Compact clinic with reception, 2 treatment rooms, and utility area',
            imageUrl: generateSmallClinicSVG()
        },
        large: {
            title: 'Large Practice Layout - 8 Rooms',
            description: 'Full-service practice with reception, waiting area, 8 treatment rooms, lab, and offices',
            imageUrl: generateLargePracticeSVG()
        },
        custom: {
            title: 'Custom Layout',
            description: 'Upload your own custom office layout or draw one',
            imageUrl: ''
        }
    };
    
    const template = templates[templateType];
    if (!template) return;
    
    if (templateType === 'custom') {
        // Clear and let user upload
        document.getElementById('officePlanTitle').value = template.title;
        document.getElementById('officePlanDescription').value = template.description;
        showNotification('Please upload your custom floor plan image', 'info');
        return;
    }
    
    // Set template values
    document.getElementById('officePlanTitle').value = template.title;
    document.getElementById('officePlanDescription').value = template.description;
    
    // Update preview
    const img = document.getElementById('officePlanImage');
    img.src = template.imageUrl;
    img.style.display = 'block';
    document.getElementById('noOfficePlanPlaceholder').style.display = 'none';
    document.getElementById('officePlanInfo').style.display = 'block';
    document.getElementById('officePlanTitleDisplay').textContent = template.title;
    document.getElementById('officePlanDescDisplay').textContent = template.description;
    
    // Switch to URL mode
    document.querySelector('input[name="uploadMethod"][value="url"]').checked = true;
    toggleUploadMethod();
    
    showNotification('Template loaded! Click "Save Office Plan" to apply.', 'success');
}

// Generate dental layout SVG
function generateDentalLayoutSVG() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 500" style="background:#f8fafc">
        <rect x="10" y="10" width="780" height="480" fill="none" stroke="#374151" stroke-width="3"/>
        
        <!-- Reception Area -->
        <rect x="20" y="20" width="200" height="150" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
        <text x="120" y="100" text-anchor="middle" fill="#1e40af" font-size="14" font-weight="bold">Reception</text>
        
        <!-- Waiting Room -->
        <rect x="20" y="180" width="200" height="130" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
        <text x="120" y="250" text-anchor="middle" fill="#166534" font-size="14" font-weight="bold">Waiting Room</text>
        
        <!-- Operatory 1 -->
        <rect x="240" y="20" width="160" height="140" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="320" y="70" text-anchor="middle" fill="#92400e" font-size="12" font-weight="bold">Operatory 1</text>
        <circle cx="320" cy="110" r="25" fill="#fed7aa" stroke="#f59e0b"/>
        
        <!-- Operatory 2 -->
        <rect x="420" y="20" width="160" height="140" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="500" y="70" text-anchor="middle" fill="#92400e" font-size="12" font-weight="bold">Operatory 2</text>
        <circle cx="500" cy="110" r="25" fill="#fed7aa" stroke="#f59e0b"/>
        
        <!-- Operatory 3 -->
        <rect x="240" y="180" width="160" height="140" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="320" y="230" text-anchor="middle" fill="#92400e" font-size="12" font-weight="bold">Operatory 3</text>
        <circle cx="320" cy="270" r="25" fill="#fed7aa" stroke="#f59e0b"/>
        
        <!-- Operatory 4 -->
        <rect x="420" y="180" width="160" height="140" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="500" y="230" text-anchor="middle" fill="#92400e" font-size="12" font-weight="bold">Operatory 4</text>
        <circle cx="500" cy="270" r="25" fill="#fed7aa" stroke="#f59e0b"/>
        
        <!-- Sterilization -->
        <rect x="600" y="20" width="170" height="140" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
        <text x="685" y="95" text-anchor="middle" fill="#be185d" font-size="12" font-weight="bold">Sterilization</text>
        
        <!-- Staff Room -->
        <rect x="600" y="180" width="170" height="140" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
        <text x="685" y="255" text-anchor="middle" fill="#4338ca" font-size="12" font-weight="bold">Staff Room</text>
        
        <!-- Restrooms -->
        <rect x="20" y="320" width="90" height="80" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
        <text x="65" y="365" text-anchor="middle" fill="#7e22ce" font-size="10" font-weight="bold">Restroom</text>
        
        <!-- Storage -->
        <rect x="120" y="320" width="100" height="80" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/>
        <text x="170" y="365" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">Storage</text>
        
        <!-- Hallway -->
        <rect x="240" y="340" width="340" height="60" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
        <text x="410" y="375" text-anchor="middle" fill="#64748b" font-size="11">Hallway</text>
        
        <!-- Lab -->
        <rect x="600" y="340" width="170" height="140" fill="#ecfdf5" stroke="#10b981" stroke-width="2"/>
        <text x="685" y="415" text-anchor="middle" fill="#047857" font-size="12" font-weight="bold">Lab</text>
        
        <!-- Legend -->
        <text x="25" y="465" fill="#374151" font-size="10">Reform Dental - Office Floor Plan</text>
    </svg>`;
    return 'data:image/svg+xml;base64,' + btoa(svg);
}

// Generate small clinic SVG
function generateSmallClinicSVG() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 400" style="background:#f8fafc">
        <rect x="10" y="10" width="580" height="380" fill="none" stroke="#374151" stroke-width="3"/>
        
        <!-- Reception -->
        <rect x="20" y="20" width="180" height="120" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
        <text x="110" y="85" text-anchor="middle" fill="#1e40af" font-size="14" font-weight="bold">Reception</text>
        
        <!-- Waiting -->
        <rect x="20" y="150" width="180" height="120" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
        <text x="110" y="215" text-anchor="middle" fill="#166534" font-size="14" font-weight="bold">Waiting</text>
        
        <!-- Treatment Room 1 -->
        <rect x="220" y="20" width="170" height="150" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="305" y="80" text-anchor="middle" fill="#92400e" font-size="12" font-weight="bold">Treatment 1</text>
        <circle cx="305" cy="120" r="30" fill="#fed7aa" stroke="#f59e0b"/>
        
        <!-- Treatment Room 2 -->
        <rect x="400" y="20" width="170" height="150" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="485" y="80" text-anchor="middle" fill="#92400e" font-size="12" font-weight="bold">Treatment 2</text>
        <circle cx="485" cy="120" r="30" fill="#fed7aa" stroke="#f59e0b"/>
        
        <!-- Utility -->
        <rect x="220" y="190" width="170" height="100" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
        <text x="305" y="245" text-anchor="middle" fill="#be185d" font-size="12" font-weight="bold">Utility</text>
        
        <!-- Office -->
        <rect x="400" y="190" width="170" height="100" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
        <text x="485" y="245" text-anchor="middle" fill="#4338ca" font-size="12" font-weight="bold">Office</text>
        
        <!-- Restroom -->
        <rect x="20" y="290" width="100" height="80" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
        <text x="70" y="335" text-anchor="middle" fill="#7e22ce" font-size="10" font-weight="bold">Restroom</text>
        
        <!-- Storage -->
        <rect x="130" y="290" width="100" height="80" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/>
        <text x="180" y="335" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">Storage</text>
        
        <text x="25" y="380" fill="#374151" font-size="10">Small Clinic - 2 Treatment Rooms</text>
    </svg>`;
    return 'data:image/svg+xml;base64,' + btoa(svg);
}

// Generate large practice SVG
function generateLargePracticeSVG() {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600" style="background:#f8fafc">
        <rect x="10" y="10" width="980" height="580" fill="none" stroke="#374151" stroke-width="3"/>
        
        <!-- Reception -->
        <rect x="20" y="20" width="200" height="120" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
        <text x="120" y="85" text-anchor="middle" fill="#1e40af" font-size="14" font-weight="bold">Reception</text>
        
        <!-- Large Waiting -->
        <rect x="20" y="150" width="200" height="180" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
        <text x="120" y="245" text-anchor="middle" fill="#166534" font-size="14" font-weight="bold">Waiting Area</text>
        
        <!-- Row 1: Rooms 1-4 -->
        <rect x="240" y="20" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="295" y="75" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 1</text>
        
        <rect x="360" y="20" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="415" y="75" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 2</text>
        
        <rect x="480" y="20" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="535" y="75" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 3</text>
        
        <rect x="600" y="20" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="655" y="75" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 4</text>
        
        <!-- Row 2: Rooms 5-8 -->
        <rect x="240" y="130" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="295" y="185" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 5</text>
        
        <rect x="360" y="130" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="415" y="185" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 6</text>
        
        <rect x="480" y="130" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="535" y="185" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 7</text>
        
        <rect x="600" y="130" width="110" height="100" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
        <text x="655" y="185" text-anchor="middle" fill="#92400e" font-size="11" font-weight="bold">Room 8</text>
        
        <!-- Sterilization -->
        <rect x="720" y="20" width="260" height="100" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
        <text x="850" y="75" text-anchor="middle" fill="#be185d" font-size="12" font-weight="bold">Sterilization Central</text>
        
        <!-- Lab -->
        <rect x="720" y="130" width="130" height="100" fill="#ecfdf5" stroke="#10b981" stroke-width="2"/>
        <text x="785" y="185" text-anchor="middle" fill="#047857" font-size="12" font-weight="bold">Lab</text>
        
        <!-- X-Ray -->
        <rect x="860" y="130" width="120" height="100" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
        <text x="920" y="185" text-anchor="middle" fill="#6d28d9" font-size="12" font-weight="bold">X-Ray</text>
        
        <!-- Hallway -->
        <rect x="240" y="240" width="470" height="50" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1"/>
        <text x="475" y="270" text-anchor="middle" fill="#64748b" font-size="11">Main Hallway</text>
        
        <!-- Office 1 -->
        <rect x="240" y="300" width="150" height="120" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
        <text x="315" y="365" text-anchor="middle" fill="#4338ca" font-size="12" font-weight="bold">Dr. Office 1</text>
        
        <!-- Office 2 -->
        <rect x="400" y="300" width="150" height="120" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
        <text x="475" y="365" text-anchor="middle" fill="#4338ca" font-size="12" font-weight="bold">Dr. Office 2</text>
        
        <!-- Staff Room -->
        <rect x="560" y="300" width="150" height="120" fill="#fef2f2" stroke="#ef4444" stroke-width="2"/>
        <text x="635" y="365" text-anchor="middle" fill="#b91c1c" font-size="12" font-weight="bold">Staff Room</text>
        
        <!-- Conference -->
        <rect x="720" y="240" width="130" height="100" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="2"/>
        <text x="785" y="295" text-anchor="middle" fill="#0369a1" font-size="11" font-weight="bold">Conference</text>
        
        <!-- Storage -->
        <rect x="860" y="240" width="120" height="100" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/>
        <text x="920" y="295" text-anchor="middle" fill="#475569" font-size="11" font-weight="bold">Storage</text>
        
        <!-- Restrooms -->
        <rect x="20" y="340" width="100" height="80" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
        <text x="70" y="385" text-anchor="middle" fill="#7e22ce" font-size="10" font-weight="bold">Restroom 1</text>
        
        <rect x="130" y="340" width="100" height="80" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
        <text x="180" y="385" text-anchor="middle" fill="#7e22ce" font-size="10" font-weight="bold">Restroom 2</text>
        
        <!-- IT Room -->
        <rect x="720" y="350" width="130" height="70" fill="#fafafa" stroke="#525252" stroke-width="2"/>
        <text x="785" y="390" text-anchor="middle" fill="#404040" font-size="10" font-weight="bold">IT/Server</text>
        
        <!-- Supply -->
        <rect x="860" y="350" width="120" height="70" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/>
        <text x="920" y="390" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">Supply</text>
        
        <text x="25" y="575" fill="#374151" font-size="10">Large Practice - 8+ Treatment Rooms - Full Service Dental Facility</text>
    </svg>`;
    return 'data:image/svg+xml;base64,' + btoa(svg);
}

function saveOfficePlan(event) {
    event.preventDefault();
    
    const title = document.getElementById('officePlanTitle').value || 'Office Plan';
    const description = document.getElementById('officePlanDescription').value || 'Click image to view full screen';
    const uploadMethod = document.querySelector('input[name="uploadMethod"]:checked').value;
    const img = document.getElementById('officePlanImage');
    
    if (uploadMethod === 'url') {
        const url = document.getElementById('officePlanUrl').value;
        if (!url && !img.src) {
            showError('Please enter an image URL');
            return;
        }
    } else {
        const file = document.getElementById('officePlanFile').files[0];
        if (!file && (!img.src || img.style.display === 'none')) {
            showError('Please select an image file');
            return;
        }
    }
    
    // Update current office plan data
    currentOfficePlan = {
        title: title,
        description: description,
        imageUrl: img.src,
        uploadDate: new Date().toISOString()
    };
    
    // Save to localStorage
    localStorage.setItem('officePlan', JSON.stringify(currentOfficePlan));
    
    // Update display
    document.getElementById('officePlanTitleDisplay').textContent = title;
    document.getElementById('officePlanDescDisplay').textContent = description;
    img.style.display = 'block';
    document.getElementById('noOfficePlanPlaceholder').style.display = 'none';
    document.getElementById('officePlanInfo').style.display = 'block';
    
    // Show success message
    showNotification('Office plan saved successfully!', 'success');
    
    // Clear form
    document.getElementById('officePlanForm').reset();
}

function clearOfficePlan() {
    document.getElementById('officePlanForm').reset();
    document.getElementById('officePlanFile').value = '';
    document.getElementById('officePlanUrl').value = '';
}

function loadCurrentOfficePlan() {
    // Load from localStorage if available
    const savedPlan = localStorage.getItem('officePlan');
    if (savedPlan) {
        currentOfficePlan = JSON.parse(savedPlan);
        const img = document.getElementById('officePlanImage');
        
        if (currentOfficePlan.imageUrl) {
            img.src = currentOfficePlan.imageUrl;
            img.style.display = 'block';
            document.getElementById('noOfficePlanPlaceholder').style.display = 'none';
            document.getElementById('officePlanInfo').style.display = 'block';
            document.getElementById('officePlanTitleDisplay').textContent = currentOfficePlan.title;
            document.getElementById('officePlanDescDisplay').textContent = currentOfficePlan.description;
        } else {
            img.style.display = 'none';
            document.getElementById('noOfficePlanPlaceholder').style.display = 'block';
            document.getElementById('officePlanInfo').style.display = 'none';
        }
    } else {
        // No saved plan - show placeholder
        document.getElementById('officePlanImage').style.display = 'none';
        document.getElementById('noOfficePlanPlaceholder').style.display = 'block';
        document.getElementById('officePlanInfo').style.display = 'none';
    }
}

function viewFullScreen() {
    const img = document.getElementById('officePlanImage');
    if (img.requestFullscreen) {
        img.requestFullscreen();
    } else if (img.webkitRequestFullscreen) {
        img.webkitRequestFullscreen();
    } else if (img.msRequestFullscreen) {
        img.msRequestFullscreen();
    }
}

function showError(message) {
    const errorDiv = document.getElementById('officePlanError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 3000);
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out;';
    successDiv.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>' + message;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('officePlanModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeOfficePlan();
            }
        });
    }
    
    // Close list view modals when clicking outside
    ['equipmentListModal', 'instrumentsListModal', 'suppliesListModal'].forEach(modalId => {
        const listModal = document.getElementById(modalId);
        if (listModal) {
            listModal.addEventListener('click', function(e) {
                if (e.target === listModal) {
                    listModal.style.display = 'none';
                }
            });
        }
    });
    
    // Load saved office plan on page load
    loadCurrentOfficePlan();

    // Initialize sticky notes board
    initStickyNotesBoard();
    
    // Update inventory badge counts
    if (typeof updateInventoryBadges === 'function') {
        updateInventoryBadges();
    }
    
    // Sync all data from master data source
    if (typeof syncAllData === 'function') {
        syncAllData();
    }
    
    // Load data from API on startup
    if (typeof loadDataFromAPI === 'function') {
        loadDataFromAPI();
    }
});

// ========================================
// API INTEGRATION - Connect to Azure SQL Database
// ========================================
const API_BASE_URL = '/api';

// Fetch users from API and sync with localStorage
async function fetchUsersFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/users`);
        if (!response.ok) throw new Error('Failed to fetch users');
        const users = await response.json();
        console.log('âœ… Fetched', users.length, 'users from API');
        return users;
    } catch (error) {
        console.error('âŒ Error fetching users from API:', error);
        return null;
    }
}

// Fetch clinics from API
async function fetchClinicsFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/clinics`);
        if (!response.ok) throw new Error('Failed to fetch clinics');
        const clinics = await response.json();
        console.log('âœ… Fetched', clinics.length, 'clinics from API');
        return clinics;
    } catch (error) {
        console.error('âŒ Error fetching clinics from API:', error);
        return null;
    }
}

// Sync API users to localStorage format
async function syncUsersFromAPI() {
    const apiUsers = await fetchUsersFromAPI();
    if (!apiUsers) return false;
    
    // Convert API format to localStorage format - map ALL fields
    const localUsers = {};
    apiUsers.forEach(user => {
        const username = user.Username || user.username;
        localUsers[username] = {
            id: user.Id || user.id,
            password: '***', // Don't store passwords in localStorage
            role: user.Role || user.role || 'user',
            name: `${user.FirstName || ''} ${user.LastName || ''}`.trim(),
            firstName: user.FirstName || user.firstName || '',
            middleName: user.MiddleName || user.middleName || '',
            lastName: user.LastName || user.lastName || '',
            gender: user.Gender || user.gender || '',
            dateOfBirth: user.DateOfBirth || user.dateOfBirth || '',
            personalEmail: user.PersonalEmail || user.personalEmail || '',
            workEmail: user.WorkEmail || user.workEmail || '',
            homePhone: user.HomePhone || user.homePhone || '',
            cellPhone: user.CellPhone || user.cellPhone || '',
            address: user.Address || user.address || '',
            city: user.City || user.city || '',
            state: user.State || user.state || '',
            zipCode: user.ZipCode || user.zipCode || '',
            jobTitle: user.JobTitle || user.jobTitle || '',
            staffType: user.StaffType || user.staffType || 'non-clinical',
            employeeType: user.EmployeeType || user.employeeType || 'full-time',
            department: user.Department || user.department || '',
            employeeStatus: user.EmployeeStatus || user.employeeStatus || 'active',
            hireDate: user.HireDate || user.hireDate || '',
            hourlyRate: user.HourlyRate || user.hourlyRate || '',
            salary: user.Salary || user.salary || '',
            color: user.Color || user.color || '#3b82f6',
            permissions: getDefaultPermissions(user.Role || user.role || 'user')
        };
    });
    
    // REPLACE localStorage with API users only (database is source of truth)
    localStorage.setItem('appUsers', JSON.stringify(localUsers));
    console.log('âœ… Synced', Object.keys(localUsers).length, 'users from API (database is source of truth)');
    
    // Refresh employee resources
    if (typeof loadEmployeeResourcesFromUsers === 'function') {
        loadEmployeeResourcesFromUsers();
    }
    
    // Refresh the users table if visible
    if (typeof renderUsersTable === 'function') {
        renderUsersTable();
    }
    
    // Refresh the users list if visible
    if (typeof displayUsersList === 'function') {
        displayUsersList();
    }
    
    return true;
}

// Sync API clinics to localStorage
async function syncClinicsFromAPI() {
    const apiClinics = await fetchClinicsFromAPI();
    if (!apiClinics || apiClinics.length === 0) return false;
    
    // Convert API format to localStorage format
    const localClinics = apiClinics.map(clinic => ({
        id: `clinic-${clinic.Id || clinic.id}`,
        name: clinic.Name || clinic.name,
        address: clinic.Address || clinic.address || '',
        city: clinic.City || clinic.city || '',
        state: clinic.State || clinic.state || '',
        phone: clinic.Phone || clinic.phone || '',
        email: clinic.Email || clinic.email || '',
        color: clinic.Color || clinic.color || '#3b82f6',
        icon: clinic.Icon || clinic.icon || 'fa-hospital'
    }));
    
    localStorage.setItem('clinics', JSON.stringify(localClinics));
    
    // Update master data
    if (typeof masterData !== 'undefined') {
        masterData.clinics = localClinics;
    }
    
    console.log('âœ… Synced', localClinics.length, 'clinics from API');
    return true;
}

// Create user via API
async function createUserViaAPI(userData) {
    try {
        const response = await fetch(`${API_BASE_URL}/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: userData.username,
                password: userData.password || 'changeme123',
                firstName: userData.firstName,
                lastName: userData.lastName,
                role: userData.role || 'user',
                staffType: userData.staffType || 'non-clinical',
                employeeStatus: userData.employeeStatus || 'active'
            })
        });
        
        if (!response.ok) throw new Error('Failed to create user');
        const result = await response.json();
        console.log('âœ… User created via API:', result);
        
        // Sync users after creation
        await syncUsersFromAPI();
        return result;
    } catch (error) {
        console.error('âŒ Error creating user via API:', error);
        return null;
    }
}

// Login via API
async function loginViaAPI(username, password) {
    try {
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            console.error('âŒ Login failed:', result.error);
            return null;
        }
        
        console.log('âœ… Login successful:', result.user);
        return result.user;
    } catch (error) {
        console.error('âŒ Error during API login:', error);
        return null;
    }
}

// Create clinic via API
async function createClinicViaAPI(clinicData) {
    try {
        const response = await fetch(`${API_BASE_URL}/clinics`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: clinicData.name,
                address: clinicData.address,
                city: clinicData.city,
                state: clinicData.state,
                phone: clinicData.phone,
                email: clinicData.email
            })
        });
        
        if (!response.ok) throw new Error('Failed to create clinic');
        const result = await response.json();
        console.log('âœ… Clinic created via API:', result);
        
        // Sync clinics after creation
        await syncClinicsFromAPI();
        return result;
    } catch (error) {
        console.error('âŒ Error creating clinic via API:', error);
        return null;
    }
}

// Load all data from API on startup
async function loadDataFromAPI() {
    console.log('ðŸ”„ Loading data from API...');
    
    try {
        // Sync users first
        await syncUsersFromAPI();
        
        // Sync clinics
        await syncClinicsFromAPI();
        
        console.log('âœ… All data synced from API');
    } catch (error) {
        console.error('âŒ Error loading data from API:', error);
    }
}

// Show API sync status
function showSyncStatus(message, isSuccess = true) {
    const statusDiv = document.createElement('div');
    statusDiv.style.cssText = `
        position: fixed; 
        bottom: 20px; 
        right: 20px; 
        background: ${isSuccess ? '#10b981' : '#ef4444'}; 
        color: white; 
        padding: 0.75rem 1.25rem; 
        border-radius: 8px; 
        z-index: 10001; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    `;
    statusDiv.innerHTML = `<i class="fas fa-${isSuccess ? 'cloud-download-alt' : 'exclamation-triangle'}"></i> ${message}`;
    document.body.appendChild(statusDiv);
    
    setTimeout(() => statusDiv.remove(), 3000);
}

// ============ EQUIPMENT API FUNCTIONS ============
async function saveEquipmentToAPI(equipmentData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/equipment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: equipmentData.name,
                serialNumber: equipmentData.serialNumber || '',
                clinicId: equipmentData.clinicId || null,
                status: equipmentData.status || 'operational',
                purchaseDate: equipmentData.purchaseDate || null,
                warranty: equipmentData.warranty || '',
                notes: equipmentData.notes || ''
            })
        });
        if (response.ok) {
            console.log('âœ… Equipment saved to database');
            showSyncStatus('Equipment saved to database', true);
        }
    } catch (error) {
        console.error('âŒ Error saving equipment to API:', error);
    }
}

async function updateEquipmentViaAPI(id, equipmentData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/equipment/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(equipmentData)
        });
        if (response.ok) {
            console.log('âœ… Equipment updated in database');
            showSyncStatus('Equipment updated', true);
        }
    } catch (error) {
        console.error('âŒ Error updating equipment:', error);
    }
}

async function deleteEquipmentViaAPI(id) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        await fetch(`${API_BASE_URL}/equipment/${id}`, { method: 'DELETE' });
        console.log('âœ… Equipment deleted from database');
    } catch (error) {
        console.error('âŒ Error deleting equipment:', error);
    }
}

async function syncEquipmentFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/equipment`);
        if (!response.ok) return false;
        const apiEquipment = await response.json();
        if (apiEquipment && apiEquipment.length > 0) {
            const localEquipment = apiEquipment.map(e => ({
                id: `eq-${e.Id || e.id}`,
                name: e.Name || e.name,
                serialNumber: e.SerialNumber || e.serialNumber || '',
                office: e.ClinicId || e.clinicId || '',
                status: e.Status || e.status || 'operational',
                purchaseDate: e.PurchaseDate || e.purchaseDate || '',
                warranty: e.Warranty || e.warranty || '',
                notes: e.Notes || e.notes || ''
            }));
            localStorage.setItem('equipment', JSON.stringify(localEquipment));
            console.log('âœ… Synced', localEquipment.length, 'equipment items from API');
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing equipment:', error);
        return false;
    }
}

// ============ INSTRUMENTS API FUNCTIONS ============
async function saveInstrumentToAPI(instrumentData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/instruments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: instrumentData.name,
                category: instrumentData.category || '',
                clinicId: instrumentData.clinicId || null,
                quantity: instrumentData.quantity || 1,
                status: instrumentData.status || 'available',
                sterilizationDate: instrumentData.sterilizationDate || null,
                notes: instrumentData.notes || ''
            })
        });
        if (response.ok) {
            console.log('âœ… Instrument saved to database');
            showSyncStatus('Instrument saved to database', true);
        }
    } catch (error) {
        console.error('âŒ Error saving instrument to API:', error);
    }
}

async function syncInstrumentsFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/instruments`);
        if (!response.ok) return false;
        const apiInstruments = await response.json();
        if (apiInstruments && apiInstruments.length > 0) {
            const localInstruments = apiInstruments.map(i => ({
                id: `inst-${i.Id || i.id}`,
                name: i.Name || i.name,
                category: i.Category || i.category || '',
                office: i.ClinicId || i.clinicId || '',
                quantity: i.Quantity || i.quantity || 1,
                status: i.Status || i.status || 'available',
                sterilizationDate: i.SterilizationDate || i.sterilizationDate || '',
                notes: i.Notes || i.notes || ''
            }));
            localStorage.setItem('instruments', JSON.stringify(localInstruments));
            console.log('âœ… Synced', localInstruments.length, 'instruments from API');
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing instruments:', error);
        return false;
    }
}

// ============ SUPPLIES API FUNCTIONS ============
async function saveSupplyToAPI(supplyData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/supplies`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: supplyData.name,
                category: supplyData.category || '',
                clinicId: supplyData.clinicId || null,
                quantity: supplyData.quantity || 0,
                minQuantity: supplyData.minQuantity || 0,
                unit: supplyData.unit || '',
                unitPrice: supplyData.unitPrice || null,
                notes: supplyData.notes || ''
            })
        });
        if (response.ok) {
            console.log('âœ… Supply saved to database');
            showSyncStatus('Supply saved to database', true);
        }
    } catch (error) {
        console.error('âŒ Error saving supply to API:', error);
    }
}

async function syncSuppliesFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/supplies`);
        if (!response.ok) return false;
        const apiSupplies = await response.json();
        if (apiSupplies && apiSupplies.length > 0) {
            const localSupplies = apiSupplies.map(s => ({
                id: `sup-${s.Id || s.id}`,
                name: s.Name || s.name,
                category: s.Category || s.category || '',
                office: s.ClinicId || s.clinicId || '',
                quantity: s.Quantity || s.quantity || 0,
                minQuantity: s.MinQuantity || s.minQuantity || 0,
                unit: s.Unit || s.unit || '',
                unitPrice: s.UnitPrice || s.unitPrice || 0,
                notes: s.Notes || s.notes || ''
            }));
            localStorage.setItem('supplies', JSON.stringify(localSupplies));
            console.log('âœ… Synced', localSupplies.length, 'supplies from API');
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing supplies:', error);
        return false;
    }
}

// ============ TASKS API FUNCTIONS ============
async function saveTaskToAPI(taskData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/tasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: taskData.title || taskData.name,
                description: taskData.description || '',
                assignedUserId: taskData.assignedUserId || null,
                clinicId: taskData.clinicId || null,
                dueDate: taskData.dueDate || null,
                priority: taskData.priority || 'medium',
                status: taskData.status || 'pending',
                category: taskData.category || ''
            })
        });
        if (response.ok) {
            const result = await response.json();
            console.log('âœ… Task saved to database:', result.id);
            showSyncStatus('Task saved to database', true);
            return result;
        }
    } catch (error) {
        console.error('âŒ Error saving task to API:', error);
    }
    return null;
}

async function updateTaskViaAPI(id, taskData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
        });
        if (response.ok) {
            console.log('âœ… Task updated in database');
            showSyncStatus('Task updated', true);
        }
    } catch (error) {
        console.error('âŒ Error updating task:', error);
    }
}

async function deleteTaskViaAPI(id) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        await fetch(`${API_BASE_URL}/tasks/${id}`, { method: 'DELETE' });
        console.log('âœ… Task deleted from database');
    } catch (error) {
        console.error('âŒ Error deleting task:', error);
    }
}

async function syncTasksFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/tasks`);
        if (!response.ok) return false;
        const apiTasks = await response.json();
        if (apiTasks && apiTasks.length > 0) {
            const localTasks = apiTasks.map(t => ({
                id: `task-${t.Id || t.id}`,
                title: t.Title || t.title,
                description: t.Description || t.description || '',
                assignedTo: t.AssignedUserId || t.assignedUserId || '',
                clinic: t.ClinicId || t.clinicId || '',
                dueDate: t.DueDate || t.dueDate || '',
                priority: t.Priority || t.priority || 'medium',
                status: t.Status || t.status || 'pending',
                category: t.Category || t.category || ''
            }));
            localStorage.setItem('tasks', JSON.stringify(localTasks));
            console.log('âœ… Synced', localTasks.length, 'tasks from API');
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing tasks:', error);
        return false;
    }
}

// ============ ROOMS API FUNCTIONS ============
async function saveRoomToAPI(roomData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/rooms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: roomData.name,
                clinicId: roomData.clinicId || null,
                type: roomData.type || 'operatory',
                color: roomData.color || '#3b82f6',
                status: roomData.status || 'available'
            })
        });
        if (response.ok) {
            console.log('âœ… Room saved to database');
            showSyncStatus('Room saved to database', true);
        }
    } catch (error) {
        console.error('âŒ Error saving room to API:', error);
    }
}

async function syncRoomsFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/rooms`);
        if (!response.ok) return false;
        const apiRooms = await response.json();
        if (apiRooms && apiRooms.length > 0) {
            const localRooms = apiRooms.map(r => ({
                id: `room-${r.Id || r.id}`,
                name: r.Name || r.name,
                clinic: r.ClinicId || r.clinicId || '',
                type: r.Type || r.type || 'operatory',
                color: r.Color || r.color || '#3b82f6',
                status: r.Status || r.status || 'available'
            }));
            localStorage.setItem('rooms', JSON.stringify(localRooms));
            console.log('âœ… Synced', localRooms.length, 'rooms from API');
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing rooms:', error);
        return false;
    }
}

// ============ SCHEDULES API FUNCTIONS ============
async function saveScheduleToAPI(scheduleData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/schedules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: scheduleData.userId || null,
                clinicId: scheduleData.clinicId || null,
                roomId: scheduleData.roomId || null,
                startDate: scheduleData.startDate,
                endDate: scheduleData.endDate || null,
                startTime: scheduleData.startTime,
                endTime: scheduleData.endTime,
                daysOfWeek: scheduleData.daysOfWeek || '',
                color: scheduleData.color || '#3b82f6',
                notes: scheduleData.notes || ''
            })
        });
        if (response.ok) {
            const result = await response.json();
            console.log('âœ… Schedule saved to database:', result.id);
            showSyncStatus('Schedule saved to database', true);
            return result;
        }
    } catch (error) {
        console.error('âŒ Error saving schedule to API:', error);
    }
    return null;
}

async function syncSchedulesFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/schedules`);
        if (!response.ok) return false;
        const apiSchedules = await response.json();
        if (apiSchedules && apiSchedules.length > 0) {
            const localSchedules = apiSchedules.map(s => ({
                id: `sched-${s.Id || s.id}`,
                employee: s.UserId || s.userId || '',
                employeeName: s.EmployeeName || '',
                clinic: s.ClinicId || s.clinicId || '',
                clinicName: s.ClinicName || '',
                room: s.RoomId || s.roomId || '',
                roomName: s.RoomName || '',
                startDate: s.StartDate || s.startDate,
                endDate: s.EndDate || s.endDate || '',
                startTime: s.StartTime || s.startTime,
                endTime: s.EndTime || s.endTime,
                daysOfWeek: s.DaysOfWeek || s.daysOfWeek || '',
                color: s.Color || s.color || '#3b82f6',
                notes: s.Notes || s.notes || ''
            }));
            localStorage.setItem('schedules', JSON.stringify(localSchedules));
            console.log('âœ… Synced', localSchedules.length, 'schedules from API');
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing schedules:', error);
        return false;
    }
}

// ============ VENDORS API FUNCTIONS ============
async function saveVendorToAPI(vendorData) {
    if (typeof API_BASE_URL === 'undefined') return;
    try {
        const response = await fetch(`${API_BASE_URL}/vendors`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: vendorData.name,
                contactPerson: vendorData.contactPerson || '',
                phone: vendorData.phone || '',
                email: vendorData.email || '',
                address: vendorData.address || '',
                notes: vendorData.notes || ''
            })
        });
        if (response.ok) {
            console.log('âœ… Vendor saved to database');
            showSyncStatus('Vendor saved to database', true);
        }
    } catch (error) {
        console.error('âŒ Error saving vendor to API:', error);
    }
}

async function syncVendorsFromAPI() {
    try {
        const response = await fetch(`${API_BASE_URL}/vendors`);
        if (!response.ok) return false;
        const apiVendors = await response.json();
        console.log('ðŸ“¦ API Vendors:', apiVendors);
        if (apiVendors && apiVendors.length > 0) {
            const localVendors = apiVendors.map(v => ({
                vendorID: v.Id || v.id,
                vendorName: v.Name || v.name || '',
                vendorType: v.VendorType || v.vendorType || v.Category || v.category || '',
                contactName: v.ContactName || v.contactName || '',
                phone: v.Phone || v.phone || '',
                alternatePhone: v.AlternatePhone || v.alternatePhone || '',
                email: v.Email || v.email || '',
                address: v.Address || v.address || '',
                city: v.City || v.city || '',
                state: v.State || v.state || '',
                zipCode: v.ZipCode || v.zipCode || '',
                website: v.Website || v.website || '',
                notes: v.Notes || v.notes || '',
                isActive: v.IsActive === true || v.IsActive === 1 || v.isActive === true || v.isActive === 1,
                createdDate: v.CreatedDate || v.createdDate || '',
                modifiedDate: v.ModifiedDate || v.modifiedDate || ''
            }));
            localStorage.setItem('vendors', JSON.stringify(localVendors));
            console.log('âœ… Synced', localVendors.length, 'vendors from API:', localVendors);
            
            // Refresh vendors list if modal is open
            if (typeof displayVendorsList === 'function') {
                displayVendorsList();
            }
        }
        return true;
    } catch (error) {
        console.error('âŒ Error syncing vendors:', error);
        return false;
    }
}

// ============ ENHANCED LOAD ALL DATA ============
async function loadAllDataFromAPI() {
    console.log('ðŸ”„ Loading ALL data from API...');
    showSyncStatus('Syncing with database...', true);
    
    try {
        await Promise.all([
            syncUsersFromAPI(),
            syncClinicsFromAPI(),
            syncRoomsFromAPI(),
            syncEquipmentFromAPI(),
            syncInstrumentsFromAPI(),
            syncSuppliesFromAPI(),
            syncTasksFromAPI(),
            syncSchedulesFromAPI(),
            syncVendorsFromAPI()
        ]);
        
        console.log('âœ… All data synced from database');
        showSyncStatus('All data synced from database!', true);
        
        // Refresh UI if needed
        if (typeof renderUsersTable === 'function') renderUsersTable();
        if (typeof displayEquipmentList === 'function') displayEquipmentList();
        if (typeof displayInstrumentsList === 'function') displayInstrumentsList();
        if (typeof displaySuppliesList === 'function') displaySuppliesList();
        
        // Load dynamic dropdowns
        loadClinicFilterDropdown();
        loadOfficesForUserForm();
        loadSupervisorsForUserForm();
        initPhoneFormatting();
        
    } catch (error) {
        console.error('âŒ Error loading data from API:', error);
        showSyncStatus('Error syncing data', false);
    }
}

// Load clinic filter dropdown from offices
async function loadClinicFilterDropdown() {
    const clinicSelect = document.getElementById('clinicFilterSelect');
    if (!clinicSelect) return;
    
    // Get offices from localStorage or API
    let offices = JSON.parse(localStorage.getItem('clinics') || '[]');
    
    // Keep "All Clinics" option and add offices
    clinicSelect.innerHTML = '<option value="">All Clinics</option>';
    offices.forEach(office => {
        const id = office.Id || office.id;
        const name = office.Name || office.name || office.clinicName;
        if (name) {
            clinicSelect.innerHTML += `<option value="${id || name}">${name}</option>`;
        }
    });
    
    console.log('âœ… Clinic filter loaded with', offices.length, 'offices');
}

// Override loadDataFromAPI to use enhanced version
loadDataFromAPI = loadAllDataFromAPI;
</script>

</body></html>